advisory_id: CVE-2023-1076
datasource_id: collect_linux_fix_commits/CVE-2023-1076
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  666c135b2d859a00ee74c8645b2affacfae45421:Merge branch 'tun-tap-uid'

  Laszlo Ersek says:

  ====================
  tun/tap: set sk_uid from current_fsuid()

  The original patches fixing CVE-2023-1076 are incorrect in my opinion.
  This small series fixes them up; see the individual commit messages for
  explanation.

  I have a very elaborate test procedure demonstrating the problem for
  both tun and tap; it involves libvirt, qemu, and "crash". I can share
  that procedure if necessary, but it's indeed quite long (I wrote it
  originally for our QE team).

  The patches in this series are supposed to "re-fix" CVE-2023-1076; given
  that said CVE is classified as Low Impact (CVSSv3=5.5), I'm posting this
  publicly, and not suggesting any embargo. Red Hat Product Security may
  assign a new CVE number later.

  I've tested the patches on top of v6.5-rc4, with "crash" built at commit
  c74f375e0ef7.

  Cc: Eric Dumazet <edumazet@google.com>
  Cc: Lorenzo Colitti <lorenzo@google.com>
  Cc: Paolo Abeni <pabeni@redhat.com>
  Cc: Pietro Borrello <borrello@diag.uniroma1.it>
  Cc: netdev@vger.kernel.org
  Cc: stable@vger.kernel.org
  ====================

  Signed-off-by: David S. Miller <davem@davemloft.net>
  666c135b2d859a00ee74c8645b2affacfae45421:Merge branch 'tun-tap-uid'

  Laszlo Ersek says:

  ====================
  tun/tap: set sk_uid from current_fsuid()

  The original patches fixing CVE-2023-1076 are incorrect in my opinion.
  This small series fixes them up; see the individual commit messages for
  explanation.

  I have a very elaborate test procedure demonstrating the problem for
  both tun and tap; it involves libvirt, qemu, and "crash". I can share
  that procedure if necessary, but it's indeed quite long (I wrote it
  originally for our QE team).

  The patches in this series are supposed to "re-fix" CVE-2023-1076; given
  that said CVE is classified as Low Impact (CVSSv3=5.5), I'm posting this
  publicly, and not suggesting any embargo. Red Hat Product Security may
  assign a new CVE number later.

  I've tested the patches on top of v6.5-rc4, with "crash" built at commit
  c74f375e0ef7.

  Cc: Eric Dumazet <edumazet@google.com>
  Cc: Lorenzo Colitti <lorenzo@google.com>
  Cc: Paolo Abeni <pabeni@redhat.com>
  Cc: Pietro Borrello <borrello@diag.uniroma1.it>
  Cc: netdev@vger.kernel.org
  Cc: stable@vger.kernel.org
  ====================

  Signed-off-by: David S. Miller <davem@davemloft.net>
  5c9241f3ceab3257abe2923a59950db0dc8bb737:net: tap_open(): set sk_uid from current_fsuid()

  Commit 66b2c338adce initializes the "sk_uid" field in the protocol socket
  (struct sock) from the "/dev/tapX" device node's owner UID. Per original
  commit 86741ec25462 ("net: core: Add a UID field to struct sock.",
  2016-11-04), that's wrong: the idea is to cache the UID of the userspace
  process that creates the socket. Commit 86741ec25462 mentions socket() and
  accept(); with "tap", the action that creates the socket is
  open("/dev/tapX").

  Therefore the device node's owner UID is irrelevant. In most cases,
  "/dev/tapX" will be owned by root, so in practice, commit 66b2c338adce has
  no observable effect:

  - before, "sk_uid" would be zero, due to undefined behavior
    (CVE-2023-1076),

  - after, "sk_uid" would be zero, due to "/dev/tapX" being owned by root.

  What matters is the (fs)UID of the process performing the open(), so cache
  that in "sk_uid".

  Cc: Eric Dumazet <edumazet@google.com>
  Cc: Lorenzo Colitti <lorenzo@google.com>
  Cc: Paolo Abeni <pabeni@redhat.com>
  Cc: Pietro Borrello <borrello@diag.uniroma1.it>
  Cc: netdev@vger.kernel.org
  Cc: stable@vger.kernel.org
  Fixes: 66b2c338adce ("tap: tap_open(): correctly initialize socket uid")
  Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2173435
  Signed-off-by: Laszlo Ersek <lersek@redhat.com>
  Signed-off-by: David S. Miller <davem@davemloft.net>
  9bc3047374d5bec163e83e743709e23753376f0c:net: tun_chr_open(): set sk_uid from current_fsuid()

  Commit a096ccca6e50 initializes the "sk_uid" field in the protocol socket
  (struct sock) from the "/dev/net/tun" device node's owner UID. Per
  original commit 86741ec25462 ("net: core: Add a UID field to struct
  sock.", 2016-11-04), that's wrong: the idea is to cache the UID of the
  userspace process that creates the socket. Commit 86741ec25462 mentions
  socket() and accept(); with "tun", the action that creates the socket is
  open("/dev/net/tun").

  Therefore the device node's owner UID is irrelevant. In most cases,
  "/dev/net/tun" will be owned by root, so in practice, commit a096ccca6e50
  has no observable effect:

  - before, "sk_uid" would be zero, due to undefined behavior
    (CVE-2023-1076),

  - after, "sk_uid" would be zero, due to "/dev/net/tun" being owned by root.

  What matters is the (fs)UID of the process performing the open(), so cache
  that in "sk_uid".

  Cc: Eric Dumazet <edumazet@google.com>
  Cc: Lorenzo Colitti <lorenzo@google.com>
  Cc: Paolo Abeni <pabeni@redhat.com>
  Cc: Pietro Borrello <borrello@diag.uniroma1.it>
  Cc: netdev@vger.kernel.org
  Cc: stable@vger.kernel.org
  Fixes: a096ccca6e50 ("tun: tun_chr_open(): correctly initialize socket uid")
  Bugzilla: https://bugzilla.redhat.com/show_bug.cgi?id=2173435
  Signed-off-by: Laszlo Ersek <lersek@redhat.com>
  Signed-off-by: David S. Miller <davem@davemloft.net>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 9bc3047374d5bec163e83e743709e23753376f0c
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 5c9241f3ceab3257abe2923a59950db0dc8bb737
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 666c135b2d859a00ee74c8645b2affacfae45421
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/5c9241f3ceab3257abe2923a59950db0dc8bb737
    reference_type: commit
    reference_id: 5c9241f3ceab3257abe2923a59950db0dc8bb737
  - url: https://github.com/torvalds/linux/tree/666c135b2d859a00ee74c8645b2affacfae45421
    reference_type: commit
    reference_id: 666c135b2d859a00ee74c8645b2affacfae45421
  - url: https://github.com/torvalds/linux/tree/9bc3047374d5bec163e83e743709e23753376f0c
    reference_type: commit
    reference_id: 9bc3047374d5bec163e83e743709e23753376f0c
