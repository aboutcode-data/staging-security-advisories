advisory_id: CVE-2022-23041
datasource_id: collect_linux_fix_commits/CVE-2022-23041
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  42baefac638f06314298087394b982ead9ec444b:xen/gnttab: fix gnttab_end_foreign_access() without page specified

  gnttab_end_foreign_access() is used to free a grant reference and
  optionally to free the associated page. In case the grant is still in
  use by the other side processing is being deferred. This leads to a
  problem in case no page to be freed is specified by the caller: the
  caller doesn't know that the page is still mapped by the other side
  and thus should not be used for other purposes.

  The correct way to handle this situation is to take an additional
  reference to the granted page in case handling is being deferred and
  to drop that reference when the grant reference could be freed
  finally.

  This requires that there are no users of gnttab_end_foreign_access()
  left directly repurposing the granted page after the call, as this
  might result in clobbered data or information leaks via the not yet
  freed grant reference.

  This is part of CVE-2022-23041 / XSA-396.

  Reported-by: Simon Gaiser <simon@invisiblethingslab.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  ---
  V4:
  - expand comment in header
  V5:
  - get page ref in case of kmalloc() failure, too
  b0576cc9c6b843d99c6982888d59a56209341888:xen/pvcalls: use alloc/free_pages_exact()

  Instead of __get_free_pages() and free_pages() use alloc_pages_exact()
  and free_pages_exact(). This is in preparation of a change of
  gnttab_end_foreign_access() which will prohibit use of high-order
  pages.

  This is part of CVE-2022-23041 / XSA-396.

  Reported-by: Simon Gaiser <simon@invisiblethingslab.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  ---
  V4:
  - new patch
  5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd:xen/9p: use alloc/free_pages_exact()

  Instead of __get_free_pages() and free_pages() use alloc_pages_exact()
  and free_pages_exact(). This is in preparation of a change of
  gnttab_end_foreign_access() which will prohibit use of high-order
  pages.

  By using the local variable "order" instead of ring->intf->ring_order
  in the error path of xen_9pfs_front_alloc_dataring() another bug is
  fixed, as the error path can be entered before ring->intf->ring_order
  is being set.

  By using alloc_pages_exact() the size in bytes is specified for the
  allocation, which fixes another bug for the case of
  order < (PAGE_SHIFT - XEN_PAGE_SHIFT).

  This is part of CVE-2022-23041 / XSA-396.

  Reported-by: Simon Gaiser <simon@invisiblethingslab.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  ---
  V4:
  - new patch
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: b0576cc9c6b843d99c6982888d59a56209341888
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 42baefac638f06314298087394b982ead9ec444b
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/42baefac638f06314298087394b982ead9ec444b
    reference_type: commit
    reference_id: 42baefac638f06314298087394b982ead9ec444b
  - url: https://github.com/torvalds/linux/tree/5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd
    reference_type: commit
    reference_id: 5cadd4bb1d7fc9ab201ac14620d1a478357e4ebd
  - url: https://github.com/torvalds/linux/tree/b0576cc9c6b843d99c6982888d59a56209341888
    reference_type: commit
    reference_id: b0576cc9c6b843d99c6982888d59a56209341888
