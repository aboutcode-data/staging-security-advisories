advisory_id: CVE-2016-6213
datasource_id: collect_linux_fix_commits/CVE-2016-6213
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "296990deb389c7da21c78030376ba244dc1badf5:mnt: Make propagate_umount less slow for\
  \ overlapping mount propagation trees\n\nAndrei Vagin pointed out that time to executue propagate_umount\
  \ can go\nnon-linear (and take a ludicrious amount of time) when the mount\npropogation trees\
  \ of the mounts to be unmunted by a lazy unmount\noverlap.\n\nMake the walk of the mount propagation\
  \ trees nearly linear by\nremembering which mounts have already been visited, allowing\nsubsequent\
  \ walks to detect when walking a mount propgation tree or a\nsubtree of a mount propgation\
  \ tree would be duplicate work and to skip\nthem entirely.\n\nWalk the list of mounts whose\
  \ propgatation trees need to be traversed\nfrom the mount highest in the mount tree to mounts\
  \ lower in the mount\ntree so that odds are higher that the code will walk the largest trees\n\
  first, allowing later tree walks to be skipped entirely.\n\nAdd cleanup_umount_visitation\
  \ to remover the code's memory of which\nmounts have been visited.\n\nAdd the functions last_slave\
  \ and skip_propagation_subtree to allow\nskipping appropriate parts of the mount propagation\
  \ tree without\nneeding to change the logic of the rest of the code.\n\nA script to generate\
  \ overlapping mount propagation trees:\n\n$ cat runs.h\nset -e\nmount -t tmpfs zdtm /mnt\n\
  mkdir -p /mnt/1 /mnt/2\nmount -t tmpfs zdtm /mnt/1\nmount --make-shared /mnt/1\nmkdir /mnt/1/1\n\
  \niteration=10\nif [ -n \"$1\" ] ; then\n\titeration=$1\nfi\n\nfor i in $(seq $iteration);\
  \ do\n\tmount --bind /mnt/1/1 /mnt/1/1\ndone\n\nmount --rbind /mnt/1 /mnt/2\n\nTIMEFORMAT='%Rs'\n\
  nr=$(( ( 2 ** ( $iteration + 1 ) ) + 1 ))\necho -n \"umount -l /mnt/1 -> $nr        \"\ntime\
  \ umount -l /mnt/1\n\nnr=$(cat /proc/self/mountinfo | grep zdtm | wc -l )\ntime umount -l\
  \ /mnt/2\n\n$ for i in $(seq 9 19); do echo $i; unshare -Urm bash ./run.sh $i; done\n\nHere\
  \ are the performance numbers with and without the patch:\n\n     mhash |  8192   |  8192\
  \  | 1048576 | 1048576\n    mounts | before  | after  |  before | after\n    ------------------------------------------------\n\
  \      1025 |  0.040s | 0.016s |  0.038s | 0.019s\n      2049 |  0.094s | 0.017s |  0.080s\
  \ | 0.018s\n      4097 |  0.243s | 0.019s |  0.206s | 0.023s\n      8193 |  1.202s | 0.028s\
  \ |  1.562s | 0.032s\n     16385 |  9.635s | 0.036s |  9.952s | 0.041s\n     32769 | 60.928s\
  \ | 0.063s | 44.321s | 0.064s\n     65537 |         | 0.097s |         | 0.097s\n    131073\
  \ |         | 0.233s |         | 0.176s\n    262145 |         | 0.653s |         | 0.344s\n\
  \    524289 |         | 2.305s |         | 0.735s\n   1048577 |         | 7.107s |       \
  \  | 2.603s\n\nAndrei Vagin reports fixing the performance problem is part of the\nwork to\
  \ fix CVE-2016-6213.\n\nCc: stable@vger.kernel.org\nFixes: a05964f3917c (\"[PATCH] shared\
  \ mounts handling: umount\")\nReported-by: Andrei Vagin <avagin@openvz.org>\nReviewed-by:\
  \ Andrei Vagin <avagin@virtuozzo.com>\nSigned-off-by: \"Eric W. Biederman\" <ebiederm@xmission.com>\n\
  d29216842a85c7970c536108e093963f02714498:mnt: Add a per mount namespace limit on the number\
  \ of mounts\n\nCAI Qian <caiqian@redhat.com> pointed out that the semantics\nof shared subtrees\
  \ make it possible to create an exponentially\nincreasing number of mounts in a mount namespace.\n\
  \n    mkdir /tmp/1 /tmp/2\n    mount --make-rshared /\n    for i in $(seq 1 20) ; do mount\
  \ --bind /tmp/1 /tmp/2 ; done\n\nWill create create 2^20 or 1048576 mounts, which is a practical\
  \ problem\nas some people have managed to hit this by accident.\n\nAs such CVE-2016-6213 was\
  \ assigned.\n\nIan Kent <raven@themaw.net> described the situation for autofs users\nas follows:\n\
  \n> The number of mounts for direct mount maps is usually not very large because of\n> the\
  \ way they are implemented, large direct mount maps can have performance\n> problems. There\
  \ can be anywhere from a few (likely case a few hundred) to less\n> than 10000, plus mounts\
  \ that have been triggered and not yet expired.\n>\n> Indirect mounts have one autofs mount\
  \ at the root plus the number of mounts that\n> have been triggered and not yet expired.\n\
  >\n> The number of autofs indirect map entries can range from a few to the common\n> case\
  \ of several thousand and in rare cases up to between 30000 and 50000. I've\n> not heard of\
  \ people with maps larger than 50000 entries.\n>\n> The larger the number of map entries the\
  \ greater the possibility for a large\n> number of active mounts so it's not hard to expect\
  \ cases of a 1000 or somewhat\n> more active mounts.\n\nSo I am setting the default number\
  \ of mounts allowed per mount\nnamespace at 100,000.  This is more than enough for any use\
  \ case I\nknow of, but small enough to quickly stop an exponential increase\nin mounts.  Which\
  \ should be perfect to catch misconfigurations and\nmalfunctioning programs.\n\nFor anyone\
  \ who needs a higher limit this can be changed by writing\nto the new /proc/sys/fs/mount-max\
  \ sysctl.\n\nTested-by: CAI Qian <caiqian@redhat.com>\nSigned-off-by: \"Eric W. Biederman\"\
  \ <ebiederm@xmission.com>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 296990deb389c7da21c78030376ba244dc1badf5
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: d29216842a85c7970c536108e093963f02714498
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/296990deb389c7da21c78030376ba244dc1badf5
    reference_type: commit
    reference_id: 296990deb389c7da21c78030376ba244dc1badf5
  - url: https://github.com/torvalds/linux/tree/d29216842a85c7970c536108e093963f02714498
    reference_type: commit
    reference_id: d29216842a85c7970c536108e093963f02714498
