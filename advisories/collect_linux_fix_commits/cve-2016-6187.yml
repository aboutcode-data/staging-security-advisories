advisory_id: cve-2016-6187
datasource_id: collect_linux_fix_commits/cve-2016-6187
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "37cd0575b8510159992d279c530c05f872990b02:userfaultfd: add UFFD_USER_MODE_ONLY\n\n\
  Patch series \"Control over userfaultfd kernel-fault handling\", v6.\n\nThis patch series\
  \ is split from [1].  The other series enables SELinux\nsupport for userfaultfd file descriptors\
  \ so that its creation and movement\ncan be controlled.\n\nIt has been demonstrated on various\
  \ occasions that suspending kernel code\nexecution for an arbitrary amount of time at any\
  \ access to userspace\nmemory (copy_from_user()/copy_to_user()/...) can be exploited to change\n\
  the intended behavior of the kernel.  For instance, handling page faults\nin kernel-mode using\
  \ userfaultfd has been exploited in [2, 3].  Likewise,\nFUSE, which is similar to userfaultfd\
  \ in this respect, has been exploited\nin [4, 5] for similar outcome.\n\nThis small patch\
  \ series adds a new flag to userfaultfd(2) that allows\ncallers to give up the ability to\
  \ handle kernel-mode faults with the\nresulting UFFD file object.  It then adds a 'user-mode\
  \ only' option to the\nunprivileged_userfaultfd sysctl knob to require unprivileged callers\
  \ to\nuse this new flag.\n\nThe purpose of this new interface is to decrease the chance of\
  \ an\nunprivileged userfaultfd user taking advantage of userfaultfd to enhance\nsecurity vulnerabilities\
  \ by lengthening the race window in kernel code.\n\n[1] https://lore.kernel.org/lkml/20200211225547.235083-1-dancol@google.com/\n\
  [2] https://duasynt.com/blog/linux-kernel-heap-spray\n[3] https://duasynt.com/blog/cve-2016-6187-heap-off-by-one-exploit\n\
  [4] https://googleprojectzero.blogspot.com/2016/06/exploiting-recursion-in-linux-kernel_20.html\n\
  [5] https://bugs.chromium.org/p/project-zero/issues/detail?id=808\n\nThis patch (of 2):\n\n\
  userfaultfd handles page faults from both user and kernel code.  Add a new\nUFFD_USER_MODE_ONLY\
  \ flag for userfaultfd(2) that makes the resulting\nuserfaultfd object refuse to handle faults\
  \ from kernel mode, treating\nthese faults as if SIGBUS were always raised, causing the kernel\
  \ code to\nfail with EFAULT.\n\nA future patch adds a knob allowing administrators to give\
  \ some processes\nthe ability to create userfaultfd file objects only if they pass\nUFFD_USER_MODE_ONLY,\
  \ reducing the likelihood that these processes will\nexploit userfaultfd's ability to delay\
  \ kernel page faults to open timing\nwindows for future exploits.\n\nLink: https://lkml.kernel.org/r/20201120030411.2690816-1-lokeshgidra@google.com\n\
  Link: https://lkml.kernel.org/r/20201120030411.2690816-2-lokeshgidra@google.com\nSigned-off-by:\
  \ Daniel Colascione <dancol@google.com>\nSigned-off-by: Lokesh Gidra <lokeshgidra@google.com>\n\
  Reviewed-by: Andrea Arcangeli <aarcange@redhat.com>\nCc: Alexander Viro <viro@zeniv.linux.org.uk>\n\
  Cc: <calin@google.com>\nCc: Daniel Colascione <dancol@dancol.org>\nCc: Eric Biggers <ebiggers@kernel.org>\n\
  Cc: Iurii Zaikin <yzaikin@google.com>\nCc: Jeff Vander Stoep <jeffv@google.com>\nCc: Jerome\
  \ Glisse <jglisse@redhat.com>\nCc: \"Joel Fernandes (Google)\" <joel@joelfernandes.org>\n\
  Cc: Johannes Weiner <hannes@cmpxchg.org>\nCc: Jonathan Corbet <corbet@lwn.net>\nCc: Kalesh\
  \ Singh <kaleshsingh@google.com>\nCc: Kees Cook <keescook@chromium.org>\nCc: Luis Chamberlain\
  \ <mcgrof@kernel.org>\nCc: Mauro Carvalho Chehab <mchehab+huawei@kernel.org>\nCc: Mel Gorman\
  \ <mgorman@techsingularity.net>\nCc: Mike Rapoport <rppt@linux.vnet.ibm.com>\nCc: Nitin Gupta\
  \ <nigupta@nvidia.com>\nCc: Peter Xu <peterx@redhat.com>\nCc: Sebastian Andrzej Siewior <bigeasy@linutronix.de>\n\
  Cc: Shaohua Li <shli@fb.com>\nCc: Stephen Smalley <stephen.smalley.work@gmail.com>\nCc: Suren\
  \ Baghdasaryan <surenb@google.com>\nCc: Vlastimil Babka <vbabka@suse.cz>\nSigned-off-by: Andrew\
  \ Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n\
  2482ddec670fb83717d129012bc558777cb159f7:mm: add SLUB free list pointer obfuscation\n\nThis\
  \ SLUB free list pointer obfuscation code is modified from Brad\nSpengler/PaX Team's code\
  \ in the last public patch of grsecurity/PaX\nbased on my understanding of the code.  Changes\
  \ or omissions from the\noriginal code are mine and don't reflect the original grsecurity/PaX\n\
  code.\n\nThis adds a per-cache random value to SLUB caches that is XORed with\ntheir freelist\
  \ pointer address and value.  This adds nearly zero\noverhead and frustrates the very common\
  \ heap overflow exploitation\nmethod of overwriting freelist pointers.\n\nA recent example\
  \ of the attack is written up here:\n\n  http://cyseclabs.com/blog/cve-2016-6187-heap-off-by-one-exploit\n\
  \nand there is a section dedicated to the technique the book \"A Guide to\nKernel Exploitation:\
  \ Attacking the Core\".\n\nThis is based on patches by Daniel Micay, and refactored to minimize\
  \ the\nuse of #ifdef.\n\nWith 200-count cycles of \"hackbench -g 20 -l 1000\" I saw the following\n\
  run times:\n\n before:\n \tmean 10.11882499999999999995\n\tvariance .03320378329145728642\n\
  \tstdev .18221905304181911048\n\n  after:\n\tmean 10.12654000000000000014\n\tvariance .04700556623115577889\n\
  \tstdev .21680767106160192064\n\nThe difference gets lost in the noise, but if the above is\
  \ to be taken\nliterally, using CONFIG_FREELIST_HARDENED is 0.07% slower.\n\nLink: http://lkml.kernel.org/r/20170802180609.GA66807@beast\n\
  Signed-off-by: Kees Cook <keescook@chromium.org>\nSuggested-by: Daniel Micay <danielmicay@gmail.com>\n\
  Cc: Rik van Riel <riel@redhat.com>\nCc: Tycho Andersen <tycho@docker.com>\nCc: Alexander Popov\
  \ <alex.popov@linux.com>\nCc: Christoph Lameter <cl@linux.com>\nCc: Pekka Enberg <penberg@kernel.org>\n\
  Cc: David Rientjes <rientjes@google.com>\nCc: Joonsoo Kim <iamjoonsoo.kim@lge.com>\nSigned-off-by:\
  \ Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 37cd0575b8510159992d279c530c05f872990b02
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 2482ddec670fb83717d129012bc558777cb159f7
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/2482ddec670fb83717d129012bc558777cb159f7
    reference_type: commit
    reference_id: 2482ddec670fb83717d129012bc558777cb159f7
  - url: https://github.com/torvalds/linux/tree/37cd0575b8510159992d279c530c05f872990b02
    reference_type: commit
    reference_id: 37cd0575b8510159992d279c530c05f872990b02
