advisory_id: CVE-2021-23133
datasource_id: collect_linux_fix_commits/CVE-2021-23133
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  34e5b01186858b36c4d7c87e1a025071e8e2401f:sctp: delay auto_asconf init until binding the first addr

  As Or Cohen described:

    If sctp_destroy_sock is called without sock_net(sk)->sctp.addr_wq_lock
    held and sp->do_auto_asconf is true, then an element is removed
    from the auto_asconf_splist without any proper locking.

    This can happen in the following functions:
    1. In sctp_accept, if sctp_sock_migrate fails.
    2. In inet_create or inet6_create, if there is a bpf program
       attached to BPF_CGROUP_INET_SOCK_CREATE which denies
       creation of the sctp socket.

  This patch is to fix it by moving the auto_asconf init out of
  sctp_init_sock(), by which inet_create()/inet6_create() won't
  need to operate it in sctp_destroy_sock() when calling
  sk_common_release().

  It also makes more sense to do auto_asconf init while binding the
  first addr, as auto_asconf actually requires an ANY addr bind,
  see it in sctp_addr_wq_timeout_handler().

  This addresses CVE-2021-23133.

  Fixes: 610236587600 ("bpf: Add new cgroup attach type to enable sock modifications")
  Reported-by: Or Cohen <orcohen@paloaltonetworks.com>
  Signed-off-by: Xin Long <lucien.xin@gmail.com>
  Signed-off-by: David S. Miller <davem@davemloft.net>
  b166a20b07382b8bc1dcee2a448715c9c2c81b5b:net/sctp: fix race condition in sctp_destroy_sock

  If sctp_destroy_sock is called without sock_net(sk)->sctp.addr_wq_lock
  held and sp->do_auto_asconf is true, then an element is removed
  from the auto_asconf_splist without any proper locking.

  This can happen in the following functions:
  1. In sctp_accept, if sctp_sock_migrate fails.
  2. In inet_create or inet6_create, if there is a bpf program
     attached to BPF_CGROUP_INET_SOCK_CREATE which denies
     creation of the sctp socket.

  The bug is fixed by acquiring addr_wq_lock in sctp_destroy_sock
  instead of sctp_close.

  This addresses CVE-2021-23133.

  Reported-by: Or Cohen <orcohen@paloaltonetworks.com>
  Reviewed-by: Xin Long <lucien.xin@gmail.com>
  Fixes: 610236587600 ("bpf: Add new cgroup attach type to enable sock modifications")
  Signed-off-by: Or Cohen <orcohen@paloaltonetworks.com>
  Acked-by: Marcelo Ricardo Leitner <marcelo.leitner@gmail.com>
  Signed-off-by: David S. Miller <davem@davemloft.net>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: b166a20b07382b8bc1dcee2a448715c9c2c81b5b
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 34e5b01186858b36c4d7c87e1a025071e8e2401f
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/34e5b01186858b36c4d7c87e1a025071e8e2401f
    reference_type: commit
    reference_id: 34e5b01186858b36c4d7c87e1a025071e8e2401f
  - url: https://github.com/torvalds/linux/tree/b166a20b07382b8bc1dcee2a448715c9c2c81b5b
    reference_type: commit
    reference_id: b166a20b07382b8bc1dcee2a448715c9c2c81b5b
