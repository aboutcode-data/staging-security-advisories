advisory_id: CVE-2021-4155
datasource_id: collect_linux_fix_commits/CVE-2021-4155
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  4d1b97f9ce7c0d2af2bb85b12d48e6902172a28e:xfs: kill the XFS_IOC_{ALLOC,FREE}SP* ioctls

  According to the glibc compat header for Irix 4, these ioctls originated
  in April 1991 as a (somewhat clunky) way to preallocate space at the end
  of a file on an EFS filesystem.  XFS, which was released in Irix 5.3 in
  December 1993, picked up these ioctls to maintain compatibility and they
  were ported to Linux in the early 2000s.

  Recently it was pointed out to me they still lurk in the kernel, even
  though the Linux fallocate syscall supplanted the functionality a long
  time ago.  fstests doesn't seem to include any real functional or stress
  tests for these ioctls, which means that the code quality is ... very
  questionable.  Most notably, it was a stale disk block exposure vector
  for 21 years and nobody noticed or complained.  As mature programmers
  say, "If you're not testing it, it's broken."

  Given all that, let's withdraw these ioctls from the XFS userspace API.
  Normally we'd set a long deprecation process, but I estimate that there
  aren't any real users, so let's trigger a warning in dmesg and return
  -ENOTTY.

  See: CVE-2021-4155

  Augments: 983d8e60f508 ("xfs: map unwritten blocks in XFS_IOC_{ALLOC,FREE}SP just like fallocate")
  Signed-off-by: Darrick J. Wong <djwong@kernel.org>
  Reviewed-by: Eric Sandeen <sandeen@redhat.com>
  Reviewed-by: Dave Chinner <dchinner@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 4d1b97f9ce7c0d2af2bb85b12d48e6902172a28e
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/4d1b97f9ce7c0d2af2bb85b12d48e6902172a28e
    reference_type: commit
    reference_id: 4d1b97f9ce7c0d2af2bb85b12d48e6902172a28e
