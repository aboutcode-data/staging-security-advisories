advisory_id: CVE-2014-8989
datasource_id: collect_linux_fix_commits/CVE-2014-8989
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  f95d7918bd1e724675de4940039f2865e5eec5fe:userns: Only allow the creator of the userns unprivileged mappings

  If you did not create the user namespace and are allowed
  to write to uid_map or gid_map you should already have the necessary
  privilege in the parent user namespace to establish any mapping
  you want so this will not affect userspace in practice.

  Limiting unprivileged uid mapping establishment to the creator of the
  user namespace makes it easier to verify all credentials obtained with
  the uid mapping can be obtained without the uid mapping without
  privilege.

  Limiting unprivileged gid mapping establishment (which is temporarily
  absent) to the creator of the user namespace also ensures that the
  combination of uid and gid can already be obtained without privilege.

  This is part of the fix for CVE-2014-8989.

  Cc: stable@vger.kernel.org
  Reviewed-by: Andy Lutomirski <luto@amacapital.net>
  Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
  80dd00a23784b384ccea049bfb3f259d3f973b9d:userns: Check euid no fsuid when establishing an unprivileged uid mapping

  setresuid allows the euid to be set to any of uid, euid, suid, and
  fsuid.  Therefor it is safe to allow an unprivileged user to map
  their euid and use CAP_SETUID privileged with exactly that uid,
  as no new credentials can be obtained.

  I can not find a combination of existing system calls that allows setting
  uid, euid, suid, and fsuid from the fsuid making the previous use
  of fsuid for allowing unprivileged mappings a bug.

  This is part of a fix for CVE-2014-8989.

  Cc: stable@vger.kernel.org
  Reviewed-by: Andy Lutomirski <luto@amacapital.net>
  Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
  be7c6dba2332cef0677fbabb606e279ae76652c3:userns: Don't allow unprivileged creation of gid mappings

  As any gid mapping will allow and must allow for backwards
  compatibility dropping groups don't allow any gid mappings to be
  established without CAP_SETGID in the parent user namespace.

  For a small class of applications this change breaks userspace
  and removes useful functionality.  This small class of applications
  includes tools/testing/selftests/mount/unprivilged-remount-test.c

  Most of the removed functionality will be added back with the addition
  of a one way knob to disable setgroups.  Once setgroups is disabled
  setting the gid_map becomes as safe as setting the uid_map.

  For more common applications that set the uid_map and the gid_map
  with privilege this change will have no affect.

  This is part of a fix for CVE-2014-8989.

  Cc: stable@vger.kernel.org
  Reviewed-by: Andy Lutomirski <luto@amacapital.net>
  Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
  273d2c67c3e179adb1e74f403d1e9a06e3f841b5:userns: Don't allow setgroups until a gid mapping has been setablished

  setgroups is unique in not needing a valid mapping before it can be called,
  in the case of setgroups(0, NULL) which drops all supplemental groups.

  The design of the user namespace assumes that CAP_SETGID can not actually
  be used until a gid mapping is established.  Therefore add a helper function
  to see if the user namespace gid mapping has been established and call
  that function in the setgroups permission check.

  This is part of the fix for CVE-2014-8989, being able to drop groups
  without privilege using user namespaces.

  Cc: stable@vger.kernel.org
  Reviewed-by: Andy Lutomirski <luto@amacapital.net>
  Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
  0542f17bf2c1f2430d368f44c8fcf2f82ec9e53e:userns: Document what the invariant required for safe unprivileged mappings.

  The rule is simple.  Don't allow anything that wouldn't be allowed
  without unprivileged mappings.

  It was previously overlooked that establishing gid mappings would
  allow dropping groups and potentially gaining permission to files and
  directories that had lesser permissions for a specific group than for
  all other users.

  This is the rule needed to fix CVE-2014-8989 and prevent any other
  security issues with new_idmap_permitted.

  The reason for this rule is that the unix permission model is old and
  there are programs out there somewhere that take advantage of every
  little corner of it.  So allowing a uid or gid mapping to be
  established without privielge that would allow anything that would not
  be allowed without that mapping will result in expectations from some
  code somewhere being violated.  Violated expectations about the
  behavior of the OS is a long way to say a security issue.

  Cc: stable@vger.kernel.org
  Signed-off-by: "Eric W. Biederman" <ebiederm@xmission.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: f95d7918bd1e724675de4940039f2865e5eec5fe
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: be7c6dba2332cef0677fbabb606e279ae76652c3
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 0542f17bf2c1f2430d368f44c8fcf2f82ec9e53e
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 80dd00a23784b384ccea049bfb3f259d3f973b9d
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 273d2c67c3e179adb1e74f403d1e9a06e3f841b5
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/0542f17bf2c1f2430d368f44c8fcf2f82ec9e53e
    reference_type: commit
    reference_id: 0542f17bf2c1f2430d368f44c8fcf2f82ec9e53e
  - url: https://github.com/torvalds/linux/tree/273d2c67c3e179adb1e74f403d1e9a06e3f841b5
    reference_type: commit
    reference_id: 273d2c67c3e179adb1e74f403d1e9a06e3f841b5
  - url: https://github.com/torvalds/linux/tree/80dd00a23784b384ccea049bfb3f259d3f973b9d
    reference_type: commit
    reference_id: 80dd00a23784b384ccea049bfb3f259d3f973b9d
  - url: https://github.com/torvalds/linux/tree/be7c6dba2332cef0677fbabb606e279ae76652c3
    reference_type: commit
    reference_id: be7c6dba2332cef0677fbabb606e279ae76652c3
  - url: https://github.com/torvalds/linux/tree/f95d7918bd1e724675de4940039f2865e5eec5fe
    reference_type: commit
    reference_id: f95d7918bd1e724675de4940039f2865e5eec5fe
