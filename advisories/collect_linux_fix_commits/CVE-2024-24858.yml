advisory_id: CVE-2024-24858
datasource_id: collect_linux_fix_commits/CVE-2024-24858
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "7835fcfd132eb88b87e8eb901f88436f63ab60f7:Bluetooth: Fix TOCTOU in HCI debugfs implementation\n\
  \nstruct hci_dev members conn_info_max_age, conn_info_min_age,\nle_conn_max_interval, le_conn_min_interval,\
  \ le_adv_max_interval,\nand le_adv_min_interval can be modified from the HCI core code, as\
  \ well\nthrough debugfs.\n\nThe debugfs implementation, that's only available to privileged\
  \ users,\nwill check for boundaries, making sure that the minimum value being set\nis strictly\
  \ above the maximum value that already exists, and vice-versa.\n\nHowever, as both minimum\
  \ and maximum values can be changed concurrently\nto us modifying them, we need to make sure\
  \ that the value we check is\nthe value we end up using.\n\nFor example, with ->conn_info_max_age\
  \ set to 10, conn_info_min_age_set()\ngets called from vfs handlers to set conn_info_min_age\
  \ to 8.\n\nIn conn_info_min_age_set(), this goes through:\n\tif (val == 0 || val > hdev->conn_info_max_age)\n\
  \t\treturn -EINVAL;\n\nConcurrently, conn_info_max_age_set() gets called to set to set the\n\
  conn_info_max_age to 7:\n\tif (val == 0 || val > hdev->conn_info_max_age)\n\t\treturn -EINVAL;\n\
  That check will also pass because we used the old value (10) for\nconn_info_max_age.\n\nAfter\
  \ those checks that both passed, the struct hci_dev access\nis mutex-locked, disabling concurrent\
  \ access, but that does not matter\nbecause the invalid value checks both passed, and we'll\
  \ end up with\nconn_info_min_age = 8 and conn_info_max_age = 7\n\nTo fix this problem, we\
  \ need to lock the structure access before so the\ncheck and assignment are not interrupted.\n\
  \nThis fix was originally devised by the BassCheck[1] team, and\nconsidered the problem to\
  \ be an atomicity one. This isn't the case as\nthere aren't any concerns about the variable\
  \ changing while we check it,\nbut rather after we check it parallel to another change.\n\n\
  This patch fixes CVE-2024-24858 and CVE-2024-24857.\n\n[1] https://sites.google.com/view/basscheck/\n\
  \nCo-developed-by: Gui-Dong Han <2045gemini@gmail.com>\nSigned-off-by: Gui-Dong Han <2045gemini@gmail.com>\n\
  Link: https://lore.kernel.org/linux-bluetooth/20231222161317.6255-1-2045gemini@gmail.com/\n\
  Link: https://nvd.nist.gov/vuln/detail/CVE-2024-24858\nLink: https://lore.kernel.org/linux-bluetooth/20231222162931.6553-1-2045gemini@gmail.com/\n\
  Link: https://lore.kernel.org/linux-bluetooth/20231222162310.6461-1-2045gemini@gmail.com/\n\
  Link: https://nvd.nist.gov/vuln/detail/CVE-2024-24857\nFixes: 31ad169148df (\"Bluetooth: Add\
  \ conn info lifetime parameters to debugfs\")\nFixes: 729a1051da6f (\"Bluetooth: Expose default\
  \ LE advertising interval via debugfs\")\nFixes: 71c3b60ec6d2 (\"Bluetooth: Move BR/EDR debugfs\
  \ file creation into hci_debugfs.c\")\nSigned-off-by: Bastien Nocera <hadess@hadess.net>\n\
  Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>\n7835fcfd132eb88b87e8eb901f88436f63ab60f7:Bluetooth:\
  \ Fix TOCTOU in HCI debugfs implementation\n\nstruct hci_dev members conn_info_max_age, conn_info_min_age,\n\
  le_conn_max_interval, le_conn_min_interval, le_adv_max_interval,\nand le_adv_min_interval\
  \ can be modified from the HCI core code, as well\nthrough debugfs.\n\nThe debugfs implementation,\
  \ that's only available to privileged users,\nwill check for boundaries, making sure that\
  \ the minimum value being set\nis strictly above the maximum value that already exists, and\
  \ vice-versa.\n\nHowever, as both minimum and maximum values can be changed concurrently\n\
  to us modifying them, we need to make sure that the value we check is\nthe value we end up\
  \ using.\n\nFor example, with ->conn_info_max_age set to 10, conn_info_min_age_set()\ngets\
  \ called from vfs handlers to set conn_info_min_age to 8.\n\nIn conn_info_min_age_set(), this\
  \ goes through:\n\tif (val == 0 || val > hdev->conn_info_max_age)\n\t\treturn -EINVAL;\n\n\
  Concurrently, conn_info_max_age_set() gets called to set to set the\nconn_info_max_age to\
  \ 7:\n\tif (val == 0 || val > hdev->conn_info_max_age)\n\t\treturn -EINVAL;\nThat check will\
  \ also pass because we used the old value (10) for\nconn_info_max_age.\n\nAfter those checks\
  \ that both passed, the struct hci_dev access\nis mutex-locked, disabling concurrent access,\
  \ but that does not matter\nbecause the invalid value checks both passed, and we'll end up\
  \ with\nconn_info_min_age = 8 and conn_info_max_age = 7\n\nTo fix this problem, we need to\
  \ lock the structure access before so the\ncheck and assignment are not interrupted.\n\nThis\
  \ fix was originally devised by the BassCheck[1] team, and\nconsidered the problem to be an\
  \ atomicity one. This isn't the case as\nthere aren't any concerns about the variable changing\
  \ while we check it,\nbut rather after we check it parallel to another change.\n\nThis patch\
  \ fixes CVE-2024-24858 and CVE-2024-24857.\n\n[1] https://sites.google.com/view/basscheck/\n\
  \nCo-developed-by: Gui-Dong Han <2045gemini@gmail.com>\nSigned-off-by: Gui-Dong Han <2045gemini@gmail.com>\n\
  Link: https://lore.kernel.org/linux-bluetooth/20231222161317.6255-1-2045gemini@gmail.com/\n\
  Link: https://nvd.nist.gov/vuln/detail/CVE-2024-24858\nLink: https://lore.kernel.org/linux-bluetooth/20231222162931.6553-1-2045gemini@gmail.com/\n\
  Link: https://lore.kernel.org/linux-bluetooth/20231222162310.6461-1-2045gemini@gmail.com/\n\
  Link: https://nvd.nist.gov/vuln/detail/CVE-2024-24857\nFixes: 31ad169148df (\"Bluetooth: Add\
  \ conn info lifetime parameters to debugfs\")\nFixes: 729a1051da6f (\"Bluetooth: Expose default\
  \ LE advertising interval via debugfs\")\nFixes: 71c3b60ec6d2 (\"Bluetooth: Move BR/EDR debugfs\
  \ file creation into hci_debugfs.c\")\nSigned-off-by: Bastien Nocera <hadess@hadess.net>\n\
  Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 7835fcfd132eb88b87e8eb901f88436f63ab60f7
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/7835fcfd132eb88b87e8eb901f88436f63ab60f7
    reference_type: commit
    reference_id: 7835fcfd132eb88b87e8eb901f88436f63ab60f7
