advisory_id: CVE-2017-1000253
datasource_id: collect_linux_fix_commits/CVE-2017-1000253
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  5f501d555653f8968011a1e65ebb121c8b43c144:binfmt_elf: reintroduce using MAP_FIXED_NOREPLACE

  Commit b212921b13bd ("elf: don't use MAP_FIXED_NOREPLACE for elf
  executable mappings") reverted back to using MAP_FIXED to map ELF LOAD
  segments because it was found that the segments in some binaries overlap
  and can cause MAP_FIXED_NOREPLACE to fail.

  The original intent of MAP_FIXED_NOREPLACE in the ELF loader was to
  prevent the silent clobbering of an existing mapping (e.g.  stack) by
  the ELF image, which could lead to exploitable conditions.  Quoting
  commit 4ed28639519c ("fs, elf: drop MAP_FIXED usage from elf_map"),
  which originally introduced the use of MAP_FIXED_NOREPLACE in the
  loader:

      Both load_elf_interp and load_elf_binary rely on elf_map to map
      segments [to a specific] address and they use MAP_FIXED to enforce
      that. This is however [a] dangerous thing prone to silent data
      corruption which can be even exploitable.
      ...
      Let's take CVE-2017-1000253 as an example ... we could end up mapping
      [the executable] over the existing stack ... The [stack layout] issue
      has been fixed since then ... So we should be safe and any [similar]
      attack should be impractical. On the other hand this is just too
      subtle [an] assumption ... it can break quite easily and [be] hard to
      spot.
      ...
      Address this [weakness] by changing MAP_FIXED to the newly added
      MAP_FIXED_NOREPLACE. This will mean that mmap will fail if there is
      an existing mapping clashing with the requested one [instead of
      silently] clobbering it.

  Then processing ET_DYN binaries the loader already calculates a total
  size for the image when the first segment is mapped, maps the entire
  image, and then unmaps the remainder before the remaining segments are
  then individually mapped.

  To avoid the earlier problems (legitimate overlapping LOAD segments
  specified in the ELF), apply the same logic to ET_EXEC binaries as well.

  For both ET_EXEC and ET_DYN+INTERP use MAP_FIXED_NOREPLACE for the
  initial total size mapping and then use MAP_FIXED to build the final
  (possibly legitimately overlapping) mappings.  For ET_DYN w/out INTERP,
  continue to map at a system-selected address in the mmap region.

  Link: https://lkml.kernel.org/r/20210916215947.3993776-1-keescook@chromium.org
  Link: https://lore.kernel.org/lkml/1595869887-23307-2-git-send-email-anthony.yznaga@oracle.com
  Co-developed-by: Anthony Yznaga <anthony.yznaga@oracle.com>
  Signed-off-by: Anthony Yznaga <anthony.yznaga@oracle.com>
  Signed-off-by: Kees Cook <keescook@chromium.org>
  Cc: Russell King <linux@armlinux.org.uk>
  Cc: Michal Hocko <mhocko@suse.com>
  Cc: Eric Biederman <ebiederm@xmission.com>
  Cc: Chen Jingwen <chenjingwen6@huawei.com>
  Cc: Alexander Viro <viro@zeniv.linux.org.uk>
  Cc: Andrei Vagin <avagin@openvz.org>
  Cc: Khalid Aziz <khalid.aziz@oracle.com>
  Cc: Michael Ellerman <mpe@ellerman.id.au>
  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
  4ed28639519c7bad5f518e70b3284c6e0763e650:fs, elf: drop MAP_FIXED usage from elf_map

  Both load_elf_interp and load_elf_binary rely on elf_map to map segments
  on a controlled address and they use MAP_FIXED to enforce that.  This is
  however dangerous thing prone to silent data corruption which can be
  even exploitable.

  Let's take CVE-2017-1000253 as an example.  At the time (before commit
  eab09532d400: "binfmt_elf: use ELF_ET_DYN_BASE only for PIE")
  ELF_ET_DYN_BASE was at TASK_SIZE / 3 * 2 which is not that far away from
  the stack top on 32b (legacy) memory layout (only 1GB away).  Therefore
  we could end up mapping over the existing stack with some luck.

  The issue has been fixed since then (a87938b2e246: "fs/binfmt_elf.c: fix
  bug in loading of PIE binaries"), ELF_ET_DYN_BASE moved moved much
  further from the stack (eab09532d400 and later by c715b72c1ba4: "mm:
  revert x86_64 and arm64 ELF_ET_DYN_BASE base changes") and excessive
  stack consumption early during execve fully stopped by da029c11e6b1
  ("exec: Limit arg stack to at most 75% of _STK_LIM").  So we should be
  safe and any attack should be impractical.  On the other hand this is
  just too subtle assumption so it can break quite easily and hard to
  spot.

  I believe that the MAP_FIXED usage in load_elf_binary (et. al) is still
  fundamentally dangerous.  Moreover it shouldn't be even needed.  We are
  at the early process stage and so there shouldn't be unrelated mappings
  (except for stack and loader) existing so mmap for a given address should
  succeed even without MAP_FIXED.  Something is terribly wrong if this is
  not the case and we should rather fail than silently corrupt the
  underlying mapping.

  Address this issue by changing MAP_FIXED to the newly added
  MAP_FIXED_NOREPLACE.  This will mean that mmap will fail if there is an
  existing mapping clashing with the requested one without clobbering it.

  [mhocko@suse.com: fix build]
  [akpm@linux-foundation.org: coding-style fixes]
  [avagin@openvz.org: don't use the same value for MAP_FIXED_NOREPLACE and MAP_SYNC]
    Link: http://lkml.kernel.org/r/20171218184916.24445-1-avagin@openvz.org
  Link: http://lkml.kernel.org/r/20171213092550.2774-3-mhocko@kernel.org
  Signed-off-by: Michal Hocko <mhocko@suse.com>
  Signed-off-by: Andrei Vagin <avagin@openvz.org>
  Signed-off-by: Michal Hocko <mhocko@suse.com>
  Reviewed-by: Khalid Aziz <khalid.aziz@oracle.com>
  Acked-by: Michael Ellerman <mpe@ellerman.id.au>
  Acked-by: Kees Cook <keescook@chromium.org>
  Cc: Abdul Haleem <abdhalee@linux.vnet.ibm.com>
  Cc: Joel Stanley <joel@jms.id.au>
  Cc: Anshuman Khandual <khandual@linux.vnet.ibm.com>
  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 5f501d555653f8968011a1e65ebb121c8b43c144
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 4ed28639519c7bad5f518e70b3284c6e0763e650
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/4ed28639519c7bad5f518e70b3284c6e0763e650
    reference_type: commit
    reference_id: 4ed28639519c7bad5f518e70b3284c6e0763e650
  - url: https://github.com/torvalds/linux/tree/5f501d555653f8968011a1e65ebb121c8b43c144
    reference_type: commit
    reference_id: 5f501d555653f8968011a1e65ebb121c8b43c144
