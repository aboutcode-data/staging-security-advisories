advisory_id: CVE-2019-3887
datasource_id: collect_linux_fix_commits/CVE-2019-3887
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  bc5725f97408ce78e61735858a113f514738ba3b:Merge tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm

  Pull kvm fixes from Paolo Bonzini:
   "x86 fixes for overflows and other nastiness"

  * tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm:
    KVM: x86: nVMX: fix x2APIC VTPR read intercept
    KVM: x86: nVMX: close leak of L0's x2APIC MSRs (CVE-2019-3887)
    KVM: SVM: prevent DBG_DECRYPT and DBG_ENCRYPT overflow
    kvm: svm: fix potential get_num_contig_pages overflow
  acff78477b9b4f26ecdf65733a4ed77fe837e9dc:KVM: x86: nVMX: close leak of L0's x2APIC MSRs (CVE-2019-3887)

  The nested_vmx_prepare_msr_bitmap() function doesn't directly guard the
  x2APIC MSR intercepts with the "virtualize x2APIC mode" MSR. As a
  result, we discovered the potential for a buggy or malicious L1 to get
  access to L0's x2APIC MSRs, via an L2, as follows.

  1. L1 executes WRMSR(IA32_SPEC_CTRL, 1). This causes the spec_ctrl
  variable, in nested_vmx_prepare_msr_bitmap() to become true.
  2. L1 disables "virtualize x2APIC mode" in VMCS12.
  3. L1 enables "APIC-register virtualization" in VMCS12.

  Now, KVM will set VMCS02's x2APIC MSR intercepts from VMCS12, and then
  set "virtualize x2APIC mode" to 0 in VMCS02. Oops.

  This patch closes the leak by explicitly guarding VMCS02's x2APIC MSR
  intercepts with VMCS12's "virtualize x2APIC mode" control.

  The scenario outlined above and fix prescribed here, were verified with
  a related patch in kvm-unit-tests titled "Add leak scenario to
  virt_x2apic_mode_test".

  Note, it looks like this issue may have been introduced inadvertently
  during a merge---see 15303ba5d1cd.

  Signed-off-by: Marc Orr <marcorr@google.com>
  Reviewed-by: Jim Mattson <jmattson@google.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: acff78477b9b4f26ecdf65733a4ed77fe837e9dc
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: bc5725f97408ce78e61735858a113f514738ba3b
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/acff78477b9b4f26ecdf65733a4ed77fe837e9dc
    reference_type: commit
    reference_id: acff78477b9b4f26ecdf65733a4ed77fe837e9dc
  - url: https://github.com/torvalds/linux/tree/bc5725f97408ce78e61735858a113f514738ba3b
    reference_type: commit
    reference_id: bc5725f97408ce78e61735858a113f514738ba3b
