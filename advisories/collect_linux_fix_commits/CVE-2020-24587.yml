advisory_id: CVE-2020-24587
datasource_id: collect_linux_fix_commits/CVE-2020-24587
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  c3944a5621026c176001493d48ee66ff94e1a39a:ath11k: Clear the fragment cache during key install

  Currently the fragment cache setup during peer assoc is
  cleared only during peer delete. In case a key reinstallation
  happens with the same peer, the same fragment cache with old
  fragments added before key installation could be clubbed
  with fragments received after. This might be exploited
  to mix fragments of different data resulting in a proper
  unintended reassembled packet to be passed up the stack.

  Hence flush the fragment cache on every key installation to prevent
  potential attacks (CVE-2020-24587).

  Tested-on: IPQ8074 hw2.0 AHB WLAN.HK.2.4.0.1-01734-QCAHKSWPL_SILICONZ-1 v2

  Cc: stable@vger.kernel.org
  Signed-off-by: Sriram R <srirrama@codeaurora.org>
  Signed-off-by: Jouni Malinen <jouni@codeaurora.org>
  Link: https://lore.kernel.org/r/20210511200110.218dc777836f.I9af6fc76215a35936c4152552018afb5079c5d8c@changeid
  Signed-off-by: Johannes Berg <johannes.berg@intel.com>
  3edc6b0d6c061a70d8ca3c3c72eb1f58ce29bfb1:mac80211: extend protection against mixed key and fragment cache attacks

  For some chips/drivers, e.g., QCA6174 with ath10k, the decryption is
  done by the hardware, and the Protected bit in the Frame Control field
  is cleared in the lower level driver before the frame is passed to
  mac80211. In such cases, the condition for ieee80211_has_protected() is
  not met in ieee80211_rx_h_defragment() of mac80211 and the new security
  validation steps are not executed.

  Extend mac80211 to cover the case where the Protected bit has been
  cleared, but the frame is indicated as having been decrypted by the
  hardware. This extends protection against mixed key and fragment cache
  attack for additional drivers/chips. This fixes CVE-2020-24586 and
  CVE-2020-24587 for such cases.

  Tested-on: QCA6174 hw3.2 PCI WLAN.RM.4.4.1-00110-QCARMSWP-1

  Cc: stable@vger.kernel.org
  Signed-off-by: Wen Gong <wgong@codeaurora.org>
  Signed-off-by: Jouni Malinen <jouni@codeaurora.org>
  Link: https://lore.kernel.org/r/20210511200110.037aa5ca0390.I7bb888e2965a0db02a67075fcb5deb50eb7408aa@changeid
  Signed-off-by: Johannes Berg <johannes.berg@intel.com>
  94034c40ab4a3fcf581fbc7f8fdf4e29943c4a24:mac80211: prevent mixed key and fragment cache attacks

  Simultaneously prevent mixed key attacks (CVE-2020-24587) and fragment
  cache attacks (CVE-2020-24586). This is accomplished by assigning a
  unique color to every key (per interface) and using this to track which
  key was used to decrypt a fragment. When reassembling frames, it is
  now checked whether all fragments were decrypted using the same key.

  To assure that fragment cache attacks are also prevented, the ID that is
  assigned to keys is unique even over (re)associations and (re)connects.
  This means fragments separated by a (re)association or (re)connect will
  not be reassembled. Because mac80211 now also prevents the reassembly of
  mixed encrypted and plaintext fragments, all cache attacks are prevented.

  Cc: stable@vger.kernel.org
  Signed-off-by: Mathy Vanhoef <Mathy.Vanhoef@kuleuven.be>
  Link: https://lore.kernel.org/r/20210511200110.3f8290e59823.I622a67769ed39257327a362cfc09c812320eb979@changeid
  Signed-off-by: Johannes Berg <johannes.berg@intel.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: c3944a5621026c176001493d48ee66ff94e1a39a
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 94034c40ab4a3fcf581fbc7f8fdf4e29943c4a24
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 3edc6b0d6c061a70d8ca3c3c72eb1f58ce29bfb1
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/3edc6b0d6c061a70d8ca3c3c72eb1f58ce29bfb1
    reference_type: commit
    reference_id: 3edc6b0d6c061a70d8ca3c3c72eb1f58ce29bfb1
  - url: https://github.com/torvalds/linux/tree/94034c40ab4a3fcf581fbc7f8fdf4e29943c4a24
    reference_type: commit
    reference_id: 94034c40ab4a3fcf581fbc7f8fdf4e29943c4a24
  - url: https://github.com/torvalds/linux/tree/c3944a5621026c176001493d48ee66ff94e1a39a
    reference_type: commit
    reference_id: c3944a5621026c176001493d48ee66ff94e1a39a
