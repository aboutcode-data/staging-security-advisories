advisory_id: CVE-2023-6270
datasource_id: collect_linux_fix_commits/CVE-2023-6270
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  6d6e54fc71ad1ab0a87047fd9c211e75d86084a3:aoe: fix the potential use-after-free problem in more places

  For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
  use-after-free problem in aoecmd_cfg_pkts") makes tx() calling dev_put()
  instead of doing in aoecmd_cfg_pkts(). It avoids that the tx() runs
  into use-after-free.

  Then Nicolai Stange found more places in aoe have potential use-after-free
  problem with tx(). e.g. revalidate(), aoecmd_ata_rw(), resend(), probe()
  and aoecmd_cfg_rsp(). Those functions also use aoenet_xmit() to push
  packet to tx queue. So they should also use dev_hold() to increase the
  refcnt of skb->dev.

  On the other hand, moving dev_put() to tx() causes that the refcnt of
  skb->dev be reduced to a negative value, because corresponding
  dev_hold() are not called in revalidate(), aoecmd_ata_rw(), resend(),
  probe(), and aoecmd_cfg_rsp(). This patch fixed this issue.

  Cc: stable@vger.kernel.org
  Link: https://nvd.nist.gov/vuln/detail/CVE-2023-6270
  Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd_cfg_pkts")
  Reported-by: Nicolai Stange <nstange@suse.com>
  Signed-off-by: Chun-Yi Lee <jlee@suse.com>
  Link: https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com
  Link: https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com
  Signed-off-by: Jens Axboe <axboe@kernel.dk>
  6d6e54fc71ad1ab0a87047fd9c211e75d86084a3:aoe: fix the potential use-after-free problem in more places

  For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
  use-after-free problem in aoecmd_cfg_pkts") makes tx() calling dev_put()
  instead of doing in aoecmd_cfg_pkts(). It avoids that the tx() runs
  into use-after-free.

  Then Nicolai Stange found more places in aoe have potential use-after-free
  problem with tx(). e.g. revalidate(), aoecmd_ata_rw(), resend(), probe()
  and aoecmd_cfg_rsp(). Those functions also use aoenet_xmit() to push
  packet to tx queue. So they should also use dev_hold() to increase the
  refcnt of skb->dev.

  On the other hand, moving dev_put() to tx() causes that the refcnt of
  skb->dev be reduced to a negative value, because corresponding
  dev_hold() are not called in revalidate(), aoecmd_ata_rw(), resend(),
  probe(), and aoecmd_cfg_rsp(). This patch fixed this issue.

  Cc: stable@vger.kernel.org
  Link: https://nvd.nist.gov/vuln/detail/CVE-2023-6270
  Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd_cfg_pkts")
  Reported-by: Nicolai Stange <nstange@suse.com>
  Signed-off-by: Chun-Yi Lee <jlee@suse.com>
  Link: https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com
  Link: https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com
  Signed-off-by: Jens Axboe <axboe@kernel.dk>
  f98364e926626c678fb4b9004b75cacf92ff0662:aoe: fix the potential use-after-free problem in aoecmd_cfg_pkts

  This patch is against CVE-2023-6270. The description of cve is:

    A flaw was found in the ATA over Ethernet (AoE) driver in the Linux
    kernel. The aoecmd_cfg_pkts() function improperly updates the refcnt on
    `struct net_device`, and a use-after-free can be triggered by racing
    between the free on the struct and the access through the `skbtxq`
    global queue. This could lead to a denial of service condition or
    potential code execution.

  In aoecmd_cfg_pkts(), it always calls dev_put(ifp) when skb initial
  code is finished. But the net_device ifp will still be used in
  later tx()->dev_queue_xmit() in kthread. Which means that the
  dev_put(ifp) should NOT be called in the success path of skb
  initial code in aoecmd_cfg_pkts(). Otherwise tx() may run into
  use-after-free because the net_device is freed.

  This patch removed the dev_put(ifp) in the success path in
  aoecmd_cfg_pkts(), and added dev_put() after skb xmit in tx().

  Link: https://nvd.nist.gov/vuln/detail/CVE-2023-6270
  Fixes: 7562f876cd93 ("[NET]: Rework dev_base via list_head (v3)")
  Signed-off-by: Chun-Yi Lee <jlee@suse.com>
  Link: https://lore.kernel.org/r/20240305082048.25526-1-jlee@suse.com
  Signed-off-by: Jens Axboe <axboe@kernel.dk>
  f98364e926626c678fb4b9004b75cacf92ff0662:aoe: fix the potential use-after-free problem in aoecmd_cfg_pkts

  This patch is against CVE-2023-6270. The description of cve is:

    A flaw was found in the ATA over Ethernet (AoE) driver in the Linux
    kernel. The aoecmd_cfg_pkts() function improperly updates the refcnt on
    `struct net_device`, and a use-after-free can be triggered by racing
    between the free on the struct and the access through the `skbtxq`
    global queue. This could lead to a denial of service condition or
    potential code execution.

  In aoecmd_cfg_pkts(), it always calls dev_put(ifp) when skb initial
  code is finished. But the net_device ifp will still be used in
  later tx()->dev_queue_xmit() in kthread. Which means that the
  dev_put(ifp) should NOT be called in the success path of skb
  initial code in aoecmd_cfg_pkts(). Otherwise tx() may run into
  use-after-free because the net_device is freed.

  This patch removed the dev_put(ifp) in the success path in
  aoecmd_cfg_pkts(), and added dev_put() after skb xmit in tx().

  Link: https://nvd.nist.gov/vuln/detail/CVE-2023-6270
  Fixes: 7562f876cd93 ("[NET]: Rework dev_base via list_head (v3)")
  Signed-off-by: Chun-Yi Lee <jlee@suse.com>
  Link: https://lore.kernel.org/r/20240305082048.25526-1-jlee@suse.com
  Signed-off-by: Jens Axboe <axboe@kernel.dk>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: f98364e926626c678fb4b9004b75cacf92ff0662
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/6d6e54fc71ad1ab0a87047fd9c211e75d86084a3
    reference_type: commit
    reference_id: 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3
  - url: https://github.com/torvalds/linux/tree/f98364e926626c678fb4b9004b75cacf92ff0662
    reference_type: commit
    reference_id: f98364e926626c678fb4b9004b75cacf92ff0662
