advisory_id: CVE-2012-3412
datasource_id: collect_linux_fix_commits/CVE-2012-3412
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  7e6d06f0de3f74ca929441add094518ae332257c:sfc: Fix maximum number of TSO segments and minimum TX queue size

  Currently an skb requiring TSO may not fit within a minimum-size TX
  queue.  The TX queue selected for the skb may stall and trigger the TX
  watchdog repeatedly (since the problem skb will be retried after the
  TX reset).  This issue is designated as CVE-2012-3412.

  Set the maximum number of TSO segments for our devices to 100.  This
  should make no difference to behaviour unless the actual MSS is less
  than about 700.  Increase the minimum TX queue size accordingly to
  allow for 2 worst-case skbs, so that there will definitely be space
  to add an skb after we wake a queue.

  To avoid invalidating existing configurations, change
  efx_ethtool_set_ringparam() to fix up values that are too small rather
  than returning -EINVAL.

  Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
  Signed-off-by: David S. Miller <davem@davemloft.net>
  30b678d844af3305cda5953467005cebb5d7b687:net: Allow driver to limit number of GSO segments per skb

  A peer (or local user) may cause TCP to use a nominal MSS of as little
  as 88 (actual MSS of 76 with timestamps).  Given that we have a
  sufficiently prodigious local sender and the peer ACKs quickly enough,
  it is nevertheless possible to grow the window for such a connection
  to the point that we will try to send just under 64K at once.  This
  results in a single skb that expands to 861 segments.

  In some drivers with TSO support, such an skb will require hundreds of
  DMA descriptors; a substantial fraction of a TX ring or even more than
  a full ring.  The TX queue selected for the skb may stall and trigger
  the TX watchdog repeatedly (since the problem skb will be retried
  after the TX reset).  This particularly affects sfc, for which the
  issue is designated as CVE-2012-3412.

  Therefore:
  1. Add the field net_device::gso_max_segs holding the device-specific
     limit.
  2. In netif_skb_features(), if the number of segments is too high then
     mask out GSO features to force fall back to software GSO.

  Signed-off-by: Ben Hutchings <bhutchings@solarflare.com>
  Signed-off-by: David S. Miller <davem@davemloft.net>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 7e6d06f0de3f74ca929441add094518ae332257c
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 30b678d844af3305cda5953467005cebb5d7b687
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/30b678d844af3305cda5953467005cebb5d7b687
    reference_type: commit
    reference_id: 30b678d844af3305cda5953467005cebb5d7b687
  - url: https://github.com/torvalds/linux/tree/7e6d06f0de3f74ca929441add094518ae332257c
    reference_type: commit
    reference_id: 7e6d06f0de3f74ca929441add094518ae332257c
