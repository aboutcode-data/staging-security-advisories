advisory_id: CVE-2024-53241
datasource_id: collect_linux_fix_commits/CVE-2024-53241
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  7fa0da5373685e7ed249af3fa317ab1e1ba8b0a6:x86/xen: remove hypercall page

  The hypercall page is no longer needed. It can be removed, as from the
  Xen perspective it is optional.

  But, from Linux's perspective, it removes naked RET instructions that
  escape the speculative protections that Call Depth Tracking and/or
  Untrain Ret are trying to achieve.

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  b1c2cb86f4a7861480ad54bb9a58df3cbebf8e92:x86/xen: use new hypercall functions instead of hypercall page

  Call the Xen hypervisor via the new xen_hypercall_func static-call
  instead of the hypercall page.

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Co-developed-by: Peter Zijlstra <peterz@infradead.org>
  Co-developed-by: Josh Poimboeuf <jpoimboe@redhat.com>
  b4845bb6383821a9516ce30af3a27dc873e37fd4:x86/xen: add central hypercall functions

  Add generic hypercall functions usable for all normal (i.e. not iret)
  hypercalls. Depending on the guest type and the processor vendor
  different functions need to be used due to the to be used instruction
  for entering the hypervisor:

  - PV guests need to use syscall
  - HVM/PVH guests on Intel need to use vmcall
  - HVM/PVH guests on AMD and Hygon need to use vmmcall

  As PVH guests need to issue hypercalls very early during boot, there
  is a 4th hypercall function needed for HVM/PVH which can be used on
  Intel and AMD processors. It will check the vendor type and then set
  the Intel or AMD specific function to use via static_call().

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Co-developed-by: Peter Zijlstra <peterz@infradead.org>
  a2796dff62d6c6bfc5fbebdf2bee0d5ac0438906:x86/xen: don't do PV iret hypercall through hypercall page

  Instead of jumping to the Xen hypercall page for doing the iret
  hypercall, directly code the required sequence in xen-asm.S.

  This is done in preparation of no longer using hypercall page at all,
  as it has shown to cause problems with speculation mitigations.

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  0ef8047b737d7480a5d4c46d956e97c190f13050:x86/static-call: provide a way to do very early static-call updates

  Add static_call_update_early() for updating static-call targets in
  very early boot.

  This will be needed for support of Xen guest type specific hypercall
  functions.

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Co-developed-by: Peter Zijlstra <peterz@infradead.org>
  Co-developed-by: Josh Poimboeuf <jpoimboe@redhat.com>
  dda014ba59331dee4f3b773a020e109932f4bd24:objtool/x86: allow syscall instruction

  The syscall instruction is used in Xen PV mode for doing hypercalls.
  Allow syscall to be used in the kernel in case it is tagged with an
  unwind hint for objtool.

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Co-developed-by: Peter Zijlstra <peterz@infradead.org>
  efbcd61d9bebb771c836a3b8bfced8165633db7c:x86: make get_cpu_vendor() accessible from Xen code

  In order to be able to differentiate between AMD and Intel based
  systems for very early hypercalls without having to rely on the Xen
  hypercall page, make get_cpu_vendor() non-static.

  Refactor early_cpu_init() for the same reason by splitting out the
  loop initializing cpu_devs() into an externally callable function.

  This is part of XSA-466 / CVE-2024-53241.

  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: b1c2cb86f4a7861480ad54bb9a58df3cbebf8e92
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: dda014ba59331dee4f3b773a020e109932f4bd24
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 7fa0da5373685e7ed249af3fa317ab1e1ba8b0a6
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 0ef8047b737d7480a5d4c46d956e97c190f13050
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: a2796dff62d6c6bfc5fbebdf2bee0d5ac0438906
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: b4845bb6383821a9516ce30af3a27dc873e37fd4
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: efbcd61d9bebb771c836a3b8bfced8165633db7c
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/0ef8047b737d7480a5d4c46d956e97c190f13050
    reference_type: commit
    reference_id: 0ef8047b737d7480a5d4c46d956e97c190f13050
  - url: https://github.com/torvalds/linux/tree/7fa0da5373685e7ed249af3fa317ab1e1ba8b0a6
    reference_type: commit
    reference_id: 7fa0da5373685e7ed249af3fa317ab1e1ba8b0a6
  - url: https://github.com/torvalds/linux/tree/a2796dff62d6c6bfc5fbebdf2bee0d5ac0438906
    reference_type: commit
    reference_id: a2796dff62d6c6bfc5fbebdf2bee0d5ac0438906
  - url: https://github.com/torvalds/linux/tree/b1c2cb86f4a7861480ad54bb9a58df3cbebf8e92
    reference_type: commit
    reference_id: b1c2cb86f4a7861480ad54bb9a58df3cbebf8e92
  - url: https://github.com/torvalds/linux/tree/b4845bb6383821a9516ce30af3a27dc873e37fd4
    reference_type: commit
    reference_id: b4845bb6383821a9516ce30af3a27dc873e37fd4
  - url: https://github.com/torvalds/linux/tree/dda014ba59331dee4f3b773a020e109932f4bd24
    reference_type: commit
    reference_id: dda014ba59331dee4f3b773a020e109932f4bd24
  - url: https://github.com/torvalds/linux/tree/efbcd61d9bebb771c836a3b8bfced8165633db7c
    reference_type: commit
    reference_id: efbcd61d9bebb771c836a3b8bfced8165633db7c
