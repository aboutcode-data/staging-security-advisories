advisory_id: cve-2017-17053
datasource_id: collect_linux_fix_commits/cve-2017-17053
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "4819e15f740ec884a50bdc431d7f1e7638b6f7d9:x86/mm/32: Bring back vmalloc faulting on\
  \ x86_32\n\nOne can not simply remove vmalloc faulting on x86-32. Upstream\n\n\tcommit: 7f0a002b5a21\
  \ (\"x86/mm: remove vmalloc faulting\")\n\nremoved it on x86 alltogether because previously\
  \ the\narch_sync_kernel_mappings() interface was introduced. This interface\nadded synchronization\
  \ of vmalloc/ioremap page-table updates to all\npage-tables in the system at creation time\
  \ and was thought to make\nvmalloc faulting obsolete.\n\nBut that assumption was incredibly\
  \ naive.\n\nIt turned out that there is a race window between the time the vmalloc\nor ioremap\
  \ code establishes a mapping and the time it synchronizes\nthis change to other page-tables\
  \ in the system.\n\nDuring this race window another CPU or thread can establish a vmalloc\n\
  mapping which uses the same intermediate page-table entries (e.g. PMD\nor PUD) and does no\
  \ synchronization in the end, because it found all\nnecessary mappings already present in\
  \ the kernel reference page-table.\n\nBut when these intermediate page-table entries are not\
  \ yet\nsynchronized, the other CPU or thread will continue with a vmalloc\naddress that is\
  \ not yet mapped in the page-table it currently uses,\ncausing an unhandled page fault and\
  \ oops like below:\n\n\tBUG: unable to handle page fault for address: fe80c000\n\t#PF: supervisor\
  \ write access in kernel mode\n\t#PF: error_code(0x0002) - not-present page\n\t*pde = 33183067\
  \ *pte = a8648163\n\tOops: 0002 [#1] SMP\n\tCPU: 1 PID: 13514 Comm: cve-2017-17053 Tainted:\
  \ G\n\t...\n\tCall Trace:\n\t ldt_dup_context+0x66/0x80\n\t dup_mm+0x2b3/0x480\n\t copy_process+0x133b/0x15c0\n\
  \t _do_fork+0x94/0x3e0\n\t __ia32_sys_clone+0x67/0x80\n\t __do_fast_syscall_32+0x3f/0x70\n\
  \t do_fast_syscall_32+0x29/0x60\n\t do_SYSENTER_32+0x15/0x20\n\t entry_SYSENTER_32+0x9f/0xf2\n\
  \tEIP: 0xb7eef549\n\nSo the arch_sync_kernel_mappings() interface is racy, but removing it\n\
  would mean to re-introduce the vmalloc_sync_all() interface, which is\neven more awful. Keep\
  \ arch_sync_kernel_mappings() in place and catch\nthe race condition in the page-fault handler\
  \ instead.\n\nDo a partial revert of above commit to get vmalloc faulting on x86-32\nback\
  \ in place.\n\nFixes: 7f0a002b5a21 (\"x86/mm: remove vmalloc faulting\")\nReported-by: Naresh\
  \ Kamboju <naresh.kamboju@linaro.org>\nSigned-off-by: Joerg Roedel <jroedel@suse.de>\nSigned-off-by:\
  \ Ingo Molnar <mingo@kernel.org>\nLink: https://lore.kernel.org/r/20200902155904.17544-1-joro@8bytes.org"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 4819e15f740ec884a50bdc431d7f1e7638b6f7d9
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/4819e15f740ec884a50bdc431d7f1e7638b6f7d9
    reference_type: commit
    reference_id: 4819e15f740ec884a50bdc431d7f1e7638b6f7d9
