advisory_id: CVE-2023-34324
datasource_id: collect_linux_fix_commits/CVE-2023-34324
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  87797fad6cce28ec9be3c13f031776ff4f104cfc:xen/events: replace evtchn_rwlock with RCU

  In unprivileged Xen guests event handling can cause a deadlock with
  Xen console handling. The evtchn_rwlock and the hvc_lock are taken in
  opposite sequence in __hvc_poll() and in Xen console IRQ handling.
  Normally this is no problem, as the evtchn_rwlock is taken as a reader
  in both paths, but as soon as an event channel is being closed, the
  lock will be taken as a writer, which will cause read_lock() to block:

  CPU0                     CPU1                CPU2
  (IRQ handling)           (__hvc_poll())      (closing event channel)

  read_lock(evtchn_rwlock)
                           spin_lock(hvc_lock)
                                               write_lock(evtchn_rwlock)
                                                   [blocks]
  spin_lock(hvc_lock)
      [blocks]
                          read_lock(evtchn_rwlock)
                              [blocks due to writer waiting,
                               and not in_interrupt()]

  This issue can be avoided by replacing evtchn_rwlock with RCU in
  xen_free_irq(). Note that RCU is used only to delay freeing of the
  irq_info memory. There is no RCU based dereferencing or replacement of
  pointers involved.

  In order to avoid potential races between removing the irq_info
  reference and handling of interrupts, set the irq_info pointer to NULL
  only when freeing its memory. The IRQ itself must be freed at that
  time, too, as otherwise the same IRQ number could be allocated again
  before handling of the old instance would have been finished.

  This is XSA-441 / CVE-2023-34324.

  Fixes: 54c9de89895e ("xen/events: add a new "late EOI" evtchn framework")
  Reported-by: Marek Marczykowski-GÃ³recki <marmarek@invisiblethingslab.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 87797fad6cce28ec9be3c13f031776ff4f104cfc
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/87797fad6cce28ec9be3c13f031776ff4f104cfc
    reference_type: commit
    reference_id: 87797fad6cce28ec9be3c13f031776ff4f104cfc
