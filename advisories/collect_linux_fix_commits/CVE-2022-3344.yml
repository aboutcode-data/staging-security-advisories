advisory_id: CVE-2022-3344
datasource_id: collect_linux_fix_commits/CVE-2022-3344
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "ed129ec9057f89d615ba0c81a4984a90345a1684:KVM: x86: forcibly leave nested mode on vCPU\
  \ reset\n\nWhile not obivous, kvm_vcpu_reset() leaves the nested mode by clearing\n'vcpu->arch.hflags'\
  \ but it does so without all the required housekeeping.\n\nOn SVM,\tit is possible to have\
  \ a vCPU reset while in guest mode because\nunlike VMX, on SVM, INIT's are not latched in\
  \ SVM non root mode and in\naddition to that L1 doesn't have to intercept triple fault, which\
  \ should\nalso trigger L1's reset if happens in L2 while L1 didn't intercept it.\n\nIf one\
  \ of the above conditions happen, KVM will\tcontinue to use vmcb02\nwhile not having in the\
  \ guest mode.\n\nLater the IA32_EFER will be cleared which will lead to freeing of the\nnested\
  \ guest state which will (correctly) free the vmcb02, but since\nKVM still uses it (incorrectly)\
  \ this will lead to a use after free\nand kernel crash.\n\nThis issue is assigned CVE-2022-3344\n\
  \nCc: stable@vger.kernel.org\nSigned-off-by: Maxim Levitsky <mlevitsk@redhat.com>\nMessage-Id:\
  \ <20221103141351.50662-5-mlevitsk@redhat.com>\nSigned-off-by: Paolo Bonzini <pbonzini@redhat.com>\n\
  16ae56d7e0528559bf8dc9070e3bfd8ba3de80df:KVM: x86: nSVM: harden svm_free_nested against freeing\
  \ vmcb02 while still in use\n\nMake sure that KVM uses vmcb01 before freeing nested state,\
  \ and warn if\nthat is not the case.\n\nThis is a minimal fix for CVE-2022-3344 making the\
  \ kernel print a warning\ninstead of a kernel panic.\n\nCc: stable@vger.kernel.org\nSigned-off-by:\
  \ Maxim Levitsky <mlevitsk@redhat.com>\nMessage-Id: <20221103141351.50662-3-mlevitsk@redhat.com>\n\
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 16ae56d7e0528559bf8dc9070e3bfd8ba3de80df
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: ed129ec9057f89d615ba0c81a4984a90345a1684
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/16ae56d7e0528559bf8dc9070e3bfd8ba3de80df
    reference_type: commit
    reference_id: 16ae56d7e0528559bf8dc9070e3bfd8ba3de80df
  - url: https://github.com/torvalds/linux/tree/ed129ec9057f89d615ba0c81a4984a90345a1684
    reference_type: commit
    reference_id: ed129ec9057f89d615ba0c81a4984a90345a1684
