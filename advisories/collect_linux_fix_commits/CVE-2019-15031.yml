advisory_id: CVE-2019-15031
datasource_id: collect_linux_fix_commits/CVE-2019-15031
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "a8318c13e79badb92bc6640704a64cc022a6eb97:powerpc/tm: Fix restoring FP/VMX facility\
  \ incorrectly on interrupts\n\nWhen in userspace and MSR FP=0 the hardware FP state is unrelated\
  \ to\nthe current process. This is extended for transactions where if tbegin\nis run with\
  \ FP=0, the hardware checkpoint FP state will also be\nunrelated to the current process. Due\
  \ to this, we need to ensure this\nhardware checkpoint is updated with the correct state before\
  \ we enable\nFP for this process.\n\nUnfortunately we get this wrong when returning to a process\
  \ from a\nhardware interrupt. A process that starts a transaction with FP=0 can\ntake an interrupt.\
  \ When the kernel returns back to that process, we\nchange to FP=1 but with hardware checkpoint\
  \ FP state not updated. If\nthis transaction is then rolled back, the FP registers now contain\
  \ the\nwrong state.\n\nThe process looks like this:\n   Userspace:                      Kernel\n\
  \n               Start userspace\n                with MSR FP=0 TM=1\n                  <\
  \ -----\n   ...\n   tbegin\n   bne\n               Hardware interrupt\n                  \
  \ ---- >\n                                    <do_IRQ...>\n                              \
  \      ....\n                                    ret_from_except\n                       \
  \               restore_math()\n\t\t\t\t        /* sees FP=0 */\n                        \
  \                restore_fp()\n                                          tm_active_with_fp()\n\
  \t\t\t\t\t    /* sees FP=1 (Incorrect) */\n                                          load_fp_state()\n\
  \                                        FP = 0 -> 1\n                  < -----\n        \
  \       Return to userspace\n                 with MSR TM=1 FP=1\n                 with junk\
  \ in the FP TM checkpoint\n   TM rollback\n   reads FP junk\n\nWhen returning from the hardware\
  \ exception, tm_active_with_fp() is\nincorrectly making restore_fp() call load_fp_state()\
  \ which is setting\nFP=1.\n\nThe fix is to remove tm_active_with_fp().\n\ntm_active_with_fp()\
  \ is attempting to handle the case where FP state\nhas been changed inside a transaction.\
  \ In this case the checkpointed\nand transactional FP state is different and hence we must\
  \ restore the\nFP state (ie. we can't do lazy FP restore inside a transaction that's\nused\
  \ FP). It's safe to remove tm_active_with_fp() as this case is\nhandled by restore_tm_state().\
  \ restore_tm_state() detects if FP has\nbeen using inside a transaction and will set load_fp\
  \ and call\nrestore_math() to ensure the FP state (checkpoint and transaction) is\nrestored.\n\
  \nThis is a data integrity problem for the current process as the FP\nregisters are corrupted.\
  \ It's also a security problem as the FP\nregisters from one process may be leaked to another.\n\
  \nSimilarly for VMX.\n\nA simple testcase to replicate this will be posted to\ntools/testing/selftests/powerpc/tm/tm-poison.c\n\
  \nThis fixes CVE-2019-15031.\n\nFixes: a7771176b439 (\"powerpc: Don't enable FP/Altivec if\
  \ not checkpointed\")\nCc: stable@vger.kernel.org # 4.15+\nSigned-off-by: Gustavo Romero <gromero@linux.ibm.com>\n\
  Signed-off-by: Michael Neuling <mikey@neuling.org>\nSigned-off-by: Michael Ellerman <mpe@ellerman.id.au>\n\
  Link: https://lore.kernel.org/r/20190904045529.23002-2-gromero@linux.vnet.ibm.com"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: a8318c13e79badb92bc6640704a64cc022a6eb97
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/a8318c13e79badb92bc6640704a64cc022a6eb97
    reference_type: commit
    reference_id: a8318c13e79badb92bc6640704a64cc022a6eb97
