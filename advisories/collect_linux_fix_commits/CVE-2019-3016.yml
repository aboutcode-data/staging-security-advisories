advisory_id: CVE-2019-3016
datasource_id: collect_linux_fix_commits/CVE-2019-3016
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  a6bd811f1209fe1c64c9f6fd578101d6436c6b6e:x86/KVM: Clean up host's steal time structure

  Now that we are mapping kvm_steal_time from the guest directly we
  don't need keep a copy of it in kvm_vcpu_arch.st. The same is true
  for the stime field.

  This is part of CVE-2019-3016.

  Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
  Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  b043138246a41064527cf019a3d51d9f015e9796:x86/KVM: Make sure KVM_VCPU_FLUSH_TLB flag is not missed

  There is a potential race in record_steal_time() between setting
  host-local vcpu->arch.st.steal.preempted to zero (i.e. clearing
  KVM_VCPU_PREEMPTED) and propagating this value to the guest with
  kvm_write_guest_cached(). Between those two events the guest may
  still see KVM_VCPU_PREEMPTED in its copy of kvm_steal_time, set
  KVM_VCPU_FLUSH_TLB and assume that hypervisor will do the right
  thing. Which it won't.

  Instad of copying, we should map kvm_steal_time and that will
  guarantee atomicity of accesses to @preempted.

  This is part of CVE-2019-3016.

  Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
  Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  917248144db5d7320655dbb41d3af0b8a0f3d589:x86/kvm: Cache gfn to pfn translation

  __kvm_map_gfn()'s call to gfn_to_pfn_memslot() is
  * relatively expensive
  * in certain cases (such as when done from atomic context) cannot be called

  Stashing gfn-to-pfn mapping should help with both cases.

  This is part of CVE-2019-3016.

  Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
  Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  1eff70a9abd46f175defafd29bc17ad456f398a7:x86/kvm: Introduce kvm_(un)map_gfn()

  kvm_vcpu_(un)map operates on gfns from any current address space.
  In certain cases we want to make sure we are not mapping SMRAM
  and for that we can use kvm_(un)map_gfn() that we are introducing
  in this patch.

  This is part of CVE-2019-3016.

  Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
  Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  8c6de56a42e0c657955e12b882a81ef07d1d073e:x86/kvm: Be careful not to clear KVM_VCPU_FLUSH_TLB bit

  kvm_steal_time_set_preempted() may accidentally clear KVM_VCPU_FLUSH_TLB
  bit if it is called more than once while VCPU is preempted.

  This is part of CVE-2019-3016.

  (This bug was also independently discovered by Jim Mattson
  <jmattson@google.com>)

  Signed-off-by: Boris Ostrovsky <boris.ostrovsky@oracle.com>
  Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: b043138246a41064527cf019a3d51d9f015e9796
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 8c6de56a42e0c657955e12b882a81ef07d1d073e
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 1eff70a9abd46f175defafd29bc17ad456f398a7
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: a6bd811f1209fe1c64c9f6fd578101d6436c6b6e
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 917248144db5d7320655dbb41d3af0b8a0f3d589
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/1eff70a9abd46f175defafd29bc17ad456f398a7
    reference_type: commit
    reference_id: 1eff70a9abd46f175defafd29bc17ad456f398a7
  - url: https://github.com/torvalds/linux/tree/8c6de56a42e0c657955e12b882a81ef07d1d073e
    reference_type: commit
    reference_id: 8c6de56a42e0c657955e12b882a81ef07d1d073e
  - url: https://github.com/torvalds/linux/tree/917248144db5d7320655dbb41d3af0b8a0f3d589
    reference_type: commit
    reference_id: 917248144db5d7320655dbb41d3af0b8a0f3d589
  - url: https://github.com/torvalds/linux/tree/a6bd811f1209fe1c64c9f6fd578101d6436c6b6e
    reference_type: commit
    reference_id: a6bd811f1209fe1c64c9f6fd578101d6436c6b6e
  - url: https://github.com/torvalds/linux/tree/b043138246a41064527cf019a3d51d9f015e9796
    reference_type: commit
    reference_id: b043138246a41064527cf019a3d51d9f015e9796
