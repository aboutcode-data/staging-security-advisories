advisory_id: CVE-2019-19769
datasource_id: collect_linux_fix_commits/CVE-2019-19769
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da:locks: fix a potential use-after-free problem\
  \ when wakeup a waiter\n\n'16306a61d3b7 (\"fs/locks: always delete_block after waiting.\"\
  )' add the\nlogic to check waiter->fl_blocker without blocked_lock_lock. And it will\ntrigger\
  \ a UAF when we try to wakeup some waiterï¼š\n\nThread 1 has create a write flock a on file,\
  \ and now thread 2 try to\nunlock and delete flock a, thread 3 try to add flock b on the same\
  \ file.\n\nThread2                         Thread3\n                                flock\
  \ syscall(create flock b)\n\t                        ...flock_lock_inode_wait\n\t\t\t\t  \
  \  flock_lock_inode(will insert\n\t\t\t\t    our fl_blocked_member list\n\t\t\t\t    to flock\
  \ a's fl_blocked_requests)\n\t\t\t\t   sleep\nflock syscall(unlock)\n...flock_lock_inode_wait\n\
  \    locks_delete_lock_ctx\n    ...__locks_wake_up_blocks\n        __locks_delete_blocks(\n\
  \tb->fl_blocker = NULL)\n\t...\n                                   break by a signal\n\t\t\
  \t\t   locks_delete_block\n\t\t\t\t    b->fl_blocker == NULL &&\n\t\t\t\t    list_empty(&b->fl_blocked_requests)\n\
  \t                            success, return directly\n\t\t\t\t locks_free_lock b\n\twake_up(&b->fl_waiter)\n\
  \ttrigger UAF\n\nFix it by remove this logic, and this patch may also fix CVE-2019-19769.\n\
  \nCc: stable@vger.kernel.org\nFixes: 16306a61d3b7 (\"fs/locks: always delete_block after waiting.\"\
  )\nSigned-off-by: yangerkun <yangerkun@huawei.com>\nSigned-off-by: Jeff Layton <jlayton@kernel.org>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da
    reference_type: commit
    reference_id: 6d390e4b5d48ec03bb87e63cf0a2bff5f4e116da
