advisory_id: CVE-2017-5753
datasource_id: collect_linux_fix_commits/CVE-2017-5753
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  3214d01f139b7544e870fc0b7fcce8da13c1cb51:KVM: PPC: Book3S: Provide information about hardware/firmware CVE workarounds

  This adds a new ioctl, KVM_PPC_GET_CPU_CHAR, that gives userspace
  information about the underlying machine's level of vulnerability
  to the recently announced vulnerabilities CVE-2017-5715,
  CVE-2017-5753 and CVE-2017-5754, and whether the machine provides
  instructions to assist software to work around the vulnerabilities.

  The ioctl returns two u64 words describing characteristics of the
  CPU and required software behaviour respectively, plus two mask
  words which indicate which bits have been filled in by the kernel,
  for extensibility.  The bit definitions are the same as for the
  new H_GET_CPU_CHARACTERISTICS hypercall.

  There is also a new capability, KVM_CAP_PPC_GET_CPU_CHAR, which
  indicates whether the new ioctl is available.

  Signed-off-by: Paul Mackerras <paulus@ozlabs.org>
  05992edc279237d5803d64578e0c72b604970a49:Merge branch 'kvm-insert-lfence'

  Topic branch for CVE-2017-5753, avoiding conflicts in the next merge window.
  2aad9b3e0711f8c67c472920cd5b70199fba8520:Merge branch 'kvm-insert-lfence' into kvm-master

  Topic branch for CVE-2017-5753, avoiding conflicts in the next merge window.
  75f139aaf896d6fdeec2e468ddfa4b2fe469bf40:KVM: x86: Add memory barrier on vmcs field lookup

  This adds a memory barrier when performing a lookup into
  the vmcs_field_to_offset_table.  This is related to
  CVE-2017-5753.

  Signed-off-by: Andrew Honig <ahonig@google.com>
  Reviewed-by: Jim Mattson <jmattson@google.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  b2157399cc9898260d6031c5bfe45fe137c1fbe7:bpf: prevent out-of-bounds speculation

  Under speculation, CPUs may mis-predict branches in bounds checks. Thus,
  memory accesses under a bounds check may be speculated even if the
  bounds check fails, providing a primitive for building a side channel.

  To avoid leaking kernel data round up array-based maps and mask the index
  after bounds check, so speculated load with out of bounds index will load
  either valid value from the array or zero from the padded area.

  Unconditionally mask index for all array types even when max_entries
  are not rounded to power of 2 for root user.
  When map is created by unpriv user generate a sequence of bpf insns
  that includes AND operation to make sure that JITed code includes
  the same 'index & index_mask' operation.

  If prog_array map is created by unpriv user replace
    bpf_tail_call(ctx, map, index);
  with
    if (index >= max_entries) {
      index &= map->index_mask;
      bpf_tail_call(ctx, map, index);
    }
  (along with roundup to power 2) to prevent out-of-bounds speculation.
  There is secondary redundant 'if (index >= max_entries)' in the interpreter
  and in all JITs, but they can be optimized later if necessary.

  Other array-like maps (cpumap, devmap, sockmap, perf_event_array, cgroup_array)
  cannot be used by unpriv, so no changes there.

  That fixes bpf side of "Variant 1: bounds check bypass (CVE-2017-5753)" on
  all architectures with and without JIT.

  v2->v3:
  Daniel noticed that attack potentially can be crafted via syscall commands
  without loading the program, so add masking to those paths as well.

  Signed-off-by: Alexei Starovoitov <ast@kernel.org>
  Acked-by: John Fastabend <john.fastabend@gmail.com>
  Signed-off-by: Daniel Borkmann <daniel@iogearbox.net>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 75f139aaf896d6fdeec2e468ddfa4b2fe469bf40
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: b2157399cc9898260d6031c5bfe45fe137c1fbe7
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 2aad9b3e0711f8c67c472920cd5b70199fba8520
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 05992edc279237d5803d64578e0c72b604970a49
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 3214d01f139b7544e870fc0b7fcce8da13c1cb51
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/05992edc279237d5803d64578e0c72b604970a49
    reference_type: commit
    reference_id: 05992edc279237d5803d64578e0c72b604970a49
  - url: https://github.com/torvalds/linux/tree/2aad9b3e0711f8c67c472920cd5b70199fba8520
    reference_type: commit
    reference_id: 2aad9b3e0711f8c67c472920cd5b70199fba8520
  - url: https://github.com/torvalds/linux/tree/3214d01f139b7544e870fc0b7fcce8da13c1cb51
    reference_type: commit
    reference_id: 3214d01f139b7544e870fc0b7fcce8da13c1cb51
  - url: https://github.com/torvalds/linux/tree/75f139aaf896d6fdeec2e468ddfa4b2fe469bf40
    reference_type: commit
    reference_id: 75f139aaf896d6fdeec2e468ddfa4b2fe469bf40
  - url: https://github.com/torvalds/linux/tree/b2157399cc9898260d6031c5bfe45fe137c1fbe7
    reference_type: commit
    reference_id: b2157399cc9898260d6031c5bfe45fe137c1fbe7
