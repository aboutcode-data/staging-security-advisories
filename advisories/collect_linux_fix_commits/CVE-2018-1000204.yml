advisory_id: CVE-2018-1000204
datasource_id: collect_linux_fix_commits/CVE-2018-1000204
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  41e99fe2005182139b1058db71f0d241f8f0078c:usb: storage: Fix memory leak in USB bulk transport

  A kernel memory leak was identified by the 'ioctl_sg01' test from Linux
  Test Project (LTP). The following bytes were mainly observed: 0x53425355.

  When USB storage devices incorrectly skip the data phase with status data,
  the code extracts/validates the CSW from the sg buffer, but fails to clear
  it afterwards. This leaves status protocol data in srb's transfer buffer,
  such as the US_BULK_CS_SIGN 'USBS' signature observed here. Thus, this can
  lead to USB protocols leaks to user space through SCSI generic (/dev/sg*)
  interfaces, such as the one seen here when the LTP test requested 512 KiB.

  Fix the leak by zeroing the CSW data in srb's transfer buffer immediately
  after the validation of devices that skip data phase.

  Note: Differently from CVE-2018-1000204, which fixed a big leak by zero-
  ing pages at allocation time, this leak occurs after allocation, when USB
  protocol data is written to already-allocated sg pages.

  Fixes: a45b599ad808 ("scsi: sg: allocate with __GFP_ZERO in sg_build_indirect()")
  Cc: stable <stable@kernel.org>
  Signed-off-by: Desnes Nunes <desnesn@redhat.com>
  Reviewed-by: Alan Stern <stern@rowland.harvard.edu>
  Link: https://patch.msgid.link/20251031043436.55929-1-desnesn@redhat.com
  Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 41e99fe2005182139b1058db71f0d241f8f0078c
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/41e99fe2005182139b1058db71f0d241f8f0078c
    reference_type: commit
    reference_id: 41e99fe2005182139b1058db71f0d241f8f0078c
