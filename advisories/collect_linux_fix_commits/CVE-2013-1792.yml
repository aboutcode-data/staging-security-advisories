advisory_id: CVE-2013-1792
datasource_id: collect_linux_fix_commits/CVE-2013-1792
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "0da9dfdd2cd9889201bc6f6f43580c99165cd087:keys: fix race with concurrent install_user_keyrings()\n\
  \nThis fixes CVE-2013-1792.\n\nThere is a race in install_user_keyrings() that can cause a\
  \ NULL pointer\ndereference when called concurrently for the same user if the uid and\nuid-session\
  \ keyrings are not yet created.  It might be possible for an\nunprivileged user to trigger\
  \ this by calling keyctl() from userspace in\nparallel immediately after logging in.\n\nAssume\
  \ that we have two threads both executing lookup_user_key(), both\nlooking for KEY_SPEC_USER_SESSION_KEYRING.\n\
  \n\tTHREAD A\t\t\tTHREAD B\n\t===============================\t===============================\n\
  \t\t\t\t\t==>call install_user_keyrings();\n\tif (!cred->user->session_keyring)\n\t==>call\
  \ install_user_keyrings()\n\t\t\t\t\t...\n\t\t\t\t\tuser->uid_keyring = uid_keyring;\n\tif\
  \ (user->uid_keyring)\n\t\treturn 0;\n\t<==\n\tkey = cred->user->session_keyring [== NULL]\n\
  \t\t\t\t\tuser->session_keyring = session_keyring;\n\tatomic_inc(&key->usage); [oops]\n\n\
  At the point thread A dereferences cred->user->session_keyring, thread B\nhasn't updated user->session_keyring\
  \ yet, but thread A assumes it is\npopulated because install_user_keyrings() returned ok.\n\
  \nThe race window is really small but can be exploited if, for example,\nthread B is interrupted\
  \ or preempted after initializing uid_keyring, but\nbefore doing setting session_keyring.\n\
  \nThis couldn't be reproduced on a stock kernel.  However, after placing\nsystemtap probe\
  \ on 'user->session_keyring = session_keyring;' that\nintroduced some delay, the kernel could\
  \ be crashed reliably.\n\nFix this by checking both pointers before deciding whether to return.\n\
  Alternatively, the test could be done away with entirely as it is checked\ninside the mutex\
  \ - but since the mutex is global, that may not be the best\nway.\n\nSigned-off-by: David\
  \ Howells <dhowells@redhat.com>\nReported-by: Mateusz Guzik <mguzik@redhat.com>\nCc: <stable@kernel.org>\n\
  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by: James Morris <james.l.morris@oracle.com>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 0da9dfdd2cd9889201bc6f6f43580c99165cd087
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/0da9dfdd2cd9889201bc6f6f43580c99165cd087
    reference_type: commit
    reference_id: 0da9dfdd2cd9889201bc6f6f43580c99165cd087
