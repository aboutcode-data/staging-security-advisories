advisory_id: CVE-2015-5307
datasource_id: collect_linux_fix_commits/CVE-2015-5307
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  2f4073e08f4cc5a41e35d777c240aaadd0257051:KVM: VMX: Enable Notify VM exit

  There are cases that malicious virtual machines can cause CPU stuck (due
  to event windows don't open up), e.g., infinite loop in microcode when
  nested #AC (CVE-2015-5307). No event window means no event (NMI, SMI and
  IRQ) can be delivered. It leads the CPU to be unavailable to host or
  other VMs.

  VMM can enable notify VM exit that a VM exit generated if no event
  window occurs in VM non-root mode for a specified amount of time (notify
  window).

  Feature enabling:
  - The new vmcs field SECONDARY_EXEC_NOTIFY_VM_EXITING is introduced to
    enable this feature. VMM can set NOTIFY_WINDOW vmcs field to adjust
    the expected notify window.
  - Add a new KVM capability KVM_CAP_X86_NOTIFY_VMEXIT so that user space
    can query and enable this feature in per-VM scope. The argument is a
    64bit value: bits 63:32 are used for notify window, and bits 31:0 are
    for flags. Current supported flags:
    - KVM_X86_NOTIFY_VMEXIT_ENABLED: enable the feature with the notify
      window provided.
    - KVM_X86_NOTIFY_VMEXIT_USER: exit to userspace once the exits happen.
  - It's safe to even set notify window to zero since an internal hardware
    threshold is added to vmcs.notify_window.

  VM exit handling:
  - Introduce a vcpu state notify_window_exits to records the count of
    notify VM exits and expose it through the debugfs.
  - Notify VM exit can happen incident to delivery of a vector event.
    Allow it in KVM.
  - Exit to userspace unconditionally for handling when VM_CONTEXT_INVALID
    bit is set.

  Nested handling
  - Nested notify VM exits are not supported yet. Keep the same notify
    window control in vmcs02 as vmcs01, so that L1 can't escape the
    restriction of notify VM exits through launching L2 VM.

  Notify VM exit is defined in latest Intel Architecture Instruction Set
  Extensions Programming Reference, chapter 9.2.

  Co-developed-by: Xiaoyao Li <xiaoyao.li@intel.com>
  Signed-off-by: Xiaoyao Li <xiaoyao.li@intel.com>
  Signed-off-by: Tao Xu <tao3.xu@intel.com>
  Co-developed-by: Chenyi Qiang <chenyi.qiang@intel.com>
  Signed-off-by: Chenyi Qiang <chenyi.qiang@intel.com>
  Message-Id: <20220524135624.22988-5-chenyi.qiang@intel.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  54a20552e1eae07aa240fa370a0293e006b5faed:KVM: x86: work around infinite loop in microcode when #AC is delivered

  It was found that a guest can DoS a host by triggering an infinite
  stream of "alignment check" (#AC) exceptions.  This causes the
  microcode to enter an infinite loop where the core never receives
  another interrupt.  The host kernel panics pretty quickly due to the
  effects (CVE-2015-5307).

  Signed-off-by: Eric Northup <digitaleric@google.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 2f4073e08f4cc5a41e35d777c240aaadd0257051
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 54a20552e1eae07aa240fa370a0293e006b5faed
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/2f4073e08f4cc5a41e35d777c240aaadd0257051
    reference_type: commit
    reference_id: 2f4073e08f4cc5a41e35d777c240aaadd0257051
  - url: https://github.com/torvalds/linux/tree/54a20552e1eae07aa240fa370a0293e006b5faed
    reference_type: commit
    reference_id: 54a20552e1eae07aa240fa370a0293e006b5faed
