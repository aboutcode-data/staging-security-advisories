advisory_id: CVE-2017-7184
datasource_id: collect_linux_fix_commits/CVE-2017-7184
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  f843ee6dd019bcece3e74e76ad9df0155655d0df:xfrm_user: validate XFRM_MSG_NEWAE incoming ESN size harder

  Kees Cook has pointed out that xfrm_replay_state_esn_len() is subject to
  wrapping issues.  To ensure we are correctly ensuring that the two ESN
  structures are the same size compare both the overall size as reported
  by xfrm_replay_state_esn_len() and the internal length are the same.

  CVE-2017-7184
  Signed-off-by: Andy Whitcroft <apw@canonical.com>
  Acked-by: Steffen Klassert <steffen.klassert@secunet.com>
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
  677e806da4d916052585301785d847c3b3e6186a:xfrm_user: validate XFRM_MSG_NEWAE XFRMA_REPLAY_ESN_VAL replay_window

  When a new xfrm state is created during an XFRM_MSG_NEWSA call we
  validate the user supplied replay_esn to ensure that the size is valid
  and to ensure that the replay_window size is within the allocated
  buffer.  However later it is possible to update this replay_esn via a
  XFRM_MSG_NEWAE call.  There we again validate the size of the supplied
  buffer matches the existing state and if so inject the contents.  We do
  not at this point check that the replay_window is within the allocated
  memory.  This leads to out-of-bounds reads and writes triggered by
  netlink packets.  This leads to memory corruption and the potential for
  priviledge escalation.

  We already attempt to validate the incoming replay information in
  xfrm_new_ae() via xfrm_replay_verify_len().  This confirms that the user
  is not trying to change the size of the replay state buffer which
  includes the replay_esn.  It however does not check the replay_window
  remains within that buffer.  Add validation of the contained
  replay_window.

  CVE-2017-7184
  Signed-off-by: Andy Whitcroft <apw@canonical.com>
  Acked-by: Steffen Klassert <steffen.klassert@secunet.com>
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: f843ee6dd019bcece3e74e76ad9df0155655d0df
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 677e806da4d916052585301785d847c3b3e6186a
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/677e806da4d916052585301785d847c3b3e6186a
    reference_type: commit
    reference_id: 677e806da4d916052585301785d847c3b3e6186a
  - url: https://github.com/torvalds/linux/tree/f843ee6dd019bcece3e74e76ad9df0155655d0df
    reference_type: commit
    reference_id: f843ee6dd019bcece3e74e76ad9df0155655d0df
