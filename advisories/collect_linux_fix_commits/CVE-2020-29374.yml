advisory_id: CVE-2020-29374
datasource_id: collect_linux_fix_commits/CVE-2020-29374
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "3bff7e3f1f16dc7305d12905c51c278b54970f0e:mm/huge_memory: streamline COW logic in do_huge_pmd_wp_page()\n\
  \nWe currently have a different COW logic for anon THP than we have for\nordinary anon pages\
  \ in do_wp_page(): the effect is that the issue reported\nin CVE-2020-29374 is currently still\
  \ possible for anon THP: an unintended\ninformation leak from the parent to the child.\n\n\
  Let's apply the same logic (page_count() == 1), with similar optimizations\nto remove additional\
  \ references first as we really want to avoid\nPTE-mapping the THP and copying individual\
  \ pages best we can.\n\nIf we end up with a page that has page_count() != 1, we'll have to\
  \ PTE-map\nthe THP and fallback to do_wp_page(), which will always copy the page.\n\nNote\
  \ that KSM does not apply to THP.\n\nI. Interaction with the swapcache and writeback\n\nWhile\
  \ a THP is in the swapcache, the swapcache holds one reference on each\nsubpage of the THP.\
  \  So with PageSwapCache() set, we expect as many\nadditional references as we have subpages.\
  \  If we manage to remove the THP\nfrom the swapcache, all these references will be gone.\n\
  \nUsually, a THP is not split when entered into the swapcache and stays a\ncompound page.\
  \  However, try_to_unmap() will PTE-map the THP and use PTE\nswap entries.  There are no PMD\
  \ swap entries for that purpose,\nconsequently, we always only swapin subpages into PTEs.\n\
  \nRemoving a page from the swapcache can fail either when there are\nremaining swap entries\
  \ (in which case COW is the right thing to do) or if\nthe page is currently under writeback.\n\
  \nHaving a locked, R/O PMD-mapped THP that is in the swapcache seems to be\npossible only\
  \ in corner cases, for example, if try_to_unmap() failed after\nadding the page to the swapcache.\
  \  However, it's comparatively easy to\nhandle.\n\nAs we have to fully unmap a THP before\
  \ starting writeback, and swapin is\nalways done on the PTE level, we shouldn't find a R/O\
  \ PMD-mapped THP in\nthe swapcache that is under writeback.  This should at least leave\n\
  writeback out of the picture.\n\nII. Interaction with GUP references\n\nHaving a R/O PMD-mapped\
  \ THP with GUP references (i.e., R/O references)\nwill result in PTE-mapping the THP on a\
  \ write fault.  Similar to ordinary\nanon pages, do_wp_page() will have to copy sub-pages\
  \ and result in a\ndisconnect between the GUP references and the pages actually mapped into\n\
  the page tables.  To improve the situation in the future, we'll need\nadditional handling\
  \ to mark anonymous pages as definitely exclusive to a\nsingle process, only allow GUP pins\
  \ on exclusive anon pages, and disallow\nsharing of exclusive anon pages with GUP pins e.g.,\
  \ during fork().\n\nIII. Interaction with references from LRU pagevecs\n\nThere is no need\
  \ to try draining the (local) LRU pagevecs in case we would\nstumble over a !PageLRU() page:\
  \ folio_add_lru() and friends will always\nflush the affected pagevec after adding a compound\
  \ page to it immediately\n-- pagevec_add_and_need_flush() always returns \"true\" for them.\
  \  Note that\nthe LRU pagevecs will hold a reference on the compound page for a very\nshort\
  \ time, between adding the page to the pagevec and draining it\nimmediately afterwards.\n\n\
  IV. Interaction with speculative/temporary references\n\nSimilar to ordinary anon pages, other\
  \ speculative/temporary references on\nthe THP, for example, from the pagecache or page migration\
  \ code, will\ndisallow exclusive reuse of the page.  We'll have to PTE-map the THP.\n\nLink:\
  \ https://lkml.kernel.org/r/20220131162940.210846-6-david@redhat.com\nSigned-off-by: David\
  \ Hildenbrand <david@redhat.com>\nAcked-by: Vlastimil Babka <vbabka@suse.cz>\nCc: Andrea Arcangeli\
  \ <aarcange@redhat.com>\nCc: Christoph Hellwig <hch@lst.de>\nCc: David Rientjes <rientjes@google.com>\n\
  Cc: Don Dutile <ddutile@redhat.com>\nCc: Hugh Dickins <hughd@google.com>\nCc: Jan Kara <jack@suse.cz>\n\
  Cc: Jann Horn <jannh@google.com>\nCc: Jason Gunthorpe <jgg@nvidia.com>\nCc: John Hubbard <jhubbard@nvidia.com>\n\
  Cc: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>\nCc: Liang Zhang <zhangliang5@huawei.com>\n\
  Cc: Matthew Wilcox (Oracle) <willy@infradead.org>\nCc: Michal Hocko <mhocko@kernel.org>\n\
  Cc: Mike Kravetz <mike.kravetz@oracle.com>\nCc: Mike Rapoport <rppt@linux.ibm.com>\nCc: Nadav\
  \ Amit <nadav.amit@gmail.com>\nCc: Oleg Nesterov <oleg@redhat.com>\nCc: Peter Xu <peterx@redhat.com>\n\
  Cc: Rik van Riel <riel@surriel.com>\nCc: Roman Gushchin <roman.gushchin@linux.dev>\nCc: Shakeel\
  \ Butt <shakeelb@google.com>\nCc: Yang Shi <shy828301@gmail.com>\nSigned-off-by: Andrew Morton\
  \ <akpm@linux-foundation.org>\nSigned-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n\
  c145e0b47c77ebeefdfd73dbb344577b2fc9b065:mm: streamline COW logic in do_swap_page()\n\nCurrently\
  \ we have a different COW logic when:\n* triggering a read-fault to swapin first and then\
  \ trigger a write-fault\n  -> do_swap_page() + do_wp_page()\n* triggering a write-fault to\
  \ swapin\n  -> do_swap_page() + do_wp_page() only if we fail reuse in do_swap_page()\n\nThe\
  \ COW logic in do_swap_page() is different than our reuse logic in\ndo_wp_page().  The COW\
  \ logic in do_wp_page() -- page_count() == 1 -- makes\ncurrently sure that we certainly don't\
  \ have a remaining reference, e.g.,\nvia GUP, on the target page we want to reuse: if there\
  \ is any unexpected\nreference, we have to copy to avoid information leaks.\n\nAs do_swap_page()\
  \ behaves differently, in environments with swap enabled\nwe can currently have an unintended\
  \ information leak from the parent to\nthe child, similar as known from CVE-2020-29374:\n\n\
  \t1. Parent writes to anonymous page\n\t-> Page is mapped writable and modified\n\t2. Page\
  \ is swapped out\n\t-> Page is unmapped and replaced by swap entry\n\t3. fork()\n\t-> Swap\
  \ entries are copied to child\n\t4. Child pins page R/O\n\t-> Page is mapped R/O into child\n\
  \t5. Child unmaps page\n\t-> Child still holds GUP reference\n\t6. Parent writes to page\n\
  \t-> Page is reused in do_swap_page()\n\t-> Child can observe changes\n\nExchanging 2. and\
  \ 3. should have the same effect.\n\nLet's apply the same COW logic as in do_wp_page(), conditionally\
  \ trying to\nremove the page from the swapcache after freeing the swap entry, however,\nbefore\
  \ actually mapping our page.  We can change the order now that we use\ntry_to_free_swap(),\
  \ which doesn't care about the mapcount, instead of\nreuse_swap_page().\n\nTo handle references\
  \ from the LRU pagevecs, conditionally drain the local\nLRU pagevecs when required, however,\
  \ don't consider the page_count() when\ndeciding whether to drain to keep it simple for now.\n\
  \nLink: https://lkml.kernel.org/r/20220131162940.210846-5-david@redhat.com\nSigned-off-by:\
  \ David Hildenbrand <david@redhat.com>\nAcked-by: Vlastimil Babka <vbabka@suse.cz>\nCc: Andrea\
  \ Arcangeli <aarcange@redhat.com>\nCc: Christoph Hellwig <hch@lst.de>\nCc: David Rientjes\
  \ <rientjes@google.com>\nCc: Don Dutile <ddutile@redhat.com>\nCc: Hugh Dickins <hughd@google.com>\n\
  Cc: Jan Kara <jack@suse.cz>\nCc: Jann Horn <jannh@google.com>\nCc: Jason Gunthorpe <jgg@nvidia.com>\n\
  Cc: John Hubbard <jhubbard@nvidia.com>\nCc: Kirill A. Shutemov <kirill.shutemov@linux.intel.com>\n\
  Cc: Liang Zhang <zhangliang5@huawei.com>\nCc: Matthew Wilcox (Oracle) <willy@infradead.org>\n\
  Cc: Michal Hocko <mhocko@kernel.org>\nCc: Mike Kravetz <mike.kravetz@oracle.com>\nCc: Mike\
  \ Rapoport <rppt@linux.ibm.com>\nCc: Nadav Amit <nadav.amit@gmail.com>\nCc: Oleg Nesterov\
  \ <oleg@redhat.com>\nCc: Peter Xu <peterx@redhat.com>\nCc: Rik van Riel <riel@surriel.com>\n\
  Cc: Roman Gushchin <roman.gushchin@linux.dev>\nCc: Shakeel Butt <shakeelb@google.com>\nCc:\
  \ Yang Shi <shy828301@gmail.com>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n\
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>\n53a05ad9f21d858d24f76d12b3e990405f2036d1:mm:\
  \ optimize do_wp_page() for exclusive pages in the swapcache\n\nPatch series \"mm: COW fixes\
  \ part 1: fix the COW security issue for THP and swap\", v3.\n\nThis series attempts to optimize\
  \ and streamline the COW logic for ordinary\nanon pages and THP anon pages, fixing two remaining\
  \ instances of\nCVE-2020-29374 in do_swap_page() and do_huge_pmd_wp_page(): information\n\
  can leak from a parent process to a child process via anonymous pages\nshared during fork().\n\
  \nThis issue, including other related COW issues, has been summarized in [2]:\n\n \"1. Observing\
  \ Memory Modifications of Private Pages From A Child Process\n\n  Long story short: process-private\
  \ memory might not be as private as you\n  think once you fork(): successive modifications\
  \ of private memory\n  regions in the parent process can still be observed by the child\n\
  \  process, for example, by smart use of vmsplice()+munmap().\n\n  The core problem is that\
  \ pinning pages readable in a child process, such\n  as done via the vmsplice system call,\
  \ can result in a child process\n  observing memory modifications done in the parent process\
  \ the child is\n  not supposed to observe. [1] contains an excellent summary and [2]\n  contains\
  \ further details. This issue was assigned CVE-2020-29374 [9].\n\n  For this to trigger, it's\
  \ required to use a fork() without subsequent\n  exec(), for example, as used under Android\
  \ zygote. Without further\n  details about an application that forks less-privileged child\
  \ processes,\n  one cannot really say what's actually affected and what's not -- see the\n\
  \  details section the end of this mail for a short sshd/openssh analysis.\n\n  While commit\
  \ 17839856fd58 (\"gup: document and work around \"COW can break\n  either way\" issue\") fixed\
  \ this issue and resulted in other problems\n  (e.g., ptrace on pmem), commit 09854ba94c6a\
  \ (\"mm: do_wp_page()\n  simplification\") re-introduced part of the problem unfortunately.\n\
  \n  The original reproducer can be modified quite easily to use THP [3] and\n  make the issue\
  \ appear again on upstream kernels. I modified it to use\n  hugetlb [4] and it triggers as\
  \ well. The problem is certainly less\n  severe with hugetlb than with THP; it merely highlights\
  \ that we still\n  have plenty of open holes we should be closing/fixing.\n\n  Regarding vmsplice(),\
  \ the only known workaround is to disallow the\n  vmsplice() system call ... or disable THP\
  \ and hugetlb. But who knows\n  what else is affected (RDMA? O_DIRECT?) to achieve the same\
  \ goal -- in\n  the end, it's a more generic issue\"\n\nThis security issue was first reported\
  \ by Jann Horn on 27 May 2020 and it\ncurrently affects anonymous pages during swapin, anonymous\
  \ THP and hugetlb.\nThis series tackles anonymous pages during swapin and anonymous THP:\n\
  \n - do_swap_page() for handling COW on PTEs during swapin directly\n\n - do_huge_pmd_wp_page()\
  \ for handling COW on PMD-mapped THP during write\n   faults\n\nWith this series, we'll apply\
  \ the same COW logic we have in do_wp_page()\nto all swappable anon pages: don't reuse (map\
  \ writable) the page in\ncase there are additional references (page_count() != 1). All users\
  \ of\nreuse_swap_page() are remove, and consequently reuse_swap_page() is\nremoved.\n\nIn\
  \ general, we're struggling with the following COW-related issues:\n\n(1) \"missed COW\":\
  \ we miss to copy on write and reuse the page (map it\n    writable) although we must copy\
  \ because there are pending references\n    from another process to this page. The result\
  \ is a security issue.\n\n(2) \"wrong COW\": we copy on write although we wouldn't have to\
  \ and\n    shouldn't: if there are valid GUP references, they will become out\n    of sync\
  \ with the pages mapped into the page table. We fail to detect\n    that such a page can be\
  \ reused safely, especially if never more than\n    a single process mapped the page. The\
  \ result is an intra process\n    memory corruption.\n\n(3) \"unnecessary COW\": we copy on\
  \ write although we wouldn't have to:\n    performance degradation and temporary increases\
  \ swap+memory\n    consumption can be the result.\n\nWhile this series fixes (1) for swappable\
  \ anon pages, it tries to reduce\nreported cases of (3) first as good and easy as possible\
  \ to limit the\nimpact when streamlining.  The individual patches try to describe in\nwhich\
  \ cases we will run into (3).\n\nThis series certainly makes (2) worse for THP, because a\
  \ THP will now\nget PTE-mapped on write faults if there are additional references, even\n\
  if there was only ever a single process involved: once PTE-mapped, we'll\ncopy each and every\
  \ subpage and won't reuse any subpage as long as the\nunderlying compound page wasn't split.\n\
  \nI'm working on an approach to fix (2) and improve (3): PageAnonExclusive\nto mark anon pages\
  \ that are exclusive to a single process, allow GUP\npins only on such exclusive pages, and\
  \ allow turning exclusive pages\nshared (clearing PageAnonExclusive) only if there are no\
  \ GUP pins.  Anon\npages with PageAnonExclusive set never have to be copied during write\n\
  faults, but eventually during fork() if they cannot be turned shared.\nThe improved reuse\
  \ logic in this series will essentially also be the\nlogic to reset PageAnonExclusive.  This\
  \ work will certainly take a\nwhile, but I'm planning on sharing details before having code\
  \ fully\nready.\n\n#1-#5 can be applied independently of the rest. #6-#9 are mostly only\n\
  cleanups related to reuse_swap_page().\n\nNotes:\n* For now, I'll leave hugetlb code untouched:\
  \ \"unnecessary COW\" might\n  easily break existing setups because hugetlb pages are a scarce\
  \ resource\n  and we could just end up having to crash the application when we run out\n \
  \ of hugetlb pages. We have to be very careful and the security aspect with\n  hugetlb is\
  \ most certainly less relevant than for unprivileged anon pages.\n* Instead of lru_add_drain()\
  \ we might actually just drain the lru_add list\n  or even just remove the single page of\
  \ interest from the lru_add list.\n  This would require a new helper function, and could be\
  \ added if the\n  conditional lru_add_drain() turn out to be a problem.\n* I extended the\
  \ test case already included in [1] to also test for the\n  newly found do_swap_page() case.\
  \ I'll send that out separately once/if\n  this part was merged.\n\n[1] https://lkml.kernel.org/r/20211217113049.23850-1-david@redhat.com\n\
  [2] https://lore.kernel.org/r/3ae33b08-d9ef-f846-56fb-645e3b9b4c66@redhat.com\n\nThis patch\
  \ (of 9):\n\nLiang Zhang reported [1] that the current COW logic in do_wp_page() is\nsub-optimal\
  \ when it comes to swap+read fault+write fault of anonymous\npages that have a single user,\
  \ visible via a performance degradation in\nthe redis benchmark.  Something similar was previously\
  \ reported [2] by\nNadav with a simple reproducer.\n\nAfter we put an anon page into the swapcache\
  \ and unmapped it from a single\nprocess, that process might read that page again and refault\
  \ it read-only.\nIf that process then writes to that page, the process is actually the\nexclusive\
  \ user of the page, however, the COW logic in do_co_page() won't\nbe able to reuse it due\
  \ to the additional reference from the swapcache.\n\nLet's optimize for pages that have been\
  \ added to the swapcache but only\nhave an exclusive user.  Try removing the swapcache reference\
  \ if there is\nhope that we're the exclusive user.\n\nWe will fail removing the swapcache\
  \ reference in two scenarios:\n(1) There are additional swap entries referencing the page:\
  \ copying\n    instead of reusing is the right thing to do.\n(2) The page is under writeback:\
  \ theoretically we might be able to reuse\n    in some cases, however, we cannot remove the\
  \ additional reference\n    and will have to copy.\n\nNote that we'll only try removing the\
  \ page from the swapcache when it's\nhighly likely that we'll be the exclusive owner after\
  \ removing the page\nfrom the swapache.  As we're about to map that page writable and redirty\n\
  it, that should not affect reclaim but is rather the right thing to do.\n\nFurther, we might\
  \ have additional references from the LRU pagevecs, which\nwill force us to copy instead of\
  \ being able to reuse.  We'll try handling\nsuch references for some scenarios next.  Concurrent\
  \ writeback cannot be\nhandled easily and we'll always have to copy.\n\nWhile at it, remove\
  \ the superfluous page_mapcount() check: it's\nimplicitly covered by the page_count() for\
  \ ordinary anon pages.\n\n[1] https://lkml.kernel.org/r/20220113140318.11117-1-zhangliang5@huawei.com\n\
  [2] https://lkml.kernel.org/r/0480D692-D9B2-429A-9A88-9BBA1331AC3A@gmail.com\n\nLink: https://lkml.kernel.org/r/20220131162940.210846-2-david@redhat.com\n\
  Signed-off-by: David Hildenbrand <david@redhat.com>\nReported-by: Liang Zhang <zhangliang5@huawei.com>\n\
  Reported-by: Nadav Amit <nadav.amit@gmail.com>\nReviewed-by: Matthew Wilcox (Oracle) <willy@infradead.org>\n\
  Acked-by: Vlastimil Babka <vbabka@suse.cz>\nCc: Hugh Dickins <hughd@google.com>\nCc: David\
  \ Rientjes <rientjes@google.com>\nCc: Shakeel Butt <shakeelb@google.com>\nCc: John Hubbard\
  \ <jhubbard@nvidia.com>\nCc: Jason Gunthorpe <jgg@nvidia.com>\nCc: Mike Kravetz <mike.kravetz@oracle.com>\n\
  Cc: Mike Rapoport <rppt@linux.ibm.com>\nCc: Yang Shi <shy828301@gmail.com>\nCc: Kirill A.\
  \ Shutemov <kirill.shutemov@linux.intel.com>\nCc: Jann Horn <jannh@google.com>\nCc: Michal\
  \ Hocko <mhocko@kernel.org>\nCc: Rik van Riel <riel@surriel.com>\nCc: Roman Gushchin <roman.gushchin@linux.dev>\n\
  Cc: Andrea Arcangeli <aarcange@redhat.com>\nCc: Peter Xu <peterx@redhat.com>\nCc: Don Dutile\
  \ <ddutile@redhat.com>\nCc: Christoph Hellwig <hch@lst.de>\nCc: Oleg Nesterov <oleg@redhat.com>\n\
  Cc: Jan Kara <jack@suse.cz>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by:\
  \ Linus Torvalds <torvalds@linux-foundation.org>\n53a05ad9f21d858d24f76d12b3e990405f2036d1:mm:\
  \ optimize do_wp_page() for exclusive pages in the swapcache\n\nPatch series \"mm: COW fixes\
  \ part 1: fix the COW security issue for THP and swap\", v3.\n\nThis series attempts to optimize\
  \ and streamline the COW logic for ordinary\nanon pages and THP anon pages, fixing two remaining\
  \ instances of\nCVE-2020-29374 in do_swap_page() and do_huge_pmd_wp_page(): information\n\
  can leak from a parent process to a child process via anonymous pages\nshared during fork().\n\
  \nThis issue, including other related COW issues, has been summarized in [2]:\n\n \"1. Observing\
  \ Memory Modifications of Private Pages From A Child Process\n\n  Long story short: process-private\
  \ memory might not be as private as you\n  think once you fork(): successive modifications\
  \ of private memory\n  regions in the parent process can still be observed by the child\n\
  \  process, for example, by smart use of vmsplice()+munmap().\n\n  The core problem is that\
  \ pinning pages readable in a child process, such\n  as done via the vmsplice system call,\
  \ can result in a child process\n  observing memory modifications done in the parent process\
  \ the child is\n  not supposed to observe. [1] contains an excellent summary and [2]\n  contains\
  \ further details. This issue was assigned CVE-2020-29374 [9].\n\n  For this to trigger, it's\
  \ required to use a fork() without subsequent\n  exec(), for example, as used under Android\
  \ zygote. Without further\n  details about an application that forks less-privileged child\
  \ processes,\n  one cannot really say what's actually affected and what's not -- see the\n\
  \  details section the end of this mail for a short sshd/openssh analysis.\n\n  While commit\
  \ 17839856fd58 (\"gup: document and work around \"COW can break\n  either way\" issue\") fixed\
  \ this issue and resulted in other problems\n  (e.g., ptrace on pmem), commit 09854ba94c6a\
  \ (\"mm: do_wp_page()\n  simplification\") re-introduced part of the problem unfortunately.\n\
  \n  The original reproducer can be modified quite easily to use THP [3] and\n  make the issue\
  \ appear again on upstream kernels. I modified it to use\n  hugetlb [4] and it triggers as\
  \ well. The problem is certainly less\n  severe with hugetlb than with THP; it merely highlights\
  \ that we still\n  have plenty of open holes we should be closing/fixing.\n\n  Regarding vmsplice(),\
  \ the only known workaround is to disallow the\n  vmsplice() system call ... or disable THP\
  \ and hugetlb. But who knows\n  what else is affected (RDMA? O_DIRECT?) to achieve the same\
  \ goal -- in\n  the end, it's a more generic issue\"\n\nThis security issue was first reported\
  \ by Jann Horn on 27 May 2020 and it\ncurrently affects anonymous pages during swapin, anonymous\
  \ THP and hugetlb.\nThis series tackles anonymous pages during swapin and anonymous THP:\n\
  \n - do_swap_page() for handling COW on PTEs during swapin directly\n\n - do_huge_pmd_wp_page()\
  \ for handling COW on PMD-mapped THP during write\n   faults\n\nWith this series, we'll apply\
  \ the same COW logic we have in do_wp_page()\nto all swappable anon pages: don't reuse (map\
  \ writable) the page in\ncase there are additional references (page_count() != 1). All users\
  \ of\nreuse_swap_page() are remove, and consequently reuse_swap_page() is\nremoved.\n\nIn\
  \ general, we're struggling with the following COW-related issues:\n\n(1) \"missed COW\":\
  \ we miss to copy on write and reuse the page (map it\n    writable) although we must copy\
  \ because there are pending references\n    from another process to this page. The result\
  \ is a security issue.\n\n(2) \"wrong COW\": we copy on write although we wouldn't have to\
  \ and\n    shouldn't: if there are valid GUP references, they will become out\n    of sync\
  \ with the pages mapped into the page table. We fail to detect\n    that such a page can be\
  \ reused safely, especially if never more than\n    a single process mapped the page. The\
  \ result is an intra process\n    memory corruption.\n\n(3) \"unnecessary COW\": we copy on\
  \ write although we wouldn't have to:\n    performance degradation and temporary increases\
  \ swap+memory\n    consumption can be the result.\n\nWhile this series fixes (1) for swappable\
  \ anon pages, it tries to reduce\nreported cases of (3) first as good and easy as possible\
  \ to limit the\nimpact when streamlining.  The individual patches try to describe in\nwhich\
  \ cases we will run into (3).\n\nThis series certainly makes (2) worse for THP, because a\
  \ THP will now\nget PTE-mapped on write faults if there are additional references, even\n\
  if there was only ever a single process involved: once PTE-mapped, we'll\ncopy each and every\
  \ subpage and won't reuse any subpage as long as the\nunderlying compound page wasn't split.\n\
  \nI'm working on an approach to fix (2) and improve (3): PageAnonExclusive\nto mark anon pages\
  \ that are exclusive to a single process, allow GUP\npins only on such exclusive pages, and\
  \ allow turning exclusive pages\nshared (clearing PageAnonExclusive) only if there are no\
  \ GUP pins.  Anon\npages with PageAnonExclusive set never have to be copied during write\n\
  faults, but eventually during fork() if they cannot be turned shared.\nThe improved reuse\
  \ logic in this series will essentially also be the\nlogic to reset PageAnonExclusive.  This\
  \ work will certainly take a\nwhile, but I'm planning on sharing details before having code\
  \ fully\nready.\n\n#1-#5 can be applied independently of the rest. #6-#9 are mostly only\n\
  cleanups related to reuse_swap_page().\n\nNotes:\n* For now, I'll leave hugetlb code untouched:\
  \ \"unnecessary COW\" might\n  easily break existing setups because hugetlb pages are a scarce\
  \ resource\n  and we could just end up having to crash the application when we run out\n \
  \ of hugetlb pages. We have to be very careful and the security aspect with\n  hugetlb is\
  \ most certainly less relevant than for unprivileged anon pages.\n* Instead of lru_add_drain()\
  \ we might actually just drain the lru_add list\n  or even just remove the single page of\
  \ interest from the lru_add list.\n  This would require a new helper function, and could be\
  \ added if the\n  conditional lru_add_drain() turn out to be a problem.\n* I extended the\
  \ test case already included in [1] to also test for the\n  newly found do_swap_page() case.\
  \ I'll send that out separately once/if\n  this part was merged.\n\n[1] https://lkml.kernel.org/r/20211217113049.23850-1-david@redhat.com\n\
  [2] https://lore.kernel.org/r/3ae33b08-d9ef-f846-56fb-645e3b9b4c66@redhat.com\n\nThis patch\
  \ (of 9):\n\nLiang Zhang reported [1] that the current COW logic in do_wp_page() is\nsub-optimal\
  \ when it comes to swap+read fault+write fault of anonymous\npages that have a single user,\
  \ visible via a performance degradation in\nthe redis benchmark.  Something similar was previously\
  \ reported [2] by\nNadav with a simple reproducer.\n\nAfter we put an anon page into the swapcache\
  \ and unmapped it from a single\nprocess, that process might read that page again and refault\
  \ it read-only.\nIf that process then writes to that page, the process is actually the\nexclusive\
  \ user of the page, however, the COW logic in do_co_page() won't\nbe able to reuse it due\
  \ to the additional reference from the swapcache.\n\nLet's optimize for pages that have been\
  \ added to the swapcache but only\nhave an exclusive user.  Try removing the swapcache reference\
  \ if there is\nhope that we're the exclusive user.\n\nWe will fail removing the swapcache\
  \ reference in two scenarios:\n(1) There are additional swap entries referencing the page:\
  \ copying\n    instead of reusing is the right thing to do.\n(2) The page is under writeback:\
  \ theoretically we might be able to reuse\n    in some cases, however, we cannot remove the\
  \ additional reference\n    and will have to copy.\n\nNote that we'll only try removing the\
  \ page from the swapcache when it's\nhighly likely that we'll be the exclusive owner after\
  \ removing the page\nfrom the swapache.  As we're about to map that page writable and redirty\n\
  it, that should not affect reclaim but is rather the right thing to do.\n\nFurther, we might\
  \ have additional references from the LRU pagevecs, which\nwill force us to copy instead of\
  \ being able to reuse.  We'll try handling\nsuch references for some scenarios next.  Concurrent\
  \ writeback cannot be\nhandled easily and we'll always have to copy.\n\nWhile at it, remove\
  \ the superfluous page_mapcount() check: it's\nimplicitly covered by the page_count() for\
  \ ordinary anon pages.\n\n[1] https://lkml.kernel.org/r/20220113140318.11117-1-zhangliang5@huawei.com\n\
  [2] https://lkml.kernel.org/r/0480D692-D9B2-429A-9A88-9BBA1331AC3A@gmail.com\n\nLink: https://lkml.kernel.org/r/20220131162940.210846-2-david@redhat.com\n\
  Signed-off-by: David Hildenbrand <david@redhat.com>\nReported-by: Liang Zhang <zhangliang5@huawei.com>\n\
  Reported-by: Nadav Amit <nadav.amit@gmail.com>\nReviewed-by: Matthew Wilcox (Oracle) <willy@infradead.org>\n\
  Acked-by: Vlastimil Babka <vbabka@suse.cz>\nCc: Hugh Dickins <hughd@google.com>\nCc: David\
  \ Rientjes <rientjes@google.com>\nCc: Shakeel Butt <shakeelb@google.com>\nCc: John Hubbard\
  \ <jhubbard@nvidia.com>\nCc: Jason Gunthorpe <jgg@nvidia.com>\nCc: Mike Kravetz <mike.kravetz@oracle.com>\n\
  Cc: Mike Rapoport <rppt@linux.ibm.com>\nCc: Yang Shi <shy828301@gmail.com>\nCc: Kirill A.\
  \ Shutemov <kirill.shutemov@linux.intel.com>\nCc: Jann Horn <jannh@google.com>\nCc: Michal\
  \ Hocko <mhocko@kernel.org>\nCc: Rik van Riel <riel@surriel.com>\nCc: Roman Gushchin <roman.gushchin@linux.dev>\n\
  Cc: Andrea Arcangeli <aarcange@redhat.com>\nCc: Peter Xu <peterx@redhat.com>\nCc: Don Dutile\
  \ <ddutile@redhat.com>\nCc: Christoph Hellwig <hch@lst.de>\nCc: Oleg Nesterov <oleg@redhat.com>\n\
  Cc: Jan Kara <jack@suse.cz>\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\nSigned-off-by:\
  \ Linus Torvalds <torvalds@linux-foundation.org>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 3bff7e3f1f16dc7305d12905c51c278b54970f0e
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 53a05ad9f21d858d24f76d12b3e990405f2036d1
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: c145e0b47c77ebeefdfd73dbb344577b2fc9b065
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/3bff7e3f1f16dc7305d12905c51c278b54970f0e
    reference_type: commit
    reference_id: 3bff7e3f1f16dc7305d12905c51c278b54970f0e
  - url: https://github.com/torvalds/linux/tree/53a05ad9f21d858d24f76d12b3e990405f2036d1
    reference_type: commit
    reference_id: 53a05ad9f21d858d24f76d12b3e990405f2036d1
  - url: https://github.com/torvalds/linux/tree/c145e0b47c77ebeefdfd73dbb344577b2fc9b065
    reference_type: commit
    reference_id: c145e0b47c77ebeefdfd73dbb344577b2fc9b065
