advisory_id: CVE-2018-1000200
datasource_id: collect_linux_fix_commits/CVE-2018-1000200
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "27ae357fa82be5ab73b2ef8d39dcb8ca2563483a:mm, oom: fix concurrent munlock and oom reaper\
  \ unmap, v3\n\nSince exit_mmap() is done without the protection of mm->mmap_sem, it is\npossible\
  \ for the oom reaper to concurrently operate on an mm until\nMMF_OOM_SKIP is set.\n\nThis\
  \ allows munlock_vma_pages_all() to concurrently run while the oom\nreaper is operating on\
  \ a vma.  Since munlock_vma_pages_range() depends\non clearing VM_LOCKED from vm_flags before\
  \ actually doing the munlock to\ndetermine if any other vmas are locking the same memory,\
  \ the check for\nVM_LOCKED in the oom reaper is racy.\n\nThis is especially noticeable on\
  \ architectures such as powerpc where\nclearing a huge pmd requires serialize_against_pte_lookup().\
  \  If the pmd\nis zapped by the oom reaper during follow_page_mask() after the check\nfor\
  \ pmd_none() is bypassed, this ends up deferencing a NULL ptl or a\nkernel oops.\n\nFix this\
  \ by manually freeing all possible memory from the mm before\ndoing the munlock and then setting\
  \ MMF_OOM_SKIP.  The oom reaper can not\nrun on the mm anymore so the munlock is safe to do\
  \ in exit_mmap().  It\nalso matches the logic that the oom reaper currently uses for\ndetermining\
  \ when to set MMF_OOM_SKIP itself, so there's no new risk of\nexcessive oom killing.\n\nThis\
  \ issue fixes CVE-2018-1000200.\n\nLink: http://lkml.kernel.org/r/alpine.DEB.2.21.1804241526320.238665@chino.kir.corp.google.com\n\
  Fixes: 212925802454 (\"mm: oom: let oom_reap_task and exit_mmap run concurrently\")\nSigned-off-by:\
  \ David Rientjes <rientjes@google.com>\nSuggested-by: Tetsuo Handa <penguin-kernel@I-love.SAKURA.ne.jp>\n\
  Acked-by: Michal Hocko <mhocko@suse.com>\nCc: Andrea Arcangeli <aarcange@redhat.com>\nCc:\
  \ <stable@vger.kernel.org>\t[4.14+]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n\
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 27ae357fa82be5ab73b2ef8d39dcb8ca2563483a
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/27ae357fa82be5ab73b2ef8d39dcb8ca2563483a
    reference_type: commit
    reference_id: 27ae357fa82be5ab73b2ef8d39dcb8ca2563483a
