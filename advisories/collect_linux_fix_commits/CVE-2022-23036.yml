advisory_id: CVE-2022-23036
datasource_id: collect_linux_fix_commits/CVE-2022-23036
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  abf1fd5919d6238ee3bc5eb4a9b6c3947caa6638:xen/blkfront: don't use gnttab_query_foreign_access() for mapped status

  It isn't enough to check whether a grant is still being in use by
  calling gnttab_query_foreign_access(), as a mapping could be realized
  by the other side just after having called that function.

  In case the call was done in preparation of revoking a grant it is
  better to do so via gnttab_end_foreign_access_ref() and check the
  success of that operation instead.

  For the ring allocation use alloc_pages_exact() in order to avoid
  high order pages in case of a multi-page ring.

  If a grant wasn't unmapped by the backend without persistent grants
  being used, set the device state to "error".

  This is CVE-2022-23036 / part of XSA-396.

  Reported-by: Demi Marie Obenour <demi@invisiblethingslab.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  ---
  V2:
  - use gnttab_try_end_foreign_access()
  V4:
  - use alloc_pages_exact() and free_pages_exact()
  - set state to error if backend didn't unmap (Roger Pau Monné)
  6b1775f26a2da2b05a6dc8ec2b5d14e9a4701a1a:xen/grant-table: add gnttab_try_end_foreign_access()

  Add a new grant table function gnttab_try_end_foreign_access(), which
  will remove and free a grant if it is not in use.

  Its main use case is to either free a grant if it is no longer in use,
  or to take some other action if it is still in use. This other action
  can be an error exit, or (e.g. in the case of blkfront persistent grant
  feature) some special handling.

  This is CVE-2022-23036, CVE-2022-23038 / part of XSA-396.

  Reported-by: Demi Marie Obenour <demi@invisiblethingslab.com>
  Signed-off-by: Juergen Gross <jgross@suse.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  ---
  V2:
  - new patch
  V4:
  - add comments to header (Jan Beulich)
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: abf1fd5919d6238ee3bc5eb4a9b6c3947caa6638
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 6b1775f26a2da2b05a6dc8ec2b5d14e9a4701a1a
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/6b1775f26a2da2b05a6dc8ec2b5d14e9a4701a1a
    reference_type: commit
    reference_id: 6b1775f26a2da2b05a6dc8ec2b5d14e9a4701a1a
  - url: https://github.com/torvalds/linux/tree/abf1fd5919d6238ee3bc5eb4a9b6c3947caa6638
    reference_type: commit
    reference_id: abf1fd5919d6238ee3bc5eb4a9b6c3947caa6638
