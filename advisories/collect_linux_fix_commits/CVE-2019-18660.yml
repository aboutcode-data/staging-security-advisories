advisory_id: CVE-2019-18660
datasource_id: collect_linux_fix_commits/CVE-2019-18660
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  80eb5fea3c14fb171facb5242a1555b3aafea4d0:Merge tag 'powerpc-spectre-rsb' of powerpc-CVE-2019-18660.bundle

  Pull powerpc Spectre-RSB fixes from Michael Ellerman:
   "We failed to activate the mitigation for Spectre-RSB (Return Stack
    Buffer, aka. ret2spec) on context switch, on CPUs prior to Power9
    DD2.3.

    That allows a process to poison the RSB (called Link Stack on Power
    CPUs) and possibly misdirect speculative execution of another process.
    If the victim process can be induced to execute a leak gadget then it
    may be possible to extract information from the victim via a side
    channel.

    The fix is to correctly activate the link stack flush mitigation on
    all CPUs that have any mitigation of Spectre v2 in userspace enabled.

    There's a second commit which adds a link stack flush in the KVM guest
    exit path. A leak via that path has not been demonstrated, but we
    believe it's at least theoretically possible.

    This is the fix for CVE-2019-18660"

  * tag 'powerpc-spectre-rsb' of /home/torvalds/Downloads/powerpc-CVE-2019-18660.bundle:
    KVM: PPC: Book3S HV: Flush link stack on guest exit to host kernel
    powerpc/book3s64: Fix link stack flush on context switch
  80eb5fea3c14fb171facb5242a1555b3aafea4d0:Merge tag 'powerpc-spectre-rsb' of powerpc-CVE-2019-18660.bundle

  Pull powerpc Spectre-RSB fixes from Michael Ellerman:
   "We failed to activate the mitigation for Spectre-RSB (Return Stack
    Buffer, aka. ret2spec) on context switch, on CPUs prior to Power9
    DD2.3.

    That allows a process to poison the RSB (called Link Stack on Power
    CPUs) and possibly misdirect speculative execution of another process.
    If the victim process can be induced to execute a leak gadget then it
    may be possible to extract information from the victim via a side
    channel.

    The fix is to correctly activate the link stack flush mitigation on
    all CPUs that have any mitigation of Spectre v2 in userspace enabled.

    There's a second commit which adds a link stack flush in the KVM guest
    exit path. A leak via that path has not been demonstrated, but we
    believe it's at least theoretically possible.

    This is the fix for CVE-2019-18660"

  * tag 'powerpc-spectre-rsb' of /home/torvalds/Downloads/powerpc-CVE-2019-18660.bundle:
    KVM: PPC: Book3S HV: Flush link stack on guest exit to host kernel
    powerpc/book3s64: Fix link stack flush on context switch
  80eb5fea3c14fb171facb5242a1555b3aafea4d0:Merge tag 'powerpc-spectre-rsb' of powerpc-CVE-2019-18660.bundle

  Pull powerpc Spectre-RSB fixes from Michael Ellerman:
   "We failed to activate the mitigation for Spectre-RSB (Return Stack
    Buffer, aka. ret2spec) on context switch, on CPUs prior to Power9
    DD2.3.

    That allows a process to poison the RSB (called Link Stack on Power
    CPUs) and possibly misdirect speculative execution of another process.
    If the victim process can be induced to execute a leak gadget then it
    may be possible to extract information from the victim via a side
    channel.

    The fix is to correctly activate the link stack flush mitigation on
    all CPUs that have any mitigation of Spectre v2 in userspace enabled.

    There's a second commit which adds a link stack flush in the KVM guest
    exit path. A leak via that path has not been demonstrated, but we
    believe it's at least theoretically possible.

    This is the fix for CVE-2019-18660"

  * tag 'powerpc-spectre-rsb' of /home/torvalds/Downloads/powerpc-CVE-2019-18660.bundle:
    KVM: PPC: Book3S HV: Flush link stack on guest exit to host kernel
    powerpc/book3s64: Fix link stack flush on context switch
  39e72bf96f5847ba87cc5bd7a3ce0fed813dc9ad:powerpc/book3s64: Fix link stack flush on context switch

  In commit ee13cb249fab ("powerpc/64s: Add support for software count
  cache flush"), I added support for software to flush the count
  cache (indirect branch cache) on context switch if firmware told us
  that was the required mitigation for Spectre v2.

  As part of that code we also added a software flush of the link
  stack (return address stack), which protects against Spectre-RSB
  between user processes.

  That is all correct for CPUs that activate that mitigation, which is
  currently Power9 Nimbus DD2.3.

  What I got wrong is that on older CPUs, where firmware has disabled
  the count cache, we also need to flush the link stack on context
  switch.

  To fix it we create a new feature bit which is not set by firmware,
  which tells us we need to flush the link stack. We set that when
  firmware tells us that either of the existing Spectre v2 mitigations
  are enabled.

  Then we adjust the patching code so that if we see that feature bit we
  enable the link stack flush. If we're also told to flush the count
  cache in software then we fall through and do that also.

  On the older CPUs we don't need to do do the software count cache
  flush, firmware has disabled it, so in that case we patch in an early
  return after the link stack flush.

  The naming of some of the functions is awkward after this patch,
  because they're called "count cache" but they also do link stack. But
  we'll fix that up in a later commit to ease backporting.

  This is the fix for CVE-2019-18660.

  Reported-by: Anthony Steinhauser <asteinhauser@google.com>
  Fixes: ee13cb249fab ("powerpc/64s: Add support for software count cache flush")
  Cc: stable@vger.kernel.org # v4.4+
  Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 80eb5fea3c14fb171facb5242a1555b3aafea4d0
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 39e72bf96f5847ba87cc5bd7a3ce0fed813dc9ad
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/39e72bf96f5847ba87cc5bd7a3ce0fed813dc9ad
    reference_type: commit
    reference_id: 39e72bf96f5847ba87cc5bd7a3ce0fed813dc9ad
  - url: https://github.com/torvalds/linux/tree/80eb5fea3c14fb171facb5242a1555b3aafea4d0
    reference_type: commit
    reference_id: 80eb5fea3c14fb171facb5242a1555b3aafea4d0
