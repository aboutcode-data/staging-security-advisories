advisory_id: CVE-2019-3900
datasource_id: collect_linux_fix_commits/CVE-2019-3900
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "c1ea02f15ab5efb3e93fc3144d895410bf79fcf2:vhost: scsi: add weight support\n\nThis patch\
  \ will check the weight and exit the loop if we exceeds the\nweight. This is useful for preventing\
  \ scsi kthread from hogging cpu\nwhich is guest triggerable.\n\nThis addresses CVE-2019-3900.\n\
  \nCc: Paolo Bonzini <pbonzini@redhat.com>\nCc: Stefan Hajnoczi <stefanha@redhat.com>\nFixes:\
  \ 057cbf49a1f0 (\"tcm_vhost: Initial merge for vhost level target fabric driver\")\nSigned-off-by:\
  \ Jason Wang <jasowang@redhat.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nSigned-off-by:\
  \ Michael S. Tsirkin <mst@redhat.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\n\
  e79b431fb901ba1106670bcc80b9b617b25def7d:vhost: vsock: add weight support\n\nThis patch will\
  \ check the weight and exit the loop if we exceeds the\nweight. This is useful for preventing\
  \ vsock kthread from hogging cpu\nwhich is guest triggerable. The weight can help to avoid\
  \ starving the\nrequest from on direction while another direction is being processed.\n\n\
  The value of weight is picked from vhost-net.\n\nThis addresses CVE-2019-3900.\n\nCc: Stefan\
  \ Hajnoczi <stefanha@redhat.com>\nFixes: 433fc58e6bf2 (\"VSOCK: Introduce vhost_vsock.ko\"\
  )\nSigned-off-by: Jason Wang <jasowang@redhat.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\n\
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>\ne2412c07f8f3040593dfb88207865a3cd58680c0:vhost_net:\
  \ fix possible infinite loop\n\nWhen the rx buffer is too small for a packet, we will discard\
  \ the vq\ndescriptor and retry it for the next packet:\n\nwhile ((sock_len = vhost_net_rx_peek_head_len(net,\
  \ sock->sk,\n\t\t\t\t\t      &busyloop_intr))) {\n...\n\t/* On overrun, truncate and discard\
  \ */\n\tif (unlikely(headcount > UIO_MAXIOV)) {\n\t\tiov_iter_init(&msg.msg_iter, READ, vq->iov,\
  \ 1, 1);\n\t\terr = sock->ops->recvmsg(sock, &msg,\n\t\t\t\t\t 1, MSG_DONTWAIT | MSG_TRUNC);\n\
  \t\tpr_debug(\"Discarded rx packet: len %zd\\n\", sock_len);\n\t\tcontinue;\n\t}\n...\n}\n\
  \nThis makes it possible to trigger a infinite while..continue loop\nthrough the co-opreation\
  \ of two VMs like:\n\n1) Malicious VM1 allocate 1 byte rx buffer and try to slow down the\n\
  \   vhost process as much as possible e.g using indirect descriptors or\n   other.\n2) Malicious\
  \ VM2 generate packets to VM1 as fast as possible\n\nFixing this by checking against weight\
  \ at the end of RX and TX\nloop. This also eliminate other similar cases when:\n\n- userspace\
  \ is consuming the packets in the meanwhile\n- theoretical TOCTOU attack if guest moving avail\
  \ index back and forth\n  to hit the continue after vhost find guest just add new buffers\n\
  \nThis addresses CVE-2019-3900.\n\nFixes: d8316f3991d20 (\"vhost: fix total length when packets\
  \ are too short\")\nFixes: 3a4d5c94e9593 (\"vhost_net: a kernel-level virtio server\")\nSigned-off-by:\
  \ Jason Wang <jasowang@redhat.com>\nReviewed-by: Stefan Hajnoczi <stefanha@redhat.com>\nSigned-off-by:\
  \ Michael S. Tsirkin <mst@redhat.com>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: c1ea02f15ab5efb3e93fc3144d895410bf79fcf2
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: e79b431fb901ba1106670bcc80b9b617b25def7d
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: e2412c07f8f3040593dfb88207865a3cd58680c0
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/c1ea02f15ab5efb3e93fc3144d895410bf79fcf2
    reference_type: commit
    reference_id: c1ea02f15ab5efb3e93fc3144d895410bf79fcf2
  - url: https://github.com/torvalds/linux/tree/e2412c07f8f3040593dfb88207865a3cd58680c0
    reference_type: commit
    reference_id: e2412c07f8f3040593dfb88207865a3cd58680c0
  - url: https://github.com/torvalds/linux/tree/e79b431fb901ba1106670bcc80b9b617b25def7d
    reference_type: commit
    reference_id: e79b431fb901ba1106670bcc80b9b617b25def7d
