advisory_id: CVE-2014-4171
datasource_id: collect_linux_fix_commits/CVE-2014-4171
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: "8e205f779d1443a94b5ae81aa359cb535dd3021e:shmem: fix faulting into a hole, not taking\
  \ i_mutex\n\nCommit f00cdc6df7d7 (\"shmem: fix faulting into a hole while it's\npunched\"\
  ) was buggy: Sasha sent a lockdep report to remind us that\ngrabbing i_mutex in the fault\
  \ path is a no-no (write syscall may already\nhold i_mutex while faulting user buffer).\n\n\
  We tried a completely different approach (see following patch) but that\nproved inadequate:\
  \ good enough for a rational workload, but not good\nenough against trinity - which forks\
  \ off so many mappings of the object\nthat contention on i_mmap_mutex while hole-puncher holds\
  \ i_mutex builds\ninto serious starvation when concurrent faults force the puncher to fall\n\
  back to single-page unmap_mapping_range() searches of the i_mmap tree.\n\nSo return to the\
  \ original umbrella approach, but keep away from i_mutex\nthis time.  We really don't want\
  \ to bloat every shmem inode with a new\nmutex or completion, just to protect this unlikely\
  \ case from trinity.\nSo extend the original with wait_queue_head on stack at the hole-punch\n\
  end, and wait_queue item on the stack at the fault end.\n\nThis involves further use of i_lock\
  \ to guard against the races: lockdep\nhas been happy so far, and I see fs/inode.c:unlock_new_inode()\
  \ holds\ni_lock around wake_up_bit(), which is comparable to what we do here.\ni_lock is more\
  \ convenient, but we could switch to shmem's info->lock.\n\nThis issue has been tagged with\
  \ CVE-2014-4171, which will require commit\nf00cdc6df7d7 and this and the following patch\
  \ to be backported: we\nsuggest to 3.1+, though in fact the trinity forkbomb effect might\
  \ go\nback as far as 2.6.16, when madvise(,,MADV_REMOVE) came in - or might\nnot, since much\
  \ has changed, with i_mmap_mutex a spinlock before 3.0.\nAnyone running trinity on 3.0 and\
  \ earlier? I don't think we need care.\n\nSigned-off-by: Hugh Dickins <hughd@google.com>\n\
  Reported-by: Sasha Levin <sasha.levin@oracle.com>\nTested-by: Sasha Levin <sasha.levin@oracle.com>\n\
  Cc: Vlastimil Babka <vbabka@suse.cz>\nCc: Konstantin Khlebnikov <koct9i@gmail.com>\nCc: Johannes\
  \ Weiner <hannes@cmpxchg.org>\nCc: Lukas Czerner <lczerner@redhat.com>\nCc: Dave Jones <davej@redhat.com>\n\
  Cc: <stable@vger.kernel.org>\t[3.1+]\nSigned-off-by: Andrew Morton <akpm@linux-foundation.org>\n\
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>"
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 8e205f779d1443a94b5ae81aa359cb535dd3021e
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/8e205f779d1443a94b5ae81aa359cb535dd3021e
    reference_type: commit
    reference_id: 8e205f779d1443a94b5ae81aa359cb535dd3021e
