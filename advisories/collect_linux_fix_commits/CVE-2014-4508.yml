advisory_id: CVE-2014-4508
datasource_id: collect_linux_fix_commits/CVE-2014-4508
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  fb21b84e7f809ef04b1e5aed5d463cf0d4866638:x86_32, entry: Clean up sysenter_badsys declaration

  commit 554086d85e "x86_32, entry: Do syscall exit work on badsys
  (CVE-2014-4508)" introduced a new jump label (sysenter_badsys) but
  somehow the END statements seem to have gone wrong (at least it
  feels that way to me).
  This does not seem to be a fatal problem, but just for the sake
  of symmetry, change the second syscall_badsys to sysenter_badsys.

  Signed-off-by: Stefan Bader <stefan.bader@canonical.com>
  Link: http://lkml.kernel.org/r/1408093066-31021-1-git-send-email-stefan.bader@canonical.com
  Acked-by: Andy Lutomirski <luto@amacapital.net>
  Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>
  8142b215501f8b291a108a202b3a053a265b03dd:x86_32, entry: Store badsys error code in %eax

  Commit 554086d ("x86_32, entry: Do syscall exit work on badsys
  (CVE-2014-4508)") introduced a regression in the x86_32 syscall entry
  code, resulting in syscall() not returning proper errors for undefined
  syscalls on CPUs supporting the sysenter feature.

  The following code:

  > int result = syscall(666);
  > printf("result=%d errno=%d error=%s\n", result, errno, strerror(errno));

  results in:

  > result=666 errno=0 error=Success

  Obviously, the syscall return value is the called syscall number, but it
  should have been an ENOSYS error. When run under ptrace it behaves
  correctly, which makes it hard to debug in the wild:

  > result=-1 errno=38 error=Function not implemented

  The %eax register is the return value register. For debugging via ptrace
  the syscall entry code stores the complete register context on the
  stack. The badsys handlers only store the ENOSYS error code in the
  ptrace register set and do not set %eax like a regular syscall handler
  would. The old resume_userspace call chain contains code that clobbers
  %eax and it restores %eax from the ptrace registers afterwards. The same
  goes for the ptrace-enabled call chain. When ptrace is not used, the
  syscall return value is the passed-in syscall number from the untouched
  %eax register.

  Use %eax as the return value register in syscall_badsys and
  sysenter_badsys, like a real syscall handler does, and have the caller
  push the value onto the stack for ptrace access.

  Signed-off-by: Sven Wegener <sven.wegener@stealer.net>
  Link: http://lkml.kernel.org/r/alpine.LNX.2.11.1407221022380.31021@titan.int.lan.stealer.net
  Reviewed-and-tested-by: Andy Lutomirski <luto@amacapital.net>
  Cc: <stable@vger.kernel.org> # If 554086d is backported
  Signed-off-by: H. Peter Anvin <hpa@zytor.com>
  d1fc98ba961db83293f804a1037e905c03b301cf:Merge branch 'x86/urgent' of git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip

  Pull x86 fixes from Peter Anvin:
   "A pile of fixes related to the VDSO, EFI and 32-bit badsys handling.

    It turns out that removing the section headers from the VDSO breaks
    gdb, so this puts back most of them.  A very simple typo broke
    rt_sigreturn on some versions of glibc, with obviously disastrous
    results.  The rest is pretty much fixes for the corresponding fallout.

    The EFI fixes fixes an arithmetic overflow on 32-bit systems and
    quiets some build warnings.

    Finally, when invoking an invalid system call number on x86-32, we
    bypass a bunch of handling, which can make the audit code oops"

  * 'x86/urgent' of git://git.kernel.org/pub/scm/linux/kernel/git/tip/tip:
    efi-pstore: Fix an overflow on 32-bit builds
    x86/vdso: Error out in vdso2c if DT_RELA is present
    x86/vdso: Move DISABLE_BRANCH_PROFILING into the vdso makefile
    x86_32, signal: Fix vdso rt_sigreturn
    x86_32, entry: Do syscall exit work on badsys (CVE-2014-4508)
    x86/vdso: Create .build-id links for unstripped vdso files
    x86/vdso: Remove some redundant in-memory section headers
    x86/vdso: Improve the fake section headers
    x86/vdso2c: Use better macros for ELF bitness
    x86/vdso: Discard the __bug_table section
    efi: Fix compiler warnings (unused, const, type)
  554086d85e71f30abe46fc014fea31929a7c6a8a:x86_32, entry: Do syscall exit work on badsys (CVE-2014-4508)

  The bad syscall nr paths are their own incomprehensible route
  through the entry control flow.  Rearrange them to work just like
  syscalls that return -ENOSYS.

  This fixes an OOPS in the audit code when fast-path auditing is
  enabled and sysenter gets a bad syscall nr (CVE-2014-4508).

  This has probably been broken since Linux 2.6.27:
  af0575bba0 i386 syscall audit fast-path

  Cc: stable@vger.kernel.org
  Cc: Roland McGrath <roland@redhat.com>
  Reported-by: Toralf Förster <toralf.foerster@gmx.de>
  Signed-off-by: Andy Lutomirski <luto@amacapital.net>
  Link: http://lkml.kernel.org/r/e09c499eade6fc321266dd6b54da7beb28d6991c.1403558229.git.luto@amacapital.net
  Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>
  554086d85e71f30abe46fc014fea31929a7c6a8a:x86_32, entry: Do syscall exit work on badsys (CVE-2014-4508)

  The bad syscall nr paths are their own incomprehensible route
  through the entry control flow.  Rearrange them to work just like
  syscalls that return -ENOSYS.

  This fixes an OOPS in the audit code when fast-path auditing is
  enabled and sysenter gets a bad syscall nr (CVE-2014-4508).

  This has probably been broken since Linux 2.6.27:
  af0575bba0 i386 syscall audit fast-path

  Cc: stable@vger.kernel.org
  Cc: Roland McGrath <roland@redhat.com>
  Reported-by: Toralf Förster <toralf.foerster@gmx.de>
  Signed-off-by: Andy Lutomirski <luto@amacapital.net>
  Link: http://lkml.kernel.org/r/e09c499eade6fc321266dd6b54da7beb28d6991c.1403558229.git.luto@amacapital.net
  Signed-off-by: H. Peter Anvin <hpa@linux.intel.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 8142b215501f8b291a108a202b3a053a265b03dd
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: fb21b84e7f809ef04b1e5aed5d463cf0d4866638
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: d1fc98ba961db83293f804a1037e905c03b301cf
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 554086d85e71f30abe46fc014fea31929a7c6a8a
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/554086d85e71f30abe46fc014fea31929a7c6a8a
    reference_type: commit
    reference_id: 554086d85e71f30abe46fc014fea31929a7c6a8a
  - url: https://github.com/torvalds/linux/tree/8142b215501f8b291a108a202b3a053a265b03dd
    reference_type: commit
    reference_id: 8142b215501f8b291a108a202b3a053a265b03dd
  - url: https://github.com/torvalds/linux/tree/d1fc98ba961db83293f804a1037e905c03b301cf
    reference_type: commit
    reference_id: d1fc98ba961db83293f804a1037e905c03b301cf
  - url: https://github.com/torvalds/linux/tree/fb21b84e7f809ef04b1e5aed5d463cf0d4866638
    reference_type: commit
    reference_id: fb21b84e7f809ef04b1e5aed5d463cf0d4866638
