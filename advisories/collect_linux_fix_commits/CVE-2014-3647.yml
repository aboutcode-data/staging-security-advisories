advisory_id: CVE-2014-3647
datasource_id: collect_linux_fix_commits/CVE-2014-3647
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  d1442d85cc30ea75f7d399474ca738e0bc96f715:KVM: x86: Handle errors when RIP is set during far jumps

  Far jmp/call/ret may fault while loading a new RIP.  Currently KVM does not
  handle this case, and may result in failed vm-entry once the assignment is
  done.  The tricky part of doing so is that loading the new CS affects the
  VMCS/VMCB state, so if we fail during loading the new RIP, we are left in
  unconsistent state.  Therefore, this patch saves on 64-bit the old CS
  descriptor and restores it if loading RIP failed.

  This fixes CVE-2014-3647.

  Cc: stable@vger.kernel.org
  Signed-off-by: Nadav Amit <namit@cs.technion.ac.il>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  234f3ce485d54017f15cf5e0699cff4100121601:KVM: x86: Emulator fixes for eip canonical checks on near branches

  Before changing rip (during jmp, call, ret, etc.) the target should be asserted
  to be canonical one, as real CPUs do.  During sysret, both target rsp and rip
  should be canonical. If any of these values is noncanonical, a #GP exception
  should occur.  The exception to this rule are syscall and sysenter instructions
  in which the assigned rip is checked during the assignment to the relevant
  MSRs.

  This patch fixes the emulator to behave as real CPUs do for near branches.
  Far branches are handled by the next patch.

  This fixes CVE-2014-3647.

  Cc: stable@vger.kernel.org
  Signed-off-by: Nadav Amit <namit@cs.technion.ac.il>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 234f3ce485d54017f15cf5e0699cff4100121601
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: d1442d85cc30ea75f7d399474ca738e0bc96f715
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/234f3ce485d54017f15cf5e0699cff4100121601
    reference_type: commit
    reference_id: 234f3ce485d54017f15cf5e0699cff4100121601
  - url: https://github.com/torvalds/linux/tree/d1442d85cc30ea75f7d399474ca738e0bc96f715
    reference_type: commit
    reference_id: d1442d85cc30ea75f7d399474ca738e0bc96f715
