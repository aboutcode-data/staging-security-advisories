advisory_id: CVE-2022-1789
datasource_id: collect_linux_fix_commits/CVE-2022-1789
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  9f46c187e2e680ecd9de7983e4d081c3391acc76:KVM: x86/mmu: fix NULL pointer dereference on guest INVPCID

  With shadow paging enabled, the INVPCID instruction results in a call
  to kvm_mmu_invpcid_gva.  If INVPCID is executed with CR0.PG=0, the
  invlpg callback is not set and the result is a NULL pointer dereference.
  Fix it trivially by checking for mmu->invlpg before every call.

  There are other possibilities:

  - check for CR0.PG, because KVM (like all Intel processors after P5)
    flushes guest TLB on CR0.PG changes so that INVPCID/INVLPG are a
    nop with paging disabled

  - check for EFER.LMA, because KVM syncs and flushes when switching
    MMU contexts outside of 64-bit mode

  All of these are tricky, go for the simple solution.  This is CVE-2022-1789.

  Reported-by: Yongkang Jia <kangel@zju.edu.cn>
  Cc: stable@vger.kernel.org
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 9f46c187e2e680ecd9de7983e4d081c3391acc76
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/9f46c187e2e680ecd9de7983e4d081c3391acc76
    reference_type: commit
    reference_id: 9f46c187e2e680ecd9de7983e4d081c3391acc76
