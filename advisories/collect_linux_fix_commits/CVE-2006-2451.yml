advisory_id: CVE-2006-2451
datasource_id: collect_linux_fix_commits/CVE-2006-2451
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  9520628e8ceb69fa9a4aee6b57f22675d9e1b709:fs: make dumpable=2 require fully qualified path

  When the suid_dumpable sysctl is set to "2", and there is no core dump
  pipe defined in the core_pattern sysctl, a local user can cause core files
  to be written to root-writable directories, potentially with
  user-controlled content.

  This means an admin can unknowningly reintroduce a variation of
  CVE-2006-2451, allowing local users to gain root privileges.

    $ cat /proc/sys/fs/suid_dumpable
    2
    $ cat /proc/sys/kernel/core_pattern
    core
    $ ulimit -c unlimited
    $ cd /
    $ ls -l core
    ls: cannot access core: No such file or directory
    $ touch core
    touch: cannot touch `core': Permission denied
    $ OHAI="evil-string-here" ping localhost >/dev/null 2>&1 &
    $ pid=$!
    $ sleep 1
    $ kill -SEGV $pid
    $ ls -l core
    -rw------- 1 root kees 458752 Jun 21 11:35 core
    $ sudo strings core | grep evil
    OHAI=evil-string-here

  While cron has been fixed to abort reading a file when there is any
  parse error, there are still other sensitive directories that will read
  any file present and skip unparsable lines.

  Instead of introducing a suid_dumpable=3 mode and breaking all users of
  mode 2, this only disables the unsafe portion of mode 2 (writing to disk
  via relative path).  Most users of mode 2 (e.g.  Chrome OS) already use
  a core dump pipe handler, so this change will not break them.  For the
  situations where a pipe handler is not defined but mode 2 is still
  active, crash dumps will only be written to fully qualified paths.  If a
  relative path is defined (e.g.  the default "core" pattern), dump
  attempts will trigger a printk yelling about the lack of a fully
  qualified path.

  Signed-off-by: Kees Cook <keescook@chromium.org>
  Cc: Alexander Viro <viro@zeniv.linux.org.uk>
  Cc: Alan Cox <alan@linux.intel.com>
  Cc: "Eric W. Biederman" <ebiederm@xmission.com>
  Cc: Doug Ledford <dledford@redhat.com>
  Cc: Serge Hallyn <serge.hallyn@canonical.com>
  Cc: James Morris <james.l.morris@oracle.com>
  Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
  Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
  abf75a5033d4da7b8a7e92321d74021d1fcfb502:[PATCH] Fix prctl privilege escalation and suid_dumpable (CVE-2006-2451)

  Based on a patch from Ernie Petrides

  During security research, Red Hat discovered a behavioral flaw in core
  dump handling. A local user could create a program that would cause a
  core file to be dumped into a directory they would not normally have
  permissions to write to. This could lead to a denial of service (disk
  consumption), or allow the local user to gain root privileges.

  The prctl() system call should never allow to set "dumpable" to the
  value 2. Especially not for non-privileged users.

  This can be split into three cases:

    1) running as root -- then core dumps will already be done as root,
       and so prctl(PR_SET_DUMPABLE, 2) is not useful

    2) running as non-root w/setuid-to-root -- this is the debatable case

    3) running as non-root w/setuid-to-non-root -- then you definitely
       do NOT want "dumpable" to get set to 2 because you have the
       privilege escalation vulnerability

  With case #2, the only potential usefulness is for a program that has
  designed to run with higher privilege (than the user invoking it) that
  wants to be able to create root-owned root-validated core dumps. This
  might be useful as a debugging aid, but would only be safe if the program
  had done a chdir() to a safe directory.

  There is no benefit to a production setuid-to-root utility, because it
  shouldn't be dumping core in the first place. If this is true, then the
  same debugging aid could also be accomplished with the "suid_dumpable"
  sysctl.

  Signed-off-by: Marcel Holtmann <marcel@holtmann.org>
  Signed-off-by: Linus Torvalds <torvalds@osdl.org>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 9520628e8ceb69fa9a4aee6b57f22675d9e1b709
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: abf75a5033d4da7b8a7e92321d74021d1fcfb502
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/9520628e8ceb69fa9a4aee6b57f22675d9e1b709
    reference_type: commit
    reference_id: 9520628e8ceb69fa9a4aee6b57f22675d9e1b709
  - url: https://github.com/torvalds/linux/tree/abf75a5033d4da7b8a7e92321d74021d1fcfb502
    reference_type: commit
    reference_id: abf75a5033d4da7b8a7e92321d74021d1fcfb502
