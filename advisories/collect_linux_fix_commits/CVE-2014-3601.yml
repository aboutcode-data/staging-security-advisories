advisory_id: CVE-2014-3601
datasource_id: collect_linux_fix_commits/CVE-2014-3601
datasource_url: https://github.com/torvalds/linux
aliases: []
summary: |
  3d32e4dbe71374a6780eaf51d719d76f9a9bf22f:kvm: fix excessive pages un-pinning in kvm_iommu_map error path.

  The third parameter of kvm_unpin_pages() when called from
  kvm_iommu_map_pages() is wrong, it should be the number of pages to un-pin
  and not the page size.

  This error was facilitated with an inconsistent API: kvm_pin_pages() takes
  a size, but kvn_unpin_pages() takes a number of pages, so fix the problem
  by matching the two.

  This was introduced by commit 350b8bd ("kvm: iommu: fix the third parameter
  of kvm_iommu_put_pages (CVE-2014-3601)"), which fixes the lack of
  un-pinning for pages intended to be un-pinned (i.e. memory leak) but
  unfortunately potentially aggravated the number of pages we un-pin that
  should have stayed pinned. As far as I understand though, the same
  practical mitigations apply.

  This issue was found during review of Red Hat 6.6 patches to prepare
  Ksplice rebootless updates.

  Thanks to Vegard for his time on a late Friday evening to help me in
  understanding this code.

  Fixes: 350b8bd ("kvm: iommu: fix the third parameter of... (CVE-2014-3601)")
  Cc: stable@vger.kernel.org
  Signed-off-by: Quentin Casasnovas <quentin.casasnovas@oracle.com>
  Signed-off-by: Vegard Nossum <vegard.nossum@oracle.com>
  Signed-off-by: Jamie Iles <jamie.iles@oracle.com>
  Reviewed-by: Sasha Levin <sasha.levin@oracle.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  3d32e4dbe71374a6780eaf51d719d76f9a9bf22f:kvm: fix excessive pages un-pinning in kvm_iommu_map error path.

  The third parameter of kvm_unpin_pages() when called from
  kvm_iommu_map_pages() is wrong, it should be the number of pages to un-pin
  and not the page size.

  This error was facilitated with an inconsistent API: kvm_pin_pages() takes
  a size, but kvn_unpin_pages() takes a number of pages, so fix the problem
  by matching the two.

  This was introduced by commit 350b8bd ("kvm: iommu: fix the third parameter
  of kvm_iommu_put_pages (CVE-2014-3601)"), which fixes the lack of
  un-pinning for pages intended to be un-pinned (i.e. memory leak) but
  unfortunately potentially aggravated the number of pages we un-pin that
  should have stayed pinned. As far as I understand though, the same
  practical mitigations apply.

  This issue was found during review of Red Hat 6.6 patches to prepare
  Ksplice rebootless updates.

  Thanks to Vegard for his time on a late Friday evening to help me in
  understanding this code.

  Fixes: 350b8bd ("kvm: iommu: fix the third parameter of... (CVE-2014-3601)")
  Cc: stable@vger.kernel.org
  Signed-off-by: Quentin Casasnovas <quentin.casasnovas@oracle.com>
  Signed-off-by: Vegard Nossum <vegard.nossum@oracle.com>
  Signed-off-by: Jamie Iles <jamie.iles@oracle.com>
  Reviewed-by: Sasha Levin <sasha.levin@oracle.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  e9de42d8eeffdc23af0144cafa9e3deacc489fb9:Merge tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm

  Pull KVM fixes from Paolo Bonzini:
   "Reverting a 3.16 patch, fixing two bugs in device assignment (one has
    a CVE), and fixing some problems introduced during the merge window
    (the CMA bug came in via Andrew, the x86 ones via yours truly)"

  * tag 'for-linus' of git://git.kernel.org/pub/scm/virt/kvm/kvm:
    virt/kvm/assigned-dev.c: Set 'dev->irq_source_id' to '-1' after free it
    Revert "KVM: x86: Increase the number of fixed MTRR regs to 10"
    KVM: x86: do not check CS.DPL against RPL during task switch
    KVM: x86: Avoid emulating instructions on #UD mistakenly
    PC, KVM, CMA: Fix regression caused by wrong get_order() use
    kvm: iommu: fix the third parameter of kvm_iommu_put_pages (CVE-2014-3601)
  350b8bdd689cd2ab2c67c8a86a0be86cfa0751a7:kvm: iommu: fix the third parameter of kvm_iommu_put_pages (CVE-2014-3601)

  The third parameter of kvm_iommu_put_pages is wrong,
  It should be 'gfn - slot->base_gfn'.

  By making gfn very large, malicious guest or userspace can cause kvm to
  go to this error path, and subsequently to pass a huge value as size.
  Alternatively if gfn is small, then pages would be pinned but never
  unpinned, causing host memory leak and local DOS.

  Passing a reasonable but large value could be the most dangerous case,
  because it would unpin a page that should have stayed pinned, and thus
  allow the device to DMA into arbitrary memory.  However, this cannot
  happen because of the condition that can trigger the error:

  - out of memory (where you can't allocate even a single page)
    should not be possible for the attacker to trigger

  - when exceeding the iommu's address space, guest pages after gfn
    will also exceed the iommu's address space, and inside
    kvm_iommu_put_pages() the iommu_iova_to_phys() will fail.  The
    page thus would not be unpinned at all.

  Reported-by: Jack Morgenstein <jackm@mellanox.com>
  Cc: stable@vger.kernel.org
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: e9de42d8eeffdc23af0144cafa9e3deacc489fb9
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 3d32e4dbe71374a6780eaf51d719d76f9a9bf22f
    introduced_in_commits: []
  - purl: pkg:github/torvalds/linux
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/torvalds/linux
        commit: 350b8bdd689cd2ab2c67c8a86a0be86cfa0751a7
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/torvalds/linux/tree/350b8bdd689cd2ab2c67c8a86a0be86cfa0751a7
    reference_type: commit
    reference_id: 350b8bdd689cd2ab2c67c8a86a0be86cfa0751a7
  - url: https://github.com/torvalds/linux/tree/3d32e4dbe71374a6780eaf51d719d76f9a9bf22f
    reference_type: commit
    reference_id: 3d32e4dbe71374a6780eaf51d719d76f9a9bf22f
  - url: https://github.com/torvalds/linux/tree/e9de42d8eeffdc23af0144cafa9e3deacc489fb9
    reference_type: commit
    reference_id: e9de42d8eeffdc23af0144cafa9e3deacc489fb9
