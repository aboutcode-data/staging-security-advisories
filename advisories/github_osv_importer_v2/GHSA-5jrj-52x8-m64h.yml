advisory_id: GHSA-5jrj-52x8-m64h
datasource_id: github_osv_importer_v2/GHSA-5jrj-52x8-m64h
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/04/GHSA-5jrj-52x8-m64h/GHSA-5jrj-52x8-m64h.json
aliases:
  - CVE-2024-32649
summary: "vyper performs multiple eval of `sqrt()` argument built in\n### Summary\nUsing the\
  \ `sqrt` builtin can result in multiple eval evaluation of side effects when the argument\
  \ has side-effects. The bug is more difficult (but not impossible!) to trigger as of 0.3.4,\
  \ when the unique symbol fence was introduced (https://github.com/vyperlang/vyper/pull/2914).\n\
  \nA contract search was performed and no vulnerable contracts were found in production.\n\n\
  ### Details\nIt can be seen that the `build_IR` function of the `sqrt` builtin doesn't cache\
  \ the argument to the stack: \nhttps://github.com/vyperlang/vyper/blob/4595938734d9988f8e46e8df38049ae0559abedb/vyper/builtins/functions.py#L2151\n\
  \nAs such, it can be evaluated multiple times (instead of retrieving the value from the stack).\n\
  \n### PoC\nWith at least Vyper version `0.2.15+commit.6e7dba7` the following contract:\n```vyper\n\
  c: uint256\n\n@internal\ndef some_decimal() -> decimal:\n    self.c += 1\n    return 1.0\n\
  \n@external\ndef foo() -> uint256:\n    k: decimal = sqrt(self.some_decimal())\n    return\
  \ self.c\n```\npasses the following test:\n```solidity\n// SPDX-License-Identifier: MIT\n\
  pragma solidity >=0.8.13;\n\nimport \"../../lib/ds-test/test.sol\";\nimport \"../../lib/utils/Console.sol\"\
  ;\nimport \"../../lib/utils/VyperDeployer.sol\";\n\nimport \"../ITest.sol\";\n\ncontract ConTest\
  \ is DSTest {\n    VyperDeployer vyperDeployer = new VyperDeployer();\n\n    ITest t;\n\n\
  \    function setUp() public {\n        t = ITest(vyperDeployer.deployContract(\"Test\"));\n\
  \    }\n\n    function testFoo() public {\n        uint256 val = t.foo();\n        console.log(val);\n\
  \        assert (val == 4);\n    }\n}\n```\n \n### Patches\nPatched in https://github.com/vyperlang/vyper/pull/3976.\n\
  \n### Impact\nNo vulnerable production contracts were found."
impacted_packages:
  - purl: pkg:pypi/vyper
    affected_versions: vers:pypi/<0.4.0
    fixed_versions: vers:pypi/0.4.0
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/04/GHSA-5jrj-52x8-m64h/GHSA-5jrj-52x8-m64h.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-95
references:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/vyper/PYSEC-2024-209.yaml
    reference_type:
    reference_id:
  - url: https://github.com/vyperlang/vyper
    reference_type:
    reference_id:
  - url: https://github.com/vyperlang/vyper/pull/2914
    reference_type:
    reference_id:
  - url: https://github.com/vyperlang/vyper/security/advisories/GHSA-5jrj-52x8-m64h
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-32649
    reference_type:
    reference_id: CVE-2024-32649
