advisory_id: GHSA-wprv-93r4-jj2p
datasource_id: github_osv_importer_v2/GHSA-wprv-93r4-jj2p
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/06/GHSA-wprv-93r4-jj2p/GHSA-wprv-93r4-jj2p.json
aliases:
  - CVE-2023-34459
summary: |
  OpenZeppelin Contracts using MerkleProof multiproofs may allow proving arbitrary leaves for specific trees
  ### Impact

  When the `verifyMultiProof`, `verifyMultiProofCalldata`, `processMultiProof`, or `processMultiProofCalldata` functions are in use, it is possible to construct merkle trees that allow forging a valid multiproof for an arbitrary set of leaves.

  A contract may be vulnerable if it uses multiproofs for verification and the merkle tree that is processed includes a node with value 0 at depth 1 (just under the root). This could happen inadvertently for balanced trees with 3 leaves or less, if the leaves are not hashed. This could happen deliberately if a malicious tree builder includes such a node in the tree.

  A contract is not vulnerable if it uses single-leaf proving (`verify`, `verifyCalldata`, `processProof`, or `processProofCalldata`), or if it uses multiproofs with a known tree that has hashed leaves. Standard merkle trees produced or validated with the [@openzeppelin/merkle-tree](https://github.com/OpenZeppelin/merkle-tree) library are safe.

  ### Patches

  The problem has been patched in 4.9.2.

  ### Workarounds

  If you are using multiproofs: When constructing merkle trees hash the leaves and do not insert empty nodes in your trees. Using the [@openzeppelin/merkle-tree](https://www.npmjs.com/package/@openzeppelin/merkle-tree) package eliminates this issue. Do not accept user-provided merkle roots without reconstructing at least the first level of the tree. Verify the merkle tree structure by reconstructing it from the leaves.
impacted_packages:
  - purl: pkg:npm/%40openzeppelin/contracts
    affected_versions: vers:npm/>=4.7.0|<4.9.2
    fixed_versions: vers:npm/4.9.2
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40openzeppelin/contracts-upgradeable
    affected_versions: vers:npm/>=4.7.0|<4.9.2
    fixed_versions: vers:npm/4.9.2
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/06/GHSA-wprv-93r4-jj2p/GHSA-wprv-93r4-jj2p.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-354
references:
  - url: https://github.com/OpenZeppelin/openzeppelin-contracts
    reference_type:
    reference_id:
  - url: https://github.com/OpenZeppelin/openzeppelin-contracts/commit/4d2383e17186be3e8ccf5a442e9686ecc7de1c55
    reference_type:
    reference_id:
  - url: https://github.com/OpenZeppelin/openzeppelin-contracts/releases/tag/v4.9.2
    reference_type:
    reference_id:
  - url: https://github.com/OpenZeppelin/openzeppelin-contracts/security/advisories/GHSA-wprv-93r4-jj2p
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-34459
    reference_type:
    reference_id: CVE-2023-34459
