advisory_id: GHSA-mf3v-f2qq-pf9g
datasource_id: github_osv_importer_v2/GHSA-mf3v-f2qq-pf9g
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/03/GHSA-mf3v-f2qq-pf9g/GHSA-mf3v-f2qq-pf9g.json
aliases:
  - CVE-2022-24743
summary: "Insufficient Session Expiration in Sylius\n### Impact\nThe reset password token was\
  \ not set to null after the password was changed. This is causing behaviour in which the same\
  \ token can be used several times, so it can result in a leak of the existing token and an\
  \ unauthorised password change.\n\n### Patches\nThe issue is fixed in versions: 1.10.11, 1.11.2\
  \ and above\n\n### Workarounds\nYou have to overwrite your `Sylius\\Bundle\\ApiBundle\\CommandHandler\\\
  ResetPasswordHandler` class using this code:\n\n```php\n<?php\ndeclare(strict_types=1);\n\n\
  namespace App\\CommandHandler\\Account;\n\nuse Sylius\\Bundle\\ApiBundle\\Command\\Account\\\
  ResetPassword;\nuse Sylius\\Component\\Core\\Model\\ShopUserInterface;\nuse Sylius\\Component\\\
  Resource\\Metadata\\MetadataInterface;\nuse Sylius\\Component\\User\\Repository\\UserRepositoryInterface;\n\
  use Sylius\\Component\\User\\Security\\PasswordUpdaterInterface;\nuse Symfony\\Component\\\
  Messenger\\Handler\\MessageHandlerInterface;\nuse Webmozart\\Assert\\Assert;\n\nfinal class\
  \ ResetPasswordHandler implements MessageHandlerInterface\n{\n    private UserRepositoryInterface\
  \ $userRepository;\n    private MetadataInterface $metadata;\n    private PasswordUpdaterInterface\
  \ $passwordUpdater;\n\n    public function __construct(\n        UserRepositoryInterface $userRepository,\n\
  \        MetadataInterface $metadata,\n        PasswordUpdaterInterface $passwordUpdater\n\
  \    ) {\n        $this->userRepository = $userRepository;\n        $this->metadata = $metadata;\n\
  \        $this->passwordUpdater = $passwordUpdater;\n    }\n\n    public function __invoke(ResetPassword\
  \ $command): void\n    {\n        /** @var ShopUserInterface|null $user */\n        $user\
  \ = $this->userRepository->findOneBy(['passwordResetToken' => $command->resetPasswordToken]);\n\
  \n        Assert::notNull($user, 'No user found with reset token: ' . $command->resetPasswordToken);\n\
  \n        $resetting = $this->metadata->getParameter('resetting');\n        $lifetime = new\
  \ \\DateInterval($resetting['token']['ttl']);\n\n        if (!$user->isPasswordRequestNonExpired($lifetime))\
  \ {\n            throw new \\InvalidArgumentException('Password reset token has expired');\n\
  \        }\n\n        if ($command->resetPasswordToken !== $user->getPasswordResetToken())\
  \ {\n            throw new \\InvalidArgumentException('Password reset token does not match.');\n\
  \        }\n\n        $user->setPlainPassword($command->newPassword);\n\n        $this->passwordUpdater->updatePassword($user);\n\
  \        $user->setPasswordResetToken(null);\n    }\n}\n```\nAnd register it in container:\n\
  \n```yaml\n\nApp\\CommandHandler\\Account\\ResetPasswordHandler:\n    arguments:\n       \
  \ - '@sylius.repository.shop_user'\n        - !service\n              class: Sylius\\Component\\\
  Resource\\Metadata\\MetadataInterface\n              factory: [ '@sylius.resource_registry',\
  \ 'get' ]\n              arguments:\n                    - 'sylius.shop_user'\n          \
  \          - '@sylius.security.password_updater'\n    tags:\n        - { name: messenger.message_handler,\
  \ bus: sylius.command_bus }\n        - { name: messenger.message_handler, bus: sylius_default.bus\
  \ }\n         \n```\n\n\n### For more information\nIf you have any questions or comments about\
  \ this advisory:\n* Open an issue in [Sylius issues](https://github.com/Sylius/Sylius/issues)\n\
  * Email us at [security@sylius.com](mailto:security@sylius.com)"
impacted_packages:
  - purl: pkg:composer/sylius/sylius
    affected_versions: vers:composer/>=1.10.0|<1.10.11
    fixed_versions: vers:composer/1.10.11
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:composer/sylius/sylius
    affected_versions: vers:composer/>=1.11.0|<1.11.2
    fixed_versions: vers:composer/1.11.2
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/03/GHSA-mf3v-f2qq-pf9g/GHSA-mf3v-f2qq-pf9g.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-613
references:
  - url: https://github.com/Sylius/Sylius
    reference_type:
    reference_id:
  - url: https://github.com/Sylius/Sylius/releases/tag/v1.10.11
    reference_type:
    reference_id:
  - url: https://github.com/Sylius/Sylius/releases/tag/v1.11.2
    reference_type:
    reference_id:
  - url: https://github.com/Sylius/Sylius/security/advisories/GHSA-mf3v-f2qq-pf9g
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-24743
    reference_type:
    reference_id: CVE-2022-24743
