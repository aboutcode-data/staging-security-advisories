advisory_id: GHSA-ff5x-7qg5-vwf2
datasource_id: github_osv_importer_v2/GHSA-ff5x-7qg5-vwf2
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/12/GHSA-ff5x-7qg5-vwf2/GHSA-ff5x-7qg5-vwf2.json
aliases:
  - CVE-2023-50251
summary: |
  Denial of service caused by infinite recursion when parsing SVG document
  ### Summary
  When parsing the attributes passed to a `use` tag inside an svg document, we can cause the system to go to an infinite recursion. Depending on the system configuration and attack pattern this could exhaust the memory available to the executing process and/or to the server itself.

  ### Details
  Inside `Svg\Tag\UseTag::before`, php-svg-lib parses the attributes passed to an `use` tag inside an svg document. When it finds a `href` or `xlink:href`, it will try to retrieve the object representing this tag:

  ```
  $link = $attributes["href"] ?? $attributes["xlink:href"];
  $this->reference = $document->getDef($link);

  if ($this->reference) {
      $this->reference->before($attributes);
  }
  ```

  `$document->getDef` is implemented as follow:

  ```
  public function getDef($id) {
      $id = ltrim($id, "#");

      return isset($this->defs[$id]) ? $this->defs[$id] : null;
  }
  ```

  _Note:_ the `$id` in the above method is actually the _link_ being used in `use` tag. This part is important, because this behaviour  here actually leads to the vulnerability. It will be mentioned later on in this report.

  If it finds the referenced object, it will try to call the `before` method on the referenced object (this is still inside `Svg\Tag\UseTag::before`) :

  ```
  if ($this->reference) {
      $this->reference->before($attributes);
  }
  ```

  In order to cause an infinte loop, we need to be able to control the `$id` used in the `$this->defs[$id]` code above. This `defs` property (`Svg\Document::defs`) is being populated when `Svg\Document::_tagStart` is called. This is the handler being used when the php-svg-lib is parsing the svg structure:

  ```
  // Svg\Document line 343
  if ($tag) {
      if (isset($attributes["id"])) {
          $this->defs[$attributes["id"]] = $tag;
      }
      else {
          // ...
      }

      // ...
  }
  ```

  So if the `use` tag contains an `id`, then that `use` tag will be added to the `$defs` array with it's `id` as the key.

  Now as noted before, when there is a link inside the `use` tag, the library uses that link as the `id` to actually find the object or `tag` that has been added to the `Svg\Document::defs`.

  So if the `id` attribute is equal to the link attribute inside the `use` tag, then the referenced object (in this case it is the `Use` tag object) will be called recursively until the memory given to the script is exhausted.

  ### PoC

  This is an example svg file that can be used to demonstrate the vulnerability.

  ```
  <svg width="200" height="200"
    xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <use id="selfref" xlink:href="#selfref" />
  </svg>
  ```

  ### Impact

  When the lib parses the above payload, it will crash:

  ```
  PHP Fatal error:  Allowed memory size of 536870912 bytes exhausted (tried to allocate 262144 bytes) in /xxx/dompdf/vendor/phenx/php-svg-lib/src/Svg/Tag/UseTag.php on line 37
  ```

  An attacker sending multiple request to a system to render the above payload can potentially cause resource exhaustion to the point that the system is unable to handle incoming request.
impacted_packages:
  - purl: pkg:composer/phenx/php-svg-lib
    affected_versions: vers:composer/<0.5.1
    fixed_versions: vers:composer/0.5.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/12/GHSA-ff5x-7qg5-vwf2/GHSA-ff5x-7qg5-vwf2.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-674
references:
  - url: https://github.com/dompdf/php-svg-lib
    reference_type:
    reference_id:
  - url: https://github.com/dompdf/php-svg-lib/commit/88163cbe562d9b391b3a352e54d9c89d02d77ee0
    reference_type:
    reference_id:
  - url: https://github.com/dompdf/php-svg-lib/security/advisories/GHSA-ff5x-7qg5-vwf2
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-50251
    reference_type:
    reference_id: CVE-2023-50251
