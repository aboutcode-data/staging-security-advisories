advisory_id: GHSA-2r8p-fg3c-wcj4
datasource_id: github_osv_importer_v2/GHSA-2r8p-fg3c-wcj4
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2021/08/GHSA-2r8p-fg3c-wcj4/GHSA-2r8p-fg3c-wcj4.json
aliases:
  - CVE-2021-37654
summary: |
  Heap OOB and CHECK fail in `ResourceGather`
  ### Impact
  An attacker can trigger a crash via a `CHECK`-fail in debug builds of TensorFlow using `tf.raw_ops.ResourceGather` or a read from outside the bounds of heap allocated data in the same API in a release build:

  ```python
  import tensorflow as tf

  tensor = tf.constant(value=[[1,2],[3,4],[5,6]],shape=(3,2),dtype=tf.uint32)
  v = tf.Variable(tensor)
  tf.raw_ops.ResourceGather(
    resource=v.handle,
    indices=[0],
    dtype=tf.uint32,
    batch_dims=10,
    validate_indices=False)
  ```

  The [implementation](https://github.com/tensorflow/tensorflow/blob/f24faa153ad31a4b51578f8181d3aaab77a1ddeb/tensorflow/core/kernels/resource_variable_ops.cc#L660-L668) does not check that the `batch_dims` value that the user supplies is less than the rank of the input tensor.

  Since the implementation uses several for loops over the dimensions of `tensor`, this results in reading data from outside the bounds of heap allocated buffer backing the tensor:

  ```cc
      // batch_dims_ = > params.dims() (10 > 2)
      for (int i = 0; i < batch_dims_; ++i) {
        result_shape.AddDim(params.dim_size(i));
      }
      for (int i = batch_dims_; i < indices.dims(); ++i) {
        result_shape.AddDim(indices.dim_size(i));
      }
      for (int i = batch_dims_ + 1; i < params.dims(); ++i) {
        result_shape.AddDim(params.dim_size(i));
      }
  ```

  In debug mode, `.dim_size(i)` validates that the argument is less than `.dims()` using a `DCHECK`. But the `DCHECK` is a no-op in release builds.

  ### Patches
  We have patched the issue in GitHub commit [bc9c546ce7015c57c2f15c168b3d9201de679a1d](https://github.com/tensorflow/tensorflow/commit/bc9c546ce7015c57c2f15c168b3d9201de679a1d).

  The fix will be included in TensorFlow 2.6.0. We will also cherrypick this commit on TensorFlow 2.5.1, TensorFlow 2.4.3, and TensorFlow 2.3.4, as these are also affected and still in supported range.

  ### For more information
  Please consult [our security guide](https://github.com/tensorflow/tensorflow/blob/master/SECURITY.md) for more information regarding the security model and how to contact us with issues and questions.

  ### Attribution
  This vulnerability has been reported by members of the Aivul Team from Qihoo 360.
impacted_packages:
  - purl: pkg:pypi/tensorflow
    affected_versions: vers:pypi/<2.3.4
    fixed_versions: vers:pypi/2.3.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow
    affected_versions: vers:pypi/>=2.4.0|<2.4.3
    fixed_versions: vers:pypi/2.4.3
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow
    affected_versions: vers:pypi/2.5.0
    fixed_versions: vers:pypi/2.5.1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow-cpu
    affected_versions: vers:pypi/<2.3.4
    fixed_versions: vers:pypi/2.3.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow-cpu
    affected_versions: vers:pypi/>=2.4.0|<2.4.3
    fixed_versions: vers:pypi/2.4.3
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow-cpu
    affected_versions: vers:pypi/2.5.0
    fixed_versions: vers:pypi/2.5.1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow-gpu
    affected_versions: vers:pypi/<2.3.4
    fixed_versions: vers:pypi/2.3.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow-gpu
    affected_versions: vers:pypi/>=2.4.0|<2.4.3
    fixed_versions: vers:pypi/2.4.3
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/tensorflow-gpu
    affected_versions: vers:pypi/2.5.0
    fixed_versions: vers:pypi/2.5.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2021/08/GHSA-2r8p-fg3c-wcj4/GHSA-2r8p-fg3c-wcj4.json
  - score: '7.0'
    scoring_system: cvssv4
    scoring_elements: CVSS:4.0/AV:L/AC:L/AT:N/PR:L/UI:N/VC:H/VI:L/VA:H/SC:N/SI:N/SA:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2021/08/GHSA-2r8p-fg3c-wcj4/GHSA-2r8p-fg3c-wcj4.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-125
references:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow-cpu/PYSEC-2021-567.yaml
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow-gpu/PYSEC-2021-765.yaml
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow/PYSEC-2021-276.yaml
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/commit/bc9c546ce7015c57c2f15c168b3d9201de679a1d
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/security/advisories/GHSA-2r8p-fg3c-wcj4
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-37654
    reference_type:
    reference_id: CVE-2021-37654
