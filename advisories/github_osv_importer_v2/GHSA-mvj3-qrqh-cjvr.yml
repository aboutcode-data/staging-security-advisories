advisory_id: GHSA-mvj3-qrqh-cjvr
datasource_id: github_osv_importer_v2/GHSA-mvj3-qrqh-cjvr
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/07/GHSA-mvj3-qrqh-cjvr/GHSA-mvj3-qrqh-cjvr.json
aliases:
  - CVE-2023-34450
summary: "CometBFT PeerState JSON serialization deadlock\n### Impact\nAn internal modification\
  \ to the way struct `PeerState` is serialized to JSON introduced a deadlock when new function\
  \ MarshallJSON is called. This function can be called from two places:\n\n1. Via logs\n  \
  \  * Setting the `consensus` logging module to \"debug\" level (should not happen in production),\
  \ and\n    * Setting the log output format to JSON\n2. Via RPC `dump_consensus_state` \n\n\
  Case 1 above, which should not be hit in production, will eventually hit the deadlock in most\
  \ goroutines, effectively halting the node.\n\nIn case 2, only the data structures related\
  \ to the first peer will be deadlocked, together with the thread(s) dealing with the RPC request(s).\
  \ This means that only one of the channels of communication to the node's peers will be blocked.\
  \ Eventually the peer will timeout and excluded from the list (typically after 2 minutes).\
  \ The goroutines involved in the deadlock will not be garbage collected, but they will not\
  \ interfere with the system after the peer is excluded.\n\nThe theoretical worst case for\
  \ case 2, is a network with only two validator nodes. In this case, each of the nodes only\
  \ has one `PeerState` struct. If `dump_consensus_state` is called in either node (or both),\
  \ the chain will halt until the peer connections time out, after which the nodes will reconnect\
  \ (with different `PeerState` structs) and the chain will progress again. Then, the same process\
  \ can be repeated.\n\nAs the number of nodes in a network increases, and thus, the number\
  \ of peer struct each node maintains, the possibility of reproducing the perturbation visible\
  \ with 2 nodes decreases. Only the first `PeerState` struct will deadlock, and not the others\
  \ (RPC `dump_consensus_state` accesses them in a for loop, so the deadlock at the first iteration\
  \ causes the rest of the iterations of that \"for\" loop to never be reached).\n\nThis regression\
  \ was introduced in versions `v0.34.28` and `v0.37.1`, and will be fixed in `v0.34.29` and\
  \ `v0.37.2`.\n\n### Patches\nThe PR containing the fix is [here](https://github.com/cometbft/cometbft/pull/865),\
  \ and the corresponding issue is [here](https://github.com/cometbft/cometbft/pull/863)\n\n\
  ### Workarounds\nFor case 1 (hitting the deadlock via logs)\n* either don't set the log output\
  \ to \"json\", leave at \"plain\",\n* or don't set the consensus logging module to \"debug\"\
  , leave it at \"info\" or higher.\n\nFor case 2 (hitting the deadlock via RPC `dump_consensus_state`)\n\
  * do not expose `dump_consensus_state` RPC endpoint to the public internet (e.g., via rules\
  \ in your nginx setup)\n\n### References\n\n* [Issue](https://github.com/cometbft/cometbft/pull/863)\
  \ that introduced the deadlock\n* [Issue](https://github.com/cometbft/cometbft/pull/524) reporting\
  \ the bug via logs"
impacted_packages: []
severities:
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/07/GHSA-mvj3-qrqh-cjvr/GHSA-mvj3-qrqh-cjvr.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-401
  - CWE-770
references:
  - url: https://github.com/cometbft/cometbft
    reference_type:
    reference_id:
  - url: https://github.com/cometbft/cometbft/pull/524
    reference_type:
    reference_id:
  - url: https://github.com/cometbft/cometbft/pull/863
    reference_type:
    reference_id:
  - url: https://github.com/cometbft/cometbft/pull/865
    reference_type:
    reference_id:
  - url: https://github.com/cometbft/cometbft/security/advisories/GHSA-mvj3-qrqh-cjvr
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-34450
    reference_type:
    reference_id: CVE-2023-34450
