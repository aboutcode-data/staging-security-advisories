advisory_id: GHSA-xm67-587q-r2vw
datasource_id: github_osv_importer_v2/GHSA-xm67-587q-r2vw
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/03/GHSA-xm67-587q-r2vw/GHSA-xm67-587q-r2vw.json
aliases:
  - CVE-2023-27477
summary: |
  wasmtime vulnerable to miscompilation of `i8x16.select` with the same inputs on x86_64
  ### Impact

  Wasmtime's code generation backend, Cranelift, has a bug on x86_64 platforms for the WebAssembly `i8x16.select` instruction which will produce the wrong results when the same operand is provided to the instruction and some of the selected indices are greater than 16. There is an off-by-one error  in the calculation of the mask to the `pshufb` instruction which causes incorrect results to be returned if lanes are selected from the second vector.

  The impact of this miscompilation is that the WebAssembly instruction can produce incorrect results for the `i8x16.select` instruction. This should have no effect on embedders and does not represent a sandbox escape, for example. Guest programs, however, may behave unexpectedly due to the incorrect result of this instruction. In extreme cases if a guest program is handling untrusted input then the guest program may deviate from its intended execution, for example calling an imported host function with different arguments than intended. This still does not impact embedders, however, because there is no form of privilege escalation with the guest.

  At this time it's expected that this codegen pattern doesn't show up in the wild that often. LLVM-generated modules, for example, do not appear to conventionally or idiomatically generate code which would hit this bug. It is possible, however, to still write code which triggers this, so it's recommended for embedders to analyze existing modules to see if any are affected.

  ### Patches

  This codegen bug has been fixed in Wasmtime 6.0.1, 5.0.1, and 4.0.1. Users are recommended to upgrade to these updated versions.

  ### Workarounds

  If upgrading is not an option for you at this time, you can avoid this miscompilation by [disabling the Wasm simd proposal](https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.wasm_simd)

  ```rust
  config.wasm_simd(false);
  ```

  Additionally the bug is only present on x86_64 hosts. Other platforms such as AArch64 and s390x are not affected.

  ### References

  * [The WebAssembly simd proposal](https://github.com/webassembly/simd)
  * [Mailing list announcement](https://groups.google.com/a/bytecodealliance.org/g/sec-announce/c/Mov-ItrNJsQ)
  * [GitHub advisory](https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-xm67-587q-r2vw)
  * [Commit to fix this issue on Wasmtime's `main` branch](https://github.com/bytecodealliance/wasmtime/commit/5dc2bbccbb363e474d2c9a1b8e38a89a43bbd5d1)

  ### For more information

  If you have any questions or comments about this advisory:

  * Reach out to us on [the Bytecode Alliance Zulip chat](https://bytecodealliance.zulipchat.com/#narrow/stream/217126-wasmtime)
  * Open an issue in [the bytecodealliance/wasmtime repository](https://github.com/bytecodealliance/wasmtime/)
impacted_packages: []
severities:
  - score: '3.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:N/I:L/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/03/GHSA-xm67-587q-r2vw/GHSA-xm67-587q-r2vw.json
  - score: LOW
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-193
references:
  - url: https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.wasm_simd
    reference_type:
    reference_id:
  - url: https://github.com/bytecodealliance/wasmtime
    reference_type:
    reference_id:
  - url: https://github.com/bytecodealliance/wasmtime/commit/5dc2bbccbb363e474d2c9a1b8e38a89a43bbd5d1
    reference_type:
    reference_id:
  - url: https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-xm67-587q-r2vw
    reference_type:
    reference_id:
  - url: https://github.com/webassembly/simd
    reference_type:
    reference_id:
  - url: https://groups.google.com/a/bytecodealliance.org/g/sec-announce/c/Mov-ItrNJsQ
    reference_type:
    reference_id:
  - url: https://rustsec.org/advisories/RUSTSEC-2023-0093.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-27477
    reference_type:
    reference_id: CVE-2023-27477
