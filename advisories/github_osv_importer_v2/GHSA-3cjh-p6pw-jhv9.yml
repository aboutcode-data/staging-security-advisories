advisory_id: GHSA-3cjh-p6pw-jhv9
datasource_id: github_osv_importer_v2/GHSA-3cjh-p6pw-jhv9
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/09/GHSA-3cjh-p6pw-jhv9/GHSA-3cjh-p6pw-jhv9.json
aliases:
  - CVE-2023-42446
summary: |
  Pow Mnesia cache doesn't invalidate all expired keys on startup
  Use of `Pow.Store.Backend.MnesiaCache` is susceptible to session hijacking as expired keys are not being invalidated correctly on startup. A cache key may become expired when all `Pow.Store.Backend.MnesiaCache` instances have been shut down for a period that is longer than the keys' remaining TTL and the expired key won't be invalidated on startups.

  ### Workarounds

  The expired keys, including all expired sessions, can be manually invalidated by running:

  ```elixir
  :mnesia.sync_transaction(fn ->
    Enum.each(:mnesia.dirty_select(Pow.Store.Backend.MnesiaCache, [{{Pow.Store.Backend.MnesiaCache, :_, :_}, [], [:"$_"]}]), fn {_, key,  {_value, expire}} ->
      ttl = expire - :os.system_time(:millisecond)
      if ttl < 0, do: :mnesia.delete({Pow.Store.Backend.MnesiaCache, key})
    end)
  end)
  ```

  ### References
  https://github.com/pow-auth/pow/commit/15dc525be03c466daa5d2119ca7acdec7b24ed17
  https://github.com/pow-auth/pow/issues/713
  https://github.com/pow-auth/pow/pull/714
impacted_packages:
  - purl: pkg:hex/pow
    affected_versions: vers:hex/>=1.0.14|<1.0.34
    fixed_versions: vers:hex/1.0.34
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '6.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/09/GHSA-3cjh-p6pw-jhv9/GHSA-3cjh-p6pw-jhv9.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-298
  - CWE-672
references:
  - url: https://github.com/pow-auth/pow
    reference_type:
    reference_id:
  - url: https://github.com/pow-auth/pow/commit/15dc525be03c466daa5d2119ca7acdec7b24ed17
    reference_type:
    reference_id:
  - url: https://github.com/pow-auth/pow/issues/713
    reference_type:
    reference_id:
  - url: https://github.com/pow-auth/pow/pull/714
    reference_type:
    reference_id:
  - url: https://github.com/pow-auth/pow/security/advisories/GHSA-3cjh-p6pw-jhv9
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-42446
    reference_type:
    reference_id: CVE-2023-42446
