advisory_id: GHSA-8274-h5jp-97vr
datasource_id: github_osv_importer_v2/GHSA-8274-h5jp-97vr
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/07/GHSA-8274-h5jp-97vr/GHSA-8274-h5jp-97vr.json
aliases:
  - CVE-2022-31109
summary: |
  Diactoros before 2.11.1 vulnerable to HTTP Host Header Attack
  ### Impact

  Applications that use Diactoros, and are either not behind a proxy, or can be accessed via untrusted proxies, can potentially have the host, protocol, and/or port of a `Laminas\Diactoros\Uri` instance associated with the incoming server request modified to reflect values from `X-Forwarded-*` headers. Such changes can potentially lead to XSS attacks (if a fully-qualified URL is used in links) and/or URL poisoning.

  ### Patches

  Any version after 2.11.0.

  Starting in laminas/laminas-diactoros 2.11.1, we have added `Laminas\Diactoros\ServerRequestFilter\FilterServerRequestInterface`, which defines the single method `__invoke(Psr\Http\Message\ServerRequestInterface $request): Psr\Http\Message\ServerRequestInterface`. Filters implementing this interface allow modifying and returning a generated `ServerRequest`.

  The primary use case of the interface is to allow modifying the generated URI based on the presence of headers such as `X-Forwarded-Host`. When operating behind a reverse proxy, the `Host` header is often rewritten to the name of the node to which the request is being forwarded, and an `X-Forwarded-Host` header is generated with the original `Host` value to allow the server to determine the original host the request was intended for. (We have always examined the `X-Forwarded-Proto` header; as of Diactoros 2.11.1, we also examine the `X-Forwarded-Port` header.) To accommodate this use case, we created Laminas\Diactoros\ServerRequestFilter\FilterUsingXForwardedHeaders.

  Due to potential security issues, it is generally best to only accept these headers if you trust the reverse proxy that has initiated the request.
  (This value is found in `$_SERVER['REMOTE_ADDR']`, which is present as `$request->getServerParams()['REMOTE_ADDR']` within PSR-7 implementations.) `FilterUsingXForwardedHeaders` provides named constructors to allow you to trust these headers from any source (which has been the default behavior of Diactoros since the beginning), or to specify specific IP addresses or CIDR subnets to trust, along with which headers are trusted.

  `Laminas\Diactoros\ServerRequestFactory::fromGlobals()` was updated to accept a `FilterServerRequestInterface` as an additional, optional argument. Since the `X-Forwarded-*` headers do have valid use cases, particularly in clustered environments using a load balancer, to prevent backwards compatibility breaks, if no filter is provided, we generate an instance via `FilterUsingXForwardedHeaders::trustReservedSubnets()`, which generates an instance marked to trust only proxies on private subnets.

  ### Workarounds

  Infrastructure or DevOps can configure web servers to reject `X-Forwarded-*` headers at the web server level.

  Users of laminas/laminas-diactoros can make use of the `Laminas\Diactoros\RequestFilter\RequestFilterInterface` functionality in order to either (a) disable usage of the `X-Forwarded-*` headers entirely, (b) opt-in to it, or (c) opt-in to the usage for configured proxy servers.

  ### References

  - [HTTP Host Header Attacks](https://portswigger.net/web-security/host-header)

  ### For more information

  If you have any questions or comments about this advisory:

  - Open an issue in [laminas/laminas-diactoros](https://github.com/laminas/laminas-diactoros/)
  - [Email us](mailto:security@getlaminas.org)
impacted_packages:
  - purl: pkg:composer/laminas/laminas-diactoros
    affected_versions: vers:composer/<2.11.1
    fixed_versions: vers:composer/2.11.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '6.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/07/GHSA-8274-h5jp-97vr/GHSA-8274-h5jp-97vr.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-79
references:
  - url: https://github.com/advisories/GHSA-8274-h5jp-97vr
    reference_type:
    reference_id:
  - url: https://github.com/FriendsOfPHP/security-advisories/blob/master/laminas/laminas-diactoros/CVE-2022-31109.yaml
    reference_type:
    reference_id:
  - url: https://github.com/laminas/laminas-diactoros
    reference_type:
    reference_id:
  - url: https://github.com/laminas/laminas-diactoros/commit/25b11d422c2e5dad868f68619888763b30f91e2d
    reference_type:
    reference_id:
  - url: https://github.com/laminas/laminas-diactoros/releases/tag/2.11.1
    reference_type:
    reference_id:
  - url: https://github.com/laminas/laminas-diactoros/security/advisories/GHSA-8274-h5jp-97vr
    reference_type:
    reference_id:
  - url: https://portswigger.net/web-security/host-header
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-31109
    reference_type:
    reference_id: CVE-2022-31109
