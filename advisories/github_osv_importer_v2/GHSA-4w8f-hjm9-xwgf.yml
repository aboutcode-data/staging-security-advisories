advisory_id: GHSA-4w8f-hjm9-xwgf
datasource_id: github_osv_importer_v2/GHSA-4w8f-hjm9-xwgf
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/06/GHSA-4w8f-hjm9-xwgf/GHSA-4w8f-hjm9-xwgf.json
aliases:
  - CVE-2022-24840
summary: |
  Path Traversal in django-s3file
  ### Impact

  It was possible to traverse the entire AWS S3 bucket and in most cases to access or delete files.
  The issue was discovered by the maintainer. There were no reports of the vulnerability
  being known to or exploited by a third party, before the release of the patch.

  If the `AWS_LOCATION` setting was set, traversal was limited to that location only.
  If all your files handling views (like form views) require authentication or special permission, the thread is limited to privileged users.

  ### Patches

  The vulnerability has been fixed in version 5.5.1 and above.

  ### Workarounds

  There is no feasible workaround. We must urge all users to immediately updated to a patched version.

  ### Detailed attack vector description

  An attacker may use a request with malicious form data to traverse the entire AWS S3 bucket and perform destructive operations.

  An attack could look as follows:
  ```bash
  curl -X POST -F "s3file=file" -F "file=/priviliged/location/secrets.txt" https://www.example.com/any/path/will/work/
  ```

  This will result in a request with files set and opened:

  ```python
  >>> request.FILES.getlist("file")
  [File("/priviliged/location/secrets.txt")]
  ```

  Since this behavior is injected via a middleware, any view can be called this way and will carry any files defined by the attacker.

  Via the `s3file` form field, any input name can be specified, including multiple inputs. For each input, multiple files can be freely
  picked of the S3 bucket.

  #### Scenarios and their practicality

  There are four scenarios that would be considered practical in most setups:

  1. Illegal file injection,
  2. file deletion,
  3. file retrieval & tree traversal.
  4. code injection & remote code execution.

  ##### File deletion

  An attacker knows the location of a privileged file, like a static asset. Next, the file is injected into a form view. The upload to function will move the file to a new location. This is effectively deleting the file, since the previous references to it are invalid, and will cause S3 to return a 404. Furthermore, the new location is unknown to the site operator.

  ##### File retrieval & tree traversal

  An attacker knows the URL of a secret file and injects it into a form view. The view will move the file to a public location, making it accessible to the attacker. Since most form views will not be rate limited, this could also be used to guess files and traverse the file tree.

  ##### Illegal file injection

  An attacker uses any form to upload a file to the temporary upload location. Next, the attacker injects that file into a request, does not validate the contents or is not equipped to handle the mime type. The latter could be used as a potential DOS vector.

  In practice, this is not a practical risk in most hardened setup. Files should always be sanitized before processing, since files can be included in a request even without this security issues.

  ### For more information
  If you have any questions or comments about this advisory:
  * Open an issue on [GitHub](https://github.com/codingjoe/django-s3file/issues)
  * Email us at [johannes@maron.family](mailto:johannes@maron.family)
impacted_packages:
  - purl: pkg:pypi/django-s3file
    affected_versions: vers:pypi/<5.5.1
    fixed_versions: vers:pypi/5.5.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '9.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/06/GHSA-4w8f-hjm9-xwgf/GHSA-4w8f-hjm9-xwgf.json
  - score: '9.3'
    scoring_system: cvssv4
    scoring_elements: CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:N/VC:H/VI:H/VA:N/SC:N/SI:N/SA:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/06/GHSA-4w8f-hjm9-xwgf/GHSA-4w8f-hjm9-xwgf.json
  - score: CRITICAL
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-96
  - CWE-22
references:
  - url: https://github.com/codingjoe/django-s3file
    reference_type:
    reference_id:
  - url: https://github.com/codingjoe/django-s3file/commit/68ccd2c621a40eb66fdd6af2be9d5fcc9c373318
    reference_type:
    reference_id:
  - url: https://github.com/codingjoe/django-s3file/releases/tag/5.5.1
    reference_type:
    reference_id:
  - url: https://github.com/codingjoe/django-s3file/security/advisories/GHSA-4w8f-hjm9-xwgf
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/django-s3file/PYSEC-2022-208.yaml
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-24840
    reference_type:
    reference_id: CVE-2022-24840
