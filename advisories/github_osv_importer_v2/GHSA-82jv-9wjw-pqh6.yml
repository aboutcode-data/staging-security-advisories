advisory_id: GHSA-82jv-9wjw-pqh6
datasource_id: github_osv_importer_v2/GHSA-82jv-9wjw-pqh6
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/04/GHSA-82jv-9wjw-pqh6/GHSA-82jv-9wjw-pqh6.json
aliases: []
summary: |
  Prototype pollution in emit function
  ### Summary
  A prototype pollution in derby can crash the application, if the application author has atypical HTML templates that feed user input into an object key.

  Attribute keys are almost always developer-controlled, not end-user-controlled, so this shouldn't be an issue in practice for most applications.

  ### Details
  ```
  emit(context: Context, target: T) {
    const node = traverseAndCreate(context.controller, this.segments);
      node[this.lastSegment] = target;
      this.addListeners(target, node, this.lastSegment);
  }
  ```
  The emit() function in src/templates/templates.ts is called without sanitizing the variable `this.lastSegment `. The variable `this.lastSegment ` can be set to `__proto__`, and this will pollute the prototype of Javascipt Object (`node['__proto__'] = target`).

  ### PoC
  To reproduce this vulnerability, you can adjust the test case `ignores DOM mutations in components\' create()` in `test/dom/ComponentHarness.mocha.js`.

  ```
  it('ignores DOM mutations in components\' create()', function() {
        function Box() {}
        Box.view = {
          is: 'box',
  -        source: '<index:><div class="box" as="boxElement"></div>'
  +        source: '<index:><div class="box" as="__proto__"></div>'
        };
        Box.prototype.create = function() {
          this.boxElement.className = 'box-changed-in-create';
        };
        var harness = runner.createHarness('<view is="box" />', Box);
        expect(harness).to.render('<div class="box"></div>');
  });
  ```
  When `as` attribute is controlled by attackers, the variable in `this.lastSegment` will exactly take value` __proto__` and prototype pollution happens.

  ### Patch
  Add a check on `this.lastSegment` can prevent this attack.
  ```
  emit(context: Context, target: T) {
    const node = traverseAndCreate(context.controller, this.segments);
  +  if (this.lastSegment.includes('__proto__') || this.lastSegment.includes('prototype')) {
  +    throw new Error('Unsafe code detected');
  +  }
      node[this.lastSegment] = target;
      this.addListeners(target, node, this.lastSegment);
  }
  ```
impacted_packages:
  - purl: pkg:npm/derby
    affected_versions: vers:npm/<=2.3.1
    fixed_versions: vers:npm/2.3.2
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/derby
    affected_versions: vers:npm/<=3.0.1
    fixed_versions: vers:npm/3.0.2
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/derby
    affected_versions: vers:npm/<=4.0.0-beta.10
    fixed_versions: vers:npm/4.0.0-beta.11
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: LOW
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-1321
references:
  - url: https://github.com/derbyjs/derby
    reference_type:
    reference_id:
  - url: https://github.com/derbyjs/derby/commit/24524e96f36976883c7c619811320428536bd4d0
    reference_type:
    reference_id:
  - url: https://github.com/derbyjs/derby/commit/465a0c2f6a77361eda4a09b77a8c94ba6a9da440
    reference_type:
    reference_id:
  - url: https://github.com/derbyjs/derby/security/advisories/GHSA-82jv-9wjw-pqh6
    reference_type:
    reference_id:
