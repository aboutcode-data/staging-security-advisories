advisory_id: GHSA-2h87-4q2w-v4hf
datasource_id: github_osv_importer_v2/GHSA-2h87-4q2w-v4hf
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/04/GHSA-2h87-4q2w-v4hf/GHSA-2h87-4q2w-v4hf.json
aliases:
  - CVE-2023-22621
summary: |
  Strapi plugins vulnerable to Server-Side Template Injection and Remote Code Execution in the Users-Permissions Plugin
  ### Summary

  Strapi through 4.5.5 allows authenticated Server-Side Template Injection (SSTI) that can be exploited to execute arbitrary code on the server.

  ### Details

  Strapi through 4.5.5 allows authenticated Server-Side Template Injection (SSTI) that can be exploited to execute arbitrary code on the server. A remote attacker with access to the Strapi admin panel can inject a crafted payload that executes code on the server into an email template that bypasses the validation checks that should prevent code execution.

  ### IoC

  Using just the request log files, the only IoC to search for is a `PUT` request to URL path `/users-permissions/email-templates`. This IoC only indicates that a Strapi email template was modified on your server and by itself does not indicate if your Strapi server has been compromised. If this IoC is detected, you will need to manually review your email templates on your Strapi server and backups of your database to see if any of the templates contain a `lodash` template delimiter (eg. `<%STUFF HERE%>`) that contains suspicious JavaScript code. Generally speaking these templates should look like the following, you may have minor adjustments but any unrecognized code should be considered suspicious.

  Reset Password Template:

  ```html
  <p>We heard that you lost your password. Sorry about that!</p>

  <p>But donâ€™t worry! You can use the following link to reset your password:</p>
  <p><%= URL %>?code=<%= TOKEN %></p>

  <p>Thanks.</p>
  ```

  Email Confirmation Template:

  ```html
  <p>Thank you for registering!</p>

  <p>You have to confirm your email address. Please click on the link below.</p>

  <p><%= URL %>?confirmation=<%= CODE %></p>

  <p>Thanks.</p>
  ```

  Specifically you should look for odd code contained within the `<%STUFF HERE%>` blocks as this is what is used to bypass the lodash templating system. If you find any code that is not a variable name, or a variable name that is not defined in the template you are most likely impacted and should take immediate steps to confirm there are no malicious applications running on your servers.

  ### Impact

  All users on Strapi below 4.5.6 with access to the admin panel and the ability to modify the email templates
impacted_packages:
  - purl: pkg:npm/%40strapi/plugin-users-permissions
    affected_versions: vers:npm/<4.5.6
    fixed_versions: vers:npm/4.5.6
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40strapi/plugin-email
    affected_versions: vers:npm/<4.5.6
    fixed_versions: vers:npm/4.5.6
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '10.0'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/04/GHSA-2h87-4q2w-v4hf/GHSA-2h87-4q2w-v4hf.json
  - score: CRITICAL
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-74
references:
  - url: https://github.com/strapi/strapi
    reference_type:
    reference_id:
  - url: https://github.com/strapi/strapi/commit/921d30961d6ba96cc098f2aea197350a49f990bd
    reference_type:
    reference_id:
  - url: https://github.com/strapi/strapi/pull/15385
    reference_type:
    reference_id:
  - url: https://github.com/strapi/strapi/releases
    reference_type:
    reference_id:
  - url: https://github.com/strapi/strapi/releases/tag/v4.5.6
    reference_type:
    reference_id:
  - url: https://github.com/strapi/strapi/security/advisories/GHSA-2h87-4q2w-v4hf
    reference_type:
    reference_id:
  - url: https://strapi.io/blog/security-disclosure-of-vulnerabilities-cve
    reference_type:
    reference_id:
  - url: https://www.ghostccamm.com/blog/multi_strapi_vulns
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-22621
    reference_type:
    reference_id: CVE-2023-22621
