advisory_id: GHSA-qq89-hq3f-393p
datasource_id: github_osv_importer_v2/GHSA-qq89-hq3f-393p
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2021/08/GHSA-qq89-hq3f-393p/GHSA-qq89-hq3f-393p.json
aliases:
  - CVE-2021-37712
summary: |
  Arbitrary File Creation/Overwrite via insufficient symlink protection due to directory cache poisoning using symbolic links
  ### Impact
  Arbitrary File Creation, Arbitrary File Overwrite, Arbitrary Code Execution

  node-tar aims to guarantee that any file whose location would be modified by a symbolic link is not extracted. This is, in part, achieved by ensuring that extracted directories are not symlinks. Additionally, in order to prevent unnecessary stat calls to determine whether a given path is a directory, paths are cached when directories are created.

  This logic was insufficient when extracting tar files that contained two directories and a symlink with names containing unicode values that normalized to the same value. Additionally, on Windows systems, long path portions would resolve to the same file system entities as their 8.3 "short path" counterparts. A specially crafted tar archive could thus include directories with two forms of the path that resolve to the same file system entity, followed by a symbolic link with a name in the first form, lastly followed by a file using the second form. It led to bypassing node-tar symlink checks on directories, essentially allowing an untrusted tar file to symlink into an arbitrary location and subsequently extracting arbitrary files into that location, thus allowing arbitrary file creation and overwrite.

  The v3 branch of `node-tar` has been deprecated and did not receive patches for these issues. If you are still using a v3 release we recommend you update to a more recent version of `node-tar`. If this is not possible, a workaround is available below.

  ### Patches

  6.1.9 || 5.0.10 || 4.4.18

  ### Workarounds

  Users may work around this vulnerability without upgrading by creating a custom filter method which prevents the extraction of symbolic links.

  ```js
  const tar = require('tar')

  tar.x({
    file: 'archive.tgz',
    filter: (file, entry) => {
      if (entry.type === 'SymbolicLink') {
        return false
      } else {
        return true
      }
    }
  })
  ```

  Users are encouraged to upgrade to the latest patched versions, rather than attempt to sanitize tar input themselves.

  #### Fix

  The problem is addressed in the following ways, when comparing paths in the directory cache and path reservation systems:

  1. The `String.normalize('NFKD')` method is used to first normalize all unicode to its maximally compatible and multi-code-point form.
  2. All slashes are normalized to `/` on Windows systems (on posix systems, `\` is a valid filename character, and thus left intact).
  3. When a symbolic link is encountered on Windows systems, the entire directory cache is cleared.  Collisions related to use of 8.3 short names to replace directories with other (non-symlink) types of entries may make archives fail to extract properly, but will not result in arbitrary file writes.
impacted_packages:
  - purl: pkg:npm/tar
    affected_versions: vers:npm/>=3.0.0|<4.4.18
    fixed_versions: vers:npm/4.4.18
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/tar
    affected_versions: vers:npm/>=5.0.0|<5.0.10
    fixed_versions: vers:npm/5.0.10
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/tar
    affected_versions: vers:npm/>=6.0.0|<6.1.9
    fixed_versions: vers:npm/6.1.9
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '8.2'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:C/C:H/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2021/08/GHSA-qq89-hq3f-393p/GHSA-qq89-hq3f-393p.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-59
  - CWE-22
references:
  - url: https://cert-portal.siemens.com/productcert/pdf/ssa-389290.pdf
    reference_type:
    reference_id:
  - url: https://github.com/isaacs/node-tar/commit/1739408d3122af897caefd09662bce2ea477533b
    reference_type:
    reference_id:
  - url: https://github.com/isaacs/node-tar/commit/2f1bca027286c23e110b8dfc7efc10756fa3db5a
    reference_type:
    reference_id:
  - url: https://github.com/isaacs/node-tar/commit/3aaf19b2501bbddb145d92b3322c80dcaed3c35f
    reference_type:
    reference_id:
  - url: https://github.com/isaacs/node-tar/commit/b6162c7fafe797f856564ef37f4b82747f051455
    reference_type:
    reference_id:
  - url: https://github.com/isaacs/node-tar/commit/bb93ba243746f705092905da1955ac3b0509ba1e
    reference_type:
    reference_id:
  - url: https://github.com/isaacs/node-tar/commit/d56f790bda9fea807dd80c5083f24771dbdd6eb1
    reference_type:
    reference_id:
  - url: https://github.com/npm/node-tar
    reference_type:
    reference_id:
  - url: https://github.com/npm/node-tar/security/advisories/GHSA-qq89-hq3f-393p
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2022/12/msg00023.html
    reference_type:
    reference_id:
  - url: https://www.debian.org/security/2021/dsa-5008
    reference_type:
    reference_id:
  - url: https://www.npmjs.com/package/tar
    reference_type:
    reference_id:
  - url: https://www.oracle.com/security-alerts/cpuoct2021.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-37712
    reference_type:
    reference_id: CVE-2021-37712
