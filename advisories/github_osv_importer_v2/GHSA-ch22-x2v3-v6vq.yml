advisory_id: GHSA-ch22-x2v3-v6vq
datasource_id: github_osv_importer_v2/GHSA-ch22-x2v3-v6vq
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/01/GHSA-ch22-x2v3-v6vq/GHSA-ch22-x2v3-v6vq.json
aliases:
  - CVE-2022-21690
summary: |
  OTF-001: Improper Input Sanitation: The path parameter of the requested URL is not sanitized before being passed to the QT frontend
  Between September 26, 2021 and October 8, 2021, [Radically Open Security](https://www.radicallyopensecurity.com/) conducted a penetration test of OnionShare 2.4, funded by the Open Technology Fund's [Red Team lab](https://www.opentech.fund/labs/red-team-lab/). This is an issue from that penetration test.

  - Vulnerability ID: OTF-001
  - Vulnerability type: Improper Input Sanitization
  - Threat level: Elevated

  ## Description:

  The `path` parameter of the requested URL is not sanitized before being passed to the QT frontend.

  ## Technical description:

  The `path` parameter is not sanitized before being passed to the constructor of the `QLabel`.

  https://github.com/onionshare/onionshare/blob/d08d5f0f32f755f504494d80794886f346fbafdb/desktop/src/onionshare/tab/mode/__init__.py#L499-L509

  https://github.com/onionshare/onionshare/blob/d08d5f0f32f755f504494d80794886f346fbafdb/desktop/src/onionshare/tab/mode/history.py#L456-L483

  https://doc.qt.io/qt-5/qlabel.html#details

  > Warning: When passing a QString to the constructor or calling setText(), make sure to sanitize your input, as QLabel tries to guess whether it displays the text as plain text or as rich text, a subset of HTML 4 markup. You may want to call setTextFormat() explicitly, e.g. in case you expect the text to be in plain format but cannot control the text source (for instance when displaying data loaded from the Web).

  This path is used in all components for displaying the server access history. This leads to a rendered HTML4 Subset (QT RichText editor) in the Onionshare frontend.

  In the following example an adversary injects a crafted image file into an Onionshare instance with receive mode and renders it in the history component of the Onionshare application.

  The only requirement is another visit to the shared site with the following parameter attached to the path of the URL:

  ```
  <img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAAFElEQVQY02Nk+M+ABzAxMIxKYwIAQC0BEwZFOw4AAAAASUVORK5CYII=' />
  ```

  This will be rendered as a green square in the history tab where the path value is supposed to be (the value itself is shown at the bottom of the page).

  ![otf-001](https://user-images.githubusercontent.com/156128/140665358-ab9e5990-3e13-4e50-85fd-b8a6e323d299.png)

  Possible scenarios where this could lead to remote code execution would be a 0-day in libpng or other internal image rendering (OTF-014 (page 12)) of the QT framework.

  The QT documentation indicates that external files could be rendered, but we were unable to find a QT code path allowing for it.

  ## Impact:

  An adversary with knowledge of the Onion service address in public mode or with authentication in private mode can render arbitrary HTML (QT-HTML4 Subset) in the server desktop application. This requires the desktop application with rendered history, therefore the impact is only elevated.

  ## Recommendation:

  - Manually define the text format of the QLabel via `setTextFormat()`
impacted_packages:
  - purl: pkg:pypi/onionshare-cli
    affected_versions: vers:pypi/<2.5
    fixed_versions: vers:pypi/2.5
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '8.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:R/S:C/C:H/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/01/GHSA-ch22-x2v3-v6vq/GHSA-ch22-x2v3-v6vq.json
  - score: '6.3'
    scoring_system: cvssv4
    scoring_elements: CVSS:4.0/AV:N/AC:L/AT:N/PR:L/UI:P/VC:N/VI:N/VA:N/SC:H/SI:H/SA:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/01/GHSA-ch22-x2v3-v6vq/GHSA-ch22-x2v3-v6vq.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-79
references:
  - url: https://github.com/onionshare/onionshare
    reference_type:
    reference_id:
  - url: https://github.com/onionshare/onionshare/releases/tag/v2.5
    reference_type:
    reference_id:
  - url: https://github.com/onionshare/onionshare/security/advisories/GHSA-ch22-x2v3-v6vq
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/onionshare-cli/PYSEC-2022-41.yaml
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-21690
    reference_type:
    reference_id: CVE-2022-21690
