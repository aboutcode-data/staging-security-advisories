advisory_id: GHSA-v64w-49xw-qq89
datasource_id: github_osv_importer_v2/GHSA-v64w-49xw-qq89
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/11/GHSA-v64w-49xw-qq89/GHSA-v64w-49xw-qq89.json
aliases:
  - CVE-2023-48309
summary: |
  Possible user mocking that bypasses basic authentication
  ### Impact

  `next-auth` applications prior to version **4.24.5** that rely on the default [Middleware authorization](https://next-auth.js.org/configuration/nextjs#middleware) are affected.

  A bad actor could create an empty/mock user, by getting hold of a NextAuth.js-issued JWT from an interrupted OAuth sign-in flow (state, PKCE or nonce).

  Manually overriding the `next-auth.session-token` cookie value with this non-related JWT would let the user simulate a logged in user, albeit having no user information associated with it. (The only property on this user is an opaque randomly generated string).

  This vulnerability does **not** give access to other users' data, neither to resources that require proper authorization via scopes or other means. The created mock user has no information associated with it (ie. no name, email, access_token, etc.)

  This vulnerability can be exploited by bad actors to peek at logged in user states (e.g. dashboard layout).

  _Note: Regardless of the vulnerability, the existence of a NextAuth.js session state can provide simple authentication, but not authorization in your applications. For role-based access control, you can check out [our guide](https://authjs.dev/guides/basics/role-based-access-control)._

  ### Patches

  We patched the vulnerability in `next-auth` `v4.24.5`. To upgrade, run one of the following:

  ```
  npm i next-auth@latest
  ```
  ```
  yarn add next-auth@latest
  ```
  ```
  pnpm add next-auth@latest
  ```

  ### Workarounds

  Upgrading to `latest` is the recommended way to fix this issue. However, using [a custom authorization callback for Middleware](https://next-auth.js.org/configuration/nextjs#advanced-usage), developers can manually do a basic authentication:

  ```ts
  // middleware.ts
  import { withAuth } from "next-auth/middleware"

  export default withAuth(/*your middleware function*/, {
    // checking the existence of any property - besides `value` which might be a random string - on the `token` object is sufficient to prevent this vulnerability
    callbacks: { authorized: ({ token }) => !!token?.email }
  })
  ```

  ### References

  - [NextAuth.js Middleware](https://next-auth.js.org/configuration/nextjs#middleware)
  - [Role-based access contorl (RBAC) guide](https://authjs.dev/guides/basics/role-based-access-control)
impacted_packages:
  - purl: pkg:npm/next-auth
    affected_versions: vers:npm/<4.24.5
    fixed_versions: vers:npm/4.24.5
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/11/GHSA-v64w-49xw-qq89/GHSA-v64w-49xw-qq89.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-285
references:
  - url: https://authjs.dev/guides/basics/role-based-access-control
    reference_type:
    reference_id:
  - url: https://github.com/nextauthjs/next-auth
    reference_type:
    reference_id:
  - url: https://github.com/nextauthjs/next-auth/commit/d237059b6d0cb868c041ba18b698e0cee20a2f10
    reference_type:
    reference_id:
  - url: https://github.com/nextauthjs/next-auth/security/advisories/GHSA-v64w-49xw-qq89
    reference_type:
    reference_id:
  - url: https://next-auth.js.org/configuration/nextjs#advanced-usage
    reference_type:
    reference_id:
  - url: https://next-auth.js.org/configuration/nextjs#middlewar
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-48309
    reference_type:
    reference_id: CVE-2023-48309
