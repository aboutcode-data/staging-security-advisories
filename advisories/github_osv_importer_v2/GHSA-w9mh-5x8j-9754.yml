advisory_id: GHSA-w9mh-5x8j-9754
datasource_id: github_osv_importer_v2/GHSA-w9mh-5x8j-9754
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/07/GHSA-w9mh-5x8j-9754/GHSA-w9mh-5x8j-9754.json
aliases:
  - CVE-2024-39691
summary: |
  Malicious Matrix homeserver can leak truncated message content of messages it shouldn't have access to
  ### Impact

  The fix for GHSA-wm4w-7h2q-3pf7 / [CVE-2024-32000](https://www.cve.org/CVERecord?id=CVE-2024-32000) included in matrix-appservice-irc 2.0.0 relied on the Matrix homeserver-provided timestamp to determine whether a user has access to the event they're replying to when determining whether or not to include a truncated version of the original event in the IRC message. Since this value is controlled by external entities, a malicious Matrix homeserver joined to a room in which a matrix-appservice-irc bridge instance (before version 2.0.1) is present can fabricate the timestamp with the intent of tricking the bridge into leaking room messages the homeserver should not have access to.

  ### Patches

  matrix-appservice-irc 2.0.1 [drops the reliance](https://github.com/matrix-org/matrix-appservice-irc/pull/1804) on `origin_server_ts` when determining whether or not an event should be visible to a user, instead tracking the event timestamps internally.

  ### Workarounds

  It's possible to limit the amount of information leaked by setting a reply template that doesn't contain the original message. See [these lines](https://github.com/matrix-org/matrix-appservice-irc/blob/d5d67d1d3ea3f0f6962a0af2cc57b56af3ad2129/config.sample.yaml#L601-L604) in the configuration file.

  ### References

  - Patch: https://github.com/matrix-org/matrix-appservice-irc/pull/1804

  ### For more information

  If you have any questions or comments about this advisory, please email us at [security at matrix.org](mailto:security@matrix.org).
impacted_packages:
  - purl: pkg:npm/matrix-appservice-irc
    affected_versions: vers:npm/<=2.0.0
    fixed_versions: vers:npm/2.0.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '4.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/07/GHSA-w9mh-5x8j-9754/GHSA-w9mh-5x8j-9754.json
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-280
  - CWE-755
references:
  - url: https://github.com/matrix-org/matrix-appservice-irc
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-appservice-irc/blob/d5d67d1d3ea3f0f6962a0af2cc57b56af3ad2129/config.sample.yaml#L601-L604
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-appservice-irc/commit/1835e047f269001054be4c68867797aa12372a0f
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-appservice-irc/pull/1804
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-appservice-irc/security/advisories/GHSA-w9mh-5x8j-9754
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-39691
    reference_type:
    reference_id: CVE-2024-39691
