advisory_id: GHSA-m4hf-6vgr-75r2
datasource_id: github_osv_importer_v2/GHSA-m4hf-6vgr-75r2
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/09/GHSA-m4hf-6vgr-75r2/GHSA-m4hf-6vgr-75r2.json
aliases:
  - CVE-2023-32187
summary: |
  K3s apiserver port is vulnerable to unauthenticated remote denial-of-service (DoS) attack via TLS SAN stuffing attack
  ### Impact

  An issue was found in K3s where an attacker with network access to K3s servers' apiserver/supervisor port (TCP 6443) can force the TLS server to add entries to the certificate's Subject Alternative Name (SAN) list, through a stuffing attack, until the certificate grows so large that it exceeds the maximum size allowed by TLS client implementations. OpenSSL for example will raise an `excessive message size` error when this occurs. No authentication is necessary to perform this attack, only the ability to perform a TLS handshake against the apiserver/supervisor port (TCP 6443).

  Affected servers will continue to operate, but clients (including both external administrative access with `kubectl` and server or agent nodes) will fail to establish new connections, thus leading to a denial of service (DoS) attack.

  ### Remediation

  Upgrade to a fixed release:

  - v1.28.1+k3s1
  - v1.27.5+k3s1
  - v1.26.8+k3s1
  - v1.25.13+k3s1
  - v1.24.17+k3s1

  If you are using K3s 1.27 or earlier, you must also add  the parameter `tls-san-security: true` to the K3s configuration to enable enhanced security for the supervisor's TLS SAN list. This option defaults to `true` starting with K3s 1.28.

  Note that this flag changes the behavior of K3s servers. You should ensure that you configure `node-external-ip` on servers that will be connected to via an external IP, and add `tls-san` entries for any load-balancers or VIP addresses that will be associated with the supervisor port. External IPs and load-balancer/VIP addresses will no longer be added to the supervisor certificate's SAN list unless explicitly configured.

  ### Mitigation

  If you cannot upgrade to a fixed release, the certificate can be "frozen" by running the following command against the cluster:

  ```shell
  kubectl annotate secret -n kube-system k3s-serving listener.cattle.io/static=true
  ```

  **⚠️ IMPORTANT CAUTION:** Note that this mitigation will prevent the certificate from adding new SAN entries when servers join the cluster, and automatically renewing itself when it is about to expire. If you do this, you should delete the annotation when adding new servers to the cluster, or when the certificate is within 90 days of expiring, so that it can be updated. Once that is done, you can freeze it again.

  Affected certificates can be reset by performing the following steps:
  1. Run `kubectl --server https://localhost:6444 delete secret -n kube-system k3s-serving`
  2. Delete `/var/lib/rancher/k3s/server/tls/dynamic-cert.json` from all servers, and restart the `k3s` service.

  ### Background

  The K3s apiserver/supervisor listener on port TCP 6443 and uses the `rancher/dynamiclistener` library to dynamically generate TLS certificates that contain TLS Subject Alternative Names (SAN) for any host name or IP address requested by a client. This is done to allow servers and external load-balancers to be added to the cluster without the administrator having to explicitly know and configure in advance a fixed list of endpoints that the supervisor may be hosted at.

  The library allows the embedding application to configure a callback that is used to filter addresses requested by clients; but this was not previously implemented in K3s.

  ### For more information

  If you have any questions or comments about this advisory:

  - Reach out to the [K3s Security team](https://github.com/k3s-io/k3s/security/policy) for security related inquiries.
  - Open an issue in the [K3s](https://github.com/k3s-io/k3s/issues/new/choose) repository.
  - Verify with our [support matrix](https://www.suse.com/suse-k3s/support-matrix/all-supported-versions) and [product support lifecycle](https://www.suse.com/lifecycle/#k3s).
impacted_packages: []
severities:
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/09/GHSA-m4hf-6vgr-75r2/GHSA-m4hf-6vgr-75r2.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-770
references:
  - url: https://bugzilla.suse.com/show_bug.cgi?id=CVE-2023-32187https:/
    reference_type:
    reference_id:
  - url: https://github.com/k3s-io/k3s
    reference_type:
    reference_id:
  - url: https://github.com/k3s-io/k3s/security/advisories/GHSA-m4hf-6vgr-75r2
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-32187
    reference_type:
    reference_id: CVE-2023-32187
