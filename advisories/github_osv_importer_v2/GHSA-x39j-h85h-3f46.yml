advisory_id: GHSA-x39j-h85h-3f46
datasource_id: github_osv_importer_v2/GHSA-x39j-h85h-3f46
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/12/GHSA-x39j-h85h-3f46/GHSA-x39j-h85h-3f46.json
aliases:
  - CVE-2022-23495
summary: |
  go-merkledag's ProtoNode may be modified such that common method calls may panic
  ### Impact

  A `ProtoNode` may be modified in such a way as to cause various encode errors which will trigger a panic on common method calls that don't allow for error returns.

  A `ProtoNode` should only be able to encode to valid DAG-PB, attempting to encode invalid DAG-PB forms will result in an error from the codec. Manipulation of an existing (newly created or decoded) `ProtoNode` using the modifier methods did not account for certain states that would place the `ProtoNode` into an unencodeable form.

  Due to conformance with the [`github.com/ipfs/go-block-format#Block`](https://pkg.go.dev/github.com/ipfs/go-block-format#Block) and [`github.com/ipfs/go-ipld-format#Node`](https://pkg.go.dev/github.com/ipfs/go-ipld-format#Node) interfaces, certain methods, which internally require a re-encode if state has changed, will panic due to the inability to return an error.

  Additionally, use of the `ProtoNode#SetCidBuilder()` method to set a non-functioning `CidBuilder` (such as one that refers to a multihash where an implementation of that hash function is not available) may cause the same methods to panic as a new CID is required but cannot be created.

  ### Patches

  Releases involving fixes for this issue are [v0.8.0](https://github.com/ipfs/go-merkledag/releases/tag/v0.8.0) and [v0.8.1](https://github.com/ipfs/go-merkledag/releases/tag/v0.8.1). The recommended minimum version is **v0.8.1**.

  * Additional checks are performed on `ProtoNode` state changes to avoid the possibility of creating unencodeable forms, errors are returned where this is the case.
  * The builder passed in to `SetCidBuilder()` is inspected to attempt to determine if it is usable to generate CIDs, otherwise an error is returned.
  * The panics have been removed and replaced with default values (empty byte slice for `RawData()` and a default zero-bytes DAG-PB CID for methods involving CIDs).

  ### Workarounds

  These workarounds are available when using impacted versions to avoid panic conditions, and may be generally appropriate in order to provide meaningful feedback to users and avoid generating bad, or unexpected encoded data:

  * Sanitise inputs when allowing user-input to set a new `CidBuilder` on a `ProtoNode`.
  * Sanitise `Tsize` (`Link#Size`) values such that they are a reasonable byte-size for sub-DAGs where derived from user-input.

  ### References

  * https://github.com/ipfs/kubo/issues/9297
  * https://github.com/ipfs/go-merkledag/issues/90
  * https://github.com/ipfs/go-merkledag/releases/tag/v0.8.0
  * https://github.com/ipfs/go-merkledag/pull/91
  * https://github.com/ipfs/go-merkledag/pull/92
  * https://github.com/ipfs/go-merkledag/pull/93
  * https://github.com/ipfs/go-merkledag/releases/tag/v0.8.1


  ### Credit

  Thanks to [@mrd0ll4r](https://github.com/mrd0ll4r) for reporting the original error to Kubo!
impacted_packages: []
severities:
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/12/GHSA-x39j-h85h-3f46/GHSA-x39j-h85h-3f46.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-755
  - CWE-252
references:
  - url: https://en.wikipedia.org/wiki/Directed_acyclic_graph
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/issues/90
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/pull/91
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/pull/92
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/pull/93
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/releases/tag/v0.8.0
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/releases/tag/v0.8.1
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/go-merkledag/security/advisories/GHSA-x39j-h85h-3f46
    reference_type:
    reference_id:
  - url: https://github.com/ipfs/kubo/issues/9297
    reference_type:
    reference_id:
  - url: https://pkg.go.dev/vuln/GO-2022-1155
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-23495
    reference_type:
    reference_id: CVE-2022-23495
