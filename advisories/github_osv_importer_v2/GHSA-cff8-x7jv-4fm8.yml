advisory_id: GHSA-cff8-x7jv-4fm8
datasource_id: github_osv_importer_v2/GHSA-cff8-x7jv-4fm8
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/09/GHSA-cff8-x7jv-4fm8/GHSA-cff8-x7jv-4fm8.json
aliases:
  - CVE-2024-45596
summary: "Session is cached for OpenID and OAuth2 if `redirect` is not used\n### Summary\nUnauthenticated\
  \ user can access credentials of last authenticated user via OpenID or OAuth2 where the authentication\
  \ URL did not include `redirect` query string.\n\nFor example:\n- Project is configured with\
  \ OpenID or OAuth2\n- Project is configured with cache enabled\n- User tries to login via\
  \ SSO link, but without `redirect` query string\n- After successful login, credentials are\
  \ cached\n- If an unauthenticated user tries to login via SSO link, it will return the credentials\
  \ of the other last user\n\nThe SSO link is something like `https://directus.example.com/auth/login/openid/callback`,\
  \ where `openid` is the name of the OpenID provider configured in Directus\n\n### Details\n\
  This happens because on that endpoint for both OpenId and Oauth2 Directus is using the `respond`\
  \ middleware, which by default will try to cache GET requests that met some conditions. Although,\
  \ those conditions do not include this scenario, when an unauthenticated request returns user\
  \ credentials.\nFor OpenID, this can be seen here:\nhttps://github.com/directus/directus/blob/main/api/src/auth/drivers/openid.ts#L453-L459\n\
  And for OAuth2 can be seen here\nhttps://github.com/directus/directus/blob/main/api/src/auth/drivers/oauth2.ts#L422-L428\n\
  \n### PoC\n- Create a new Directus project\n- Set `CACHE_ENABLED` to true\n- Set `CACHE_STORE`\
  \ to `redis` for reliable results (if using memory with multiple nodes, it may only happen\
  \ sometimes, due to cache being different for different nodes)\n- Configure `REDIS` with redis\
  \ string or redis host, port, user, etc.\n- Set `AUTH_PROVIDERS` to `openid`\n- Set `PUBLIC_URL`\
  \ to the the main URL of your project . \tFor example, `PUBLIC_URL: http://localhost:8055`\n\
  - Configure `AUTH_OPENID_CLIENT_ID`, `AUTH_OPENID_CLIENT_SECRET`, `AUTH_OPENID_ISSUER_URL`\
  \ with proper OpenID configurations\n- Be sure that on OpenID external app you have configured\
  \ Redirect URI to `http://localhost:8055/auth/login/openid/callback`\n- Run Directus\n- Open\
  \ the SSO link like `http://localhost:8055/auth/login/openid/callback`\n- Do the authentication\
  \ on the OpenID external webpage\n- Verify that it you got redirected to a page with a JSON\
  \ including `access_token` property\n- Be sure all anonymous mode windows are closed\n- Open\
  \ an anonymous window and go to the SSO Link `http://localhost:8055/auth/login/openid/callback`\
  \ and see you have the same credentials, even though you don't have any session because you\
  \ are in anonymous mode\n\n### Impact\nAll projects using OpenID or OAuth 2, that does not\
  \ include `redirect` query string on loggin in users."
impacted_packages:
  - purl: pkg:npm/directus
    affected_versions: vers:npm/<10.13.3
    fixed_versions: vers:npm/10.13.3
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/directus
    affected_versions: vers:npm/>=11.0.0-rc.1|<11.1.0
    fixed_versions: vers:npm/11.1.0
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40directus/api
    affected_versions: vers:npm/<21.0.1
    fixed_versions: vers:npm/21.0.1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40directus/api
    affected_versions: vers:npm/>=22.0.0|<22.2.0
    fixed_versions: vers:npm/22.2.0
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.4'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:H/I:N/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/09/GHSA-cff8-x7jv-4fm8/GHSA-cff8-x7jv-4fm8.json
  - score: '8.3'
    scoring_system: cvssv4
    scoring_elements: CVSS:4.0/AV:N/AC:L/AT:N/PR:N/UI:P/VC:H/VI:N/VA:N/SC:H/SI:N/SA:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2024/09/GHSA-cff8-x7jv-4fm8/GHSA-cff8-x7jv-4fm8.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-524
  - CWE-384
references:
  - url: https://github.com/directus/directus
    reference_type:
    reference_id:
  - url: https://github.com/directus/directus/blob/main/api/src/auth/drivers/oauth2.ts#L422-L428
    reference_type:
    reference_id:
  - url: https://github.com/directus/directus/blob/main/api/src/auth/drivers/openid.ts#L453-L459
    reference_type:
    reference_id:
  - url: https://github.com/directus/directus/commit/4aace0bbe57232e38cd6a287ee475293e46dc91b
    reference_type:
    reference_id:
  - url: https://github.com/directus/directus/commit/769fa22797bff5a9231599883b391e013f122e52
    reference_type:
    reference_id:
  - url: https://github.com/directus/directus/security/advisories/GHSA-cff8-x7jv-4fm8
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-45596
    reference_type:
    reference_id: CVE-2024-45596
