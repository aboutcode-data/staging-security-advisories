advisory_id: GHSA-5r98-f33j-g8h7
datasource_id: github_osv_importer_v2/GHSA-5r98-f33j-g8h7
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/08/GHSA-5r98-f33j-g8h7/GHSA-5r98-f33j-g8h7.json
aliases:
  - CVE-2023-37478
summary: |
  pnpm incorrectly parses tar archives relative to specification
  ### Summary
  It is possible to construct a tarball that, when installed via npm or parsed by the registry is safe, but when installed via pnpm is malicious, due to how pnpm parses tar archives.

  ### Details
  The TAR format is an append-only archive format, and as such, the specification for how to update a file is to add a new record to the end with the updated version of the file. This means that it is completely valid for an archive to contain multiple copies of, say, `package.json`, and the expected behavior when extracting is that all versions other than the last get ignored.

  This is further complicated by that during tarball extraction, all package managers are configured to drop the first path component, so collisions can be created simply by using multiple root folders in the archive, even without performing updates.

  When pnpm extracts a tar archive via tar-stream, it appears to extract only the _first_ file of a given name and discards all subsequent files with the same name.

  ### PoC
  Create a root folder with the following layout:
  - `a/package.json`
  - `package/package.json`
  - `z/package.json`

  File contents:
  #### a/package.json
  ```json
  {
      "name": "test-package",
      "version": "0.1.0",
      "description": "This is a bad version of a test package",
      "dependencies": {
          "react": "^15"
      }
  }
  ```
  #### package/package.json
  ```json
  {
      "name": "test-package",
      "version": "0.1.0",
      "description": "This is a bad version of a test package",
      "dependencies": {
          "react": "^16"
      }
  }
  ```
  #### z/package.json
  ```json
  {
      "name": "test-package",
      "version": "0.1.0",
      "description": "This is the good version of a test package",
      "dependencies": {
          "react": "^17"
      }
  }
  ```

  Then use the tar binary to produce a tarball (working directory is the root folder):
  `tar -c -z --format ustar -f package.tgz a package z`
  The order of the folders at the end matters; whichever one is last will end up being the package.json that wins when extracted by npm; the one that is first will be the one that wins when extracted by pnpm.

  Install the tarball via the `file:` protocol.

  Observe that with npm, the lockfile has `react@17`, while with pnpm it has `react@15`.

  ### Impact
  This can result in a package that appears safe on the npm registry or when installed via npm being replaced with a compromised or malicious version when installed via pnpm.
impacted_packages:
  - purl: pkg:npm/pnpm
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/exe
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/linux-arm64
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/linux-x64
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/linuxstatic-arm64
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/macos-arm64
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/macos-x64
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/win-x64
    affected_versions: vers:npm/<7.33.4
    fixed_versions: vers:npm/7.33.4
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/cafs
    affected_versions: vers:npm/<7.0.5
    fixed_versions: vers:npm/7.0.5
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/pnpm
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/exe
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/linux-arm64
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/linux-x64
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/linuxstatic-arm64
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/macos-arm64
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/macos-x64
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:npm/%40pnpm/win-x64
    affected_versions: vers:npm/>=8.0.0|<8.6.8
    fixed_versions: vers:npm/8.6.8
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2023/08/GHSA-5r98-f33j-g8h7/GHSA-5r98-f33j-g8h7.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-284
references:
  - url: https://github.com/pnpm/pnpm
    reference_type:
    reference_id:
  - url: https://github.com/pnpm/pnpm/releases/tag/v7.33.4
    reference_type:
    reference_id:
  - url: https://github.com/pnpm/pnpm/releases/tag/v8.6.8
    reference_type:
    reference_id:
  - url: https://github.com/pnpm/pnpm/security/advisories/GHSA-5r98-f33j-g8h7
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-37478
    reference_type:
    reference_id: CVE-2023-37478
