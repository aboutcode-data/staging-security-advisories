advisory_id: GHSA-6263-x97c-c4gg
datasource_id: github_osv_importer_v2/GHSA-6263-x97c-c4gg
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/09/GHSA-6263-x97c-c4gg/GHSA-6263-x97c-c4gg.json
aliases:
  - CVE-2022-39249
summary: |
  matrix-js-sdk subject to impersonated messages due to permissive key forwarding
  ## Impact

  An attacker cooperating with a malicious homeserver can construct messages appearing to have come from another person. Such messages will be marked with a grey shield on some platforms, but this may be missing in others.

  This attack is possible due to the matrix-js-sdk implementing a too permissive [key forwarding](https://spec.matrix.org/v1.3/client-server-api/#key-requests) strategy on the receiving end.

  Key forwarding is a mechanism allowing clients to recover from “unable to decrypt” messages when they missed the initial key distribution, at the time the message was originally sent. Examples include accessing message history before they joined the room but also when some network/federation errors have occurred.

  ## Patches

  The default policy for accepting key forwards has been made more strict in the matrix-js-sdk. matrix-js-sdk will now only accept forwarded keys in response to previously issued requests and only from own, verified devices.

  A unique exception to this rule is with the experimental [MSC3061](https://github.com/matrix-org/matrix-spec-proposals/pull/3061), that is forwarding room keys for past messages when invited in a room configured with the proper history visibility setting. Such key forwards are parked upon receipt and are only accepted if the SDK receives an invitation for that room from the inviter in a limited time window.

  The SDK now sets a `trusted` flag on the decrypted message upon decryption, based on whether the key used to decrypt the message was received from a trusted source. Clients need to ensure that messages decrypted with a key with `trusted = false` are decorated appropriately (for example, by showing a warning for such messages).

  ### Workarounds

  As this attack requires coordination between a malicious homeserver and an attacker, if you trust your homeserver, no particular workaround is needed.

  ## References
  Blog post: https://matrix.org/blog/2022/09/28/upgrade-now-to-address-encryption-vulns-in-matrix-sdks-and-clients

  ## For more information
  If you have any questions or comments about this advisory, e-mail us at security@matrix.org.
impacted_packages:
  - purl: pkg:npm/matrix-js-sdk
    affected_versions: vers:npm/<19.7.0
    fixed_versions: vers:npm/19.7.0
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N
    published_at: None
    url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/09/GHSA-6263-x97c-c4gg/GHSA-6263-x97c-c4gg.json
  - score: HIGH
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses:
  - CWE-287
references:
  - url: https://github.com/matrix-org/matrix-js-sdk
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-js-sdk/commit/a587d7c36026fe1fcf93dfff63588abee359be76
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-js-sdk/releases/tag/v19.7.0
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-js-sdk/security/advisories/GHSA-6263-x97c-c4gg
    reference_type:
    reference_id:
  - url: https://github.com/matrix-org/matrix-spec-proposals/pull/3061
    reference_type:
    reference_id:
  - url: https://matrix.org/blog/2022/09/28/upgrade-now-to-address-encryption-vulns-in-matrix-sdks-and-clients
    reference_type:
    reference_id:
  - url: https://security.gentoo.org/glsa/202210-35
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-39249
    reference_type:
    reference_id: CVE-2022-39249
