advisory_id: GHSA-9x8m-2xpf-crp3
datasource_id: github_osv_importer_v2/GHSA-9x8m-2xpf-crp3
datasource_url: https://github.com/github/advisory-database/blob/main/advisories/github-reviewed/2022/07/GHSA-9x8m-2xpf-crp3/GHSA-9x8m-2xpf-crp3.json
aliases: []
summary: |
  Scrapy before 2.6.2 and 1.8.3 vulnerable to one proxy sending credentials to another
  ### Impact

  When the [built-in HTTP proxy downloader middleware](https://docs.scrapy.org/en/2.6/topics/downloader-middleware.html#module-scrapy.downloadermiddlewares.httpproxy) processes a request with `proxy` metadata, and that `proxy` metadata includes proxy credentials, the built-in HTTP proxy downloader middleware sets the `Proxy-Authentication` header, but only if that header is not already set.

  There are third-party proxy-rotation downloader middlewares that set different `proxy` metadata every time they process a request.

  Because of request retries and redirects, the same request can be processed by downloader middlewares more than once, including both the built-in HTTP proxy downloader middleware and any third-party proxy-rotation downloader middleware.

  These third-party proxy-rotation downloader middlewares could change the `proxy` metadata of a request to a new value, but fail to remove the `Proxy-Authentication` header from the previous value of the `proxy` metadata, causing the credentials of one proxy to be leaked to a different proxy.

  If you rotate proxies from different proxy providers, and any of those proxies requires credentials, you are affected, unless you are handling proxy rotation as described under **Workarounds** below. If you use a third-party downloader middleware for proxy rotation, the same applies to that downloader middleware, and installing a patched version of Scrapy may not be enough; patching that downloader middlware may be necessary as well.

  ### Patches

  Upgrade to Scrapy 2.6.2.

  If you are using Scrapy 1.8 or a lower version, and upgrading to Scrapy 2.6.2 is not an option, you may upgrade to Scrapy 1.8.3 instead.

  ### Workarounds

  If you cannot upgrade, make sure that any code that changes the value of the `proxy` request meta also removes the `Proxy-Authorization` header from the request if present.

  ### For more information

  If you have any questions or comments about this advisory:
  * [Open an issue](https://github.com/scrapy/scrapy/issues)
  * [Email us](mailto:opensource@zyte.com)
impacted_packages:
  - purl: pkg:pypi/scrapy
    affected_versions: vers:pypi/<1.8.3
    fixed_versions: vers:pypi/1.8.3
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:pypi/scrapy
    affected_versions: vers:pypi/>=2.0.0|<2.6.2
    fixed_versions: vers:pypi/2.6.2
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: MODERATE
    scoring_system: generic_textual
    scoring_elements:
    published_at: None
    url:
weaknesses: []
references:
  - url: https://github.com/scrapy/scrapy
    reference_type:
    reference_id:
  - url: https://github.com/scrapy/scrapy/commit/af7dd16d8ded3e6cb2946603688f4f4a5212e80f
    reference_type:
    reference_id:
  - url: https://github.com/scrapy/scrapy/security/advisories/GHSA-9x8m-2xpf-crp3
    reference_type:
    reference_id:
