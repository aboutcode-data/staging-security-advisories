advisory_id: CVE-2024-46750
datasource_id: vulnrichment_importer_v2/CVE-2024-46750
datasource_url: https://github.com/cisagov/vulnrichment/blob/develop/2024/46xxx/CVE-2024-46750.json
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  PCI: Add missing bridge lock to pci_bus_lock()

  One of the true positives that the cfg_access_lock lockdep effort
  identified is this sequence:

    WARNING: CPU: 14 PID: 1 at drivers/pci/pci.c:4886 pci_bridge_secondary_bus_reset+0x5d/0x70
    RIP: 0010:pci_bridge_secondary_bus_reset+0x5d/0x70
    Call Trace:
     <TASK>
     ? __warn+0x8c/0x190
     ? pci_bridge_secondary_bus_reset+0x5d/0x70
     ? report_bug+0x1f8/0x200
     ? handle_bug+0x3c/0x70
     ? exc_invalid_op+0x18/0x70
     ? asm_exc_invalid_op+0x1a/0x20
     ? pci_bridge_secondary_bus_reset+0x5d/0x70
     pci_reset_bus+0x1d8/0x270
     vmd_probe+0x778/0xa10
     pci_device_probe+0x95/0x120

  Where pci_reset_bus() users are triggering unlocked secondary bus resets.
  Ironically pci_bus_reset(), several calls down from pci_reset_bus(), uses
  pci_bus_lock() before issuing the reset which locks everything *but* the
  bridge itself.

  For the same motivation as adding:

    bridge = pci_upstream_bridge(dev);
    if (bridge)
      pci_dev_lock(bridge);

  to pci_reset_function() for the "bus" and "cxl_bus" reset cases, add
  pci_dev_lock() for @bus->self to pci_bus_lock().

  [bhelgaas: squash in recursive locking deadlock fix from Keith Busch:
  https://lore.kernel.org/r/20240711193650.701834-1-kbusch@meta.com]
impacted_packages: []
severities:
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-09-29T14:47:52Z/
    published_at: None
    url:
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/04e85a3285b0e5c5af6fd2c0fd6e95ffecc01945
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/0790b89c7e911003b8c50ae50e3ac7645de1fae9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7253b4fed46471cc247c6cacefac890a8472c083
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/78c6e39fef5c428960aff742149bba302dd46f5a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/81c68e218ab883dfa368460a59b674084c0240da
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a4e772898f8bf2e7e1cf661a12c60a5612c4afab
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/df77a678c33871a6e4ac5b54a71662f1d702335b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e2355d513b89a2cb511b4ded0deb426cdb01acd0
    reference_type:
    reference_id:
