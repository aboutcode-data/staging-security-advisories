advisory_id: CVE-2024-42152
datasource_id: vulnrichment_importer_v2/CVE-2024-42152
datasource_url: https://github.com/cisagov/vulnrichment/blob/develop/2024/42xxx/CVE-2024-42152.json
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  nvmet: fix a possible leak when destroy a ctrl during qp establishment

  In nvmet_sq_destroy we capture sq->ctrl early and if it is non-NULL we
  know that a ctrl was allocated (in the admin connect request handler)
  and we need to release pending AERs, clear ctrl->sqs and sq->ctrl
  (for nvme-loop primarily), and drop the final reference on the ctrl.

  However, a small window is possible where nvmet_sq_destroy starts (as
  a result of the client giving up and disconnecting) concurrently with
  the nvme admin connect cmd (which may be in an early stage). But *before*
  kill_and_confirm of sq->ref (i.e. the admin connect managed to get an sq
  live reference). In this case, sq->ctrl was allocated however after it was
  captured in a local variable in nvmet_sq_destroy.
  This prevented the final reference drop on the ctrl.

  Solve this by re-capturing the sq->ctrl after all inflight request has
  completed, where for sure sq->ctrl reference is final, and move forward
  based on that.

  This issue was observed in an environment with many hosts connecting
  multiple ctrls simoutanuosly, creating a delay in allocating a ctrl
  leading up to this race window.
impacted_packages: []
severities:
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-09-10T16:15:21Z/
    published_at: None
    url:
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/2f3c22b1d3d7e86712253244797a651998c141fa
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5502c1f1d0d7472706cc1f201aecf1c935d302d1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/818004f2a380420c19872171be716174d4985e33
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/940a71f08ef153ef807f751310b0648d1fa5d0da
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b4fed1443a6571d49c6ffe7d97af3bbe5ee6dff5
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c758b77d4a0a0ed3a1292b3fd7a2aeccd1a169a4
    reference_type:
    reference_id:
