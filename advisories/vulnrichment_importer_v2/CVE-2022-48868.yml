advisory_id: CVE-2022-48868
datasource_id: vulnrichment_importer_v2/CVE-2022-48868
datasource_url: https://github.com/cisagov/vulnrichment/blob/develop/2022/48xxx/CVE-2022-48868.json
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  dmaengine: idxd: Let probe fail when workqueue cannot be enabled

  The workqueue is enabled when the appropriate driver is loaded and
  disabled when the driver is removed. When the driver is removed it
  assumes that the workqueue was enabled successfully and proceeds to
  free allocations made during workqueue enabling.

  Failure during workqueue enabling does not prevent the driver from
  being loaded. This is because the error path within drv_enable_wq()
  returns success unless a second failure is encountered
  during the error path. By returning success it is possible to load
  the driver even if the workqueue cannot be enabled and
  allocations that do not exist are attempted to be freed during
  driver remove.

  Some examples of problematic flows:
  (a)

   idxd_dmaengine_drv_probe() -> drv_enable_wq() -> idxd_wq_request_irq():
   In above flow, if idxd_wq_request_irq() fails then
   idxd_wq_unmap_portal() is called on error exit path, but
   drv_enable_wq() returns 0 because idxd_wq_disable() succeeds. The
   driver is thus loaded successfully.

   idxd_dmaengine_drv_remove()->drv_disable_wq()->idxd_wq_unmap_portal()
   Above flow on driver unload triggers the WARN in devm_iounmap() because
   the device resource has already been removed during error path of
   drv_enable_wq().

  (b)

   idxd_dmaengine_drv_probe() -> drv_enable_wq() -> idxd_wq_request_irq():
   In above flow, if idxd_wq_request_irq() fails then
   idxd_wq_init_percpu_ref() is never called to initialize the percpu
   counter, yet the driver loads successfully because drv_enable_wq()
   returns 0.

   idxd_dmaengine_drv_remove()->__idxd_wq_quiesce()->percpu_ref_kill():
   Above flow on driver unload triggers a BUG when attempting to drop the
   initial ref of the uninitialized percpu ref:
   BUG: kernel NULL pointer dereference, address: 0000000000000010

  Fix the drv_enable_wq() error path by returning the original error that
  indicates failure of workqueue enabling. This ensures that the probe
  fails when an error is encountered and the driver remove paths are only
  attempted when the workqueue was enabled successfully.
impacted_packages: []
severities:
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-09-10T16:05:38Z/
    published_at: None
    url:
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/0f150134dd795ffcd60b798a85ab737d8d010fb7
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/99dc4520b74e7ca8e9dc9abe37a0b10b49467960
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b51b75f0604f17c0f6f3b6f68f1a521a5cc6b04f
    reference_type:
    reference_id:
