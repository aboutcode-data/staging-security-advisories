advisory_id: CVE-2024-42302
datasource_id: vulnrichment_importer_v2/CVE-2024-42302
datasource_url: https://github.com/cisagov/vulnrichment/blob/develop/2024/42xxx/CVE-2024-42302.json
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  PCI/DPC: Fix use-after-free on concurrent DPC and hot-removal

  Keith reports a use-after-free when a DPC event occurs concurrently to
  hot-removal of the same portion of the hierarchy:

  The dpc_handler() awaits readiness of the secondary bus below the
  Downstream Port where the DPC event occurred.  To do so, it polls the
  config space of the first child device on the secondary bus.  If that
  child device is concurrently removed, accesses to its struct pci_dev
  cause the kernel to oops.

  That's because pci_bridge_wait_for_secondary_bus() neglects to hold a
  reference on the child device.  Before v6.3, the function was only
  called on resume from system sleep or on runtime resume.  Holding a
  reference wasn't necessary back then because the pciehp IRQ thread
  could never run concurrently.  (On resume from system sleep, IRQs are
  not enabled until after the resume_noirq phase.  And runtime resume is
  always awaited before a PCI device is removed.)

  However starting with v6.3, pci_bridge_wait_for_secondary_bus() is also
  called on a DPC event.  Commit 53b54ad074de ("PCI/DPC: Await readiness
  of secondary bus after reset"), which introduced that, failed to
  appreciate that pci_bridge_wait_for_secondary_bus() now needs to hold a
  reference on the child device because dpc_handler() and pciehp may
  indeed run concurrently.  The commit was backported to v5.10+ stable
  kernels, so that's the oldest one affected.

  Add the missing reference acquisition.

  Abridged stack trace:

    BUG: unable to handle page fault for address: 00000000091400c0
    CPU: 15 PID: 2464 Comm: irq/53-pcie-dpc 6.9.0
    RIP: pci_bus_read_config_dword+0x17/0x50
    pci_dev_wait()
    pci_bridge_wait_for_secondary_bus()
    dpc_reset_link()
    pcie_do_recovery()
    dpc_handler()
impacted_packages: []
severities:
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-09-10T16:10:28Z/
    published_at: None
    url:
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/11a1f4bc47362700fcbde717292158873fb847ed
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2c111413f38ca5cf87557cab89f6d82b0e3433e7
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2cc8973bdc4d6c928ebe38b88090a2cdfe81f42f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b16f3ea1db47a6766a9f1169244cf1fc287a7c62
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c52f9e1a9eb40f13993142c331a6cfd334d4b91d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f63df70b439bb8331358a306541893bf415bf1da
    reference_type:
    reference_id:
