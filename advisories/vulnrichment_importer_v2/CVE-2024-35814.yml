advisory_id: CVE-2024-35814
datasource_id: vulnrichment_importer_v2/CVE-2024-35814
datasource_url: https://github.com/cisagov/vulnrichment/blob/develop/2024/35xxx/CVE-2024-35814.json
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  swiotlb: Fix double-allocation of slots due to broken alignment handling

  Commit bbb73a103fbb ("swiotlb: fix a braino in the alignment check fix"),
  which was a fix for commit 0eee5ae10256 ("swiotlb: fix slot alignment
  checks"), causes a functional regression with vsock in a virtual machine
  using bouncing via a restricted DMA SWIOTLB pool.

  When virtio allocates the virtqueues for the vsock device using
  dma_alloc_coherent(), the SWIOTLB search can return page-unaligned
  allocations if 'area->index' was left unaligned by a previous allocation
  from the buffer:

   # Final address in brackets is the SWIOTLB address returned to the caller
   | virtio-pci 0000:00:07.0: orig_addr 0x0 alloc_size 0x2000, iotlb_align_mask 0x800 stride 0x2: got slot 1645-1649/7168 (0x98326800)
   | virtio-pci 0000:00:07.0: orig_addr 0x0 alloc_size 0x2000, iotlb_align_mask 0x800 stride 0x2: got slot 1649-1653/7168 (0x98328800)
   | virtio-pci 0000:00:07.0: orig_addr 0x0 alloc_size 0x2000, iotlb_align_mask 0x800 stride 0x2: got slot 1653-1657/7168 (0x9832a800)

  This ends badly (typically buffer corruption and/or a hang) because
  swiotlb_alloc() is expecting a page-aligned allocation and so blindly
  returns a pointer to the 'struct page' corresponding to the allocation,
  therefore double-allocating the first half (2KiB slot) of the 4KiB page.

  Fix the problem by treating the allocation alignment separately to any
  additional alignment requirements from the device, using the maximum
  of the two as the stride to search the buffer slots and taking care
  to ensure a minimum of page-alignment for buffers larger than a page.

  This also resolves swiotlb allocation failures occuring due to the
  inclusion of ~PAGE_MASK in 'iotlb_align_mask' for large allocations and
  resulting in alignment requirements exceeding swiotlb_max_mapping_size().
impacted_packages: []
severities:
  - score: '7.1'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H
    published_at: None
    url:
  - score: Track
    scoring_system: ssvc
    scoring_elements: SSVCv2/E:N/A:N/T:P/P:M/B:A/M:M/D:T/2024-06-05T20:30:30Z/
    published_at: None
    url:
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/04867a7a33324c9c562ee7949dbcaab7aaad1fb4
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3e7acd6e25ba77dde48c3b721c54c89cd6a10534
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/777391743771040e12cc40d3d0d178f70c616491
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c88668aa6c1da240ea3eb4d128b7906e740d3cb8
    reference_type:
    reference_id:
