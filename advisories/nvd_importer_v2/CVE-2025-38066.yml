advisory_id: CVE-2025-38066
datasource_id: nvd_importer_v2/CVE-2025-38066
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-38066
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  dm cache: prevent BUG_ON by blocking retries on failed device resumes

  A cache device failing to resume due to mapping errors should not be
  retried, as the failure leaves a partially initialized policy object.
  Repeating the resume operation risks triggering BUG_ON when reloading
  cache mappings into the incomplete policy object.

  Reproduce steps:

  1. create a cache metadata consisting of 512 or more cache blocks,
     with some mappings stored in the first array block of the mapping
     array. Here we use cache_restore v1.0 to build the metadata.

  cat <<EOF >> cmeta.xml
  <superblock uuid="" block_size="128" nr_cache_blocks="512" \
  policy="smq" hint_width="4">
    <mappings>
      <mapping cache_block="0" origin_block="0" dirty="false"/>
    </mappings>
  </superblock>
  EOF
  dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
  cache_restore -i cmeta.xml -o /dev/mapper/cmeta --metadata-version=2
  dmsetup remove cmeta

  2. wipe the second array block of the mapping array to simulate
     data degradations.

  mapping_root=$(dd if=/dev/sdc bs=1c count=8 skip=192 \
  2>/dev/null | hexdump -e '1/8 "%u\n"')
  ablock=$(dd if=/dev/sdc bs=1c count=8 skip=$((4096*mapping_root+2056)) \
  2>/dev/null | hexdump -e '1/8 "%u\n"')
  dd if=/dev/zero of=/dev/sdc bs=4k count=1 seek=$ablock

  3. try bringing up the cache device. The resume is expected to fail
     due to the broken array block.

  dmsetup create cmeta --table "0 8192 linear /dev/sdc 0"
  dmsetup create cdata --table "0 65536 linear /dev/sdc 8192"
  dmsetup create corig --table "0 524288 linear /dev/sdc 262144"
  dmsetup create cache --notable
  dmsetup load cache --table "0 524288 cache /dev/mapper/cmeta \
  /dev/mapper/cdata /dev/mapper/corig 128 2 metadata2 writethrough smq 0"
  dmsetup resume cache

  4. try resuming the cache again. An unexpected BUG_ON is triggered
     while loading cache mappings.

  dmsetup resume cache

  Kernel logs:

  (snip)
  ------------[ cut here ]------------
  kernel BUG at drivers/md/dm-cache-policy-smq.c:752!
  Oops: invalid opcode: 0000 [#1] PREEMPT SMP KASAN NOPTI
  CPU: 0 UID: 0 PID: 332 Comm: dmsetup Not tainted 6.13.4 #3
  RIP: 0010:smq_load_mapping+0x3e5/0x570

  Fix by disallowing resume operations for devices that failed the
  initial attempt.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2025-38066
weaknesses:
  - CWE-617
references:
  - url: https://git.kernel.org/stable/c/00586b78eeb7c626a14ca13453a1631f88a7cf36
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/025c8f477625eb39006ded650e7d027bcfb20e79
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3986ef4a9b6a0d9c28bc325d8713beba5e67586f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5da692e2262b8f81993baa9592f57d12c2703dea
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c5356a5e80442131e2714d0d26bb110590e4e568
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c614584c2a66b538f469089ac089457a34590c14
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/cc80a5cc520939d0a7d071cc4ae4b3c55ef171d0
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f3128e3074e8af565cc6a66fe3384a56df87f803
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/10/msg00007.html
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/10/msg00008.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:debian:debian_linux:11.0:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:debian:debian_linux:11.0:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-38066
    reference_type:
    reference_id: CVE-2025-38066
