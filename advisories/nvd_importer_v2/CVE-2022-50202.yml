advisory_id: CVE-2022-50202
datasource_id: nvd_importer_v2/CVE-2022-50202
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2022-50202
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  PM: hibernate: defer device probing when resuming from hibernation

  syzbot is reporting hung task at misc_open() [1], for there is a race
  window of AB-BA deadlock which involves probe_count variable. Currently
  wait_for_device_probe() from snapshot_open() from misc_open() can sleep
  forever with misc_mtx held if probe_count cannot become 0.

  When a device is probed by hub_event() work function, probe_count is
  incremented before the probe function starts, and probe_count is
  decremented after the probe function completed.

  There are three cases that can prevent probe_count from dropping to 0.

    (a) A device being probed stopped responding (i.e. broken/malicious
        hardware).

    (b) A process emulating a USB device using /dev/raw-gadget interface
        stopped responding for some reason.

    (c) New device probe requests keeps coming in before existing device
        probe requests complete.

  The phenomenon syzbot is reporting is (b). A process which is holding
  system_transition_mutex and misc_mtx is waiting for probe_count to become
  0 inside wait_for_device_probe(), but the probe function which is called
   from hub_event() work function is waiting for the processes which are
  blocked at mutex_lock(&misc_mtx) to respond via /dev/raw-gadget interface.

  This patch mitigates (b) by deferring wait_for_device_probe() from
  snapshot_open() to snapshot_write() and snapshot_ioctl(). Please note that
  the possibility of (b) remains as long as any thread which is emulating a
  USB device via /dev/raw-gadget interface can be blocked by uninterruptible
  blocking operations (e.g. mutex_lock()).

  Please also note that (a) and (c) are not addressed. Regarding (c), we
  should change the code to wait for only one device which contains the
  image for resuming from hibernation. I don't know how to address (a), for
  use of timeout for wait_for_device_probe() might result in loss of user
  data in the image. Maybe we should require the userland to wait for the
  image device before opening /dev/snapshot interface.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-50202
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/003a456ae6f70bb97e436e02fc5105be577c1570
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2f0e18e0db42f4f8bc87d3d98333680065ceeff8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3c48d3067eaf878642276f053575a5c642600a50
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5a283b59bce72c05c60e9f0fa92a28b5b850d8bb
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/8386c414e27caba8501119948e9551e52b527f59
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/8c90947e5f1801e6c7120021c6ea0f3ad6a4eb91
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b8e1ae9433d7bd95f2dcc044a7a6f20a4c40d258
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f7042cf9dd40733f387b7cac021e626c74b8856f
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-50202
    reference_type:
    reference_id: CVE-2022-50202
