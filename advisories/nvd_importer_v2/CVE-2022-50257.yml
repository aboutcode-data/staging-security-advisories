advisory_id: CVE-2022-50257
datasource_id: nvd_importer_v2/CVE-2022-50257
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2022-50257
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  xen/gntdev: Prevent leaking grants

  Prior to this commit, if a grant mapping operation failed partially,
  some of the entries in the map_ops array would be invalid, whereas all
  of the entries in the kmap_ops array would be valid. This in turn would
  cause the following logic in gntdev_map_grant_pages to become invalid:

    for (i = 0; i < map->count; i++) {
      if (map->map_ops[i].status == GNTST_okay) {
        map->unmap_ops[i].handle = map->map_ops[i].handle;
        if (!use_ptemod)
          alloced++;
      }
      if (use_ptemod) {
        if (map->kmap_ops[i].status == GNTST_okay) {
          if (map->map_ops[i].status == GNTST_okay)
            alloced++;
          map->kunmap_ops[i].handle = map->kmap_ops[i].handle;
        }
      }
    }
    ...
    atomic_add(alloced, &map->live_grants);

  Assume that use_ptemod is true (i.e., the domain mapping the granted
  pages is a paravirtualized domain). In the code excerpt above, note that
  the "alloced" variable is only incremented when both kmap_ops[i].status
  and map_ops[i].status are set to GNTST_okay (i.e., both mapping
  operations are successful).  However, as also noted above, there are
  cases where a grant mapping operation fails partially, breaking the
  assumption of the code excerpt above.

  The aforementioned causes map->live_grants to be incorrectly set. In
  some cases, all of the map_ops mappings fail, but all of the kmap_ops
  mappings succeed, meaning that live_grants may remain zero. This in turn
  makes it impossible to unmap the successfully grant-mapped pages pointed
  to by kmap_ops, because unmap_grant_pages has the following snippet of
  code at its beginning:

    if (atomic_read(&map->live_grants) == 0)
      return; /* Nothing to do */

  In other cases where only some of the map_ops mappings fail but all
  kmap_ops mappings succeed, live_grants is made positive, but when the
  user requests unmapping the grant-mapped pages, __unmap_grant_pages_done
  will then make map->live_grants negative, because the latter function
  does not check if all of the pages that were requested to be unmapped
  were actually unmapped, and the same function unconditionally subtracts
  "data->count" (i.e., a value that can be greater than map->live_grants)
  from map->live_grants. The side effects of a negative live_grants value
  have not been studied.

  The net effect of all of this is that grant references are leaked in one
  of the above conditions. In Qubes OS v4.1 (which uses Xen's grant
  mechanism extensively for X11 GUI isolation), this issue manifests
  itself with warning messages like the following to be printed out by the
  Linux kernel in the VM that had granted pages (that contain X11 GUI
  window data) to dom0: "g.e. 0x1234 still pending", especially after the
  user rapidly resizes GUI VM windows (causing some grant-mapping
  operations to partially or completely fail, due to the fact that the VM
  unshares some of the pages as part of the window resizing, making the
  pages impossible to grant-map from dom0).

  The fix for this issue involves counting all successful map_ops and
  kmap_ops mappings separately, and then adding the sum to live_grants.
  During unmapping, only the number of successfully unmapped grants is
  subtracted from live_grants. The code is also modified to check for
  negative live_grants values after the subtraction and warn the user.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-50257
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/0991028cd49567d7016d1b224fe0117c35059f86
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/0bccddd9b8f03ad57bb738f0d3da8845d4e1e579
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/1cb73704cb4778299609634a790a80daba582f7d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/273f6a4f71be12e2ec80a4919837d6e4fa933a04
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3d056d81b93a787613eda44aeb21fc14c3392b34
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/49bb053b1ec367b6883030eb2cca696e91435679
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/49db6cb81400ba863e1a85e55fcdf1031807c23f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b043f2cab100bed3e0a999dcf38cc05b1e4a7e41
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/cb1ccfe7655380f77a58b340072f5f40bc285902
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.19:-:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.19:-:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.19:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.19:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.19:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.19:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.19:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.19:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.19:rc7:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.19:rc7:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.19:rc8:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.19:rc8:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-50257
    reference_type:
    reference_id: CVE-2022-50257
