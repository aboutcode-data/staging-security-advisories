advisory_id: CVE-2023-52933
datasource_id: nvd_importer_v2/CVE-2023-52933
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2023-52933
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  Squashfs: fix handling and sanity checking of xattr_ids count

  A Sysbot [1] corrupted filesystem exposes two flaws in the handling and
  sanity checking of the xattr_ids count in the filesystem.  Both of these
  flaws cause computation overflow due to incorrect typing.

  In the corrupted filesystem the xattr_ids value is 4294967071, which
  stored in a signed variable becomes the negative number -225.

  Flaw 1 (64-bit systems only):

  The signed integer xattr_ids variable causes sign extension.

  This causes variable overflow in the SQUASHFS_XATTR_*(A) macros.  The
  variable is first multiplied by sizeof(struct squashfs_xattr_id) where the
  type of the sizeof operator is "unsigned long".

  On a 64-bit system this is 64-bits in size, and causes the negative number
  to be sign extended and widened to 64-bits and then become unsigned.  This
  produces the very large number 18446744073709548016 or 2^64 - 3600.  This
  number when rounded up by SQUASHFS_METADATA_SIZE - 1 (8191 bytes) and
  divided by SQUASHFS_METADATA_SIZE overflows and produces a length of 0
  (stored in len).

  Flaw 2 (32-bit systems only):

  On a 32-bit system the integer variable is not widened by the unsigned
  long type of the sizeof operator (32-bits), and the signedness of the
  variable has no effect due it always being treated as unsigned.

  The above corrupted xattr_ids value of 4294967071, when multiplied
  overflows and produces the number 4294963696 or 2^32 - 3400.  This number
  when rounded up by SQUASHFS_METADATA_SIZE - 1 (8191 bytes) and divided by
  SQUASHFS_METADATA_SIZE overflows again and produces a length of 0.

  The effect of the 0 length computation:

  In conjunction with the corrupted xattr_ids field, the filesystem also has
  a corrupted xattr_table_start value, where it matches the end of
  filesystem value of 850.

  This causes the following sanity check code to fail because the
  incorrectly computed len of 0 matches the incorrect size of the table
  reported by the superblock (0 bytes).

      len = SQUASHFS_XATTR_BLOCK_BYTES(*xattr_ids);
      indexes = SQUASHFS_XATTR_BLOCKS(*xattr_ids);

      /*
       * The computed size of the index table (len bytes) should exactly
       * match the table start and end points
      */
      start = table_start + sizeof(*id_table);
      end = msblk->bytes_used;

      if (len != (end - start))
              return ERR_PTR(-EINVAL);

  Changing the xattr_ids variable to be "usigned int" fixes the flaw on a
  64-bit system.  This relies on the fact the computation is widened by the
  unsigned long type of the sizeof operator.

  Casting the variable to u64 in the above macro fixes this flaw on a 32-bit
  system.

  It also means 64-bit systems do not implicitly rely on the type of the
  sizeof operator to widen the computation.

  [1] https://lore.kernel.org/lkml/000000000000cd44f005f1a0f17f@google.com/
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-52933
weaknesses:
  - CWE-190
references:
  - url: https://git.kernel.org/stable/c/1369322c1de52c7b9b988b95c9903110a4566778
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5c4d4a83bf1a862d80c1efff1c6e3ce33b501e2e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7fe583c9bec10cd4b76231c51b37f3e4ca646e01
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/997bed0f3cde78a3e639d624985bf4a95cf767e6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a7da7d01ac5ce9b369a1ac70e1197999cc6c9686
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b38c3e9e0adc01956cc3e5a52e4d3f92f79d88e2
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f65c4bbbd682b0877b669828b4e033b8d5d0a2dc
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.11:-:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.11:-:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.2:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.2:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-52933
    reference_type:
    reference_id: CVE-2023-52933
