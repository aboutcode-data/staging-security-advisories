advisory_id: CVE-2024-53058
datasource_id: nvd_importer_v2/CVE-2024-53058
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-53058
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  net: stmmac: TSO: Fix unbalanced DMA map/unmap for non-paged SKB data

  In case the non-paged data of a SKB carries protocol header and protocol
  payload to be transmitted on a certain platform that the DMA AXI address
  width is configured to 40-bit/48-bit, or the size of the non-paged data
  is bigger than TSO_MAX_BUFF_SIZE on a certain platform that the DMA AXI
  address width is configured to 32-bit, then this SKB requires at least
  two DMA transmit descriptors to serve it.

  For example, three descriptors are allocated to split one DMA buffer
  mapped from one piece of non-paged data:
      dma_desc[N + 0],
      dma_desc[N + 1],
      dma_desc[N + 2].
  Then three elements of tx_q->tx_skbuff_dma[] will be allocated to hold
  extra information to be reused in stmmac_tx_clean():
      tx_q->tx_skbuff_dma[N + 0],
      tx_q->tx_skbuff_dma[N + 1],
      tx_q->tx_skbuff_dma[N + 2].
  Now we focus on tx_q->tx_skbuff_dma[entry].buf, which is the DMA buffer
  address returned by DMA mapping call. stmmac_tx_clean() will try to
  unmap the DMA buffer _ONLY_IF_ tx_q->tx_skbuff_dma[entry].buf
  is a valid buffer address.

  The expected behavior that saves DMA buffer address of this non-paged
  data to tx_q->tx_skbuff_dma[entry].buf is:
      tx_q->tx_skbuff_dma[N + 0].buf = NULL;
      tx_q->tx_skbuff_dma[N + 1].buf = NULL;
      tx_q->tx_skbuff_dma[N + 2].buf = dma_map_single();
  Unfortunately, the current code misbehaves like this:
      tx_q->tx_skbuff_dma[N + 0].buf = dma_map_single();
      tx_q->tx_skbuff_dma[N + 1].buf = NULL;
      tx_q->tx_skbuff_dma[N + 2].buf = NULL;

  On the stmmac_tx_clean() side, when dma_desc[N + 0] is closed by the
  DMA engine, tx_q->tx_skbuff_dma[N + 0].buf is a valid buffer address
  obviously, then the DMA buffer will be unmapped immediately.
  There may be a rare case that the DMA engine does not finish the
  pending dma_desc[N + 1], dma_desc[N + 2] yet. Now things will go
  horribly wrong, DMA is going to access a unmapped/unreferenced memory
  region, corrupted data will be transmited or iommu fault will be
  triggered :(

  In contrast, the for-loop that maps SKB fragments behaves perfectly
  as expected, and that is how the driver should do for both non-paged
  data and paged frags actually.

  This patch corrects DMA map/unmap sequences by fixing the array index
  for tx_q->tx_skbuff_dma[entry].buf when assigning DMA buffer address.

  Tested and verified on DWXGMAC CORE 3.20a
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-53058
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/07c9c26e37542486e34d767505e842f48f29c3f6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/58d23d835eb498336716cca55b5714191a309286
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/66600fac7a984dea4ae095411f644770b2561ede
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a3ff23f7c3f0e13f718900803e090fd3997d6bc9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ece593fc9c00741b682869d3f3dc584d37b7c9df
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/01/msg00001.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-53058
    reference_type:
    reference_id: CVE-2024-53058
