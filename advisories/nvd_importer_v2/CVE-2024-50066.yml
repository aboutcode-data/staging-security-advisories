advisory_id: CVE-2024-50066
datasource_id: nvd_importer_v2/CVE-2024-50066
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-50066
aliases: []
summary: "In the Linux kernel, the following vulnerability has been resolved:\n\nmm/mremap:\
  \ fix move_normal_pmd/retract_page_tables race\n\nIn mremap(), move_page_tables() looks at\
  \ the type of the PMD entry and the\nspecified address range to figure out by which method\
  \ the next chunk of\npage table entries should be moved.\n\nAt that point, the mmap_lock is\
  \ held in write mode, but no rmap locks are\nheld yet.  For PMD entries that point to page\
  \ tables and are fully covered\nby the source address range, move_pgt_entry(NORMAL_PMD, ...)\
  \ is called,\nwhich first takes rmap locks, then does move_normal_pmd(). \nmove_normal_pmd()\
  \ takes the necessary page table locks at source and\ndestination, then moves an entire page\
  \ table from the source to the\ndestination.\n\nThe problem is: The rmap locks, which protect\
  \ against concurrent page\ntable removal by retract_page_tables() in the THP code, are only\
  \ taken\nafter the PMD entry has been read and it has been decided how to move it. \nSo we\
  \ can race as follows (with two processes that have mappings of the\nsame tmpfs file that\
  \ is stored on a tmpfs mount with huge=advise); note\nthat process A accesses page tables\
  \ through the MM while process B does it\nthrough the file rmap:\n\nprocess A            \
  \          process B\n=========                      =========\nmremap\n  mremap_to\n    move_vma\n\
  \      move_page_tables\n        get_old_pmd\n        alloc_new_pmd\n                    \
  \  *** PREEMPT ***\n                               madvise(MADV_COLLAPSE)\n              \
  \                   do_madvise\n                                   madvise_walk_vmas\n   \
  \                                  madvise_vma_behavior\n                                \
  \       madvise_collapse\n                                         hpage_collapse_scan_file\n\
  \                                           collapse_file\n                              \
  \               retract_page_tables\n                                               i_mmap_lock_read(mapping)\n\
  \                                               pmdp_collapse_flush\n                    \
  \                           i_mmap_unlock_read(mapping)\n        move_pgt_entry(NORMAL_PMD,\
  \ ...)\n          take_rmap_locks\n          move_normal_pmd\n          drop_rmap_locks\n\n\
  When this happens, move_normal_pmd() can end up creating bogus PMD entries\nin the line `pmd_populate(mm,\
  \ new_pmd, pmd_pgtable(pmd))`.  The effect\ndepends on arch-specific and machine-specific\
  \ details; on x86, you can end\nup with physical page 0 mapped as a page table, which is likely\n\
  exploitable for user->kernel privilege escalation.\n\nFix the race by letting process B recheck\
  \ that the PMD still points to a\npage table after the rmap locks have been taken.  Otherwise,\
  \ we bail and\nlet the caller fall back to the PTE-level copying path, which will then\nbail\
  \ immediately at the pmd_none() check.\n\nBug reachability: Reaching this bug requires that\
  \ you can create\nshmem/file THP mappings - anonymous THP uses different code that doesn't\n\
  zap stuff under rmap locks.  File THP is gated on an experimental config\nflag (CONFIG_READ_ONLY_THP_FOR_FS),\
  \ so on normal distro kernels you need\nshmem THP to hit this bug.  As far as I know, getting\
  \ shmem THP normally\nrequires that you can mount your own tmpfs with the right mount flags,\n\
  which would require creating your own user+mount namespace; though I don't\nknow if some distros\
  \ maybe enable shmem THP by default or something like\nthat.\n\nBug impact: This issue can\
  \ likely be used for user->kernel privilege\nescalation when it is reachable."
impacted_packages: []
severities:
  - score: '7.0'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-50066
weaknesses:
  - CWE-362
references:
  - url: https://git.kernel.org/stable/c/1552ce9ce8af47c0fe911682e5e1855e25851ca9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/17396e32f975130b3e6251f024c8807d192e4c3e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6fa1066fc5d00cb9f1b0e83b7ff6ef98d26ba2aa
    reference_type:
    reference_id:
  - url: https://project-zero.issues.chromium.org/issues/371047675
    reference_type:
    reference_id:
  - url: https://www.vicarius.io/vsociety/posts/cve-2024-50066-kernel-detection-vulnerability
    reference_type:
    reference_id:
  - url: https://www.vicarius.io/vsociety/posts/cve-2024-50066-kernel-mitigation-vulnerability
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-50066
    reference_type:
    reference_id: CVE-2024-50066
