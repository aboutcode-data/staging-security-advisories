advisory_id: CVE-2022-50838
datasource_id: nvd_importer_v2/CVE-2022-50838
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2022-50838
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  net: stream: purge sk_error_queue in sk_stream_kill_queues()

  Changheon Lee reported TCP socket leaks, with a nice repro.

  It seems we leak TCP sockets with the following sequence:

  1) SOF_TIMESTAMPING_TX_ACK is enabled on the socket.

     Each ACK will cook an skb put in error queue, from __skb_tstamp_tx().
     __skb_tstamp_tx() is using skb_clone(), unless
     SOF_TIMESTAMPING_OPT_TSONLY was also requested.

  2) If the application is also using MSG_ZEROCOPY, then we put in the
     error queue cloned skbs that had a struct ubuf_info attached to them.

     Whenever an struct ubuf_info is allocated, sock_zerocopy_alloc()
     does a sock_hold().

     As long as the cloned skbs are still in sk_error_queue,
     socket refcount is kept elevated.

  3) Application closes the socket, while error queue is not empty.

  Since tcp_close() no longer purges the socket error queue,
  we might end up with a TCP socket with at least one skb in
  error queue keeping the socket alive forever.

  This bug can be (ab)used to consume all kernel memory
  and freeze the host.

  We need to purge the error queue, with proper synchronization
  against concurrent writers.
impacted_packages: []
severities: []
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/4f1d37ff4226eb99d6b69e9f4518e279e1a851bf
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6f00bd0402a1e3d2d556afba57c045bd7931e4d3
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/8c330c36b3970d0917f48827fa6c7a9c75aa4602
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9062493811676ee0efe6c74d98f00ca38c4e17d4
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9da204cd67c4fe97e8aa465d10d5c2e7076f7f42
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b458d349f8753f666233828ebd30df6f100cf7d5
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/bab542cf56fc174c8447c00b73be99ffd66d2d39
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c8c1eec578a9ae2dc8f14a1846942a0b7bf29d1d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e0c8bccd40fc1c19e1d246c39bcf79e357e1ada3
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-50838
    reference_type:
    reference_id: CVE-2022-50838
