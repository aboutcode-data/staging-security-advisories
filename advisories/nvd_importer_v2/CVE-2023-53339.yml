advisory_id: CVE-2023-53339
datasource_id: nvd_importer_v2/CVE-2023-53339
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2023-53339
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix BUG_ON condition in btrfs_cancel_balance

  Pausing and canceling balance can race to interrupt balance lead to BUG_ON
  panic in btrfs_cancel_balance. The BUG_ON condition in btrfs_cancel_balance
  does not take this race scenario into account.

  However, the race condition has no other side effects. We can fix that.

  Reproducing it with panic trace like this:

    kernel BUG at fs/btrfs/volumes.c:4618!
    RIP: 0010:btrfs_cancel_balance+0x5cf/0x6a0
    Call Trace:
     <TASK>
     ? do_nanosleep+0x60/0x120
     ? hrtimer_nanosleep+0xb7/0x1a0
     ? sched_core_clone_cookie+0x70/0x70
     btrfs_ioctl_balance_ctl+0x55/0x70
     btrfs_ioctl+0xa46/0xd20
     __x64_sys_ioctl+0x7d/0xa0
     do_syscall_64+0x38/0x80
     entry_SYSCALL_64_after_hwframe+0x63/0xcd

    Race scenario as follows:
    > mutex_unlock(&fs_info->balance_mutex);
    > --------------------
    > .......issue pause and cancel req in another thread
    > --------------------
    > ret = __btrfs_balance(fs_info);
    >
    > mutex_lock(&fs_info->balance_mutex);
    > if (ret == -ECANCELED && atomic_read(&fs_info->balance_pause_req)) {
    >         btrfs_info(fs_info, "balance: paused");
    >         btrfs_exclop_balance(fs_info, BTRFS_EXCLOP_BALANCE_PAUSED);
    > }
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-53339
weaknesses:
  - CWE-617
references:
  - url: https://git.kernel.org/stable/c/29eefa6d0d07e185f7bfe9576f91e6dba98189c2
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ae81329f7de3aa6f34ecdfa5412e72161a30e9ce
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ceb9ba8e30833a4823e2dc73f80ebcdf2498d01a
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-53339
    reference_type:
    reference_id: CVE-2023-53339
