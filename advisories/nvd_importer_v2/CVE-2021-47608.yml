advisory_id: CVE-2021-47608
datasource_id: nvd_importer_v2/CVE-2021-47608
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2021-47608
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  bpf: Fix kernel address leakage in atomic fetch

  The change in commit 37086bfdc737 ("bpf: Propagate stack bounds to registers
  in atomics w/ BPF_FETCH") around check_mem_access() handling is buggy since
  this would allow for unprivileged users to leak kernel pointers. For example,
  an atomic fetch/and with -1 on a stack destination which holds a spilled
  pointer will migrate the spilled register type into a scalar, which can then
  be exported out of the program (since scalar != pointer) by dumping it into
  a map value.

  The original implementation of XADD was preventing this situation by using
  a double call to check_mem_access() one with BPF_READ and a subsequent one
  with BPF_WRITE, in both cases passing -1 as a placeholder value instead of
  register as per XADD semantics since it didn't contain a value fetch. The
  BPF_READ also included a check in check_stack_read_fixed_off() which rejects
  the program if the stack slot is of __is_pointer_value() if dst_regno < 0.
  The latter is to distinguish whether we're dealing with a regular stack spill/
  fill or some arithmetical operation which is disallowed on non-scalars, see
  also 6e7e63cbb023 ("bpf: Forbid XADD on spilled pointers for unprivileged
  users") for more context on check_mem_access() and its handling of placeholder
  value -1.

  One minimally intrusive option to fix the leak is for the BPF_FETCH case to
  initially check the BPF_READ case via check_mem_access() with -1 as register,
  followed by the actual load case with non-negative load_reg to propagate
  stack bounds to registers.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47608
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/423628125a484538111c2c6d9bb1588eb086053b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7d3baf0afa3aa9102d6a521a8e4c41888bb79882
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.16:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.16:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.16:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.16:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.16:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.16:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.16:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.16:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.16:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.16:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47608
    reference_type:
    reference_id: CVE-2021-47608
