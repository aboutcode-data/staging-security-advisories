advisory_id: CVE-2024-26757
datasource_id: nvd_importer_v2/CVE-2024-26757
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-26757
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  md: Don't ignore read-only array in md_check_recovery()

  Usually if the array is not read-write, md_check_recovery() won't
  register new sync_thread in the first place. And if the array is
  read-write and sync_thread is registered, md_set_readonly() will
  unregister sync_thread before setting the array read-only. md/raid
  follow this behavior hence there is no problem.

  After commit f52f5c71f3d4 ("md: fix stopping sync thread"), following
  hang can be triggered by test shell/integrity-caching.sh:

  1) array is read-only. dm-raid update super block:
  rs_update_sbs
   ro = mddev->ro
   mddev->ro = 0
    -> set array read-write
   md_update_sb

  2) register new sync thread concurrently.

  3) dm-raid set array back to read-only:
  rs_update_sbs
   mddev->ro = ro

  4) stop the array:
  raid_dtr
   md_stop
    stop_sync_thread
      set_bit(MD_RECOVERY_INTR, &mddev->recovery);
      md_wakeup_thread_directly(mddev->sync_thread);
      wait_event(..., !test_bit(MD_RECOVERY_RUNNING, &mddev->recovery))

  5) sync thread done:
   md_do_sync
   set_bit(MD_RECOVERY_DONE, &mddev->recovery);
   md_wakeup_thread(mddev->thread);

  6) daemon thread can't unregister sync thread:
   md_check_recovery
    if (!md_is_rdwr(mddev) &&
        !test_bit(MD_RECOVERY_NEEDED, &mddev->recovery))
     return;
    -> -> MD_RECOVERY_RUNNING can't be cleared, hence step 4 hang;

  The root cause is that dm-raid manipulate 'mddev->ro' by itself,
  however, dm-raid really should stop sync thread before setting the
  array read-only. Unfortunately, I need to read more code before I
  can refacter the handler of 'mddev->ro' in dm-raid, hence let's fix
  the problem the easy way for now to prevent dm-raid regression.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-26757
weaknesses:
  - CWE-404
references:
  - url: https://git.kernel.org/stable/c/2ea169c5a0b1134d573d07fc27a16f327ad0e7d3
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/55a48ad2db64737f7ffc0407634218cc6e4c513b
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.8:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.8:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.8:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.8:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.8:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.8:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.8:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.8:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.8:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.8:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-26757
    reference_type:
    reference_id: CVE-2024-26757
