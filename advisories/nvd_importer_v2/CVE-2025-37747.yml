advisory_id: CVE-2025-37747
datasource_id: nvd_importer_v2/CVE-2025-37747
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-37747
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  perf: Fix hang while freeing sigtrap event

  Perf can hang while freeing a sigtrap event if a related deferred
  signal hadn't managed to be sent before the file got closed:

  perf_event_overflow()
     task_work_add(perf_pending_task)

  fput()
     task_work_add(____fput())

  task_work_run()
      ____fput()
          perf_release()
              perf_event_release_kernel()
                  _free_event()
                      perf_pending_task_sync()
                          task_work_cancel() -> FAILED
                          rcuwait_wait_event()

  Once task_work_run() is running, the list of pending callbacks is
  removed from the task_struct and from this point on task_work_cancel()
  can't remove any pending and not yet started work items, hence the
  task_work_cancel() failure and the hang on rcuwait_wait_event().

  Task work could be changed to remove one work at a time, so a work
  running on the current task can always cancel a pending one, however
  the wait / wake design is still subject to inverted dependencies when
  remote targets are involved, as pictured by Oleg:

  T1                                                      T2

  fd = perf_event_open(pid => T2->pid);                  fd = perf_event_open(pid => T1->pid);
  close(fd)                                              close(fd)
      <IRQ>                                                  <IRQ>
      perf_event_overflow()                                  perf_event_overflow()
         task_work_add(perf_pending_task)                        task_work_add(perf_pending_task)
      </IRQ>                                                 </IRQ>
      fput()                                                 fput()
          task_work_add(____fput())                              task_work_add(____fput())

      task_work_run()                                        task_work_run()
          ____fput()                                             ____fput()
              perf_release()                                         perf_release()
                  perf_event_release_kernel()                            perf_event_release_kernel()
                      _free_event()                                          _free_event()
                          perf_pending_task_sync()                               perf_pending_task_sync()
                              rcuwait_wait_event()                                   rcuwait_wait_event()

  Therefore the only option left is to acquire the event reference count
  upon queueing the perf task work and release it from the task work, just
  like it was done before 3a5465418f5f ("perf: Fix event leak upon exec and file release")
  but without the leaks it fixed.

  Some adjustments are necessary to make it work:

  * A child event might dereference its parent upon freeing. Care must be
    taken to release the parent last.

  * Some places assuming the event doesn't have any reference held and
    therefore can be freed right away must instead put the reference and
    let the reference counting to its job.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2025-37747
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/1267bd38f161c1a27d9b722de017027167a225a0
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/56799bc035658738f362acec3e7647bb84e68933
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/665b87b8f8b3aeb49083ef3b65c4953e7753fc12
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/fa1827fa968c0674e9b6fca223fa9fb4da4493eb
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.15:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.15:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-37747
    reference_type:
    reference_id: CVE-2025-37747
