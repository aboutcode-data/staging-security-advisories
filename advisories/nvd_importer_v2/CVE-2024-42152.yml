advisory_id: CVE-2024-42152
datasource_id: nvd_importer_v2/CVE-2024-42152
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-42152
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  nvmet: fix a possible leak when destroy a ctrl during qp establishment

  In nvmet_sq_destroy we capture sq->ctrl early and if it is non-NULL we
  know that a ctrl was allocated (in the admin connect request handler)
  and we need to release pending AERs, clear ctrl->sqs and sq->ctrl
  (for nvme-loop primarily), and drop the final reference on the ctrl.

  However, a small window is possible where nvmet_sq_destroy starts (as
  a result of the client giving up and disconnecting) concurrently with
  the nvme admin connect cmd (which may be in an early stage). But *before*
  kill_and_confirm of sq->ref (i.e. the admin connect managed to get an sq
  live reference). In this case, sq->ctrl was allocated however after it was
  captured in a local variable in nvmet_sq_destroy.
  This prevented the final reference drop on the ctrl.

  Solve this by re-capturing the sq->ctrl after all inflight request has
  completed, where for sure sq->ctrl reference is final, and move forward
  based on that.

  This issue was observed in an environment with many hosts connecting
  multiple ctrls simoutanuosly, creating a delay in allocating a ctrl
  leading up to this race window.
impacted_packages: []
severities:
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-42152
weaknesses:
  - CWE-401
references:
  - url: https://git.kernel.org/stable/c/2f3c22b1d3d7e86712253244797a651998c141fa
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5502c1f1d0d7472706cc1f201aecf1c935d302d1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/818004f2a380420c19872171be716174d4985e33
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/940a71f08ef153ef807f751310b0648d1fa5d0da
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b4fed1443a6571d49c6ffe7d97af3bbe5ee6dff5
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c758b77d4a0a0ed3a1292b3fd7a2aeccd1a169a4
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/01/msg00001.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-42152
    reference_type:
    reference_id: CVE-2024-42152
