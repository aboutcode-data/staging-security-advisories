advisory_id: CVE-2023-53813
datasource_id: nvd_importer_v2/CVE-2023-53813
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2023-53813
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  ext4: fix rbtree traversal bug in ext4_mb_use_preallocated

  During allocations, while looking for preallocations(PA) in the per
  inode rbtree, we can't do a direct traversal of the tree because
  ext4_mb_discard_group_preallocation() can paralelly mark the pa deleted
  and that can cause direct traversal to skip some entries. This was
  leading to a BUG_ON() being hit [1] when we missed a PA that could satisfy
  our request and ultimately tried to create a new PA that would overlap
  with the missed one.

  To makes sure we handle that case while still keeping the performance of
  the rbtree, we make use of the fact that the only pa that could possibly
  overlap the original goal start is the one that satisfies the below
  conditions:

    1. It must have it's logical start immediately to the left of
    (ie less than) original logical start.

    2. It must not be deleted

  To find this pa we use the following traversal method:

  1. Descend into the rbtree normally to find the immediate neighboring
  PA. Here we keep descending irrespective of if the PA is deleted or if
  it overlaps with our request etc. The goal is to find an immediately
  adjacent PA.

  2. If the found PA is on right of original goal, use rb_prev() to find
  the left adjacent PA.

  3. Check if this PA is deleted and keep moving left with rb_prev() until
  a non deleted PA is found.

  4. This is the PA we are looking for. Now we can check if it can satisfy
  the original request and proceed accordingly.

  This approach also takes care of having deleted PAs in the tree.

  (While we are at it, also fix a possible overflow bug in calculating the
  end of a PA)

  [1] https://lore.kernel.org/linux-ext4/CA+G9fYv2FRpLqBZf34ZinR8bU2_ZRAUOjKAD3+tKRFaEQHtt8Q@mail.gmail.com/
impacted_packages: []
severities: []
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/339fee69a1daa71d6f97e47a867e2c32419a2406
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9d3de7ee192a6a253f475197fe4d2e2af10a731f
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-53813
    reference_type:
    reference_id: CVE-2023-53813
