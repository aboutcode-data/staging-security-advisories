advisory_id: CVE-2025-68282
datasource_id: nvd_importer_v2/CVE-2025-68282
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-68282
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  usb: gadget: udc: fix use-after-free in usb_gadget_state_work

  A race condition during gadget teardown can lead to a use-after-free
  in usb_gadget_state_work(), as reported by KASAN:

    BUG: KASAN: invalid-access in sysfs_notify+0x2c/0xd0
    Workqueue: events usb_gadget_state_work

  The fundamental race occurs because a concurrent event (e.g., an
  interrupt) can call usb_gadget_set_state() and schedule gadget->work
  at any time during the cleanup process in usb_del_gadget().

  Commit 399a45e5237c ("usb: gadget: core: flush gadget workqueue after
  device removal") attempted to fix this by moving flush_work() to after
  device_del(). However, this does not fully solve the race, as a new
  work item can still be scheduled *after* flush_work() completes but
  before the gadget's memory is freed, leading to the same use-after-free.

  This patch fixes the race condition robustly by introducing a 'teardown'
  flag and a 'state_lock' spinlock to the usb_gadget struct. The flag is
  set during cleanup in usb_del_gadget() *before* calling flush_work() to
  prevent any new work from being scheduled once cleanup has commenced.
  The scheduling site, usb_gadget_set_state(), now checks this flag under
  the lock before queueing the work, thus safely closing the race window.
impacted_packages: []
severities: []
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/10014310193cf6736c1aeb4105c5f4a0818d0c65
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3b32caa73d135eea8fb9cabb45e9fc64c5a3ecb9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/baeb66fbd4201d1c4325074e78b1f557dff89b5b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c12a0c3ef815ddd67e47f9c819f9fe822fed5467
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/dddc944d65169b552e09cb54e3ed4fbb9ea26416
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/eee16f3ff08e759ea828bdf7dc1c0ef2f22134f5
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f02a412c0a18f02f0f91b0a3d9788315a721b7fd
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-68282
    reference_type:
    reference_id: CVE-2025-68282
