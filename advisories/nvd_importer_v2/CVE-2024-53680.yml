advisory_id: CVE-2024-53680
datasource_id: nvd_importer_v2/CVE-2024-53680
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-53680
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  ipvs: fix UB due to uninitialized stack access in ip_vs_protocol_init()

  Under certain kernel configurations when building with Clang/LLVM, the
  compiler does not generate a return or jump as the terminator
  instruction for ip_vs_protocol_init(), triggering the following objtool
  warning during build time:

    vmlinux.o: warning: objtool: ip_vs_protocol_init() falls through to next function __initstub__kmod_ip_vs_rr__935_123_ip_vs_rr_init6()

  At runtime, this either causes an oops when trying to load the ipvs
  module or a boot-time panic if ipvs is built-in. This same issue has
  been reported by the Intel kernel test robot previously.

  Digging deeper into both LLVM and the kernel code reveals this to be a
  undefined behavior problem. ip_vs_protocol_init() uses a on-stack buffer
  of 64 chars to store the registered protocol names and leaves it
  uninitialized after definition. The function calls strnlen() when
  concatenating protocol names into the buffer. With CONFIG_FORTIFY_SOURCE
  strnlen() performs an extra step to check whether the last byte of the
  input char buffer is a null character (commit 3009f891bb9f ("fortify:
  Allow strlen() and strnlen() to pass compile-time known lengths")).
  This, together with possibly other configurations, cause the following
  IR to be generated:

    define hidden i32 @ip_vs_protocol_init() local_unnamed_addr #5 section ".init.text" align 16 !kcfi_type !29 {
      %1 = alloca [64 x i8], align 16
      ...

    14:                                               ; preds = %11
      %15 = getelementptr inbounds i8, ptr %1, i64 63
      %16 = load i8, ptr %15, align 1
      %17 = tail call i1 @llvm.is.constant.i8(i8 %16)
      %18 = icmp eq i8 %16, 0
      %19 = select i1 %17, i1 %18, i1 false
      br i1 %19, label %20, label %23

    20:                                               ; preds = %14
      %21 = call i64 @strlen(ptr noundef nonnull dereferenceable(1) %1) #23
      ...

    23:                                               ; preds = %14, %11, %20
      %24 = call i64 @strnlen(ptr noundef nonnull dereferenceable(1) %1, i64 noundef 64) #24
      ...
    }

  The above code calculates the address of the last char in the buffer
  (value %15) and then loads from it (value %16). Because the buffer is
  never initialized, the LLVM GVN pass marks value %16 as undefined:

    %13 = getelementptr inbounds i8, ptr %1, i64 63
    br i1 undef, label %14, label %17

  This gives later passes (SCCP, in particular) more DCE opportunities by
  propagating the undef value further, and eventually removes everything
  after the load on the uninitialized stack location:

    define hidden i32 @ip_vs_protocol_init() local_unnamed_addr #0 section ".init.text" align 16 !kcfi_type !11 {
      %1 = alloca [64 x i8], align 16
      ...

    12:                                               ; preds = %11
      %13 = getelementptr inbounds i8, ptr %1, i64 63
      unreachable
    }

  In this way, the generated native code will just fall through to the
  next function, as LLVM does not generate any code for the unreachable IR
  instruction and leaves the function without a terminator.

  Zero the on-stack buffer to avoid this possible UB.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-53680
weaknesses:
  - CWE-908
references:
  - url: https://git.kernel.org/stable/c/0b2cbed82b7c6504a8a0fbd181f92dd56b432c12
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/124834133b32f9386bb2d8581d9ab92f65e951e4
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/146b6f1112eb30a19776d6c323c994e9d67790db
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/31d1ddc1ce8e8d3f101a679243abb42a313ee88a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/48130002e64fd191b7d18efeb4d253fcc23e4688
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/664d0feab92495b6a27edc3d1119e232c0fe8b2b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/d6e1776f51c95827142f1d7064118e255e2deec1
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/03/msg00001.html
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/03/msg00002.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:2.6.12:-:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:2.6.12:-:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:2.6.12:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:2.6.12:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:2.6.12:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:2.6.12:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:2.6.12:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:2.6.12:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:2.6.12:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:2.6.12:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.13:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.13:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-53680
    reference_type:
    reference_id: CVE-2024-53680
