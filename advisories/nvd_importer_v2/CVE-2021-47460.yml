advisory_id: CVE-2021-47460
datasource_id: nvd_importer_v2/CVE-2021-47460
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2021-47460
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  ocfs2: fix data corruption after conversion from inline format

  Commit 6dbf7bb55598 ("fs: Don't invalidate page buffers in
  block_write_full_page()") uncovered a latent bug in ocfs2 conversion
  from inline inode format to a normal inode format.

  The code in ocfs2_convert_inline_data_to_extents() attempts to zero out
  the whole cluster allocated for file data by grabbing, zeroing, and
  dirtying all pages covering this cluster.  However these pages are
  beyond i_size, thus writeback code generally ignores these dirty pages
  and no blocks were ever actually zeroed on the disk.

  This oversight was fixed by commit 693c241a5f6a ("ocfs2: No need to zero
  pages past i_size.") for standard ocfs2 write path, inline conversion
  path was apparently forgotten; the commit log also has a reasoning why
  the zeroing actually is not needed.

  After commit 6dbf7bb55598, things became worse as writeback code stopped
  invalidating buffers on pages beyond i_size and thus these pages end up
  with clean PageDirty bit but with buffers attached to these pages being
  still dirty.  So when a file is converted from inline format, then
  writeback triggers, and then the file is grown so that these pages
  become valid, the invalid dirtiness state is preserved,
  mark_buffer_dirty() does nothing on these pages (buffers are already
  dirty) but page is never written back because it is clean.  So data
  written to these pages is lost once pages are reclaimed.

  Simple reproducer for the problem is:

    xfs_io -f -c "pwrite 0 2000" -c "pwrite 2000 2000" -c "fsync" \
      -c "pwrite 4000 2000" ocfs2_file

  After unmounting and mounting the fs again, you can observe that end of
  'ocfs2_file' has lost its contents.

  Fix the problem by not doing the pointless zeroing during conversion
  from inline format similarly as in the standard write path.

  [akpm@linux-foundation.org: fix whitespace, per Joseph]
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47460
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/5314454ea3ff6fc746eaf71b9a7ceebed52888fa
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/560edd14de2bf9dbc0129681eeb4d5ef87cc105f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/8e6bfb4f70168ddfd32fb6dc028ad52faaf1f32e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a3a089c241cd49b33a8cdd7fcb37cc87a086912a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b05caf023b14cbed9223bb5b48ecc7bffe38f632
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f1b98569e81c37d7e0deada7172f8f60860c1360
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/fa9b6b6c953e3f6441ed6cf83b4c771dac2dae08
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.15:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.15:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.15:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.15:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.15:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.15:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.15:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.15:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.15:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.15:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.15:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.15:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47460
    reference_type:
    reference_id: CVE-2021-47460
