advisory_id: CVE-2024-56640
datasource_id: nvd_importer_v2/CVE-2024-56640
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-56640
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  net/smc: fix LGR and link use-after-free issue

  We encountered a LGR/link use-after-free issue, which manifested as
  the LGR/link refcnt reaching 0 early and entering the clear process,
  making resource access unsafe.

   refcount_t: addition on 0; use-after-free.
   WARNING: CPU: 14 PID: 107447 at lib/refcount.c:25 refcount_warn_saturate+0x9c/0x140
   Workqueue: events smc_lgr_terminate_work [smc]
   Call trace:
    refcount_warn_saturate+0x9c/0x140
    __smc_lgr_terminate.part.45+0x2a8/0x370 [smc]
    smc_lgr_terminate_work+0x28/0x30 [smc]
    process_one_work+0x1b8/0x420
    worker_thread+0x158/0x510
    kthread+0x114/0x118

  or

   refcount_t: underflow; use-after-free.
   WARNING: CPU: 6 PID: 93140 at lib/refcount.c:28 refcount_warn_saturate+0xf0/0x140
   Workqueue: smc_hs_wq smc_listen_work [smc]
   Call trace:
    refcount_warn_saturate+0xf0/0x140
    smcr_link_put+0x1cc/0x1d8 [smc]
    smc_conn_free+0x110/0x1b0 [smc]
    smc_conn_abort+0x50/0x60 [smc]
    smc_listen_find_device+0x75c/0x790 [smc]
    smc_listen_work+0x368/0x8a0 [smc]
    process_one_work+0x1b8/0x420
    worker_thread+0x158/0x510
    kthread+0x114/0x118

  It is caused by repeated release of LGR/link refcnt. One suspect is that
  smc_conn_free() is called repeatedly because some smc_conn_free() from
  server listening path are not protected by sock lock.

  e.g.

  Calls under socklock        | smc_listen_work
  -------------------------------------------------------
  lock_sock(sk)               | smc_conn_abort
  smc_conn_free               | \- smc_conn_free
  \- smcr_link_put            |    \- smcr_link_put (duplicated)
  release_sock(sk)

  So here add sock lock protection in smc_listen_work() path, making it
  exclusive with other connection operations.
impacted_packages: []
severities:
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-56640
weaknesses:
  - CWE-416
references:
  - url: https://git.kernel.org/stable/c/0cf598548a6c36d90681d53c6b77d52363f2f295
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2c7f14ed9c19ec0f149479d1c2842ec1f9bf76d7
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/673d606683ac70bc074ca6676b938bff18635226
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6f0ae06a234a78ae137064f2c89135ac078a00eb
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f502a88fdd415647a1f2dc45fac71b9c522a052b
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/03/msg00001.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.13:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.13:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-56640
    reference_type:
    reference_id: CVE-2024-56640
