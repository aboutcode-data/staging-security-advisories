advisory_id: CVE-2022-49764
datasource_id: nvd_importer_v2/CVE-2022-49764
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2022-49764
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  bpf: Prevent bpf program recursion for raw tracepoint probes

  We got report from sysbot [1] about warnings that were caused by
  bpf program attached to contention_begin raw tracepoint triggering
  the same tracepoint by using bpf_trace_printk helper that takes
  trace_printk_lock lock.

   Call Trace:
    <TASK>
    ? trace_event_raw_event_bpf_trace_printk+0x5f/0x90
    bpf_trace_printk+0x2b/0xe0
    bpf_prog_a9aec6167c091eef_prog+0x1f/0x24
    bpf_trace_run2+0x26/0x90
    native_queued_spin_lock_slowpath+0x1c6/0x2b0
    _raw_spin_lock_irqsave+0x44/0x50
    bpf_trace_printk+0x3f/0xe0
    bpf_prog_a9aec6167c091eef_prog+0x1f/0x24
    bpf_trace_run2+0x26/0x90
    native_queued_spin_lock_slowpath+0x1c6/0x2b0
    _raw_spin_lock_irqsave+0x44/0x50
    bpf_trace_printk+0x3f/0xe0
    bpf_prog_a9aec6167c091eef_prog+0x1f/0x24
    bpf_trace_run2+0x26/0x90
    native_queued_spin_lock_slowpath+0x1c6/0x2b0
    _raw_spin_lock_irqsave+0x44/0x50
    bpf_trace_printk+0x3f/0xe0
    bpf_prog_a9aec6167c091eef_prog+0x1f/0x24
    bpf_trace_run2+0x26/0x90
    native_queued_spin_lock_slowpath+0x1c6/0x2b0
    _raw_spin_lock_irqsave+0x44/0x50
    __unfreeze_partials+0x5b/0x160
    ...

  The can be reproduced by attaching bpf program as raw tracepoint on
  contention_begin tracepoint. The bpf prog calls bpf_trace_printk
  helper. Then by running perf bench the spin lock code is forced to
  take slow path and call contention_begin tracepoint.

  Fixing this by skipping execution of the bpf program if it's
  already running, Using bpf prog 'active' field, which is being
  currently used by trampoline programs for the same reason.

  Moving bpf_prog_inc_misses_counter to syscall.c because
  trampoline.c is compiled in just for CONFIG_BPF_JIT option.

  [1] https://lore.kernel.org/bpf/YxhFe3EwqchC%2FfYf@krava/T/#t
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-49764
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/05b24ff9b2cfabfcfd951daaa915a036ab53c9e1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2e5399879024fedd6cdc41f73fbf9bbe7208f899
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-49764
    reference_type:
    reference_id: CVE-2022-49764
