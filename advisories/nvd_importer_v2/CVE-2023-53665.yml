advisory_id: CVE-2023-53665
datasource_id: nvd_importer_v2/CVE-2023-53665
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2023-53665
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  md: don't dereference mddev after export_rdev()

  Except for initial reference, mddev->kobject is referenced by
  rdev->kobject, and if the last rdev is freed, there is no guarantee that
  mddev is still valid. Hence mddev should not be used anymore after
  export_rdev().

  This problem can be triggered by following test for mdadm at very
  low rate:

  New file: mdadm/tests/23rdev-lifetime

  devname=${dev0##*/}
  devt=`cat /sys/block/$devname/dev`
  pid=""
  runtime=2

  clean_up_test() {
          pill -9 $pid
          echo clear > /sys/block/md0/md/array_state
  }

  trap 'clean_up_test' EXIT

  add_by_sysfs() {
          while true; do
                  echo $devt > /sys/block/md0/md/new_dev
          done
  }

  remove_by_sysfs(){
          while true; do
                  echo remove > /sys/block/md0/md/dev-${devname}/state
          done
  }

  echo md0 > /sys/module/md_mod/parameters/new_array || die "create md0 failed"

  add_by_sysfs &
  pid="$pid $!"

  remove_by_sysfs &
  pid="$pid $!"

  sleep $runtime
  exit 0

  Test cmd:

  ./test --save-logs --logdir=/tmp/ --keep-going --dev=loop --tests=23rdev-lifetime

  Test result:

  general protection fault, probably for non-canonical address 0x6b6b6b6b6b6b6bcb: 0000 [#4] PREEMPT SMP
  CPU: 0 PID: 1292 Comm: test Tainted: G      D W          6.5.0-rc2-00121-g01e55c376936 #562
  RIP: 0010:md_wakeup_thread+0x9e/0x320 [md_mod]
  Call Trace:
   <TASK>
   mddev_unlock+0x1b6/0x310 [md_mod]
   rdev_attr_store+0xec/0x190 [md_mod]
   sysfs_kf_write+0x52/0x70
   kernfs_fop_write_iter+0x19a/0x2a0
   vfs_write+0x3b5/0x770
   ksys_write+0x74/0x150
   __x64_sys_write+0x22/0x30
   do_syscall_64+0x40/0x90
   entry_SYSCALL_64_after_hwframe+0x63/0xcd

  Fix this problem by don't dereference mddev after export_rdev().
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-53665
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/7deac114be5fb25a4e865212ed0feaf5f85f2a28
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ad430ad0669d2757377373390d68e1454fc7a344
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.6:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.6:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-53665
    reference_type:
    reference_id: CVE-2023-53665
