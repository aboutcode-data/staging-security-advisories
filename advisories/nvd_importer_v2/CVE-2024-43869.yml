advisory_id: CVE-2024-43869
datasource_id: nvd_importer_v2/CVE-2024-43869
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-43869
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  perf: Fix event leak upon exec and file release

  The perf pending task work is never waited upon the matching event
  release. In the case of a child event, released via free_event()
  directly, this can potentially result in a leaked event, such as in the
  following scenario that doesn't even require a weak IRQ work
  implementation to trigger:

  schedule()
     prepare_task_switch()
  =======> <NMI>
        perf_event_overflow()
           event->pending_sigtrap = ...
           irq_work_queue(&event->pending_irq)
  <======= </NMI>
        perf_event_task_sched_out()
            event_sched_out()
                event->pending_sigtrap = 0;
                atomic_long_inc_not_zero(&event->refcount)
                task_work_add(&event->pending_task)
     finish_lock_switch()
  =======> <IRQ>
     perf_pending_irq()
        //do nothing, rely on pending task work
  <======= </IRQ>

  begin_new_exec()
     perf_event_exit_task()
        perf_event_exit_event()
           // If is child event
           free_event()
              WARN(atomic_long_cmpxchg(&event->refcount, 1, 0) != 1)
              // event is leaked

  Similar scenarios can also happen with perf_event_remove_on_exec() or
  simply against concurrent perf_event_release().

  Fix this with synchonizing against the possibly remaining pending task
  work while freeing the event, just like is done with remaining pending
  IRQ work. This means that the pending task callback neither need nor
  should hold a reference to the event, preventing it from ever beeing
  freed.
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-43869
weaknesses:
  - CWE-401
references:
  - url: https://git.kernel.org/stable/c/104e258a004037bc7dba9f6085c71dad6af57ad4
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3a5465418f5fd970e86a86c7f4075be262682840
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/9ad46f1fef421d43cdab3a7d1744b2f43b54dae0
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ed2c202dac55423a52d7e2290f2888bf08b8ee99
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f34d8307a73a18de5320fcc6f40403146d061891
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/01/msg00001.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:-:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:-:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.1:rc8:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.1:rc8:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-43869
    reference_type:
    reference_id: CVE-2024-43869
