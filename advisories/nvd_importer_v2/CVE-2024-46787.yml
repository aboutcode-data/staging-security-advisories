advisory_id: CVE-2024-46787
datasource_id: nvd_importer_v2/CVE-2024-46787
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-46787
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  userfaultfd: fix checks for huge PMDs

  Patch series "userfaultfd: fix races around pmd_trans_huge() check", v2.

  The pmd_trans_huge() code in mfill_atomic() is wrong in three different
  ways depending on kernel version:

  1. The pmd_trans_huge() check is racy and can lead to a BUG_ON() (if you hit
     the right two race windows) - I've tested this in a kernel build with
     some extra mdelay() calls. See the commit message for a description
     of the race scenario.
     On older kernels (before 6.5), I think the same bug can even
     theoretically lead to accessing transhuge page contents as a page table
     if you hit the right 5 narrow race windows (I haven't tested this case).
  2. As pointed out by Qi Zheng, pmd_trans_huge() is not sufficient for
     detecting PMDs that don't point to page tables.
     On older kernels (before 6.5), you'd just have to win a single fairly
     wide race to hit this.
     I've tested this on 6.1 stable by racing migration (with a mdelay()
     patched into try_to_migrate()) against UFFDIO_ZEROPAGE - on my x86
     VM, that causes a kernel oops in ptlock_ptr().
  3. On newer kernels (>=6.5), for shmem mappings, khugepaged is allowed
     to yank page tables out from under us (though I haven't tested that),
     so I think the BUG_ON() checks in mfill_atomic() are just wrong.

  I decided to write two separate fixes for these (one fix for bugs 1+2, one
  fix for bug 3), so that the first fix can be backported to kernels
  affected by bugs 1+2.


  This patch (of 2):

  This fixes two issues.

  I discovered that the following race can occur:

    mfill_atomic                other thread
    ============                ============
                                <zap PMD>
    pmdp_get_lockless() [reads none pmd]
    <bail if trans_huge>
    <if none:>
                                <pagefault creates transhuge zeropage>
      __pte_alloc [no-op]
                                <zap PMD>
    <bail if pmd_trans_huge(*dst_pmd)>
    BUG_ON(pmd_none(*dst_pmd))

  I have experimentally verified this in a kernel with extra mdelay() calls;
  the BUG_ON(pmd_none(*dst_pmd)) triggers.

  On kernels newer than commit 0d940a9b270b ("mm/pgtable: allow
  pte_offset_map[_lock]() to fail"), this can't lead to anything worse than
  a BUG_ON(), since the page table access helpers are actually designed to
  deal with page tables concurrently disappearing; but on older kernels
  (<=6.4), I think we could probably theoretically race past the two
  BUG_ON() checks and end up treating a hugepage as a page table.

  The second issue is that, as Qi Zheng pointed out, there are other types
  of huge PMDs that pmd_trans_huge() can't catch: devmap PMDs and swap PMDs
  (in particular, migration PMDs).

  On <=6.4, this is worse than the first issue: If mfill_atomic() runs on a
  PMD that contains a migration entry (which just requires winning a single,
  fairly wide race), it will pass the PMD to pte_offset_map_lock(), which
  assumes that the PMD points to a page table.

  Breakage follows: First, the kernel tries to take the PTE lock (which will
  crash or maybe worse if there is no "struct page" for the address bits in
  the migration entry PMD - I think at least on X86 there usually is no
  corresponding "struct page" thanks to the PTE inversion mitigation, amd64
  looks different).

  If that didn't crash, the kernel would next try to write a PTE into what
  it wrongly thinks is a page table.

  As part of fixing these issues, get rid of the check for pmd_trans_huge()
  before __pte_alloc() - that's redundant, we're going to have to check for
  that after the __pte_alloc() anyway.

  Backport note: pmdp_get_lockless() is pmd_read_atomic() in older kernels.
impacted_packages: []
severities:
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-46787
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/3c6b4bcf37845c9359aed926324bed66bdd2448d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/71c186efc1b2cf1aeabfeff3b9bd5ac4c5ac14d8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/98cc18b1b71e23fe81a5194ed432b20c2d81a01a
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.11:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.11:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-46787
    reference_type:
    reference_id: CVE-2024-46787
