advisory_id: CVE-2022-49398
datasource_id: nvd_importer_v2/CVE-2022-49398
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2022-49398
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  usb: dwc3: gadget: Replace list_for_each_entry_safe() if using giveback

  The list_for_each_entry_safe() macro saves the current item (n) and
  the item after (n+1), so that n can be safely removed without
  corrupting the list.  However, when traversing the list and removing
  items using gadget giveback, the DWC3 lock is briefly released,
  allowing other routines to execute.  There is a situation where, while
  items are being removed from the cancelled_list using
  dwc3_gadget_ep_cleanup_cancelled_requests(), the pullup disable
  routine is running in parallel (due to UDC unbind).  As the cleanup
  routine removes n, and the pullup disable removes n+1, once the
  cleanup retakes the DWC3 lock, it references a request who was already
  removed/handled.  With list debug enabled, this leads to a panic.
  Ensure all instances of the macro are replaced where gadget giveback
  is used.

  Example call stack:

  Thread#1:
  __dwc3_gadget_ep_set_halt() - CLEAR HALT
    -> dwc3_gadget_ep_cleanup_cancelled_requests()
      ->list_for_each_entry_safe()
      ->dwc3_gadget_giveback(n)
        ->dwc3_gadget_del_and_unmap_request()- n deleted[cancelled_list]
        ->spin_unlock
        ->Thread#2 executes
        ...
      ->dwc3_gadget_giveback(n+1)
        ->Already removed!

  Thread#2:
  dwc3_gadget_pullup()
    ->waiting for dwc3 spin_lock
    ...
    ->Thread#1 released lock
    ->dwc3_stop_active_transfers()
      ->dwc3_remove_requests()
        ->fetches n+1 item from cancelled_list (n removed by Thread#1)
        ->dwc3_gadget_giveback()
          ->dwc3_gadget_del_and_unmap_request()- n+1 deleted[cancelled_list]
          ->spin_unlock
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-49398
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/1c6e5dc3b639c96e6839a8d1b8e951923fdfd34a
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2424307cdf421ac72075a1384eae4e4199ab6457
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/26a7e6832afe9d9a991cfd9015177f083cf959cc
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/bf594d1d0c1d7b895954018043536ffd327844f9
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-49398
    reference_type:
    reference_id: CVE-2022-49398
