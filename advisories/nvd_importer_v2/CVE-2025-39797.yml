advisory_id: CVE-2025-39797
datasource_id: nvd_importer_v2/CVE-2025-39797
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-39797
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  xfrm: Duplicate SPI Handling

  The issue originates when Strongswan initiates an XFRM_MSG_ALLOCSPI
  Netlink message, which triggers the kernel function xfrm_alloc_spi().
  This function is expected to ensure uniqueness of the Security Parameter
  Index (SPI) for inbound Security Associations (SAs). However, it can
  return success even when the requested SPI is already in use, leading
  to duplicate SPIs assigned to multiple inbound SAs, differentiated
  only by their destination addresses.

  This behavior causes inconsistencies during SPI lookups for inbound packets.
  Since the lookup may return an arbitrary SA among those with the same SPI,
  packet processing can fail, resulting in packet drops.

  According to RFC 4301 section 4.4.2 , for inbound processing a unicast SA
  is uniquely identified by the SPI and optionally protocol.

  Reproducing the Issue Reliably:
  To consistently reproduce the problem, restrict the available SPI range in
  charon.conf : spi_min = 0x10000000 spi_max = 0x10000002
  This limits the system to only 2 usable SPI values.
  Next, create more than 2 Child SA. each using unique pair of src/dst address.
  As soon as the 3rd Child SA is initiated, it will be assigned a duplicate
  SPI, since the SPI pool is already exhausted.
  With a narrow SPI range, the issue is consistently reproducible.
  With a broader/default range, it becomes rare and unpredictable.

  Current implementation:
  xfrm_spi_hash() lookup function computes hash using daddr, proto, and family.
  So if two SAs have the same SPI but different destination addresses, then
  they will:
  a. Hash into different buckets
  b. Be stored in different linked lists (byspi + h)
  c. Not be seen in the same hlist_for_each_entry_rcu() iteration.
  As a result, the lookup will result in NULL and kernel allows that Duplicate SPI

  Proposed Change:
  xfrm_state_lookup_spi_proto() does a truly global search - across all states,
  regardless of hash bucket and matches SPI and proto.
impacted_packages: []
severities:
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2025-39797
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/29e9158f91f99057dbd35db5e8674d93b38549fe
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/2fc5b54368a1bf1d2d74b4d3b8eea5309a653e38
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3d8090bb53424432fa788fe9a49e8ceca74f0544
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/94f39804d891cffe4ce17737d295f3b195bc7299
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c67d4e7a8f90fb6361ca89d4d5c9a28f4e935e47
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-39797
    reference_type:
    reference_id: CVE-2025-39797
