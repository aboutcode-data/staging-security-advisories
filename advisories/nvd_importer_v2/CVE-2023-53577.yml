advisory_id: CVE-2023-53577
datasource_id: nvd_importer_v2/CVE-2023-53577
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2023-53577
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  bpf, cpumap: Make sure kthread is running before map update returns

  The following warning was reported when running stress-mode enabled
  xdp_redirect_cpu with some RT threads:

    ------------[ cut here ]------------
    WARNING: CPU: 4 PID: 65 at kernel/bpf/cpumap.c:135
    CPU: 4 PID: 65 Comm: kworker/4:1 Not tainted 6.5.0-rc2+ #1
    Hardware name: QEMU Standard PC (i440FX + PIIX, 1996)
    Workqueue: events cpu_map_kthread_stop
    RIP: 0010:put_cpu_map_entry+0xda/0x220
    ......
    Call Trace:
     <TASK>
     ? show_regs+0x65/0x70
     ? __warn+0xa5/0x240
     ......
     ? put_cpu_map_entry+0xda/0x220
     cpu_map_kthread_stop+0x41/0x60
     process_one_work+0x6b0/0xb80
     worker_thread+0x96/0x720
     kthread+0x1a5/0x1f0
     ret_from_fork+0x3a/0x70
     ret_from_fork_asm+0x1b/0x30
     </TASK>

  The root cause is the same as commit 436901649731 ("bpf: cpumap: Fix memory
  leak in cpu_map_update_elem"). The kthread is stopped prematurely by
  kthread_stop() in cpu_map_kthread_stop(), and kthread() doesn't call
  cpu_map_kthread_run() at all but XDP program has already queued some
  frames or skbs into ptr_ring. So when __cpu_map_ring_cleanup() checks
  the ptr_ring, it will find it was not emptied and report a warning.

  An alternative fix is to use __cpu_map_ring_cleanup() to drop these
  pending frames or skbs when kthread_stop() returns -EINTR, but it may
  confuse the user, because these frames or skbs have been handled
  correctly by XDP program. So instead of dropping these frames or skbs,
  just make sure the per-cpu kthread is running before
  __cpu_map_entry_alloc() returns.

  After apply the fix, the error handle for kthread_stop() will be
  unnecessary because it will always return 0, so just remove it.
impacted_packages: []
severities:
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2023-53577
weaknesses:
  - CWE-401
references:
  - url: https://git.kernel.org/stable/c/640a604585aa30f93e39b17d4d6ba69fcb1e66c9
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7a1178a3671b40746830d355836b72e47ceb2490
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b44d28b98f185d2f2348aa3c3636838c316f889e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ecb45b852af5e88257020b88bea5ff0798d72aca
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.5:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.5:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-53577
    reference_type:
    reference_id: CVE-2023-53577
