advisory_id: CVE-2025-40256
datasource_id: nvd_importer_v2/CVE-2025-40256
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-40256
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  xfrm: also call xfrm_state_delete_tunnel at destroy time for states that were never added

  In commit b441cf3f8c4b ("xfrm: delete x->tunnel as we delete x"), I
  missed the case where state creation fails between full
  initialization (->init_state has been called) and being inserted on
  the lists.

  In this situation, ->init_state has been called, so for IPcomp
  tunnels, the fallback tunnel has been created and added onto the
  lists, but the user state never gets added, because we fail before
  that. The user state doesn't go through __xfrm_state_delete, so we
  don't call xfrm_state_delete_tunnel for those states, and we end up
  leaking the FB tunnel.

  There are several codepaths affected by this: the add/update paths, in
  both net/key and xfrm, and the migrate code (xfrm_migrate,
  xfrm_state_migrate). A "proper" rollback of the init_state work would
  probably be doable in the add/update code, but for migrate it gets
  more complicated as multiple states may be involved.

  At some point, the new (not-inserted) state will be destroyed, so call
  xfrm_state_delete_tunnel during xfrm_state_gc_destroy. Most states
  will have their fallback tunnel cleaned up during __xfrm_state_delete,
  which solves the issue that b441cf3f8c4b (and other patches before it)
  aimed at. All states (including FB tunnels) will be removed from the
  lists once xfrm_state_fini has called flush_work(&xfrm_state_gc_work).
impacted_packages: []
severities: []
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/10deb69864840ccf96b00ac2ab3a2055c0c04721
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/1dad653643f28ccc89be93f9440b8804cded85b2
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/57b72d74d4651dc19d046308a8304eb9abfe66ac
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/64441724387b4ac92f67ef51caaaeffe99c950d1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/763e5c351206c1e4d910db4a1159053f6263689c
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/d6fe5c740c573af10943b8353992e1325cdb2715
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f7d879c19d306512c2e260f37e8a3e5c85e37c50
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-40256
    reference_type:
    reference_id: CVE-2025-40256
