advisory_id: CVE-2023-53756
datasource_id: nvd_importer_v2/CVE-2023-53756
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2023-53756
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  KVM: VMX: Fix crash due to uninitialized current_vmcs

  KVM enables 'Enlightened VMCS' and 'Enlightened MSR Bitmap' when running as
  a nested hypervisor on top of Hyper-V. When MSR bitmap is updated,
  evmcs_touch_msr_bitmap function uses current_vmcs per-cpu variable to mark
  that the msr bitmap was changed.

  vmx_vcpu_create() modifies the msr bitmap via vmx_disable_intercept_for_msr
  -> vmx_msr_bitmap_l01_changed which in the end calls this function. The
  function checks for current_vmcs if it is null but the check is
  insufficient because current_vmcs is not initialized. Because of this, the
  code might incorrectly write to the structure pointed by current_vmcs value
  left by another task. Preemption is not disabled, the current task can be
  preempted and moved to another CPU while current_vmcs is accessed multiple
  times from evmcs_touch_msr_bitmap() which leads to crash.

  The manipulation of MSR bitmaps by callers happens only for vmcs01 so the
  solution is to use vmx->vmcs01.vmcs instead of current_vmcs.

    BUG: kernel NULL pointer dereference, address: 0000000000000338
    PGD 4e1775067 P4D 0
    Oops: 0002 [#1] PREEMPT SMP NOPTI
    ...
    RIP: 0010:vmx_msr_bitmap_l01_changed+0x39/0x50 [kvm_intel]
    ...
    Call Trace:
     vmx_disable_intercept_for_msr+0x36/0x260 [kvm_intel]
     vmx_vcpu_create+0xe6/0x540 [kvm_intel]
     kvm_arch_vcpu_create+0x1d1/0x2e0 [kvm]
     kvm_vm_ioctl_create_vcpu+0x178/0x430 [kvm]
     kvm_vm_ioctl+0x53f/0x790 [kvm]
     __x64_sys_ioctl+0x8a/0xc0
     do_syscall_64+0x5c/0x90
     entry_SYSCALL_64_after_hwframe+0x63/0xcd
impacted_packages: []
severities: []
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/3ba95cc671c025d0d2a1c7d5e2930f0ff0980cf4
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6baebcecf09acd19e2bab1c2911dcdba5d48a1dc
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/6e7bc50f97c9855da83f1478f722590defd45ff2
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/93827a0a36396f2fd6368a54a020f420c8916e9b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b2de2b4d4e007f9add46ea8dc06f781835e3ea9f
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2023-53756
    reference_type:
    reference_id: CVE-2023-53756
