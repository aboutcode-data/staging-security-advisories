advisory_id: CVE-2024-41045
datasource_id: nvd_importer_v2/CVE-2024-41045
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-41045
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  bpf: Defer work in bpf_timer_cancel_and_free

  Currently, the same case as previous patch (two timer callbacks trying
  to cancel each other) can be invoked through bpf_map_update_elem as
  well, or more precisely, freeing map elements containing timers. Since
  this relies on hrtimer_cancel as well, it is prone to the same deadlock
  situation as the previous patch.

  It would be sufficient to use hrtimer_try_to_cancel to fix this problem,
  as the timer cannot be enqueued after async_cancel_and_free. Once
  async_cancel_and_free has been done, the timer must be reinitialized
  before it can be armed again. The callback running in parallel trying to
  arm the timer will fail, and freeing bpf_hrtimer without waiting is
  sufficient (given kfree_rcu), and bpf_timer_cb will return
  HRTIMER_NORESTART, preventing the timer from being rearmed again.

  However, there exists a UAF scenario where the callback arms the timer
  before entering this function, such that if cancellation fails (due to
  timer callback invoking this routine, or the target timer callback
  running concurrently). In such a case, if the timer expiration is
  significantly far in the future, the RCU grace period expiration
  happening before it will free the bpf_hrtimer state and along with it
  the struct hrtimer, that is enqueued.

  Hence, it is clear cancellation needs to occur after
  async_cancel_and_free, and yet it cannot be done inline due to deadlock
  issues. We thus modify bpf_timer_cancel_and_free to defer work to the
  global workqueue, adding a work_struct alongside rcu_head (both used at
  _different_ points of time, so can share space).

  Update existing code comments to reflect the new state of affairs.
impacted_packages: []
severities:
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-41045
weaknesses:
  - CWE-416
references:
  - url: https://git.kernel.org/stable/c/7aa5a19279c3639ae8b758b63f05d0c616a39fa1
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a6fcd19d7eac1335eb76bc16b6a66b7f574d1d69
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc6:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc6:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.10:rc7:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.10:rc7:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-41045
    reference_type:
    reference_id: CVE-2024-41045
