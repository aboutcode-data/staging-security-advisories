advisory_id: CVE-2025-39759
datasource_id: nvd_importer_v2/CVE-2025-39759
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-39759
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: qgroup: fix race between quota disable and quota rescan ioctl

  There's a race between a task disabling quotas and another running the
  rescan ioctl that can result in a use-after-free of qgroup records from
  the fs_info->qgroup_tree rbtree.

  This happens as follows:

  1) Task A enters btrfs_ioctl_quota_rescan() -> btrfs_qgroup_rescan();

  2) Task B enters btrfs_quota_disable() and calls
     btrfs_qgroup_wait_for_completion(), which does nothing because at that
     point fs_info->qgroup_rescan_running is false (it wasn't set yet by
     task A);

  3) Task B calls btrfs_free_qgroup_config() which starts freeing qgroups
     from fs_info->qgroup_tree without taking the lock fs_info->qgroup_lock;

  4) Task A enters qgroup_rescan_zero_tracking() which starts iterating
     the fs_info->qgroup_tree tree while holding fs_info->qgroup_lock,
     but task B is freeing qgroup records from that tree without holding
     the lock, resulting in a use-after-free.

  Fix this by taking fs_info->qgroup_lock at btrfs_free_qgroup_config().
  Also at btrfs_qgroup_rescan() don't start the rescan worker if quotas
  were already disabled.
impacted_packages: []
severities:
  - score: '7.0'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2025-39759
weaknesses:
  - CWE-362
references:
  - url: https://git.kernel.org/stable/c/2fd0f5ceb997f90f4332ccbab6c7e907e6b2d0eb
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/7cda0fdde5d9890976861421d207870500f9aace
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/b172535ccba12f0cf7d23b3b840989de47fc104d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c38028ce0d0045ca600b6a8345a0ff92bfb47b66
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/dd0b28d877b293b1d7f8727a7de08ae36b6b9ef0
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/e1249667750399a48cafcf5945761d39fa584edf
    reference_type:
    reference_id:
  - url: https://lists.debian.org/debian-lts-announce/2025/10/msg00008.html
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:debian:debian_linux:11.0:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:debian:debian_linux:11.0:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-39759
    reference_type:
    reference_id: CVE-2025-39759
