advisory_id: CVE-2022-49414
datasource_id: nvd_importer_v2/CVE-2022-49414
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2022-49414
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  ext4: fix race condition between ext4_write and ext4_convert_inline_data

  Hulk Robot reported a BUG_ON:
   ==================================================================
   EXT4-fs error (device loop3): ext4_mb_generate_buddy:805: group 0,
   block bitmap and bg descriptor inconsistent: 25 vs 31513 free clusters
   kernel BUG at fs/ext4/ext4_jbd2.c:53!
   invalid opcode: 0000 [#1] SMP KASAN PTI
   CPU: 0 PID: 25371 Comm: syz-executor.3 Not tainted 5.10.0+ #1
   RIP: 0010:ext4_put_nojournal fs/ext4/ext4_jbd2.c:53 [inline]
   RIP: 0010:__ext4_journal_stop+0x10e/0x110 fs/ext4/ext4_jbd2.c:116
   [...]
   Call Trace:
    ext4_write_inline_data_end+0x59a/0x730 fs/ext4/inline.c:795
    generic_perform_write+0x279/0x3c0 mm/filemap.c:3344
    ext4_buffered_write_iter+0x2e3/0x3d0 fs/ext4/file.c:270
    ext4_file_write_iter+0x30a/0x11c0 fs/ext4/file.c:520
    do_iter_readv_writev+0x339/0x3c0 fs/read_write.c:732
    do_iter_write+0x107/0x430 fs/read_write.c:861
    vfs_writev fs/read_write.c:934 [inline]
    do_pwritev+0x1e5/0x380 fs/read_write.c:1031
   [...]
   ==================================================================

  Above issue may happen as follows:
             cpu1                     cpu2
  __________________________|__________________________
  do_pwritev
   vfs_writev
    do_iter_write
     ext4_file_write_iter
      ext4_buffered_write_iter
       generic_perform_write
        ext4_da_write_begin
                             vfs_fallocate
                              ext4_fallocate
                               ext4_convert_inline_data
                                ext4_convert_inline_data_nolock
                                 ext4_destroy_inline_data_nolock
                                  clear EXT4_STATE_MAY_INLINE_DATA
                                 ext4_map_blocks
                                  ext4_ext_map_blocks
                                   ext4_mb_new_blocks
                                    ext4_mb_regular_allocator
                                     ext4_mb_good_group_nolock
                                      ext4_mb_init_group
                                       ext4_mb_init_cache
                                        ext4_mb_generate_buddy  --> error
         ext4_test_inode_state(inode, EXT4_STATE_MAY_INLINE_DATA)
                                  ext4_restore_inline_data
                                   set EXT4_STATE_MAY_INLINE_DATA
         ext4_block_write_begin
        ext4_da_write_end
         ext4_test_inode_state(inode, EXT4_STATE_MAY_INLINE_DATA)
         ext4_write_inline_data_end
          handle=NULL
          ext4_journal_stop(handle)
           __ext4_journal_stop
            ext4_put_nojournal(handle)
             ref_cnt = (unsigned long)handle
             BUG_ON(ref_cnt == 0)  ---> BUG_ON

  The lock held by ext4_convert_inline_data is xattr_sem, but the lock
  held by generic_perform_write is i_rwsem. Therefore, the two locks can
  be concurrent.

  To solve above issue, we add inode_lock() for ext4_convert_inline_data().
  At the same time, move ext4_convert_inline_data() in front of
  ext4_punch_hole(), remove similar handling from ext4_punch_hole().
impacted_packages: []
severities:
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2022-49414
weaknesses:
  - CWE-362
references:
  - url: https://git.kernel.org/stable/c/14602353b350950b551eccc6b46411aa3b12ffe2
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/18881d7e517169193d9ef6c89c7f322e3e164277
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/725e00cb7039eae291890f1bb19bc867176745f6
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/91f90b571f1a23f5b8a9c2b68a9aa5d6981a3c3d
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/ccc6639f831bee91aa8b41c8a1cdd020ecfb9f32
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f87c7a4b084afc13190cbb263538e444cb2b392a
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-49414
    reference_type:
    reference_id: CVE-2022-49414
