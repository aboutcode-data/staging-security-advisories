advisory_id: CVE-2021-47272
datasource_id: nvd_importer_v2/CVE-2021-47272
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2021-47272
aliases: []
summary: "In the Linux kernel, the following vulnerability has been resolved:\n\nusb: dwc3:\
  \ gadget: Bail from dwc3_gadget_exit() if dwc->gadget is NULL\n\nThere exists a possible scenario\
  \ in which dwc3_gadget_init() can fail:\nduring during host -> peripheral mode switch in dwc3_set_mode(),\
  \ and\na pending gadget driver fails to bind.  Then, if the DRD undergoes\nanother mode switch\
  \ from peripheral->host the resulting\ndwc3_gadget_exit() will attempt to reference an invalid\
  \ and dangling\ndwc->gadget pointer as well as call dma_free_coherent() on unmapped\nDMA pointers.\n\
  \nThe exact scenario can be reproduced as follows:\n - Start DWC3 in peripheral mode\n - Configure\
  \ ConfigFS gadget with FunctionFS instance (or use g_ffs)\n - Run FunctionFS userspace application\
  \ (open EPs, write descriptors, etc)\n - Bind gadget driver to DWC3's UDC\n - Switch DWC3\
  \ to host mode\n   => dwc3_gadget_exit() is called. usb_del_gadget() will put the\n\tConfigFS\
  \ driver instance on the gadget_driver_pending_list\n - Stop FunctionFS application (closes\
  \ the ep files)\n - Switch DWC3 to peripheral mode\n   => dwc3_gadget_init() fails as usb_add_gadget()\
  \ calls\n\tcheck_pending_gadget_drivers() and attempts to rebind the UDC\n\tto the ConfigFS\
  \ gadget but fails with -19 (-ENODEV) because the\n\tFFS instance is not in FFS_ACTIVE state\
  \ (userspace has not\n\tre-opened and written the descriptors yet, i.e. desc_ready!=0).\n\
  \ - Switch DWC3 back to host mode\n   => dwc3_gadget_exit() is called again, but this time\
  \ dwc->gadget\n\tis invalid.\n\nAlthough it can be argued that userspace should take responsibility\n\
  for ensuring that the FunctionFS application be ready prior to\nallowing the composite driver\
  \ bind to the UDC, failure to do so\nshould not result in a panic from the kernel driver.\n\
  \nFix this by setting dwc->gadget to NULL in the failure path of\ndwc3_gadget_init() and add\
  \ a check to dwc3_gadget_exit() to bail out\nunless the gadget pointer is valid."
impacted_packages: []
severities:
  - score: '5.5'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47272
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/03715ea2e3dbbc56947137ce3b4ac18a726b2f87
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/4aad390363d2b9b3e92428dd34d27bb7ea8f1ee8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/851dee5a5da56564a70290713aee665403bb0b24
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.13:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.13:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47272
    reference_type:
    reference_id: CVE-2021-47272
