advisory_id: CVE-2021-47634
datasource_id: nvd_importer_v2/CVE-2021-47634
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2021-47634
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  ubi: Fix race condition between ctrl_cdev_ioctl and ubi_cdev_ioctl

  Hulk Robot reported a KASAN report about use-after-free:
   ==================================================================
   BUG: KASAN: use-after-free in __list_del_entry_valid+0x13d/0x160
   Read of size 8 at addr ffff888035e37d98 by task ubiattach/1385
   [...]
   Call Trace:
    klist_dec_and_del+0xa7/0x4a0
    klist_put+0xc7/0x1a0
    device_del+0x4d4/0xed0
    cdev_device_del+0x1a/0x80
    ubi_attach_mtd_dev+0x2951/0x34b0 [ubi]
    ctrl_cdev_ioctl+0x286/0x2f0 [ubi]

   Allocated by task 1414:
    device_add+0x60a/0x18b0
    cdev_device_add+0x103/0x170
    ubi_create_volume+0x1118/0x1a10 [ubi]
    ubi_cdev_ioctl+0xb7f/0x1ba0 [ubi]

   Freed by task 1385:
    cdev_device_del+0x1a/0x80
    ubi_remove_volume+0x438/0x6c0 [ubi]
    ubi_cdev_ioctl+0xbf4/0x1ba0 [ubi]
   [...]
   ==================================================================

  The lock held by ctrl_cdev_ioctl is ubi_devices_mutex, but the lock held
  by ubi_cdev_ioctl is ubi->device_mutex. Therefore, the two locks can be
  concurrent.

  ctrl_cdev_ioctl contains two operations: ubi_attach and ubi_detach.
  ubi_detach is bug-free because it uses reference counting to prevent
  concurrency. However, uif_init and uif_close in ubi_attach may race with
  ubi_cdev_ioctl.

  uif_init will race with ubi_cdev_ioctl as in the following stack.
             cpu1                   cpu2                  cpu3
  _______________________|________________________|______________________
  ctrl_cdev_ioctl
   ubi_attach_mtd_dev
    uif_init
                             ubi_cdev_ioctl
                              ubi_create_volume
                               cdev_device_add
     ubi_add_volume
     // sysfs exist
     kill_volumes
                                                      ubi_cdev_ioctl
                                                       ubi_remove_volume
                                                        cdev_device_del
                                                         // first free
      ubi_free_volume
       cdev_del
       // double free
     cdev_device_del

  And uif_close will race with ubi_cdev_ioctl as in the following stack.
             cpu1                   cpu2                  cpu3
  _______________________|________________________|______________________
  ctrl_cdev_ioctl
   ubi_attach_mtd_dev
    uif_init
                             ubi_cdev_ioctl
                              ubi_create_volume
                               cdev_device_add
    ubi_debugfs_init_dev
    //error goto out_uif;
    uif_close
     kill_volumes
                                                      ubi_cdev_ioctl
                                                       ubi_remove_volume
                                                        cdev_device_del
                                                         // first free
      ubi_free_volume
      // double free

  The cause of this problem is that commit 714fb87e8bc0 make device
  "available" before it becomes accessible via sysfs. Therefore, we
  roll back the modification. We will fix the race condition between
  ubi device creation and udev by removing ubi_get_device in
  vol_attribute_show and dev_attribute_show.This avoids accessing
  uninitialized ubi_devices[ubi_num].

  ubi_get_device is used to prevent devices from being deleted during
  sysfs execution. However, now kernfs ensures that devices will not
  be deleted before all reference counting are released.
  The key process is shown in the following stack.

  device_del
    device_remove_attrs
      device_remove_groups
        sysfs_remove_groups
          sysfs_remove_group
            remove_files
              kernfs_remove_by_name
                kernfs_remove_by_name_ns
                  __kernfs_remove
                    kernfs_drain
impacted_packages: []
severities:
  - score: '7.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47634
weaknesses:
  - CWE-416
references:
  - url: https://git.kernel.org/stable/c/1a3f1cf87054833242fcd0218de0481cf855f888
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/3cbf0e392f173ba0ce425968c8374a6aa3e90f2e
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/432b057f8e847ae5a2306515606f8d2defaca178
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/5f9e9c223e48c264241d2f34d0bfc29e5fcb5c1b
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a8ecee49259f8f78d91ddb329ab2be7e6fd01974
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/c32fe764191b8ae8b128588beb96e3718d9179d8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/d727fd32cbd1abf3465f607021bc9c746f17b5a8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f149b1bd213820363731aa119e5011ca892a2aac
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47634
    reference_type:
    reference_id: CVE-2021-47634
