advisory_id: CVE-2021-32629
datasource_id: nvd_importer_v2/CVE-2021-32629
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2021-32629
aliases: []
summary: 'Cranelift is an open-source code generator maintained by Bytecode Alliance. It translates
  a target-independent intermediate representation into executable machine code. There is a
  bug in 0.73 of the Cranelift x64 backend that can create a scenario that could result in a
  potential sandbox escape in a Wasm program. This bug was introduced in the new backend on
  2020-09-08 and first included in a release on 2020-09-30, but the new backend was not the
  default prior to 0.73. The recently-released version 0.73 with default settings, and prior
  versions with an explicit build flag to select the new backend, are vulnerable. The bug in
  question performs a sign-extend instead of a zero-extend on a value loaded from the stack,
  under a specific set of circumstances. If those circumstances occur, the bug could allow access
  to memory addresses upto 2GiB before the start of the Wasm program heap. If the heap bound
  is larger than 2GiB, then it would be possible to read memory from a computable range dependent
  on the size of the heaps bound. The impact of this bug is highly dependent on heap implementation,
  specifically: * if the heap has bounds checks, and * does not rely exclusively on guard pages,
  and * the heap bound is 2GiB or smaller * then this bug cannot be used to reach memory from
  another Wasm program heap. The impact of the vulnerability is mitigated if there is no memory
  mapped in the range accessible using this bug, for example, if there is a 2 GiB guard region
  before the Wasm program heap. The bug in question performs a sign-extend instead of a zero-extend
  on a value loaded from the stack, when the register allocator reloads a spilled integer value
  narrower than 64 bits. This interacts poorly with another optimization: the instruction selector
  elides a 32-to-64-bit zero-extend operator when we know that an instruction producing a 32-bit
  value actually zeros the upper 32 bits of its destination register. Hence, we rely on these
  zeroed bits, but the type of the value is still i32, and the spill/reload reconstitutes those
  bits as the sign extension of the i32’s MSB. The issue would thus occur when: * An i32 value
  in a Wasm program is greater than or equal to 0x8000_0000; * The value is spilled and reloaded
  by the register allocator due to high register pressure in the program between the value’s
  definition and its use; * The value is produced by an instruction that we know to be “special”
  in that it zeroes the upper 32 bits of its destination: add, sub, mul, and, or; * The value
  is then zero-extended to 64 bits in the Wasm program; * The resulting 64-bit value is used.
  Under these circumstances there is a potential sandbox escape when the i32 value is a pointer.
  The usual code emitted for heap accesses zero-extends the Wasm heap address, adds it to a
  64-bit heap base, and accesses the resulting address. If the zero-extend becomes a sign-extend,
  the program could reach backward and access memory up to 2GiB before the start of its heap.
  In addition to assessing the nature of the code generation bug in Cranelift, we have also
  determined that under specific circumstances, both Lucet and Wasmtime using this version of
  Cranelift may be exploitable. See referenced GitHub Advisory for more details.'
impacted_packages: []
severities:
  - score: '4.6'
    scoring_system: cvssv2
    scoring_elements: AV:L/AC:L/Au:N/C:P/I:P/A:P
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-32629
  - score: '7.2'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:R/S:C/C:H/I:H/A:N
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-32629
  - score: '8.8'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-32629
weaknesses:
  - CWE-681
  - CWE-125
  - CWE-788
references:
  - url: https://crates.io/crates/cranelift-codegen
    reference_type:
    reference_id:
  - url: https://github.com/bytecodealliance/wasmtime/commit/95559c01aaa7c061088a433040f31e8291fb09d0
    reference_type:
    reference_id:
  - url: https://github.com/bytecodealliance/wasmtime/security/advisories/GHSA-hpqh-2wqx-7qp5
    reference_type:
    reference_id:
  - url: https://www.fastly.com/security-advisories/memory-access-due-to-code-generation-flaw-in-cranelift-module
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:a:bytecodealliance:cranelift-codegen:*:*:*:*:*:rust:*:*
    reference_type:
    reference_id: cpe:2.3:a:bytecodealliance:cranelift-codegen:*:*:*:*:*:rust:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-32629
    reference_type:
    reference_id: CVE-2021-32629
