advisory_id: CVE-2025-40209
datasource_id: nvd_importer_v2/CVE-2025-40209
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2025-40209
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  btrfs: fix memory leak of qgroup_list in btrfs_add_qgroup_relation

  When btrfs_add_qgroup_relation() is called with invalid qgroup levels
  (src >= dst), the function returns -EINVAL directly without freeing the
  preallocated qgroup_list structure passed by the caller. This causes a
  memory leak because the caller unconditionally sets the pointer to NULL
  after the call, preventing any cleanup.

  The issue occurs because the level validation check happens before the
  mutex is acquired and before any error handling path that would free
  the prealloc pointer. On this early return, the cleanup code at the
  'out' label (which includes kfree(prealloc)) is never reached.

  In btrfs_ioctl_qgroup_assign(), the code pattern is:

      prealloc = kzalloc(sizeof(*prealloc), GFP_KERNEL);
      ret = btrfs_add_qgroup_relation(trans, sa->src, sa->dst, prealloc);
      prealloc = NULL;  // Always set to NULL regardless of return value
      ...
      kfree(prealloc);  // This becomes kfree(NULL), does nothing

  When the level check fails, 'prealloc' is never freed by either the
  callee or the caller, resulting in a 64-byte memory leak per failed
  operation. This can be triggered repeatedly by an unprivileged user
  with access to a writable btrfs mount, potentially exhausting kernel
  memory.

  Fix this by freeing prealloc before the early return, ensuring prealloc
  is always freed on all error paths.
impacted_packages: []
severities: []
weaknesses: []
references:
  - url: https://git.kernel.org/stable/c/3412d0e973e8f8381747d69033eda809a57a2581
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a4d9ebe23bcb79d9d057e3c995db73b7b3aae414
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f260c6aff0b8af236084012d14f9f1bf792ea883
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2025-40209
    reference_type:
    reference_id: CVE-2025-40209
