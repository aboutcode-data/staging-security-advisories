advisory_id: CVE-2024-50220
datasource_id: nvd_importer_v2/CVE-2024-50220
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2024-50220
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  fork: do not invoke uffd on fork if error occurs

  Patch series "fork: do not expose incomplete mm on fork".

  During fork we may place the virtual memory address space into an
  inconsistent state before the fork operation is complete.

  In addition, we may encounter an error during the fork operation that
  indicates that the virtual memory address space is invalidated.

  As a result, we should not be exposing it in any way to external machinery
  that might interact with the mm or VMAs, machinery that is not designed to
  deal with incomplete state.

  We specifically update the fork logic to defer khugepaged and ksm to the
  end of the operation and only to be invoked if no error arose, and
  disallow uffd from observing fork events should an error have occurred.


  This patch (of 2):

  Currently on fork we expose the virtual address space of a process to
  userland unconditionally if uffd is registered in VMAs, regardless of
  whether an error arose in the fork.

  This is performed in dup_userfaultfd_complete() which is invoked
  unconditionally, and performs two duties - invoking registered handlers
  for the UFFD_EVENT_FORK event via dup_fctx(), and clearing down
  userfaultfd_fork_ctx objects established in dup_userfaultfd().

  This is problematic, because the virtual address space may not yet be
  correctly initialised if an error arose.

  The change in commit d24062914837 ("fork: use __mt_dup() to duplicate
  maple tree in dup_mmap()") makes this more pertinent as we may be in a
  state where entries in the maple tree are not yet consistent.

  We address this by, on fork error, ensuring that we roll back state that
  we would otherwise expect to clean up through the event being handled by
  userland and perform the memory freeing duty otherwise performed by
  dup_userfaultfd_complete().

  We do this by implementing a new function, dup_userfaultfd_fail(), which
  performs the same loop, only decrementing reference counts.

  Note that we perform mmgrab() on the parent and child mm's, however
  userfaultfd_ctx_put() will mmdrop() this once the reference count drops to
  zero, so we will avoid memory leaks correctly here.
impacted_packages: []
severities:
  - score: '4.7'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:H/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2024-50220
weaknesses:
  - CWE-367
references:
  - url: https://git.kernel.org/stable/c/92b472945dbf8abc020e9259c0088026f7027dfc
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/f64e67e5d3a45a4a04286c47afade4b518acd47b
    reference_type:
    reference_id:
  - url: https://project-zero.issues.chromium.org/issues/373391951
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc2:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc3:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc4:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc4:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:6.12:rc5:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:6.12:rc5:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-50220
    reference_type:
    reference_id: CVE-2024-50220
