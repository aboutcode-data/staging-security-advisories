advisory_id: CVE-2021-47192
datasource_id: nvd_importer_v2/CVE-2021-47192
datasource_url: https://nvd.nist.gov/vuln/detail/CVE-2021-47192
aliases: []
summary: |
  In the Linux kernel, the following vulnerability has been resolved:

  scsi: core: sysfs: Fix hang when device state is set via sysfs

  This fixes a regression added with:

  commit f0f82e2476f6 ("scsi: core: Fix capacity set to zero after
  offlinining device")

  The problem is that after iSCSI recovery, iscsid will call into the kernel
  to set the dev's state to running, and with that patch we now call
  scsi_rescan_device() with the state_mutex held. If the SCSI error handler
  thread is just starting to test the device in scsi_send_eh_cmnd() then it's
  going to try to grab the state_mutex.

  We are then stuck, because when scsi_rescan_device() tries to send its I/O
  scsi_queue_rq() calls -> scsi_host_queue_ready() -> scsi_host_in_recovery()
  which will return true (the host state is still in recovery) and I/O will
  just be requeued. scsi_send_eh_cmnd() will then never be able to grab the
  state_mutex to finish error handling.

  To prevent the deadlock move the rescan-related code to after we drop the
  state_mutex.

  This also adds a check for if we are already in the running state. This
  prevents extra scans and helps the iscsid case where if the transport class
  has already onlined the device during its recovery process then we don't
  need userspace to do it again plus possibly block that daemon.
impacted_packages: []
severities:
  - score: '5.3'
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:L/I:N/A:N
    published_at: None
    url: https://nvd.nist.gov/vuln/detail/CVE-2021-47192
weaknesses:
  - CWE-667
references:
  - url: https://git.kernel.org/stable/c/4edd8cd4e86dd3047e5294bbefcc0a08f66a430f
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/a792e0128d232251edb5fdf42fb0f9fbb0b44a73
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/bcc0e3175a976b7fa9a353960808adb0bb49ead8
    reference_type:
    reference_id:
  - url: https://git.kernel.org/stable/c/edd783162bf2385b43de6764f2d4c6e9f4f6be27
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:*:*:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/search/results?adv_search=true&isCpeNameSearch=true&query=cpe:2.3:o:linux:linux_kernel:5.16:rc1:*:*:*:*:*:*
    reference_type:
    reference_id: cpe:2.3:o:linux:linux_kernel:5.16:rc1:*:*:*:*:*:*
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-47192
    reference_type:
    reference_id: CVE-2021-47192
