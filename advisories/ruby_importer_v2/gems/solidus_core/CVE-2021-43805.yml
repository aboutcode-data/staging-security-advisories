advisory_id: gems/solidus_core/CVE-2021-43805
datasource_id: ruby_importer_v2/gems/solidus_core/CVE-2021-43805
datasource_url: https://github.com/rubysec/ruby-advisory-db/blob/master/gems/solidus_core/CVE-2021-43805.yml
aliases:
  - CVE-2021-43805
  - GHSA-qxmr-qxh6-2cc9
summary: |
  ReDos vulnerability on guest checkout email validation
  ### Impact
  Denial of service vulnerability that could be exploited during a guest checkout.
  The regular expression used to validate a guest order's email was subject to
  exponential backtracking through a fragment like `a.a.`.

  Before the patch, it can be reproduced in the console like this:

  ```ruby
  irb(main)> Spree::EmailValidator::EMAIL_REGEXP.match "a@a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.@"
  processing time: 54.293660s
  => nil
  ```

  To reproduce in the browser, fill in the "Customer Email" field with that fake
  email address during a guest checkout. Before that, you should open the browser
  dev tools and change the `type` attribute for that field from `email` to `text`.
  After entering a fake address and pressing the "Save & Continue" button, the
  browser will take a long term to perform the request before showing an error
  message for the invalid address. Eventually, making the email string even longer
  could lead to the exhaustion of server resources.

  ### Patches
  Versions 3.1.4, 3.0.4, and 2.11.13 have been patched to use a different regular
  expression.

  There's an improbable chance that some orders in your system end up having
  associated an email address that is no longer valid. We've added a task to check
  precisely that:

  ```bash
  bin/rails solidus:check_orders_with_invalid_email
  ```

  The above will print information for every affected order if any.

  ### Workarounds

  If a prompt upgrade is not an option, please, add the following to
  `config/application.rb`:

  ```ruby
  config.after_initialize do
    Spree::EmailValidator.send(:remove_const, :EMAIL_REGEXP)
    Spree::EmailValidator::EMAIL_REGEXP = URI::MailTo::EMAIL_REGEXP
  end
  ```
impacted_packages:
  - purl: pkg:gem/solidus_core
    affected_versions:
    fixed_versions: vers:gem/>=2.11.13|<2.12
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:gem/solidus_core
    affected_versions:
    fixed_versions: vers:gem/>=3.0.4|<3.1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:gem/solidus_core
    affected_versions:
    fixed_versions: vers:gem/>=3.1.4
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '7.5'
    scoring_system: cvssv3
    scoring_elements:
    published_at: None
    url:
weaknesses: []
references:
  - url: https://github.com/solidusio/solidus/security/advisories/GHSA-qxmr-qxh6-2cc9
    reference_type:
    reference_id:
