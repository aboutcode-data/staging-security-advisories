advisory_id: gems/rack/CVE-2018-16471
datasource_id: ruby_importer_v2/gems/rack/CVE-2018-16471
datasource_url: https://github.com/rubysec/ruby-advisory-db/blob/master/gems/rack/CVE-2018-16471.yml
aliases:
  - CVE-2018-16471
  - GHSA-5r2p-j47h-mhpg
summary: |
  Possible XSS vulnerability in Rack
  There is a possible vulnerability in Rack. This vulnerability has been
  assigned the CVE identifier CVE-2018-16471.

  Versions Affected:  All.
  Not affected:       None.
  Fixed Versions:     2.0.6, 1.6.11

  Impact
  ------
  There is a possible XSS vulnerability in Rack.  Carefully crafted requests can
  impact the data returned by the `scheme` method on `Rack::Request`.
  Applications that expect the scheme to be limited to "http" or "https" and do
  not escape the return value could be vulnerable to an XSS attack.

  Vulnerable code looks something like this:

  ```
  <%= request.scheme.html_safe %>
  ```

  Note that applications using the normal escaping mechanisms provided by Rails
  may not impacted, but applications that bypass the escaping mechanisms, or do
  not use them may be vulnerable.

  All users running an affected release should either upgrade or use one of the
  workarounds immediately.

  Releases
  --------
  The 2.0.6 and 1.6.11 releases are available at the normal locations.

  Workarounds
  -----------
  The following monkey patch can be applied to work around this issue:

  ```
  require "rack"
  require "rack/request"

  class Rack::Request
  SCHEME_WHITELIST = %w(https http).freeze

  def scheme
    if get_header(Rack::HTTPS) == 'on'
      'https'
    elsif get_header(HTTP_X_FORWARDED_SSL) == 'on'
      'https'
    elsif forwarded_scheme
      forwarded_scheme
    else
      get_header(Rack::RACK_URL_SCHEME)
    end
  end

  def forwarded_scheme
    scheme_headers = [
      get_header(HTTP_X_FORWARDED_SCHEME),
      get_header(HTTP_X_FORWARDED_PROTO).to_s.split(',')[0]
    ]

    scheme_headers.each do |header|
      return header if SCHEME_WHITELIST.include?(header)
    end

    nil
  end
  end
  ```
impacted_packages:
  - purl: pkg:gem/rack
    affected_versions:
    fixed_versions: vers:gem/>=1.6.11|<1.7
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:gem/rack
    affected_versions:
    fixed_versions: vers:gem/>=2.0.6
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score: '6.1'
    scoring_system: cvssv3
    scoring_elements:
    published_at: None
    url:
weaknesses: []
references:
  - url: https://groups.google.com/forum/#!topic/ruby-security-ann/NAalCee8n6o
    reference_type:
    reference_id:
