advisory_id: CVE-2024-31145
datasource_id: collect_xen_project_fix_commits/CVE-2024-31145
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  10d6cba5989d8acb94ae293f22eb434d85f735cb:x86/IOMMU: move tracking in iommu_identity_mapping()

  If for some reason xmalloc() fails after having mapped the reserved
  regions, an error is reported, but the regions remain mapped in the P2M.

  Similarly if an error occurs during set_identity_p2m_entry() (except on
  the first call), the partial mappings of the region would be retained
  without being tracked anywhere, and hence without there being a way to
  remove them again from the domain's P2M.

  Move the setting up of the list entry ahead of trying to map the region.
  In cases other than the first mapping failing, keep record of the full
  region, such that a subsequent unmapping request can be properly torn
  down.

  To compensate for the potentially excess unmapping requests, don't log a
  warning from p2m_remove_identity_entry() when there really was nothing
  mapped at a given GFN.

  This is XSA-460 / CVE-2024-31145.

  Fixes: 2201b67b9128 ("VT-d: improve RMRR region handling")
  Fixes: c0e19d7c6c42 ("IOMMU: generalize VT-d's tracking of mapped RMRR regions")
  Signed-off-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: beadd68b5490ada053d72f8a9ce6fd696d626596
  master date: 2024-08-13 16:36:40 +0200
  c638866e99d28279a92879db6f2ae85f76a35ee6:x86/IOMMU: move tracking in iommu_identity_mapping()

  If for some reason xmalloc() fails after having mapped the reserved
  regions, an error is reported, but the regions remain mapped in the P2M.

  Similarly if an error occurs during set_identity_p2m_entry() (except on
  the first call), the partial mappings of the region would be retained
  without being tracked anywhere, and hence without there being a way to
  remove them again from the domain's P2M.

  Move the setting up of the list entry ahead of trying to map the region.
  In cases other than the first mapping failing, keep record of the full
  region, such that a subsequent unmapping request can be properly torn
  down.

  To compensate for the potentially excess unmapping requests, don't log a
  warning from p2m_remove_identity_entry() when there really was nothing
  mapped at a given GFN.

  This is XSA-460 / CVE-2024-31145.

  Fixes: 2201b67b9128 ("VT-d: improve RMRR region handling")
  Fixes: c0e19d7c6c42 ("IOMMU: generalize VT-d's tracking of mapped RMRR regions")
  Signed-off-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: beadd68b5490ada053d72f8a9ce6fd696d626596
  master date: 2024-08-13 16:36:40 +0200
  255d6518ce993cf1d11b5d34dcc3ec696f36f8e1:x86/IOMMU: move tracking in iommu_identity_mapping()

  If for some reason xmalloc() fails after having mapped the reserved
  regions, an error is reported, but the regions remain mapped in the P2M.

  Similarly if an error occurs during set_identity_p2m_entry() (except on
  the first call), the partial mappings of the region would be retained
  without being tracked anywhere, and hence without there being a way to
  remove them again from the domain's P2M.

  Move the setting up of the list entry ahead of trying to map the region.
  In cases other than the first mapping failing, keep record of the full
  region, such that a subsequent unmapping request can be properly torn
  down.

  To compensate for the potentially excess unmapping requests, don't log a
  warning from p2m_remove_identity_entry() when there really was nothing
  mapped at a given GFN.

  This is XSA-460 / CVE-2024-31145.

  Fixes: 2201b67b9128 ("VT-d: improve RMRR region handling")
  Fixes: c0e19d7c6c42 ("IOMMU: generalize VT-d's tracking of mapped RMRR regions")
  Signed-off-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: beadd68b5490ada053d72f8a9ce6fd696d626596
  master date: 2024-08-13 16:36:40 +0200
  c61d4264d26d1ffb26563bfb6dc2f0b06cd72128:x86/IOMMU: move tracking in iommu_identity_mapping()

  If for some reason xmalloc() fails after having mapped the reserved
  regions, an error is reported, but the regions remain mapped in the P2M.

  Similarly if an error occurs during set_identity_p2m_entry() (except on
  the first call), the partial mappings of the region would be retained
  without being tracked anywhere, and hence without there being a way to
  remove them again from the domain's P2M.

  Move the setting up of the list entry ahead of trying to map the region.
  In cases other than the first mapping failing, keep record of the full
  region, such that a subsequent unmapping request can be properly torn
  down.

  To compensate for the potentially excess unmapping requests, don't log a
  warning from p2m_remove_identity_entry() when there really was nothing
  mapped at a given GFN.

  This is XSA-460 / CVE-2024-31145.

  Fixes: 2201b67b9128 ("VT-d: improve RMRR region handling")
  Fixes: c0e19d7c6c42 ("IOMMU: generalize VT-d's tracking of mapped RMRR regions")
  Signed-off-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: beadd68b5490ada053d72f8a9ce6fd696d626596
  master date: 2024-08-13 16:36:40 +0200
  beadd68b5490ada053d72f8a9ce6fd696d626596:x86/IOMMU: move tracking in iommu_identity_mapping()

  If for some reason xmalloc() fails after having mapped the reserved
  regions, an error is reported, but the regions remain mapped in the P2M.

  Similarly if an error occurs during set_identity_p2m_entry() (except on
  the first call), the partial mappings of the region would be retained
  without being tracked anywhere, and hence without there being a way to
  remove them again from the domain's P2M.

  Move the setting up of the list entry ahead of trying to map the region.
  In cases other than the first mapping failing, keep record of the full
  region, such that a subsequent unmapping request can be properly torn
  down.

  To compensate for the potentially excess unmapping requests, don't log a
  warning from p2m_remove_identity_entry() when there really was nothing
  mapped at a given GFN.

  This is XSA-460 / CVE-2024-31145.

  Fixes: 2201b67b9128 ("VT-d: improve RMRR region handling")
  Fixes: c0e19d7c6c42 ("IOMMU: generalize VT-d's tracking of mapped RMRR regions")
  Signed-off-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 255d6518ce993cf1d11b5d34dcc3ec696f36f8e1
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c61d4264d26d1ffb26563bfb6dc2f0b06cd72128
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c638866e99d28279a92879db6f2ae85f76a35ee6
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 10d6cba5989d8acb94ae293f22eb434d85f735cb
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: beadd68b5490ada053d72f8a9ce6fd696d626596
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/10d6cba5989d8acb94ae293f22eb434d85f735cb
    reference_type: commit
    reference_id: 10d6cba5989d8acb94ae293f22eb434d85f735cb
  - url: https://github.com/xen-project/xen/tree/255d6518ce993cf1d11b5d34dcc3ec696f36f8e1
    reference_type: commit
    reference_id: 255d6518ce993cf1d11b5d34dcc3ec696f36f8e1
  - url: https://github.com/xen-project/xen/tree/beadd68b5490ada053d72f8a9ce6fd696d626596
    reference_type: commit
    reference_id: beadd68b5490ada053d72f8a9ce6fd696d626596
  - url: https://github.com/xen-project/xen/tree/c61d4264d26d1ffb26563bfb6dc2f0b06cd72128
    reference_type: commit
    reference_id: c61d4264d26d1ffb26563bfb6dc2f0b06cd72128
  - url: https://github.com/xen-project/xen/tree/c638866e99d28279a92879db6f2ae85f76a35ee6
    reference_type: commit
    reference_id: c638866e99d28279a92879db6f2ae85f76a35ee6
