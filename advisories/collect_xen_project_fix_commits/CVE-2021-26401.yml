advisory_id: CVE-2021-26401
datasource_id: collect_xen_project_fix_commits/CVE-2021-26401
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  c374a8c5cc74535e16410b7a0d9e92bf5de54f79:x86/spec-ctrl: Cease using thunk=lfence on AMD

  AMD have updated their Spectre v2 guidance, and lfence/jmp is no longer
  considered safe.  AMD are recommending using retpoline everywhere.

  Retpoline is incompatible with CET.  All CET-capable hardware has efficient
  IBRS (specifically, not something retrofitted in microcode), so use IBRS (and
  STIBP for consistency sake).

  This is a logical change on AMD, but not on Intel as the default calculations
  would end up with these settings anyway.  Leave behind a message if IBRS is
  found to be missing.

  Also update the default heuristics to never select THUNK_LFENCE.  This causes
  AMD CPUs to change their default to retpoline.

  Also update the printed message to include the AMD MSR_SPEC_CTRL settings, and
  STIBP now that we set it for consistency sake.

  This is part of XSA-398 / CVE-2021-26401.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 8d03080d2a339840d3a59e0932a94f804e45110d)
  1b50f41b3bd800eb72064063da0c64b86d629f3a:x86/spec-ctrl: Cease using thunk=lfence on AMD

  AMD have updated their Spectre v2 guidance, and lfence/jmp is no longer
  considered safe.  AMD are recommending using retpoline everywhere.

  Retpoline is incompatible with CET.  All CET-capable hardware has efficient
  IBRS (specifically, not something retrofitted in microcode), so use IBRS (and
  STIBP for consistency sake).

  This is a logical change on AMD, but not on Intel as the default calculations
  would end up with these settings anyway.  Leave behind a message if IBRS is
  found to be missing.

  Also update the default heuristics to never select THUNK_LFENCE.  This causes
  AMD CPUs to change their default to retpoline.

  Also update the printed message to include the AMD MSR_SPEC_CTRL settings, and
  STIBP now that we set it for consistency sake.

  This is part of XSA-398 / CVE-2021-26401.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 8d03080d2a339840d3a59e0932a94f804e45110d)
  ca304edd3ba8c19211107fd2e898249987557ce5:x86/spec-ctrl: Cease using thunk=lfence on AMD

  AMD have updated their Spectre v2 guidance, and lfence/jmp is no longer
  considered safe.  AMD are recommending using retpoline everywhere.

  Retpoline is incompatible with CET.  All CET-capable hardware has efficient
  IBRS (specifically, not something retrofitted in microcode), so use IBRS (and
  STIBP for consistency sake).

  This is a logical change on AMD, but not on Intel as the default calculations
  would end up with these settings anyway.  Leave behind a message if IBRS is
  found to be missing.

  Also update the default heuristics to never select THUNK_LFENCE.  This causes
  AMD CPUs to change their default to retpoline.

  Also update the printed message to include the AMD MSR_SPEC_CTRL settings, and
  STIBP now that we set it for consistency sake.

  This is part of XSA-398 / CVE-2021-26401.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 8d03080d2a339840d3a59e0932a94f804e45110d)
  7b9814b250a5a28277bd0866d341a5cfc0f4c1ac:x86/spec-ctrl: Cease using thunk=lfence on AMD

  AMD have updated their Spectre v2 guidance, and lfence/jmp is no longer
  considered safe.  AMD are recommending using retpoline everywhere.

  Update the default heuristics to never select THUNK_LFENCE.

  This is part of XSA-398 / CVE-2021-26401.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 8d03080d2a339840d3a59e0932a94f804e45110d)
  944afa38d9339a67f0164d07fb7ac8a54e9a4c60:x86/spec-ctrl: Cease using thunk=lfence on AMD

  AMD have updated their Spectre v2 guidance, and lfence/jmp is no longer
  considered safe.  AMD are recommending using retpoline everywhere.

  Update the default heuristics to never select THUNK_LFENCE.

  This is part of XSA-398 / CVE-2021-26401.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 8d03080d2a339840d3a59e0932a94f804e45110d)
  8d03080d2a339840d3a59e0932a94f804e45110d:x86/spec-ctrl: Cease using thunk=lfence on AMD

  AMD have updated their Spectre v2 guidance, and lfence/jmp is no longer
  considered safe.  AMD are recommending using retpoline everywhere.

  Retpoline is incompatible with CET.  All CET-capable hardware has efficient
  IBRS (specifically, not something retrofitted in microcode), so use IBRS (and
  STIBP for consistency sake).

  This is a logical change on AMD, but not on Intel as the default calculations
  would end up with these settings anyway.  Leave behind a message if IBRS is
  found to be missing.

  Also update the default heuristics to never select THUNK_LFENCE.  This causes
  AMD CPUs to change their default to retpoline.

  Also update the printed message to include the AMD MSR_SPEC_CTRL settings, and
  STIBP now that we set it for consistency sake.

  This is part of XSA-398 / CVE-2021-26401.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7b9814b250a5a28277bd0866d341a5cfc0f4c1ac
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c374a8c5cc74535e16410b7a0d9e92bf5de54f79
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 1b50f41b3bd800eb72064063da0c64b86d629f3a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 944afa38d9339a67f0164d07fb7ac8a54e9a4c60
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ca304edd3ba8c19211107fd2e898249987557ce5
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 8d03080d2a339840d3a59e0932a94f804e45110d
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/1b50f41b3bd800eb72064063da0c64b86d629f3a
    reference_type: commit
    reference_id: 1b50f41b3bd800eb72064063da0c64b86d629f3a
  - url: https://github.com/xen-project/xen/tree/7b9814b250a5a28277bd0866d341a5cfc0f4c1ac
    reference_type: commit
    reference_id: 7b9814b250a5a28277bd0866d341a5cfc0f4c1ac
  - url: https://github.com/xen-project/xen/tree/8d03080d2a339840d3a59e0932a94f804e45110d
    reference_type: commit
    reference_id: 8d03080d2a339840d3a59e0932a94f804e45110d
  - url: https://github.com/xen-project/xen/tree/944afa38d9339a67f0164d07fb7ac8a54e9a4c60
    reference_type: commit
    reference_id: 944afa38d9339a67f0164d07fb7ac8a54e9a4c60
  - url: https://github.com/xen-project/xen/tree/c374a8c5cc74535e16410b7a0d9e92bf5de54f79
    reference_type: commit
    reference_id: c374a8c5cc74535e16410b7a0d9e92bf5de54f79
  - url: https://github.com/xen-project/xen/tree/ca304edd3ba8c19211107fd2e898249987557ce5
    reference_type: commit
    reference_id: ca304edd3ba8c19211107fd2e898249987557ce5
