advisory_id: CVE-2021-28694
datasource_id: collect_xen_project_fix_commits/CVE-2021-28694
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  8c02a4943e60a400103a6790de2e6f19854403e5:x86/p2m: guard (in particular) identity mapping entries

  Such entries, created by set_identity_p2m_entry(), should only be
  destroyed by clear_identity_p2m_entry(). However, similarly, entries
  created by set_mmio_p2m_entry() should only be torn down by
  clear_mmio_p2m_entry(), so the logic gets based upon p2m_mmio_direct as
  the entry type (separation between "ordinary" and 1:1 mappings would
  require a further indicator to tell apart the two).

  As to the guest_remove_page() change, commit 48dfb297a20a ("x86/PVH:
  allow guest_remove_page to remove p2m_mmio_direct pages"), which
  introduced the call to clear_mmio_p2m_entry(), claimed this was done for
  hwdom only without this actually having been the case. However, this
  code shouldn't be there in the first place, as MMIO entries shouldn't be
  dropped this way. Avoid triggering the warning again that 48dfb297a20a
  silenced by an adjustment to xenmem_add_to_physmap_one() instead.

  Note that guest_physmap_mark_populate_on_demand() gets tightened beyond
  the immediate purpose of this change.

  Note also that I didn't inspect code which isn't security supported,
  e.g. sharing, paging, or altp2m.

  This is CVE-2021-28694 / part of XSA-378.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
  master date: 2021-08-25 14:17:32 +0200
  4e5bf7ebbfd0bb4fc57466f8eebfb90047a3e277:x86/p2m: guard (in particular) identity mapping entries

  Such entries, created by set_identity_p2m_entry(), should only be
  destroyed by clear_identity_p2m_entry(). However, similarly, entries
  created by set_mmio_p2m_entry() should only be torn down by
  clear_mmio_p2m_entry(), so the logic gets based upon p2m_mmio_direct as
  the entry type (separation between "ordinary" and 1:1 mappings would
  require a further indicator to tell apart the two).

  As to the guest_remove_page() change, commit 48dfb297a20a ("x86/PVH:
  allow guest_remove_page to remove p2m_mmio_direct pages"), which
  introduced the call to clear_mmio_p2m_entry(), claimed this was done for
  hwdom only without this actually having been the case. However, this
  code shouldn't be there in the first place, as MMIO entries shouldn't be
  dropped this way. Avoid triggering the warning again that 48dfb297a20a
  silenced by an adjustment to xenmem_add_to_physmap_one() instead.

  Note that guest_physmap_mark_populate_on_demand() gets tightened beyond
  the immediate purpose of this change.

  Note also that I didn't inspect code which isn't security supported,
  e.g. sharing, paging, or altp2m.

  This is CVE-2021-28694 / part of XSA-378.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
  master date: 2021-08-25 14:17:32 +0200
  89d40f0682f9ad37091cc53685f3ecf63a44bb72:x86/p2m: guard (in particular) identity mapping entries

  Such entries, created by set_identity_p2m_entry(), should only be
  destroyed by clear_identity_p2m_entry(). However, similarly, entries
  created by set_mmio_p2m_entry() should only be torn down by
  clear_mmio_p2m_entry(), so the logic gets based upon p2m_mmio_direct as
  the entry type (separation between "ordinary" and 1:1 mappings would
  require a further indicator to tell apart the two).

  As to the guest_remove_page() change, commit 48dfb297a20a ("x86/PVH:
  allow guest_remove_page to remove p2m_mmio_direct pages"), which
  introduced the call to clear_mmio_p2m_entry(), claimed this was done for
  hwdom only without this actually having been the case. However, this
  code shouldn't be there in the first place, as MMIO entries shouldn't be
  dropped this way. Avoid triggering the warning again that 48dfb297a20a
  silenced by an adjustment to xenmem_add_to_physmap_one() instead.

  Note that guest_physmap_mark_populate_on_demand() gets tightened beyond
  the immediate purpose of this change.

  Note also that I didn't inspect code which isn't security supported,
  e.g. sharing, paging, or altp2m.

  This is CVE-2021-28694 / part of XSA-378.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
  master date: 2021-08-25 14:17:32 +0200
  6f4c2146893c10ec17e854242613428f96e86757:x86/p2m: guard (in particular) identity mapping entries

  Such entries, created by set_identity_p2m_entry(), should only be
  destroyed by clear_identity_p2m_entry(). However, similarly, entries
  created by set_mmio_p2m_entry() should only be torn down by
  clear_mmio_p2m_entry(), so the logic gets based upon p2m_mmio_direct as
  the entry type (separation between "ordinary" and 1:1 mappings would
  require a further indicator to tell apart the two).

  As to the guest_remove_page() change, commit 48dfb297a20a ("x86/PVH:
  allow guest_remove_page to remove p2m_mmio_direct pages"), which
  introduced the call to clear_mmio_p2m_entry(), claimed this was done for
  hwdom only without this actually having been the case. However, this
  code shouldn't be there in the first place, as MMIO entries shouldn't be
  dropped this way. Avoid triggering the warning again that 48dfb297a20a
  silenced by an adjustment to xenmem_add_to_physmap_one() instead.

  Note that guest_physmap_mark_populate_on_demand() gets tightened beyond
  the immediate purpose of this change.

  Note also that I didn't inspect code which isn't security supported,
  e.g. sharing, paging, or altp2m.

  This is CVE-2021-28694 / part of XSA-378.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
  master date: 2021-08-25 14:17:32 +0200
  7850fe53a59f73fbb0a61c36141c6a6563e3eeca:x86/p2m: guard (in particular) identity mapping entries

  Such entries, created by set_identity_p2m_entry(), should only be
  destroyed by clear_identity_p2m_entry(). However, similarly, entries
  created by set_mmio_p2m_entry() should only be torn down by
  clear_mmio_p2m_entry(), so the logic gets based upon p2m_mmio_direct as
  the entry type (separation between "ordinary" and 1:1 mappings would
  require a further indicator to tell apart the two).

  As to the guest_remove_page() change, commit 48dfb297a20a ("x86/PVH:
  allow guest_remove_page to remove p2m_mmio_direct pages"), which
  introduced the call to clear_mmio_p2m_entry(), claimed this was done for
  hwdom only without this actually having been the case. However, this
  code shouldn't be there in the first place, as MMIO entries shouldn't be
  dropped this way. Avoid triggering the warning again that 48dfb297a20a
  silenced by an adjustment to xenmem_add_to_physmap_one() instead.

  Note that guest_physmap_mark_populate_on_demand() gets tightened beyond
  the immediate purpose of this change.

  Note also that I didn't inspect code which isn't security supported,
  e.g. sharing, paging, or altp2m.

  This is CVE-2021-28694 / part of XSA-378.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
  master date: 2021-08-25 14:17:32 +0200
  753cb68e653002e89fdcd1c80e52905fdbfb78cb:x86/p2m: guard (in particular) identity mapping entries

  Such entries, created by set_identity_p2m_entry(), should only be
  destroyed by clear_identity_p2m_entry(). However, similarly, entries
  created by set_mmio_p2m_entry() should only be torn down by
  clear_mmio_p2m_entry(), so the logic gets based upon p2m_mmio_direct as
  the entry type (separation between "ordinary" and 1:1 mappings would
  require a further indicator to tell apart the two).

  As to the guest_remove_page() change, commit 48dfb297a20a ("x86/PVH:
  allow guest_remove_page to remove p2m_mmio_direct pages"), which
  introduced the call to clear_mmio_p2m_entry(), claimed this was done for
  hwdom only without this actually having been the case. However, this
  code shouldn't be there in the first place, as MMIO entries shouldn't be
  dropped this way. Avoid triggering the warning again that 48dfb297a20a
  silenced by an adjustment to xenmem_add_to_physmap_one() instead.

  Note that guest_physmap_mark_populate_on_demand() gets tightened beyond
  the immediate purpose of this change.

  Note also that I didn't inspect code which isn't security supported,
  e.g. sharing, paging, or altp2m.

  This is CVE-2021-28694 / part of XSA-378.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 4e5bf7ebbfd0bb4fc57466f8eebfb90047a3e277
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 89d40f0682f9ad37091cc53685f3ecf63a44bb72
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7850fe53a59f73fbb0a61c36141c6a6563e3eeca
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 6f4c2146893c10ec17e854242613428f96e86757
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 8c02a4943e60a400103a6790de2e6f19854403e5
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/4e5bf7ebbfd0bb4fc57466f8eebfb90047a3e277
    reference_type: commit
    reference_id: 4e5bf7ebbfd0bb4fc57466f8eebfb90047a3e277
  - url: https://github.com/xen-project/xen/tree/6f4c2146893c10ec17e854242613428f96e86757
    reference_type: commit
    reference_id: 6f4c2146893c10ec17e854242613428f96e86757
  - url: https://github.com/xen-project/xen/tree/753cb68e653002e89fdcd1c80e52905fdbfb78cb
    reference_type: commit
    reference_id: 753cb68e653002e89fdcd1c80e52905fdbfb78cb
  - url: https://github.com/xen-project/xen/tree/7850fe53a59f73fbb0a61c36141c6a6563e3eeca
    reference_type: commit
    reference_id: 7850fe53a59f73fbb0a61c36141c6a6563e3eeca
  - url: https://github.com/xen-project/xen/tree/89d40f0682f9ad37091cc53685f3ecf63a44bb72
    reference_type: commit
    reference_id: 89d40f0682f9ad37091cc53685f3ecf63a44bb72
  - url: https://github.com/xen-project/xen/tree/8c02a4943e60a400103a6790de2e6f19854403e5
    reference_type: commit
    reference_id: 8c02a4943e60a400103a6790de2e6f19854403e5
