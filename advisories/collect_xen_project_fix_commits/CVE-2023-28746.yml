advisory_id: CVE-2023-28746
datasource_id: collect_xen_project_fix_commits/CVE-2023-28746
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  a8c4726320e89ffa68d60d423ab88e1829b7b535:x86/spec-ctrl: Mitigation Register File Data Sampling

  RFDS affects Atom cores, also branded E-cores, between the Goldmont and
  Gracemont microarchitectures.  This includes Alder Lake and Raptor Lake hybrid
  clien systems which have a mix of Gracemont and other types of cores.

  Two new bits have been defined; RFDS_CLEAR to indicate VERW has more side
  effets, and RFDS_NO to incidate that the system is unaffected.  Plenty of
  unaffected CPUs won't be getting RFDS_NO retrofitted in microcode, so we
  synthesise it.  Alder Lake and Raptor Lake Xeon-E's are unaffected due to
  their platform configuration, and we must use the Hybrid CPUID bit to
  distinguish them from their non-Xeon counterparts.

  Like MD_CLEAR and FB_CLEAR, RFDS_CLEAR needs OR-ing across a resource pool, so
  set it in the max policies and reflect the host setting in default.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit fb5b6f6744713410c74cfc12b7176c108e3c9a31)
  7c69a025f141ada31f5bd1b1a3e35eacd9543e45:x86/spec-ctrl: VERW-handling adjustments

  ... before we add yet more complexity to this logic.  Mostly expanded
  comments, but with three minor changes.

  1) Introduce cpu_has_useful_md_clear to simplify later logic in this patch and
     future ones.

  2) We only ever need SC_VERW_IDLE when SMT is active.  If SMT isn't active,
     then there's no re-partition of pipeline resources based on thread-idleness
     to worry about.

  3) The logic to adjust HVM VERW based on L1D_FLUSH is unmaintainable and, as
     it turns out, wrong.  SKIP_L1DFL is just a hint bit, whereas opt_l1d_flush
     is the relevant decision of whether to use L1D_FLUSH based on
     susceptibility and user preference.

     Rewrite the logic so it can be followed, and incorporate the fact that when
     FB_CLEAR is visible, L1D_FLUSH isn't a safe substitution.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Acked-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 1eb91a8a06230b4b64228c9a380194f8cfe6c5e2)
  a8f99b49075ea30e5a074eb0579609a4ea0a44a3:x86/spec-ctrl: Rename VERW related options

  VERW is going to be used for a 3rd purpose, and the existing nomenclature
  didn't survive the Stale MMIO issues terribly well.

  Rename the command line option from `md-clear=` to `verw=`.  This is more
  consistent with other options which tend to be named based on what they're
  doing, not which feature enumeration they use behind the scenes.  Retain
  `md-clear=` as a deprecated alias.

  Rename opt_md_clear_{pv,hvm} and opt_fb_clear_mmio to opt_verw_{pv,hvm,mmio},
  which has a side effect of making spec_ctrl_init_domain() rather clearer to
  follow.

  No functional change.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit f7603ca252e4226739eb3129a5290ee3da3f8ea4)
  d636a6d1d4325f1b448ea7613bce909ccf99420b:x86/spec-ctrl: Perform VERW flushing later in exit paths

  On parts vulnerable to RFDS, VERW's side effects are extended to scrub all
  non-architectural entries in various Physical Register Files.  To remove all
  of Xen's values, the VERW must be after popping the GPRs.

  Rework SPEC_CTRL_COND_VERW to default to an CPUINFO_error_code %rsp position,
  but with overrides for other contexts.  Identify that it clobbers eflags; this
  is particularly relevant for the SYSRET path.

  For the IST exit return to Xen, have the main SPEC_CTRL_EXIT_TO_XEN put a
  shadow copy of spec_ctrl_flags, as GPRs can't be used at the point we want to
  issue the VERW.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7)
  eeed8a8ef62af7136b2cee0da00eb00c90d2fec0:x86/vmx: Perform VERW flushing later in the VMExit path

  Broken out of the following patch because this change is subtle enough on its
  own.  See it for the rational of why we're moving VERW.

  As for how, extend the trick already used to hold one condition in
  flags (RESUME vs LAUNCH) through the POPing of GPRs.

  Move the MOV CR earlier.  Intel specify flags to be undefined across it.

  Encode the two conditions we want using SF and PF.  See the code comment for
  exactly how.

  Leave a comment to explain the lack of any content around
  SPEC_CTRL_EXIT_TO_VMX, but leave the block in place.  Sods law says if we
  delete it, we'll need to reintroduce it.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 475fa20b7384464210f42bad7195f87bd6f1c63f)
  762cd5423635a8f0f69eb71ce10c5a62c47247ac:x86/spec-ctrl: Mitigation Register File Data Sampling

  RFDS affects Atom cores, also branded E-cores, between the Goldmont and
  Gracemont microarchitectures.  This includes Alder Lake and Raptor Lake hybrid
  clien systems which have a mix of Gracemont and other types of cores.

  Two new bits have been defined; RFDS_CLEAR to indicate VERW has more side
  effets, and RFDS_NO to incidate that the system is unaffected.  Plenty of
  unaffected CPUs won't be getting RFDS_NO retrofitted in microcode, so we
  synthesise it.  Alder Lake and Raptor Lake Xeon-E's are unaffected due to
  their platform configuration, and we must use the Hybrid CPUID bit to
  distinguish them from their non-Xeon counterparts.

  Like MD_CLEAR and FB_CLEAR, RFDS_CLEAR needs OR-ing across a resource pool, so
  set it in the max policies and reflect the host setting in default.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit fb5b6f6744713410c74cfc12b7176c108e3c9a31)
  638b6b21702ebf5a028a166261e4353d3028c7bd:x86/spec-ctrl: VERW-handling adjustments

  ... before we add yet more complexity to this logic.  Mostly expanded
  comments, but with three minor changes.

  1) Introduce cpu_has_useful_md_clear to simplify later logic in this patch and
     future ones.

  2) We only ever need SC_VERW_IDLE when SMT is active.  If SMT isn't active,
     then there's no re-partition of pipeline resources based on thread-idleness
     to worry about.

  3) The logic to adjust HVM VERW based on L1D_FLUSH is unmaintainable and, as
     it turns out, wrong.  SKIP_L1DFL is just a hint bit, whereas opt_l1d_flush
     is the relevant decision of whether to use L1D_FLUSH based on
     susceptibility and user preference.

     Rewrite the logic so it can be followed, and incorporate the fact that when
     FB_CLEAR is visible, L1D_FLUSH isn't a safe substitution.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Acked-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 1eb91a8a06230b4b64228c9a380194f8cfe6c5e2)
  a7ae8dbd8f4518b3d56d41d32931587b9027bc7b:x86/spec-ctrl: Rename VERW related options

  VERW is going to be used for a 3rd purpose, and the existing nomenclature
  didn't survive the Stale MMIO issues terribly well.

  Rename the command line option from `md-clear=` to `verw=`.  This is more
  consistent with other options which tend to be named based on what they're
  doing, not which feature enumeration they use behind the scenes.  Retain
  `md-clear=` as a deprecated alias.

  Rename opt_md_clear_{pv,hvm} and opt_fb_clear_mmio to opt_verw_{pv,hvm,mmio},
  which has a side effect of making spec_ctrl_init_domain() rather clearer to
  follow.

  No functional change.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit f7603ca252e4226739eb3129a5290ee3da3f8ea4)
  92e7aab34337aa6b68a506861992822c079ee175:x86/spec-ctrl: Perform VERW flushing later in exit paths

  On parts vulnerable to RFDS, VERW's side effects are extended to scrub all
  non-architectural entries in various Physical Register Files.  To remove all
  of Xen's values, the VERW must be after popping the GPRs.

  Rework SPEC_CTRL_COND_VERW to default to an CPUINFO_error_code %rsp position,
  but with overrides for other contexts.  Identify that it clobbers eflags; this
  is particularly relevant for the SYSRET path.

  For the IST exit return to Xen, have the main SPEC_CTRL_EXIT_TO_XEN put a
  shadow copy of spec_ctrl_flags, as GPRs can't be used at the point we want to
  issue the VERW.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7)
  3bf73a02cb770682587c1c7e3c254ddb18e7b261:x86/vmx: Perform VERW flushing later in the VMExit path

  Broken out of the following patch because this change is subtle enough on its
  own.  See it for the rational of why we're moving VERW.

  As for how, extend the trick already used to hold one condition in
  flags (RESUME vs LAUNCH) through the POPing of GPRs.

  Move the MOV CR earlier.  Intel specify flags to be undefined across it.

  Encode the two conditions we want using SF and PF.  See the code comment for
  exactly how.

  Leave a comment to explain the lack of any content around
  SPEC_CTRL_EXIT_TO_VMX, but leave the block in place.  Sods law says if we
  delete it, we'll need to reintroduce it.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 475fa20b7384464210f42bad7195f87bd6f1c63f)
  d85481135d87abbbf1feab18b749288fa08b65f2:x86/spec-ctrl: Mitigation Register File Data Sampling

  RFDS affects Atom cores, also branded E-cores, between the Goldmont and
  Gracemont microarchitectures.  This includes Alder Lake and Raptor Lake hybrid
  clien systems which have a mix of Gracemont and other types of cores.

  Two new bits have been defined; RFDS_CLEAR to indicate VERW has more side
  effets, and RFDS_NO to incidate that the system is unaffected.  Plenty of
  unaffected CPUs won't be getting RFDS_NO retrofitted in microcode, so we
  synthesise it.  Alder Lake and Raptor Lake Xeon-E's are unaffected due to
  their platform configuration, and we must use the Hybrid CPUID bit to
  distinguish them from their non-Xeon counterparts.

  Like MD_CLEAR and FB_CLEAR, RFDS_CLEAR needs OR-ing across a resource pool, so
  set it in the max policies and reflect the host setting in default.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit fb5b6f6744713410c74cfc12b7176c108e3c9a31)
  6663430b442fdf9698bd8e03f701a4547309ad71:x86/spec-ctrl: VERW-handling adjustments

  ... before we add yet more complexity to this logic.  Mostly expanded
  comments, but with three minor changes.

  1) Introduce cpu_has_useful_md_clear to simplify later logic in this patch and
     future ones.

  2) We only ever need SC_VERW_IDLE when SMT is active.  If SMT isn't active,
     then there's no re-partition of pipeline resources based on thread-idleness
     to worry about.

  3) The logic to adjust HVM VERW based on L1D_FLUSH is unmaintainable and, as
     it turns out, wrong.  SKIP_L1DFL is just a hint bit, whereas opt_l1d_flush
     is the relevant decision of whether to use L1D_FLUSH based on
     susceptibility and user preference.

     Rewrite the logic so it can be followed, and incorporate the fact that when
     FB_CLEAR is visible, L1D_FLUSH isn't a safe substitution.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Acked-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 1eb91a8a06230b4b64228c9a380194f8cfe6c5e2)
  d55d52961d13d4fcd1441fcfca98f690e687b941:x86/spec-ctrl: Rename VERW related options

  VERW is going to be used for a 3rd purpose, and the existing nomenclature
  didn't survive the Stale MMIO issues terribly well.

  Rename the command line option from `md-clear=` to `verw=`.  This is more
  consistent with other options which tend to be named based on what they're
  doing, not which feature enumeration they use behind the scenes.  Retain
  `md-clear=` as a deprecated alias.

  Rename opt_md_clear_{pv,hvm} and opt_fb_clear_mmio to opt_verw_{pv,hvm,mmio},
  which has a side effect of making spec_ctrl_init_domain() rather clearer to
  follow.

  No functional change.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit f7603ca252e4226739eb3129a5290ee3da3f8ea4)
  76af773de5d3e68b7140cc9c5343be6746c9101c:x86/spec-ctrl: Perform VERW flushing later in exit paths

  On parts vulnerable to RFDS, VERW's side effects are extended to scrub all
  non-architectural entries in various Physical Register Files.  To remove all
  of Xen's values, the VERW must be after popping the GPRs.

  Rework SPEC_CTRL_COND_VERW to default to an CPUINFO_error_code %rsp position,
  but with overrides for other contexts.  Identify that it clobbers eflags; this
  is particularly relevant for the SYSRET path.

  For the IST exit return to Xen, have the main SPEC_CTRL_EXIT_TO_XEN put a
  shadow copy of spec_ctrl_flags, as GPRs can't be used at the point we want to
  issue the VERW.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7)
  77f2bec134049aba29b9b459f955022722d10847:x86/vmx: Perform VERW flushing later in the VMExit path

  Broken out of the following patch because this change is subtle enough on its
  own.  See it for the rational of why we're moving VERW.

  As for how, extend the trick already used to hold one condition in
  flags (RESUME vs LAUNCH) through the POPing of GPRs.

  Move the MOV CR earlier.  Intel specify flags to be undefined across it.

  Encode the two conditions we want using SF and PF.  See the code comment for
  exactly how.

  Leave a comment to explain the lack of any content around
  SPEC_CTRL_EXIT_TO_VMX, but leave the block in place.  Sods law says if we
  delete it, we'll need to reintroduce it.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 475fa20b7384464210f42bad7195f87bd6f1c63f)
  908cbd1893e80eb52b92b2c70c2bfd9ffdf6f77b:x86/spec-ctrl: Mitigation Register File Data Sampling

  RFDS affects Atom cores, also branded E-cores, between the Goldmont and
  Gracemont microarchitectures.  This includes Alder Lake and Raptor Lake hybrid
  clien systems which have a mix of Gracemont and other types of cores.

  Two new bits have been defined; RFDS_CLEAR to indicate VERW has more side
  effets, and RFDS_NO to incidate that the system is unaffected.  Plenty of
  unaffected CPUs won't be getting RFDS_NO retrofitted in microcode, so we
  synthesise it.  Alder Lake and Raptor Lake Xeon-E's are unaffected due to
  their platform configuration, and we must use the Hybrid CPUID bit to
  distinguish them from their non-Xeon counterparts.

  Like MD_CLEAR and FB_CLEAR, RFDS_CLEAR needs OR-ing across a resource pool, so
  set it in the max policies and reflect the host setting in default.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit fb5b6f6744713410c74cfc12b7176c108e3c9a31)
  fb85a8fc91f8cfd61d7c7f9742502b223d4024b5:x86/spec-ctrl: VERW-handling adjustments

  ... before we add yet more complexity to this logic.  Mostly expanded
  comments, but with three minor changes.

  1) Introduce cpu_has_useful_md_clear to simplify later logic in this patch and
     future ones.

  2) We only ever need SC_VERW_IDLE when SMT is active.  If SMT isn't active,
     then there's no re-partition of pipeline resources based on thread-idleness
     to worry about.

  3) The logic to adjust HVM VERW based on L1D_FLUSH is unmaintainable and, as
     it turns out, wrong.  SKIP_L1DFL is just a hint bit, whereas opt_l1d_flush
     is the relevant decision of whether to use L1D_FLUSH based on
     susceptibility and user preference.

     Rewrite the logic so it can be followed, and incorporate the fact that when
     FB_CLEAR is visible, L1D_FLUSH isn't a safe substitution.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Acked-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 1eb91a8a06230b4b64228c9a380194f8cfe6c5e2)
  b7205fc1cbad0c633e92d2d019a02a507467507b:x86/spec-ctrl: Rename VERW related options

  VERW is going to be used for a 3rd purpose, and the existing nomenclature
  didn't survive the Stale MMIO issues terribly well.

  Rename the command line option from `md-clear=` to `verw=`.  This is more
  consistent with other options which tend to be named based on what they're
  doing, not which feature enumeration they use behind the scenes.  Retain
  `md-clear=` as a deprecated alias.

  Rename opt_md_clear_{pv,hvm} and opt_fb_clear_mmio to opt_verw_{pv,hvm,mmio},
  which has a side effect of making spec_ctrl_init_domain() rather clearer to
  follow.

  No functional change.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit f7603ca252e4226739eb3129a5290ee3da3f8ea4)
  95dd34fdbea5408872d5c244fe268222a4f145d0:x86/spec-ctrl: Perform VERW flushing later in exit paths

  On parts vulnerable to RFDS, VERW's side effects are extended to scrub all
  non-architectural entries in various Physical Register Files.  To remove all
  of Xen's values, the VERW must be after popping the GPRs.

  Rework SPEC_CTRL_COND_VERW to default to an CPUINFO_error_code %rsp position,
  but with overrides for other contexts.  Identify that it clobbers eflags; this
  is particularly relevant for the SYSRET path.

  For the IST exit return to Xen, have the main SPEC_CTRL_EXIT_TO_XEN put a
  shadow copy of spec_ctrl_flags, as GPRs can't be used at the point we want to
  issue the VERW.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7)
  9f89ec65fbe49c3be32a456091097d7ef017d268:x86/vmx: Perform VERW flushing later in the VMExit path

  Broken out of the following patch because this change is subtle enough on its
  own.  See it for the rational of why we're moving VERW.

  As for how, extend the trick already used to hold one condition in
  flags (RESUME vs LAUNCH) through the POPing of GPRs.

  Move the MOV CR earlier.  Intel specify flags to be undefined across it.

  Encode the two conditions we want using SF and PF.  See the code comment for
  exactly how.

  Leave a comment to explain the lack of any content around
  SPEC_CTRL_EXIT_TO_VMX, but leave the block in place.  Sods law says if we
  delete it, we'll need to reintroduce it.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 475fa20b7384464210f42bad7195f87bd6f1c63f)
  fb5b6f6744713410c74cfc12b7176c108e3c9a31:x86/spec-ctrl: Mitigation Register File Data Sampling

  RFDS affects Atom cores, also branded E-cores, between the Goldmont and
  Gracemont microarchitectures.  This includes Alder Lake and Raptor Lake hybrid
  clien systems which have a mix of Gracemont and other types of cores.

  Two new bits have been defined; RFDS_CLEAR to indicate VERW has more side
  effets, and RFDS_NO to incidate that the system is unaffected.  Plenty of
  unaffected CPUs won't be getting RFDS_NO retrofitted in microcode, so we
  synthesise it.  Alder Lake and Raptor Lake Xeon-E's are unaffected due to
  their platform configuration, and we must use the Hybrid CPUID bit to
  distinguish them from their non-Xeon counterparts.

  Like MD_CLEAR and FB_CLEAR, RFDS_CLEAR needs OR-ing across a resource pool, so
  set it in the max policies and reflect the host setting in default.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  1eb91a8a06230b4b64228c9a380194f8cfe6c5e2:x86/spec-ctrl: VERW-handling adjustments

  ... before we add yet more complexity to this logic.  Mostly expanded
  comments, but with three minor changes.

  1) Introduce cpu_has_useful_md_clear to simplify later logic in this patch and
     future ones.

  2) We only ever need SC_VERW_IDLE when SMT is active.  If SMT isn't active,
     then there's no re-partition of pipeline resources based on thread-idleness
     to worry about.

  3) The logic to adjust HVM VERW based on L1D_FLUSH is unmaintainable and, as
     it turns out, wrong.  SKIP_L1DFL is just a hint bit, whereas opt_l1d_flush
     is the relevant decision of whether to use L1D_FLUSH based on
     susceptibility and user preference.

     Rewrite the logic so it can be followed, and incorporate the fact that when
     FB_CLEAR is visible, L1D_FLUSH isn't a safe substitution.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Acked-by: Jan Beulich <jbeulich@suse.com>
  f7603ca252e4226739eb3129a5290ee3da3f8ea4:x86/spec-ctrl: Rename VERW related options

  VERW is going to be used for a 3rd purpose, and the existing nomenclature
  didn't survive the Stale MMIO issues terribly well.

  Rename the command line option from `md-clear=` to `verw=`.  This is more
  consistent with other options which tend to be named based on what they're
  doing, not which feature enumeration they use behind the scenes.  Retain
  `md-clear=` as a deprecated alias.

  Rename opt_md_clear_{pv,hvm} and opt_fb_clear_mmio to opt_verw_{pv,hvm,mmio},
  which has a side effect of making spec_ctrl_init_domain() rather clearer to
  follow.

  No functional change.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7:x86/spec-ctrl: Perform VERW flushing later in exit paths

  On parts vulnerable to RFDS, VERW's side effects are extended to scrub all
  non-architectural entries in various Physical Register Files.  To remove all
  of Xen's values, the VERW must be after popping the GPRs.

  Rework SPEC_CTRL_COND_VERW to default to an CPUINFO_error_code %rsp position,
  but with overrides for other contexts.  Identify that it clobbers eflags; this
  is particularly relevant for the SYSRET path.

  For the IST exit return to Xen, have the main SPEC_CTRL_EXIT_TO_XEN put a
  shadow copy of spec_ctrl_flags, as GPRs can't be used at the point we want to
  issue the VERW.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  475fa20b7384464210f42bad7195f87bd6f1c63f:x86/vmx: Perform VERW flushing later in the VMExit path

  Broken out of the following patch because this change is subtle enough on its
  own.  See it for the rational of why we're moving VERW.

  As for how, extend the trick already used to hold one condition in
  flags (RESUME vs LAUNCH) through the POPing of GPRs.

  Move the MOV CR earlier.  Intel specify flags to be undefined across it.

  Encode the two conditions we want using SF and PF.  See the code comment for
  exactly how.

  Leave a comment to explain the lack of any content around
  SPEC_CTRL_EXIT_TO_VMX, but leave the block in place.  Sods law says if we
  delete it, we'll need to reintroduce it.

  This is part of XSA-452 / CVE-2023-28746.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 762cd5423635a8f0f69eb71ce10c5a62c47247ac
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 92e7aab34337aa6b68a506861992822c079ee175
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 76af773de5d3e68b7140cc9c5343be6746c9101c
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a7ae8dbd8f4518b3d56d41d32931587b9027bc7b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: fb5b6f6744713410c74cfc12b7176c108e3c9a31
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: b7205fc1cbad0c633e92d2d019a02a507467507b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a8f99b49075ea30e5a074eb0579609a4ea0a44a3
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d85481135d87abbbf1feab18b749288fa08b65f2
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: eeed8a8ef62af7136b2cee0da00eb00c90d2fec0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d636a6d1d4325f1b448ea7613bce909ccf99420b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 1eb91a8a06230b4b64228c9a380194f8cfe6c5e2
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 9f89ec65fbe49c3be32a456091097d7ef017d268
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 475fa20b7384464210f42bad7195f87bd6f1c63f
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 77f2bec134049aba29b9b459f955022722d10847
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 6663430b442fdf9698bd8e03f701a4547309ad71
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3bf73a02cb770682587c1c7e3c254ddb18e7b261
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7c69a025f141ada31f5bd1b1a3e35eacd9543e45
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: f7603ca252e4226739eb3129a5290ee3da3f8ea4
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 95dd34fdbea5408872d5c244fe268222a4f145d0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 638b6b21702ebf5a028a166261e4353d3028c7bd
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d55d52961d13d4fcd1441fcfca98f690e687b941
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 908cbd1893e80eb52b92b2c70c2bfd9ffdf6f77b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: fb85a8fc91f8cfd61d7c7f9742502b223d4024b5
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a8c4726320e89ffa68d60d423ab88e1829b7b535
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7
    reference_type: commit
    reference_id: 0a666cf2cd99df6faf3eebc81a1fc286e4eca4c7
  - url: https://github.com/xen-project/xen/tree/1eb91a8a06230b4b64228c9a380194f8cfe6c5e2
    reference_type: commit
    reference_id: 1eb91a8a06230b4b64228c9a380194f8cfe6c5e2
  - url: https://github.com/xen-project/xen/tree/3bf73a02cb770682587c1c7e3c254ddb18e7b261
    reference_type: commit
    reference_id: 3bf73a02cb770682587c1c7e3c254ddb18e7b261
  - url: https://github.com/xen-project/xen/tree/475fa20b7384464210f42bad7195f87bd6f1c63f
    reference_type: commit
    reference_id: 475fa20b7384464210f42bad7195f87bd6f1c63f
  - url: https://github.com/xen-project/xen/tree/638b6b21702ebf5a028a166261e4353d3028c7bd
    reference_type: commit
    reference_id: 638b6b21702ebf5a028a166261e4353d3028c7bd
  - url: https://github.com/xen-project/xen/tree/6663430b442fdf9698bd8e03f701a4547309ad71
    reference_type: commit
    reference_id: 6663430b442fdf9698bd8e03f701a4547309ad71
  - url: https://github.com/xen-project/xen/tree/762cd5423635a8f0f69eb71ce10c5a62c47247ac
    reference_type: commit
    reference_id: 762cd5423635a8f0f69eb71ce10c5a62c47247ac
  - url: https://github.com/xen-project/xen/tree/76af773de5d3e68b7140cc9c5343be6746c9101c
    reference_type: commit
    reference_id: 76af773de5d3e68b7140cc9c5343be6746c9101c
  - url: https://github.com/xen-project/xen/tree/77f2bec134049aba29b9b459f955022722d10847
    reference_type: commit
    reference_id: 77f2bec134049aba29b9b459f955022722d10847
  - url: https://github.com/xen-project/xen/tree/7c69a025f141ada31f5bd1b1a3e35eacd9543e45
    reference_type: commit
    reference_id: 7c69a025f141ada31f5bd1b1a3e35eacd9543e45
  - url: https://github.com/xen-project/xen/tree/908cbd1893e80eb52b92b2c70c2bfd9ffdf6f77b
    reference_type: commit
    reference_id: 908cbd1893e80eb52b92b2c70c2bfd9ffdf6f77b
  - url: https://github.com/xen-project/xen/tree/92e7aab34337aa6b68a506861992822c079ee175
    reference_type: commit
    reference_id: 92e7aab34337aa6b68a506861992822c079ee175
  - url: https://github.com/xen-project/xen/tree/95dd34fdbea5408872d5c244fe268222a4f145d0
    reference_type: commit
    reference_id: 95dd34fdbea5408872d5c244fe268222a4f145d0
  - url: https://github.com/xen-project/xen/tree/9f89ec65fbe49c3be32a456091097d7ef017d268
    reference_type: commit
    reference_id: 9f89ec65fbe49c3be32a456091097d7ef017d268
  - url: https://github.com/xen-project/xen/tree/a7ae8dbd8f4518b3d56d41d32931587b9027bc7b
    reference_type: commit
    reference_id: a7ae8dbd8f4518b3d56d41d32931587b9027bc7b
  - url: https://github.com/xen-project/xen/tree/a8c4726320e89ffa68d60d423ab88e1829b7b535
    reference_type: commit
    reference_id: a8c4726320e89ffa68d60d423ab88e1829b7b535
  - url: https://github.com/xen-project/xen/tree/a8f99b49075ea30e5a074eb0579609a4ea0a44a3
    reference_type: commit
    reference_id: a8f99b49075ea30e5a074eb0579609a4ea0a44a3
  - url: https://github.com/xen-project/xen/tree/b7205fc1cbad0c633e92d2d019a02a507467507b
    reference_type: commit
    reference_id: b7205fc1cbad0c633e92d2d019a02a507467507b
  - url: https://github.com/xen-project/xen/tree/d55d52961d13d4fcd1441fcfca98f690e687b941
    reference_type: commit
    reference_id: d55d52961d13d4fcd1441fcfca98f690e687b941
  - url: https://github.com/xen-project/xen/tree/d636a6d1d4325f1b448ea7613bce909ccf99420b
    reference_type: commit
    reference_id: d636a6d1d4325f1b448ea7613bce909ccf99420b
  - url: https://github.com/xen-project/xen/tree/d85481135d87abbbf1feab18b749288fa08b65f2
    reference_type: commit
    reference_id: d85481135d87abbbf1feab18b749288fa08b65f2
  - url: https://github.com/xen-project/xen/tree/eeed8a8ef62af7136b2cee0da00eb00c90d2fec0
    reference_type: commit
    reference_id: eeed8a8ef62af7136b2cee0da00eb00c90d2fec0
  - url: https://github.com/xen-project/xen/tree/f7603ca252e4226739eb3129a5290ee3da3f8ea4
    reference_type: commit
    reference_id: f7603ca252e4226739eb3129a5290ee3da3f8ea4
  - url: https://github.com/xen-project/xen/tree/fb5b6f6744713410c74cfc12b7176c108e3c9a31
    reference_type: commit
    reference_id: fb5b6f6744713410c74cfc12b7176c108e3c9a31
  - url: https://github.com/xen-project/xen/tree/fb85a8fc91f8cfd61d7c7f9742502b223d4024b5
    reference_type: commit
    reference_id: fb85a8fc91f8cfd61d7c7f9742502b223d4024b5
