advisory_id: CVE-2023-34327
datasource_id: collect_xen_project_fix_commits/CVE-2023-34327
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  5d54282f984bb9a7a65b3d12208584f9fdf1c8e1:x86/svm: Fix asymmetry with AMD DR MASK context switching

  The handling of MSR_DR{0..3}_MASK is asymmetric between PV and HVM guests.

  HVM guests context switch in based on the guest view of DBEXT, whereas PV
  guest switch in base on the host capability.  Both guest types leave the
  context dirty for the next vCPU.

  This leads to the following issue:

   * PV or HVM vCPU has debugging active (%dr7 + mask)
   * Switch out deactivates %dr7 but leaves other state stale in hardware
   * HVM vCPU with debugging activate but can't see DBEXT is switched in
   * Switch in loads %dr7 but leaves the mask MSRs alone

  Now, the HVM vCPU is operating in the context of the prior vCPU's mask MSR,
  and furthermore in a case where it genuinely expects there to be no masking
  MSRs.

  As a stopgap, adjust the HVM path to switch in/out the masks based on host
  capabilities rather than guest visibility (i.e. like the PV path).  Adjustment
  of the of the intercepts still needs to be dependent on the guest visibility
  of DBEXT.

  This is part of XSA-444 / CVE-2023-34327

  Fixes: c097f54912d3 ("x86/SVM: support data breakpoint extension registers")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  1f0d217f054b4b9f2d2990dc8721488ca550c5a4:x86/svm: Fix asymmetry with AMD DR MASK context switching

  The handling of MSR_DR{0..3}_MASK is asymmetric between PV and HVM guests.

  HVM guests context switch in based on the guest view of DBEXT, whereas PV
  guest switch in base on the host capability.  Both guest types leave the
  context dirty for the next vCPU.

  This leads to the following issue:

   * PV or HVM vCPU has debugging active (%dr7 + mask)
   * Switch out deactivates %dr7 but leaves other state stale in hardware
   * HVM vCPU with debugging activate but can't see DBEXT is switched in
   * Switch in loads %dr7 but leaves the mask MSRs alone

  Now, the HVM vCPU is operating in the context of the prior vCPU's mask MSR,
  and furthermore in a case where it genuinely expects there to be no masking
  MSRs.

  As a stopgap, adjust the HVM path to switch in/out the masks based on host
  capabilities rather than guest visibility (i.e. like the PV path).  Adjustment
  of the of the intercepts still needs to be dependent on the guest visibility
  of DBEXT.

  This is part of XSA-444 / CVE-2023-34327

  Fixes: c097f54912d3 ("x86/SVM: support data breakpoint extension registers")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  (cherry picked from commit 5d54282f984bb9a7a65b3d12208584f9fdf1c8e1)
  3c22a9bf8703a297431ac5ad110e6d523758eae1:x86/svm: Fix asymmetry with AMD DR MASK context switching

  The handling of MSR_DR{0..3}_MASK is asymmetric between PV and HVM guests.

  HVM guests context switch in based on the guest view of DBEXT, whereas PV
  guest switch in base on the host capability.  Both guest types leave the
  context dirty for the next vCPU.

  This leads to the following issue:

   * PV or HVM vCPU has debugging active (%dr7 + mask)
   * Switch out deactivates %dr7 but leaves other state stale in hardware
   * HVM vCPU with debugging activate but can't see DBEXT is switched in
   * Switch in loads %dr7 but leaves the mask MSRs alone

  Now, the HVM vCPU is operating in the context of the prior vCPU's mask MSR,
  and furthermore in a case where it genuinely expects there to be no masking
  MSRs.

  As a stopgap, adjust the HVM path to switch in/out the masks based on host
  capabilities rather than guest visibility (i.e. like the PV path).  Adjustment
  of the of the intercepts still needs to be dependent on the guest visibility
  of DBEXT.

  This is part of XSA-444 / CVE-2023-34327

  Fixes: c097f54912d3 ("x86/SVM: support data breakpoint extension registers")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  (cherry picked from commit 5d54282f984bb9a7a65b3d12208584f9fdf1c8e1)
  3f8b444072fd8615288d9d11e53fbf0b6a8a7750:x86/svm: Fix asymmetry with AMD DR MASK context switching

  The handling of MSR_DR{0..3}_MASK is asymmetric between PV and HVM guests.

  HVM guests context switch in based on the guest view of DBEXT, whereas PV
  guest switch in base on the host capability.  Both guest types leave the
  context dirty for the next vCPU.

  This leads to the following issue:

   * PV or HVM vCPU has debugging active (%dr7 + mask)
   * Switch out deactivates %dr7 but leaves other state stale in hardware
   * HVM vCPU with debugging activate but can't see DBEXT is switched in
   * Switch in loads %dr7 but leaves the mask MSRs alone

  Now, the HVM vCPU is operating in the context of the prior vCPU's mask MSR,
  and furthermore in a case where it genuinely expects there to be no masking
  MSRs.

  As a stopgap, adjust the HVM path to switch in/out the masks based on host
  capabilities rather than guest visibility (i.e. like the PV path).  Adjustment
  of the of the intercepts still needs to be dependent on the guest visibility
  of DBEXT.

  This is part of XSA-444 / CVE-2023-34327

  Fixes: c097f54912d3 ("x86/SVM: support data breakpoint extension registers")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  (cherry picked from commit 5d54282f984bb9a7a65b3d12208584f9fdf1c8e1)
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 5d54282f984bb9a7a65b3d12208584f9fdf1c8e1
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3f8b444072fd8615288d9d11e53fbf0b6a8a7750
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 1f0d217f054b4b9f2d2990dc8721488ca550c5a4
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3c22a9bf8703a297431ac5ad110e6d523758eae1
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/1f0d217f054b4b9f2d2990dc8721488ca550c5a4
    reference_type: commit
    reference_id: 1f0d217f054b4b9f2d2990dc8721488ca550c5a4
  - url: https://github.com/xen-project/xen/tree/3c22a9bf8703a297431ac5ad110e6d523758eae1
    reference_type: commit
    reference_id: 3c22a9bf8703a297431ac5ad110e6d523758eae1
  - url: https://github.com/xen-project/xen/tree/3f8b444072fd8615288d9d11e53fbf0b6a8a7750
    reference_type: commit
    reference_id: 3f8b444072fd8615288d9d11e53fbf0b6a8a7750
  - url: https://github.com/xen-project/xen/tree/5d54282f984bb9a7a65b3d12208584f9fdf1c8e1
    reference_type: commit
    reference_id: 5d54282f984bb9a7a65b3d12208584f9fdf1c8e1
