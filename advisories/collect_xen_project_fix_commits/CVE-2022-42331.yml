advisory_id: CVE-2022-42331
datasource_id: collect_xen_project_fix_commits/CVE-2022-42331
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  e49571868d67944b9f4a546ade130e0b6e506b65:x86/spec-ctrl: Defer CR4_PV32_RESTORE on the cstar_enter path

  As stated (correctly) by the comment next to SPEC_CTRL_ENTRY_FROM_PV, between
  the two hunks visible in the patch, RET's are not safe prior to this point.

  CR4_PV32_RESTORE hides a CALL/RET pair in certain configurations (PV32
  compiled in, SMEP or SMAP active), and the RET can be attacked with one of
  several known speculative issues.

  Furthermore, CR4_PV32_RESTORE also hides a reference to the cr4_pv32_mask
  global variable, which is not safe when XPTI is active before restoring Xen's
  full pagetables.

  This crash has gone unnoticed because it is only AMD CPUs which permit the
  SYSCALL instruction in compatibility mode, and these are not vulnerable to
  Meltdown so don't activate XPTI by default.

  This is XSA-429 / CVE-2022-42331

  Fixes: 5e7962901131 ("x86/entry: Organise the use of MSR_SPEC_CTRL at each entry/exit point")
  Fixes: 5784de3e2067 ("x86: Meltdown band-aid against malicious 64-bit PV guests")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit df5b055b12116d9e63ced59ae5389e69a2a3de48)
  11193e13e5359ba1896be46be3e9b468154c1295:x86/spec-ctrl: Defer CR4_PV32_RESTORE on the cstar_enter path

  As stated (correctly) by the comment next to SPEC_CTRL_ENTRY_FROM_PV, between
  the two hunks visible in the patch, RET's are not safe prior to this point.

  CR4_PV32_RESTORE hides a CALL/RET pair in certain configurations (PV32
  compiled in, SMEP or SMAP active), and the RET can be attacked with one of
  several known speculative issues.

  Furthermore, CR4_PV32_RESTORE also hides a reference to the cr4_pv32_mask
  global variable, which is not safe when XPTI is active before restoring Xen's
  full pagetables.

  This crash has gone unnoticed because it is only AMD CPUs which permit the
  SYSCALL instruction in compatibility mode, and these are not vulnerable to
  Meltdown so don't activate XPTI by default.

  This is XSA-429 / CVE-2022-42331

  Fixes: 5e7962901131 ("x86/entry: Organise the use of MSR_SPEC_CTRL at each entry/exit point")
  Fixes: 5784de3e2067 ("x86: Meltdown band-aid against malicious 64-bit PV guests")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit df5b055b12116d9e63ced59ae5389e69a2a3de48)
  3c924fe46b455834b5c04268db6b528b549668d1:x86/spec-ctrl: Defer CR4_PV32_RESTORE on the cstar_enter path

  As stated (correctly) by the comment next to SPEC_CTRL_ENTRY_FROM_PV, between
  the two hunks visible in the patch, RET's are not safe prior to this point.

  CR4_PV32_RESTORE hides a CALL/RET pair in certain configurations (PV32
  compiled in, SMEP or SMAP active), and the RET can be attacked with one of
  several known speculative issues.

  Furthermore, CR4_PV32_RESTORE also hides a reference to the cr4_pv32_mask
  global variable, which is not safe when XPTI is active before restoring Xen's
  full pagetables.

  This crash has gone unnoticed because it is only AMD CPUs which permit the
  SYSCALL instruction in compatibility mode, and these are not vulnerable to
  Meltdown so don't activate XPTI by default.

  This is XSA-429 / CVE-2022-42331

  Fixes: 5e7962901131 ("x86/entry: Organise the use of MSR_SPEC_CTRL at each entry/exit point")
  Fixes: 5784de3e2067 ("x86: Meltdown band-aid against malicious 64-bit PV guests")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit df5b055b12116d9e63ced59ae5389e69a2a3de48)
  245d030f4aa79f766e575684127f86748c63bb32:x86/spec-ctrl: Defer CR4_PV32_RESTORE on the cstar_enter path

  As stated (correctly) by the comment next to SPEC_CTRL_ENTRY_FROM_PV, between
  the two hunks visible in the patch, RET's are not safe prior to this point.

  CR4_PV32_RESTORE hides a CALL/RET pair in certain configurations (PV32
  compiled in, SMEP or SMAP active), and the RET can be attacked with one of
  several known speculative issues.

  Furthermore, CR4_PV32_RESTORE also hides a reference to the cr4_pv32_mask
  global variable, which is not safe when XPTI is active before restoring Xen's
  full pagetables.

  This crash has gone unnoticed because it is only AMD CPUs which permit the
  SYSCALL instruction in compatibility mode, and these are not vulnerable to
  Meltdown so don't activate XPTI by default.

  This is XSA-429 / CVE-2022-42331

  Fixes: 5e7962901131 ("x86/entry: Organise the use of MSR_SPEC_CTRL at each entry/exit point")
  Fixes: 5784de3e2067 ("x86: Meltdown band-aid against malicious 64-bit PV guests")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  a730e4d1190594102784222f76a984d10bbc88a9:x86/spec-ctrl: Defer CR4_PV32_RESTORE on the cstar_enter path

  As stated (correctly) by the comment next to SPEC_CTRL_ENTRY_FROM_PV, between
  the two hunks visible in the patch, RET's are not safe prior to this point.

  CR4_PV32_RESTORE hides a CALL/RET pair in certain configurations (PV32
  compiled in, SMEP or SMAP active), and the RET can be attacked with one of
  several known speculative issues.

  Furthermore, CR4_PV32_RESTORE also hides a reference to the cr4_pv32_mask
  global variable, which is not safe when XPTI is active before restoring Xen's
  full pagetables.

  This crash has gone unnoticed because it is only AMD CPUs which permit the
  SYSCALL instruction in compatibility mode, and these are not vulnerable to
  Meltdown so don't activate XPTI by default.

  This is XSA-429 / CVE-2022-42331

  Fixes: 5e7962901131 ("x86/entry: Organise the use of MSR_SPEC_CTRL at each entry/exit point")
  Fixes: 5784de3e2067 ("x86: Meltdown band-aid against malicious 64-bit PV guests")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit df5b055b12116d9e63ced59ae5389e69a2a3de48)
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 245d030f4aa79f766e575684127f86748c63bb32
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3c924fe46b455834b5c04268db6b528b549668d1
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 11193e13e5359ba1896be46be3e9b468154c1295
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a730e4d1190594102784222f76a984d10bbc88a9
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e49571868d67944b9f4a546ade130e0b6e506b65
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/11193e13e5359ba1896be46be3e9b468154c1295
    reference_type: commit
    reference_id: 11193e13e5359ba1896be46be3e9b468154c1295
  - url: https://github.com/xen-project/xen/tree/245d030f4aa79f766e575684127f86748c63bb32
    reference_type: commit
    reference_id: 245d030f4aa79f766e575684127f86748c63bb32
  - url: https://github.com/xen-project/xen/tree/3c924fe46b455834b5c04268db6b528b549668d1
    reference_type: commit
    reference_id: 3c924fe46b455834b5c04268db6b528b549668d1
  - url: https://github.com/xen-project/xen/tree/a730e4d1190594102784222f76a984d10bbc88a9
    reference_type: commit
    reference_id: a730e4d1190594102784222f76a984d10bbc88a9
  - url: https://github.com/xen-project/xen/tree/e49571868d67944b9f4a546ade130e0b6e506b65
    reference_type: commit
    reference_id: e49571868d67944b9f4a546ade130e0b6e506b65
