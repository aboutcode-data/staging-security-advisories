advisory_id: CVE-2022-26359
datasource_id: collect_xen_project_fix_commits/CVE-2022-26359
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  18479bf16d62b232830ad7247ebb50e598319db3:VT-d: re-assign devices directly

  Devices with RMRRs, due to it being unspecified how/when the specified
  memory regions may get accessed, may not be left disconnected from their
  respective mappings (as long as it's not certain that the device has
  been fully quiesced). Hence rather than unmapping the old context and
  then mapping the new one, re-assignment needs to be done in a single
  step.

  This is CVE-2022-26359 / part of XSA-400.

  Reported-by: Roger Pau Monné <roger.pau@citrix.com>

  Similarly quarantining scratch-page mode relies on page tables to be
  continuously wired up.

  To avoid complicating things more than necessary, treat all devices
  mostly equally, i.e. regardless of their association with any RMRRs. The
  main difference is when it comes to updating context entries, which need
  to be atomic when there are RMRRs. Yet atomicity can only be achieved
  with CMPXCHG16B, availability of which we can't take for given.

  The seemingly complicated choice of non-negative return values for
  domain_context_mapping_one() is to limit code churn: This way callers
  passing NULL for pdev don't need fiddling with.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Kevin Tian <kevin.tian@intel.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: 8f41e481b4852173909363b88c1ab3da747d3a05
  master date: 2022-04-05 14:17:42 +0200
  235aa158e0f71ee2bf20155ce6b0b429acf59d37:VT-d: re-assign devices directly

  Devices with RMRRs, due to it being unspecified how/when the specified
  memory regions may get accessed, may not be left disconnected from their
  respective mappings (as long as it's not certain that the device has
  been fully quiesced). Hence rather than unmapping the old context and
  then mapping the new one, re-assignment needs to be done in a single
  step.

  This is CVE-2022-26359 / part of XSA-400.

  Reported-by: Roger Pau Monné <roger.pau@citrix.com>

  Similarly quarantining scratch-page mode relies on page tables to be
  continuously wired up.

  To avoid complicating things more than necessary, treat all devices
  mostly equally, i.e. regardless of their association with any RMRRs. The
  main difference is when it comes to updating context entries, which need
  to be atomic when there are RMRRs. Yet atomicity can only be achieved
  with CMPXCHG16B, availability of which we can't take for given.

  The seemingly complicated choice of non-negative return values for
  domain_context_mapping_one() is to limit code churn: This way callers
  passing NULL for pdev don't need fiddling with.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Kevin Tian <kevin.tian@intel.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: 8f41e481b4852173909363b88c1ab3da747d3a05
  master date: 2022-04-05 14:17:42 +0200
  8a9a21b1add6d96cffd028f2546b1c31f2e98210:VT-d: re-assign devices directly

  Devices with RMRRs, due to it being unspecified how/when the specified
  memory regions may get accessed, may not be left disconnected from their
  respective mappings (as long as it's not certain that the device has
  been fully quiesced). Hence rather than unmapping the old context and
  then mapping the new one, re-assignment needs to be done in a single
  step.

  This is CVE-2022-26359 / part of XSA-400.

  Reported-by: Roger Pau Monné <roger.pau@citrix.com>

  Similarly quarantining scratch-page mode relies on page tables to be
  continuously wired up.

  To avoid complicating things more than necessary, treat all devices
  mostly equally, i.e. regardless of their association with any RMRRs. The
  main difference is when it comes to updating context entries, which need
  to be atomic when there are RMRRs. Yet atomicity can only be achieved
  with CMPXCHG16B, availability of which we can't take for given.

  The seemingly complicated choice of non-negative return values for
  domain_context_mapping_one() is to limit code churn: This way callers
  passing NULL for pdev don't need fiddling with.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Kevin Tian <kevin.tian@intel.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: 8f41e481b4852173909363b88c1ab3da747d3a05
  master date: 2022-04-05 14:17:42 +0200
  d67a72c655cb884f0090e0fe4f977d0d75c6b94d:VT-d: re-assign devices directly

  Devices with RMRRs, due to it being unspecified how/when the specified
  memory regions may get accessed, may not be left disconnected from their
  respective mappings (as long as it's not certain that the device has
  been fully quiesced). Hence rather than unmapping the old context and
  then mapping the new one, re-assignment needs to be done in a single
  step.

  This is CVE-2022-26359 / part of XSA-400.

  Reported-by: Roger Pau Monné <roger.pau@citrix.com>

  Similarly quarantining scratch-page mode relies on page tables to be
  continuously wired up.

  To avoid complicating things more than necessary, treat all devices
  mostly equally, i.e. regardless of their association with any RMRRs. The
  main difference is when it comes to updating context entries, which need
  to be atomic when there are RMRRs. Yet atomicity can only be achieved
  with CMPXCHG16B, availability of which we can't take for given.

  The seemingly complicated choice of non-negative return values for
  domain_context_mapping_one() is to limit code churn: This way callers
  passing NULL for pdev don't need fiddling with.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Kevin Tian <kevin.tian@intel.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: 8f41e481b4852173909363b88c1ab3da747d3a05
  master date: 2022-04-05 14:17:42 +0200
  e579153bfe650d533525e46709a2ed6610303dfb:VT-d: re-assign devices directly

  Devices with RMRRs, due to it being unspecified how/when the specified
  memory regions may get accessed, may not be left disconnected from their
  respective mappings (as long as it's not certain that the device has
  been fully quiesced). Hence rather than unmapping the old context and
  then mapping the new one, re-assignment needs to be done in a single
  step.

  This is CVE-2022-26359 / part of XSA-400.

  Reported-by: Roger Pau Monné <roger.pau@citrix.com>

  Similarly quarantining scratch-page mode relies on page tables to be
  continuously wired up.

  To avoid complicating things more than necessary, treat all devices
  mostly equally, i.e. regardless of their association with any RMRRs. The
  main difference is when it comes to updating context entries, which need
  to be atomic when there are RMRRs. Yet atomicity can only be achieved
  with CMPXCHG16B, availability of which we can't take for given.

  The seemingly complicated choice of non-negative return values for
  domain_context_mapping_one() is to limit code churn: This way callers
  passing NULL for pdev don't need fiddling with.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Kevin Tian <kevin.tian@intel.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: 8f41e481b4852173909363b88c1ab3da747d3a05
  master date: 2022-04-05 14:17:42 +0200
  8f41e481b4852173909363b88c1ab3da747d3a05:VT-d: re-assign devices directly

  Devices with RMRRs, due to it being unspecified how/when the specified
  memory regions may get accessed, may not be left disconnected from their
  respective mappings (as long as it's not certain that the device has
  been fully quiesced). Hence rather than unmapping the old context and
  then mapping the new one, re-assignment needs to be done in a single
  step.

  This is CVE-2022-26359 / part of XSA-400.

  Reported-by: Roger Pau Monné <roger.pau@citrix.com>

  Similarly quarantining scratch-page mode relies on page tables to be
  continuously wired up.

  To avoid complicating things more than necessary, treat all devices
  mostly equally, i.e. regardless of their association with any RMRRs. The
  main difference is when it comes to updating context entries, which need
  to be atomic when there are RMRRs. Yet atomicity can only be achieved
  with CMPXCHG16B, availability of which we can't take for given.

  The seemingly complicated choice of non-negative return values for
  domain_context_mapping_one() is to limit code churn: This way callers
  passing NULL for pdev don't need fiddling with.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Kevin Tian <kevin.tian@intel.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d67a72c655cb884f0090e0fe4f977d0d75c6b94d
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 18479bf16d62b232830ad7247ebb50e598319db3
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 8f41e481b4852173909363b88c1ab3da747d3a05
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 8a9a21b1add6d96cffd028f2546b1c31f2e98210
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 235aa158e0f71ee2bf20155ce6b0b429acf59d37
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e579153bfe650d533525e46709a2ed6610303dfb
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/18479bf16d62b232830ad7247ebb50e598319db3
    reference_type: commit
    reference_id: 18479bf16d62b232830ad7247ebb50e598319db3
  - url: https://github.com/xen-project/xen/tree/235aa158e0f71ee2bf20155ce6b0b429acf59d37
    reference_type: commit
    reference_id: 235aa158e0f71ee2bf20155ce6b0b429acf59d37
  - url: https://github.com/xen-project/xen/tree/8a9a21b1add6d96cffd028f2546b1c31f2e98210
    reference_type: commit
    reference_id: 8a9a21b1add6d96cffd028f2546b1c31f2e98210
  - url: https://github.com/xen-project/xen/tree/8f41e481b4852173909363b88c1ab3da747d3a05
    reference_type: commit
    reference_id: 8f41e481b4852173909363b88c1ab3da747d3a05
  - url: https://github.com/xen-project/xen/tree/d67a72c655cb884f0090e0fe4f977d0d75c6b94d
    reference_type: commit
    reference_id: d67a72c655cb884f0090e0fe4f977d0d75c6b94d
  - url: https://github.com/xen-project/xen/tree/e579153bfe650d533525e46709a2ed6610303dfb
    reference_type: commit
    reference_id: e579153bfe650d533525e46709a2ed6610303dfb
