advisory_id: CVE-2023-34322
datasource_id: collect_xen_project_fix_commits/CVE-2023-34322
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  3a9a2901cc8b24f28dbdc6fb63f57006c77a1f47:x86/shadow: defer releasing of PV's top-level shadow reference

  sh_set_toplevel_shadow() re-pinning the top-level shadow we may be
  running on is not enough (and at the same time unnecessary when the
  shadow isn't what we're running on): That shadow becomes eligible for
  blowing away (from e.g. shadow_prealloc()) immediately after the
  paging lock was dropped. Yet it needs to remain valid until the actual
  page table switch occurred.

  Propagate up the call chain the shadow entry that needs releasing
  eventually, and carry out the release immediately after switching page
  tables. Handle update_cr3() failures by switching to idle pagetables.
  Note that various further uses of update_cr3() are HVM-only or only act
  on paused vCPU-s, in which case sh_set_toplevel_shadow() will not defer
  releasing of the reference.

  While changing the update_cr3() hook, also convert the "do_locking"
  parameter to boolean.

  This is CVE-2023-34322 / XSA-438.

  Reported-by: Tim Deegan <tim@xen.org>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@cloud.com>
  (cherry picked from commit fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb)
  c450a4bc11e97eabe97dcefe06f510d7acea8d6d:x86/shadow: defer releasing of PV's top-level shadow reference

  sh_set_toplevel_shadow() re-pinning the top-level shadow we may be
  running on is not enough (and at the same time unnecessary when the
  shadow isn't what we're running on): That shadow becomes eligible for
  blowing away (from e.g. shadow_prealloc()) immediately after the
  paging lock was dropped. Yet it needs to remain valid until the actual
  page table switch occurred.

  Propagate up the call chain the shadow entry that needs releasing
  eventually, and carry out the release immediately after switching page
  tables. Handle update_cr3() failures by switching to idle pagetables.
  Note that various further uses of update_cr3() are HVM-only or only act
  on paused vCPU-s, in which case sh_set_toplevel_shadow() will not defer
  releasing of the reference.

  While changing the update_cr3() hook, also convert the "do_locking"
  parameter to boolean.

  This is CVE-2023-34322 / XSA-438.

  Reported-by: Tim Deegan <tim@xen.org>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@cloud.com>
  (cherry picked from commit fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb)
  90c540c58985dc774cf0a1d2dc423473d3f37267:x86/shadow: defer releasing of PV's top-level shadow reference

  sh_set_toplevel_shadow() re-pinning the top-level shadow we may be
  running on is not enough (and at the same time unnecessary when the
  shadow isn't what we're running on): That shadow becomes eligible for
  blowing away (from e.g. shadow_prealloc()) immediately after the
  paging lock was dropped. Yet it needs to remain valid until the actual
  page table switch occurred.

  Propagate up the call chain the shadow entry that needs releasing
  eventually, and carry out the release immediately after switching page
  tables. Handle update_cr3() failures by switching to idle pagetables.
  Note that various further uses of update_cr3() are HVM-only or only act
  on paused vCPU-s, in which case sh_set_toplevel_shadow() will not defer
  releasing of the reference.

  While changing the update_cr3() hook, also convert the "do_locking"
  parameter to boolean.

  This is CVE-2023-34322 / XSA-438.

  Reported-by: Tim Deegan <tim@xen.org>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@cloud.com>
  (cherry picked from commit fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb)
  fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb:x86/shadow: defer releasing of PV's top-level shadow reference

  sh_set_toplevel_shadow() re-pinning the top-level shadow we may be
  running on is not enough (and at the same time unnecessary when the
  shadow isn't what we're running on): That shadow becomes eligible for
  blowing away (from e.g. shadow_prealloc()) immediately after the
  paging lock was dropped. Yet it needs to remain valid until the actual
  page table switch occurred.

  Propagate up the call chain the shadow entry that needs releasing
  eventually, and carry out the release immediately after switching page
  tables. Handle update_cr3() failures by switching to idle pagetables.
  Note that various further uses of update_cr3() are HVM-only or only act
  on paused vCPU-s, in which case sh_set_toplevel_shadow() will not defer
  releasing of the reference.

  While changing the update_cr3() hook, also convert the "do_locking"
  parameter to boolean.

  This is CVE-2023-34322 / XSA-438.

  Reported-by: Tim Deegan <tim@xen.org>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@cloud.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c450a4bc11e97eabe97dcefe06f510d7acea8d6d
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3a9a2901cc8b24f28dbdc6fb63f57006c77a1f47
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 90c540c58985dc774cf0a1d2dc423473d3f37267
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/3a9a2901cc8b24f28dbdc6fb63f57006c77a1f47
    reference_type: commit
    reference_id: 3a9a2901cc8b24f28dbdc6fb63f57006c77a1f47
  - url: https://github.com/xen-project/xen/tree/90c540c58985dc774cf0a1d2dc423473d3f37267
    reference_type: commit
    reference_id: 90c540c58985dc774cf0a1d2dc423473d3f37267
  - url: https://github.com/xen-project/xen/tree/c450a4bc11e97eabe97dcefe06f510d7acea8d6d
    reference_type: commit
    reference_id: c450a4bc11e97eabe97dcefe06f510d7acea8d6d
  - url: https://github.com/xen-project/xen/tree/fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb
    reference_type: commit
    reference_id: fb0ff49fe9f784bfee0370c2a3c5f20e39d7a1cb
