advisory_id: CVE-2023-34321
datasource_id: collect_xen_project_fix_commits/CVE-2023-34321
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  0517763e771f2e2582bc492fafa42a86400ab957:xen/arm: page: Handle cache flush of an element at the top of the address space

  The region that needs to be cleaned/invalidated may be at the top
  of the address space. This means that 'end' (i.e. 'p + size') will
  be 0 and therefore nothing will be cleaned/invalidated as the check
  in the loop will always be false.

  On Arm64, we only support we only support up to 48-bit Virtual
  address space. So this is not a concern there. However, for 32-bit,
  the mapcache is using the last 2GB of the address space. Therefore
  we may not clean/invalidate properly some pages. This could lead
  to memory corruption or data leakage (the scrubbed value may
  still sit in the cache when the guest could read directly the memory
  and therefore read the old content).

  Rework invalidate_dcache_va_range(), clean_dcache_va_range(),
  clean_and_invalidate_dcache_va_range() to handle a cache flush
  with an element at the top of the address space.

  This is CVE-2023-34321 / XSA-437.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Stefano Stabellini <stefano.stabellini@amd.com>
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Acked-by: Bertrand Marquis <bertrand.marquis@arm.com>
  master commit: 9a216e92de9f9011097e4f1fb55ff67ba0a21704
  master date: 2023-09-05 14:30:08 +0200
  d720c2310a7ac8878c01fe9d9fdc13f43cb266b3:xen/arm: page: Handle cache flush of an element at the top of the address space

  The region that needs to be cleaned/invalidated may be at the top
  of the address space. This means that 'end' (i.e. 'p + size') will
  be 0 and therefore nothing will be cleaned/invalidated as the check
  in the loop will always be false.

  On Arm64, we only support we only support up to 48-bit Virtual
  address space. So this is not a concern there. However, for 32-bit,
  the mapcache is using the last 2GB of the address space. Therefore
  we may not clean/invalidate properly some pages. This could lead
  to memory corruption or data leakage (the scrubbed value may
  still sit in the cache when the guest could read directly the memory
  and therefore read the old content).

  Rework invalidate_dcache_va_range(), clean_dcache_va_range(),
  clean_and_invalidate_dcache_va_range() to handle a cache flush
  with an element at the top of the address space.

  This is CVE-2023-34321 / XSA-437.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Stefano Stabellini <stefano.stabellini@amd.com>
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Acked-by: Bertrand Marquis <bertrand.marquis@arm.com>
  master commit: 9a216e92de9f9011097e4f1fb55ff67ba0a21704
  master date: 2023-09-05 14:30:08 +0200
  d31e5b2a9c39816a954d1088d4cfc782f0006f39:xen/arm: page: Handle cache flush of an element at the top of the address space

  The region that needs to be cleaned/invalidated may be at the top
  of the address space. This means that 'end' (i.e. 'p + size') will
  be 0 and therefore nothing will be cleaned/invalidated as the check
  in the loop will always be false.

  On Arm64, we only support we only support up to 48-bit Virtual
  address space. So this is not a concern there. However, for 32-bit,
  the mapcache is using the last 2GB of the address space. Therefore
  we may not clean/invalidate properly some pages. This could lead
  to memory corruption or data leakage (the scrubbed value may
  still sit in the cache when the guest could read directly the memory
  and therefore read the old content).

  Rework invalidate_dcache_va_range(), clean_dcache_va_range(),
  clean_and_invalidate_dcache_va_range() to handle a cache flush
  with an element at the top of the address space.

  This is CVE-2023-34321 / XSA-437.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Stefano Stabellini <stefano.stabellini@amd.com>
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Acked-by: Bertrand Marquis <bertrand.marquis@arm.com>
  master commit: 9a216e92de9f9011097e4f1fb55ff67ba0a21704
  master date: 2023-09-05 14:30:08 +0200
  9a216e92de9f9011097e4f1fb55ff67ba0a21704:xen/arm: page: Handle cache flush of an element at the top of the address space

  The region that needs to be cleaned/invalidated may be at the top
  of the address space. This means that 'end' (i.e. 'p + size') will
  be 0 and therefore nothing will be cleaned/invalidated as the check
  in the loop will always be false.

  On Arm64, we only support we only support up to 48-bit Virtual
  address space. So this is not a concern there. However, for 32-bit,
  the mapcache is using the last 2GB of the address space. Therefore
  we may not clean/invalidate properly some pages. This could lead
  to memory corruption or data leakage (the scrubbed value may
  still sit in the cache when the guest could read directly the memory
  and therefore read the old content).

  Rework invalidate_dcache_va_range(), clean_dcache_va_range(),
  clean_and_invalidate_dcache_va_range() to handle a cache flush
  with an element at the top of the address space.

  This is CVE-2023-34321 / XSA-437.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Stefano Stabellini <stefano.stabellini@amd.com>
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Acked-by: Bertrand Marquis <bertrand.marquis@arm.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d31e5b2a9c39816a954d1088d4cfc782f0006f39
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d720c2310a7ac8878c01fe9d9fdc13f43cb266b3
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0517763e771f2e2582bc492fafa42a86400ab957
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 9a216e92de9f9011097e4f1fb55ff67ba0a21704
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0517763e771f2e2582bc492fafa42a86400ab957
    reference_type: commit
    reference_id: 0517763e771f2e2582bc492fafa42a86400ab957
  - url: https://github.com/xen-project/xen/tree/9a216e92de9f9011097e4f1fb55ff67ba0a21704
    reference_type: commit
    reference_id: 9a216e92de9f9011097e4f1fb55ff67ba0a21704
  - url: https://github.com/xen-project/xen/tree/d31e5b2a9c39816a954d1088d4cfc782f0006f39
    reference_type: commit
    reference_id: d31e5b2a9c39816a954d1088d4cfc782f0006f39
  - url: https://github.com/xen-project/xen/tree/d720c2310a7ac8878c01fe9d9fdc13f43cb266b3
    reference_type: commit
    reference_id: d720c2310a7ac8878c01fe9d9fdc13f43cb266b3
