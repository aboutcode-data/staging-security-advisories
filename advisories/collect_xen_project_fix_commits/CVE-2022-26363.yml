advisory_id: CVE-2022-26363
datasource_id: collect_xen_project_fix_commits/CVE-2022-26363
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  fce392fa36c31f88be4f6b5f5821d244549cc825:x86: Don't change the cacheability of the directmap

  Changeset 55f97f49b7ce ("x86: Change cache attributes of Xen 1:1 page mappings
  in response to guest mapping requests") attempted to keep the cacheability
  consistent between different mappings of the same page.

  The reason wasn't described in the changelog, but it is understood to be in
  regards to a concern over machine check exceptions, owing to errata when using
  mixed cacheabilities.  It did this primarily by updating Xen's mapping of the
  page in the direct map when the guest mapped a page with reduced cacheability.

  Unfortunately, the logic didn't actually prevent mixed cacheability from
  occurring:
   * A guest could map a page normally, and then map the same page with
     different cacheability; nothing prevented this.
   * The cacheability of the directmap was always latest-takes-precedence in
     terms of guest requests.
   * Grant-mapped frames with lesser cacheability didn't adjust the page's
     cacheattr settings.
   * The map_domain_page() function still unconditionally created WB mappings,
     irrespective of the page's cacheattr settings.

  Additionally, update_xen_mappings() had a bug where the alias calculation was
  wrong for mfn's which were .init content, which should have been treated as
  fully guest pages, not Xen pages.

  Worse yet, the logic introduced a vulnerability whereby necessary
  pagetable/segdesc adjustments made by Xen in the validation logic could become
  non-coherent between the cache and main memory.  The CPU could subsequently
  operate on the stale value in the cache, rather than the safe value in main
  memory.

  The directmap contains primarily mappings of RAM.  PAT/MTRR conflict
  resolution is asymmetric, and generally for MTRR=WB ranges, PAT of lesser
  cacheability resolves to being coherent.  The special case is WC mappings,
  which are non-coherent against MTRR=WB regions (except for fully-coherent
  CPUs).

  Xen must not have any WC cacheability in the directmap, to prevent Xen's
  actions from creating non-coherency.  (Guest actions creating non-coherency is
  dealt with in subsequent patches.)  As all memory types for MTRR=WB ranges
  inter-operate coherently, so leave Xen's directmap mappings as WB.

  Only PV guests with access to devices can use reduced-cacheability mappings to
  begin with, and they're trusted not to mount DoSs against the system anyway.

  Drop PGC_cacheattr_{base,mask} entirely, and the logic to manipulate them.
  Shift the later PGC_* constants up, to gain 3 extra bits in the main reference
  count.  Retain the check in get_page_from_l1e() for special_pages() because a
  guest has no business using reduced cacheability on these.

  This reverts changeset 55f97f49b7ce6c3520c555d19caac6cf3f9a5df0

  This is CVE-2022-26363, part of XSA-402.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  master commit: ae09597da34aee6bc5b76475c5eea6994457e854
  master date: 2022-06-09 14:22:08 +0200
  07fbed87582c117262541a9a0903848a36adcc79:x86: Don't change the cacheability of the directmap

  Changeset 55f97f49b7ce ("x86: Change cache attributes of Xen 1:1 page mappings
  in response to guest mapping requests") attempted to keep the cacheability
  consistent between different mappings of the same page.

  The reason wasn't described in the changelog, but it is understood to be in
  regards to a concern over machine check exceptions, owing to errata when using
  mixed cacheabilities.  It did this primarily by updating Xen's mapping of the
  page in the direct map when the guest mapped a page with reduced cacheability.

  Unfortunately, the logic didn't actually prevent mixed cacheability from
  occurring:
   * A guest could map a page normally, and then map the same page with
     different cacheability; nothing prevented this.
   * The cacheability of the directmap was always latest-takes-precedence in
     terms of guest requests.
   * Grant-mapped frames with lesser cacheability didn't adjust the page's
     cacheattr settings.
   * The map_domain_page() function still unconditionally created WB mappings,
     irrespective of the page's cacheattr settings.

  Additionally, update_xen_mappings() had a bug where the alias calculation was
  wrong for mfn's which were .init content, which should have been treated as
  fully guest pages, not Xen pages.

  Worse yet, the logic introduced a vulnerability whereby necessary
  pagetable/segdesc adjustments made by Xen in the validation logic could become
  non-coherent between the cache and main memory.  The CPU could subsequently
  operate on the stale value in the cache, rather than the safe value in main
  memory.

  The directmap contains primarily mappings of RAM.  PAT/MTRR conflict
  resolution is asymmetric, and generally for MTRR=WB ranges, PAT of lesser
  cacheability resolves to being coherent.  The special case is WC mappings,
  which are non-coherent against MTRR=WB regions (except for fully-coherent
  CPUs).

  Xen must not have any WC cacheability in the directmap, to prevent Xen's
  actions from creating non-coherency.  (Guest actions creating non-coherency is
  dealt with in subsequent patches.)  As all memory types for MTRR=WB ranges
  inter-operate coherently, so leave Xen's directmap mappings as WB.

  Only PV guests with access to devices can use reduced-cacheability mappings to
  begin with, and they're trusted not to mount DoSs against the system anyway.

  Drop PGC_cacheattr_{base,mask} entirely, and the logic to manipulate them.
  Shift the later PGC_* constants up, to gain 3 extra bits in the main reference
  count.  Retain the check in get_page_from_l1e() for special_pages() because a
  guest has no business using reduced cacheability on these.

  This reverts changeset 55f97f49b7ce6c3520c555d19caac6cf3f9a5df0

  This is CVE-2022-26363, part of XSA-402.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  master commit: ae09597da34aee6bc5b76475c5eea6994457e854
  master date: 2022-06-09 14:22:08 +0200
  9b1e1e74a6c23ffad4c6a78973995957db2d4cc7:x86: Don't change the cacheability of the directmap

  Changeset 55f97f49b7ce ("x86: Change cache attributes of Xen 1:1 page mappings
  in response to guest mapping requests") attempted to keep the cacheability
  consistent between different mappings of the same page.

  The reason wasn't described in the changelog, but it is understood to be in
  regards to a concern over machine check exceptions, owing to errata when using
  mixed cacheabilities.  It did this primarily by updating Xen's mapping of the
  page in the direct map when the guest mapped a page with reduced cacheability.

  Unfortunately, the logic didn't actually prevent mixed cacheability from
  occurring:
   * A guest could map a page normally, and then map the same page with
     different cacheability; nothing prevented this.
   * The cacheability of the directmap was always latest-takes-precedence in
     terms of guest requests.
   * Grant-mapped frames with lesser cacheability didn't adjust the page's
     cacheattr settings.
   * The map_domain_page() function still unconditionally created WB mappings,
     irrespective of the page's cacheattr settings.

  Additionally, update_xen_mappings() had a bug where the alias calculation was
  wrong for mfn's which were .init content, which should have been treated as
  fully guest pages, not Xen pages.

  Worse yet, the logic introduced a vulnerability whereby necessary
  pagetable/segdesc adjustments made by Xen in the validation logic could become
  non-coherent between the cache and main memory.  The CPU could subsequently
  operate on the stale value in the cache, rather than the safe value in main
  memory.

  The directmap contains primarily mappings of RAM.  PAT/MTRR conflict
  resolution is asymmetric, and generally for MTRR=WB ranges, PAT of lesser
  cacheability resolves to being coherent.  The special case is WC mappings,
  which are non-coherent against MTRR=WB regions (except for fully-coherent
  CPUs).

  Xen must not have any WC cacheability in the directmap, to prevent Xen's
  actions from creating non-coherency.  (Guest actions creating non-coherency is
  dealt with in subsequent patches.)  As all memory types for MTRR=WB ranges
  inter-operate coherently, so leave Xen's directmap mappings as WB.

  Only PV guests with access to devices can use reduced-cacheability mappings to
  begin with, and they're trusted not to mount DoSs against the system anyway.

  Drop PGC_cacheattr_{base,mask} entirely, and the logic to manipulate them.
  Shift the later PGC_* constants up, to gain 3 extra bits in the main reference
  count.  Retain the check in get_page_from_l1e() for special_pages() because a
  guest has no business using reduced cacheability on these.

  This reverts changeset 55f97f49b7ce6c3520c555d19caac6cf3f9a5df0

  This is CVE-2022-26363, part of XSA-402.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  master commit: ae09597da34aee6bc5b76475c5eea6994457e854
  master date: 2022-06-09 14:22:08 +0200
  74193f4292d9cfc2874866e941d9939d8f33fcef:x86: Don't change the cacheability of the directmap

  Changeset 55f97f49b7ce ("x86: Change cache attributes of Xen 1:1 page mappings
  in response to guest mapping requests") attempted to keep the cacheability
  consistent between different mappings of the same page.

  The reason wasn't described in the changelog, but it is understood to be in
  regards to a concern over machine check exceptions, owing to errata when using
  mixed cacheabilities.  It did this primarily by updating Xen's mapping of the
  page in the direct map when the guest mapped a page with reduced cacheability.

  Unfortunately, the logic didn't actually prevent mixed cacheability from
  occurring:
   * A guest could map a page normally, and then map the same page with
     different cacheability; nothing prevented this.
   * The cacheability of the directmap was always latest-takes-precedence in
     terms of guest requests.
   * Grant-mapped frames with lesser cacheability didn't adjust the page's
     cacheattr settings.
   * The map_domain_page() function still unconditionally created WB mappings,
     irrespective of the page's cacheattr settings.

  Additionally, update_xen_mappings() had a bug where the alias calculation was
  wrong for mfn's which were .init content, which should have been treated as
  fully guest pages, not Xen pages.

  Worse yet, the logic introduced a vulnerability whereby necessary
  pagetable/segdesc adjustments made by Xen in the validation logic could become
  non-coherent between the cache and main memory.  The CPU could subsequently
  operate on the stale value in the cache, rather than the safe value in main
  memory.

  The directmap contains primarily mappings of RAM.  PAT/MTRR conflict
  resolution is asymmetric, and generally for MTRR=WB ranges, PAT of lesser
  cacheability resolves to being coherent.  The special case is WC mappings,
  which are non-coherent against MTRR=WB regions (except for fully-coherent
  CPUs).

  Xen must not have any WC cacheability in the directmap, to prevent Xen's
  actions from creating non-coherency.  (Guest actions creating non-coherency is
  dealt with in subsequent patches.)  As all memory types for MTRR=WB ranges
  inter-operate coherently, so leave Xen's directmap mappings as WB.

  Only PV guests with access to devices can use reduced-cacheability mappings to
  begin with, and they're trusted not to mount DoSs against the system anyway.

  Drop PGC_cacheattr_{base,mask} entirely, and the logic to manipulate them.
  Shift the later PGC_* constants up, to gain 3 extra bits in the main reference
  count.  Retain the check in get_page_from_l1e() for special_pages() because a
  guest has no business using reduced cacheability on these.

  This reverts changeset 55f97f49b7ce6c3520c555d19caac6cf3f9a5df0

  This is CVE-2022-26363, part of XSA-402.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  master commit: ae09597da34aee6bc5b76475c5eea6994457e854
  master date: 2022-06-09 14:22:08 +0200
  ae09597da34aee6bc5b76475c5eea6994457e854:x86: Don't change the cacheability of the directmap

  Changeset 55f97f49b7ce ("x86: Change cache attributes of Xen 1:1 page mappings
  in response to guest mapping requests") attempted to keep the cacheability
  consistent between different mappings of the same page.

  The reason wasn't described in the changelog, but it is understood to be in
  regards to a concern over machine check exceptions, owing to errata when using
  mixed cacheabilities.  It did this primarily by updating Xen's mapping of the
  page in the direct map when the guest mapped a page with reduced cacheability.

  Unfortunately, the logic didn't actually prevent mixed cacheability from
  occurring:
   * A guest could map a page normally, and then map the same page with
     different cacheability; nothing prevented this.
   * The cacheability of the directmap was always latest-takes-precedence in
     terms of guest requests.
   * Grant-mapped frames with lesser cacheability didn't adjust the page's
     cacheattr settings.
   * The map_domain_page() function still unconditionally created WB mappings,
     irrespective of the page's cacheattr settings.

  Additionally, update_xen_mappings() had a bug where the alias calculation was
  wrong for mfn's which were .init content, which should have been treated as
  fully guest pages, not Xen pages.

  Worse yet, the logic introduced a vulnerability whereby necessary
  pagetable/segdesc adjustments made by Xen in the validation logic could become
  non-coherent between the cache and main memory.  The CPU could subsequently
  operate on the stale value in the cache, rather than the safe value in main
  memory.

  The directmap contains primarily mappings of RAM.  PAT/MTRR conflict
  resolution is asymmetric, and generally for MTRR=WB ranges, PAT of lesser
  cacheability resolves to being coherent.  The special case is WC mappings,
  which are non-coherent against MTRR=WB regions (except for fully-coherent
  CPUs).

  Xen must not have any WC cacheability in the directmap, to prevent Xen's
  actions from creating non-coherency.  (Guest actions creating non-coherency is
  dealt with in subsequent patches.)  As all memory types for MTRR=WB ranges
  inter-operate coherently, so leave Xen's directmap mappings as WB.

  Only PV guests with access to devices can use reduced-cacheability mappings to
  begin with, and they're trusted not to mount DoSs against the system anyway.

  Drop PGC_cacheattr_{base,mask} entirely, and the logic to manipulate them.
  Shift the later PGC_* constants up, to gain 3 extra bits in the main reference
  count.  Retain the check in get_page_from_l1e() for special_pages() because a
  guest has no business using reduced cacheability on these.

  This reverts changeset 55f97f49b7ce6c3520c555d19caac6cf3f9a5df0

  This is CVE-2022-26363, part of XSA-402.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 9b1e1e74a6c23ffad4c6a78973995957db2d4cc7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ae09597da34aee6bc5b76475c5eea6994457e854
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: fce392fa36c31f88be4f6b5f5821d244549cc825
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 74193f4292d9cfc2874866e941d9939d8f33fcef
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 07fbed87582c117262541a9a0903848a36adcc79
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/07fbed87582c117262541a9a0903848a36adcc79
    reference_type: commit
    reference_id: 07fbed87582c117262541a9a0903848a36adcc79
  - url: https://github.com/xen-project/xen/tree/74193f4292d9cfc2874866e941d9939d8f33fcef
    reference_type: commit
    reference_id: 74193f4292d9cfc2874866e941d9939d8f33fcef
  - url: https://github.com/xen-project/xen/tree/9b1e1e74a6c23ffad4c6a78973995957db2d4cc7
    reference_type: commit
    reference_id: 9b1e1e74a6c23ffad4c6a78973995957db2d4cc7
  - url: https://github.com/xen-project/xen/tree/ae09597da34aee6bc5b76475c5eea6994457e854
    reference_type: commit
    reference_id: ae09597da34aee6bc5b76475c5eea6994457e854
  - url: https://github.com/xen-project/xen/tree/fce392fa36c31f88be4f6b5f5821d244549cc825
    reference_type: commit
    reference_id: fce392fa36c31f88be4f6b5f5821d244549cc825
