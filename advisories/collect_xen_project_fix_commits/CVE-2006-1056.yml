advisory_id: CVE-2006-1056
datasource_id: collect_xen_project_fix_commits/CVE-2006-1056
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  d2a95f1c3ef96f47840ab172278293e55c4fc430:x86/AMD: Fix handling of x87 exception pointers on Fam17h hardware

  AMD Pre-Fam17h CPUs "optimise" {F,}X{SAVE,RSTOR} by not saving/restoring
  FOP/FIP/FDP if an x87 exception isn't pending.  This causes an information
  leak, CVE-2006-1056, and worked around by several OSes, including Xen.  AMD
  Fam17h CPUs no longer have this leak, and advertise so in a CPUID bit.

  Introduce the RSTR_FP_ERR_PTRS feature, as specified by AMD, and expose to all
  guests by default.  While adjusting libxl's cpuid table, add CLZERO which
  looks to have been omitted previously.

  Also introduce an X86_BUG bit to trigger the (F)XRSTOR workaround, and set it
  on AMD hardware where RSTR_FP_ERR_PTRS is not advertised.  Optimise the
  conditions for the workaround paths.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  c3401c1aece47dc5388184c9b6a3527655d5bbdf:x86/xsave: fix information leak on AMD CPUs

  Just like for FXSAVE/FXRSTOR, XSAVE/XRSTOR also don't save/restore the
  last instruction and operand pointers as well as the last opcode if
  there's no pending unmasked exception (see CVE-2006-1056 and commit
  9747:4d667a139318).

  While the FXSR solution sits in the save path, I prefer to have this in
  the restore path because there the handling is simpler (namely in the
  context of the pending changes to properly save the selector values for
  32-bit guest code).

  Also this is using FFREE instead of EMMS, as it doesn't seem unlikely
  that in the future we may see CPUs with x87 and SSE/AVX but no MMX
  support. The goal here anyway is just to avoid an FPU stack overflow.
  I would have preferred to use FFREEP instead of FFREE (freeing two
  stack slots at once), but AMD doesn't document that instruction.

  This is CVE-2013-2076 / XSA-52.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Tested-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
  master commit: 8dcf9f0113454f233089e8e5bb3970d891928410
  master date: 2013-06-04 09:26:54 +0200
  16b0db2eeef6491fee4277b030c84678b1579863:x86/xsave: fix information leak on AMD CPUs

  Just like for FXSAVE/FXRSTOR, XSAVE/XRSTOR also don't save/restore the
  last instruction and operand pointers as well as the last opcode if
  there's no pending unmasked exception (see CVE-2006-1056 and commit
  9747:4d667a139318).

  While the FXSR solution sits in the save path, I prefer to have this in
  the restore path because there the handling is simpler (namely in the
  context of the pending changes to properly save the selector values for
  32-bit guest code).

  Also this is using FFREE instead of EMMS, as it doesn't seem unlikely
  that in the future we may see CPUs with x87 and SSE/AVX but no MMX
  support. The goal here anyway is just to avoid an FPU stack overflow.
  I would have preferred to use FFREEP instead of FFREE (freeing two
  stack slots at once), but AMD doesn't document that instruction.

  This is CVE-2013-2076 / XSA-52.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Tested-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
  master commit: 8dcf9f0113454f233089e8e5bb3970d891928410
  master date: 2013-06-04 09:26:54 +0200
  8dcf9f0113454f233089e8e5bb3970d891928410:x86/xsave: fix information leak on AMD CPUs

  Just like for FXSAVE/FXRSTOR, XSAVE/XRSTOR also don't save/restore the
  last instruction and operand pointers as well as the last opcode if
  there's no pending unmasked exception (see CVE-2006-1056 and commit
  9747:4d667a139318).

  While the FXSR solution sits in the save path, I prefer to have this in
  the restore path because there the handling is simpler (namely in the
  context of the pending changes to properly save the selector values for
  32-bit guest code).

  Also this is using FFREE instead of EMMS, as it doesn't seem unlikely
  that in the future we may see CPUs with x87 and SSE/AVX but no MMX
  support. The goal here anyway is just to avoid an FPU stack overflow.
  I would have preferred to use FFREEP instead of FFREE (freeing two
  stack slots at once), but AMD doesn't document that instruction.

  This is CVE-2013-2076 / XSA-52.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Tested-by: Suravee Suthikulpanit <suravee.suthikulpanit@amd.com>
  60395c1ca994f0c1ce83ff7fe19362f76c3ff3d8:This patch addresses CVE-2006-1056 (information leak from
  fxsave/fxrstor on AMD CPUs) and also adjusts 64-bit handling so that
  full 64-bit RIP/RDP values get saved/restored. More fine-grained
  handling may be needed if 32-bit processes are expected to properly
  see their selectors (native Linux doesn't currently do that either,
  but there is a patch to adjust it there).

  Original patch: Jan Beulich (based on Linux original by Andi Kleen)

  Signed-off-by: Keir Fraser <keir@xensource.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 16b0db2eeef6491fee4277b030c84678b1579863
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d2a95f1c3ef96f47840ab172278293e55c4fc430
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 60395c1ca994f0c1ce83ff7fe19362f76c3ff3d8
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 8dcf9f0113454f233089e8e5bb3970d891928410
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c3401c1aece47dc5388184c9b6a3527655d5bbdf
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/16b0db2eeef6491fee4277b030c84678b1579863
    reference_type: commit
    reference_id: 16b0db2eeef6491fee4277b030c84678b1579863
  - url: https://github.com/xen-project/xen/tree/60395c1ca994f0c1ce83ff7fe19362f76c3ff3d8
    reference_type: commit
    reference_id: 60395c1ca994f0c1ce83ff7fe19362f76c3ff3d8
  - url: https://github.com/xen-project/xen/tree/8dcf9f0113454f233089e8e5bb3970d891928410
    reference_type: commit
    reference_id: 8dcf9f0113454f233089e8e5bb3970d891928410
  - url: https://github.com/xen-project/xen/tree/c3401c1aece47dc5388184c9b6a3527655d5bbdf
    reference_type: commit
    reference_id: c3401c1aece47dc5388184c9b6a3527655d5bbdf
  - url: https://github.com/xen-project/xen/tree/d2a95f1c3ef96f47840ab172278293e55c4fc430
    reference_type: commit
    reference_id: d2a95f1c3ef96f47840ab172278293e55c4fc430
