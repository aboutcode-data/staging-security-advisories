advisory_id: CVE-2021-28695
datasource_id: collect_xen_project_fix_commits/CVE-2021-28695
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  c18e200eb657fd37b970aabbdae637878d055801:AMD/IOMMU: correct device unity map handling

  Blindly assuming all addresses between any two such ranges, specified by
  firmware in the ACPI tables, should also be unity-mapped can't be right.
  Nor can it be correct to merge ranges with differing permissions. Track
  ranges individually; don't merge at all, but check for overlaps instead.
  This requires bubbling up error indicators, such that IOMMU init can be
  failed when allocation of a new tracking struct wasn't possible, or an
  overlap was detected.

  At this occasion also stop ignoring
  amd_iommu_reserve_domain_unity_map()'s return value.

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
  master date: 2021-08-25 14:15:11 +0200
  3da2f2b0fce27a5de8d875671588580f210ec37c:AMD/IOMMU: correct global exclusion range extending

  Besides unity mapping regions, the AMD IOMMU spec also provides for
  exclusion ranges (areas of memory not to be subject to DMA translation)
  to be specified by firmware in the ACPI tables. The spec does not put
  any constraints on the number of such regions.

  Blindly assuming all addresses between any two such ranges should also
  be excluded can't be right. Since hardware has room for just a single
  such range (comprised of the Exclusion Base Register and the Exclusion
  Range Limit Register), combine only adjacent or overlapping regions (for
  now; this may require further adjustment in case table entries aren't
  sorted by address) with matching exclusion_allow_all settings. This
  requires bubbling up error indicators, such that IOMMU init can be
  failed when concatenation wasn't possible.

  Furthermore, since the exclusion range specified in IOMMU registers
  implies R/W access, reject requests asking for less permissions (this
  will be brought closer to the spec by a subsequent change).

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: b02c5c88982411be11e3413159862f255f1f39dc
  master date: 2021-08-25 14:12:13 +0200
  724eebcaeb6663915ef5cff7ccffe2301e47f7c6:AMD/IOMMU: correct device unity map handling

  Blindly assuming all addresses between any two such ranges, specified by
  firmware in the ACPI tables, should also be unity-mapped can't be right.
  Nor can it be correct to merge ranges with differing permissions. Track
  ranges individually; don't merge at all, but check for overlaps instead.
  This requires bubbling up error indicators, such that IOMMU init can be
  failed when allocation of a new tracking struct wasn't possible, or an
  overlap was detected.

  At this occasion also stop ignoring
  amd_iommu_reserve_domain_unity_map()'s return value.

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
  master date: 2021-08-25 14:15:11 +0200
  dd59be6857707a61f73612ce73e0192921b58427:AMD/IOMMU: correct global exclusion range extending

  Besides unity mapping regions, the AMD IOMMU spec also provides for
  exclusion ranges (areas of memory not to be subject to DMA translation)
  to be specified by firmware in the ACPI tables. The spec does not put
  any constraints on the number of such regions.

  Blindly assuming all addresses between any two such ranges should also
  be excluded can't be right. Since hardware has room for just a single
  such range (comprised of the Exclusion Base Register and the Exclusion
  Range Limit Register), combine only adjacent or overlapping regions (for
  now; this may require further adjustment in case table entries aren't
  sorted by address) with matching exclusion_allow_all settings. This
  requires bubbling up error indicators, such that IOMMU init can be
  failed when concatenation wasn't possible.

  Furthermore, since the exclusion range specified in IOMMU registers
  implies R/W access, reject requests asking for less permissions (this
  will be brought closer to the spec by a subsequent change).

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: b02c5c88982411be11e3413159862f255f1f39dc
  master date: 2021-08-25 14:12:13 +0200
  0ed0cdd17ffabd8aeb5a8db06bd21b0f0130a9f0:AMD/IOMMU: correct device unity map handling

  Blindly assuming all addresses between any two such ranges, specified by
  firmware in the ACPI tables, should also be unity-mapped can't be right.
  Nor can it be correct to merge ranges with differing permissions. Track
  ranges individually; don't merge at all, but check for overlaps instead.
  This requires bubbling up error indicators, such that IOMMU init can be
  failed when allocation of a new tracking struct wasn't possible, or an
  overlap was detected.

  At this occasion also stop ignoring
  amd_iommu_reserve_domain_unity_map()'s return value.

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
  master date: 2021-08-25 14:15:11 +0200
  ecb4697c50a00c29c8bfc784be7a308862b1c8a9:AMD/IOMMU: correct global exclusion range extending

  Besides unity mapping regions, the AMD IOMMU spec also provides for
  exclusion ranges (areas of memory not to be subject to DMA translation)
  to be specified by firmware in the ACPI tables. The spec does not put
  any constraints on the number of such regions.

  Blindly assuming all addresses between any two such ranges should also
  be excluded can't be right. Since hardware has room for just a single
  such range (comprised of the Exclusion Base Register and the Exclusion
  Range Limit Register), combine only adjacent or overlapping regions (for
  now; this may require further adjustment in case table entries aren't
  sorted by address) with matching exclusion_allow_all settings. This
  requires bubbling up error indicators, such that IOMMU init can be
  failed when concatenation wasn't possible.

  Furthermore, since the exclusion range specified in IOMMU registers
  implies R/W access, reject requests asking for less permissions (this
  will be brought closer to the spec by a subsequent change).

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: b02c5c88982411be11e3413159862f255f1f39dc
  master date: 2021-08-25 14:12:13 +0200
  100b2e2d5ee0ea5549113ad6b15f4b532c13bcd7:AMD/IOMMU: correct device unity map handling

  Blindly assuming all addresses between any two such ranges, specified by
  firmware in the ACPI tables, should also be unity-mapped can't be right.
  Nor can it be correct to merge ranges with differing permissions. Track
  ranges individually; don't merge at all, but check for overlaps instead.
  This requires bubbling up error indicators, such that IOMMU init can be
  failed when allocation of a new tracking struct wasn't possible, or an
  overlap was detected.

  At this occasion also stop ignoring
  amd_iommu_reserve_domain_unity_map()'s return value.

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
  master date: 2021-08-25 14:15:11 +0200
  8da14912d229eeef969f0738ec98c61a29946d07:AMD/IOMMU: correct global exclusion range extending

  Besides unity mapping regions, the AMD IOMMU spec also provides for
  exclusion ranges (areas of memory not to be subject to DMA translation)
  to be specified by firmware in the ACPI tables. The spec does not put
  any constraints on the number of such regions.

  Blindly assuming all addresses between any two such ranges should also
  be excluded can't be right. Since hardware has room for just a single
  such range (comprised of the Exclusion Base Register and the Exclusion
  Range Limit Register), combine only adjacent or overlapping regions (for
  now; this may require further adjustment in case table entries aren't
  sorted by address) with matching exclusion_allow_all settings. This
  requires bubbling up error indicators, such that IOMMU init can be
  failed when concatenation wasn't possible.

  Furthermore, since the exclusion range specified in IOMMU registers
  implies R/W access, reject requests asking for less permissions (this
  will be brought closer to the spec by a subsequent change).

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: b02c5c88982411be11e3413159862f255f1f39dc
  master date: 2021-08-25 14:12:13 +0200
  29a6cf118ce82afea292e23d8bbe329dc1e7bcb9:AMD/IOMMU: correct device unity map handling

  Blindly assuming all addresses between any two such ranges, specified by
  firmware in the ACPI tables, should also be unity-mapped can't be right.
  Nor can it be correct to merge ranges with differing permissions. Track
  ranges individually; don't merge at all, but check for overlaps instead.
  This requires bubbling up error indicators, such that IOMMU init can be
  failed when allocation of a new tracking struct wasn't possible, or an
  overlap was detected.

  At this occasion also stop ignoring
  amd_iommu_reserve_domain_unity_map()'s return value.

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
  master date: 2021-08-25 14:15:11 +0200
  92c8b9274db6b0c4e22ed0dff19b2611cf057921:AMD/IOMMU: correct global exclusion range extending

  Besides unity mapping regions, the AMD IOMMU spec also provides for
  exclusion ranges (areas of memory not to be subject to DMA translation)
  to be specified by firmware in the ACPI tables. The spec does not put
  any constraints on the number of such regions.

  Blindly assuming all addresses between any two such ranges should also
  be excluded can't be right. Since hardware has room for just a single
  such range (comprised of the Exclusion Base Register and the Exclusion
  Range Limit Register), combine only adjacent or overlapping regions (for
  now; this may require further adjustment in case table entries aren't
  sorted by address) with matching exclusion_allow_all settings. This
  requires bubbling up error indicators, such that IOMMU init can be
  failed when concatenation wasn't possible.

  Furthermore, since the exclusion range specified in IOMMU registers
  implies R/W access, reject requests asking for less permissions (this
  will be brought closer to the spec by a subsequent change).

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  master commit: b02c5c88982411be11e3413159862f255f1f39dc
  master date: 2021-08-25 14:12:13 +0200
  34750a3eb022462cdd1c36e8ef9049d3d73c824c:AMD/IOMMU: correct device unity map handling

  Blindly assuming all addresses between any two such ranges, specified by
  firmware in the ACPI tables, should also be unity-mapped can't be right.
  Nor can it be correct to merge ranges with differing permissions. Track
  ranges individually; don't merge at all, but check for overlaps instead.
  This requires bubbling up error indicators, such that IOMMU init can be
  failed when allocation of a new tracking struct wasn't possible, or an
  overlap was detected.

  At this occasion also stop ignoring
  amd_iommu_reserve_domain_unity_map()'s return value.

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
  b02c5c88982411be11e3413159862f255f1f39dc:AMD/IOMMU: correct global exclusion range extending

  Besides unity mapping regions, the AMD IOMMU spec also provides for
  exclusion ranges (areas of memory not to be subject to DMA translation)
  to be specified by firmware in the ACPI tables. The spec does not put
  any constraints on the number of such regions.

  Blindly assuming all addresses between any two such ranges should also
  be excluded can't be right. Since hardware has room for just a single
  such range (comprised of the Exclusion Base Register and the Exclusion
  Range Limit Register), combine only adjacent or overlapping regions (for
  now; this may require further adjustment in case table entries aren't
  sorted by address) with matching exclusion_allow_all settings. This
  requires bubbling up error indicators, such that IOMMU init can be
  failed when concatenation wasn't possible.

  Furthermore, since the exclusion range specified in IOMMU registers
  implies R/W access, reject requests asking for less permissions (this
  will be brought closer to the spec by a subsequent change).

  This is part of XSA-378 / CVE-2021-28695.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Paul Durrant <paul@xen.org>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: dd59be6857707a61f73612ce73e0192921b58427
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 724eebcaeb6663915ef5cff7ccffe2301e47f7c6
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 8da14912d229eeef969f0738ec98c61a29946d07
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ecb4697c50a00c29c8bfc784be7a308862b1c8a9
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c18e200eb657fd37b970aabbdae637878d055801
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3da2f2b0fce27a5de8d875671588580f210ec37c
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 100b2e2d5ee0ea5549113ad6b15f4b532c13bcd7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: b02c5c88982411be11e3413159862f255f1f39dc
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0ed0cdd17ffabd8aeb5a8db06bd21b0f0130a9f0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 92c8b9274db6b0c4e22ed0dff19b2611cf057921
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 29a6cf118ce82afea292e23d8bbe329dc1e7bcb9
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0ed0cdd17ffabd8aeb5a8db06bd21b0f0130a9f0
    reference_type: commit
    reference_id: 0ed0cdd17ffabd8aeb5a8db06bd21b0f0130a9f0
  - url: https://github.com/xen-project/xen/tree/100b2e2d5ee0ea5549113ad6b15f4b532c13bcd7
    reference_type: commit
    reference_id: 100b2e2d5ee0ea5549113ad6b15f4b532c13bcd7
  - url: https://github.com/xen-project/xen/tree/29a6cf118ce82afea292e23d8bbe329dc1e7bcb9
    reference_type: commit
    reference_id: 29a6cf118ce82afea292e23d8bbe329dc1e7bcb9
  - url: https://github.com/xen-project/xen/tree/34750a3eb022462cdd1c36e8ef9049d3d73c824c
    reference_type: commit
    reference_id: 34750a3eb022462cdd1c36e8ef9049d3d73c824c
  - url: https://github.com/xen-project/xen/tree/3da2f2b0fce27a5de8d875671588580f210ec37c
    reference_type: commit
    reference_id: 3da2f2b0fce27a5de8d875671588580f210ec37c
  - url: https://github.com/xen-project/xen/tree/724eebcaeb6663915ef5cff7ccffe2301e47f7c6
    reference_type: commit
    reference_id: 724eebcaeb6663915ef5cff7ccffe2301e47f7c6
  - url: https://github.com/xen-project/xen/tree/8da14912d229eeef969f0738ec98c61a29946d07
    reference_type: commit
    reference_id: 8da14912d229eeef969f0738ec98c61a29946d07
  - url: https://github.com/xen-project/xen/tree/92c8b9274db6b0c4e22ed0dff19b2611cf057921
    reference_type: commit
    reference_id: 92c8b9274db6b0c4e22ed0dff19b2611cf057921
  - url: https://github.com/xen-project/xen/tree/b02c5c88982411be11e3413159862f255f1f39dc
    reference_type: commit
    reference_id: b02c5c88982411be11e3413159862f255f1f39dc
  - url: https://github.com/xen-project/xen/tree/c18e200eb657fd37b970aabbdae637878d055801
    reference_type: commit
    reference_id: c18e200eb657fd37b970aabbdae637878d055801
  - url: https://github.com/xen-project/xen/tree/dd59be6857707a61f73612ce73e0192921b58427
    reference_type: commit
    reference_id: dd59be6857707a61f73612ce73e0192921b58427
  - url: https://github.com/xen-project/xen/tree/ecb4697c50a00c29c8bfc784be7a308862b1c8a9
    reference_type: commit
    reference_id: ecb4697c50a00c29c8bfc784be7a308862b1c8a9
