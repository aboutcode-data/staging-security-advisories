advisory_id: CVE-2022-26357
datasource_id: collect_xen_project_fix_commits/CVE-2022-26357
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  7615e24837074daab396dc2a9718a0a2191dc136:VT-d: correct ordering of operations in cleanup_domid_map()

  The function may be called without any locks held (leaving aside the
  domctl one, which we surely don't want to depend on here), so needs to
  play safe wrt other accesses to domid_map[] and domid_bitmap[]. This is
  to avoid context_set_domain_id()'s writing of domid_map[] to be reset to
  zero right away in the case of it racing the freeing of a DID.

  For the interaction with context_set_domain_id() and did_to_domain_id()
  see the code comment.

  {check_,}cleanup_domid_map() are called with pcidevs_lock held or during
  domain cleanup only (and pcidevs_lock is also held around
  context_set_domain_id()), i.e. racing calls with the same (dom, iommu)
  tuple cannot occur.

  domain_iommu_domid(), besides its use by cleanup_domid_map(), has its
  result used only to control flushing, and hence a stale result would
  only lead to a stray extra flush.

  This is CVE-2022-26357 / XSA-399.

  Fixes: b9c20c78789f ("VT-d: per-iommu domain-id")
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
  master date: 2022-04-05 14:12:27 +0200
  920e93df4e16c03811665e459c414feced6bc9b6:VT-d: correct ordering of operations in cleanup_domid_map()

  The function may be called without any locks held (leaving aside the
  domctl one, which we surely don't want to depend on here), so needs to
  play safe wrt other accesses to domid_map[] and domid_bitmap[]. This is
  to avoid context_set_domain_id()'s writing of domid_map[] to be reset to
  zero right away in the case of it racing the freeing of a DID.

  For the interaction with context_set_domain_id() and did_to_domain_id()
  see the code comment.

  {check_,}cleanup_domid_map() are called with pcidevs_lock held or during
  domain cleanup only (and pcidevs_lock is also held around
  context_set_domain_id()), i.e. racing calls with the same (dom, iommu)
  tuple cannot occur.

  domain_iommu_domid(), besides its use by cleanup_domid_map(), has its
  result used only to control flushing, and hence a stale result would
  only lead to a stray extra flush.

  This is CVE-2022-26357 / XSA-399.

  Fixes: b9c20c78789f ("VT-d: per-iommu domain-id")
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
  master date: 2022-04-05 14:12:27 +0200
  9d7046b644b1fff443b5e12ba4d5676ec3708cb8:VT-d: correct ordering of operations in cleanup_domid_map()

  The function may be called without any locks held (leaving aside the
  domctl one, which we surely don't want to depend on here), so needs to
  play safe wrt other accesses to domid_map[] and domid_bitmap[]. This is
  to avoid context_set_domain_id()'s writing of domid_map[] to be reset to
  zero right away in the case of it racing the freeing of a DID.

  For the interaction with context_set_domain_id() and did_to_domain_id()
  see the code comment.

  {check_,}cleanup_domid_map() are called with pcidevs_lock held or during
  domain cleanup only (and pcidevs_lock is also held around
  context_set_domain_id()), i.e. racing calls with the same (dom, iommu)
  tuple cannot occur.

  domain_iommu_domid(), besides its use by cleanup_domid_map(), has its
  result used only to control flushing, and hence a stale result would
  only lead to a stray extra flush.

  This is CVE-2022-26357 / XSA-399.

  Fixes: b9c20c78789f ("VT-d: per-iommu domain-id")
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
  master date: 2022-04-05 14:12:27 +0200
  aafd4f1df0adfe94d4632a25904e05f0fedba5c5:VT-d: correct ordering of operations in cleanup_domid_map()

  The function may be called without any locks held (leaving aside the
  domctl one, which we surely don't want to depend on here), so needs to
  play safe wrt other accesses to domid_map[] and domid_bitmap[]. This is
  to avoid context_set_domain_id()'s writing of domid_map[] to be reset to
  zero right away in the case of it racing the freeing of a DID.

  For the interaction with context_set_domain_id() and did_to_domain_id()
  see the code comment.

  {check_,}cleanup_domid_map() are called with pcidevs_lock held or during
  domain cleanup only (and pcidevs_lock is also held around
  context_set_domain_id()), i.e. racing calls with the same (dom, iommu)
  tuple cannot occur.

  domain_iommu_domid(), besides its use by cleanup_domid_map(), has its
  result used only to control flushing, and hence a stale result would
  only lead to a stray extra flush.

  This is CVE-2022-26357 / XSA-399.

  Fixes: b9c20c78789f ("VT-d: per-iommu domain-id")
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
  master date: 2022-04-05 14:12:27 +0200
  0e754e07b00f3ad644a3c05f85702bce8b4c0d5c:VT-d: correct ordering of operations in cleanup_domid_map()

  The function may be called without any locks held (leaving aside the
  domctl one, which we surely don't want to depend on here), so needs to
  play safe wrt other accesses to domid_map[] and domid_bitmap[]. This is
  to avoid context_set_domain_id()'s writing of domid_map[] to be reset to
  zero right away in the case of it racing the freeing of a DID.

  For the interaction with context_set_domain_id() and did_to_domain_id()
  see the code comment.

  {check_,}cleanup_domid_map() are called with pcidevs_lock held or during
  domain cleanup only (and pcidevs_lock is also held around
  context_set_domain_id()), i.e. racing calls with the same (dom, iommu)
  tuple cannot occur.

  domain_iommu_domid(), besides its use by cleanup_domid_map(), has its
  result used only to control flushing, and hence a stale result would
  only lead to a stray extra flush.

  This is CVE-2022-26357 / XSA-399.

  Fixes: b9c20c78789f ("VT-d: per-iommu domain-id")
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  master commit: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
  master date: 2022-04-05 14:12:27 +0200
  d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0:VT-d: correct ordering of operations in cleanup_domid_map()

  The function may be called without any locks held (leaving aside the
  domctl one, which we surely don't want to depend on here), so needs to
  play safe wrt other accesses to domid_map[] and domid_bitmap[]. This is
  to avoid context_set_domain_id()'s writing of domid_map[] to be reset to
  zero right away in the case of it racing the freeing of a DID.

  For the interaction with context_set_domain_id() and did_to_domain_id()
  see the code comment.

  {check_,}cleanup_domid_map() are called with pcidevs_lock held or during
  domain cleanup only (and pcidevs_lock is also held around
  context_set_domain_id()), i.e. racing calls with the same (dom, iommu)
  tuple cannot occur.

  domain_iommu_domid(), besides its use by cleanup_domid_map(), has its
  result used only to control flushing, and hence a stale result would
  only lead to a stray extra flush.

  This is CVE-2022-26357 / XSA-399.

  Fixes: b9c20c78789f ("VT-d: per-iommu domain-id")
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 920e93df4e16c03811665e459c414feced6bc9b6
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7615e24837074daab396dc2a9718a0a2191dc136
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 9d7046b644b1fff443b5e12ba4d5676ec3708cb8
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0e754e07b00f3ad644a3c05f85702bce8b4c0d5c
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: aafd4f1df0adfe94d4632a25904e05f0fedba5c5
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0e754e07b00f3ad644a3c05f85702bce8b4c0d5c
    reference_type: commit
    reference_id: 0e754e07b00f3ad644a3c05f85702bce8b4c0d5c
  - url: https://github.com/xen-project/xen/tree/7615e24837074daab396dc2a9718a0a2191dc136
    reference_type: commit
    reference_id: 7615e24837074daab396dc2a9718a0a2191dc136
  - url: https://github.com/xen-project/xen/tree/920e93df4e16c03811665e459c414feced6bc9b6
    reference_type: commit
    reference_id: 920e93df4e16c03811665e459c414feced6bc9b6
  - url: https://github.com/xen-project/xen/tree/9d7046b644b1fff443b5e12ba4d5676ec3708cb8
    reference_type: commit
    reference_id: 9d7046b644b1fff443b5e12ba4d5676ec3708cb8
  - url: https://github.com/xen-project/xen/tree/aafd4f1df0adfe94d4632a25904e05f0fedba5c5
    reference_type: commit
    reference_id: aafd4f1df0adfe94d4632a25904e05f0fedba5c5
  - url: https://github.com/xen-project/xen/tree/d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
    reference_type: commit
    reference_id: d9eca7bb6c6636eb87bb17b08ba7de270f47ecd0
