advisory_id: CVE-2023-46836
datasource_id: collect_xen_project_fix_commits/CVE-2023-46836
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e:x86/spec-ctrl: Remove conditional IRQs-on-ness for INT $0x80/0x82 paths

  Before speculation defences, some paths in Xen could genuinely get away with
  being IRQs-on at entry.  But XPTI invalidated this property on most paths, and
  attempting to maintain it on the remaining paths was a mistake.

  Fast forward, and DO_SPEC_CTRL_COND_IBPB (protection for AMD BTC/SRSO) is not
  IRQ-safe, running with IRQs enabled in some cases.  The other actions taken on
  these paths happen to be IRQ-safe.

  Make entry_int82() and int80_direct_trap() unconditionally Interrupt Gates
  rather than Trap Gates.  Remove the conditional re-adjustment of
  int80_direct_trap() in smp_prepare_cpus(), and have entry_int82() explicitly
  enable interrupts when safe to do so.

  In smp_prepare_cpus(), with the conditional re-adjustment removed, the
  clearing of pv_cr3 is the only remaining action gated on XPTI, and it is out
  of place anyway, repeating work already done by smp_prepare_boot_cpu().  Drop
  the entire if() condition to avoid leaving an incorrect vestigial remnant.

  Also drop comments which make incorrect statements about when its safe to
  enable interrupts.

  This is XSA-446 / CVE-2023-46836

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  2185851bbf72123ea76c9ce26e0c3a4d1a0ab8b0:x86/spec-ctrl: Remove conditional IRQs-on-ness for INT $0x80/0x82 paths

  Before speculation defences, some paths in Xen could genuinely get away with
  being IRQs-on at entry.  But XPTI invalidated this property on most paths, and
  attempting to maintain it on the remaining paths was a mistake.

  Fast forward, and DO_SPEC_CTRL_COND_IBPB (protection for AMD BTC/SRSO) is not
  IRQ-safe, running with IRQs enabled in some cases.  The other actions taken on
  these paths happen to be IRQ-safe.

  Make entry_int82() and int80_direct_trap() unconditionally Interrupt Gates
  rather than Trap Gates.  Remove the conditional re-adjustment of
  int80_direct_trap() in smp_prepare_cpus(), and have entry_int82() explicitly
  enable interrupts when safe to do so.

  In smp_prepare_cpus(), with the conditional re-adjustment removed, the
  clearing of pv_cr3 is the only remaining action gated on XPTI, and it is out
  of place anyway, repeating work already done by smp_prepare_boot_cpu().  Drop
  the entire if() condition to avoid leaving an incorrect vestigial remnant.

  Also drop comments which make incorrect statements about when its safe to
  enable interrupts.

  This is XSA-446 / CVE-2023-46836

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e)
  b918c4cdc7ab2c1c9e9a9b54fa9d9c595913e028:x86/spec-ctrl: Remove conditional IRQs-on-ness for INT $0x80/0x82 paths

  Before speculation defences, some paths in Xen could genuinely get away with
  being IRQs-on at entry.  But XPTI invalidated this property on most paths, and
  attempting to maintain it on the remaining paths was a mistake.

  Fast forward, and DO_SPEC_CTRL_COND_IBPB (protection for AMD BTC/SRSO) is not
  IRQ-safe, running with IRQs enabled in some cases.  The other actions taken on
  these paths happen to be IRQ-safe.

  Make entry_int82() and int80_direct_trap() unconditionally Interrupt Gates
  rather than Trap Gates.  Remove the conditional re-adjustment of
  int80_direct_trap() in smp_prepare_cpus(), and have entry_int82() explicitly
  enable interrupts when safe to do so.

  In smp_prepare_cpus(), with the conditional re-adjustment removed, the
  clearing of pv_cr3 is the only remaining action gated on XPTI, and it is out
  of place anyway, repeating work already done by smp_prepare_boot_cpu().  Drop
  the entire if() condition to avoid leaving an incorrect vestigial remnant.

  Also drop comments which make incorrect statements about when its safe to
  enable interrupts.

  This is XSA-446 / CVE-2023-46836

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e)
  4dfe95177b948d1f3ed27a801f603ed7f1bc36e8:x86/spec-ctrl: Remove conditional IRQs-on-ness for INT $0x80/0x82 paths

  Before speculation defences, some paths in Xen could genuinely get away with
  being IRQs-on at entry.  But XPTI invalidated this property on most paths, and
  attempting to maintain it on the remaining paths was a mistake.

  Fast forward, and DO_SPEC_CTRL_COND_IBPB (protection for AMD BTC/SRSO) is not
  IRQ-safe, running with IRQs enabled in some cases.  The other actions taken on
  these paths happen to be IRQ-safe.

  Make entry_int82() and int80_direct_trap() unconditionally Interrupt Gates
  rather than Trap Gates.  Remove the conditional re-adjustment of
  int80_direct_trap() in smp_prepare_cpus(), and have entry_int82() explicitly
  enable interrupts when safe to do so.

  In smp_prepare_cpus(), with the conditional re-adjustment removed, the
  clearing of pv_cr3 is the only remaining action gated on XPTI, and it is out
  of place anyway, repeating work already done by smp_prepare_boot_cpu().  Drop
  the entire if() condition to avoid leaving an incorrect vestigial remnant.

  Also drop comments which make incorrect statements about when its safe to
  enable interrupts.

  This is XSA-446 / CVE-2023-46836

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e)
  0311ff4a2ca505c5edba6b9b36df0ded910f3388:x86/spec-ctrl: Remove conditional IRQs-on-ness for INT $0x80/0x82 paths

  Before speculation defences, some paths in Xen could genuinely get away with
  being IRQs-on at entry.  But XPTI invalidated this property on most paths, and
  attempting to maintain it on the remaining paths was a mistake.

  Fast forward, and DO_SPEC_CTRL_COND_IBPB (protection for AMD BTC/SRSO) is not
  IRQ-safe, running with IRQs enabled in some cases.  The other actions taken on
  these paths happen to be IRQ-safe.

  Make entry_int82() and int80_direct_trap() unconditionally Interrupt Gates
  rather than Trap Gates.  Remove the conditional re-adjustment of
  int80_direct_trap() in smp_prepare_cpus(), and have entry_int82() explicitly
  enable interrupts when safe to do so.

  In smp_prepare_cpus(), with the conditional re-adjustment removed, the
  clearing of pv_cr3 is the only remaining action gated on XPTI, and it is out
  of place anyway, repeating work already done by smp_prepare_boot_cpu().  Drop
  the entire if() condition to avoid leaving an incorrect vestigial remnant.

  Also drop comments which make incorrect statements about when its safe to
  enable interrupts.

  This is XSA-446 / CVE-2023-46836

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e)
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 2185851bbf72123ea76c9ce26e0c3a4d1a0ab8b0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: b918c4cdc7ab2c1c9e9a9b54fa9d9c595913e028
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0311ff4a2ca505c5edba6b9b36df0ded910f3388
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 4dfe95177b948d1f3ed27a801f603ed7f1bc36e8
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0311ff4a2ca505c5edba6b9b36df0ded910f3388
    reference_type: commit
    reference_id: 0311ff4a2ca505c5edba6b9b36df0ded910f3388
  - url: https://github.com/xen-project/xen/tree/2185851bbf72123ea76c9ce26e0c3a4d1a0ab8b0
    reference_type: commit
    reference_id: 2185851bbf72123ea76c9ce26e0c3a4d1a0ab8b0
  - url: https://github.com/xen-project/xen/tree/4dfe95177b948d1f3ed27a801f603ed7f1bc36e8
    reference_type: commit
    reference_id: 4dfe95177b948d1f3ed27a801f603ed7f1bc36e8
  - url: https://github.com/xen-project/xen/tree/a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e
    reference_type: commit
    reference_id: a48bb129f1b9ff55c22cf6d2b589247c8ba3b10e
  - url: https://github.com/xen-project/xen/tree/b918c4cdc7ab2c1c9e9a9b54fa9d9c595913e028
    reference_type: commit
    reference_id: b918c4cdc7ab2c1c9e9a9b54fa9d9c595913e028
