advisory_id: CVE-2022-23034
datasource_id: collect_xen_project_fix_commits/CVE-2022-23034
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  ff626ec7f2777ef7de85f6d485c5e788738af0c3:xen/grant-table: Only decrement the refcounter when grant is fully unmapped

  The grant unmapping hypercall (GNTTABOP_unmap_grant_ref) is not a
  simple revert of the changes done by the grant mapping hypercall
  (GNTTABOP_map_grant_ref).

  Instead, it is possible to partially (or even not) clear some flags.
  This will leave the grant is mapped until a future call where all
  the flags would be cleared.

  XSA-380 introduced a refcounting that is meant to only be dropped
  when the grant is fully unmapped. Unfortunately, unmap_common() will
  decrement the refcount for every successful call.

  A consequence is a domain would be able to underflow the refcount
  and trigger a BUG().

  Looking at the code, it is not clear to me why a domain would
  want to partially clear some flags in the grant-table. But as
  this is part of the ABI, it is better to not change the behavior
  for now.

  Fix it by checking if the maptrack handle has been released before
  decrementing the refcounting.

  This is CVE-2022-23034 / XSA-394.

  Fixes: 9781b51efde2 ("gnttab: replace mapkind()")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
  master date: 2022-01-25 13:25:49 +0100
  e48c7878e54a5f970c00abed2cfd747858f0d592:xen/grant-table: Only decrement the refcounter when grant is fully unmapped

  The grant unmapping hypercall (GNTTABOP_unmap_grant_ref) is not a
  simple revert of the changes done by the grant mapping hypercall
  (GNTTABOP_map_grant_ref).

  Instead, it is possible to partially (or even not) clear some flags.
  This will leave the grant is mapped until a future call where all
  the flags would be cleared.

  XSA-380 introduced a refcounting that is meant to only be dropped
  when the grant is fully unmapped. Unfortunately, unmap_common() will
  decrement the refcount for every successful call.

  A consequence is a domain would be able to underflow the refcount
  and trigger a BUG().

  Looking at the code, it is not clear to me why a domain would
  want to partially clear some flags in the grant-table. But as
  this is part of the ABI, it is better to not change the behavior
  for now.

  Fix it by checking if the maptrack handle has been released before
  decrementing the refcounting.

  This is CVE-2022-23034 / XSA-394.

  Fixes: 9781b51efde2 ("gnttab: replace mapkind()")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
  master date: 2022-01-25 13:25:49 +0100
  dbd85c0a8264aa2cd9b011a189ac8b1d90297d80:xen/grant-table: Only decrement the refcounter when grant is fully unmapped

  The grant unmapping hypercall (GNTTABOP_unmap_grant_ref) is not a
  simple revert of the changes done by the grant mapping hypercall
  (GNTTABOP_map_grant_ref).

  Instead, it is possible to partially (or even not) clear some flags.
  This will leave the grant is mapped until a future call where all
  the flags would be cleared.

  XSA-380 introduced a refcounting that is meant to only be dropped
  when the grant is fully unmapped. Unfortunately, unmap_common() will
  decrement the refcount for every successful call.

  A consequence is a domain would be able to underflow the refcount
  and trigger a BUG().

  Looking at the code, it is not clear to me why a domain would
  want to partially clear some flags in the grant-table. But as
  this is part of the ABI, it is better to not change the behavior
  for now.

  Fix it by checking if the maptrack handle has been released before
  decrementing the refcounting.

  This is CVE-2022-23034 / XSA-394.

  Fixes: 9781b51efde2 ("gnttab: replace mapkind()")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
  master date: 2022-01-25 13:25:49 +0100
  2700abffa5e42cf04dc1c6eba73faaba670c99df:xen/grant-table: Only decrement the refcounter when grant is fully unmapped

  The grant unmapping hypercall (GNTTABOP_unmap_grant_ref) is not a
  simple revert of the changes done by the grant mapping hypercall
  (GNTTABOP_map_grant_ref).

  Instead, it is possible to partially (or even not) clear some flags.
  This will leave the grant is mapped until a future call where all
  the flags would be cleared.

  XSA-380 introduced a refcounting that is meant to only be dropped
  when the grant is fully unmapped. Unfortunately, unmap_common() will
  decrement the refcount for every successful call.

  A consequence is a domain would be able to underflow the refcount
  and trigger a BUG().

  Looking at the code, it is not clear to me why a domain would
  want to partially clear some flags in the grant-table. But as
  this is part of the ABI, it is better to not change the behavior
  for now.

  Fix it by checking if the maptrack handle has been released before
  decrementing the refcounting.

  This is CVE-2022-23034 / XSA-394.

  Fixes: 9781b51efde2 ("gnttab: replace mapkind()")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
  master date: 2022-01-25 13:25:49 +0100
  965fbc8e801c91938dd7efa831fb9078a78deeb7:xen/grant-table: Only decrement the refcounter when grant is fully unmapped

  The grant unmapping hypercall (GNTTABOP_unmap_grant_ref) is not a
  simple revert of the changes done by the grant mapping hypercall
  (GNTTABOP_map_grant_ref).

  Instead, it is possible to partially (or even not) clear some flags.
  This will leave the grant is mapped until a future call where all
  the flags would be cleared.

  XSA-380 introduced a refcounting that is meant to only be dropped
  when the grant is fully unmapped. Unfortunately, unmap_common() will
  decrement the refcount for every successful call.

  A consequence is a domain would be able to underflow the refcount
  and trigger a BUG().

  Looking at the code, it is not clear to me why a domain would
  want to partially clear some flags in the grant-table. But as
  this is part of the ABI, it is better to not change the behavior
  for now.

  Fix it by checking if the maptrack handle has been released before
  decrementing the refcounting.

  This is CVE-2022-23034 / XSA-394.

  Fixes: 9781b51efde2 ("gnttab: replace mapkind()")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
  master date: 2022-01-25 13:25:49 +0100
  975a8fb45ca186b3476e5656c6ad5dad1122dbfd:xen/grant-table: Only decrement the refcounter when grant is fully unmapped

  The grant unmapping hypercall (GNTTABOP_unmap_grant_ref) is not a
  simple revert of the changes done by the grant mapping hypercall
  (GNTTABOP_map_grant_ref).

  Instead, it is possible to partially (or even not) clear some flags.
  This will leave the grant is mapped until a future call where all
  the flags would be cleared.

  XSA-380 introduced a refcounting that is meant to only be dropped
  when the grant is fully unmapped. Unfortunately, unmap_common() will
  decrement the refcount for every successful call.

  A consequence is a domain would be able to underflow the refcount
  and trigger a BUG().

  Looking at the code, it is not clear to me why a domain would
  want to partially clear some flags in the grant-table. But as
  this is part of the ABI, it is better to not change the behavior
  for now.

  Fix it by checking if the maptrack handle has been released before
  decrementing the refcounting.

  This is CVE-2022-23034 / XSA-394.

  Fixes: 9781b51efde2 ("gnttab: replace mapkind()")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: dbd85c0a8264aa2cd9b011a189ac8b1d90297d80
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ff626ec7f2777ef7de85f6d485c5e788738af0c3
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 965fbc8e801c91938dd7efa831fb9078a78deeb7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 2700abffa5e42cf04dc1c6eba73faaba670c99df
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e48c7878e54a5f970c00abed2cfd747858f0d592
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/2700abffa5e42cf04dc1c6eba73faaba670c99df
    reference_type: commit
    reference_id: 2700abffa5e42cf04dc1c6eba73faaba670c99df
  - url: https://github.com/xen-project/xen/tree/965fbc8e801c91938dd7efa831fb9078a78deeb7
    reference_type: commit
    reference_id: 965fbc8e801c91938dd7efa831fb9078a78deeb7
  - url: https://github.com/xen-project/xen/tree/975a8fb45ca186b3476e5656c6ad5dad1122dbfd
    reference_type: commit
    reference_id: 975a8fb45ca186b3476e5656c6ad5dad1122dbfd
  - url: https://github.com/xen-project/xen/tree/dbd85c0a8264aa2cd9b011a189ac8b1d90297d80
    reference_type: commit
    reference_id: dbd85c0a8264aa2cd9b011a189ac8b1d90297d80
  - url: https://github.com/xen-project/xen/tree/e48c7878e54a5f970c00abed2cfd747858f0d592
    reference_type: commit
    reference_id: e48c7878e54a5f970c00abed2cfd747858f0d592
  - url: https://github.com/xen-project/xen/tree/ff626ec7f2777ef7de85f6d485c5e788738af0c3
    reference_type: commit
    reference_id: ff626ec7f2777ef7de85f6d485c5e788738af0c3
