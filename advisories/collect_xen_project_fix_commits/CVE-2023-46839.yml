advisory_id: CVE-2023-46839
datasource_id: collect_xen_project_fix_commits/CVE-2023-46839
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  dfafb3ec959b20307d4c640a48b3b55a2896ac30:pci: fail device assignment if phantom functions cannot be assigned

  The current behavior is that no error is reported if (some) phantom functions
  fail to be assigned during device add or assignment, so the operation succeeds
  even if some phantom functions are not correctly setup.

  This can lead to devices possibly being successfully assigned to a domU while
  some of the device phantom functions are still assigned to dom0.  Even when the
  device is assigned domIO before being assigned to a domU phantom functions
  might fail to be assigned to domIO, and also fail to be assigned to the domU,
  leaving them assigned to dom0.

  Since the device can generate requests using the IDs of those phantom
  functions, given the scenario above a device in such state would be in control
  of a domU, but still capable of generating transactions that use a context ID
  targeting dom0 owned memory.

  Modify device assign in order to attempt to deassign the device if phantom
  functions failed to be assigned.

  Note that device addition is not modified in the same way, as in that case the
  device is assigned to a trusted domain, and hence partial assign can lead to
  device malfunction but not a security issue.

  This is XSA-449 / CVE-2023-46839

  Fixes: 4e9950dc1bd2 ('IOMMU: add phantom function support')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
  master date: 2024-01-30 14:28:01 +0100
  e481fc9f32339ebf9ddd171a3995a3e44527d148:pci: fail device assignment if phantom functions cannot be assigned

  The current behavior is that no error is reported if (some) phantom functions
  fail to be assigned during device add or assignment, so the operation succeeds
  even if some phantom functions are not correctly setup.

  This can lead to devices possibly being successfully assigned to a domU while
  some of the device phantom functions are still assigned to dom0.  Even when the
  device is assigned domIO before being assigned to a domU phantom functions
  might fail to be assigned to domIO, and also fail to be assigned to the domU,
  leaving them assigned to dom0.

  Since the device can generate requests using the IDs of those phantom
  functions, given the scenario above a device in such state would be in control
  of a domU, but still capable of generating transactions that use a context ID
  targeting dom0 owned memory.

  Modify device assign in order to attempt to deassign the device if phantom
  functions failed to be assigned.

  Note that device addition is not modified in the same way, as in that case the
  device is assigned to a trusted domain, and hence partial assign can lead to
  device malfunction but not a security issue.

  This is XSA-449 / CVE-2023-46839

  Fixes: 4e9950dc1bd2 ('IOMMU: add phantom function support')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
  master date: 2024-01-30 14:28:01 +0100
  f9e1ed51bdba31017ea17e1819eb2ade6b5c8615:pci: fail device assignment if phantom functions cannot be assigned

  The current behavior is that no error is reported if (some) phantom functions
  fail to be assigned during device add or assignment, so the operation succeeds
  even if some phantom functions are not correctly setup.

  This can lead to devices possibly being successfully assigned to a domU while
  some of the device phantom functions are still assigned to dom0.  Even when the
  device is assigned domIO before being assigned to a domU phantom functions
  might fail to be assigned to domIO, and also fail to be assigned to the domU,
  leaving them assigned to dom0.

  Since the device can generate requests using the IDs of those phantom
  functions, given the scenario above a device in such state would be in control
  of a domU, but still capable of generating transactions that use a context ID
  targeting dom0 owned memory.

  Modify device assign in order to attempt to deassign the device if phantom
  functions failed to be assigned.

  Note that device addition is not modified in the same way, as in that case the
  device is assigned to a trusted domain, and hence partial assign can lead to
  device malfunction but not a security issue.

  This is XSA-449 / CVE-2023-46839

  Fixes: 4e9950dc1bd2 ('IOMMU: add phantom function support')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
  master date: 2024-01-30 14:28:01 +0100
  637da04812fba259a5d06591ec535345637a4407:pci: fail device assignment if phantom functions cannot be assigned

  The current behavior is that no error is reported if (some) phantom functions
  fail to be assigned during device add or assignment, so the operation succeeds
  even if some phantom functions are not correctly setup.

  This can lead to devices possibly being successfully assigned to a domU while
  some of the device phantom functions are still assigned to dom0.  Even when the
  device is assigned domIO before being assigned to a domU phantom functions
  might fail to be assigned to domIO, and also fail to be assigned to the domU,
  leaving them assigned to dom0.

  Since the device can generate requests using the IDs of those phantom
  functions, given the scenario above a device in such state would be in control
  of a domU, but still capable of generating transactions that use a context ID
  targeting dom0 owned memory.

  Modify device assign in order to attempt to deassign the device if phantom
  functions failed to be assigned.

  Note that device addition is not modified in the same way, as in that case the
  device is assigned to a trusted domain, and hence partial assign can lead to
  device malfunction but not a security issue.

  This is XSA-449 / CVE-2023-46839

  Fixes: 4e9950dc1bd2 ('IOMMU: add phantom function support')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
  master date: 2024-01-30 14:28:01 +0100
  cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e:pci: fail device assignment if phantom functions cannot be assigned

  The current behavior is that no error is reported if (some) phantom functions
  fail to be assigned during device add or assignment, so the operation succeeds
  even if some phantom functions are not correctly setup.

  This can lead to devices possibly being successfully assigned to a domU while
  some of the device phantom functions are still assigned to dom0.  Even when the
  device is assigned domIO before being assigned to a domU phantom functions
  might fail to be assigned to domIO, and also fail to be assigned to the domU,
  leaving them assigned to dom0.

  Since the device can generate requests using the IDs of those phantom
  functions, given the scenario above a device in such state would be in control
  of a domU, but still capable of generating transactions that use a context ID
  targeting dom0 owned memory.

  Modify device assign in order to attempt to deassign the device if phantom
  functions failed to be assigned.

  Note that device addition is not modified in the same way, as in that case the
  device is assigned to a trusted domain, and hence partial assign can lead to
  device malfunction but not a security issue.

  This is XSA-449 / CVE-2023-46839

  Fixes: 4e9950dc1bd2 ('IOMMU: add phantom function support')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: f9e1ed51bdba31017ea17e1819eb2ade6b5c8615
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 637da04812fba259a5d06591ec535345637a4407
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e481fc9f32339ebf9ddd171a3995a3e44527d148
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: dfafb3ec959b20307d4c640a48b3b55a2896ac30
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/637da04812fba259a5d06591ec535345637a4407
    reference_type: commit
    reference_id: 637da04812fba259a5d06591ec535345637a4407
  - url: https://github.com/xen-project/xen/tree/cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
    reference_type: commit
    reference_id: cb4ecb3cc17b02c2814bc817efd05f3f3ba33d1e
  - url: https://github.com/xen-project/xen/tree/dfafb3ec959b20307d4c640a48b3b55a2896ac30
    reference_type: commit
    reference_id: dfafb3ec959b20307d4c640a48b3b55a2896ac30
  - url: https://github.com/xen-project/xen/tree/e481fc9f32339ebf9ddd171a3995a3e44527d148
    reference_type: commit
    reference_id: e481fc9f32339ebf9ddd171a3995a3e44527d148
  - url: https://github.com/xen-project/xen/tree/f9e1ed51bdba31017ea17e1819eb2ade6b5c8615
    reference_type: commit
    reference_id: f9e1ed51bdba31017ea17e1819eb2ade6b5c8615
