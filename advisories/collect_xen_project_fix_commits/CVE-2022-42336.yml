advisory_id: CVE-2022-42336
datasource_id: collect_xen_project_fix_commits/CVE-2022-42336
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  66c930ceac3989b6dc6031bfc30e1e894fc6aebe:x86/amd: fix legacy setting of SSBD on AMD Family 17h

  The current logic to set SSBD on AMD Family 17h and Hygon Family 18h
  processors requires that the setting of SSBD is coordinated at a core
  level, as the setting is shared between threads.  Logic was introduced
  to keep track of how many threads require SSBD active in order to
  coordinate it, such logic relies on using a per-core counter of
  threads that have SSBD active.

  Given the current logic, it's possible for a guest to under or
  overflow the thread counter, because each write to VIRT_SPEC_CTRL.SSBD
  by the guest gets propagated to the helper that does the per-core
  active accounting.  Overflowing the counter is not so much of an
  issue, as this would just make SSBD sticky.

  Underflowing however is more problematic: on non-debug Xen builds a
  guest can perform empty writes to VIRT_SPEC_CTRL that would cause the
  counter to underflow and thus the value gets saturated to the max
  value of unsigned int.  At which points attempts from any thread to
  set VIRT_SPEC_CTRL.SSBD won't get propagated to the hardware anymore,
  because the logic will see that the counter is greater than 1 and
  assume that SSBD is already active, effectively loosing the setting
  of SSBD and the protection it provides.

  Fix this by introducing a per-CPU variable that keeps track of whether
  the current thread has legacy SSBD active or not, and thus only
  attempt to propagate the value to the hardware once the thread
  selected value changes.

  This is XSA-431 / CVE-2022-42336

  Fixes: b2030e6730a2 ('amd/virt_ssbd: set SSBD at vCPU context switch')
  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: eda98ea870803ea204a1928519b3f21ec6a679b6
  master date: 2023-05-16 17:17:24 +0200
  eda98ea870803ea204a1928519b3f21ec6a679b6:x86/amd: fix legacy setting of SSBD on AMD Family 17h

  The current logic to set SSBD on AMD Family 17h and Hygon Family 18h
  processors requires that the setting of SSBD is coordinated at a core
  level, as the setting is shared between threads.  Logic was introduced
  to keep track of how many threads require SSBD active in order to
  coordinate it, such logic relies on using a per-core counter of
  threads that have SSBD active.

  Given the current logic, it's possible for a guest to under or
  overflow the thread counter, because each write to VIRT_SPEC_CTRL.SSBD
  by the guest gets propagated to the helper that does the per-core
  active accounting.  Overflowing the counter is not so much of an
  issue, as this would just make SSBD sticky.

  Underflowing however is more problematic: on non-debug Xen builds a
  guest can perform empty writes to VIRT_SPEC_CTRL that would cause the
  counter to underflow and thus the value gets saturated to the max
  value of unsigned int.  At which points attempts from any thread to
  set VIRT_SPEC_CTRL.SSBD won't get propagated to the hardware anymore,
  because the logic will see that the counter is greater than 1 and
  assume that SSBD is already active, effectively loosing the setting
  of SSBD and the protection it provides.

  Fix this by introducing a per-CPU variable that keeps track of whether
  the current thread has legacy SSBD active or not, and thus only
  attempt to propagate the value to the hardware once the thread
  selected value changes.

  This is XSA-431 / CVE-2022-42336

  Fixes: b2030e6730a2 ('amd/virt_ssbd: set SSBD at vCPU context switch')
  Reported-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 66c930ceac3989b6dc6031bfc30e1e894fc6aebe
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: eda98ea870803ea204a1928519b3f21ec6a679b6
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/66c930ceac3989b6dc6031bfc30e1e894fc6aebe
    reference_type: commit
    reference_id: 66c930ceac3989b6dc6031bfc30e1e894fc6aebe
  - url: https://github.com/xen-project/xen/tree/eda98ea870803ea204a1928519b3f21ec6a679b6
    reference_type: commit
    reference_id: eda98ea870803ea204a1928519b3f21ec6a679b6
