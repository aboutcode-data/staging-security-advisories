advisory_id: CVE-2023-46840
datasource_id: collect_xen_project_fix_commits/CVE-2023-46840
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  6b1864afc14d484cdbc9754ce3172ac3dc189846:VT-d: Fix "else" vs "#endif" misplacement

  In domain_pgd_maddr() the "#endif" is misplaced with respect to "else".  This
  generates incorrect logic when CONFIG_HVM is compiled out, as the "else" body
  is executed unconditionally.

  Rework the logic to use IS_ENABLED() instead of explicit #ifdef-ary, as it's
  clearer to follow.  This in turn involves adjusting p2m_get_pagetable() to
  compile when CONFIG_HVM is disabled.

  This is XSA-450 / CVE-2023-46840.

  Fixes: 033ff90aa9c1 ("x86/P2M: p2m_{alloc,free}_ptp() and p2m_alloc_table() are HVM-only")
  Reported-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: cc6ba68edf6dcd18c3865e7d7c0f1ed822796426
  master date: 2024-01-30 14:29:15 +0100
  c7ac596a575a05d6ff1e35c3ff98bc4d143712d2:VT-d: Fix "else" vs "#endif" misplacement

  In domain_pgd_maddr() the "#endif" is misplaced with respect to "else".  This
  generates incorrect logic when CONFIG_HVM is compiled out, as the "else" body
  is executed unconditionally.

  Rework the logic to use IS_ENABLED() instead of explicit #ifdef-ary, as it's
  clearer to follow.  This in turn involves adjusting p2m_get_pagetable() to
  compile when CONFIG_HVM is disabled.

  This is XSA-450 / CVE-2023-46840.

  Fixes: 033ff90aa9c1 ("x86/P2M: p2m_{alloc,free}_ptp() and p2m_alloc_table() are HVM-only")
  Reported-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: cc6ba68edf6dcd18c3865e7d7c0f1ed822796426
  master date: 2024-01-30 14:29:15 +0100
  cc6ba68edf6dcd18c3865e7d7c0f1ed822796426:VT-d: Fix "else" vs "#endif" misplacement

  In domain_pgd_maddr() the "#endif" is misplaced with respect to "else".  This
  generates incorrect logic when CONFIG_HVM is compiled out, as the "else" body
  is executed unconditionally.

  Rework the logic to use IS_ENABLED() instead of explicit #ifdef-ary, as it's
  clearer to follow.  This in turn involves adjusting p2m_get_pagetable() to
  compile when CONFIG_HVM is disabled.

  This is XSA-450 / CVE-2023-46840.

  Fixes: 033ff90aa9c1 ("x86/P2M: p2m_{alloc,free}_ptp() and p2m_alloc_table() are HVM-only")
  Reported-by: Teddy Astie <teddy.astie@vates.tech>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 6b1864afc14d484cdbc9754ce3172ac3dc189846
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: cc6ba68edf6dcd18c3865e7d7c0f1ed822796426
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c7ac596a575a05d6ff1e35c3ff98bc4d143712d2
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/6b1864afc14d484cdbc9754ce3172ac3dc189846
    reference_type: commit
    reference_id: 6b1864afc14d484cdbc9754ce3172ac3dc189846
  - url: https://github.com/xen-project/xen/tree/c7ac596a575a05d6ff1e35c3ff98bc4d143712d2
    reference_type: commit
    reference_id: c7ac596a575a05d6ff1e35c3ff98bc4d143712d2
  - url: https://github.com/xen-project/xen/tree/cc6ba68edf6dcd18c3865e7d7c0f1ed822796426
    reference_type: commit
    reference_id: cc6ba68edf6dcd18c3865e7d7c0f1ed822796426
