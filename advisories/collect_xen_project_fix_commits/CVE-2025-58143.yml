advisory_id: CVE-2025-58143
datasource_id: collect_xen_project_fix_commits/CVE-2025-58143
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  af733b706de569614b499bbd615085225fda1c6a:x86/viridian: protect concurrent modification of the reference TSC page

  The reference TSC page is shared between all vCPUs, and the data stored in
  the domain struct.  However the handlers to set and clear it are not safe
  against concurrent accesses.  It's possible for two (or more) vCPUs to call
  HV_X64_MSR_REFERENCE_TSC at the same time and cause the in-use reference
  TSC page to be freed, while still being on the p2m.  This creates a use-
  after-free bug, where the page can end up mapped in another domain or used
  by Xen while still being part of the original domain's p2m.

  It's also possible to underflow the reference counter, as multiple
  concurrent writes to HV_X64_MSR_REFERENCE_TSC can create an imbalance on
  the number of put_page_and_type() calls.

  Introduce a lock to protect the reference TSC domain field, thus
  serializing concurrent vCPU accesses.

  This is CVE-2025-58143 / part of XSA-472.

  Fixes: 386b3365221d ('viridian: use viridian_map/unmap_guest_page() for reference tsc page')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 45729a510a352e1a973e4023bd0067cddb1bcaf8
  master date: 2025-09-09 14:12:00 +0200
  2102093e081f0d57e0b92881970d07c6542c969a:x86/viridian: protect concurrent modification of the reference TSC page

  The reference TSC page is shared between all vCPUs, and the data stored in
  the domain struct.  However the handlers to set and clear it are not safe
  against concurrent accesses.  It's possible for two (or more) vCPUs to call
  HV_X64_MSR_REFERENCE_TSC at the same time and cause the in-use reference
  TSC page to be freed, while still being on the p2m.  This creates a use-
  after-free bug, where the page can end up mapped in another domain or used
  by Xen while still being part of the original domain's p2m.

  It's also possible to underflow the reference counter, as multiple
  concurrent writes to HV_X64_MSR_REFERENCE_TSC can create an imbalance on
  the number of put_page_and_type() calls.

  Introduce a lock to protect the reference TSC domain field, thus
  serializing concurrent vCPU accesses.

  This is CVE-2025-58143 / part of XSA-472.

  Fixes: 386b3365221d ('viridian: use viridian_map/unmap_guest_page() for reference tsc page')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 45729a510a352e1a973e4023bd0067cddb1bcaf8
  master date: 2025-09-09 14:12:00 +0200
  c7f0d12c8a0b3b54263b5f79ffc9c02f094c0e2d:x86/viridian: protect concurrent modification of the reference TSC page

  The reference TSC page is shared between all vCPUs, and the data stored in
  the domain struct.  However the handlers to set and clear it are not safe
  against concurrent accesses.  It's possible for two (or more) vCPUs to call
  HV_X64_MSR_REFERENCE_TSC at the same time and cause the in-use reference
  TSC page to be freed, while still being on the p2m.  This creates a use-
  after-free bug, where the page can end up mapped in another domain or used
  by Xen while still being part of the original domain's p2m.

  It's also possible to underflow the reference counter, as multiple
  concurrent writes to HV_X64_MSR_REFERENCE_TSC can create an imbalance on
  the number of put_page_and_type() calls.

  Introduce a lock to protect the reference TSC domain field, thus
  serializing concurrent vCPU accesses.

  This is CVE-2025-58143 / part of XSA-472.

  Fixes: 386b3365221d ('viridian: use viridian_map/unmap_guest_page() for reference tsc page')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 45729a510a352e1a973e4023bd0067cddb1bcaf8
  master date: 2025-09-09 14:12:00 +0200
  665a641471efbcf97a6bea6a7543bbd7b475dc54:x86/viridian: protect concurrent modification of the reference TSC page

  The reference TSC page is shared between all vCPUs, and the data stored in
  the domain struct.  However the handlers to set and clear it are not safe
  against concurrent accesses.  It's possible for two (or more) vCPUs to call
  HV_X64_MSR_REFERENCE_TSC at the same time and cause the in-use reference
  TSC page to be freed, while still being on the p2m.  This creates a use-
  after-free bug, where the page can end up mapped in another domain or used
  by Xen while still being part of the original domain's p2m.

  It's also possible to underflow the reference counter, as multiple
  concurrent writes to HV_X64_MSR_REFERENCE_TSC can create an imbalance on
  the number of put_page_and_type() calls.

  Introduce a lock to protect the reference TSC domain field, thus
  serializing concurrent vCPU accesses.

  This is CVE-2025-58143 / part of XSA-472.

  Fixes: 386b3365221d ('viridian: use viridian_map/unmap_guest_page() for reference tsc page')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: 45729a510a352e1a973e4023bd0067cddb1bcaf8
  master date: 2025-09-09 14:12:00 +0200
  45729a510a352e1a973e4023bd0067cddb1bcaf8:x86/viridian: protect concurrent modification of the reference TSC page

  The reference TSC page is shared between all vCPUs, and the data stored in
  the domain struct.  However the handlers to set and clear it are not safe
  against concurrent accesses.  It's possible for two (or more) vCPUs to call
  HV_X64_MSR_REFERENCE_TSC at the same time and cause the in-use reference
  TSC page to be freed, while still being on the p2m.  This creates a use-
  after-free bug, where the page can end up mapped in another domain or used
  by Xen while still being part of the original domain's p2m.

  It's also possible to underflow the reference counter, as multiple
  concurrent writes to HV_X64_MSR_REFERENCE_TSC can create an imbalance on
  the number of put_page_and_type() calls.

  Introduce a lock to protect the reference TSC domain field, thus
  serializing concurrent vCPU accesses.

  This is CVE-2025-58143 / part of XSA-472.

  Fixes: 386b3365221d ('viridian: use viridian_map/unmap_guest_page() for reference tsc page')
  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 2102093e081f0d57e0b92881970d07c6542c969a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 45729a510a352e1a973e4023bd0067cddb1bcaf8
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c7f0d12c8a0b3b54263b5f79ffc9c02f094c0e2d
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: af733b706de569614b499bbd615085225fda1c6a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 665a641471efbcf97a6bea6a7543bbd7b475dc54
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/2102093e081f0d57e0b92881970d07c6542c969a
    reference_type: commit
    reference_id: 2102093e081f0d57e0b92881970d07c6542c969a
  - url: https://github.com/xen-project/xen/tree/45729a510a352e1a973e4023bd0067cddb1bcaf8
    reference_type: commit
    reference_id: 45729a510a352e1a973e4023bd0067cddb1bcaf8
  - url: https://github.com/xen-project/xen/tree/665a641471efbcf97a6bea6a7543bbd7b475dc54
    reference_type: commit
    reference_id: 665a641471efbcf97a6bea6a7543bbd7b475dc54
  - url: https://github.com/xen-project/xen/tree/af733b706de569614b499bbd615085225fda1c6a
    reference_type: commit
    reference_id: af733b706de569614b499bbd615085225fda1c6a
  - url: https://github.com/xen-project/xen/tree/c7f0d12c8a0b3b54263b5f79ffc9c02f094c0e2d
    reference_type: commit
    reference_id: c7f0d12c8a0b3b54263b5f79ffc9c02f094c0e2d
