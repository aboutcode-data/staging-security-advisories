advisory_id: CVE-2022-26364
datasource_id: collect_xen_project_fix_commits/CVE-2022-26364
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  f9ae12fc103c7429d8ce6bc57b8cbcefdd71cd45:x86/pv: Track and flush non-coherent mappings of RAM

  There are legitimate uses of WC mappings of RAM, e.g. for DMA buffers with
  devices that make non-coherent writes.  The Linux sound subsystem makes
  extensive use of this technique.

  For such usecases, the guest's DMA buffer is mapped and consistently used as
  WC, and Xen doesn't interact with the buffer.

  However, a mischevious guest can use WC mappings to deliberately create
  non-coherency between the cache and RAM, and use this to trick Xen into
  validating a pagetable which isn't actually safe.

  Allocate a new PGT_non_coherent to track the non-coherency of mappings.  Set
  it whenever a non-coherent writeable mapping is created.  If the page is used
  as anything other than PGT_writable_page, force a cache flush before
  validation.  Also force a cache flush before the page is returned to the heap.

  This is CVE-2022-26364, part of XSA-402.

  Reported-by: Jann Horn <jannh@google.com>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: c1c9cae3a9633054b177c5de21ad7268162b2f2c
  master date: 2022-06-09 14:23:37 +0200
  82ba97ec6b24f3e92fd1749962154cedf2addc5d:x86/pv: Track and flush non-coherent mappings of RAM

  There are legitimate uses of WC mappings of RAM, e.g. for DMA buffers with
  devices that make non-coherent writes.  The Linux sound subsystem makes
  extensive use of this technique.

  For such usecases, the guest's DMA buffer is mapped and consistently used as
  WC, and Xen doesn't interact with the buffer.

  However, a mischevious guest can use WC mappings to deliberately create
  non-coherency between the cache and RAM, and use this to trick Xen into
  validating a pagetable which isn't actually safe.

  Allocate a new PGT_non_coherent to track the non-coherency of mappings.  Set
  it whenever a non-coherent writeable mapping is created.  If the page is used
  as anything other than PGT_writable_page, force a cache flush before
  validation.  Also force a cache flush before the page is returned to the heap.

  This is CVE-2022-26364, part of XSA-402.

  Reported-by: Jann Horn <jannh@google.com>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: c1c9cae3a9633054b177c5de21ad7268162b2f2c
  master date: 2022-06-09 14:23:37 +0200
  a851dbce6876cd2c5689f912787c15cc507cbb39:x86/pv: Track and flush non-coherent mappings of RAM

  There are legitimate uses of WC mappings of RAM, e.g. for DMA buffers with
  devices that make non-coherent writes.  The Linux sound subsystem makes
  extensive use of this technique.

  For such usecases, the guest's DMA buffer is mapped and consistently used as
  WC, and Xen doesn't interact with the buffer.

  However, a mischevious guest can use WC mappings to deliberately create
  non-coherency between the cache and RAM, and use this to trick Xen into
  validating a pagetable which isn't actually safe.

  Allocate a new PGT_non_coherent to track the non-coherency of mappings.  Set
  it whenever a non-coherent writeable mapping is created.  If the page is used
  as anything other than PGT_writable_page, force a cache flush before
  validation.  Also force a cache flush before the page is returned to the heap.

  This is CVE-2022-26364, part of XSA-402.

  Reported-by: Jann Horn <jannh@google.com>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: c1c9cae3a9633054b177c5de21ad7268162b2f2c
  master date: 2022-06-09 14:23:37 +0200
  dc020d8d1ba420e2dd0e7a40f5045db897f3c4f4:x86/pv: Track and flush non-coherent mappings of RAM

  There are legitimate uses of WC mappings of RAM, e.g. for DMA buffers with
  devices that make non-coherent writes.  The Linux sound subsystem makes
  extensive use of this technique.

  For such usecases, the guest's DMA buffer is mapped and consistently used as
  WC, and Xen doesn't interact with the buffer.

  However, a mischevious guest can use WC mappings to deliberately create
  non-coherency between the cache and RAM, and use this to trick Xen into
  validating a pagetable which isn't actually safe.

  Allocate a new PGT_non_coherent to track the non-coherency of mappings.  Set
  it whenever a non-coherent writeable mapping is created.  If the page is used
  as anything other than PGT_writable_page, force a cache flush before
  validation.  Also force a cache flush before the page is returned to the heap.

  This is CVE-2022-26364, part of XSA-402.

  Reported-by: Jann Horn <jannh@google.com>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  master commit: c1c9cae3a9633054b177c5de21ad7268162b2f2c
  master date: 2022-06-09 14:23:37 +0200
  c1c9cae3a9633054b177c5de21ad7268162b2f2c:x86/pv: Track and flush non-coherent mappings of RAM

  There are legitimate uses of WC mappings of RAM, e.g. for DMA buffers with
  devices that make non-coherent writes.  The Linux sound subsystem makes
  extensive use of this technique.

  For such usecases, the guest's DMA buffer is mapped and consistently used as
  WC, and Xen doesn't interact with the buffer.

  However, a mischevious guest can use WC mappings to deliberately create
  non-coherency between the cache and RAM, and use this to trick Xen into
  validating a pagetable which isn't actually safe.

  Allocate a new PGT_non_coherent to track the non-coherency of mappings.  Set
  it whenever a non-coherent writeable mapping is created.  If the page is used
  as anything other than PGT_writable_page, force a cache flush before
  validation.  Also force a cache flush before the page is returned to the heap.

  This is CVE-2022-26364, part of XSA-402.

  Reported-by: Jann Horn <jannh@google.com>
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: George Dunlap <george.dunlap@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: f9ae12fc103c7429d8ce6bc57b8cbcefdd71cd45
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c1c9cae3a9633054b177c5de21ad7268162b2f2c
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 82ba97ec6b24f3e92fd1749962154cedf2addc5d
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: dc020d8d1ba420e2dd0e7a40f5045db897f3c4f4
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a851dbce6876cd2c5689f912787c15cc507cbb39
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/82ba97ec6b24f3e92fd1749962154cedf2addc5d
    reference_type: commit
    reference_id: 82ba97ec6b24f3e92fd1749962154cedf2addc5d
  - url: https://github.com/xen-project/xen/tree/a851dbce6876cd2c5689f912787c15cc507cbb39
    reference_type: commit
    reference_id: a851dbce6876cd2c5689f912787c15cc507cbb39
  - url: https://github.com/xen-project/xen/tree/c1c9cae3a9633054b177c5de21ad7268162b2f2c
    reference_type: commit
    reference_id: c1c9cae3a9633054b177c5de21ad7268162b2f2c
  - url: https://github.com/xen-project/xen/tree/dc020d8d1ba420e2dd0e7a40f5045db897f3c4f4
    reference_type: commit
    reference_id: dc020d8d1ba420e2dd0e7a40f5045db897f3c4f4
  - url: https://github.com/xen-project/xen/tree/f9ae12fc103c7429d8ce6bc57b8cbcefdd71cd45
    reference_type: commit
    reference_id: f9ae12fc103c7429d8ce6bc57b8cbcefdd71cd45
