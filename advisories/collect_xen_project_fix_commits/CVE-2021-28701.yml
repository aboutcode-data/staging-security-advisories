advisory_id: CVE-2021-28701
datasource_id: collect_xen_project_fix_commits/CVE-2021-28701
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  47193c78887734c2f95a50125684bf81419f1565:gnttab: deal with status frame mapping race

  Once gnttab_map_frame() drops the grant table lock, the MFN it reports
  back to its caller is free to other manipulation. In particular
  gnttab_unpopulate_status_frames() might free it, by a racing request on
  another CPU, thus resulting in a reference to a deallocated page getting
  added to a domain's P2M.

  Obtain a page reference in gnttab_map_frame() to prevent freeing of the
  page until xenmem_add_to_physmap_one() has actually completed its acting
  on the page. Do so uniformly, even if only strictly required for v2
  status pages, to avoid extra conditionals (which then would all need to
  be kept in sync going forward).

  This is CVE-2021-28701 / XSA-384.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: eb6bbf7b30da5bae87932514d54d0e3c68b23757
  master date: 2021-09-08 14:37:45 +0200
  9c4b19c110e1410e50a9f1dbd15d337b05e9cc9d:gnttab: deal with status frame mapping race

  Once gnttab_map_frame() drops the grant table lock, the MFN it reports
  back to its caller is free to other manipulation. In particular
  gnttab_unpopulate_status_frames() might free it, by a racing request on
  another CPU, thus resulting in a reference to a deallocated page getting
  added to a domain's P2M.

  Obtain a page reference in gnttab_map_frame() to prevent freeing of the
  page until xenmem_add_to_physmap_one() has actually completed its acting
  on the page. Do so uniformly, even if only strictly required for v2
  status pages, to avoid extra conditionals (which then would all need to
  be kept in sync going forward).

  This is CVE-2021-28701 / XSA-384.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: eb6bbf7b30da5bae87932514d54d0e3c68b23757
  master date: 2021-09-08 14:37:45 +0200
  ef6455a3707cf1c7c61ad8af12558811eeee4ba8:gnttab: deal with status frame mapping race

  Once gnttab_map_frame() drops the grant table lock, the MFN it reports
  back to its caller is free to other manipulation. In particular
  gnttab_unpopulate_status_frames() might free it, by a racing request on
  another CPU, thus resulting in a reference to a deallocated page getting
  added to a domain's P2M.

  Obtain a page reference in gnttab_map_frame() to prevent freeing of the
  page until xenmem_add_to_physmap_one() has actually completed its acting
  on the page. Do so uniformly, even if only strictly required for v2
  status pages, to avoid extra conditionals (which then would all need to
  be kept in sync going forward).

  This is CVE-2021-28701 / XSA-384.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: eb6bbf7b30da5bae87932514d54d0e3c68b23757
  master date: 2021-09-08 14:37:45 +0200
  6f92f38419d6bd052da9076a7d89534b1f85ded9:gnttab: deal with status frame mapping race

  Once gnttab_map_frame() drops the grant table lock, the MFN it reports
  back to its caller is free to other manipulation. In particular
  gnttab_unpopulate_status_frames() might free it, by a racing request on
  another CPU, thus resulting in a reference to a deallocated page getting
  added to a domain's P2M.

  Obtain a page reference in gnttab_map_frame() to prevent freeing of the
  page until xenmem_add_to_physmap_one() has actually completed its acting
  on the page. Do so uniformly, even if only strictly required for v2
  status pages, to avoid extra conditionals (which then would all need to
  be kept in sync going forward).

  This is CVE-2021-28701 / XSA-384.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: eb6bbf7b30da5bae87932514d54d0e3c68b23757
  master date: 2021-09-08 14:37:45 +0200
  eb6bbf7b30da5bae87932514d54d0e3c68b23757:gnttab: deal with status frame mapping race

  Once gnttab_map_frame() drops the grant table lock, the MFN it reports
  back to its caller is free to other manipulation. In particular
  gnttab_unpopulate_status_frames() might free it, by a racing request on
  another CPU, thus resulting in a reference to a deallocated page getting
  added to a domain's P2M.

  Obtain a page reference in gnttab_map_frame() to prevent freeing of the
  page until xenmem_add_to_physmap_one() has actually completed its acting
  on the page. Do so uniformly, even if only strictly required for v2
  status pages, to avoid extra conditionals (which then would all need to
  be kept in sync going forward).

  This is CVE-2021-28701 / XSA-384.

  Reported-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 6f92f38419d6bd052da9076a7d89534b1f85ded9
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ef6455a3707cf1c7c61ad8af12558811eeee4ba8
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 47193c78887734c2f95a50125684bf81419f1565
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 9c4b19c110e1410e50a9f1dbd15d337b05e9cc9d
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: eb6bbf7b30da5bae87932514d54d0e3c68b23757
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/47193c78887734c2f95a50125684bf81419f1565
    reference_type: commit
    reference_id: 47193c78887734c2f95a50125684bf81419f1565
  - url: https://github.com/xen-project/xen/tree/6f92f38419d6bd052da9076a7d89534b1f85ded9
    reference_type: commit
    reference_id: 6f92f38419d6bd052da9076a7d89534b1f85ded9
  - url: https://github.com/xen-project/xen/tree/9c4b19c110e1410e50a9f1dbd15d337b05e9cc9d
    reference_type: commit
    reference_id: 9c4b19c110e1410e50a9f1dbd15d337b05e9cc9d
  - url: https://github.com/xen-project/xen/tree/eb6bbf7b30da5bae87932514d54d0e3c68b23757
    reference_type: commit
    reference_id: eb6bbf7b30da5bae87932514d54d0e3c68b23757
  - url: https://github.com/xen-project/xen/tree/ef6455a3707cf1c7c61ad8af12558811eeee4ba8
    reference_type: commit
    reference_id: ef6455a3707cf1c7c61ad8af12558811eeee4ba8
