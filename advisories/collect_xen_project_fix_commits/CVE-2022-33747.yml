advisory_id: CVE-2022-33747
datasource_id: collect_xen_project_fix_commits/CVE-2022-33747
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  042a5b7024e7b27f5806914b9d42099a48c8f893:xen/arm: Correct the p2m pool size calculations

  Allocating or freeing p2m pages doesn't alter the size of the mempool; only
  the split between free and used pages.

  Right now, the hypercalls operate on the free subset of the pool, meaning that
  XEN_DOMCTL_get_paging_mempool_size varies with time as the guest shuffles its
  physmap, and XEN_DOMCTL_set_paging_mempool_size ignores the used subset of the
  pool and lets the guest grow unbounded.

  This fixes test-pagign-mempool on ARM so that the behaviour matches x86.

  This is part of XSA-409 / CVE-2022-33747.

  Fixes: cbea5a1149ca ("xen/arm: Allocate and free P2M pages from the P2M pool")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  Release-acked-by: Henry Wang <Henry.Wang@arm.com>
  db8fa01c61db0317a9ee947925226234c65d48e8:xen/arm: Correct the p2m pool size calculations

  Allocating or freeing p2m pages doesn't alter the size of the mempool; only
  the split between free and used pages.

  Right now, the hypercalls operate on the free subset of the pool, meaning that
  XEN_DOMCTL_get_paging_mempool_size varies with time as the guest shuffles its
  physmap, and XEN_DOMCTL_set_paging_mempool_size ignores the used subset of the
  pool and lets the guest grow unbounded.

  This fixes test-pagign-mempool on ARM so that the behaviour matches x86.

  This is part of XSA-409 / CVE-2022-33747.

  Fixes: cbea5a1149ca ("xen/arm: Allocate and free P2M pages from the P2M pool")
  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  Release-acked-by: Henry Wang <Henry.Wang@arm.com>
  7c3bbd940dd8aeb1649734e5055798cc6f3fea4e:xen/arm, libxl: Revert XEN_DOMCTL_shadow_op; use p2m mempool hypercalls

  This reverts most of commit cf2a68d2ffbc3ce95e01449d46180bddb10d24a0, and bits
  of cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7.

  First of all, with ARM borrowing x86's implementation, the logic to set the
  pool size should have been common, not duplicated.  Introduce
  libxl__domain_set_paging_mempool_size() as a shared implementation, and use it
  from the ARM and x86 paths.  It is left as an exercise to the reader to judge
  how libxl/xl can reasonably function without the ability to query the pool
  size...

  Remove ARM's p2m_domctl() infrastructure now the functioanlity has been
  replaced with a working and unit tested interface.

  This is part of XSA-409 / CVE-2022-33747.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  Reviewed-by: Anthony PERARD <anthony.perard@citrix.com>
  Release-acked-by: Henry Wang <Henry.Wang@arm.com>
  bd87315a603bf25e869e6293f7db7b1024d67999:tools/tests: Unit test for paging mempool size

  Exercise some basic functionality of the new
  xc_{get,set}_paging_mempool_size() hypercalls.

  This passes on x86, but fails currently on ARM.  ARM will be fixed up in
  future patches.

  This is part of XSA-409 / CVE-2022-33747.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Acked-by: Jan Beulich <jbeulich@suse.com>
  Acked-by: Anthony PERARD <anthony.perard@citrix.com>
  Release-acked-by: Henry Wang <Henry.Wang@arm.com>
  22b20bd98c025e06525410e3ab3494d5e63489f7:xen: Introduce non-broken hypercalls for the paging mempool size

  The existing XEN_DOMCTL_SHADOW_OP_{GET,SET}_ALLOCATION have problems:

   * All set_allocation() flavours have an overflow-before-widen bug when
     calculating "sc->mb << (20 - PAGE_SHIFT)".
   * All flavours have a granularity of 1M.  This was tolerable when the size of
     the pool could only be set at the same granularity, but is broken now that
     ARM has a 16-page stopgap allocation in use.
   * All get_allocation() flavours round up, and in particular turn 0 into 1,
     meaning the get op returns junk before a successful set op.
   * The x86 flavours reject the hypercalls before the VM has vCPUs allocated,
     despite the pool size being a domain property.
   * Even the hypercall names are long-obsolete.

  Implement a better interface, which can be first used to unit test the
  behaviour, and subsequently correct a broken implementation.  The old
  interface will be retired in due course.

  The unit of bytes (as opposed pages) is a deliberate API/ABI improvement to
  more easily support multiple page granularities.

  This is part of XSA-409 / CVE-2022-33747.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Acked-by: Anthony PERARD <anthony.perard@citrix.com>
  Release-acked-by: Henry Wang <Henry.Wang@arm.com>
  867fcf6ca2e6a5dfb490bc5a1bd9b36d8ba88531:xen/arm: Allocate and free P2M pages from the P2M pool

  This commit sets/tearsdown of p2m pages pool for non-privileged Arm
  guests by calling `p2m_set_allocation` and `p2m_teardown_allocation`.

  - For dom0, P2M pages should come from heap directly instead of p2m
  pool, so that the kernel may take advantage of the extended regions.

  - For xl guests, the setting of the p2m pool is called in
  `XEN_DOMCTL_shadow_op` and the p2m pool is destroyed in
  `domain_relinquish_resources`. Note that domctl->u.shadow_op.mb is
  updated with the new size when setting the p2m pool.

  - For dom0less domUs, the setting of the p2m pool is called before
  allocating memory during domain creation. Users can specify the p2m
  pool size by `xen,domain-p2m-mem-mb` dts property.

  To actually allocate/free pages from the p2m pool, this commit adds
  two helper functions namely `p2m_alloc_page` and `p2m_free_page` to
  `struct p2m_domain`. By replacing the `alloc_domheap_page` and
  `free_domheap_page` with these two helper functions, p2m pages can
  be added/removed from the list of p2m pool rather than from the heap.

  Since page from `p2m_alloc_page` is cleaned, take the opportunity
  to remove the redundant `clean_page` in `p2m_create_table`.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
  master date: 2022-10-11 14:28:44 +0200
  e6b1e3892b685346490eded1f6b6f5392b1020b0:xen/arm, libxl: Implement XEN_DOMCTL_shadow_op for Arm

  This commit implements the `XEN_DOMCTL_shadow_op` support in Xen
  for Arm. The p2m pages pool size for xl guests is supposed to be
  determined by `XEN_DOMCTL_shadow_op`. Hence, this commit:

  - Introduces a function `p2m_domctl` and implements the subops
  `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` and
  `XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION` of `XEN_DOMCTL_shadow_op`.

  - Adds the `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` support in libxl.

  Therefore enabling the setting of shadow memory pool size
  when creating a guest from xl and getting shadow memory pool size
  from Xen.

  Note that the `XEN_DOMCTL_shadow_op` added in this commit is only
  a dummy op, and the functionality of setting/getting p2m memory pool
  size for xl guests will be added in following commits.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
  master date: 2022-10-11 14:28:42 +0200
  2ae9bbef0f84a025719382ffcf44882b76316d62:xen/arm: Construct the P2M pages pool for guests

  This commit constructs the p2m pages pool for guests from the
  data structure and helper perspective.

  This is implemented by:

  - Adding a `struct paging_domain` which contains a freelist, a
  counter variable and a spinlock to `struct arch_domain` to
  indicate the free p2m pages and the number of p2m total pages in
  the p2m pages pool.

  - Adding a helper `p2m_get_allocation` to get the p2m pool size.

  - Adding a helper `p2m_set_allocation` to set the p2m pages pool
  size. This helper should be called before allocating memory for
  a guest.

  - Adding a helper `p2m_teardown_allocation` to free the p2m pages
  pool. This helper should be called during the xl domain destory.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: 55914f7fc91a468649b8a3ec3f53ae1c4aca6670
  master date: 2022-10-11 14:28:39 +0200
  9992c089de1fbb4d3217d2421ca60295998645d7:libxl, docs: Use arch-specific default paging memory

  The default paging memory (descibed in `shadow_memory` entry in xl
  config) in libxl is used to determine the memory pool size for xl
  guests. Currently this size is only used for x86, and contains a part
  of RAM to shadow the resident processes. Since on Arm there is no
  shadow mode guests, so the part of RAM to shadow the resident processes
  is not necessary. Therefore, this commit splits the function
  `libxl_get_required_shadow_memory()` to arch specific helpers and
  renamed the helper to `libxl__arch_get_required_paging_memory()`.

  On x86, this helper calls the original value from
  `libxl_get_required_shadow_memory()` so no functional change intended.

  On Arm, this helper returns 1MB per vcpu plus 4KB per MiB of RAM
  for the P2M map and additional 512KB.

  Also update the xl.cfg documentation to add Arm documentation
  according to code changes and correct the comment style following Xen
  coding style.

  This is part of CVE-2022-33747 / XSA-409.

  Suggested-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Anthony PERARD <anthony.perard@citrix.com>
  master commit: 156a239ea288972425f967ac807b3cb5b5e14874
  master date: 2022-10-11 14:28:37 +0200
  7d64fb52a57109147dd4180e3a3ba4b5e735a117:xen/arm: Allocate and free P2M pages from the P2M pool

  This commit sets/tearsdown of p2m pages pool for non-privileged Arm
  guests by calling `p2m_set_allocation` and `p2m_teardown_allocation`.

  - For dom0, P2M pages should come from heap directly instead of p2m
  pool, so that the kernel may take advantage of the extended regions.

  - For xl guests, the setting of the p2m pool is called in
  `XEN_DOMCTL_shadow_op` and the p2m pool is destroyed in
  `domain_relinquish_resources`. Note that domctl->u.shadow_op.mb is
  updated with the new size when setting the p2m pool.

  - For dom0less domUs, the setting of the p2m pool is called before
  allocating memory during domain creation. Users can specify the p2m
  pool size by `xen,domain-p2m-mem-mb` dts property.

  To actually allocate/free pages from the p2m pool, this commit adds
  two helper functions namely `p2m_alloc_page` and `p2m_free_page` to
  `struct p2m_domain`. By replacing the `alloc_domheap_page` and
  `free_domheap_page` with these two helper functions, p2m pages can
  be added/removed from the list of p2m pool rather than from the heap.

  Since page from `p2m_alloc_page` is cleaned, take the opportunity
  to remove the redundant `clean_page` in `p2m_create_table`.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
  master date: 2022-10-11 14:28:44 +0200
  4220eac3799f46ba84316513606a33e1ea33fb4e:xen/arm, libxl: Implement XEN_DOMCTL_shadow_op for Arm

  This commit implements the `XEN_DOMCTL_shadow_op` support in Xen
  for Arm. The p2m pages pool size for xl guests is supposed to be
  determined by `XEN_DOMCTL_shadow_op`. Hence, this commit:

  - Introduces a function `p2m_domctl` and implements the subops
  `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` and
  `XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION` of `XEN_DOMCTL_shadow_op`.

  - Adds the `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` support in libxl.

  Therefore enabling the setting of shadow memory pool size
  when creating a guest from xl and getting shadow memory pool size
  from Xen.

  Note that the `XEN_DOMCTL_shadow_op` added in this commit is only
  a dummy op, and the functionality of setting/getting p2m memory pool
  size for xl guests will be added in following commits.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
  master date: 2022-10-11 14:28:42 +0200
  fd688b06a57a327dc5dbda106a104a2af5e1aa2b:xen/arm: Construct the P2M pages pool for guests

  This commit constructs the p2m pages pool for guests from the
  data structure and helper perspective.

  This is implemented by:

  - Adding a `struct paging_domain` which contains a freelist, a
  counter variable and a spinlock to `struct arch_domain` to
  indicate the free p2m pages and the number of p2m total pages in
  the p2m pages pool.

  - Adding a helper `p2m_get_allocation` to get the p2m pool size.

  - Adding a helper `p2m_set_allocation` to set the p2m pages pool
  size. This helper should be called before allocating memory for
  a guest.

  - Adding a helper `p2m_teardown_allocation` to free the p2m pages
  pool. This helper should be called during the xl domain destory.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: 55914f7fc91a468649b8a3ec3f53ae1c4aca6670
  master date: 2022-10-11 14:28:39 +0200
  e3b66e5cba89fc0b59c9a116e7414388d45e04a0:libxl, docs: Use arch-specific default paging memory

  The default paging memory (descibed in `shadow_memory` entry in xl
  config) in libxl is used to determine the memory pool size for xl
  guests. Currently this size is only used for x86, and contains a part
  of RAM to shadow the resident processes. Since on Arm there is no
  shadow mode guests, so the part of RAM to shadow the resident processes
  is not necessary. Therefore, this commit splits the function
  `libxl_get_required_shadow_memory()` to arch specific helpers and
  renamed the helper to `libxl__arch_get_required_paging_memory()`.

  On x86, this helper calls the original value from
  `libxl_get_required_shadow_memory()` so no functional change intended.

  On Arm, this helper returns 1MB per vcpu plus 4KB per MiB of RAM
  for the P2M map and additional 512KB.

  Also update the xl.cfg documentation to add Arm documentation
  according to code changes and correct the comment style following Xen
  coding style.

  This is part of CVE-2022-33747 / XSA-409.

  Suggested-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Anthony PERARD <anthony.perard@citrix.com>
  master commit: 156a239ea288972425f967ac807b3cb5b5e14874
  master date: 2022-10-11 14:28:37 +0200
  7ad38a39f08aadc1578bdb46ccabaad79ed0faee:xen/arm: Allocate and free P2M pages from the P2M pool

  This commit sets/tearsdown of p2m pages pool for non-privileged Arm
  guests by calling `p2m_set_allocation` and `p2m_teardown_allocation`.

  - For dom0, P2M pages should come from heap directly instead of p2m
  pool, so that the kernel may take advantage of the extended regions.

  - For xl guests, the setting of the p2m pool is called in
  `XEN_DOMCTL_shadow_op` and the p2m pool is destroyed in
  `domain_relinquish_resources`. Note that domctl->u.shadow_op.mb is
  updated with the new size when setting the p2m pool.

  - For dom0less domUs, the setting of the p2m pool is called before
  allocating memory during domain creation. Users can specify the p2m
  pool size by `xen,domain-p2m-mem-mb` dts property.

  To actually allocate/free pages from the p2m pool, this commit adds
  two helper functions namely `p2m_alloc_page` and `p2m_free_page` to
  `struct p2m_domain`. By replacing the `alloc_domheap_page` and
  `free_domheap_page` with these two helper functions, p2m pages can
  be added/removed from the list of p2m pool rather than from the heap.

  Since page from `p2m_alloc_page` is cleaned, take the opportunity
  to remove the redundant `clean_page` in `p2m_create_table`.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
  master date: 2022-10-11 14:28:44 +0200
  c5215044578e88b401a1296ed6302df05c113c5f:xen/arm, libxl: Implement XEN_DOMCTL_shadow_op for Arm

  This commit implements the `XEN_DOMCTL_shadow_op` support in Xen
  for Arm. The p2m pages pool size for xl guests is supposed to be
  determined by `XEN_DOMCTL_shadow_op`. Hence, this commit:

  - Introduces a function `p2m_domctl` and implements the subops
  `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` and
  `XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION` of `XEN_DOMCTL_shadow_op`.

  - Adds the `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` support in libxl.

  Therefore enabling the setting of shadow memory pool size
  when creating a guest from xl and getting shadow memory pool size
  from Xen.

  Note that the `XEN_DOMCTL_shadow_op` added in this commit is only
  a dummy op, and the functionality of setting/getting p2m memory pool
  size for xl guests will be added in following commits.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
  master date: 2022-10-11 14:28:42 +0200
  45336d8f88725aec65ee177b1b09abf6eef1dc8d:xen/arm: Construct the P2M pages pool for guests

  This commit constructs the p2m pages pool for guests from the
  data structure and helper perspective.

  This is implemented by:

  - Adding a `struct paging_domain` which contains a freelist, a
  counter variable and a spinlock to `struct arch_domain` to
  indicate the free p2m pages and the number of p2m total pages in
  the p2m pages pool.

  - Adding a helper `p2m_get_allocation` to get the p2m pool size.

  - Adding a helper `p2m_set_allocation` to set the p2m pages pool
  size. This helper should be called before allocating memory for
  a guest.

  - Adding a helper `p2m_teardown_allocation` to free the p2m pages
  pool. This helper should be called during the xl domain destory.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: 55914f7fc91a468649b8a3ec3f53ae1c4aca6670
  master date: 2022-10-11 14:28:39 +0200
  0c0680d6e7953ca4c91699e60060c732f9ead5c1:libxl, docs: Use arch-specific default paging memory

  The default paging memory (descibed in `shadow_memory` entry in xl
  config) in libxl is used to determine the memory pool size for xl
  guests. Currently this size is only used for x86, and contains a part
  of RAM to shadow the resident processes. Since on Arm there is no
  shadow mode guests, so the part of RAM to shadow the resident processes
  is not necessary. Therefore, this commit splits the function
  `libxl_get_required_shadow_memory()` to arch specific helpers and
  renamed the helper to `libxl__arch_get_required_paging_memory()`.

  On x86, this helper calls the original value from
  `libxl_get_required_shadow_memory()` so no functional change intended.

  On Arm, this helper returns 1MB per vcpu plus 4KB per MiB of RAM
  for the P2M map and additional 512KB.

  Also update the xl.cfg documentation to add Arm documentation
  according to code changes and correct the comment style following Xen
  coding style.

  This is part of CVE-2022-33747 / XSA-409.

  Suggested-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Anthony PERARD <anthony.perard@citrix.com>
  master commit: 156a239ea288972425f967ac807b3cb5b5e14874
  master date: 2022-10-11 14:28:37 +0200
  44e9dcc48b81bca202a5b31926125a6a59a4c72e:xen/arm: Allocate and free P2M pages from the P2M pool

  This commit sets/tearsdown of p2m pages pool for non-privileged Arm
  guests by calling `p2m_set_allocation` and `p2m_teardown_allocation`.

  - For dom0, P2M pages should come from heap directly instead of p2m
  pool, so that the kernel may take advantage of the extended regions.

  - For xl guests, the setting of the p2m pool is called in
  `XEN_DOMCTL_shadow_op` and the p2m pool is destroyed in
  `domain_relinquish_resources`. Note that domctl->u.shadow_op.mb is
  updated with the new size when setting the p2m pool.

  - For dom0less domUs, the setting of the p2m pool is called before
  allocating memory during domain creation. Users can specify the p2m
  pool size by `xen,domain-p2m-mem-mb` dts property.

  To actually allocate/free pages from the p2m pool, this commit adds
  two helper functions namely `p2m_alloc_page` and `p2m_free_page` to
  `struct p2m_domain`. By replacing the `alloc_domheap_page` and
  `free_domheap_page` with these two helper functions, p2m pages can
  be added/removed from the list of p2m pool rather than from the heap.

  Since page from `p2m_alloc_page` is cleaned, take the opportunity
  to remove the redundant `clean_page` in `p2m_create_table`.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
  master date: 2022-10-11 14:28:44 +0200
  3a16da801e14b8ff996b6f7408391ce488abd925:xen/arm, libxl: Implement XEN_DOMCTL_shadow_op for Arm

  This commit implements the `XEN_DOMCTL_shadow_op` support in Xen
  for Arm. The p2m pages pool size for xl guests is supposed to be
  determined by `XEN_DOMCTL_shadow_op`. Hence, this commit:

  - Introduces a function `p2m_domctl` and implements the subops
  `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` and
  `XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION` of `XEN_DOMCTL_shadow_op`.

  - Adds the `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` support in libxl.

  Therefore enabling the setting of shadow memory pool size
  when creating a guest from xl and getting shadow memory pool size
  from Xen.

  Note that the `XEN_DOMCTL_shadow_op` added in this commit is only
  a dummy op, and the functionality of setting/getting p2m memory pool
  size for xl guests will be added in following commits.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
  master date: 2022-10-11 14:28:42 +0200
  914fc8e8b4cc003e90d51bee0aef54687358530a:xen/arm: Construct the P2M pages pool for guests

  This commit constructs the p2m pages pool for guests from the
  data structure and helper perspective.

  This is implemented by:

  - Adding a `struct paging_domain` which contains a freelist, a
  counter variable and a spinlock to `struct arch_domain` to
  indicate the free p2m pages and the number of p2m total pages in
  the p2m pages pool.

  - Adding a helper `p2m_get_allocation` to get the p2m pool size.

  - Adding a helper `p2m_set_allocation` to set the p2m pages pool
  size. This helper should be called before allocating memory for
  a guest.

  - Adding a helper `p2m_teardown_allocation` to free the p2m pages
  pool. This helper should be called during the xl domain destory.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  master commit: 55914f7fc91a468649b8a3ec3f53ae1c4aca6670
  master date: 2022-10-11 14:28:39 +0200
  755a9b52844de3e1e47aa1fc9991a4240ccfbf35:libxl, docs: Use arch-specific default paging memory

  The default paging memory (descibed in `shadow_memory` entry in xl
  config) in libxl is used to determine the memory pool size for xl
  guests. Currently this size is only used for x86, and contains a part
  of RAM to shadow the resident processes. Since on Arm there is no
  shadow mode guests, so the part of RAM to shadow the resident processes
  is not necessary. Therefore, this commit splits the function
  `libxl_get_required_shadow_memory()` to arch specific helpers and
  renamed the helper to `libxl__arch_get_required_paging_memory()`.

  On x86, this helper calls the original value from
  `libxl_get_required_shadow_memory()` so no functional change intended.

  On Arm, this helper returns 1MB per vcpu plus 4KB per MiB of RAM
  for the P2M map and additional 512KB.

  Also update the xl.cfg documentation to add Arm documentation
  according to code changes and correct the comment style following Xen
  coding style.

  This is part of CVE-2022-33747 / XSA-409.

  Suggested-by: Julien Grall <jgrall@amazon.com>
  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Anthony PERARD <anthony.perard@citrix.com>
  master commit: 156a239ea288972425f967ac807b3cb5b5e14874
  master date: 2022-10-11 14:28:37 +0200
  cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7:xen/arm: Allocate and free P2M pages from the P2M pool

  This commit sets/tearsdown of p2m pages pool for non-privileged Arm
  guests by calling `p2m_set_allocation` and `p2m_teardown_allocation`.

  - For dom0, P2M pages should come from heap directly instead of p2m
  pool, so that the kernel may take advantage of the extended regions.

  - For xl guests, the setting of the p2m pool is called in
  `XEN_DOMCTL_shadow_op` and the p2m pool is destroyed in
  `domain_relinquish_resources`. Note that domctl->u.shadow_op.mb is
  updated with the new size when setting the p2m pool.

  - For dom0less domUs, the setting of the p2m pool is called before
  allocating memory during domain creation. Users can specify the p2m
  pool size by `xen,domain-p2m-mem-mb` dts property.

  To actually allocate/free pages from the p2m pool, this commit adds
  two helper functions namely `p2m_alloc_page` and `p2m_free_page` to
  `struct p2m_domain`. By replacing the `alloc_domheap_page` and
  `free_domheap_page` with these two helper functions, p2m pages can
  be added/removed from the list of p2m pool rather than from the heap.

  Since page from `p2m_alloc_page` is cleaned, take the opportunity
  to remove the redundant `clean_page` in `p2m_create_table`.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  cf2a68d2ffbc3ce95e01449d46180bddb10d24a0:xen/arm, libxl: Implement XEN_DOMCTL_shadow_op for Arm

  This commit implements the `XEN_DOMCTL_shadow_op` support in Xen
  for Arm. The p2m pages pool size for xl guests is supposed to be
  determined by `XEN_DOMCTL_shadow_op`. Hence, this commit:

  - Introduces a function `p2m_domctl` and implements the subops
  `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` and
  `XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION` of `XEN_DOMCTL_shadow_op`.

  - Adds the `XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION` support in libxl.

  Therefore enabling the setting of shadow memory pool size
  when creating a guest from xl and getting shadow memory pool size
  from Xen.

  Note that the `XEN_DOMCTL_shadow_op` added in this commit is only
  a dummy op, and the functionality of setting/getting p2m memory pool
  size for xl guests will be added in following commits.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  55914f7fc91a468649b8a3ec3f53ae1c4aca6670:xen/arm: Construct the P2M pages pool for guests

  This commit constructs the p2m pages pool for guests from the
  data structure and helper perspective.

  This is implemented by:

  - Adding a `struct paging_domain` which contains a freelist, a
  counter variable and a spinlock to `struct arch_domain` to
  indicate the free p2m pages and the number of p2m total pages in
  the p2m pages pool.

  - Adding a helper `p2m_get_allocation` to get the p2m pool size.

  - Adding a helper `p2m_set_allocation` to set the p2m pages pool
  size. This helper should be called before allocating memory for
  a guest.

  - Adding a helper `p2m_teardown_allocation` to free the p2m pages
  pool. This helper should be called during the xl domain destory.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Stefano Stabellini <sstabellini@kernel.org>
  156a239ea288972425f967ac807b3cb5b5e14874:libxl, docs: Add per-arch extra default paging memory

  This commit adds a per-arch macro `EXTRA_DEFAULT_PAGING_MEM_MB`
  to the default paging memory size, in order to cover the p2m
  pool for extended regions of a xl-based guest on Arm.

  For Arm, the extra default paging memory is 128MB.
  For x86, the extra default paging memory is zero, since there
  are no extended regions on x86.

  Also update the xl.cfg documentation to add Arm documentation
  according to code changes.

  This is part of CVE-2022-33747 / XSA-409.

  Signed-off-by: Henry Wang <Henry.Wang@arm.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 55914f7fc91a468649b8a3ec3f53ae1c4aca6670
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3a16da801e14b8ff996b6f7408391ce488abd925
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7c3bbd940dd8aeb1649734e5055798cc6f3fea4e
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 45336d8f88725aec65ee177b1b09abf6eef1dc8d
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 867fcf6ca2e6a5dfb490bc5a1bd9b36d8ba88531
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c5215044578e88b401a1296ed6302df05c113c5f
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 914fc8e8b4cc003e90d51bee0aef54687358530a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e3b66e5cba89fc0b59c9a116e7414388d45e04a0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 4220eac3799f46ba84316513606a33e1ea33fb4e
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 9992c089de1fbb4d3217d2421ca60295998645d7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: db8fa01c61db0317a9ee947925226234c65d48e8
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0c0680d6e7953ca4c91699e60060c732f9ead5c1
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: bd87315a603bf25e869e6293f7db7b1024d67999
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: fd688b06a57a327dc5dbda106a104a2af5e1aa2b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 22b20bd98c025e06525410e3ab3494d5e63489f7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 2ae9bbef0f84a025719382ffcf44882b76316d62
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7ad38a39f08aadc1578bdb46ccabaad79ed0faee
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 44e9dcc48b81bca202a5b31926125a6a59a4c72e
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e6b1e3892b685346490eded1f6b6f5392b1020b0
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 156a239ea288972425f967ac807b3cb5b5e14874
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 755a9b52844de3e1e47aa1fc9991a4240ccfbf35
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 7d64fb52a57109147dd4180e3a3ba4b5e735a117
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 042a5b7024e7b27f5806914b9d42099a48c8f893
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/042a5b7024e7b27f5806914b9d42099a48c8f893
    reference_type: commit
    reference_id: 042a5b7024e7b27f5806914b9d42099a48c8f893
  - url: https://github.com/xen-project/xen/tree/0c0680d6e7953ca4c91699e60060c732f9ead5c1
    reference_type: commit
    reference_id: 0c0680d6e7953ca4c91699e60060c732f9ead5c1
  - url: https://github.com/xen-project/xen/tree/156a239ea288972425f967ac807b3cb5b5e14874
    reference_type: commit
    reference_id: 156a239ea288972425f967ac807b3cb5b5e14874
  - url: https://github.com/xen-project/xen/tree/22b20bd98c025e06525410e3ab3494d5e63489f7
    reference_type: commit
    reference_id: 22b20bd98c025e06525410e3ab3494d5e63489f7
  - url: https://github.com/xen-project/xen/tree/2ae9bbef0f84a025719382ffcf44882b76316d62
    reference_type: commit
    reference_id: 2ae9bbef0f84a025719382ffcf44882b76316d62
  - url: https://github.com/xen-project/xen/tree/3a16da801e14b8ff996b6f7408391ce488abd925
    reference_type: commit
    reference_id: 3a16da801e14b8ff996b6f7408391ce488abd925
  - url: https://github.com/xen-project/xen/tree/4220eac3799f46ba84316513606a33e1ea33fb4e
    reference_type: commit
    reference_id: 4220eac3799f46ba84316513606a33e1ea33fb4e
  - url: https://github.com/xen-project/xen/tree/44e9dcc48b81bca202a5b31926125a6a59a4c72e
    reference_type: commit
    reference_id: 44e9dcc48b81bca202a5b31926125a6a59a4c72e
  - url: https://github.com/xen-project/xen/tree/45336d8f88725aec65ee177b1b09abf6eef1dc8d
    reference_type: commit
    reference_id: 45336d8f88725aec65ee177b1b09abf6eef1dc8d
  - url: https://github.com/xen-project/xen/tree/55914f7fc91a468649b8a3ec3f53ae1c4aca6670
    reference_type: commit
    reference_id: 55914f7fc91a468649b8a3ec3f53ae1c4aca6670
  - url: https://github.com/xen-project/xen/tree/755a9b52844de3e1e47aa1fc9991a4240ccfbf35
    reference_type: commit
    reference_id: 755a9b52844de3e1e47aa1fc9991a4240ccfbf35
  - url: https://github.com/xen-project/xen/tree/7ad38a39f08aadc1578bdb46ccabaad79ed0faee
    reference_type: commit
    reference_id: 7ad38a39f08aadc1578bdb46ccabaad79ed0faee
  - url: https://github.com/xen-project/xen/tree/7c3bbd940dd8aeb1649734e5055798cc6f3fea4e
    reference_type: commit
    reference_id: 7c3bbd940dd8aeb1649734e5055798cc6f3fea4e
  - url: https://github.com/xen-project/xen/tree/7d64fb52a57109147dd4180e3a3ba4b5e735a117
    reference_type: commit
    reference_id: 7d64fb52a57109147dd4180e3a3ba4b5e735a117
  - url: https://github.com/xen-project/xen/tree/867fcf6ca2e6a5dfb490bc5a1bd9b36d8ba88531
    reference_type: commit
    reference_id: 867fcf6ca2e6a5dfb490bc5a1bd9b36d8ba88531
  - url: https://github.com/xen-project/xen/tree/914fc8e8b4cc003e90d51bee0aef54687358530a
    reference_type: commit
    reference_id: 914fc8e8b4cc003e90d51bee0aef54687358530a
  - url: https://github.com/xen-project/xen/tree/9992c089de1fbb4d3217d2421ca60295998645d7
    reference_type: commit
    reference_id: 9992c089de1fbb4d3217d2421ca60295998645d7
  - url: https://github.com/xen-project/xen/tree/bd87315a603bf25e869e6293f7db7b1024d67999
    reference_type: commit
    reference_id: bd87315a603bf25e869e6293f7db7b1024d67999
  - url: https://github.com/xen-project/xen/tree/c5215044578e88b401a1296ed6302df05c113c5f
    reference_type: commit
    reference_id: c5215044578e88b401a1296ed6302df05c113c5f
  - url: https://github.com/xen-project/xen/tree/cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
    reference_type: commit
    reference_id: cbea5a1149ca7fd4b7cdbfa3ec2e4f109b601ff7
  - url: https://github.com/xen-project/xen/tree/cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
    reference_type: commit
    reference_id: cf2a68d2ffbc3ce95e01449d46180bddb10d24a0
  - url: https://github.com/xen-project/xen/tree/db8fa01c61db0317a9ee947925226234c65d48e8
    reference_type: commit
    reference_id: db8fa01c61db0317a9ee947925226234c65d48e8
  - url: https://github.com/xen-project/xen/tree/e3b66e5cba89fc0b59c9a116e7414388d45e04a0
    reference_type: commit
    reference_id: e3b66e5cba89fc0b59c9a116e7414388d45e04a0
  - url: https://github.com/xen-project/xen/tree/e6b1e3892b685346490eded1f6b6f5392b1020b0
    reference_type: commit
    reference_id: e6b1e3892b685346490eded1f6b6f5392b1020b0
  - url: https://github.com/xen-project/xen/tree/fd688b06a57a327dc5dbda106a104a2af5e1aa2b
    reference_type: commit
    reference_id: fd688b06a57a327dc5dbda106a104a2af5e1aa2b
