advisory_id: CVE-2022-23825
datasource_id: collect_xen_project_fix_commits/CVE-2022-23825
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  f8614c7153f95dcd1a1320156787dbc5325fd946:x86/spec-ctrl: Mitigate Branch Type Confusion when possible

  Branch Type Confusion affects AMD/Hygon CPUs on Zen2 and earlier.  To
  mitigate, we require SMT safety (STIBP on Zen2, no-SMT on Zen1), and to issue
  an IBPB on each entry to Xen, to flush the BTB.

  Due to performance concerns, dom0 (which is trusted in most configurations) is
  excluded from protections by default.

  Therefore:
   * Use STIBP by default on Zen2 too, which now means we want it on by default
     on all hardware supporting STIBP.
   * Break the current IBPB logic out into a new function, extending it with
     IBPB-at-entry logic.
   * Change the existing IBPB-at-ctxt-switch boolean to be tristate, and disable
     it by default when IBPB-at-entry is providing sufficient safety.

  If all PV guests on the system are trusted, then it is recommended to boot
  with `spec-ctrl=ibpb-entry=no-pv`, as this will provide an additional marginal
  perf improvement.

  This is part of XSA-407 / CVE-2022-23825.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit d8cb7e0f069e0f106d24941355b59b45a731eabe)
  87d90d511c87477609cc4b8c88866bfbe997da46:x86/spec-ctrl: Mitigate Branch Type Confusion when possible

  Branch Type Confusion affects AMD/Hygon CPUs on Zen2 and earlier.  To
  mitigate, we require SMT safety (STIBP on Zen2, no-SMT on Zen1), and to issue
  an IBPB on each entry to Xen, to flush the BTB.

  Due to performance concerns, dom0 (which is trusted in most configurations) is
  excluded from protections by default.

  Therefore:
   * Use STIBP by default on Zen2 too, which now means we want it on by default
     on all hardware supporting STIBP.
   * Break the current IBPB logic out into a new function, extending it with
     IBPB-at-entry logic.
   * Change the existing IBPB-at-ctxt-switch boolean to be tristate, and disable
     it by default when IBPB-at-entry is providing sufficient safety.

  If all PV guests on the system are trusted, then it is recommended to boot
  with `spec-ctrl=ibpb-entry=no-pv`, as this will provide an additional marginal
  perf improvement.

  This is part of XSA-407 / CVE-2022-23825.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit d8cb7e0f069e0f106d24941355b59b45a731eabe)
  35bf91d30f1a480dcf5bfd99b79384b2b283da7f:x86/spec-ctrl: Mitigate Branch Type Confusion when possible

  Branch Type Confusion affects AMD/Hygon CPUs on Zen2 and earlier.  To
  mitigate, we require SMT safety (STIBP on Zen2, no-SMT on Zen1), and to issue
  an IBPB on each entry to Xen, to flush the BTB.

  Due to performance concerns, dom0 (which is trusted in most configurations) is
  excluded from protections by default.

  Therefore:
   * Use STIBP by default on Zen2 too, which now means we want it on by default
     on all hardware supporting STIBP.
   * Break the current IBPB logic out into a new function, extending it with
     IBPB-at-entry logic.
   * Change the existing IBPB-at-ctxt-switch boolean to be tristate, and disable
     it by default when IBPB-at-entry is providing sufficient safety.

  If all PV guests on the system are trusted, then it is recommended to boot
  with `spec-ctrl=ibpb-entry=no-pv`, as this will provide an additional marginal
  perf improvement.

  This is part of XSA-407 / CVE-2022-23825.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit d8cb7e0f069e0f106d24941355b59b45a731eabe)
  0a5387a01165b46c8c85e7f7e2ddbe60a7f5db44:x86/spec-ctrl: Mitigate Branch Type Confusion when possible

  Branch Type Confusion affects AMD/Hygon CPUs on Zen2 and earlier.  To
  mitigate, we require SMT safety (STIBP on Zen2, no-SMT on Zen1), and to issue
  an IBPB on each entry to Xen, to flush the BTB.

  Due to performance concerns, dom0 (which is trusted in most configurations) is
  excluded from protections by default.

  Therefore:
   * Use STIBP by default on Zen2 too, which now means we want it on by default
     on all hardware supporting STIBP.
   * Break the current IBPB logic out into a new function, extending it with
     IBPB-at-entry logic.
   * Change the existing IBPB-at-ctxt-switch boolean to be tristate, and disable
     it by default when IBPB-at-entry is providing sufficient safety.

  If all PV guests on the system are trusted, then it is recommended to boot
  with `spec-ctrl=ibpb-entry=no-pv`, as this will provide an additional marginal
  perf improvement.

  This is part of XSA-407 / CVE-2022-23825.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit d8cb7e0f069e0f106d24941355b59b45a731eabe)
  d8cb7e0f069e0f106d24941355b59b45a731eabe:x86/spec-ctrl: Mitigate Branch Type Confusion when possible

  Branch Type Confusion affects AMD/Hygon CPUs on Zen2 and earlier.  To
  mitigate, we require SMT safety (STIBP on Zen2, no-SMT on Zen1), and to issue
  an IBPB on each entry to Xen, to flush the BTB.

  Due to performance concerns, dom0 (which is trusted in most configurations) is
  excluded from protections by default.

  Therefore:
   * Use STIBP by default on Zen2 too, which now means we want it on by default
     on all hardware supporting STIBP.
   * Break the current IBPB logic out into a new function, extending it with
     IBPB-at-entry logic.
   * Change the existing IBPB-at-ctxt-switch boolean to be tristate, and disable
     it by default when IBPB-at-entry is providing sufficient safety.

  If all PV guests on the system are trusted, then it is recommended to boot
  with `spec-ctrl=ibpb-entry=no-pv`, as this will provide an additional marginal
  perf improvement.

  This is part of XSA-407 / CVE-2022-23825.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 35bf91d30f1a480dcf5bfd99b79384b2b283da7f
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 87d90d511c87477609cc4b8c88866bfbe997da46
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d8cb7e0f069e0f106d24941355b59b45a731eabe
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0a5387a01165b46c8c85e7f7e2ddbe60a7f5db44
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: f8614c7153f95dcd1a1320156787dbc5325fd946
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0a5387a01165b46c8c85e7f7e2ddbe60a7f5db44
    reference_type: commit
    reference_id: 0a5387a01165b46c8c85e7f7e2ddbe60a7f5db44
  - url: https://github.com/xen-project/xen/tree/35bf91d30f1a480dcf5bfd99b79384b2b283da7f
    reference_type: commit
    reference_id: 35bf91d30f1a480dcf5bfd99b79384b2b283da7f
  - url: https://github.com/xen-project/xen/tree/87d90d511c87477609cc4b8c88866bfbe997da46
    reference_type: commit
    reference_id: 87d90d511c87477609cc4b8c88866bfbe997da46
  - url: https://github.com/xen-project/xen/tree/d8cb7e0f069e0f106d24941355b59b45a731eabe
    reference_type: commit
    reference_id: d8cb7e0f069e0f106d24941355b59b45a731eabe
  - url: https://github.com/xen-project/xen/tree/f8614c7153f95dcd1a1320156787dbc5325fd946
    reference_type: commit
    reference_id: f8614c7153f95dcd1a1320156787dbc5325fd946
