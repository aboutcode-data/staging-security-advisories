advisory_id: CVE-2023-34326
datasource_id: collect_xen_project_fix_commits/CVE-2023-34326
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  5fc98b97084a46884acef9320e643faf40d42212:iommu/amd-vi: flush IOMMU TLB when flushing the DTE

  The caching invalidation guidelines from the AMD-Vi specification (48882—Rev
  3.07-PUB—Oct 2022) seem to be misleading on some hardware, as devices will
  malfunction (see stale DMA mappings) if some fields of the DTE are updated but
  the IOMMU TLB is not flushed. This has been observed in practice on AMD
  systems.  Due to the lack of guidance from the currently published
  specification this patch aims to increase the flushing done in order to prevent
  device malfunction.

  In order to fix, issue an INVALIDATE_IOMMU_PAGES command from
  amd_iommu_flush_device(), flushing all the address space.  Note this requires
  callers to be adjusted in order to pass the DomID on the DTE previous to the
  modification.

  Some call sites don't provide a valid DomID to amd_iommu_flush_device() in
  order to avoid the flush.  That's because the device had address translations
  disabled and hence the previous DomID on the DTE is not valid.  Note the
  current logic relies on the entity disabling address translations to also flush
  the TLB of the in use DomID.

  Device I/O TLB flushing when ATS are enabled is not covered by the current
  change, as ATS usage is not security supported.

  This is XSA-442 / CVE-2023-34326

  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  1b8dbe48d6ff0b1db1cc641424e9ac1b4402b7b1:iommu/amd-vi: flush IOMMU TLB when flushing the DTE

  The caching invalidation guidelines from the AMD-Vi specification (48882—Rev
  3.07-PUB—Oct 2022) seem to be misleading on some hardware, as devices will
  malfunction (see stale DMA mappings) if some fields of the DTE are updated but
  the IOMMU TLB is not flushed. This has been observed in practice on AMD
  systems.  Due to the lack of guidance from the currently published
  specification this patch aims to increase the flushing done in order to prevent
  device malfunction.

  In order to fix, issue an INVALIDATE_IOMMU_PAGES command from
  amd_iommu_flush_device(), flushing all the address space.  Note this requires
  callers to be adjusted in order to pass the DomID on the DTE previous to the
  modification.

  Some call sites don't provide a valid DomID to amd_iommu_flush_device() in
  order to avoid the flush.  That's because the device had address translations
  disabled and hence the previous DomID on the DTE is not valid.  Note the
  current logic relies on the entity disabling address translations to also flush
  the TLB of the in use DomID.

  Device I/O TLB flushing when ATS are enabled is not covered by the current
  change, as ATS usage is not security supported.

  This is XSA-442 / CVE-2023-34326

  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 5fc98b97084a46884acef9320e643faf40d42212)
  35217b78048e91a0f4d0f14b31a474cc59ec1388:iommu/amd-vi: flush IOMMU TLB when flushing the DTE

  The caching invalidation guidelines from the AMD-Vi specification (48882—Rev
  3.07-PUB—Oct 2022) seem to be misleading on some hardware, as devices will
  malfunction (see stale DMA mappings) if some fields of the DTE are updated but
  the IOMMU TLB is not flushed. This has been observed in practice on AMD
  systems.  Due to the lack of guidance from the currently published
  specification this patch aims to increase the flushing done in order to prevent
  device malfunction.

  In order to fix, issue an INVALIDATE_IOMMU_PAGES command from
  amd_iommu_flush_device(), flushing all the address space.  Note this requires
  callers to be adjusted in order to pass the DomID on the DTE previous to the
  modification.

  Some call sites don't provide a valid DomID to amd_iommu_flush_device() in
  order to avoid the flush.  That's because the device had address translations
  disabled and hence the previous DomID on the DTE is not valid.  Note the
  current logic relies on the entity disabling address translations to also flush
  the TLB of the in use DomID.

  Device I/O TLB flushing when ATS are enabled is not covered by the current
  change, as ATS usage is not security supported.

  This is XSA-442 / CVE-2023-34326

  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 5fc98b97084a46884acef9320e643faf40d42212)
  0d8f9f7f2706e8ad8dfff203173693b631339b86:iommu/amd-vi: flush IOMMU TLB when flushing the DTE

  The caching invalidation guidelines from the AMD-Vi specification (48882—Rev
  3.07-PUB—Oct 2022) seem to be misleading on some hardware, as devices will
  malfunction (see stale DMA mappings) if some fields of the DTE are updated but
  the IOMMU TLB is not flushed. This has been observed in practice on AMD
  systems.  Due to the lack of guidance from the currently published
  specification this patch aims to increase the flushing done in order to prevent
  device malfunction.

  In order to fix, issue an INVALIDATE_IOMMU_PAGES command from
  amd_iommu_flush_device(), flushing all the address space.  Note this requires
  callers to be adjusted in order to pass the DomID on the DTE previous to the
  modification.

  Some call sites don't provide a valid DomID to amd_iommu_flush_device() in
  order to avoid the flush.  That's because the device had address translations
  disabled and hence the previous DomID on the DTE is not valid.  Note the
  current logic relies on the entity disabling address translations to also flush
  the TLB of the in use DomID.

  Device I/O TLB flushing when ATS are enabled is not covered by the current
  change, as ATS usage is not security supported.

  This is XSA-442 / CVE-2023-34326

  Signed-off-by: Roger Pau Monné <roger.pau@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  (cherry picked from commit 5fc98b97084a46884acef9320e643faf40d42212)
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 5fc98b97084a46884acef9320e643faf40d42212
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 1b8dbe48d6ff0b1db1cc641424e9ac1b4402b7b1
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0d8f9f7f2706e8ad8dfff203173693b631339b86
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 35217b78048e91a0f4d0f14b31a474cc59ec1388
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0d8f9f7f2706e8ad8dfff203173693b631339b86
    reference_type: commit
    reference_id: 0d8f9f7f2706e8ad8dfff203173693b631339b86
  - url: https://github.com/xen-project/xen/tree/1b8dbe48d6ff0b1db1cc641424e9ac1b4402b7b1
    reference_type: commit
    reference_id: 1b8dbe48d6ff0b1db1cc641424e9ac1b4402b7b1
  - url: https://github.com/xen-project/xen/tree/35217b78048e91a0f4d0f14b31a474cc59ec1388
    reference_type: commit
    reference_id: 35217b78048e91a0f4d0f14b31a474cc59ec1388
  - url: https://github.com/xen-project/xen/tree/5fc98b97084a46884acef9320e643faf40d42212
    reference_type: commit
    reference_id: 5fc98b97084a46884acef9320e643faf40d42212
