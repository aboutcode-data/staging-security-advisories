advisory_id: CVE-2023-34323
datasource_id: collect_xen_project_fix_commits/CVE-2023-34323
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  0a70ce96deebbe3074708b618bab11cd802491c8:tools/xenstored: domain_entry_fix(): Handle conflicting transaction

  The function domain_entry_fix() will be initially called to check if the
  quota is correct before attempt to commit any nodes. So it would be
  possible that accounting is temporarily negative. This is the case
  in the following sequence:

    1) Create 50 nodes
    2) Start two transactions
    3) Delete all the nodes in each transaction
    4) Commit the two transactions

  Because the first transaction will have succeed and updated the
  accounting, there is no guarantee that 'd->nbentry + num' will still
  be above 0. So the assert() would be triggered.
  The assert() was introduced in dbef1f748289 ("tools/xenstore: simplify
  and fix per domain node accounting") with the assumption that the
  value can't be negative. As this is not true revert to the original
  check but restricted to the path where we don't update. Take the
  opportunity to explain the rationale behind the check.

  This CVE-2023-34323 / XSA-440.

  Fixes: dbef1f748289 ("tools/xenstore: simplify and fix per domain node accounting")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Juergen Gross <jgross@suse.com>
  (cherry picked from commit c4e05c97f57d236040d1da5c1fbf6e3699dc86ea)
  3382512b9f5e0d8cf37709d7cb47389d2ce8e624:tools/xenstored: domain_entry_fix(): Handle conflicting transaction

  The function domain_entry_fix() will be initially called to check if the
  quota is correct before attempt to commit any nodes. So it would be
  possible that accounting is temporarily negative. This is the case
  in the following sequence:

    1) Create 50 nodes
    2) Start two transactions
    3) Delete all the nodes in each transaction
    4) Commit the two transactions

  Because the first transaction will have succeed and updated the
  accounting, there is no guarantee that 'd->nbentry + num' will still
  be above 0. So the assert() would be triggered.
  The assert() was introduced in dbef1f748289 ("tools/xenstore: simplify
  and fix per domain node accounting") with the assumption that the
  value can't be negative. As this is not true revert to the original
  check but restricted to the path where we don't update. Take the
  opportunity to explain the rationale behind the check.

  This CVE-2023-34323 / XSA-440.

  Fixes: dbef1f748289 ("tools/xenstore: simplify and fix per domain node accounting")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Juergen Gross <jgross@suse.com>
  (cherry picked from commit c4e05c97f57d236040d1da5c1fbf6e3699dc86ea)
  c4e05c97f57d236040d1da5c1fbf6e3699dc86ea:tools/xenstored: domain_entry_fix(): Handle conflicting transaction

  The function domain_entry_fix() will be initially called to check if the
  quota is correct before attempt to commit any nodes. So it would be
  possible that accounting is temporarily negative. This is the case
  in the following sequence:

    1) Create 50 nodes
    2) Start two transactions
    3) Delete all the nodes in each transaction
    4) Commit the two transactions

  Because the first transaction will have succeed and updated the
  accounting, there is no guarantee that 'd->nbentry + num' will still
  be above 0. So the assert() would be triggered.
  The assert() was introduced in dbef1f748289 ("tools/xenstore: simplify
  and fix per domain node accounting") with the assumption that the
  value can't be negative. As this is not true revert to the original
  check but restricted to the path where we don't update. Take the
  opportunity to explain the rationale behind the check.

  This CVE-2023-34323 / XSA-440.

  Fixes: dbef1f748289 ("tools/xenstore: simplify and fix per domain node accounting")
  Signed-off-by: Julien Grall <jgrall@amazon.com>
  Reviewed-by: Juergen Gross <jgross@suse.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c4e05c97f57d236040d1da5c1fbf6e3699dc86ea
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0a70ce96deebbe3074708b618bab11cd802491c8
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3382512b9f5e0d8cf37709d7cb47389d2ce8e624
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0a70ce96deebbe3074708b618bab11cd802491c8
    reference_type: commit
    reference_id: 0a70ce96deebbe3074708b618bab11cd802491c8
  - url: https://github.com/xen-project/xen/tree/3382512b9f5e0d8cf37709d7cb47389d2ce8e624
    reference_type: commit
    reference_id: 3382512b9f5e0d8cf37709d7cb47389d2ce8e624
  - url: https://github.com/xen-project/xen/tree/c4e05c97f57d236040d1da5c1fbf6e3699dc86ea
    reference_type: commit
    reference_id: c4e05c97f57d236040d1da5c1fbf6e3699dc86ea
