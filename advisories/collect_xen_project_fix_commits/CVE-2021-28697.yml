advisory_id: CVE-2021-28697
datasource_id: collect_xen_project_fix_commits/CVE-2021-28697
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  3882d451ec15472d8c17e228d6ec760d698fbe10:x86/mm: widen locked region in xenmem_add_to_physmap_one()

  For pages which can be made part of the P2M by the guest, but which can
  also later be de-allocated (grant table v2 status pages being the
  present example), it is imperative that they be mapped at no more than a
  single GFN. We therefore need to make sure that of two parallel
  XENMAPSPACE_grant_table requests for the same status page one completes
  before the second checks at which other GFN the underlying MFN is
  presently mapped.

  Pull ahead the respective get_gfn() and push down the respective
  put_gfn(). This leverages that gfn_lock() really aliases p2m_lock(), but
  the function makes this assumption already anyway: In the
  XENMAPSPACE_gmfn case lock nesting constraints for both involved GFNs
  would otherwise need to be enforced to avoid ABBA deadlocks.

  This is CVE-2021-28697 / XSA-379.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: f147422bf9476fb8161b43e35f5901571ed17c35
  master date: 2021-08-25 14:17:56 +0200
  90ae827632671b3631ed2ded6d57d8445a00c607:x86/mm: widen locked region in xenmem_add_to_physmap_one()

  For pages which can be made part of the P2M by the guest, but which can
  also later be de-allocated (grant table v2 status pages being the
  present example), it is imperative that they be mapped at no more than a
  single GFN. We therefore need to make sure that of two parallel
  XENMAPSPACE_grant_table requests for the same status page one completes
  before the second checks at which other GFN the underlying MFN is
  presently mapped.

  Pull ahead the respective get_gfn() and push down the respective
  put_gfn(). This leverages that gfn_lock() really aliases p2m_lock(), but
  the function makes this assumption already anyway: In the
  XENMAPSPACE_gmfn case lock nesting constraints for both involved GFNs
  would otherwise need to be enforced to avoid ABBA deadlocks.

  This is CVE-2021-28697 / XSA-379.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: f147422bf9476fb8161b43e35f5901571ed17c35
  master date: 2021-08-25 14:17:56 +0200
  53e797c042df61c99cbca6d7e6aecaa568821bb6:x86/mm: widen locked region in xenmem_add_to_physmap_one()

  For pages which can be made part of the P2M by the guest, but which can
  also later be de-allocated (grant table v2 status pages being the
  present example), it is imperative that they be mapped at no more than a
  single GFN. We therefore need to make sure that of two parallel
  XENMAPSPACE_grant_table requests for the same status page one completes
  before the second checks at which other GFN the underlying MFN is
  presently mapped.

  Pull ahead the respective get_gfn() and push down the respective
  put_gfn(). This leverages that gfn_lock() really aliases p2m_lock(), but
  the function makes this assumption already anyway: In the
  XENMAPSPACE_gmfn case lock nesting constraints for both involved GFNs
  would otherwise need to be enforced to avoid ABBA deadlocks.

  This is CVE-2021-28697 / XSA-379.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: f147422bf9476fb8161b43e35f5901571ed17c35
  master date: 2021-08-25 14:17:56 +0200
  98bcd536c24ea35dcaed84cc35ce0f6c938ba9d6:x86/mm: widen locked region in xenmem_add_to_physmap_one()

  For pages which can be made part of the P2M by the guest, but which can
  also later be de-allocated (grant table v2 status pages being the
  present example), it is imperative that they be mapped at no more than a
  single GFN. We therefore need to make sure that of two parallel
  XENMAPSPACE_grant_table requests for the same status page one completes
  before the second checks at which other GFN the underlying MFN is
  presently mapped.

  Pull ahead the respective get_gfn() and push down the respective
  put_gfn(). This leverages that gfn_lock() really aliases p2m_lock(), but
  the function makes this assumption already anyway: In the
  XENMAPSPACE_gmfn case lock nesting constraints for both involved GFNs
  would otherwise need to be enforced to avoid ABBA deadlocks.

  This is CVE-2021-28697 / XSA-379.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: f147422bf9476fb8161b43e35f5901571ed17c35
  master date: 2021-08-25 14:17:56 +0200
  d40287a000ec20252006d92c51a69f14be808fd5:x86/mm: widen locked region in xenmem_add_to_physmap_one()

  For pages which can be made part of the P2M by the guest, but which can
  also later be de-allocated (grant table v2 status pages being the
  present example), it is imperative that they be mapped at no more than a
  single GFN. We therefore need to make sure that of two parallel
  XENMAPSPACE_grant_table requests for the same status page one completes
  before the second checks at which other GFN the underlying MFN is
  presently mapped.

  Pull ahead the respective get_gfn() and push down the respective
  put_gfn(). This leverages that gfn_lock() really aliases p2m_lock(), but
  the function makes this assumption already anyway: In the
  XENMAPSPACE_gmfn case lock nesting constraints for both involved GFNs
  would otherwise need to be enforced to avoid ABBA deadlocks.

  This is CVE-2021-28697 / XSA-379.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
  master commit: f147422bf9476fb8161b43e35f5901571ed17c35
  master date: 2021-08-25 14:17:56 +0200
  f147422bf9476fb8161b43e35f5901571ed17c35:x86/mm: widen locked region in xenmem_add_to_physmap_one()

  For pages which can be made part of the P2M by the guest, but which can
  also later be de-allocated (grant table v2 status pages being the
  present example), it is imperative that they be mapped at no more than a
  single GFN. We therefore need to make sure that of two parallel
  XENMAPSPACE_grant_table requests for the same status page one completes
  before the second checks at which other GFN the underlying MFN is
  presently mapped.

  Pull ahead the respective get_gfn() and push down the respective
  put_gfn(). This leverages that gfn_lock() really aliases p2m_lock(), but
  the function makes this assumption already anyway: In the
  XENMAPSPACE_gmfn case lock nesting constraints for both involved GFNs
  would otherwise need to be enforced to avoid ABBA deadlocks.

  This is CVE-2021-28697 / XSA-379.

  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Julien Grall <jgrall@amazon.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 53e797c042df61c99cbca6d7e6aecaa568821bb6
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: d40287a000ec20252006d92c51a69f14be808fd5
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 98bcd536c24ea35dcaed84cc35ce0f6c938ba9d6
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 90ae827632671b3631ed2ded6d57d8445a00c607
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 3882d451ec15472d8c17e228d6ec760d698fbe10
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: f147422bf9476fb8161b43e35f5901571ed17c35
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/3882d451ec15472d8c17e228d6ec760d698fbe10
    reference_type: commit
    reference_id: 3882d451ec15472d8c17e228d6ec760d698fbe10
  - url: https://github.com/xen-project/xen/tree/53e797c042df61c99cbca6d7e6aecaa568821bb6
    reference_type: commit
    reference_id: 53e797c042df61c99cbca6d7e6aecaa568821bb6
  - url: https://github.com/xen-project/xen/tree/90ae827632671b3631ed2ded6d57d8445a00c607
    reference_type: commit
    reference_id: 90ae827632671b3631ed2ded6d57d8445a00c607
  - url: https://github.com/xen-project/xen/tree/98bcd536c24ea35dcaed84cc35ce0f6c938ba9d6
    reference_type: commit
    reference_id: 98bcd536c24ea35dcaed84cc35ce0f6c938ba9d6
  - url: https://github.com/xen-project/xen/tree/d40287a000ec20252006d92c51a69f14be808fd5
    reference_type: commit
    reference_id: d40287a000ec20252006d92c51a69f14be808fd5
  - url: https://github.com/xen-project/xen/tree/f147422bf9476fb8161b43e35f5901571ed17c35
    reference_type: commit
    reference_id: f147422bf9476fb8161b43e35f5901571ed17c35
