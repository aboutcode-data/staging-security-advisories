advisory_id: CVE-2016-2271
datasource_id: collect_xen_project_fix_commits/CVE-2016-2271
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  c0616ae33907321c2ede9b56d4b462a4f3636f7f:x86/VMX: sanitize rIP before re-entering guest

  ... to prevent guest user mode arranging for a guest crash (due to
  failed VM entry). (On the AMD system I checked, hardware is doing
  exactly the canonicalization being added here.)

  Note that fixing this in an architecturally correct way would be quite
  a bit more involved: Making the x86 instruction emulator check all
  branch targets for validity, plus dealing with invalid rIP resulting
  from update_guest_eip() or incoming directly during a VM exit. The only
  way to get the latter right would be by not having hardware do the
  injection.

  Note further that there are a two early returns from
  vmx_vmexit_handler(): One (through vmx_failed_vmentry()) leads to
  domain_crash() anyway, and the other covers real mode only and can
  neither occur with a non-canonical rIP nor result in an altered rIP,
  so we don't need to force those paths through the checking logic.

  This is CVE-2016-2271 / XSA-170.

  Reported-by: 刘令 <liuling-it@360.cn>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Tested-by: Andrew Cooper <andrew.cooper3@citrix.com>
  master commit: ffbbfda37782a2408953af1a3e00ada80bb141bc
  master date: 2016-02-17 16:18:08 +0100
  46b8f780d307b37c38c5a104972c3595724395c5:x86/VMX: sanitize rIP before re-entering guest

  ... to prevent guest user mode arranging for a guest crash (due to
  failed VM entry). (On the AMD system I checked, hardware is doing
  exactly the canonicalization being added here.)

  Note that fixing this in an architecturally correct way would be quite
  a bit more involved: Making the x86 instruction emulator check all
  branch targets for validity, plus dealing with invalid rIP resulting
  from update_guest_eip() or incoming directly during a VM exit. The only
  way to get the latter right would be by not having hardware do the
  injection.

  Note further that there are a two early returns from
  vmx_vmexit_handler(): One (through vmx_failed_vmentry()) leads to
  domain_crash() anyway, and the other covers real mode only and can
  neither occur with a non-canonical rIP nor result in an altered rIP,
  so we don't need to force those paths through the checking logic.

  This is CVE-2016-2271 / XSA-170.

  Reported-by: 刘令 <liuling-it@360.cn>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Tested-by: Andrew Cooper <andrew.cooper3@citrix.com>
  master commit: ffbbfda37782a2408953af1a3e00ada80bb141bc
  master date: 2016-02-17 16:18:08 +0100
  30b0e11898e2c2c67c64bd1ec48f88de8125d678:x86/VMX: sanitize rIP before re-entering guest

  ... to prevent guest user mode arranging for a guest crash (due to
  failed VM entry). (On the AMD system I checked, hardware is doing
  exactly the canonicalization being added here.)

  Note that fixing this in an architecturally correct way would be quite
  a bit more involved: Making the x86 instruction emulator check all
  branch targets for validity, plus dealing with invalid rIP resulting
  from update_guest_eip() or incoming directly during a VM exit. The only
  way to get the latter right would be by not having hardware do the
  injection.

  Note further that there are a two early returns from
  vmx_vmexit_handler(): One (through vmx_failed_vmentry()) leads to
  domain_crash() anyway, and the other covers real mode only and can
  neither occur with a non-canonical rIP nor result in an altered rIP,
  so we don't need to force those paths through the checking logic.

  This is CVE-2016-2271 / XSA-170.

  Reported-by: 刘令 <liuling-it@360.cn>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Tested-by: Andrew Cooper <andrew.cooper3@citrix.com>
  master commit: ffbbfda37782a2408953af1a3e00ada80bb141bc
  master date: 2016-02-17 16:18:08 +0100
  f7bb277a2415010ae238e96ae29069167ba5679b:x86/VMX: sanitize rIP before re-entering guest

  ... to prevent guest user mode arranging for a guest crash (due to
  failed VM entry). (On the AMD system I checked, hardware is doing
  exactly the canonicalization being added here.)

  Note that fixing this in an architecturally correct way would be quite
  a bit more involved: Making the x86 instruction emulator check all
  branch targets for validity, plus dealing with invalid rIP resulting
  from update_guest_eip() or incoming directly during a VM exit. The only
  way to get the latter right would be by not having hardware do the
  injection.

  Note further that there are a two early returns from
  vmx_vmexit_handler(): One (through vmx_failed_vmentry()) leads to
  domain_crash() anyway, and the other covers real mode only and can
  neither occur with a non-canonical rIP nor result in an altered rIP,
  so we don't need to force those paths through the checking logic.

  This is CVE-2016-2271 / XSA-170.

  Reported-by: 刘令 <liuling-it@360.cn>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Tested-by: Andrew Cooper <andrew.cooper3@citrix.com>
  master commit: ffbbfda37782a2408953af1a3e00ada80bb141bc
  master date: 2016-02-17 16:18:08 +0100
  ffbbfda37782a2408953af1a3e00ada80bb141bc:x86/VMX: sanitize rIP before re-entering guest

  ... to prevent guest user mode arranging for a guest crash (due to
  failed VM entry). (On the AMD system I checked, hardware is doing
  exactly the canonicalization being added here.)

  Note that fixing this in an architecturally correct way would be quite
  a bit more involved: Making the x86 instruction emulator check all
  branch targets for validity, plus dealing with invalid rIP resulting
  from update_guest_eip() or incoming directly during a VM exit. The only
  way to get the latter right would be by not having hardware do the
  injection.

  Note further that there are a two early returns from
  vmx_vmexit_handler(): One (through vmx_failed_vmentry()) leads to
  domain_crash() anyway, and the other covers real mode only and can
  neither occur with a non-canonical rIP nor result in an altered rIP,
  so we don't need to force those paths through the checking logic.

  This is CVE-2016-2271 / XSA-170.

  Reported-by: 刘令 <liuling-it@360.cn>
  Signed-off-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Tested-by: Andrew Cooper <andrew.cooper3@citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c0616ae33907321c2ede9b56d4b462a4f3636f7f
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: f7bb277a2415010ae238e96ae29069167ba5679b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 46b8f780d307b37c38c5a104972c3595724395c5
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ffbbfda37782a2408953af1a3e00ada80bb141bc
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 30b0e11898e2c2c67c64bd1ec48f88de8125d678
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/30b0e11898e2c2c67c64bd1ec48f88de8125d678
    reference_type: commit
    reference_id: 30b0e11898e2c2c67c64bd1ec48f88de8125d678
  - url: https://github.com/xen-project/xen/tree/46b8f780d307b37c38c5a104972c3595724395c5
    reference_type: commit
    reference_id: 46b8f780d307b37c38c5a104972c3595724395c5
  - url: https://github.com/xen-project/xen/tree/c0616ae33907321c2ede9b56d4b462a4f3636f7f
    reference_type: commit
    reference_id: c0616ae33907321c2ede9b56d4b462a4f3636f7f
  - url: https://github.com/xen-project/xen/tree/f7bb277a2415010ae238e96ae29069167ba5679b
    reference_type: commit
    reference_id: f7bb277a2415010ae238e96ae29069167ba5679b
  - url: https://github.com/xen-project/xen/tree/ffbbfda37782a2408953af1a3e00ada80bb141bc
    reference_type: commit
    reference_id: ffbbfda37782a2408953af1a3e00ada80bb141bc
