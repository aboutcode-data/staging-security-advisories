advisory_id: CVE-2022-21166
datasource_id: collect_xen_project_fix_commits/CVE-2022-21166
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  a84bc5bde583ffe1b9b697a4b1d2006c5614afff:x86/spec-ctrl: Make VERW flushing runtime conditional

  Currently, VERW flushing to mitigate MDS is boot time conditional per domain
  type.  However, to provide mitigations for DRPW (CVE-2022-21166), we need to
  conditionally use VERW based on the trustworthiness of the guest, and the
  devices passed through.

  Remove the PV/HVM alternatives and instead issue a VERW on the return-to-guest
  path depending on the SCF_verw bit in cpuinfo spec_ctrl_flags.

  Introduce spec_ctrl_init_domain() and d->arch.verw to calculate the VERW
  disposition at domain creation time, and context switch the SCF_verw bit.

  For now, VERW flushing is used and controlled exactly as before, but later
  patches will add per-domain cases too.

  No change in behaviour.

  This is part of XSA-404.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit e06b95c1d44ab80da255219fc9f1e2fc423edcb6)
  878e684e154cc0d54ad649aaef2699cd71ee5501:x86/spec-ctrl: Make VERW flushing runtime conditional

  Currently, VERW flushing to mitigate MDS is boot time conditional per domain
  type.  However, to provide mitigations for DRPW (CVE-2022-21166), we need to
  conditionally use VERW based on the trustworthiness of the guest, and the
  devices passed through.

  Remove the PV/HVM alternatives and instead issue a VERW on the return-to-guest
  path depending on the SCF_verw bit in cpuinfo spec_ctrl_flags.

  Introduce spec_ctrl_init_domain() and d->arch.verw to calculate the VERW
  disposition at domain creation time, and context switch the SCF_verw bit.

  For now, VERW flushing is used and controlled exactly as before, but later
  patches will add per-domain cases too.

  No change in behaviour.

  This is part of XSA-404.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit e06b95c1d44ab80da255219fc9f1e2fc423edcb6)
  1a377949cee5f13c18fa3d0e1a6c51404f223a9a:x86/spec-ctrl: Make VERW flushing runtime conditional

  Currently, VERW flushing to mitigate MDS is boot time conditional per domain
  type.  However, to provide mitigations for DRPW (CVE-2022-21166), we need to
  conditionally use VERW based on the trustworthiness of the guest, and the
  devices passed through.

  Remove the PV/HVM alternatives and instead issue a VERW on the return-to-guest
  path depending on the SCF_verw bit in cpuinfo spec_ctrl_flags.

  Introduce spec_ctrl_init_domain() and d->arch.verw to calculate the VERW
  disposition at domain creation time, and context switch the SCF_verw bit.

  For now, VERW flushing is used and controlled exactly as before, but later
  patches will add per-domain cases too.

  No change in behaviour.

  This is part of XSA-404.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit e06b95c1d44ab80da255219fc9f1e2fc423edcb6)
  0e80f9f61168d4e4f008da75762cee0118f802ed:x86/spec-ctrl: Make VERW flushing runtime conditional

  Currently, VERW flushing to mitigate MDS is boot time conditional per domain
  type.  However, to provide mitigations for DRPW (CVE-2022-21166), we need to
  conditionally use VERW based on the trustworthiness of the guest, and the
  devices passed through.

  Remove the PV/HVM alternatives and instead issue a VERW on the return-to-guest
  path depending on the SCF_verw bit in cpuinfo spec_ctrl_flags.

  Introduce spec_ctrl_init_domain() and d->arch.verw to calculate the VERW
  disposition at domain creation time, and context switch the SCF_verw bit.

  For now, VERW flushing is used and controlled exactly as before, but later
  patches will add per-domain cases too.

  No change in behaviour.

  This is part of XSA-404.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit e06b95c1d44ab80da255219fc9f1e2fc423edcb6)
  e06b95c1d44ab80da255219fc9f1e2fc423edcb6:x86/spec-ctrl: Make VERW flushing runtime conditional

  Currently, VERW flushing to mitigate MDS is boot time conditional per domain
  type.  However, to provide mitigations for DRPW (CVE-2022-21166), we need to
  conditionally use VERW based on the trustworthiness of the guest, and the
  devices passed through.

  Remove the PV/HVM alternatives and instead issue a VERW on the return-to-guest
  path depending on the SCF_verw bit in cpuinfo spec_ctrl_flags.

  Introduce spec_ctrl_init_domain() and d->arch.verw to calculate the VERW
  disposition at domain creation time, and context switch the SCF_verw bit.

  For now, VERW flushing is used and controlled exactly as before, but later
  patches will add per-domain cases too.

  No change in behaviour.

  This is part of XSA-404.

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0e80f9f61168d4e4f008da75762cee0118f802ed
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 878e684e154cc0d54ad649aaef2699cd71ee5501
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 1a377949cee5f13c18fa3d0e1a6c51404f223a9a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a84bc5bde583ffe1b9b697a4b1d2006c5614afff
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e06b95c1d44ab80da255219fc9f1e2fc423edcb6
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0e80f9f61168d4e4f008da75762cee0118f802ed
    reference_type: commit
    reference_id: 0e80f9f61168d4e4f008da75762cee0118f802ed
  - url: https://github.com/xen-project/xen/tree/1a377949cee5f13c18fa3d0e1a6c51404f223a9a
    reference_type: commit
    reference_id: 1a377949cee5f13c18fa3d0e1a6c51404f223a9a
  - url: https://github.com/xen-project/xen/tree/878e684e154cc0d54ad649aaef2699cd71ee5501
    reference_type: commit
    reference_id: 878e684e154cc0d54ad649aaef2699cd71ee5501
  - url: https://github.com/xen-project/xen/tree/a84bc5bde583ffe1b9b697a4b1d2006c5614afff
    reference_type: commit
    reference_id: a84bc5bde583ffe1b9b697a4b1d2006c5614afff
  - url: https://github.com/xen-project/xen/tree/e06b95c1d44ab80da255219fc9f1e2fc423edcb6
    reference_type: commit
    reference_id: e06b95c1d44ab80da255219fc9f1e2fc423edcb6
