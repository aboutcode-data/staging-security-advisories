advisory_id: CVE-2023-20569
datasource_id: collect_xen_project_fix_commits/CVE-2023-20569
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  2bd25cef5949ee472a6f48a91148499ea81140a2:x86/spec-ctrl: Mitigate Speculative Return Stack Overflow

  On native, synthesise the SRSO bits by probing various hardware properties as
  given by AMD.

  Extend the IBPB-on-entry mitigations to Zen3/4 CPUs.  There is a microcode
  prerequisite to make this an effective mitigation.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 220c06e6fefe2378f40e2a7391f5e265a2aa50f7)
  498945c4670a8fe76c03ccf568cb2057f22b36ac:x86/spec-ctrl: Enumerations for Speculative Return Stack Overflow

  AMD have specified new CPUID bits relating to SRSO.

   * SRSO_NO indicates that hardware is no longer vulnerable to SRSO.
   * IBPB_BRTYPE indicates that IBPB flushes branch type information too.
   * SBPB indicates support for a relaxed form of IBPB that does not flush
     branch type information.

  Current CPUs (Zen4 and older) are not expected to enumerate these bits.
  Native software is expected to synthesise them for guests using model and
  microcode revision checks.

  Two are just status bits, and SBPB is trivial to support for guests by
  tweaking the reserved bit calculation in guest_wrmsr() and feature
  dependencies.  Expose all by default to guests, so they start showing up when
  Xen synthesises them.

  While adding feature dependenies for IBPB, fix up an overlooked issue from
  XSA-422.  It's inappropriate to advertise that IBPB flushes RET predictions if
  IBPB is unavailable itself.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe)
  b274f6878b6199c35968b39be2afa1de62763f5b:x86/spec-ctrl: Rework ibpb_calculations()

  ... in order to make the SRSO mitigations easier to integrate.

   * Check for AMD/Hygon CPUs directly, rather than assuming based on IBPB.
     In particular, Xen supports synthesising the IBPB bit to guests on Intel to
     allow IBPB while dissuading the use of (legacy) IBRS.
   * Collect def_ibpb_entry rather than opencoding the BTC_NO calculation for
     both opt_ibpb_entry_{pv,hvm}.

  No functional change.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 292f68fb77196a35ac92b296792770d0f3190d75)
  24b37f953867b6d11ad1715e4b2a393ba691aacd:x86/spec-ctrl: Mitigate Speculative Return Stack Overflow

  On native, synthesise the SRSO bits by probing various hardware properties as
  given by AMD.

  Extend the IBPB-on-entry mitigations to Zen3/4 CPUs.  There is a microcode
  prerequisite to make this an effective mitigation.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 220c06e6fefe2378f40e2a7391f5e265a2aa50f7)
  ecb2a3cea9c75e1ddeb9793b3032c2409b7df0c7:x86/spec-ctrl: Enumerations for Speculative Return Stack Overflow

  AMD have specified new CPUID bits relating to SRSO.

   * SRSO_NO indicates that hardware is no longer vulnerable to SRSO.
   * IBPB_BRTYPE indicates that IBPB flushes branch type information too.
   * SBPB indicates support for a relaxed form of IBPB that does not flush
     branch type information.

  Current CPUs (Zen4 and older) are not expected to enumerate these bits.
  Native software is expected to synthesise them for guests using model and
  microcode revision checks.

  Two are just status bits, and SBPB is trivial to support for guests by
  tweaking the reserved bit calculation in guest_wrmsr() and feature
  dependencies.  Expose all by default to guests, so they start showing up when
  Xen synthesises them.

  While adding feature dependenies for IBPB, fix up an overlooked issue from
  XSA-422.  It's inappropriate to advertise that IBPB flushes RET predictions if
  IBPB is unavailable itself.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe)
  c35a2dcd3892526f73afd58f36290fce4764c363:x86/spec-ctrl: Rework ibpb_calculations()

  ... in order to make the SRSO mitigations easier to integrate.

   * Check for AMD/Hygon CPUs directly, rather than assuming based on IBPB.
     In particular, Xen supports synthesising the IBPB bit to guests on Intel to
     allow IBPB while dissuading the use of (legacy) IBRS.
   * Collect def_ibpb_entry rather than opencoding the BTC_NO calculation for
     both opt_ibpb_entry_{pv,hvm}.

  No functional change.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 292f68fb77196a35ac92b296792770d0f3190d75)
  220c06e6fefe2378f40e2a7391f5e265a2aa50f7:x86/spec-ctrl: Mitigate Speculative Return Stack Overflow

  On native, synthesise the SRSO bits by probing various hardware properties as
  given by AMD.

  Extend the IBPB-on-entry mitigations to Zen3/4 CPUs.  There is a microcode
  prerequisite to make this an effective mitigation.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe:x86/spec-ctrl: Enumerations for Speculative Return Stack Overflow

  AMD have specified new CPUID bits relating to SRSO.

   * SRSO_NO indicates that hardware is no longer vulnerable to SRSO.
   * IBPB_BRTYPE indicates that IBPB flushes branch type information too.
   * SBPB indicates support for a relaxed form of IBPB that does not flush
     branch type information.

  Current CPUs (Zen4 and older) are not expected to enumerate these bits.
  Native software is expected to synthesise them for guests using model and
  microcode revision checks.

  Two are just status bits, and SBPB is trivial to support for guests by
  tweaking the reserved bit calculation in guest_wrmsr() and feature
  dependencies.  Expose all by default to guests, so they start showing up when
  Xen synthesises them.

  While adding feature dependenies for IBPB, fix up an overlooked issue from
  XSA-422.  It's inappropriate to advertise that IBPB flushes RET predictions if
  IBPB is unavailable itself.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  292f68fb77196a35ac92b296792770d0f3190d75:x86/spec-ctrl: Rework ibpb_calculations()

  ... in order to make the SRSO mitigations easier to integrate.

   * Check for AMD/Hygon CPUs directly, rather than assuming based on IBPB.
     In particular, Xen supports synthesising the IBPB bit to guests on Intel to
     allow IBPB while dissuading the use of (legacy) IBRS.
   * Collect def_ibpb_entry rather than opencoding the BTC_NO calculation for
     both opt_ibpb_entry_{pv,hvm}.

  No functional change.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  e8db771a17c96f3a393ad7929c1c35e17e39972a:x86/spec-ctrl: Mitigate Speculative Return Stack Overflow

  On native, synthesise the SRSO bits by probing various hardware properties as
  given by AMD.

  Extend the IBPB-on-entry mitigations to Zen3/4 CPUs.  There is a microcode
  prerequisite to make this an effective mitigation.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 220c06e6fefe2378f40e2a7391f5e265a2aa50f7)
  6a2df62a986739561df37912ac2b6474b5162da3:x86/spec-ctrl: Enumerations for Speculative Return Stack Overflow

  AMD have specified new CPUID bits relating to SRSO.

   * SRSO_NO indicates that hardware is no longer vulnerable to SRSO.
   * IBPB_BRTYPE indicates that IBPB flushes branch type information too.
   * SBPB indicates support for a relaxed form of IBPB that does not flush
     branch type information.

  Current CPUs (Zen4 and older) are not expected to enumerate these bits.
  Native software is expected to synthesise them for guests using model and
  microcode revision checks.

  Two are just status bits, and SBPB is trivial to support for guests by
  tweaking the reserved bit calculation in guest_wrmsr() and feature
  dependencies.  Expose all by default to guests, so they start showing up when
  Xen synthesises them.

  While adding feature dependenies for IBPB, fix up an overlooked issue from
  XSA-422.  It's inappropriate to advertise that IBPB flushes RET predictions if
  IBPB is unavailable itself.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe)
  0ac679428a034b54da52da5bc4c43788e679613a:x86/spec-ctrl: Rework ibpb_calculations()

  ... in order to make the SRSO mitigations easier to integrate.

   * Check for AMD/Hygon CPUs directly, rather than assuming based on IBPB.
     In particular, Xen supports synthesising the IBPB bit to guests on Intel to
     allow IBPB while dissuading the use of (legacy) IBRS.
   * Collect def_ibpb_entry rather than opencoding the BTC_NO calculation for
     both opt_ibpb_entry_{pv,hvm}.

  No functional change.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 292f68fb77196a35ac92b296792770d0f3190d75)
  b066b60cf04fe979a6dfd830f5b25d1e3aece5c5:x86/spec-ctrl: Mitigate Speculative Return Stack Overflow

  On native, synthesise the SRSO bits by probing various hardware properties as
  given by AMD.

  Extend the IBPB-on-entry mitigations to Zen3/4 CPUs.  There is a microcode
  prerequisite to make this an effective mitigation.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 220c06e6fefe2378f40e2a7391f5e265a2aa50f7)
  30de2397d2d93e0c01137e9a72a7a1f291004565:x86/spec-ctrl: Enumerations for Speculative Return Stack Overflow

  AMD have specified new CPUID bits relating to SRSO.

   * SRSO_NO indicates that hardware is no longer vulnerable to SRSO.
   * IBPB_BRTYPE indicates that IBPB flushes branch type information too.
   * SBPB indicates support for a relaxed form of IBPB that does not flush
     branch type information.

  Current CPUs (Zen4 and older) are not expected to enumerate these bits.
  Native software is expected to synthesise them for guests using model and
  microcode revision checks.

  Two are just status bits, and SBPB is trivial to support for guests by
  tweaking the reserved bit calculation in guest_wrmsr() and feature
  dependencies.  Expose all by default to guests, so they start showing up when
  Xen synthesises them.

  While adding feature dependenies for IBPB, fix up an overlooked issue from
  XSA-422.  It's inappropriate to advertise that IBPB flushes RET predictions if
  IBPB is unavailable itself.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe)
  42105f5435035cd76572cbaea8e94bed4c74dec1:x86/spec-ctrl: Rework ibpb_calculations()

  ... in order to make the SRSO mitigations easier to integrate.

   * Check for AMD/Hygon CPUs directly, rather than assuming based on IBPB.
     In particular, Xen supports synthesising the IBPB bit to guests on Intel to
     allow IBPB while dissuading the use of (legacy) IBRS.
   * Collect def_ibpb_entry rather than opencoding the BTC_NO calculation for
     both opt_ibpb_entry_{pv,hvm}.

  No functional change.

  This is part of XSA-434 / CVE-2023-20569

  Signed-off-by: Andrew Cooper <andrew.cooper3@citrix.com>
  Reviewed-by: Jan Beulich <jbeulich@suse.com>
  Reviewed-by: Roger Pau Monné <roger.pau@citrix.com>
  (cherry picked from commit 292f68fb77196a35ac92b296792770d0f3190d75)
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: b274f6878b6199c35968b39be2afa1de62763f5b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: c35a2dcd3892526f73afd58f36290fce4764c363
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: e8db771a17c96f3a393ad7929c1c35e17e39972a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 220c06e6fefe2378f40e2a7391f5e265a2aa50f7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 42105f5435035cd76572cbaea8e94bed4c74dec1
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 2bd25cef5949ee472a6f48a91148499ea81140a2
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: ecb2a3cea9c75e1ddeb9793b3032c2409b7df0c7
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 0ac679428a034b54da52da5bc4c43788e679613a
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 6a2df62a986739561df37912ac2b6474b5162da3
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: b066b60cf04fe979a6dfd830f5b25d1e3aece5c5
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 292f68fb77196a35ac92b296792770d0f3190d75
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 24b37f953867b6d11ad1715e4b2a393ba691aacd
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 498945c4670a8fe76c03ccf568cb2057f22b36ac
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 30de2397d2d93e0c01137e9a72a7a1f291004565
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/0ac679428a034b54da52da5bc4c43788e679613a
    reference_type: commit
    reference_id: 0ac679428a034b54da52da5bc4c43788e679613a
  - url: https://github.com/xen-project/xen/tree/220c06e6fefe2378f40e2a7391f5e265a2aa50f7
    reference_type: commit
    reference_id: 220c06e6fefe2378f40e2a7391f5e265a2aa50f7
  - url: https://github.com/xen-project/xen/tree/2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe
    reference_type: commit
    reference_id: 2280b0ee2aed6e0fd4af3fa31bf99bc04d038bfe
  - url: https://github.com/xen-project/xen/tree/24b37f953867b6d11ad1715e4b2a393ba691aacd
    reference_type: commit
    reference_id: 24b37f953867b6d11ad1715e4b2a393ba691aacd
  - url: https://github.com/xen-project/xen/tree/292f68fb77196a35ac92b296792770d0f3190d75
    reference_type: commit
    reference_id: 292f68fb77196a35ac92b296792770d0f3190d75
  - url: https://github.com/xen-project/xen/tree/2bd25cef5949ee472a6f48a91148499ea81140a2
    reference_type: commit
    reference_id: 2bd25cef5949ee472a6f48a91148499ea81140a2
  - url: https://github.com/xen-project/xen/tree/30de2397d2d93e0c01137e9a72a7a1f291004565
    reference_type: commit
    reference_id: 30de2397d2d93e0c01137e9a72a7a1f291004565
  - url: https://github.com/xen-project/xen/tree/42105f5435035cd76572cbaea8e94bed4c74dec1
    reference_type: commit
    reference_id: 42105f5435035cd76572cbaea8e94bed4c74dec1
  - url: https://github.com/xen-project/xen/tree/498945c4670a8fe76c03ccf568cb2057f22b36ac
    reference_type: commit
    reference_id: 498945c4670a8fe76c03ccf568cb2057f22b36ac
  - url: https://github.com/xen-project/xen/tree/6a2df62a986739561df37912ac2b6474b5162da3
    reference_type: commit
    reference_id: 6a2df62a986739561df37912ac2b6474b5162da3
  - url: https://github.com/xen-project/xen/tree/b066b60cf04fe979a6dfd830f5b25d1e3aece5c5
    reference_type: commit
    reference_id: b066b60cf04fe979a6dfd830f5b25d1e3aece5c5
  - url: https://github.com/xen-project/xen/tree/b274f6878b6199c35968b39be2afa1de62763f5b
    reference_type: commit
    reference_id: b274f6878b6199c35968b39be2afa1de62763f5b
  - url: https://github.com/xen-project/xen/tree/c35a2dcd3892526f73afd58f36290fce4764c363
    reference_type: commit
    reference_id: c35a2dcd3892526f73afd58f36290fce4764c363
  - url: https://github.com/xen-project/xen/tree/e8db771a17c96f3a393ad7929c1c35e17e39972a
    reference_type: commit
    reference_id: e8db771a17c96f3a393ad7929c1c35e17e39972a
  - url: https://github.com/xen-project/xen/tree/ecb2a3cea9c75e1ddeb9793b3032c2409b7df0c7
    reference_type: commit
    reference_id: ecb2a3cea9c75e1ddeb9793b3032c2409b7df0c7
