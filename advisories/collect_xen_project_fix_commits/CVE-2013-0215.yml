advisory_id: CVE-2013-0215
datasource_id: collect_xen_project_fix_commits/CVE-2013-0215
datasource_url: https://github.com/xen-project/xen
aliases: []
summary: |
  cfc4249c0df095811142e338bcc1291d8b6cba29:tools/ocaml: oxenstored: correctly handle a full ring.

  Change 26521:2c0fd406f02c (part of XSA-38 / CVE-2013-0215) incorrectly
  caused us to ignore rather than process a completely full ring. Check if
  producer and consumer are equal before masking to avoid this, since prod ==
  cons + PAGE_SIZE after masking becomes prod == cons.

  Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
  Acked-by: Keir Fraser <keir@xen.org>
  Committed-by: Ian Campbell <ian.campbell@citrix.com>

  xen-unstable changeset: 26539:759574df84a6
  Backport-requested-by: security@xen.org
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
  762349de68bcb832b8b6fb5357b837789506f242:tools/ocaml: oxenstored: correctly handle a full ring.

  Change 26521:2c0fd406f02c (part of XSA-38 / CVE-2013-0215) incorrectly
  caused us to ignore rather than process a completely full ring. Check if
  producer and consumer are equal before masking to avoid this, since prod ==
  cons + PAGE_SIZE after masking becomes prod == cons.

  Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
  Acked-by: Keir Fraser <keir@xen.org>
  Committed-by: Ian Campbell <ian.campbell@citrix.com>

  xen-unstable changeset: 26539:759574df84a6
  Backport-requested-by: security@xen.org
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
  eeddfad1b339dcaa787230f519a19de1cbc22ad8:tools/ocaml: oxenstored: correctly handle a full ring.

  Change 26521:2c0fd406f02c (part of XSA-38 / CVE-2013-0215) incorrectly
  caused us to ignore rather than process a completely full ring. Check if
  producer and consumer are equal before masking to avoid this, since prod ==
  cons + PAGE_SIZE after masking becomes prod == cons.

  Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
  Acked-by: Keir Fraser <keir@xen.org>
  Committed-by: Ian Campbell <ian.campbell@citrix.com>
  4d249d79db70dc2756f6c102e2ddaeee14d7ac42:oxenstored: Enforce a maximum message size of 4096 bytes

  The maximum size of a message is part of the protocol spec in
    xen/include/public/io/xs_wire.h

  Before this patch a client which sends an overly large message can
  cause a buffer read overrun.

  Note if a badly-behaved client sends a very large message
  then it will be difficult for them to make their connection
  work again-- they will probably need to reboot.

  This is a security issue, part of XSA-38 / CVE-2013-0215.

  Signed-off-by: David Scott <dave.scott@eu.citrix.com>
  Acked-by: Ian Campbell <Ian.Campbell@citrix.com>
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>

  xen-unstable changeset: 26522:ffd30e7388ad
  Backport-requested-by: security@xen.org
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
  a69bad54a915d039e3e571304d096898bd51e0ac:tools/ocaml: oxenstored: Be more paranoid about ring reading

  oxenstored makes use of the OCaml Xenbus bindings, in which the
  function xs_ring_read in tools/ocaml/libs/xb/xs_ring_stubs.c is used
  to read from the shared memory Xenstore ring.

  This function does not correctly handle all possible (prod, cons)
  states when MASK_XENSTORE_IDX(prod) > MASK_XENSTORE_IDX(cons).

  The root cause is the use of the unmasked values of prod and cons to
  calculate to_read.  If prod is set to an out-of-range value, the ring
  peer can cause to_read to be too large or even negative.  This allows
  the ring peer to force oxenstored to read and write out of range for
  the buffers leading to a crash or possibly to privilege escalation.

  Correct this by masking the values of cons and prod at the start, so
  we only deal with masked values.  This makes the logic simpler, as
  semantically inappropriate values of the upper bits of the ring
  pointers are simply ignored.

  The same vulnerability does not exist in the ring writer because the
  only use made of the unmasked value is the check which prevents the
  prod pointer overtaking the cons pointer.  A ring peer which defeats
  this check will suffer only lost data.


  However, additionally, precautions need to be taken to ensure that
  req_cons and req_prod are only read once in each function.  Without
  the use of volatile or some asm construct, the compiler can "prove"
  that req_cons and req_prod do not change unexpectedly and is permitted
  to "amplify" the read of (say) req_cons into two reads at different
  times, giving two different values for use as cons, and then use the
  two sources of cons interchangeably.  (The use of xen_mb() does not
  forbid this.)

  Therefore do the reads of req_cons and req_prod through a volatile
  pointer in both xs_ring_read and xs_ring_write.

  This is currently believed to be a theoretical vulnerability as we are
  not aware of any compilers which amplify reads in this way.


  This is a security issue, part of XSA-38 / CVE-2013-0215.


  Signed-off-by: Ian Jackson <ian.jackson@eu.citrix.com>
  Tested-by: Matthew Daley <mattjd@gmail.com>
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>

  xen-unstable changeset: 26521:2c0fd406f02c
  Backport-requested-by: security@xen.org
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
  61401264eb00fae4ee4efc8e9a5067449283207b:oxenstored: Enforce a maximum message size of 4096 bytes

  The maximum size of a message is part of the protocol spec in
    xen/include/public/io/xs_wire.h

  Before this patch a client which sends an overly large message can
  cause a buffer read overrun.

  Note if a badly-behaved client sends a very large message
  then it will be difficult for them to make their connection
  work again-- they will probably need to reboot.

  This is a security issue, part of XSA-38 / CVE-2013-0215.

  Signed-off-by: David Scott <dave.scott@eu.citrix.com>
  Acked-by: Ian Campbell <Ian.Campbell@citrix.com>
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>

  xen-unstable changeset: 26522:ffd30e7388ad
  Backport-requested-by: security@xen.org
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
  40f9c5e0a6d15b4ca1f6d4ed3a46f0871520eab5:tools/ocaml: oxenstored: Be more paranoid about ring reading

  oxenstored makes use of the OCaml Xenbus bindings, in which the
  function xs_ring_read in tools/ocaml/libs/xb/xs_ring_stubs.c is used
  to read from the shared memory Xenstore ring.

  This function does not correctly handle all possible (prod, cons)
  states when MASK_XENSTORE_IDX(prod) > MASK_XENSTORE_IDX(cons).

  The root cause is the use of the unmasked values of prod and cons to
  calculate to_read.  If prod is set to an out-of-range value, the ring
  peer can cause to_read to be too large or even negative.  This allows
  the ring peer to force oxenstored to read and write out of range for
  the buffers leading to a crash or possibly to privilege escalation.

  Correct this by masking the values of cons and prod at the start, so
  we only deal with masked values.  This makes the logic simpler, as
  semantically inappropriate values of the upper bits of the ring
  pointers are simply ignored.

  The same vulnerability does not exist in the ring writer because the
  only use made of the unmasked value is the check which prevents the
  prod pointer overtaking the cons pointer.  A ring peer which defeats
  this check will suffer only lost data.


  However, additionally, precautions need to be taken to ensure that
  req_cons and req_prod are only read once in each function.  Without
  the use of volatile or some asm construct, the compiler can "prove"
  that req_cons and req_prod do not change unexpectedly and is permitted
  to "amplify" the read of (say) req_cons into two reads at different
  times, giving two different values for use as cons, and then use the
  two sources of cons interchangeably.  (The use of xen_mb() does not
  forbid this.)

  Therefore do the reads of req_cons and req_prod through a volatile
  pointer in both xs_ring_read and xs_ring_write.

  This is currently believed to be a theoretical vulnerability as we are
  not aware of any compilers which amplify reads in this way.


  This is a security issue, part of XSA-38 / CVE-2013-0215.


  Signed-off-by: Ian Jackson <ian.jackson@eu.citrix.com>
  Tested-by: Matthew Daley <mattjd@gmail.com>
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>

  xen-unstable changeset: 26521:2c0fd406f02c
  Backport-requested-by: security@xen.org
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
  331a3b6ff03932c6d577073880c08adb1ff3cbee:tools/ocaml: oxenstored: Be more paranoid about ring reading

  oxenstored makes use of the OCaml Xenbus bindings, in which the
  function xs_ring_read in tools/ocaml/libs/xb/xs_ring_stubs.c is used
  to read from the shared memory Xenstore ring.

  This function does not correctly handle all possible (prod, cons)
  states when MASK_XENSTORE_IDX(prod) > MASK_XENSTORE_IDX(cons).

  The root cause is the use of the unmasked values of prod and cons to
  calculate to_read.  If prod is set to an out-of-range value, the ring
  peer can cause to_read to be too large or even negative.  This allows
  the ring peer to force oxenstored to read and write out of range for
  the buffers leading to a crash or possibly to privilege escalation.

  Correct this by masking the values of cons and prod at the start, so
  we only deal with masked values.  This makes the logic simpler, as
  semantically inappropriate values of the upper bits of the ring
  pointers are simply ignored.

  The same vulnerability does not exist in the ring writer because the
  only use made of the unmasked value is the check which prevents the
  prod pointer overtaking the cons pointer.  A ring peer which defeats
  this check will suffer only lost data.


  However, additionally, precautions need to be taken to ensure that
  req_cons and req_prod are only read once in each function.  Without
  the use of volatile or some asm construct, the compiler can "prove"
  that req_cons and req_prod do not change unexpectedly and is permitted
  to "amplify" the read of (say) req_cons into two reads at different
  times, giving two different values for use as cons, and then use the
  two sources of cons interchangeably.  (The use of xen_mb() does not
  forbid this.)

  Therefore do the reads of req_cons and req_prod through a volatile
  pointer in both xs_ring_read and xs_ring_write.

  This is currently believed to be a theoretical vulnerability as we are
  not aware of any compilers which amplify reads in this way.


  This is a security issue, part of XSA-38 / CVE-2013-0215.


  Signed-off-by: Ian Jackson <ian.jackson@eu.citrix.com>
  Tested-by: Matthew Daley <mattjd@gmail.com>
  Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
impacted_packages:
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 762349de68bcb832b8b6fb5357b837789506f242
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 331a3b6ff03932c6d577073880c08adb1ff3cbee
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: cfc4249c0df095811142e338bcc1291d8b6cba29
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: a69bad54a915d039e3e571304d096898bd51e0ac
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 4d249d79db70dc2756f6c102e2ddaeee14d7ac42
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 40f9c5e0a6d15b4ca1f6d4ed3a46f0871520eab5
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: 61401264eb00fae4ee4efc8e9a5067449283207b
    introduced_in_commits: []
  - purl: pkg:github/xen-project/xen
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/xen-project/xen
        commit: eeddfad1b339dcaa787230f519a19de1cbc22ad8
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/xen-project/xen/tree/331a3b6ff03932c6d577073880c08adb1ff3cbee
    reference_type: commit
    reference_id: 331a3b6ff03932c6d577073880c08adb1ff3cbee
  - url: https://github.com/xen-project/xen/tree/40f9c5e0a6d15b4ca1f6d4ed3a46f0871520eab5
    reference_type: commit
    reference_id: 40f9c5e0a6d15b4ca1f6d4ed3a46f0871520eab5
  - url: https://github.com/xen-project/xen/tree/4d249d79db70dc2756f6c102e2ddaeee14d7ac42
    reference_type: commit
    reference_id: 4d249d79db70dc2756f6c102e2ddaeee14d7ac42
  - url: https://github.com/xen-project/xen/tree/61401264eb00fae4ee4efc8e9a5067449283207b
    reference_type: commit
    reference_id: 61401264eb00fae4ee4efc8e9a5067449283207b
  - url: https://github.com/xen-project/xen/tree/762349de68bcb832b8b6fb5357b837789506f242
    reference_type: commit
    reference_id: 762349de68bcb832b8b6fb5357b837789506f242
  - url: https://github.com/xen-project/xen/tree/a69bad54a915d039e3e571304d096898bd51e0ac
    reference_type: commit
    reference_id: a69bad54a915d039e3e571304d096898bd51e0ac
  - url: https://github.com/xen-project/xen/tree/cfc4249c0df095811142e338bcc1291d8b6cba29
    reference_type: commit
    reference_id: cfc4249c0df095811142e338bcc1291d8b6cba29
  - url: https://github.com/xen-project/xen/tree/eeddfad1b339dcaa787230f519a19de1cbc22ad8
    reference_type: commit
    reference_id: eeddfad1b339dcaa787230f519a19de1cbc22ad8
