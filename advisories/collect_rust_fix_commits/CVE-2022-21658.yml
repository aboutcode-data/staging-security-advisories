advisory_id: CVE-2022-21658
datasource_id: collect_rust_fix_commits/CVE-2022-21658
datasource_url: https://github.com/rust-lang/rust
aliases: []
summary: |
  7f306d5729fc11d18a88de6f7503b9c2883e250d:Rollup merge of #141832 - workingjubilee:explain-what-toctou-races-are, r=thomcc,ChrisDenton

  library: explain TOCTOU races in `fs::remove_dir_all`

  In the previous description it said there was a TOCTOU race but did not explain exactly what the problem was. I sat down with the CVE, reviewed its text, and created this explanation. This context should hopefully help people understand the actual risk as-such.

  Incidentally, it also fixes the capitalization on the name of Redox OS.

  Original CVE and advisory:
  - CVE: https://www.cve.org/CVERecord?id=CVE-2022-21658
  - security advisory: https://groups.google.com/g/rustlang-security-announcements/c/R1fZFDhnJVQ?pli=1
  - github cross-post: https://github.com/rust-lang/rust/security/advisories/GHSA-r9cc-f5pr-p3j2
  51126be1b260216b41143469086e6e6ee567647e:Auto merge of #93260 - matthiaskrgr:rollup-c5b9c76, r=matthiaskrgr

  Rollup of 8 pull requests

  Successful merges:

   - #92513 (std: Implement try_reserve and try_reserve_exact on PathBuf)
   - #93152 (Fix STD compilation for the ESP-IDF target (regression from CVE-2022-21658))
   - #93186 (Fix link to CVE-2022-21658)
   - #93188 (rustdoc: fix bump down typing search on Safari)
   - #93212 (Remove unneeded cursor pointer rule on mobile sidebar)
   - #93231 (adjust sidebar link brightness)
   - #93241 (Fix brief appearance of rust logo in the sidebar)
   - #93253 (Update theme on pageshow event)

  Failed merges:

  r? `@ghost`
  `@rustbot` modify labels: rollup
  51126be1b260216b41143469086e6e6ee567647e:Auto merge of #93260 - matthiaskrgr:rollup-c5b9c76, r=matthiaskrgr

  Rollup of 8 pull requests

  Successful merges:

   - #92513 (std: Implement try_reserve and try_reserve_exact on PathBuf)
   - #93152 (Fix STD compilation for the ESP-IDF target (regression from CVE-2022-21658))
   - #93186 (Fix link to CVE-2022-21658)
   - #93188 (rustdoc: fix bump down typing search on Safari)
   - #93212 (Remove unneeded cursor pointer rule on mobile sidebar)
   - #93231 (adjust sidebar link brightness)
   - #93241 (Fix brief appearance of rust logo in the sidebar)
   - #93253 (Update theme on pageshow event)

  Failed merges:

  r? `@ghost`
  `@rustbot` modify labels: rollup
  8491fb3d3f723cb500527c5379f6cc52822309d2:Rollup merge of #93186 - kraai:fix-CVE-2022-21658-link, r=m-ou-se

  Fix link to CVE-2022-21658

  The link to CVE-2022-21658 contains a trailing bracket, which causes
  it to link to <https://www.cve.org/CVERecord?id=CVE-2022-21658%5D>.
  8491fb3d3f723cb500527c5379f6cc52822309d2:Rollup merge of #93186 - kraai:fix-CVE-2022-21658-link, r=m-ou-se

  Fix link to CVE-2022-21658

  The link to CVE-2022-21658 contains a trailing bracket, which causes
  it to link to <https://www.cve.org/CVERecord?id=CVE-2022-21658%5D>.
  8491fb3d3f723cb500527c5379f6cc52822309d2:Rollup merge of #93186 - kraai:fix-CVE-2022-21658-link, r=m-ou-se

  Fix link to CVE-2022-21658

  The link to CVE-2022-21658 contains a trailing bracket, which causes
  it to link to <https://www.cve.org/CVERecord?id=CVE-2022-21658%5D>.
  8491fb3d3f723cb500527c5379f6cc52822309d2:Rollup merge of #93186 - kraai:fix-CVE-2022-21658-link, r=m-ou-se

  Fix link to CVE-2022-21658

  The link to CVE-2022-21658 contains a trailing bracket, which causes
  it to link to <https://www.cve.org/CVERecord?id=CVE-2022-21658%5D>.
  144aeedcf3ec4720c2635bbd20a5b3b1588547e3:Rollup merge of #93152 - ivmarkov:master, r=m-ou-se

  Fix STD compilation for the ESP-IDF target (regression from CVE-2022-21658)

  Commit https://github.com/rust-lang/rust/commit/54e22eb7dbb615bd44355028d3fd867aa93c0972 broke the compilation of STD for the ESP-IDF embedded "unix-like" Tier 3 target, because the fix for [CVE-2022-21658](https://blog.rust-lang.org/2022/01/20/Rust-1.58.1.html) uses [libc flags](https://github.com/esp-rs/esp-idf-svc/runs/4892221554?check_suite_focus=true) which are not supported on the ESP-IDF platform.

  This PR simply redirects the ESP-IDF compilation to the "classic" implementation, similar to REDOX. This should be safe because:
  * Neither of the two filesystems supported by ESP-IDF (spiffs and fatfs) support [symlinks](https://github.com/natevw/fatfs/blob/master/README.md) in the first place
  * There is no notion of fs permissions at all, as the ESP-IDF is an embedded platform that does not have the notion of users, groups, etc.
  * Similarly, ESP-IDF has just one "process" - the firmware itself - which contains the user code and the "OS" fused together and running with all permissions
  144aeedcf3ec4720c2635bbd20a5b3b1588547e3:Rollup merge of #93152 - ivmarkov:master, r=m-ou-se

  Fix STD compilation for the ESP-IDF target (regression from CVE-2022-21658)

  Commit https://github.com/rust-lang/rust/commit/54e22eb7dbb615bd44355028d3fd867aa93c0972 broke the compilation of STD for the ESP-IDF embedded "unix-like" Tier 3 target, because the fix for [CVE-2022-21658](https://blog.rust-lang.org/2022/01/20/Rust-1.58.1.html) uses [libc flags](https://github.com/esp-rs/esp-idf-svc/runs/4892221554?check_suite_focus=true) which are not supported on the ESP-IDF platform.

  This PR simply redirects the ESP-IDF compilation to the "classic" implementation, similar to REDOX. This should be safe because:
  * Neither of the two filesystems supported by ESP-IDF (spiffs and fatfs) support [symlinks](https://github.com/natevw/fatfs/blob/master/README.md) in the first place
  * There is no notion of fs permissions at all, as the ESP-IDF is an embedded platform that does not have the notion of users, groups, etc.
  * Similarly, ESP-IDF has just one "process" - the firmware itself - which contains the user code and the "OS" fused together and running with all permissions
  91b9b6adfb6c585a7bf6cd4a47adbd1f20bd5c73:Fix link to CVE-2022-21658
  92c92fb3c14a19a565aab416c4d357e0872a4408:Auto merge of #93111 - pietroalbini:pa-cve-2022-21658-beta, r=Mark-Simulacrum

  [beta] Fix CVE-2022-21658

  See https://blog.rust-lang.org/2022/01/20/cve-2022-21658.html. Patches reviewed by `@m-ou-se.`

  Also backports:

  *  resolve rustfmt issue with generated files #92912
  *  rustdoc: fix intra-link for generic trait impls #92792
  *  Fix rust logo style #92764

  r? `@ghost`
  777bb86bcdbc568be7cff6eeeaaf81a89b4aa50b:Auto merge of #93119 - matthiaskrgr:rollup-ku3cn5j, r=matthiaskrgr

  Rollup of 13 pull requests

  Successful merges:

   - #89747 (Add MaybeUninit::(slice_)as_bytes(_mut))
   - #89764 (Fix variant index / discriminant confusion in uninhabited enum branching)
   - #91606 (Stabilize `-Z print-link-args` as `--print link-args`)
   - #91694 (rustdoc: decouple stability and const-stability)
   - #92183 (Point at correct argument when async fn output type lifetime disagrees with signature)
   - #92582 (improve `_` constants in item signature handling)
   - #92680 (intra-doc: Use the impl's assoc item where possible)
   - #92704 (Change lint message to be stronger for &T -> &mut T transmute)
   - #92861 (Rustdoc mobile: put out-of-band info on its own line)
   - #92992 (Help optimize out backtraces when disabled)
   - #93038 (Fix star handling in block doc comments)
   - #93108 (:arrow_up: rust-analyzer)
   - #93112 (Fix CVE-2022-21658)

  Failed merges:

  r? `@ghost`
  `@rustbot` modify labels: rollup
  dbc97490bbca00e6913c34b8864791d660c60312:Rollup merge of #93112 - pietroalbini:pa-cve-2022-21658-nightly, r=pietroalbini

  Fix CVE-2022-21658

  See https://blog.rust-lang.org/2022/01/20/cve-2022-21658.html. Patches reviewed by `@m-ou-se.`

  r? `@ghost`
  08182e4670b07fbb0511e01338eb9d6402c90dd3:Auto merge of #93110 - pietroalbini:pa-cve-2022-21658-stable, r=pietroalbini

  [stable] Fix CVE 2022 21658 and prepare 1.58.1

  Followup to https://github.com/rust-lang/rust/pull/93071. Includes the fix for CVE-2022-21658.

  r? `@ghost`
  cc `@rust-lang/release` `@rust-lang/security`
  1e17daf1e0104ef096f70c062dd92e4310cd2966:Update release notes to include CVE-2022-21658
  406cc071d6cfdfdb678bf3d83d766851de95abaf:Fix CVE-2022-21658 for WASI
  32ed6e599bb4722efefd78bbc9cd7ec4613cb946:Fix CVE-2022-21658 for UNIX-like
  4f0ad1c92ca08da6e8dc17838070975762f59714:Fix CVE-2022-21658 for Windows
  cb748a27d28df86cfe036709dc8092896abde31a:Fix CVE-2022-21658 for WASI
  54e22eb7dbb615bd44355028d3fd867aa93c0972:Fix CVE-2022-21658 for UNIX-like
  5ab67bff1e2230217ce133165605f8dc0d588178:Fix CVE-2022-21658 for Windows
  a935222f80ad711d4a6080d4baabd08ef261955b:Fix CVE-2022-21658 for WASI
  4c482ad2da3c433c047d2b12f32a9d0d57ae44d3:Fix CVE-2022-21658 for UNIX-like
  3d52c4c0128bf475ab5076d9a7e9df0024aa312b:Fix CVE-2022-21658 for Windows
impacted_packages:
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 92c92fb3c14a19a565aab416c4d357e0872a4408
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 32ed6e599bb4722efefd78bbc9cd7ec4613cb946
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 5ab67bff1e2230217ce133165605f8dc0d588178
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 144aeedcf3ec4720c2635bbd20a5b3b1588547e3
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 4f0ad1c92ca08da6e8dc17838070975762f59714
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 54e22eb7dbb615bd44355028d3fd867aa93c0972
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: a935222f80ad711d4a6080d4baabd08ef261955b
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 7f306d5729fc11d18a88de6f7503b9c2883e250d
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: cb748a27d28df86cfe036709dc8092896abde31a
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 3d52c4c0128bf475ab5076d9a7e9df0024aa312b
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 1e17daf1e0104ef096f70c062dd92e4310cd2966
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 406cc071d6cfdfdb678bf3d83d766851de95abaf
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 51126be1b260216b41143469086e6e6ee567647e
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: dbc97490bbca00e6913c34b8864791d660c60312
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 08182e4670b07fbb0511e01338eb9d6402c90dd3
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 777bb86bcdbc568be7cff6eeeaaf81a89b4aa50b
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 91b9b6adfb6c585a7bf6cd4a47adbd1f20bd5c73
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 4c482ad2da3c433c047d2b12f32a9d0d57ae44d3
    introduced_in_commits: []
  - purl: pkg:github/rust-lang/rust
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rust-lang/rust
        commit: 8491fb3d3f723cb500527c5379f6cc52822309d2
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/rust-lang/rust/tree/08182e4670b07fbb0511e01338eb9d6402c90dd3
    reference_type: commit
    reference_id: 08182e4670b07fbb0511e01338eb9d6402c90dd3
  - url: https://github.com/rust-lang/rust/tree/144aeedcf3ec4720c2635bbd20a5b3b1588547e3
    reference_type: commit
    reference_id: 144aeedcf3ec4720c2635bbd20a5b3b1588547e3
  - url: https://github.com/rust-lang/rust/tree/1e17daf1e0104ef096f70c062dd92e4310cd2966
    reference_type: commit
    reference_id: 1e17daf1e0104ef096f70c062dd92e4310cd2966
  - url: https://github.com/rust-lang/rust/tree/32ed6e599bb4722efefd78bbc9cd7ec4613cb946
    reference_type: commit
    reference_id: 32ed6e599bb4722efefd78bbc9cd7ec4613cb946
  - url: https://github.com/rust-lang/rust/tree/3d52c4c0128bf475ab5076d9a7e9df0024aa312b
    reference_type: commit
    reference_id: 3d52c4c0128bf475ab5076d9a7e9df0024aa312b
  - url: https://github.com/rust-lang/rust/tree/406cc071d6cfdfdb678bf3d83d766851de95abaf
    reference_type: commit
    reference_id: 406cc071d6cfdfdb678bf3d83d766851de95abaf
  - url: https://github.com/rust-lang/rust/tree/4c482ad2da3c433c047d2b12f32a9d0d57ae44d3
    reference_type: commit
    reference_id: 4c482ad2da3c433c047d2b12f32a9d0d57ae44d3
  - url: https://github.com/rust-lang/rust/tree/4f0ad1c92ca08da6e8dc17838070975762f59714
    reference_type: commit
    reference_id: 4f0ad1c92ca08da6e8dc17838070975762f59714
  - url: https://github.com/rust-lang/rust/tree/51126be1b260216b41143469086e6e6ee567647e
    reference_type: commit
    reference_id: 51126be1b260216b41143469086e6e6ee567647e
  - url: https://github.com/rust-lang/rust/tree/54e22eb7dbb615bd44355028d3fd867aa93c0972
    reference_type: commit
    reference_id: 54e22eb7dbb615bd44355028d3fd867aa93c0972
  - url: https://github.com/rust-lang/rust/tree/5ab67bff1e2230217ce133165605f8dc0d588178
    reference_type: commit
    reference_id: 5ab67bff1e2230217ce133165605f8dc0d588178
  - url: https://github.com/rust-lang/rust/tree/777bb86bcdbc568be7cff6eeeaaf81a89b4aa50b
    reference_type: commit
    reference_id: 777bb86bcdbc568be7cff6eeeaaf81a89b4aa50b
  - url: https://github.com/rust-lang/rust/tree/7f306d5729fc11d18a88de6f7503b9c2883e250d
    reference_type: commit
    reference_id: 7f306d5729fc11d18a88de6f7503b9c2883e250d
  - url: https://github.com/rust-lang/rust/tree/8491fb3d3f723cb500527c5379f6cc52822309d2
    reference_type: commit
    reference_id: 8491fb3d3f723cb500527c5379f6cc52822309d2
  - url: https://github.com/rust-lang/rust/tree/91b9b6adfb6c585a7bf6cd4a47adbd1f20bd5c73
    reference_type: commit
    reference_id: 91b9b6adfb6c585a7bf6cd4a47adbd1f20bd5c73
  - url: https://github.com/rust-lang/rust/tree/92c92fb3c14a19a565aab416c4d357e0872a4408
    reference_type: commit
    reference_id: 92c92fb3c14a19a565aab416c4d357e0872a4408
  - url: https://github.com/rust-lang/rust/tree/a935222f80ad711d4a6080d4baabd08ef261955b
    reference_type: commit
    reference_id: a935222f80ad711d4a6080d4baabd08ef261955b
  - url: https://github.com/rust-lang/rust/tree/cb748a27d28df86cfe036709dc8092896abde31a
    reference_type: commit
    reference_id: cb748a27d28df86cfe036709dc8092896abde31a
  - url: https://github.com/rust-lang/rust/tree/dbc97490bbca00e6913c34b8864791d660c60312
    reference_type: commit
    reference_id: dbc97490bbca00e6913c34b8864791d660c60312
