advisory_id: CVE-2016-2193
datasource_id: collect_postgresql_fix_commits/CVE-2016-2193
datasource_url: https://github.com/postgres/postgres
aliases: []
summary: |
  b56f7b1f0c5e41e85828774debf8b911a203e012:Last-minute updates for release notes.

  Security: CVE-2016-2193, CVE-2016-3065
  4c46f83386a7e3556856d1e4c9f0c294d16b0dcc:Last-minute updates for release notes.

  Security: CVE-2016-2193, CVE-2016-3065
  db69e58a0642ef7fa46d62f6c4cf2460c3a1b41b:Reset plan->row_security_env and planUserId

  In the plancache, we check if the environment we planned the query under
  has changed in a way which requires us to re-plan, such as when the user
  for whom the plan was prepared changes and RLS is being used (and,
  therefore, there may be different policies to apply).

  Unfortunately, while those values were set and checked, they were not
  being reset when the query was re-planned and therefore, in cases where
  we change role, re-plan, and then change role again, we weren't
  re-planning again.  This leads to potentially incorrect policies being
  applied in cases where role-specific policies are used and a given query
  is planned under one role and then executed under other roles, which
  could happen under security definer functions or when a common user and
  query is planned initially and then re-used across multiple SET ROLEs.

  Further, extensions which made use of CopyCachedPlan() may suffer from
  similar issues as the RLS-related fields were not properly copied as
  part of the plan and therefore RevalidateCachedQuery() would copy in the
  current settings without invalidating the query.

  Fix by using the same approach used for 'search_path', where we set the
  correct values in CompleteCachedPlan(), check them early on in
  RevalidateCachedQuery() and then properly reset them if re-planning.
  Also, copy through the values during CopyCachedPlan().

  Pointed out by Ashutosh Bapat.  Reviewed by Michael Paquier.

  Back-patch to 9.5 where RLS was introduced.

  Security: CVE-2016-2193
  86ebf30fd6d8964bbd5d48db053b0a7ff709a0d7:Reset plan->row_security_env and planUserId

  In the plancache, we check if the environment we planned the query under
  has changed in a way which requires us to re-plan, such as when the user
  for whom the plan was prepared changes and RLS is being used (and,
  therefore, there may be different policies to apply).

  Unfortunately, while those values were set and checked, they were not
  being reset when the query was re-planned and therefore, in cases where
  we change role, re-plan, and then change role again, we weren't
  re-planning again.  This leads to potentially incorrect policies being
  applied in cases where role-specific policies are used and a given query
  is planned under one role and then executed under other roles, which
  could happen under security definer functions or when a common user and
  query is planned initially and then re-used across multiple SET ROLEs.

  Further, extensions which made use of CopyCachedPlan() may suffer from
  similar issues as the RLS-related fields were not properly copied as
  part of the plan and therefore RevalidateCachedQuery() would copy in the
  current settings without invalidating the query.

  Fix by using the same approach used for 'search_path', where we set the
  correct values in CompleteCachedPlan(), check them early on in
  RevalidateCachedQuery() and then properly reset them if re-planning.
  Also, copy through the values during CopyCachedPlan().

  Pointed out by Ashutosh Bapat.  Reviewed by Michael Paquier.

  Back-patch to 9.5 where RLS was introduced.

  Security: CVE-2016-2193
impacted_packages:
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: db69e58a0642ef7fa46d62f6c4cf2460c3a1b41b
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: b56f7b1f0c5e41e85828774debf8b911a203e012
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: 4c46f83386a7e3556856d1e4c9f0c294d16b0dcc
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: 86ebf30fd6d8964bbd5d48db053b0a7ff709a0d7
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/postgres/postgres/tree/4c46f83386a7e3556856d1e4c9f0c294d16b0dcc
    reference_type: commit
    reference_id: 4c46f83386a7e3556856d1e4c9f0c294d16b0dcc
  - url: https://github.com/postgres/postgres/tree/86ebf30fd6d8964bbd5d48db053b0a7ff709a0d7
    reference_type: commit
    reference_id: 86ebf30fd6d8964bbd5d48db053b0a7ff709a0d7
  - url: https://github.com/postgres/postgres/tree/b56f7b1f0c5e41e85828774debf8b911a203e012
    reference_type: commit
    reference_id: b56f7b1f0c5e41e85828774debf8b911a203e012
  - url: https://github.com/postgres/postgres/tree/db69e58a0642ef7fa46d62f6c4cf2460c3a1b41b
    reference_type: commit
    reference_id: db69e58a0642ef7fa46d62f6c4cf2460c3a1b41b
