advisory_id: CVE-2021-3393
datasource_id: collect_postgresql_fix_commits/CVE-2021-3393
datasource_url: https://github.com/postgres/postgres
aliases: []
summary: |
  934b8508472a6b7175fd49bb2a8e719cb5560be8:Last-minute updates for release notes.

  Security: CVE-2021-3393, CVE-2021-20229
  392c530d10352978bb3701b7eb425626dc9a4d3e:Last-minute updates for release notes.

  Security: CVE-2021-3393, CVE-2021-20229
  cd82d75a9861c871b95683afdb12df6374fa8435:Last-minute updates for release notes.

  Security: CVE-2021-3393, CVE-2021-20229
  cb5868cc1bd77b9b2f0f62b28d15a62b97ba3e94:Fix permission checks on constraint violation errors on partitions.

  If a cross-partition UPDATE violates a constraint on the target partition,
  and the columns in the new partition are in different physical order than
  in the parent, the error message can reveal columns that the user does not
  have SELECT permission on. A similar bug was fixed earlier in commit
  804b6b6db4.

  The cause of the bug is that the callers of the
  ExecBuildSlotValueDescription() function got confused when constructing
  the list of modified columns. If the tuple was routed from a parent, we
  converted the tuple to the parent's format, but the list of modified
  columns was grabbed directly from the child's RTE entry.

  ExecUpdateLockMode() had a similar issue. That lead to confusion on which
  columns are key columns, leading to wrong tuple lock being taken on tables
  referenced by foreign keys, when a row is updated with INSERT ON CONFLICT
  UPDATE. A new isolation test is added for that corner case.

  With this patch, the ri_RangeTableIndex field is no longer set for
  partitions that don't have an entry in the range table. Previously, it was
  set to the RTE entry of the parent relation, but that was confusing.

  NOTE: This modifies the ResultRelInfo struct, replacing the
  ri_PartitionRoot field with ri_RootResultRelInfo. That's a bit risky to
  backpatch, because it breaks any extensions accessing the field. The
  change that ri_RangeTableIndex is not set for partitions could potentially
  break extensions, too. The ResultRelInfos are visible to FDWs at least,
  and this patch required small changes to postgres_fdw. Nevertheless, this
  seem like the least bad option. I don't think these fields widely used in
  extensions; I don't think there are FDWs out there that uses the FDW
  "direct update" API, other than postgres_fdw. If there is, you will get a
  compilation error, so hopefully it is caught quickly.

  Backpatch to 11, where support for both cross-partition UPDATEs, and unique
  indexes on partitioned tables, were added.

  Reviewed-by: Amit Langote
  Security: CVE-2021-3393
  f50e888990d3fa197e588991b637f9e43e56e53f:Fix permission checks on constraint violation errors on partitions.

  If a cross-partition UPDATE violates a constraint on the target partition,
  and the columns in the new partition are in different physical order than
  in the parent, the error message can reveal columns that the user does not
  have SELECT permission on. A similar bug was fixed earlier in commit
  804b6b6db4.

  The cause of the bug is that the callers of the
  ExecBuildSlotValueDescription() function got confused when constructing
  the list of modified columns. If the tuple was routed from a parent, we
  converted the tuple to the parent's format, but the list of modified
  columns was grabbed directly from the child's RTE entry.

  ExecUpdateLockMode() had a similar issue. That lead to confusion on which
  columns are key columns, leading to wrong tuple lock being taken on tables
  referenced by foreign keys, when a row is updated with INSERT ON CONFLICT
  UPDATE. A new isolation test is added for that corner case.

  With this patch, the ri_RangeTableIndex field is no longer set for
  partitions that don't have an entry in the range table. Previously, it was
  set to the RTE entry of the parent relation, but that was confusing.

  NOTE: This modifies the ResultRelInfo struct, replacing the
  ri_PartitionRoot field with ri_RootResultRelInfo. That's a bit risky to
  backpatch, because it breaks any extensions accessing the field. The
  change that ri_RangeTableIndex is not set for partitions could potentially
  break extensions, too. The ResultRelInfos are visible to FDWs at least,
  and this patch required small changes to postgres_fdw. Nevertheless, this
  seem like the least bad option. I don't think these fields widely used in
  extensions; I don't think there are FDWs out there that uses the FDW
  "direct update" API, other than postgres_fdw. If there is, you will get a
  compilation error, so hopefully it is caught quickly.

  Backpatch to 11, where support for both cross-partition UPDATEs, and unique
  indexes on partitioned tables, were added.

  Reviewed-by: Amit Langote
  Security: CVE-2021-3393
  8e56684d54d44ba4ed737d5847d31fba6fb13763:Fix permission checks on constraint violation errors on partitions.

  If a cross-partition UPDATE violates a constraint on the target partition,
  and the columns in the new partition are in different physical order than
  in the parent, the error message can reveal columns that the user does not
  have SELECT permission on. A similar bug was fixed earlier in commit
  804b6b6db4.

  The cause of the bug is that the callers of the
  ExecBuildSlotValueDescription() function got confused when constructing
  the list of modified columns. If the tuple was routed from a parent, we
  converted the tuple to the parent's format, but the list of modified
  columns was grabbed directly from the child's RTE entry.

  ExecUpdateLockMode() had a similar issue. That lead to confusion on which
  columns are key columns, leading to wrong tuple lock being taken on tables
  referenced by foreign keys, when a row is updated with INSERT ON CONFLICT
  UPDATE. A new isolation test is added for that corner case.

  With this patch, the ri_RangeTableIndex field is no longer set for
  partitions that don't have an entry in the range table. Previously, it was
  set to the RTE entry of the parent relation, but that was confusing.

  NOTE: This modifies the ResultRelInfo struct, replacing the
  ri_PartitionRoot field with ri_RootResultRelInfo. That's a bit risky to
  backpatch, because it breaks any extensions accessing the field. The
  change that ri_RangeTableIndex is not set for partitions could potentially
  break extensions, too. The ResultRelInfos are visible to FDWs at least,
  and this patch required small changes to postgres_fdw. Nevertheless, this
  seem like the least bad option. I don't think these fields widely used in
  extensions; I don't think there are FDWs out there that uses the FDW
  "direct update" API, other than postgres_fdw. If there is, you will get a
  compilation error, so hopefully it is caught quickly.

  Backpatch to 11, where support for both cross-partition UPDATEs, and unique
  indexes on partitioned tables, were added.

  Reviewed-by: Amit Langote
  Security: CVE-2021-3393
  6214e2b2280462cbc3aa1986e350e167651b3905:Fix permission checks on constraint violation errors on partitions.

  If a cross-partition UPDATE violates a constraint on the target partition,
  and the columns in the new partition are in different physical order than
  in the parent, the error message can reveal columns that the user does not
  have SELECT permission on. A similar bug was fixed earlier in commit
  804b6b6db4.

  The cause of the bug is that the callers of the
  ExecBuildSlotValueDescription() function got confused when constructing
  the list of modified columns. If the tuple was routed from a parent, we
  converted the tuple to the parent's format, but the list of modified
  columns was grabbed directly from the child's RTE entry.

  ExecUpdateLockMode() had a similar issue. That lead to confusion on which
  columns are key columns, leading to wrong tuple lock being taken on tables
  referenced by foreign keys, when a row is updated with INSERT ON CONFLICT
  UPDATE. A new isolation test is added for that corner case.

  With this patch, the ri_RangeTableIndex field is no longer set for
  partitions that don't have an entry in the range table. Previously, it was
  set to the RTE entry of the parent relation, but that was confusing.

  NOTE: This modifies the ResultRelInfo struct, replacing the
  ri_PartitionRoot field with ri_RootResultRelInfo. That's a bit risky to
  backpatch, because it breaks any extensions accessing the field. The
  change that ri_RangeTableIndex is not set for partitions could potentially
  break extensions, too. The ResultRelInfos are visible to FDWs at least,
  and this patch required small changes to postgres_fdw. Nevertheless, this
  seem like the least bad option. I don't think these fields widely used in
  extensions; I don't think there are FDWs out there that uses the FDW
  "direct update" API, other than postgres_fdw. If there is, you will get a
  compilation error, so hopefully it is caught quickly.

  Backpatch to 11, where support for both cross-partition UPDATEs, and unique
  indexes on partitioned tables, were added.

  Reviewed-by: Amit Langote
  Security: CVE-2021-3393
impacted_packages:
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: cd82d75a9861c871b95683afdb12df6374fa8435
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: 6214e2b2280462cbc3aa1986e350e167651b3905
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: cb5868cc1bd77b9b2f0f62b28d15a62b97ba3e94
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: 934b8508472a6b7175fd49bb2a8e719cb5560be8
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: f50e888990d3fa197e588991b637f9e43e56e53f
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: 392c530d10352978bb3701b7eb425626dc9a4d3e
    introduced_in_commits: []
  - purl: pkg:github/postgres/postgres
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/postgres/postgres
        commit: 8e56684d54d44ba4ed737d5847d31fba6fb13763
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/postgres/postgres/tree/392c530d10352978bb3701b7eb425626dc9a4d3e
    reference_type: commit
    reference_id: 392c530d10352978bb3701b7eb425626dc9a4d3e
  - url: https://github.com/postgres/postgres/tree/6214e2b2280462cbc3aa1986e350e167651b3905
    reference_type: commit
    reference_id: 6214e2b2280462cbc3aa1986e350e167651b3905
  - url: https://github.com/postgres/postgres/tree/8e56684d54d44ba4ed737d5847d31fba6fb13763
    reference_type: commit
    reference_id: 8e56684d54d44ba4ed737d5847d31fba6fb13763
  - url: https://github.com/postgres/postgres/tree/934b8508472a6b7175fd49bb2a8e719cb5560be8
    reference_type: commit
    reference_id: 934b8508472a6b7175fd49bb2a8e719cb5560be8
  - url: https://github.com/postgres/postgres/tree/cb5868cc1bd77b9b2f0f62b28d15a62b97ba3e94
    reference_type: commit
    reference_id: cb5868cc1bd77b9b2f0f62b28d15a62b97ba3e94
  - url: https://github.com/postgres/postgres/tree/cd82d75a9861c871b95683afdb12df6374fa8435
    reference_type: commit
    reference_id: cd82d75a9861c871b95683afdb12df6374fa8435
  - url: https://github.com/postgres/postgres/tree/f50e888990d3fa197e588991b637f9e43e56e53f
    reference_type: commit
    reference_id: f50e888990d3fa197e588991b637f9e43e56e53f
