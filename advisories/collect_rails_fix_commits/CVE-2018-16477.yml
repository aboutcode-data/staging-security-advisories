advisory_id: CVE-2018-16477
datasource_id: collect_rails_fix_commits/CVE-2018-16477
datasource_url: https://github.com/rails/rails
aliases: []
summary: |
  06ab7b27ea1c1ab357085439abacdb464f6742bf:Prevent content type and disposition bypass in storage service URLs

  * Force content-type to binary on service urls for relevant content types

  We have a list of content types that must be forcibly served as binary,
  but in practice this only means to serve them as attachment always. We
  should also set the Content-Type to the configured binary type.

  As a bonus: add text/cache-manifest to the list of content types to be
  served as binary by default.

  * Store content-disposition and content-type in GCS

  Forcing these in the service_url when serving the file works fine for S3
  and Azure, since these services include params in the signature.
  However, GCS specifically excludes response-content-disposition and
  response-content-type from the signature, which means an attacker can
  modify these and have files that should be served as text/plain attachments
  served as inline HTML for example. This makes our attempt to force
  specific files to be served as binary and as attachment can be easily
  bypassed.

  The only way this can be forced in GCS is by storing
  content-disposition and content-type in the object metadata.

  * Update GCS object metadata after identifying blob

  In some cases we create the blob and upload the data before identifying
  the content-type, which means we can't store that in GCS right when
  uploading. In these, after creating the attachment, we enqueue a job to
  identify the blob, and set the content-type.

  In other cases, files are uploaded to the storage service via direct
  upload link. We create the blob before the direct upload, which happens
  independently from the blob creation itself. We then mark the blob as
  identified, but we have already the content-type we need without having
  put it in the service.

  In these two cases, then, we need to update the metadata in the GCS
  service.

  * Include content-type and disposition in the verified key for disk service

  This prevents an attacker from modifying these params in the service
  signed URL, which is particularly important when we want to force them
  to have specific values for security reasons.

  * Allow only a list of specific content types to be served inline

  This is different from the content types that must be served as binary
  in the sense that any content type not in this list will be always
  served as attachment but with its original content type. Only types in
  this list are allowed to be served either inline or as attachment.

  Apart from forcing this in the service URL, for GCS we need to store the
  disposition in the metadata.

  Fix CVE-2018-16477.
  54ed6ad8d7468dc3a0b690e629c7c18497552eb8:Prevent content type and disposition bypass in storage service URLs

  * Force content-type to binary on service urls for relevant content types

  We have a list of content types that must be forcibly served as binary,
  but in practice this only means to serve them as attachment always. We
  should also set the Content-Type to the configured binary type.

  As a bonus: add text/cache-manifest to the list of content types to be
  served as binary by default.

  * Store content-disposition and content-type in GCS

  Forcing these in the service_url when serving the file works fine for S3
  and Azure, since these services include params in the signature.
  However, GCS specifically excludes response-content-disposition and
  response-content-type from the signature, which means an attacker can
  modify these and have files that should be served as text/plain attachments
  served as inline HTML for example. This makes our attempt to force
  specific files to be served as binary and as attachment can be easily
  bypassed.

  The only way this can be forced in GCS is by storing
  content-disposition and content-type in the object metadata.

  * Update GCS object metadata after identifying blob

  In some cases we create the blob and upload the data before identifying
  the content-type, which means we can't store that in GCS right when
  uploading. In these, after creating the attachment, we enqueue a job to
  identify the blob, and set the content-type.

  In other cases, files are uploaded to the storage service via direct
  upload link. We create the blob before the direct upload, which happens
  independently from the blob creation itself. We then mark the blob as
  identified, but we have already the content-type we need without having
  put it in the service.

  In these two cases, then, we need to update the metadata in the GCS
  service.

  * Include content-type and disposition in the verified key for disk service

  This prevents an attacker from modifying these params in the service
  signed URL, which is particularly important when we want to force them
  to have specific values for security reasons.

  * Allow only a list of specific content types to be served inline

  This is different from the content types that must be served as binary
  in the sense that any content type not in this list will be always
  served as attachment but with its original content type. Only types in
  this list are allowed to be served either inline or as attachment.

  Apart from forcing this in the service URL, for GCS we need to store the
  disposition in the metadata.

  Fix CVE-2018-16477.
impacted_packages:
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 06ab7b27ea1c1ab357085439abacdb464f6742bf
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 54ed6ad8d7468dc3a0b690e629c7c18497552eb8
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/rails/rails/tree/06ab7b27ea1c1ab357085439abacdb464f6742bf
    reference_type: commit
    reference_id: 06ab7b27ea1c1ab357085439abacdb464f6742bf
  - url: https://github.com/rails/rails/tree/54ed6ad8d7468dc3a0b690e629c7c18497552eb8
    reference_type: commit
    reference_id: 54ed6ad8d7468dc3a0b690e629c7c18497552eb8
