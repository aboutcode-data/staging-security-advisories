advisory_id: CVE-2021-22881
datasource_id: collect_rails_fix_commits/CVE-2021-22881
datasource_url: https://github.com/rails/rails
aliases: []
summary: |
  9f02d2d84ac84827b98add4199a7efafd0124eba:Merge branch '6-0-sec' into 6-0-stable

  * 6-0-sec:
    Preparing for 6.0.4.1 release
    Bumping version for release / update changelog
    Refactor CVE-2021-22881 fix
  e7b0eddc70bf516bed56f892a40c57e8ddec559f:Merge branch '6-1-sec' into 6-1-stable

  * 6-1-sec:
    Preparing for 6.1.4.1 release
    Bump version / update changelog
    Refactor CVE-2021-22881 fix
  9fe57c0fc5561088a2df42e4438992591e9d917e:Refactor CVE-2021-22881 fix

  Follow-up to 83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f.

  This allows `HTTP_HOST` to be omitted as before, and reduces the number
  of object allocations per request.

  Benchmark:

  ```ruby
   # frozen_string_literal: true
  require "benchmark/memory"

  HOST = "example.com:80"
  BEFORE_REGEXP = /\A(?<host>[a-z0-9.-]+|\[[a-f0-9]*:[a-f0-9.:]+\])(:\d+)?\z/
  AFTER_REGEXP = /(?:\A|,[ ]?)([a-z0-9.-]+|\[[a-f0-9]*:[a-f0-9.:]+\])(?::\d+)?\z/i

  Benchmark.memory do |x|
    x.report("BEFORE (non-nil X-Forwarded-Host)") do
      origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]
      forwarded_host = BEFORE_REGEXP.match(HOST.to_s.split(/,\s?/).last)[:host]
    end

    x.report("BEFORE (nil X-Forwarded-Host)") do
      origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]
      forwarded_host = BEFORE_REGEXP.match(nil.to_s.split(/,\s?/).last)
    end

    x.report("AFTER (non-nil X-Forwarded-Host)") do
      origin_host = HOST&.slice(AFTER_REGEXP, 1) || ""
      forwarded_host = HOST&.slice(AFTER_REGEXP, 1) || ""
    end

    x.report("AFTER (nil X-Forwarded-Host)") do
      origin_host = HOST&.slice(AFTER_REGEXP, 1) || ""
      forwarded_host = nil&.slice(AFTER_REGEXP, 1) || ""
    end
  end
  ```

  Results:

  ```
  BEFORE (non-nil X-Forwarded-Host)
                         616.000  memsize (   208.000  retained)
                           9.000  objects (     2.000  retained)
                           2.000  strings (     1.000  retained)
  BEFORE (nil X-Forwarded-Host)
                         328.000  memsize (     0.000  retained)
                           5.000  objects (     0.000  retained)
                           2.000  strings (     0.000  retained)
  AFTER (non-nil X-Forwarded-Host)
                         248.000  memsize (   168.000  retained)
                           3.000  objects (     1.000  retained)
                           1.000  strings (     0.000  retained)
  AFTER (nil X-Forwarded-Host)
                          40.000  memsize (     0.000  retained)
                           1.000  objects (     0.000  retained)
                           1.000  strings (     0.000  retained)
  ```

  [CVE-2021-22942]
  5e9973d6e020b98a5ec71578aa1837efcf4d7b7e:Refactor CVE-2021-22881 fix

  Follow-up to 83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f.

  This allows `HTTP_HOST` to be omitted as before, and reduces the number
  of object allocations per request.

  Benchmark:

  ```ruby
   # frozen_string_literal: true
  require "benchmark/memory"

  HOST = "example.com:80"
  BEFORE_REGEXP = /\A(?<host>[a-z0-9.-]+|\[[a-f0-9]*:[a-f0-9.:]+\])(:\d+)?\z/
  AFTER_REGEXP = /(?:\A|,[ ]?)([a-z0-9.-]+|\[[a-f0-9]*:[a-f0-9.:]+\])(?::\d+)?\z/i

  Benchmark.memory do |x|
    x.report("BEFORE (non-nil X-Forwarded-Host)") do
      origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]
      forwarded_host = BEFORE_REGEXP.match(HOST.to_s.split(/,\s?/).last)[:host]
    end

    x.report("BEFORE (nil X-Forwarded-Host)") do
      origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]
      forwarded_host = BEFORE_REGEXP.match(nil.to_s.split(/,\s?/).last)
    end

    x.report("AFTER (non-nil X-Forwarded-Host)") do
      origin_host = HOST&.slice(AFTER_REGEXP, 1) || ""
      forwarded_host = HOST&.slice(AFTER_REGEXP, 1) || ""
    end

    x.report("AFTER (nil X-Forwarded-Host)") do
      origin_host = HOST&.slice(AFTER_REGEXP, 1) || ""
      forwarded_host = nil&.slice(AFTER_REGEXP, 1) || ""
    end
  end
  ```

  Results:

  ```
  BEFORE (non-nil X-Forwarded-Host)
                         616.000  memsize (   208.000  retained)
                           9.000  objects (     2.000  retained)
                           2.000  strings (     1.000  retained)
  BEFORE (nil X-Forwarded-Host)
                         328.000  memsize (     0.000  retained)
                           5.000  objects (     0.000  retained)
                           2.000  strings (     0.000  retained)
  AFTER (non-nil X-Forwarded-Host)
                         248.000  memsize (   168.000  retained)
                           3.000  objects (     1.000  retained)
                           1.000  strings (     0.000  retained)
  AFTER (nil X-Forwarded-Host)
                          40.000  memsize (     0.000  retained)
                           1.000  objects (     0.000  retained)
                           1.000  strings (     0.000  retained)
  ```

  [CVE-2021-22942]
  7f02924fe65446a7cbbc29d91cf96d457b94c2de:Merge pull request #41435 from jonathanhefner/refactor-cve-2021-22881-fix

  Refactor CVE-2021-22881 fix
  a21ebfa1c98943df1e94534d45c16dca343027d7:Refactor CVE-2021-22881 fix

  Follow-up to 83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f.

  This allows `HTTP_HOST` to be omitted as before, and reduces the number
  of object allocations per request.

  Benchmark:

  ```ruby
   # frozen_string_literal: true
  require "benchmark/memory"

  HOST = "example.com:80"
  BEFORE_REGEXP = /\A(?<host>[a-z0-9.-]+|\[[a-f0-9]*:[a-f0-9.:]+\])(:\d+)?\z/
  AFTER_REGEXP = /(?:\A|,[ ]?)([a-z0-9.-]+|\[[a-f0-9]*:[a-f0-9.:]+\])(?::\d+)?\z/i

  Benchmark.memory do |x|
    x.report("BEFORE (non-nil X-Forwarded-Host)") do
      origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]
      forwarded_host = BEFORE_REGEXP.match(HOST.to_s.split(/,\s?/).last)[:host]
    end

    x.report("BEFORE (nil X-Forwarded-Host)") do
      origin_host = BEFORE_REGEXP.match(HOST.to_s.downcase)[:host]
      forwarded_host = BEFORE_REGEXP.match(nil.to_s.split(/,\s?/).last)
    end

    x.report("AFTER (non-nil X-Forwarded-Host)") do
      origin_host = HOST&.slice(AFTER_REGEXP, 1) || ""
      forwarded_host = HOST&.slice(AFTER_REGEXP, 1) || ""
    end

    x.report("AFTER (nil X-Forwarded-Host)") do
      origin_host = HOST&.slice(AFTER_REGEXP, 1) || ""
      forwarded_host = nil&.slice(AFTER_REGEXP, 1) || ""
    end
  end
  ```

  Results:

  ```
  BEFORE (non-nil X-Forwarded-Host)
                         616.000  memsize (   208.000  retained)
                           9.000  objects (     2.000  retained)
                           2.000  strings (     1.000  retained)
  BEFORE (nil X-Forwarded-Host)
                         328.000  memsize (     0.000  retained)
                           5.000  objects (     0.000  retained)
                           2.000  strings (     0.000  retained)
  AFTER (non-nil X-Forwarded-Host)
                         248.000  memsize (   168.000  retained)
                           3.000  objects (     1.000  retained)
                           1.000  strings (     0.000  retained)
  AFTER (nil X-Forwarded-Host)
                          40.000  memsize (     0.000  retained)
                           1.000  objects (     0.000  retained)
                           1.000  strings (     0.000  retained)
  ```
  83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f:Prevent open redirect when allowed host starts with a dot

  [CVE-2021-22881]

  Thanks to @tktech (https://hackerone.com/tktech) for reporting this
  issue and the patch!
  b5de7b3a4787d8a55aaad39f477c16e3af65e444:Prevent open redirect when allowed host starts with a dot

  [CVE-2021-22881]

  Thanks to @tktech (https://hackerone.com/tktech) for reporting this
  issue and the patch!
  e33092740b3cc05f5abee197a5982eac31947e92:Prevent open redirect when allowed host starts with a dot

  [CVE-2021-22881]

  Thanks to @tktech (https://hackerone.com/tktech) for reporting this
  issue and the patch!
impacted_packages:
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: e7b0eddc70bf516bed56f892a40c57e8ddec559f
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 7f02924fe65446a7cbbc29d91cf96d457b94c2de
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: a21ebfa1c98943df1e94534d45c16dca343027d7
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: b5de7b3a4787d8a55aaad39f477c16e3af65e444
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 9fe57c0fc5561088a2df42e4438992591e9d917e
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: e33092740b3cc05f5abee197a5982eac31947e92
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 9f02d2d84ac84827b98add4199a7efafd0124eba
    introduced_in_commits: []
  - purl: pkg:github/rails/rails
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/rails/rails
        commit: 5e9973d6e020b98a5ec71578aa1837efcf4d7b7e
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/rails/rails/tree/5e9973d6e020b98a5ec71578aa1837efcf4d7b7e
    reference_type: commit
    reference_id: 5e9973d6e020b98a5ec71578aa1837efcf4d7b7e
  - url: https://github.com/rails/rails/tree/7f02924fe65446a7cbbc29d91cf96d457b94c2de
    reference_type: commit
    reference_id: 7f02924fe65446a7cbbc29d91cf96d457b94c2de
  - url: https://github.com/rails/rails/tree/83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f
    reference_type: commit
    reference_id: 83a6ac3fee8fd538ce7e0088913ff54f0f9bcb6f
  - url: https://github.com/rails/rails/tree/9f02d2d84ac84827b98add4199a7efafd0124eba
    reference_type: commit
    reference_id: 9f02d2d84ac84827b98add4199a7efafd0124eba
  - url: https://github.com/rails/rails/tree/9fe57c0fc5561088a2df42e4438992591e9d917e
    reference_type: commit
    reference_id: 9fe57c0fc5561088a2df42e4438992591e9d917e
  - url: https://github.com/rails/rails/tree/a21ebfa1c98943df1e94534d45c16dca343027d7
    reference_type: commit
    reference_id: a21ebfa1c98943df1e94534d45c16dca343027d7
  - url: https://github.com/rails/rails/tree/b5de7b3a4787d8a55aaad39f477c16e3af65e444
    reference_type: commit
    reference_id: b5de7b3a4787d8a55aaad39f477c16e3af65e444
  - url: https://github.com/rails/rails/tree/e33092740b3cc05f5abee197a5982eac31947e92
    reference_type: commit
    reference_id: e33092740b3cc05f5abee197a5982eac31947e92
  - url: https://github.com/rails/rails/tree/e7b0eddc70bf516bed56f892a40c57e8ddec559f
    reference_type: commit
    reference_id: e7b0eddc70bf516bed56f892a40c57e8ddec559f
