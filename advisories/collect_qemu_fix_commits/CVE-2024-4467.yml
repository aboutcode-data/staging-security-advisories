advisory_id: CVE-2024-4467
datasource_id: collect_qemu_fix_commits/CVE-2024-4467
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  2e909d7ca95e6d395bd282a5bbf775c4b4eac10f:qcow2, vmdk: Restrict creation with secondary file using protocol

  Ever since CVE-2024-4467 (see commit 7ead9469 in qemu v9.1.0), we have
  intentionally treated the opening of secondary files whose name is
  specified in the contents of the primary file, such as a qcow2
  data_file, as something that must be a local file and not a protocol
  prefix (it is still possible to open a qcow2 file that wraps an NBD
  data image by using QMP commands, but that is from the explicit action
  of the QMP overriding any string encoded in the qcow2 file).  At the
  time, we did not prevent the use of protocol prefixes on the secondary
  image while creating a qcow2 file, but it results in a qcow2 file that
  records an empty string for the data_file, rather than the protocol
  passed in during creation:

  $ qemu-img create -f raw datastore.raw 2G
  $ qemu-nbd -e 0 -t -f raw datastore.raw &
  $ qemu-img create -f qcow2 -o data_file=nbd://localhost:10809/ \
    datastore_nbd.qcow2 2G
  Formatting 'datastore_nbd.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=2147483648 data_file=nbd://localhost:10809/ lazy_refcounts=off refcount_bits=16
  $ qemu-img info datastore_nbd.qcow2 | grep data
  $ qemu-img info datastore_nbd.qcow2 | grep data
  image: datastore_nbd.qcow2
      data file:
      data file raw: false
      filename: datastore_nbd.qcow2

  And since an empty string was recorded in the file, attempting to open
  the image without using QMP to supply the NBD data store fails, with a
  somewhat confusing error message:

  $ qemu-io -f qcow2 datastore_nbd.qcow2
  qemu-io: can't open device datastore_nbd.qcow2: The 'file' block driver requires a file name

  Although the ability to create an image with a convenience reference
  to a protocol data file is not a security hole (unlike the case with
  open, the image is not untrusted if we are the ones creating it), the
  above demo shows that it is still inconsistent.  Thus, it makes more
  sense if we also insist that image creation rejects a protocol prefix
  when using the same syntax.  Now, the above attempt produces:

  $ qemu-img create -f qcow2 -o data_file=nbd://localhost:10809/ \
    datastore_nbd.qcow2 2G
  Formatting 'datastore_nbd.qcow2', fmt=qcow2 cluster_size=65536 extended_l2=off compression_type=zlib size=2147483648 data_file=nbd://localhost:10809/ lazy_refcounts=off refcount_bits=16
  qemu-img: datastore_nbd.qcow2: Could not create 'nbd://localhost:10809/': No such file or directory

  with datastore_nbd.qcow2 no longer created.

  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-ID: <20250915213919.3121401-6-eblake@redhat.com>
  Reviewed-by: Kevin Wolf <kwolf@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  149bc216f295380b1a7b96e518f34bdbc9aecd6e:qcow2: Don't open data_file with BDRV_O_NO_IO

  One use case for 'qemu-img info' is verifying that untrusted images
  don't reference an unwanted external file, be it as a backing file or an
  external data file. To make sure that calling 'qemu-img info' can't
  already have undesired side effects with a malicious image, just don't
  open the data file at all with BDRV_O_NO_IO. If nothing ever tries to do
  I/O, we don't need to have it open.

  This changes the output of iotests case 061, which used 'qemu-img info'
  to show that opening an image with an invalid data file fails. After
  this patch, it succeeds. Replace this part of the test with a qemu-io
  call, but keep the final 'qemu-img info' to show that the invalid data
  file is correctly displayed in the output.

  Fixes: CVE-2024-4467
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Hanna Czenczek <hreitz@redhat.com>
  (cherry picked from commit bd385a5298d7062668e804d73944d52aec9549f1)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  d7e7f342c69372baededb664ea9386a28a72fa63:qcow2: Don't open data_file with BDRV_O_NO_IO

  One use case for 'qemu-img info' is verifying that untrusted images
  don't reference an unwanted external file, be it as a backing file or an
  external data file. To make sure that calling 'qemu-img info' can't
  already have undesired side effects with a malicious image, just don't
  open the data file at all with BDRV_O_NO_IO. If nothing ever tries to do
  I/O, we don't need to have it open.

  This changes the output of iotests case 061, which used 'qemu-img info'
  to show that opening an image with an invalid data file fails. After
  this patch, it succeeds. Replace this part of the test with a qemu-io
  call, but keep the final 'qemu-img info' to show that the invalid data
  file is correctly displayed in the output.

  Fixes: CVE-2024-4467
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Hanna Czenczek <hreitz@redhat.com>
  (cherry picked from commit bd385a5298d7062668e804d73944d52aec9549f1)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  312ca4065b236b1c6eea649a3138d6ea79149794:qcow2: Don't open data_file with BDRV_O_NO_IO

  One use case for 'qemu-img info' is verifying that untrusted images
  don't reference an unwanted external file, be it as a backing file or an
  external data file. To make sure that calling 'qemu-img info' can't
  already have undesired side effects with a malicious image, just don't
  open the data file at all with BDRV_O_NO_IO. If nothing ever tries to do
  I/O, we don't need to have it open.

  This changes the output of iotests case 061, which used 'qemu-img info'
  to show that opening an image with an invalid data file fails. After
  this patch, it succeeds. Replace this part of the test with a qemu-io
  call, but keep the final 'qemu-img info' to show that the invalid data
  file is correctly displayed in the output.

  Fixes: CVE-2024-4467
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Hanna Czenczek <hreitz@redhat.com>
  (cherry picked from commit bd385a5298d7062668e804d73944d52aec9549f1)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  727f4a780033bd29e63de4443e0461af05c93eaa:Merge tag 'for-upstream' of https://repo.or.cz/qemu/kevin into staging

  Block layer patches (CVE-2024-4467)

  - Don't open qcow2 data files in 'qemu-img info'
  - Disallow protocol prefixes for qcow2 data files, VMDK extent files and
    other child nodes that are neither 'file' nor 'backing'

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJFBAABCAAvFiEE3D3rFZqa+V09dFb+fwmycsiPL9YFAmaEKQwRHGt3b2xmQHJl
  # ZGhhdC5jb20ACgkQfwmycsiPL9YgMA/+OeQf0veFb02ZNqf907Etz8/DvnqbiWUN
  # 0aT5z5x8ilZQIiEDbFtLKgF3A/WO7phyCKk1q1dbRNbc1ZaWFW7mTaJM2ew++EuB
  # fq0mnskLt/GVSqTReO4od7flsssp3sEDxs74yuyNITIUqui4we9WK2lLRiAv3aco
  # 2NbyNeMHJxIW+QlOO3R62i24yjQaLyg/YekmiIK8itQkpKuI80fiVgor5W3RR0P0
  # 71AVSHC0Edv5eavmiRqmQ+pfSI8tlINsN1s5jvxge6XpVTaL8NHsgH3LVv1R3Qtx
  # Uo9hp6lQboAfc4I06gf+fcsYSBRiGCwA/J+JsWusX4FLaaTNHLt5eJAEJhfZlioj
  # wgTqpy2ImRu5lcuLjLWRu4cLapPLI6CSwf4/lG9/szmRA/1UtOKpquKeTuCwMl9Y
  # XEVoNDzo7GpfSb7YONo7fU7kq00OuEEAn0he7eNd2UU+Ao9Abi7JvY+fKx71FHo3
  # k24SQVhVJihV1IEC4psCtaQm2bB/jdMr0jB44zHLtmqeUMLrrVf64cSAntp+2KRa
  # sINBXA5OeblGKQ7FoAzc5NNNveSdF1ioRCvKB3MlHzI+efzRS7+I3wwh2Uz1Uwfo
  # sivg+dAXQQBKVXn8UbfznFyEKueT0RW5CUbfeEqGQ/ocw7iTrXABsX+tjcktxl8Q
  # zrHZNoAz6Ds=
  # =7LWn
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Tue 02 Jul 2024 09:21:32 AM PDT
  # gpg:                using RSA key DC3DEB159A9AF95D3D7456FE7F09B272C88F2FD6
  # gpg:                issuer "kwolf@redhat.com"
  # gpg: Good signature from "Kevin Wolf <kwolf@redhat.com>" [full]

  * tag 'for-upstream' of https://repo.or.cz/qemu/kevin:
    block: Parse filenames only when explicitly requested
    iotests/270: Don't store data-file with json: prefix in image
    iotests/244: Don't store data-file with protocol in image
    qcow2: Don't open data_file with BDRV_O_NO_IO

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  bd385a5298d7062668e804d73944d52aec9549f1:qcow2: Don't open data_file with BDRV_O_NO_IO

  One use case for 'qemu-img info' is verifying that untrusted images
  don't reference an unwanted external file, be it as a backing file or an
  external data file. To make sure that calling 'qemu-img info' can't
  already have undesired side effects with a malicious image, just don't
  open the data file at all with BDRV_O_NO_IO. If nothing ever tries to do
  I/O, we don't need to have it open.

  This changes the output of iotests case 061, which used 'qemu-img info'
  to show that opening an image with an invalid data file fails. After
  this patch, it succeeds. Replace this part of the test with a qemu-io
  call, but keep the final 'qemu-img info' to show that the invalid data
  file is correctly displayed in the output.

  Fixes: CVE-2024-4467
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Hanna Czenczek <hreitz@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 2e909d7ca95e6d395bd282a5bbf775c4b4eac10f
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: bd385a5298d7062668e804d73944d52aec9549f1
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 149bc216f295380b1a7b96e518f34bdbc9aecd6e
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 727f4a780033bd29e63de4443e0461af05c93eaa
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d7e7f342c69372baededb664ea9386a28a72fa63
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 312ca4065b236b1c6eea649a3138d6ea79149794
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
