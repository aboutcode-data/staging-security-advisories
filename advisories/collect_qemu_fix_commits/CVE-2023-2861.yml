advisory_id: CVE-2023-2861
datasource_id: collect_qemu_fix_commits/CVE-2023-2861
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  922f8888a06e2431961851593db78aa5a46fd3b9:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  922f8888a06e2431961851593db78aa5a46fd3b9:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  922f8888a06e2431961851593db78aa5a46fd3b9:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  9e1cacffdb3d460e9f95c5d1fdb4d14a5487a1be:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  9e1cacffdb3d460e9f95c5d1fdb4d14a5487a1be:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  9e1cacffdb3d460e9f95c5d1fdb4d14a5487a1be:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  361f29fe1bc6c847b108442d573fcd2690d6db4b:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  361f29fe1bc6c847b108442d573fcd2690d6db4b:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  361f29fe1bc6c847b108442d573fcd2690d6db4b:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  (cherry picked from commit d06a9d843fb65351e0e4dc42ba0c404f01ea92b3)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  b5e3f63a4a78e8c172507bf9853b7b638c5da44a:Merge tag 'pull-9p-20241210' of https://github.com/cschoenebeck/qemu into staging

  * Fix a regression regarding CVE-2023-2861 with security_model=passthrough
    which caused certain sockets on guest to fail.

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJLBAABCgA1FiEEltjREM96+AhPiFkBNMK1h2Wkc5UFAmdYErEXHHFlbXVfb3Nz
  # QGNydWRlYnl0ZS5jb20ACgkQNMK1h2Wkc5UaYRAAiyQ/o1Ex7u2SpKzVs5VWSS9j
  # AgtF9FD4S9m6XMY+7VvX2KrUK/r5zUzjDiZyKTBT+TqczFIWvV6N2bb9II+PS1if
  # LwRCPk4jwl7ptk9r2/+jSLeQ9a1D58p8VsSaJCJWOwKuupy45L4iWQsyIhscdKve
  # 13Zjc0SZOOcN3A5Q9HdMjDLuW1WXlxf+UzRnca1CpDLfx0ubMIL4YGYB7Rm0JG+A
  # OaJT2Sd71JH7TU88j0sVhVFMy/TUY+zSrU2GJ/Y1ESK2w8MxYH2VyDvNnXd5tlqV
  # RcBCY86cZfeDdxf1xu/WOGAhDbi++tlQtu+bSYZiMdlYDB7C4yZgtdMTVhSPstlK
  # 1jndtbh4zUNeWpMA5LIwQ14JmjSUG/ea6EXN1i6xy6rCsFrhhEmG+MOxPm+SsnSv
  # OtL9RwKfx3nuCuVhurjc/1JNxCSthYJPivzBN52B3Gh2zBvUCmHz5DL2YLI1fYYd
  # YTxbSkMOBTxIL5tf7e2Zyfu1HezSNEMjJAX9wxu/GY7T+bWJBjIinMVBHEzBiAdB
  # aHuScq37uxZH1B8NmddZvgitCP7m18K2jVutNE0GFy4VQkogKIUEh+2b5N2y0nUi
  # eKS7iue/6CJyfQCrucN1hR60xPJXMtApi/7sNW9+b5H7fbIcdPzL93Xo58CfYZPt
  # kdlqod3W+ivvKqjeGvY=
  # =7A03
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Tue 10 Dec 2024 10:06:41 GMT
  # gpg:                using RSA key 96D8D110CF7AF8084F88590134C2B58765A47395
  # gpg:                issuer "qemu_oss@crudebyte.com"
  # gpg: Good signature from "Christian Schoenebeck <qemu_oss@crudebyte.com>" [unknown]
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: ECAB 1A45 4014 1413 BA38  4926 30DB 47C3 A012 D5F4
  #      Subkey fingerprint: 96D8 D110 CF7A F808 4F88  5901 34C2 B587 65A4 7395

  * tag 'pull-9p-20241210' of https://github.com/cschoenebeck/qemu:
    9pfs: fix regression regarding CVE-2023-2861

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  b5e3f63a4a78e8c172507bf9853b7b638c5da44a:Merge tag 'pull-9p-20241210' of https://github.com/cschoenebeck/qemu into staging

  * Fix a regression regarding CVE-2023-2861 with security_model=passthrough
    which caused certain sockets on guest to fail.

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJLBAABCgA1FiEEltjREM96+AhPiFkBNMK1h2Wkc5UFAmdYErEXHHFlbXVfb3Nz
  # QGNydWRlYnl0ZS5jb20ACgkQNMK1h2Wkc5UaYRAAiyQ/o1Ex7u2SpKzVs5VWSS9j
  # AgtF9FD4S9m6XMY+7VvX2KrUK/r5zUzjDiZyKTBT+TqczFIWvV6N2bb9II+PS1if
  # LwRCPk4jwl7ptk9r2/+jSLeQ9a1D58p8VsSaJCJWOwKuupy45L4iWQsyIhscdKve
  # 13Zjc0SZOOcN3A5Q9HdMjDLuW1WXlxf+UzRnca1CpDLfx0ubMIL4YGYB7Rm0JG+A
  # OaJT2Sd71JH7TU88j0sVhVFMy/TUY+zSrU2GJ/Y1ESK2w8MxYH2VyDvNnXd5tlqV
  # RcBCY86cZfeDdxf1xu/WOGAhDbi++tlQtu+bSYZiMdlYDB7C4yZgtdMTVhSPstlK
  # 1jndtbh4zUNeWpMA5LIwQ14JmjSUG/ea6EXN1i6xy6rCsFrhhEmG+MOxPm+SsnSv
  # OtL9RwKfx3nuCuVhurjc/1JNxCSthYJPivzBN52B3Gh2zBvUCmHz5DL2YLI1fYYd
  # YTxbSkMOBTxIL5tf7e2Zyfu1HezSNEMjJAX9wxu/GY7T+bWJBjIinMVBHEzBiAdB
  # aHuScq37uxZH1B8NmddZvgitCP7m18K2jVutNE0GFy4VQkogKIUEh+2b5N2y0nUi
  # eKS7iue/6CJyfQCrucN1hR60xPJXMtApi/7sNW9+b5H7fbIcdPzL93Xo58CfYZPt
  # kdlqod3W+ivvKqjeGvY=
  # =7A03
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Tue 10 Dec 2024 10:06:41 GMT
  # gpg:                using RSA key 96D8D110CF7AF8084F88590134C2B58765A47395
  # gpg:                issuer "qemu_oss@crudebyte.com"
  # gpg: Good signature from "Christian Schoenebeck <qemu_oss@crudebyte.com>" [unknown]
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: ECAB 1A45 4014 1413 BA38  4926 30DB 47C3 A012 D5F4
  #      Subkey fingerprint: 96D8 D110 CF7A F808 4F88  5901 34C2 B587 65A4 7395

  * tag 'pull-9p-20241210' of https://github.com/cschoenebeck/qemu:
    9pfs: fix regression regarding CVE-2023-2861

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  d06a9d843fb65351e0e4dc42ba0c404f01ea92b3:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  d06a9d843fb65351e0e4dc42ba0c404f01ea92b3:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  d06a9d843fb65351e0e4dc42ba0c404f01ea92b3:9pfs: fix regression regarding CVE-2023-2861

  The released fix for this CVE:

    f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")

  caused a regression with security_model=passthrough. When handling a
  'Tmknod' request there was a side effect that 'Tmknod' request could fail
  as 9p server was trying to adjust permissions:

    #6  close_if_special_file (fd=30) at ../hw/9pfs/9p-util.h:140
    #7  openat_file (mode=<optimized out>, flags=2228224,
        name=<optimized out>, dirfd=<optimized out>) at
        ../hw/9pfs/9p-util.h:181
    #8  fchmodat_nofollow (dirfd=dirfd@entry=31,
        name=name@entry=0x5555577ea6e0 "mysocket", mode=493) at
        ../hw/9pfs/9p-local.c:360
    #9  local_set_cred_passthrough (credp=0x7ffbbc4ace10, name=0x5555577ea6e0
        "mysocket", dirfd=31, fs_ctx=0x55555811f528) at
        ../hw/9pfs/9p-local.c:457
    #10 local_mknod (fs_ctx=0x55555811f528, dir_path=<optimized out>,
        name=0x5555577ea6e0 "mysocket", credp=0x7ffbbc4ace10) at
        ../hw/9pfs/9p-local.c:702
    #11 v9fs_co_mknod (pdu=pdu@entry=0x555558121140,
        fidp=fidp@entry=0x5555574c46c0, name=name@entry=0x7ffbbc4aced0,
        uid=1000, gid=1000, dev=<optimized out>, mode=49645,
        stbuf=0x7ffbbc4acef0) at ../hw/9pfs/cofs.c:205
    #12 v9fs_mknod (opaque=0x555558121140) at ../hw/9pfs/9p.c:3711

  That's because server was opening the special file to adjust permissions,
  however it was using O_PATH and it would have not returned the file
  descriptor to guest. So the call to close_if_special_file() on that branch
  was incorrect.

  Let's lift the restriction introduced by f6b0de53fb8 such that it would
  allow to open special files on host if O_PATH flag is supplied, not only
  for 9p server's own operations as described above, but also for any client
  'Topen' request.

  It is safe to allow opening special files with O_PATH on host, because
  O_PATH only allows path based operations on the resulting file descriptor
  and prevents I/O such as read() and write() on that file descriptor.

  Fixes: f6b0de53fb8 ("9pfs: prevent opening special files (CVE-2023-2861)")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2337
  Reported-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Tested-by: Dirk Herrendorfer <d.herrendoerfer@de.ibm.com>
  Message-Id: <E1tJWbk-007BH4-OB@kylie.crudebyte.com>
  71d72ececa086114df80fe4cc04d701b59002eb2:9pfs: deprecate 'proxy' backend

  As recent CVE-2023-2861 (fixed by f6b0de53fb) once again showed, the 9p
  'proxy' fs driver is in bad shape. Using the 'proxy' backend was already
  discouraged for safety reasons before and we recommended to use the
  'local' backend (preferably in conjunction with its 'mapped' security
  model) instead, but now it is time to officially deprecate the 'proxy'
  backend.

  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Message-Id: <E1qDkmw-0007M1-8f@lizzy.crudebyte.com>
  10fad73a2bf1c76c8aa9d6322755e5f877d83ce5:9pfs: prevent opening special files (CVE-2023-2861)

  The 9p protocol does not specifically define how server shall behave when
  client tries to open a special file, however from security POV it does
  make sense for 9p server to prohibit opening any special file on host side
  in general. A sane Linux 9p client for instance would never attempt to
  open a special file on host side, it would always handle those exclusively
  on its guest side. A malicious client however could potentially escape
  from the exported 9p tree by creating and opening a device file on host
  side.

  With QEMU this could only be exploited in the following unsafe setups:

    - Running QEMU binary as root AND 9p 'local' fs driver AND 'passthrough'
      security model.

  or

    - Using 9p 'proxy' fs driver (which is running its helper daemon as
      root).

  These setups were already discouraged for safety reasons before,
  however for obvious reasons we are now tightening behaviour on this.

  Fixes: CVE-2023-2861
  Reported-by: Yanwu Shen <ywsPlz@gmail.com>
  Reported-by: Jietao Xiao <shawtao1125@gmail.com>
  Reported-by: Jinku Li <jkli@xidian.edu.cn>
  Reported-by: Wenbo Shen <shenwenbo@zju.edu.cn>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  Message-Id: <E1q6w7r-0000Q0-NM@lizzy.crudebyte.com>
  (cherry picked from commit f6b0de53fb87ddefed348a39284c8e2f28dc4eda)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  (Mjt: drop adding qemu_fstat wrapper for 7.2 where wrappers aren't used)
  10fad73a2bf1c76c8aa9d6322755e5f877d83ce5:9pfs: prevent opening special files (CVE-2023-2861)

  The 9p protocol does not specifically define how server shall behave when
  client tries to open a special file, however from security POV it does
  make sense for 9p server to prohibit opening any special file on host side
  in general. A sane Linux 9p client for instance would never attempt to
  open a special file on host side, it would always handle those exclusively
  on its guest side. A malicious client however could potentially escape
  from the exported 9p tree by creating and opening a device file on host
  side.

  With QEMU this could only be exploited in the following unsafe setups:

    - Running QEMU binary as root AND 9p 'local' fs driver AND 'passthrough'
      security model.

  or

    - Using 9p 'proxy' fs driver (which is running its helper daemon as
      root).

  These setups were already discouraged for safety reasons before,
  however for obvious reasons we are now tightening behaviour on this.

  Fixes: CVE-2023-2861
  Reported-by: Yanwu Shen <ywsPlz@gmail.com>
  Reported-by: Jietao Xiao <shawtao1125@gmail.com>
  Reported-by: Jinku Li <jkli@xidian.edu.cn>
  Reported-by: Wenbo Shen <shenwenbo@zju.edu.cn>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  Message-Id: <E1q6w7r-0000Q0-NM@lizzy.crudebyte.com>
  (cherry picked from commit f6b0de53fb87ddefed348a39284c8e2f28dc4eda)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  (Mjt: drop adding qemu_fstat wrapper for 7.2 where wrappers aren't used)
  b9d2887be4e616cdaeedd0b7456bfaa71ee798af:9pfs: prevent opening special files (CVE-2023-2861)

  The 9p protocol does not specifically define how server shall behave when
  client tries to open a special file, however from security POV it does
  make sense for 9p server to prohibit opening any special file on host side
  in general. A sane Linux 9p client for instance would never attempt to
  open a special file on host side, it would always handle those exclusively
  on its guest side. A malicious client however could potentially escape
  from the exported 9p tree by creating and opening a device file on host
  side.

  With QEMU this could only be exploited in the following unsafe setups:

    - Running QEMU binary as root AND 9p 'local' fs driver AND 'passthrough'
      security model.

  or

    - Using 9p 'proxy' fs driver (which is running its helper daemon as
      root).

  These setups were already discouraged for safety reasons before,
  however for obvious reasons we are now tightening behaviour on this.

  Fixes: CVE-2023-2861
  Reported-by: Yanwu Shen <ywsPlz@gmail.com>
  Reported-by: Jietao Xiao <shawtao1125@gmail.com>
  Reported-by: Jinku Li <jkli@xidian.edu.cn>
  Reported-by: Wenbo Shen <shenwenbo@zju.edu.cn>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  Message-Id: <E1q6w7r-0000Q0-NM@lizzy.crudebyte.com>
  (cherry picked from commit f6b0de53fb87ddefed348a39284c8e2f28dc4eda)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  b9d2887be4e616cdaeedd0b7456bfaa71ee798af:9pfs: prevent opening special files (CVE-2023-2861)

  The 9p protocol does not specifically define how server shall behave when
  client tries to open a special file, however from security POV it does
  make sense for 9p server to prohibit opening any special file on host side
  in general. A sane Linux 9p client for instance would never attempt to
  open a special file on host side, it would always handle those exclusively
  on its guest side. A malicious client however could potentially escape
  from the exported 9p tree by creating and opening a device file on host
  side.

  With QEMU this could only be exploited in the following unsafe setups:

    - Running QEMU binary as root AND 9p 'local' fs driver AND 'passthrough'
      security model.

  or

    - Using 9p 'proxy' fs driver (which is running its helper daemon as
      root).

  These setups were already discouraged for safety reasons before,
  however for obvious reasons we are now tightening behaviour on this.

  Fixes: CVE-2023-2861
  Reported-by: Yanwu Shen <ywsPlz@gmail.com>
  Reported-by: Jietao Xiao <shawtao1125@gmail.com>
  Reported-by: Jinku Li <jkli@xidian.edu.cn>
  Reported-by: Wenbo Shen <shenwenbo@zju.edu.cn>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  Message-Id: <E1q6w7r-0000Q0-NM@lizzy.crudebyte.com>
  (cherry picked from commit f6b0de53fb87ddefed348a39284c8e2f28dc4eda)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  5f9dd6a8ce3961db4ce47411ed2097ad88bdf5fc:Merge tag 'pull-9p-20230608' of https://github.com/cschoenebeck/qemu into staging

  * Fix for CVE-2023-2861.

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJLBAABCgA1FiEEltjREM96+AhPiFkBNMK1h2Wkc5UFAmSB7yMXHHFlbXVfb3Nz
  # QGNydWRlYnl0ZS5jb20ACgkQNMK1h2Wkc5XykxAAzQb+d2clDVyj3Y3UqcB/YS7X
  # ijxoZph9ObweyPiP2IThjsAcvNPnVR2Bc8bgEpihRkpEYGNLicw5BSk1SjqOgZvg
  # buDRc8bOvOOrKqvYEBXbzaS/OHVIdozn8h+WNjX0jSsdUd4uq9vcwX+uqshkPwl+
  # L4Ipx7ChzmHpaEigkVLh1biQEkLPRCTplny5JK/ZzvAmGVaqYb1usbSx//OVu7k+
  # gBuBALmvJQst3iz/1e+bmVg+JhyxRqcHfCJuuWxaOLIyiZME3ZhTn7tp+2ilivRj
  # n4/AGglTAv+yaVwRi6XEca7GND23HqFs26RPGgZrIhsAkFV03Iz3IT/BJ3Psy3Qv
  # 7KYE4FhhReDnNU5JNfCbNxUPWVilwLY83BXVL9I0CADbAHgTqRSnataQ/PY26VQp
  # BqKJKmxjAEnmsGVZSgRuCDDOhOBlPUPMRFINCUp2b0qujsUQaV5XHUlQ3qRfjUBc
  # JQCy1LrxcSINg7oTRPZczNcrb9iWtaOfD24OGGeW1O6ihCAV0CYaRSmHUhFVPOPR
  # uu4LWnbSToNgfNxBXaMk3vHA0SzWxJl7zBi53GVRvn8ciiTkAPVIoZLf0W8jE47X
  # 5nkzfTpNdjnQJlaKAfDx+YcAyBUPxiknJjAJmjF/mquAtW8c9XbsCVJpyUgS4Lna
  # GNfRoCUHQ6+6ui+/zM0=
  # =6Vxp
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Thu 08 Jun 2023 08:09:23 AM PDT
  # gpg:                using RSA key 96D8D110CF7AF8084F88590134C2B58765A47395
  # gpg:                issuer "qemu_oss@crudebyte.com"
  # gpg: Good signature from "Christian Schoenebeck <qemu_oss@crudebyte.com>" [unknown]
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: ECAB 1A45 4014 1413 BA38  4926 30DB 47C3 A012 D5F4
  #      Subkey fingerprint: 96D8 D110 CF7A F808 4F88  5901 34C2 B587 65A4 7395

  * tag 'pull-9p-20230608' of https://github.com/cschoenebeck/qemu:
    9pfs: prevent opening special files (CVE-2023-2861)

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  5f9dd6a8ce3961db4ce47411ed2097ad88bdf5fc:Merge tag 'pull-9p-20230608' of https://github.com/cschoenebeck/qemu into staging

  * Fix for CVE-2023-2861.

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJLBAABCgA1FiEEltjREM96+AhPiFkBNMK1h2Wkc5UFAmSB7yMXHHFlbXVfb3Nz
  # QGNydWRlYnl0ZS5jb20ACgkQNMK1h2Wkc5XykxAAzQb+d2clDVyj3Y3UqcB/YS7X
  # ijxoZph9ObweyPiP2IThjsAcvNPnVR2Bc8bgEpihRkpEYGNLicw5BSk1SjqOgZvg
  # buDRc8bOvOOrKqvYEBXbzaS/OHVIdozn8h+WNjX0jSsdUd4uq9vcwX+uqshkPwl+
  # L4Ipx7ChzmHpaEigkVLh1biQEkLPRCTplny5JK/ZzvAmGVaqYb1usbSx//OVu7k+
  # gBuBALmvJQst3iz/1e+bmVg+JhyxRqcHfCJuuWxaOLIyiZME3ZhTn7tp+2ilivRj
  # n4/AGglTAv+yaVwRi6XEca7GND23HqFs26RPGgZrIhsAkFV03Iz3IT/BJ3Psy3Qv
  # 7KYE4FhhReDnNU5JNfCbNxUPWVilwLY83BXVL9I0CADbAHgTqRSnataQ/PY26VQp
  # BqKJKmxjAEnmsGVZSgRuCDDOhOBlPUPMRFINCUp2b0qujsUQaV5XHUlQ3qRfjUBc
  # JQCy1LrxcSINg7oTRPZczNcrb9iWtaOfD24OGGeW1O6ihCAV0CYaRSmHUhFVPOPR
  # uu4LWnbSToNgfNxBXaMk3vHA0SzWxJl7zBi53GVRvn8ciiTkAPVIoZLf0W8jE47X
  # 5nkzfTpNdjnQJlaKAfDx+YcAyBUPxiknJjAJmjF/mquAtW8c9XbsCVJpyUgS4Lna
  # GNfRoCUHQ6+6ui+/zM0=
  # =6Vxp
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Thu 08 Jun 2023 08:09:23 AM PDT
  # gpg:                using RSA key 96D8D110CF7AF8084F88590134C2B58765A47395
  # gpg:                issuer "qemu_oss@crudebyte.com"
  # gpg: Good signature from "Christian Schoenebeck <qemu_oss@crudebyte.com>" [unknown]
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: ECAB 1A45 4014 1413 BA38  4926 30DB 47C3 A012 D5F4
  #      Subkey fingerprint: 96D8 D110 CF7A F808 4F88  5901 34C2 B587 65A4 7395

  * tag 'pull-9p-20230608' of https://github.com/cschoenebeck/qemu:
    9pfs: prevent opening special files (CVE-2023-2861)

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  f6b0de53fb87ddefed348a39284c8e2f28dc4eda:9pfs: prevent opening special files (CVE-2023-2861)

  The 9p protocol does not specifically define how server shall behave when
  client tries to open a special file, however from security POV it does
  make sense for 9p server to prohibit opening any special file on host side
  in general. A sane Linux 9p client for instance would never attempt to
  open a special file on host side, it would always handle those exclusively
  on its guest side. A malicious client however could potentially escape
  from the exported 9p tree by creating and opening a device file on host
  side.

  With QEMU this could only be exploited in the following unsafe setups:

    - Running QEMU binary as root AND 9p 'local' fs driver AND 'passthrough'
      security model.

  or

    - Using 9p 'proxy' fs driver (which is running its helper daemon as
      root).

  These setups were already discouraged for safety reasons before,
  however for obvious reasons we are now tightening behaviour on this.

  Fixes: CVE-2023-2861
  Reported-by: Yanwu Shen <ywsPlz@gmail.com>
  Reported-by: Jietao Xiao <shawtao1125@gmail.com>
  Reported-by: Jinku Li <jkli@xidian.edu.cn>
  Reported-by: Wenbo Shen <shenwenbo@zju.edu.cn>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  Message-Id: <E1q6w7r-0000Q0-NM@lizzy.crudebyte.com>
  f6b0de53fb87ddefed348a39284c8e2f28dc4eda:9pfs: prevent opening special files (CVE-2023-2861)

  The 9p protocol does not specifically define how server shall behave when
  client tries to open a special file, however from security POV it does
  make sense for 9p server to prohibit opening any special file on host side
  in general. A sane Linux 9p client for instance would never attempt to
  open a special file on host side, it would always handle those exclusively
  on its guest side. A malicious client however could potentially escape
  from the exported 9p tree by creating and opening a device file on host
  side.

  With QEMU this could only be exploited in the following unsafe setups:

    - Running QEMU binary as root AND 9p 'local' fs driver AND 'passthrough'
      security model.

  or

    - Using 9p 'proxy' fs driver (which is running its helper daemon as
      root).

  These setups were already discouraged for safety reasons before,
  however for obvious reasons we are now tightening behaviour on this.

  Fixes: CVE-2023-2861
  Reported-by: Yanwu Shen <ywsPlz@gmail.com>
  Reported-by: Jietao Xiao <shawtao1125@gmail.com>
  Reported-by: Jinku Li <jkli@xidian.edu.cn>
  Reported-by: Wenbo Shen <shenwenbo@zju.edu.cn>
  Signed-off-by: Christian Schoenebeck <qemu_oss@crudebyte.com>
  Reviewed-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  Message-Id: <E1q6w7r-0000Q0-NM@lizzy.crudebyte.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9e1cacffdb3d460e9f95c5d1fdb4d14a5487a1be
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b9d2887be4e616cdaeedd0b7456bfaa71ee798af
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 71d72ececa086114df80fe4cc04d701b59002eb2
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 922f8888a06e2431961851593db78aa5a46fd3b9
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 5f9dd6a8ce3961db4ce47411ed2097ad88bdf5fc
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 10fad73a2bf1c76c8aa9d6322755e5f877d83ce5
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f6b0de53fb87ddefed348a39284c8e2f28dc4eda
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b5e3f63a4a78e8c172507bf9853b7b638c5da44a
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 361f29fe1bc6c847b108442d573fcd2690d6db4b
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d06a9d843fb65351e0e4dc42ba0c404f01ea92b3
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
