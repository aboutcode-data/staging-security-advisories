advisory_id: CVE-2020-10761
datasource_id: collect_qemu_fix_commits/CVE-2020-10761
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  d48973dc26f9f852eb32b89ae33db717d192df5c:nbd/server: Avoid long error message assertions CVE-2020-10761

  Ever since commit 36683283 (v2.8), the server code asserts that error
  strings sent to the client are well-formed per the protocol by not
  exceeding the maximum string length of 4096.  At the time the server
  first started sending error messages, the assertion could not be
  triggered, because messages were completely under our control.
  However, over the years, we have added latent scenarios where a client
  could trigger the server to attempt an error message that would
  include the client's information if it passed other checks first:

  - requesting NBD_OPT_INFO/GO on an export name that is not present
    (commit 0cfae925 in v2.12 echoes the name)

  - requesting NBD_OPT_LIST/SET_META_CONTEXT on an export name that is
    not present (commit e7b1948d in v2.12 echoes the name)

  At the time, those were still safe because we flagged names larger
  than 256 bytes with a different message; but that changed in commit
  93676c88 (v4.2) when we raised the name limit to 4096 to match the NBD
  string limit.  (That commit also failed to change the magic number
  4096 in nbd_negotiate_send_rep_err to the just-introduced named
  constant.)  So with that commit, long client names appended to server
  text can now trigger the assertion, and thus be used as a denial of
  service attack against a server.  As a mitigating factor, if the
  server requires TLS, the client cannot trigger the problematic paths
  unless it first supplies TLS credentials, and such trusted clients are
  less likely to try to intentionally crash the server.

  We may later want to further sanitize the user-supplied strings we
  place into our error messages, such as scrubbing out control
  characters, but that is less important to the CVE fix, so it can be a
  later patch to the new nbd_sanitize_name.

  Consideration was given to changing the assertion in
  nbd_negotiate_send_rep_verr to instead merely log a server error and
  truncate the message, to avoid leaving a latent path that could
  trigger a future CVE DoS on any new error message.  However, this
  merely complicates the code for something that is already (correctly)
  flagging coding errors, and now that we are aware of the long message
  pitfall, we are less likely to introduce such errors in the future,
  which would make such error handling dead code.

  Reported-by: Xueqiang Wei <xuwei@redhat.com>
  CC: qemu-stable@nongnu.org
  Fixes: https://bugzilla.redhat.com/1843684 CVE-2020-10761
  Fixes: 93676c88d7
  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-Id: <20200610163741.3745251-2-eblake@redhat.com>
  Reviewed-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
  (cherry picked from commit 5c4fe018c025740fef4a0a4421e8162db0c3eefd)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  d48973dc26f9f852eb32b89ae33db717d192df5c:nbd/server: Avoid long error message assertions CVE-2020-10761

  Ever since commit 36683283 (v2.8), the server code asserts that error
  strings sent to the client are well-formed per the protocol by not
  exceeding the maximum string length of 4096.  At the time the server
  first started sending error messages, the assertion could not be
  triggered, because messages were completely under our control.
  However, over the years, we have added latent scenarios where a client
  could trigger the server to attempt an error message that would
  include the client's information if it passed other checks first:

  - requesting NBD_OPT_INFO/GO on an export name that is not present
    (commit 0cfae925 in v2.12 echoes the name)

  - requesting NBD_OPT_LIST/SET_META_CONTEXT on an export name that is
    not present (commit e7b1948d in v2.12 echoes the name)

  At the time, those were still safe because we flagged names larger
  than 256 bytes with a different message; but that changed in commit
  93676c88 (v4.2) when we raised the name limit to 4096 to match the NBD
  string limit.  (That commit also failed to change the magic number
  4096 in nbd_negotiate_send_rep_err to the just-introduced named
  constant.)  So with that commit, long client names appended to server
  text can now trigger the assertion, and thus be used as a denial of
  service attack against a server.  As a mitigating factor, if the
  server requires TLS, the client cannot trigger the problematic paths
  unless it first supplies TLS credentials, and such trusted clients are
  less likely to try to intentionally crash the server.

  We may later want to further sanitize the user-supplied strings we
  place into our error messages, such as scrubbing out control
  characters, but that is less important to the CVE fix, so it can be a
  later patch to the new nbd_sanitize_name.

  Consideration was given to changing the assertion in
  nbd_negotiate_send_rep_verr to instead merely log a server error and
  truncate the message, to avoid leaving a latent path that could
  trigger a future CVE DoS on any new error message.  However, this
  merely complicates the code for something that is already (correctly)
  flagging coding errors, and now that we are aware of the long message
  pitfall, we are less likely to introduce such errors in the future,
  which would make such error handling dead code.

  Reported-by: Xueqiang Wei <xuwei@redhat.com>
  CC: qemu-stable@nongnu.org
  Fixes: https://bugzilla.redhat.com/1843684 CVE-2020-10761
  Fixes: 93676c88d7
  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-Id: <20200610163741.3745251-2-eblake@redhat.com>
  Reviewed-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
  (cherry picked from commit 5c4fe018c025740fef4a0a4421e8162db0c3eefd)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  0c1d805360a5b8590614471388f8bbb6d5697db5:nbd/server: Avoid long error message assertions CVE-2020-10761

  Ever since commit 36683283 (v2.8), the server code asserts that error
  strings sent to the client are well-formed per the protocol by not
  exceeding the maximum string length of 4096.  At the time the server
  first started sending error messages, the assertion could not be
  triggered, because messages were completely under our control.
  However, over the years, we have added latent scenarios where a client
  could trigger the server to attempt an error message that would
  include the client's information if it passed other checks first:

  - requesting NBD_OPT_INFO/GO on an export name that is not present
    (commit 0cfae925 in v2.12 echoes the name)

  - requesting NBD_OPT_LIST/SET_META_CONTEXT on an export name that is
    not present (commit e7b1948d in v2.12 echoes the name)

  At the time, those were still safe because we flagged names larger
  than 256 bytes with a different message; but that changed in commit
  93676c88 (v4.2) when we raised the name limit to 4096 to match the NBD
  string limit.  (That commit also failed to change the magic number
  4096 in nbd_negotiate_send_rep_err to the just-introduced named
  constant.)  So with that commit, long client names appended to server
  text can now trigger the assertion, and thus be used as a denial of
  service attack against a server.  As a mitigating factor, if the
  server requires TLS, the client cannot trigger the problematic paths
  unless it first supplies TLS credentials, and such trusted clients are
  less likely to try to intentionally crash the server.

  We may later want to further sanitize the user-supplied strings we
  place into our error messages, such as scrubbing out control
  characters, but that is less important to the CVE fix, so it can be a
  later patch to the new nbd_sanitize_name.

  Consideration was given to changing the assertion in
  nbd_negotiate_send_rep_verr to instead merely log a server error and
  truncate the message, to avoid leaving a latent path that could
  trigger a future CVE DoS on any new error message.  However, this
  merely complicates the code for something that is already (correctly)
  flagging coding errors, and now that we are aware of the long message
  pitfall, we are less likely to introduce such errors in the future,
  which would make such error handling dead code.

  Reported-by: Xueqiang Wei <xuwei@redhat.com>
  CC: qemu-stable@nongnu.org
  Fixes: https://bugzilla.redhat.com/1843684 CVE-2020-10761
  Fixes: 93676c88d7
  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-Id: <20200610163741.3745251-2-eblake@redhat.com>
  Reviewed-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
  (cherry picked from commit 5c4fe018c025740fef4a0a4421e8162db0c3eefd)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  0c1d805360a5b8590614471388f8bbb6d5697db5:nbd/server: Avoid long error message assertions CVE-2020-10761

  Ever since commit 36683283 (v2.8), the server code asserts that error
  strings sent to the client are well-formed per the protocol by not
  exceeding the maximum string length of 4096.  At the time the server
  first started sending error messages, the assertion could not be
  triggered, because messages were completely under our control.
  However, over the years, we have added latent scenarios where a client
  could trigger the server to attempt an error message that would
  include the client's information if it passed other checks first:

  - requesting NBD_OPT_INFO/GO on an export name that is not present
    (commit 0cfae925 in v2.12 echoes the name)

  - requesting NBD_OPT_LIST/SET_META_CONTEXT on an export name that is
    not present (commit e7b1948d in v2.12 echoes the name)

  At the time, those were still safe because we flagged names larger
  than 256 bytes with a different message; but that changed in commit
  93676c88 (v4.2) when we raised the name limit to 4096 to match the NBD
  string limit.  (That commit also failed to change the magic number
  4096 in nbd_negotiate_send_rep_err to the just-introduced named
  constant.)  So with that commit, long client names appended to server
  text can now trigger the assertion, and thus be used as a denial of
  service attack against a server.  As a mitigating factor, if the
  server requires TLS, the client cannot trigger the problematic paths
  unless it first supplies TLS credentials, and such trusted clients are
  less likely to try to intentionally crash the server.

  We may later want to further sanitize the user-supplied strings we
  place into our error messages, such as scrubbing out control
  characters, but that is less important to the CVE fix, so it can be a
  later patch to the new nbd_sanitize_name.

  Consideration was given to changing the assertion in
  nbd_negotiate_send_rep_verr to instead merely log a server error and
  truncate the message, to avoid leaving a latent path that could
  trigger a future CVE DoS on any new error message.  However, this
  merely complicates the code for something that is already (correctly)
  flagging coding errors, and now that we are aware of the long message
  pitfall, we are less likely to introduce such errors in the future,
  which would make such error handling dead code.

  Reported-by: Xueqiang Wei <xuwei@redhat.com>
  CC: qemu-stable@nongnu.org
  Fixes: https://bugzilla.redhat.com/1843684 CVE-2020-10761
  Fixes: 93676c88d7
  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-Id: <20200610163741.3745251-2-eblake@redhat.com>
  Reviewed-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
  (cherry picked from commit 5c4fe018c025740fef4a0a4421e8162db0c3eefd)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  9f1f264edbdf5516d6f208497310b3eedbc7b74c:Merge remote-tracking branch 'remotes/ericb/tags/pull-nbd-2020-06-09-v2' into staging

  NBD patches for 2020-06-09

  - fix iotest 194 race
  - fix CVE-2020-10761: server DoS from assertion on long NBD error messages

  # gpg: Signature made Wed 10 Jun 2020 18:59:19 BST
  # gpg:                using RSA key 71C2CC22B1C4602927D2F3AAA7A16B4A2527436A
  # gpg: Good signature from "Eric Blake <eblake@redhat.com>" [full]
  # gpg:                 aka "Eric Blake (Free Software Programmer) <ebb9@byu.net>" [full]
  # gpg:                 aka "[jpeg image of size 6874]" [full]
  # Primary key fingerprint: 71C2 CC22 B1C4 6029 27D2  F3AA A7A1 6B4A 2527 436A

  * remotes/ericb/tags/pull-nbd-2020-06-09-v2:
    block: Call attention to truncation of long NBD exports
    nbd/server: Avoid long error message assertions CVE-2020-10761
    iotests: 194: wait for migration completion on target too

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  9f1f264edbdf5516d6f208497310b3eedbc7b74c:Merge remote-tracking branch 'remotes/ericb/tags/pull-nbd-2020-06-09-v2' into staging

  NBD patches for 2020-06-09

  - fix iotest 194 race
  - fix CVE-2020-10761: server DoS from assertion on long NBD error messages

  # gpg: Signature made Wed 10 Jun 2020 18:59:19 BST
  # gpg:                using RSA key 71C2CC22B1C4602927D2F3AAA7A16B4A2527436A
  # gpg: Good signature from "Eric Blake <eblake@redhat.com>" [full]
  # gpg:                 aka "Eric Blake (Free Software Programmer) <ebb9@byu.net>" [full]
  # gpg:                 aka "[jpeg image of size 6874]" [full]
  # Primary key fingerprint: 71C2 CC22 B1C4 6029 27D2  F3AA A7A1 6B4A 2527 436A

  * remotes/ericb/tags/pull-nbd-2020-06-09-v2:
    block: Call attention to truncation of long NBD exports
    nbd/server: Avoid long error message assertions CVE-2020-10761
    iotests: 194: wait for migration completion on target too

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  5c4fe018c025740fef4a0a4421e8162db0c3eefd:nbd/server: Avoid long error message assertions CVE-2020-10761

  Ever since commit 36683283 (v2.8), the server code asserts that error
  strings sent to the client are well-formed per the protocol by not
  exceeding the maximum string length of 4096.  At the time the server
  first started sending error messages, the assertion could not be
  triggered, because messages were completely under our control.
  However, over the years, we have added latent scenarios where a client
  could trigger the server to attempt an error message that would
  include the client's information if it passed other checks first:

  - requesting NBD_OPT_INFO/GO on an export name that is not present
    (commit 0cfae925 in v2.12 echoes the name)

  - requesting NBD_OPT_LIST/SET_META_CONTEXT on an export name that is
    not present (commit e7b1948d in v2.12 echoes the name)

  At the time, those were still safe because we flagged names larger
  than 256 bytes with a different message; but that changed in commit
  93676c88 (v4.2) when we raised the name limit to 4096 to match the NBD
  string limit.  (That commit also failed to change the magic number
  4096 in nbd_negotiate_send_rep_err to the just-introduced named
  constant.)  So with that commit, long client names appended to server
  text can now trigger the assertion, and thus be used as a denial of
  service attack against a server.  As a mitigating factor, if the
  server requires TLS, the client cannot trigger the problematic paths
  unless it first supplies TLS credentials, and such trusted clients are
  less likely to try to intentionally crash the server.

  We may later want to further sanitize the user-supplied strings we
  place into our error messages, such as scrubbing out control
  characters, but that is less important to the CVE fix, so it can be a
  later patch to the new nbd_sanitize_name.

  Consideration was given to changing the assertion in
  nbd_negotiate_send_rep_verr to instead merely log a server error and
  truncate the message, to avoid leaving a latent path that could
  trigger a future CVE DoS on any new error message.  However, this
  merely complicates the code for something that is already (correctly)
  flagging coding errors, and now that we are aware of the long message
  pitfall, we are less likely to introduce such errors in the future,
  which would make such error handling dead code.

  Reported-by: Xueqiang Wei <xuwei@redhat.com>
  CC: qemu-stable@nongnu.org
  Fixes: https://bugzilla.redhat.com/1843684 CVE-2020-10761
  Fixes: 93676c88d7
  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-Id: <20200610163741.3745251-2-eblake@redhat.com>
  Reviewed-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
  5c4fe018c025740fef4a0a4421e8162db0c3eefd:nbd/server: Avoid long error message assertions CVE-2020-10761

  Ever since commit 36683283 (v2.8), the server code asserts that error
  strings sent to the client are well-formed per the protocol by not
  exceeding the maximum string length of 4096.  At the time the server
  first started sending error messages, the assertion could not be
  triggered, because messages were completely under our control.
  However, over the years, we have added latent scenarios where a client
  could trigger the server to attempt an error message that would
  include the client's information if it passed other checks first:

  - requesting NBD_OPT_INFO/GO on an export name that is not present
    (commit 0cfae925 in v2.12 echoes the name)

  - requesting NBD_OPT_LIST/SET_META_CONTEXT on an export name that is
    not present (commit e7b1948d in v2.12 echoes the name)

  At the time, those were still safe because we flagged names larger
  than 256 bytes with a different message; but that changed in commit
  93676c88 (v4.2) when we raised the name limit to 4096 to match the NBD
  string limit.  (That commit also failed to change the magic number
  4096 in nbd_negotiate_send_rep_err to the just-introduced named
  constant.)  So with that commit, long client names appended to server
  text can now trigger the assertion, and thus be used as a denial of
  service attack against a server.  As a mitigating factor, if the
  server requires TLS, the client cannot trigger the problematic paths
  unless it first supplies TLS credentials, and such trusted clients are
  less likely to try to intentionally crash the server.

  We may later want to further sanitize the user-supplied strings we
  place into our error messages, such as scrubbing out control
  characters, but that is less important to the CVE fix, so it can be a
  later patch to the new nbd_sanitize_name.

  Consideration was given to changing the assertion in
  nbd_negotiate_send_rep_verr to instead merely log a server error and
  truncate the message, to avoid leaving a latent path that could
  trigger a future CVE DoS on any new error message.  However, this
  merely complicates the code for something that is already (correctly)
  flagging coding errors, and now that we are aware of the long message
  pitfall, we are less likely to introduce such errors in the future,
  which would make such error handling dead code.

  Reported-by: Xueqiang Wei <xuwei@redhat.com>
  CC: qemu-stable@nongnu.org
  Fixes: https://bugzilla.redhat.com/1843684 CVE-2020-10761
  Fixes: 93676c88d7
  Signed-off-by: Eric Blake <eblake@redhat.com>
  Message-Id: <20200610163741.3745251-2-eblake@redhat.com>
  Reviewed-by: Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d48973dc26f9f852eb32b89ae33db717d192df5c
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 5c4fe018c025740fef4a0a4421e8162db0c3eefd
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9f1f264edbdf5516d6f208497310b3eedbc7b74c
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 0c1d805360a5b8590614471388f8bbb6d5697db5
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
