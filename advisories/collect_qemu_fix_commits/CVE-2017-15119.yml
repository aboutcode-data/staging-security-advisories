advisory_id: CVE-2017-15119
datasource_id: collect_qemu_fix_commits/CVE-2017-15119
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  2ce8993512fb5e6ba4d4f62cecd159d3862a9a7e:nbd/server: CVE-2017-15119 Reject options larger than 32M

  The NBD spec gives us permission to abruptly disconnect on clients
  that send outrageously large option requests, rather than having
  to spend the time reading to the end of the option.  No real
  option request requires that much data anyways; and meanwhile, we
  already have the practice of abruptly dropping the connection on
  any client that sends NBD_CMD_WRITE with a payload larger than 32M.

  For comparison, nbdkit drops the connection on any request with
  more than 4096 bytes; however, that limit is probably too low
  (as the NBD spec states an export name can theoretically be up
  to 4096 bytes, which means a valid NBD_OPT_INFO could be even
  longer) - even if qemu doesn't permit exports longer than 256
  bytes.

  It could be argued that a malicious client trying to get us to
  read nearly 4G of data on a bad request is a form of denial of
  service.  In particular, if the server requires TLS, but a client
  that does not know the TLS credentials sends any option (other
  than NBD_OPT_STARTTLS or NBD_OPT_EXPORT_NAME) with a stated
  payload of nearly 4G, then the server was keeping the connection
  alive trying to read all the payload, tying up resources that it
  would rather be spending on a client that can get past the TLS
  handshake.  Hence, this warranted a CVE.

  Present since at least 2.5 when handling known options, and made
  worse in 2.6 when fixing support for NBD_FLAG_C_FIXED_NEWSTYLE
  to handle unknown options.

  CC: qemu-stable@nongnu.org
  Signed-off-by: Eric Blake <eblake@redhat.com>
  (cherry picked from commit fdad35ef6c5839d50dfc14073364ac893afebc30)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  844496f3e55a2155200fdcf7f6320acef03d4e9f:Merge remote-tracking branch 'remotes/ericb/tags/pull-nbd-2017-11-28' into staging

  nbd patches for 2017-11-28

  Eric Blake - 0/2 fix two NBD server CVEs

  # gpg: Signature made Tue 28 Nov 2017 12:58:29 GMT
  # gpg:                using RSA key 0xA7A16B4A2527436A
  # gpg: Good signature from "Eric Blake <eblake@redhat.com>"
  # gpg:                 aka "Eric Blake (Free Software Programmer) <ebb9@byu.net>"
  # gpg:                 aka "[jpeg image of size 6874]"
  # Primary key fingerprint: 71C2 CC22 B1C4 6029 27D2  F3AA A7A1 6B4A 2527 436A

  * remotes/ericb/tags/pull-nbd-2017-11-28:
    nbd/server: CVE-2017-15118 Stack smash on large export name
    nbd/server: CVE-2017-15119 Reject options larger than 32M

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  fdad35ef6c5839d50dfc14073364ac893afebc30:nbd/server: CVE-2017-15119 Reject options larger than 32M

  The NBD spec gives us permission to abruptly disconnect on clients
  that send outrageously large option requests, rather than having
  to spend the time reading to the end of the option.  No real
  option request requires that much data anyways; and meanwhile, we
  already have the practice of abruptly dropping the connection on
  any client that sends NBD_CMD_WRITE with a payload larger than 32M.

  For comparison, nbdkit drops the connection on any request with
  more than 4096 bytes; however, that limit is probably too low
  (as the NBD spec states an export name can theoretically be up
  to 4096 bytes, which means a valid NBD_OPT_INFO could be even
  longer) - even if qemu doesn't permit exports longer than 256
  bytes.

  It could be argued that a malicious client trying to get us to
  read nearly 4G of data on a bad request is a form of denial of
  service.  In particular, if the server requires TLS, but a client
  that does not know the TLS credentials sends any option (other
  than NBD_OPT_STARTTLS or NBD_OPT_EXPORT_NAME) with a stated
  payload of nearly 4G, then the server was keeping the connection
  alive trying to read all the payload, tying up resources that it
  would rather be spending on a client that can get past the TLS
  handshake.  Hence, this warranted a CVE.

  Present since at least 2.5 when handling known options, and made
  worse in 2.6 when fixing support for NBD_FLAG_C_FIXED_NEWSTYLE
  to handle unknown options.

  CC: qemu-stable@nongnu.org
  Signed-off-by: Eric Blake <eblake@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 844496f3e55a2155200fdcf7f6320acef03d4e9f
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 2ce8993512fb5e6ba4d4f62cecd159d3862a9a7e
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: fdad35ef6c5839d50dfc14073364ac893afebc30
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
