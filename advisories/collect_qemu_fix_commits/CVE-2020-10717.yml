advisory_id: CVE-2020-10717
datasource_id: collect_qemu_fix_commits/CVE-2020-10717
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  c1abbd0f047e81ea5441baa586c5e3e9901318aa:virtiofsd: stay below fs.file-max sysctl value (CVE-2020-10717)

  The system-wide fs.file-max sysctl value determines how many files can
  be open.  It defaults to a value calculated based on the machine's RAM
  size.  Previously virtiofsd would try to set RLIMIT_NOFILE to 1,000,000
  and this allowed the FUSE client to exhaust the number of open files
  system-wide on Linux hosts with less than 10 GB of RAM!

  Take fs.file-max into account when choosing the default RLIMIT_NOFILE
  value.

  Fixes: CVE-2020-10717
  Reported-by: Yuval Avrahami <yavrahami@paloaltonetworks.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  Message-Id: <20200501140644.220940-3-stefanha@redhat.com>
  Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  (cherry picked from commit 8c1d353d107b4fc344e27f2f08ea7fa25de2eea2)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  c1abbd0f047e81ea5441baa586c5e3e9901318aa:virtiofsd: stay below fs.file-max sysctl value (CVE-2020-10717)

  The system-wide fs.file-max sysctl value determines how many files can
  be open.  It defaults to a value calculated based on the machine's RAM
  size.  Previously virtiofsd would try to set RLIMIT_NOFILE to 1,000,000
  and this allowed the FUSE client to exhaust the number of open files
  system-wide on Linux hosts with less than 10 GB of RAM!

  Take fs.file-max into account when choosing the default RLIMIT_NOFILE
  value.

  Fixes: CVE-2020-10717
  Reported-by: Yuval Avrahami <yavrahami@paloaltonetworks.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  Message-Id: <20200501140644.220940-3-stefanha@redhat.com>
  Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  (cherry picked from commit 8c1d353d107b4fc344e27f2f08ea7fa25de2eea2)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  6897541d902218b31eef2e8eabc74fa56618f9b3:Merge remote-tracking branch 'remotes/dgilbert-gitlab/tags/pull-virtiofs-20200501' into staging

  virtiofsd: Pull 2020-05-01 (includes CVE fix)

  This set includes a security fix, other fixes and improvements.

  Security fix:
  The security fix is for CVE-2020-10717 where, on low RAM hosts,
  the guest can potentially exceed the maximum fd limit.
  This fix adds some more configuration so that the user
  can explicitly set the limit.

  Fixes:

  Recursive mounting of the exported directory is now used in
  the sandbox, such that if there was a mount underneath present at
  the time the virtiofsd was started, that mount is also
  visible to the guest; in the existing code, only mounts that
  happened after startup were visible.

  Security improvements:

  The jailing for /proc/self/fd is improved - but it's something
  that shouldn't be accessible anyway.

  Most capabilities are now dropped at startup; again this shouldn't
  change any behaviour but is extra protection.

  # gpg: Signature made Fri 01 May 2020 20:06:46 BST
  # gpg:                using RSA key 45F5C71B4A0CB7FB977A9FA90516331EBC5BFDE7
  # gpg: Good signature from "Dr. David Alan Gilbert (RH2) <dgilbert@redhat.com>" [full]
  # Primary key fingerprint: 45F5 C71B 4A0C B7FB 977A  9FA9 0516 331E BC5B FDE7

  * remotes/dgilbert-gitlab/tags/pull-virtiofs-20200501:
    virtiofsd: drop all capabilities in the wait parent process
    virtiofsd: only retain file system capabilities
    virtiofsd: Show submounts
    virtiofsd: jail lo->proc_self_fd
    virtiofsd: stay below fs.file-max sysctl value (CVE-2020-10717)
    virtiofsd: add --rlimit-nofile=NUM option

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  6897541d902218b31eef2e8eabc74fa56618f9b3:Merge remote-tracking branch 'remotes/dgilbert-gitlab/tags/pull-virtiofs-20200501' into staging

  virtiofsd: Pull 2020-05-01 (includes CVE fix)

  This set includes a security fix, other fixes and improvements.

  Security fix:
  The security fix is for CVE-2020-10717 where, on low RAM hosts,
  the guest can potentially exceed the maximum fd limit.
  This fix adds some more configuration so that the user
  can explicitly set the limit.

  Fixes:

  Recursive mounting of the exported directory is now used in
  the sandbox, such that if there was a mount underneath present at
  the time the virtiofsd was started, that mount is also
  visible to the guest; in the existing code, only mounts that
  happened after startup were visible.

  Security improvements:

  The jailing for /proc/self/fd is improved - but it's something
  that shouldn't be accessible anyway.

  Most capabilities are now dropped at startup; again this shouldn't
  change any behaviour but is extra protection.

  # gpg: Signature made Fri 01 May 2020 20:06:46 BST
  # gpg:                using RSA key 45F5C71B4A0CB7FB977A9FA90516331EBC5BFDE7
  # gpg: Good signature from "Dr. David Alan Gilbert (RH2) <dgilbert@redhat.com>" [full]
  # Primary key fingerprint: 45F5 C71B 4A0C B7FB 977A  9FA9 0516 331E BC5B FDE7

  * remotes/dgilbert-gitlab/tags/pull-virtiofs-20200501:
    virtiofsd: drop all capabilities in the wait parent process
    virtiofsd: only retain file system capabilities
    virtiofsd: Show submounts
    virtiofsd: jail lo->proc_self_fd
    virtiofsd: stay below fs.file-max sysctl value (CVE-2020-10717)
    virtiofsd: add --rlimit-nofile=NUM option

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  8c1d353d107b4fc344e27f2f08ea7fa25de2eea2:virtiofsd: stay below fs.file-max sysctl value (CVE-2020-10717)

  The system-wide fs.file-max sysctl value determines how many files can
  be open.  It defaults to a value calculated based on the machine's RAM
  size.  Previously virtiofsd would try to set RLIMIT_NOFILE to 1,000,000
  and this allowed the FUSE client to exhaust the number of open files
  system-wide on Linux hosts with less than 10 GB of RAM!

  Take fs.file-max into account when choosing the default RLIMIT_NOFILE
  value.

  Fixes: CVE-2020-10717
  Reported-by: Yuval Avrahami <yavrahami@paloaltonetworks.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  Message-Id: <20200501140644.220940-3-stefanha@redhat.com>
  Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  8c1d353d107b4fc344e27f2f08ea7fa25de2eea2:virtiofsd: stay below fs.file-max sysctl value (CVE-2020-10717)

  The system-wide fs.file-max sysctl value determines how many files can
  be open.  It defaults to a value calculated based on the machine's RAM
  size.  Previously virtiofsd would try to set RLIMIT_NOFILE to 1,000,000
  and this allowed the FUSE client to exhaust the number of open files
  system-wide on Linux hosts with less than 10 GB of RAM!

  Take fs.file-max into account when choosing the default RLIMIT_NOFILE
  value.

  Fixes: CVE-2020-10717
  Reported-by: Yuval Avrahami <yavrahami@paloaltonetworks.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
  Message-Id: <20200501140644.220940-3-stefanha@redhat.com>
  Signed-off-by: Dr. David Alan Gilbert <dgilbert@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: c1abbd0f047e81ea5441baa586c5e3e9901318aa
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 6897541d902218b31eef2e8eabc74fa56618f9b3
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 8c1d353d107b4fc344e27f2f08ea7fa25de2eea2
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
