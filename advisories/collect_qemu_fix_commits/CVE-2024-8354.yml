advisory_id: CVE-2024-8354
datasource_id: collect_qemu_fix_commits/CVE-2024-8354
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  2ef88536a905a867260732541dd9a9661120e608:hw/usb/hcd-uhci: don't assert for SETUP to non-0 endpoint

  If the guest feeds invalid data to the UHCI controller, we
  can assert:
  qemu-system-x86_64: ../../hw/usb/core.c:744: usb_ep_get: Assertion `pid == USB_TOKEN_IN || pid == USB_TOKEN_OUT' failed.

  (see issue 2548 for the repro case).  This happens because the guest
  attempts USB_TOKEN_SETUP to an endpoint other than 0, which is not
  valid.  The controller code doesn't catch this guest error, so
  instead we hit the assertion in the USB core code.

  Catch the case of SETUP to non-zero endpoint, and treat it as a fatal
  error in the TD, in the same way we do for an invalid PID value in
  the TD.

  This is the UHCI equivalent of the same bug in OHCI that we fixed in
  commit 3c3c233677 ("hw/usb/hcd-ohci: Fix #1510, #303: pid not IN or
  OUT").

  This bug has been tracked as CVE-2024-8354.

  Cc: qemu-stable@nongnu.org
  Fixes: https://gitlab.com/qemu-project/qemu/-/issues/2548
  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  (cherry picked from commit d0af3cd0274e265435170a583c72b9f0a4100dff)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  746269eaae16423572ae7c0dfeb66140fa882149:hw/usb/hcd-uhci: don't assert for SETUP to non-0 endpoint

  If the guest feeds invalid data to the UHCI controller, we
  can assert:
  qemu-system-x86_64: ../../hw/usb/core.c:744: usb_ep_get: Assertion `pid == USB_TOKEN_IN || pid == USB_TOKEN_OUT' failed.

  (see issue 2548 for the repro case).  This happens because the guest
  attempts USB_TOKEN_SETUP to an endpoint other than 0, which is not
  valid.  The controller code doesn't catch this guest error, so
  instead we hit the assertion in the USB core code.

  Catch the case of SETUP to non-zero endpoint, and treat it as a fatal
  error in the TD, in the same way we do for an invalid PID value in
  the TD.

  This is the UHCI equivalent of the same bug in OHCI that we fixed in
  commit 3c3c233677 ("hw/usb/hcd-ohci: Fix #1510, #303: pid not IN or
  OUT").

  This bug has been tracked as CVE-2024-8354.

  Cc: qemu-stable@nongnu.org
  Fixes: https://gitlab.com/qemu-project/qemu/-/issues/2548
  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  (cherry picked from commit d0af3cd0274e265435170a583c72b9f0a4100dff)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  dfae27159d00de9259f95cf578784cfccb56ce04:hw/usb/hcd-uhci: don't assert for SETUP to non-0 endpoint

  If the guest feeds invalid data to the UHCI controller, we
  can assert:
  qemu-system-x86_64: ../../hw/usb/core.c:744: usb_ep_get: Assertion `pid == USB_TOKEN_IN || pid == USB_TOKEN_OUT' failed.

  (see issue 2548 for the repro case).  This happens because the guest
  attempts USB_TOKEN_SETUP to an endpoint other than 0, which is not
  valid.  The controller code doesn't catch this guest error, so
  instead we hit the assertion in the USB core code.

  Catch the case of SETUP to non-zero endpoint, and treat it as a fatal
  error in the TD, in the same way we do for an invalid PID value in
  the TD.

  This is the UHCI equivalent of the same bug in OHCI that we fixed in
  commit 3c3c233677 ("hw/usb/hcd-ohci: Fix #1510, #303: pid not IN or
  OUT").

  This bug has been tracked as CVE-2024-8354.

  Cc: qemu-stable@nongnu.org
  Fixes: https://gitlab.com/qemu-project/qemu/-/issues/2548
  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
  (cherry picked from commit d0af3cd0274e265435170a583c72b9f0a4100dff)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  d0af3cd0274e265435170a583c72b9f0a4100dff:hw/usb/hcd-uhci: don't assert for SETUP to non-0 endpoint

  If the guest feeds invalid data to the UHCI controller, we
  can assert:
  qemu-system-x86_64: ../../hw/usb/core.c:744: usb_ep_get: Assertion `pid == USB_TOKEN_IN || pid == USB_TOKEN_OUT' failed.

  (see issue 2548 for the repro case).  This happens because the guest
  attempts USB_TOKEN_SETUP to an endpoint other than 0, which is not
  valid.  The controller code doesn't catch this guest error, so
  instead we hit the assertion in the USB core code.

  Catch the case of SETUP to non-zero endpoint, and treat it as a fatal
  error in the TD, in the same way we do for an invalid PID value in
  the TD.

  This is the UHCI equivalent of the same bug in OHCI that we fixed in
  commit 3c3c233677 ("hw/usb/hcd-ohci: Fix #1510, #303: pid not IN or
  OUT").

  This bug has been tracked as CVE-2024-8354.

  Cc: qemu-stable@nongnu.org
  Fixes: https://gitlab.com/qemu-project/qemu/-/issues/2548
  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  Reviewed-by: Michael Tokarev <mjt@tls.msk.ru>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 2ef88536a905a867260732541dd9a9661120e608
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 746269eaae16423572ae7c0dfeb66140fa882149
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d0af3cd0274e265435170a583c72b9f0a4100dff
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: dfae27159d00de9259f95cf578784cfccb56ce04
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
