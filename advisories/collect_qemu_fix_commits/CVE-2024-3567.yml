advisory_id: CVE-2024-3567
datasource_id: collect_qemu_fix_commits/CVE-2024-3567
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  1cfe45956e03070f894e91b304e233b4d5b99719:hw/net/net_tx_pkt: Fix overrun in update_sctp_checksum()

  If a fragmented packet size is too short, do not try to
  calculate its checksum.

  Reproduced using:

    $ cat << EOF | qemu-system-i386 -display none -nodefaults \
                                    -machine q35,accel=qtest -m 32M \
                                    -device igb,netdev=net0 \
                                    -netdev user,id=net0 \
                                    -qtest stdio
    outl 0xcf8 0x80000810
    outl 0xcfc 0xe0000000
    outl 0xcf8 0x80000804
    outw 0xcfc 0x06
    write 0xe0000403 0x1 0x02
    writel 0xe0003808 0xffffffff
    write 0xe000381a 0x1 0x5b
    write 0xe000381b 0x1 0x00
    EOF
    Assertion failed: (offset == 0), function iov_from_buf_full, file util/iov.c, line 39.
    #1 0x5575e81e952a in iov_from_buf_full qemu/util/iov.c:39:5
    #2 0x5575e6500768 in net_tx_pkt_update_sctp_checksum qemu/hw/net/net_tx_pkt.c:144:9
    #3 0x5575e659f3e1 in igb_setup_tx_offloads qemu/hw/net/igb_core.c:478:11
    #4 0x5575e659f3e1 in igb_tx_pkt_send qemu/hw/net/igb_core.c:552:10
    #5 0x5575e659f3e1 in igb_process_tx_desc qemu/hw/net/igb_core.c:671:17
    #6 0x5575e659f3e1 in igb_start_xmit qemu/hw/net/igb_core.c:903:9
    #7 0x5575e659f3e1 in igb_set_tdt qemu/hw/net/igb_core.c:2812:5
    #8 0x5575e657d6a4 in igb_core_write qemu/hw/net/igb_core.c:4248:9

  Fixes: CVE-2024-3567
  Cc: qemu-stable@nongnu.org
  Reported-by: Zheyu Ma <zheyuma97@gmail.com>
  Fixes: f199b13bc1 ("igb: Implement Tx SCTP CSO")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2273
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Akihiko Odaki <akihiko.odaki@daynix.com>
  Acked-by: Jason Wang <jasowang@redhat.com>
  Message-Id: <20240410070459.49112-1-philmd@linaro.org>
  (cherry picked from commit 83ddb3dbba2ee0f1767442ae6ee665058aeb1093)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  f243175727903a0d2b52422e7baef86c1838a895:Merge tag 'hw-misc-20240410' of https://github.com/philmd/qemu into staging

  Misc HW patch queue

  - Fix CXL Fixed Memory Window interleave-granularity typo
  - Fix for DMA re-entrancy abuse with VirtIO devices (CVE-2024-3446)
  - Fix out-of-bound access in NAND block buffer
  - Fix memory leak in AppleSMC reset() handler
  - Avoid VirtIO crypto backends abort o invalid session ID
  - Fix overflow in LAN9118 MIL TX FIFO
  - Fix overflow when abusing SDHCI TRNMOD register (CVE-2024-3447)
  - Fix overrun in short fragmented packet SCTP checksum (CVE-2024-3567)
  - Remove unused assignment in virtio-snd model (Coverity 1542933 & 1542934)

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQIzBAABCAAdFiEE+qvnXhKRciHc/Wuy4+MsLN6twN4FAmYWV94ACgkQ4+MsLN6t
  # wN4+ew/+PqDmL4S8xXGQPi6Q8fxAogbwo1mPptDO2y8ChEjtc9LI5HOLu90EYz7A
  # s62SPDsh3gx8vOthrJVEk0LqCbw4N3s5dFdmHNrnjXCsKQFifgucQ+yZy8ipy34N
  # wWHSJ9nipBQLvkK23iCxkbl3cTyr44Rlweae/TZR4/FjFCEe3N555LQU0fruEqRo
  # AHW1RjYhGvOfL9knLWzIQqW2QjcCnKky3bJhwHh3crfWE69nvVJTkbSF6oUxWSG0
  # RzSToK3nN5tmvUlyvbTBE9u0K9JkOcbtMQiAgj39nR9xpsaUZZa0zSWOmliYIuBC
  # kWuUY0/nAQk6gxHBKyu8q09ACBbzeCp+lVPOYXdxax8QMeURSa9fB1qY7JmI5QAZ
  # bg0ypD2pvbxhidU5TWpw7araAYyBOJrEYjnOkhXB4oa01ZWu2d0uNhGWo83h3Wjy
  # ahKrNDoVIQIdh8QkYy/ZqDwhCMoNM+pQcfUzsYxkqZC/JiiM/qxm87pTHQ/x2yQA
  # l0MLzljGv90/dklokrqeg4REwMqfwzc74PUbKdCk43saemmatslK3ktu3xAzUlQW
  # 2xmZQTnKwXDf+U3YnYryDddow2LsU7qlu8dlDGNd0WIrE5LRCCXzhv8la66O0jVE
  # qMOHpBPkwMlACBwiXuxV6ucelk4vy+XvabeQUsizm0m+PR7TwJY=
  # =9phd
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Wed 10 Apr 2024 10:11:58 BST
  # gpg:                using RSA key FAABE75E12917221DCFD6BB2E3E32C2CDEADC0DE
  # gpg: Good signature from "Philippe Mathieu-Daudé (F4BUG) <f4bug@amsat.org>" [full]
  # Primary key fingerprint: FAAB E75E 1291 7221 DCFD  6BB2 E3E3 2C2C DEAD C0DE

  * tag 'hw-misc-20240410' of https://github.com/philmd/qemu:
    hw/audio/virtio-snd: Remove unused assignment
    hw/net/net_tx_pkt: Fix overrun in update_sctp_checksum()
    hw/sd/sdhci: Do not update TRNMOD when Command Inhibit (DAT) is set
    hw/net/lan9118: Fix overflow in MIL TX FIFO
    hw/net/lan9118: Replace magic '2048' value by MIL_TXFIFO_SIZE definition
    backends/cryptodev: Do not abort for invalid session ID
    hw/misc/applesmc: Fix memory leak in reset() handler
    hw/misc/applesmc: Do not call DeviceReset from DeviceRealize
    hw/block/nand: Fix out-of-bound access in NAND block buffer
    hw/block/nand: Have blk_load() take unsigned offset and return boolean
    hw/block/nand: Factor nand_load_iolen() method out
    qemu-options: Fix CXL Fixed Memory Window interleave-granularity typo
    hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs
    hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs
    hw/display/virtio-gpu: Protect from DMA re-entrancy bugs
    hw/virtio: Introduce virtio_bh_new_guarded() helper

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  83ddb3dbba2ee0f1767442ae6ee665058aeb1093:hw/net/net_tx_pkt: Fix overrun in update_sctp_checksum()

  If a fragmented packet size is too short, do not try to
  calculate its checksum.

  Reproduced using:

    $ cat << EOF | qemu-system-i386 -display none -nodefaults \
                                    -machine q35,accel=qtest -m 32M \
                                    -device igb,netdev=net0 \
                                    -netdev user,id=net0 \
                                    -qtest stdio
    outl 0xcf8 0x80000810
    outl 0xcfc 0xe0000000
    outl 0xcf8 0x80000804
    outw 0xcfc 0x06
    write 0xe0000403 0x1 0x02
    writel 0xe0003808 0xffffffff
    write 0xe000381a 0x1 0x5b
    write 0xe000381b 0x1 0x00
    EOF
    Assertion failed: (offset == 0), function iov_from_buf_full, file util/iov.c, line 39.
    #1 0x5575e81e952a in iov_from_buf_full qemu/util/iov.c:39:5
    #2 0x5575e6500768 in net_tx_pkt_update_sctp_checksum qemu/hw/net/net_tx_pkt.c:144:9
    #3 0x5575e659f3e1 in igb_setup_tx_offloads qemu/hw/net/igb_core.c:478:11
    #4 0x5575e659f3e1 in igb_tx_pkt_send qemu/hw/net/igb_core.c:552:10
    #5 0x5575e659f3e1 in igb_process_tx_desc qemu/hw/net/igb_core.c:671:17
    #6 0x5575e659f3e1 in igb_start_xmit qemu/hw/net/igb_core.c:903:9
    #7 0x5575e659f3e1 in igb_set_tdt qemu/hw/net/igb_core.c:2812:5
    #8 0x5575e657d6a4 in igb_core_write qemu/hw/net/igb_core.c:4248:9

  Fixes: CVE-2024-3567
  Cc: qemu-stable@nongnu.org
  Reported-by: Zheyu Ma <zheyuma97@gmail.com>
  Fixes: f199b13bc1 ("igb: Implement Tx SCTP CSO")
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/2273
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Akihiko Odaki <akihiko.odaki@daynix.com>
  Acked-by: Jason Wang <jasowang@redhat.com>
  Message-Id: <20240410070459.49112-1-philmd@linaro.org>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 1cfe45956e03070f894e91b304e233b4d5b99719
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f243175727903a0d2b52422e7baef86c1838a895
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 83ddb3dbba2ee0f1767442ae6ee665058aeb1093
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
