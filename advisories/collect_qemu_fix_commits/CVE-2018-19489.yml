advisory_id: CVE-2018-19489
datasource_id: collect_qemu_fix_commits/CVE-2018-19489
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  d086829e5ba00d75637cd6ab51c4f291f62db941:9p: fix QEMU crash when renaming files

  When using the 9P2000.u version of the protocol, the following shell
  command line in the guest can cause QEMU to crash:

      while true; do rm -rf aa; mkdir -p a/b & touch a/b/c & mv a aa; done

  With 9P2000.u, file renaming is handled by the WSTAT command. The
  v9fs_wstat() function calls v9fs_complete_rename(), which calls
  v9fs_fix_path() for every fid whose path is affected by the change.
  The involved calls to v9fs_path_copy() may race with any other access
  to the fid path performed by some worker thread, causing a crash like
  shown below:

  Thread 12 "qemu-system-x86" received signal SIGSEGV, Segmentation fault.
  0x0000555555a25da2 in local_open_nofollow (fs_ctx=0x555557d958b8, path=0x0,
   flags=65536, mode=0) at hw/9pfs/9p-local.c:59
  59          while (*path && fd != -1) {
  (gdb) bt
  #0  0x0000555555a25da2 in local_open_nofollow (fs_ctx=0x555557d958b8,
   path=0x0, flags=65536, mode=0) at hw/9pfs/9p-local.c:59
  #1  0x0000555555a25e0c in local_opendir_nofollow (fs_ctx=0x555557d958b8,
   path=0x0) at hw/9pfs/9p-local.c:92
  #2  0x0000555555a261b8 in local_lstat (fs_ctx=0x555557d958b8,
   fs_path=0x555556b56858, stbuf=0x7fff84830ef0) at hw/9pfs/9p-local.c:185
  #3  0x0000555555a2b367 in v9fs_co_lstat (pdu=0x555557d97498,
   path=0x555556b56858, stbuf=0x7fff84830ef0) at hw/9pfs/cofile.c:53
  #4  0x0000555555a1e9e2 in v9fs_stat (opaque=0x555557d97498)
   at hw/9pfs/9p.c:1083
  #5  0x0000555555e060a2 in coroutine_trampoline (i0=-669165424, i1=32767)
   at util/coroutine-ucontext.c:116
  #6  0x00007fffef4f5600 in __start_context () at /lib64/libc.so.6
  #7  0x0000000000000000 in  ()
  (gdb)

  The fix is to take the path write lock when calling v9fs_complete_rename(),
  like in v9fs_rename().

  Impact:  DoS triggered by unprivileged guest users.

  Fixes: CVE-2018-19489
  Cc: P J P <ppandit@redhat.com>
  Reported-by: zhibin hu <noirfate@gmail.com>
  Reviewed-by: Prasad J Pandit <pjp@fedoraproject.org>
  Signed-off-by: Greg Kurz <groug@kaod.org>
  (cherry picked from commit 1d20398694a3b67a388d955b7a945ba4aa90a8a8)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  72138f9bf5d8c316043b0d2cc7a674f70930cf95:Merge remote-tracking branch 'remotes/gkurz/tags/for-upstream' into staging

  Fixes a QEMU crash triggerable by guest userspace (CVE-2018-19489).

  # gpg: Signature made Mon 26 Nov 2018 07:25:01 GMT
  # gpg:                using RSA key 71D4D5E5822F73D6
  # gpg: Good signature from "Greg Kurz <groug@kaod.org>"
  # gpg:                 aka "Gregory Kurz <gregory.kurz@free.fr>"
  # gpg:                 aka "[jpeg image of size 3330]"
  # Primary key fingerprint: B482 8BAF 9431 40CE F2A3  4910 71D4 D5E5 822F 73D6

  * remotes/gkurz/tags/for-upstream:
    9p: fix QEMU crash when renaming files

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  1d20398694a3b67a388d955b7a945ba4aa90a8a8:9p: fix QEMU crash when renaming files

  When using the 9P2000.u version of the protocol, the following shell
  command line in the guest can cause QEMU to crash:

      while true; do rm -rf aa; mkdir -p a/b & touch a/b/c & mv a aa; done

  With 9P2000.u, file renaming is handled by the WSTAT command. The
  v9fs_wstat() function calls v9fs_complete_rename(), which calls
  v9fs_fix_path() for every fid whose path is affected by the change.
  The involved calls to v9fs_path_copy() may race with any other access
  to the fid path performed by some worker thread, causing a crash like
  shown below:

  Thread 12 "qemu-system-x86" received signal SIGSEGV, Segmentation fault.
  0x0000555555a25da2 in local_open_nofollow (fs_ctx=0x555557d958b8, path=0x0,
   flags=65536, mode=0) at hw/9pfs/9p-local.c:59
  59          while (*path && fd != -1) {
  (gdb) bt
  #0  0x0000555555a25da2 in local_open_nofollow (fs_ctx=0x555557d958b8,
   path=0x0, flags=65536, mode=0) at hw/9pfs/9p-local.c:59
  #1  0x0000555555a25e0c in local_opendir_nofollow (fs_ctx=0x555557d958b8,
   path=0x0) at hw/9pfs/9p-local.c:92
  #2  0x0000555555a261b8 in local_lstat (fs_ctx=0x555557d958b8,
   fs_path=0x555556b56858, stbuf=0x7fff84830ef0) at hw/9pfs/9p-local.c:185
  #3  0x0000555555a2b367 in v9fs_co_lstat (pdu=0x555557d97498,
   path=0x555556b56858, stbuf=0x7fff84830ef0) at hw/9pfs/cofile.c:53
  #4  0x0000555555a1e9e2 in v9fs_stat (opaque=0x555557d97498)
   at hw/9pfs/9p.c:1083
  #5  0x0000555555e060a2 in coroutine_trampoline (i0=-669165424, i1=32767)
   at util/coroutine-ucontext.c:116
  #6  0x00007fffef4f5600 in __start_context () at /lib64/libc.so.6
  #7  0x0000000000000000 in  ()
  (gdb)

  The fix is to take the path write lock when calling v9fs_complete_rename(),
  like in v9fs_rename().

  Impact:  DoS triggered by unprivileged guest users.

  Fixes: CVE-2018-19489
  Cc: P J P <ppandit@redhat.com>
  Reported-by: zhibin hu <noirfate@gmail.com>
  Reviewed-by: Prasad J Pandit <pjp@fedoraproject.org>
  Signed-off-by: Greg Kurz <groug@kaod.org>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 72138f9bf5d8c316043b0d2cc7a674f70930cf95
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 1d20398694a3b67a388d955b7a945ba4aa90a8a8
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d086829e5ba00d75637cd6ab51c4f291f62db941
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
