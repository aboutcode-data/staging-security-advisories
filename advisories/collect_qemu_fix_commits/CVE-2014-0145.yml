advisory_id: CVE-2014-0145
datasource_id: collect_qemu_fix_commits/CVE-2014-0145
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  d99c4e2d857fbd5e95bf61971d59eb10499289c0:qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)

  For the L1 table to loaded for an internal snapshot, the code allocated
  only enough memory to hold the currently active L1 table. If the
  snapshot's L1 table is actually larger than the current one, this leads
  to a buffer overflow.

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit c05e4667be91b46ab42b5a11babf8e84d476cc6b)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  b6f7fbdd1d9e27822e829e983fb6f907576a24e4:dmg: prevent chunk buffer overflow (CVE-2014-0145)

  Both compressed and uncompressed I/O is buffered.  dmg_open() calculates
  the maximum buffer size needed from the metadata in the image file.

  There is currently a buffer overflow since ->lengths[] is accounted
  against the maximum compressed buffer size but actually uses the
  uncompressed buffer:

    switch (s->types[chunk]) {
    case 1: /* copy */
        ret = bdrv_pread(bs->file, s->offsets[chunk],
                         s->uncompressed_chunk, s->lengths[chunk]);

  We must account against the maximum uncompressed buffer size for type=1
  chunks.

  This patch fixes the maximum buffer size calculation to take into
  account the chunk type.  It is critical that we update the correct
  maximum since there are two buffers ->compressed_chunk and
  ->uncompressed_chunk.

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit f0dce23475b5af5da6b17b97c1765271307734b6)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  758c4840c64d2f0faed18c16c02cbb2c2a3bdfe3:dmg: sanitize chunk length and sectorcount (CVE-2014-0145)

  Chunk length and sectorcount are used for decompression buffers as well
  as the bdrv_pread() count argument.  Ensure that they have reasonable
  values so neither memory allocation nor conversion from uint64_t to int
  will cause problems.

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit c165f7758009a4f793c1fc19ebb69cf55313450b)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  53e11bd384a799c03884bd7d8b5be53f025f8e2d:Merge remote-tracking branch 'remotes/stefanha/tags/block-pull-request' into staging

  Block pull request

  # gpg: Signature made Tue 01 Apr 2014 18:11:16 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/block-pull-request: (51 commits)
    qcow2: link all L2 meta updates in preallocate()
    parallels: Sanity check for s->tracks (CVE-2014-0142)
    parallels: Fix catalog size integer overflow (CVE-2014-0143)
    qcow2: Limit snapshot table size
    qcow2: Check maximum L1 size in qcow2_snapshot_load_tmp() (CVE-2014-0143)
    qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)
    qcow2: Fix NULL dereference in qcow2_open() error path (CVE-2014-0146)
    qcow2: Fix copy_sectors() with VM state
    block: Limit request size (CVE-2014-0143)
    block: vdi bounds check qemu-io tests
    dmg: prevent chunk buffer overflow (CVE-2014-0145)
    dmg: use uint64_t consistently for sectors and lengths
    dmg: sanitize chunk length and sectorcount (CVE-2014-0145)
    dmg: use appropriate types when reading chunks
    dmg: drop broken bdrv_pread() loop
    dmg: prevent out-of-bounds array access on terminator
    dmg: coding style and indentation cleanup
    qcow2: Fix new L1 table size check (CVE-2014-0143)
    qcow2: Protect against some integer overflows in bdrv_check
    qcow2: Fix types in qcow2_alloc_clusters and alloc_clusters_noref
    ...

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  53e11bd384a799c03884bd7d8b5be53f025f8e2d:Merge remote-tracking branch 'remotes/stefanha/tags/block-pull-request' into staging

  Block pull request

  # gpg: Signature made Tue 01 Apr 2014 18:11:16 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/block-pull-request: (51 commits)
    qcow2: link all L2 meta updates in preallocate()
    parallels: Sanity check for s->tracks (CVE-2014-0142)
    parallels: Fix catalog size integer overflow (CVE-2014-0143)
    qcow2: Limit snapshot table size
    qcow2: Check maximum L1 size in qcow2_snapshot_load_tmp() (CVE-2014-0143)
    qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)
    qcow2: Fix NULL dereference in qcow2_open() error path (CVE-2014-0146)
    qcow2: Fix copy_sectors() with VM state
    block: Limit request size (CVE-2014-0143)
    block: vdi bounds check qemu-io tests
    dmg: prevent chunk buffer overflow (CVE-2014-0145)
    dmg: use uint64_t consistently for sectors and lengths
    dmg: sanitize chunk length and sectorcount (CVE-2014-0145)
    dmg: use appropriate types when reading chunks
    dmg: drop broken bdrv_pread() loop
    dmg: prevent out-of-bounds array access on terminator
    dmg: coding style and indentation cleanup
    qcow2: Fix new L1 table size check (CVE-2014-0143)
    qcow2: Protect against some integer overflows in bdrv_check
    qcow2: Fix types in qcow2_alloc_clusters and alloc_clusters_noref
    ...

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  53e11bd384a799c03884bd7d8b5be53f025f8e2d:Merge remote-tracking branch 'remotes/stefanha/tags/block-pull-request' into staging

  Block pull request

  # gpg: Signature made Tue 01 Apr 2014 18:11:16 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/block-pull-request: (51 commits)
    qcow2: link all L2 meta updates in preallocate()
    parallels: Sanity check for s->tracks (CVE-2014-0142)
    parallels: Fix catalog size integer overflow (CVE-2014-0143)
    qcow2: Limit snapshot table size
    qcow2: Check maximum L1 size in qcow2_snapshot_load_tmp() (CVE-2014-0143)
    qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)
    qcow2: Fix NULL dereference in qcow2_open() error path (CVE-2014-0146)
    qcow2: Fix copy_sectors() with VM state
    block: Limit request size (CVE-2014-0143)
    block: vdi bounds check qemu-io tests
    dmg: prevent chunk buffer overflow (CVE-2014-0145)
    dmg: use uint64_t consistently for sectors and lengths
    dmg: sanitize chunk length and sectorcount (CVE-2014-0145)
    dmg: use appropriate types when reading chunks
    dmg: drop broken bdrv_pread() loop
    dmg: prevent out-of-bounds array access on terminator
    dmg: coding style and indentation cleanup
    qcow2: Fix new L1 table size check (CVE-2014-0143)
    qcow2: Protect against some integer overflows in bdrv_check
    qcow2: Fix types in qcow2_alloc_clusters and alloc_clusters_noref
    ...

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  c05e4667be91b46ab42b5a11babf8e84d476cc6b:qcow2: Fix L1 allocation size in qcow2_snapshot_load_tmp() (CVE-2014-0145)

  For the L1 table to loaded for an internal snapshot, the code allocated
  only enough memory to hold the currently active L1 table. If the
  snapshot's L1 table is actually larger than the current one, this leads
  to a buffer overflow.

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  f0dce23475b5af5da6b17b97c1765271307734b6:dmg: prevent chunk buffer overflow (CVE-2014-0145)

  Both compressed and uncompressed I/O is buffered.  dmg_open() calculates
  the maximum buffer size needed from the metadata in the image file.

  There is currently a buffer overflow since ->lengths[] is accounted
  against the maximum compressed buffer size but actually uses the
  uncompressed buffer:

    switch (s->types[chunk]) {
    case 1: /* copy */
        ret = bdrv_pread(bs->file, s->offsets[chunk],
                         s->uncompressed_chunk, s->lengths[chunk]);

  We must account against the maximum uncompressed buffer size for type=1
  chunks.

  This patch fixes the maximum buffer size calculation to take into
  account the chunk type.  It is critical that we update the correct
  maximum since there are two buffers ->compressed_chunk and
  ->uncompressed_chunk.

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  c165f7758009a4f793c1fc19ebb69cf55313450b:dmg: sanitize chunk length and sectorcount (CVE-2014-0145)

  Chunk length and sectorcount are used for decompression buffers as well
  as the bdrv_pread() count argument.  Ensure that they have reasonable
  values so neither memory allocation nor conversion from uint64_t to int
  will cause problems.

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: c05e4667be91b46ab42b5a11babf8e84d476cc6b
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: c165f7758009a4f793c1fc19ebb69cf55313450b
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d99c4e2d857fbd5e95bf61971d59eb10499289c0
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b6f7fbdd1d9e27822e829e983fb6f907576a24e4
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 758c4840c64d2f0faed18c16c02cbb2c2a3bdfe3
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 53e11bd384a799c03884bd7d8b5be53f025f8e2d
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f0dce23475b5af5da6b17b97c1765271307734b6
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
