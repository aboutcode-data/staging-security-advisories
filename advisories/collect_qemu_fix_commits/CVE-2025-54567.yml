advisory_id: CVE-2025-54567
datasource_id: collect_qemu_fix_commits/CVE-2025-54567
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  df7dff296bf95e8b4c6246fc3bc0a9d759c26418:pcie_sriov: Fix configuration and state synchronization

  Fix issues in PCIe SR-IOV configuration register handling that caused
  inconsistent internal state due to improper write mask handling and
  incorrect migration behavior.

  Two main problems were identified:

  1. VF Enable bit write mask handling:
     pcie_sriov_config_write() incorrectly assumed that its val parameter
     was already masked, causing it to ignore the actual write mask.
     This led to the VF Enable bit being processed even when masked,
     resulting in incorrect VF registration/unregistration. It is
     identified as CVE-2025-54567.

  2. Migration state inconsistency:
     pcie_sriov_pf_post_load() unconditionally called register_vfs()
     regardless of the VF Enable bit state, creating inconsistent
     internal state when VFs should not be enabled. Additionally,
     it failed to properly update the NumVFs write mask based on
     the current configuration. It is identified as CVE-2025-54566.

  Root cause analysis revealed that both functions relied on incorrect
  special-case assumptions instead of properly reading and consuming
  the actual configuration values. This change introduces a unified
  consume_config() function that reads actual configuration values and
  synchronize the internal state without special-case assumptions.

  The solution only adds register read overhead in non-hot-path code
  while ensuring correct SR-IOV state management across configuration
  writes and migration scenarios.

  Fixes: 5e7dd17e4348 ("pcie_sriov: Remove num_vfs from PCIESriovPF")
  Fixes: f9efcd47110d ("pcie_sriov: Register VFs after migration")
  Fixes: CVE-2025-54566
  Fixes: CVE-2025-54567
  Cc: qemu-stable@nongnu.org
  Reported-by: Corentin BAYET <corentin.bayet@reversetactics.com>
  Signed-off-by: Akihiko Odaki <odaki@rsg.ci.i.u-tokyo.ac.jp>
  Message-Id: <20250727-wmask-v2-1-394910b1c0b6@rsg.ci.i.u-tokyo.ac.jp>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  (cherry picked from commit cad9aa6fbdccd95e56e10cfa57c354a20a333717)
  (Mjt: context fix)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  df7dff296bf95e8b4c6246fc3bc0a9d759c26418:pcie_sriov: Fix configuration and state synchronization

  Fix issues in PCIe SR-IOV configuration register handling that caused
  inconsistent internal state due to improper write mask handling and
  incorrect migration behavior.

  Two main problems were identified:

  1. VF Enable bit write mask handling:
     pcie_sriov_config_write() incorrectly assumed that its val parameter
     was already masked, causing it to ignore the actual write mask.
     This led to the VF Enable bit being processed even when masked,
     resulting in incorrect VF registration/unregistration. It is
     identified as CVE-2025-54567.

  2. Migration state inconsistency:
     pcie_sriov_pf_post_load() unconditionally called register_vfs()
     regardless of the VF Enable bit state, creating inconsistent
     internal state when VFs should not be enabled. Additionally,
     it failed to properly update the NumVFs write mask based on
     the current configuration. It is identified as CVE-2025-54566.

  Root cause analysis revealed that both functions relied on incorrect
  special-case assumptions instead of properly reading and consuming
  the actual configuration values. This change introduces a unified
  consume_config() function that reads actual configuration values and
  synchronize the internal state without special-case assumptions.

  The solution only adds register read overhead in non-hot-path code
  while ensuring correct SR-IOV state management across configuration
  writes and migration scenarios.

  Fixes: 5e7dd17e4348 ("pcie_sriov: Remove num_vfs from PCIESriovPF")
  Fixes: f9efcd47110d ("pcie_sriov: Register VFs after migration")
  Fixes: CVE-2025-54566
  Fixes: CVE-2025-54567
  Cc: qemu-stable@nongnu.org
  Reported-by: Corentin BAYET <corentin.bayet@reversetactics.com>
  Signed-off-by: Akihiko Odaki <odaki@rsg.ci.i.u-tokyo.ac.jp>
  Message-Id: <20250727-wmask-v2-1-394910b1c0b6@rsg.ci.i.u-tokyo.ac.jp>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  (cherry picked from commit cad9aa6fbdccd95e56e10cfa57c354a20a333717)
  (Mjt: context fix)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  cad9aa6fbdccd95e56e10cfa57c354a20a333717:pcie_sriov: Fix configuration and state synchronization

  Fix issues in PCIe SR-IOV configuration register handling that caused
  inconsistent internal state due to improper write mask handling and
  incorrect migration behavior.

  Two main problems were identified:

  1. VF Enable bit write mask handling:
     pcie_sriov_config_write() incorrectly assumed that its val parameter
     was already masked, causing it to ignore the actual write mask.
     This led to the VF Enable bit being processed even when masked,
     resulting in incorrect VF registration/unregistration. It is
     identified as CVE-2025-54567.

  2. Migration state inconsistency:
     pcie_sriov_pf_post_load() unconditionally called register_vfs()
     regardless of the VF Enable bit state, creating inconsistent
     internal state when VFs should not be enabled. Additionally,
     it failed to properly update the NumVFs write mask based on
     the current configuration. It is identified as CVE-2025-54566.

  Root cause analysis revealed that both functions relied on incorrect
  special-case assumptions instead of properly reading and consuming
  the actual configuration values. This change introduces a unified
  consume_config() function that reads actual configuration values and
  synchronize the internal state without special-case assumptions.

  The solution only adds register read overhead in non-hot-path code
  while ensuring correct SR-IOV state management across configuration
  writes and migration scenarios.

  Fixes: 5e7dd17e4348 ("pcie_sriov: Remove num_vfs from PCIESriovPF")
  Fixes: f9efcd47110d ("pcie_sriov: Register VFs after migration")
  Fixes: CVE-2025-54566
  Fixes: CVE-2025-54567
  Cc: qemu-stable@nongnu.org
  Reported-by: Corentin BAYET <corentin.bayet@reversetactics.com>
  Signed-off-by: Akihiko Odaki <odaki@rsg.ci.i.u-tokyo.ac.jp>
  Message-Id: <20250727-wmask-v2-1-394910b1c0b6@rsg.ci.i.u-tokyo.ac.jp>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  cad9aa6fbdccd95e56e10cfa57c354a20a333717:pcie_sriov: Fix configuration and state synchronization

  Fix issues in PCIe SR-IOV configuration register handling that caused
  inconsistent internal state due to improper write mask handling and
  incorrect migration behavior.

  Two main problems were identified:

  1. VF Enable bit write mask handling:
     pcie_sriov_config_write() incorrectly assumed that its val parameter
     was already masked, causing it to ignore the actual write mask.
     This led to the VF Enable bit being processed even when masked,
     resulting in incorrect VF registration/unregistration. It is
     identified as CVE-2025-54567.

  2. Migration state inconsistency:
     pcie_sriov_pf_post_load() unconditionally called register_vfs()
     regardless of the VF Enable bit state, creating inconsistent
     internal state when VFs should not be enabled. Additionally,
     it failed to properly update the NumVFs write mask based on
     the current configuration. It is identified as CVE-2025-54566.

  Root cause analysis revealed that both functions relied on incorrect
  special-case assumptions instead of properly reading and consuming
  the actual configuration values. This change introduces a unified
  consume_config() function that reads actual configuration values and
  synchronize the internal state without special-case assumptions.

  The solution only adds register read overhead in non-hot-path code
  while ensuring correct SR-IOV state management across configuration
  writes and migration scenarios.

  Fixes: 5e7dd17e4348 ("pcie_sriov: Remove num_vfs from PCIESriovPF")
  Fixes: f9efcd47110d ("pcie_sriov: Register VFs after migration")
  Fixes: CVE-2025-54566
  Fixes: CVE-2025-54567
  Cc: qemu-stable@nongnu.org
  Reported-by: Corentin BAYET <corentin.bayet@reversetactics.com>
  Signed-off-by: Akihiko Odaki <odaki@rsg.ci.i.u-tokyo.ac.jp>
  Message-Id: <20250727-wmask-v2-1-394910b1c0b6@rsg.ci.i.u-tokyo.ac.jp>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: df7dff296bf95e8b4c6246fc3bc0a9d759c26418
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: cad9aa6fbdccd95e56e10cfa57c354a20a333717
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
