advisory_id: CVE-2020-13253
datasource_id: collect_qemu_fix_commits/CVE-2020-13253
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  d7fab184e98bc0d482b0203fd3333da972b7ca5f:hw/sd/sdcard: Do not switch to ReceivingData if address is invalid

  Only move the state machine to ReceivingData if there is no
  pending error. This avoids later OOB access while processing
  commands queued.

    "SD Specifications Part 1 Physical Layer Simplified Spec. v3.01"

    4.3.3 Data Read

    Read command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
    occurred and no data transfer is performed.

    4.3.4 Data Write

    Write command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
    occurred and no data transfer is performed.

  WP_VIOLATION errors are not modified: the error bit is set, we
  stay in receive-data state, wait for a stop command. All further
  data transfer is ignored. See the check on sd->card_status at the
  beginning of sd_read_data() and sd_write_data().

  Fixes: CVE-2020-13253
  Cc: qemu-stable@nongnu.org
  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Buglink: https://bugs.launchpad.net/qemu/+bug/1880822
  Reviewed-by: Peter Maydell <peter.maydell@linaro.org>
  Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
  Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
  Message-Id: <20200630133912.9428-6-f4bug@amsat.org>
  (cherry picked from commit 790762e5487114341cccc5bffcec4cb3c022c3cd)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  e569ca39faf9dcd34fb7f0911ab1a3f7c3ffc0df:hw/sd/sdcard: Do not allow invalid SD card sizes

  QEMU allows to create SD card with unrealistic sizes. This could
  work, but some guests (at least Linux) consider sizes that are not
  a power of 2 as a firmware bug and fix the card size to the next
  power of 2.

  While the possibility to use small SD card images has been seen as
  a feature, it became a bug with CVE-2020-13253, where the guest is
  able to do OOB read/write accesses past the image size end.

  In a pair of commits we will fix CVE-2020-13253 as:

      Read command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      Write command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      WP_VIOLATION errors are not modified: the error bit is set, we
      stay in receive-data state, wait for a stop command. All further
      data transfer is ignored. See the check on sd->card_status at the
      beginning of sd_read_data() and sd_write_data().

  While this is the correct behavior, in case QEMU create smaller SD
  cards, guests still try to access past the image size end, and QEMU
  considers this is an invalid address, thus "all further data transfer
  is ignored". This is wrong and make the guest looping until
  eventually timeouts.

  Fix by not allowing invalid SD card sizes (suggesting the expected
  size as a hint):

    $ qemu-system-arm -M orangepi-pc -drive file=rootfs.ext2,if=sd,format=raw
    qemu-system-arm: Invalid SD card size: 60 MiB
    SD card size has to be a power of 2, e.g. 64 MiB.
    You can resize disk images with 'qemu-img resize <imagefile> <new-size>'
    (note that this will lose data if you make the image smaller than it currently is).

  Cc: qemu-stable@nongnu.org
  Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
  Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
  Reviewed-by: Peter Maydell <peter.maydell@linaro.org>
  Message-Id: <20200713183209.26308-8-f4bug@amsat.org>
  (cherry picked from commit a9bcedd15a5834ca9ae6c3a97933e85ac7edbd36)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  e569ca39faf9dcd34fb7f0911ab1a3f7c3ffc0df:hw/sd/sdcard: Do not allow invalid SD card sizes

  QEMU allows to create SD card with unrealistic sizes. This could
  work, but some guests (at least Linux) consider sizes that are not
  a power of 2 as a firmware bug and fix the card size to the next
  power of 2.

  While the possibility to use small SD card images has been seen as
  a feature, it became a bug with CVE-2020-13253, where the guest is
  able to do OOB read/write accesses past the image size end.

  In a pair of commits we will fix CVE-2020-13253 as:

      Read command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      Write command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      WP_VIOLATION errors are not modified: the error bit is set, we
      stay in receive-data state, wait for a stop command. All further
      data transfer is ignored. See the check on sd->card_status at the
      beginning of sd_read_data() and sd_write_data().

  While this is the correct behavior, in case QEMU create smaller SD
  cards, guests still try to access past the image size end, and QEMU
  considers this is an invalid address, thus "all further data transfer
  is ignored". This is wrong and make the guest looping until
  eventually timeouts.

  Fix by not allowing invalid SD card sizes (suggesting the expected
  size as a hint):

    $ qemu-system-arm -M orangepi-pc -drive file=rootfs.ext2,if=sd,format=raw
    qemu-system-arm: Invalid SD card size: 60 MiB
    SD card size has to be a power of 2, e.g. 64 MiB.
    You can resize disk images with 'qemu-img resize <imagefile> <new-size>'
    (note that this will lose data if you make the image smaller than it currently is).

  Cc: qemu-stable@nongnu.org
  Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
  Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
  Reviewed-by: Peter Maydell <peter.maydell@linaro.org>
  Message-Id: <20200713183209.26308-8-f4bug@amsat.org>
  (cherry picked from commit a9bcedd15a5834ca9ae6c3a97933e85ac7edbd36)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  3a9163af4e3dd61795a35d47b702e302f98f81d6:Merge remote-tracking branch 'remotes/philmd-gitlab/tags/sdcard-CVE-2020-13253-pull-request' into staging

  Fix CVE-2020-13253

  By using invalidated address, guest can do out-of-bounds accesses.
  These patches fix the issue by only allowing SD card image sizes
  power of 2, and not switching to SEND_DATA state when the address
  is invalid (out of range).

  This issue was found using QEMU fuzzing mode (using --enable-fuzzing,
  see docs/devel/fuzzing.txt) and reported by Alexander Bulekov.

  Reproducer:
    https://bugs.launchpad.net/qemu/+bug/1880822/comments/1

  CI jobs results:
  . https://cirrus-ci.com/build/5157142548185088
  . https://gitlab.com/philmd/qemu/-/pipelines/166381731
  . https://travis-ci.org/github/philmd/qemu/builds/707956535

  # gpg: Signature made Tue 14 Jul 2020 14:54:44 BST
  # gpg:                using RSA key FAABE75E12917221DCFD6BB2E3E32C2CDEADC0DE
  # gpg: Good signature from "Philippe Mathieu-Daudé (F4BUG) <f4bug@amsat.org>" [full]
  # Primary key fingerprint: FAAB E75E 1291 7221 DCFD  6BB2 E3E3 2C2C DEAD C0DE

  * remotes/philmd-gitlab/tags/sdcard-CVE-2020-13253-pull-request:
    hw/sd/sdcard: Do not switch to ReceivingData if address is invalid
    hw/sd/sdcard: Update coding style to make checkpatch.pl happy
    hw/sd/sdcard: Do not allow invalid SD card sizes
    hw/sd/sdcard: Simplify realize() a bit
    hw/sd/sdcard: Restrict Class 6 commands to SCSD cards
    tests/acceptance/boot_linux: Expand SD card image to power of 2
    tests/acceptance/boot_linux: Tag tests using a SD card with 'device:sd'
    docs/orangepi: Add instructions for resizing SD image to power of two
    MAINTAINERS: Cc qemu-block mailing list

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  3a9163af4e3dd61795a35d47b702e302f98f81d6:Merge remote-tracking branch 'remotes/philmd-gitlab/tags/sdcard-CVE-2020-13253-pull-request' into staging

  Fix CVE-2020-13253

  By using invalidated address, guest can do out-of-bounds accesses.
  These patches fix the issue by only allowing SD card image sizes
  power of 2, and not switching to SEND_DATA state when the address
  is invalid (out of range).

  This issue was found using QEMU fuzzing mode (using --enable-fuzzing,
  see docs/devel/fuzzing.txt) and reported by Alexander Bulekov.

  Reproducer:
    https://bugs.launchpad.net/qemu/+bug/1880822/comments/1

  CI jobs results:
  . https://cirrus-ci.com/build/5157142548185088
  . https://gitlab.com/philmd/qemu/-/pipelines/166381731
  . https://travis-ci.org/github/philmd/qemu/builds/707956535

  # gpg: Signature made Tue 14 Jul 2020 14:54:44 BST
  # gpg:                using RSA key FAABE75E12917221DCFD6BB2E3E32C2CDEADC0DE
  # gpg: Good signature from "Philippe Mathieu-Daudé (F4BUG) <f4bug@amsat.org>" [full]
  # Primary key fingerprint: FAAB E75E 1291 7221 DCFD  6BB2 E3E3 2C2C DEAD C0DE

  * remotes/philmd-gitlab/tags/sdcard-CVE-2020-13253-pull-request:
    hw/sd/sdcard: Do not switch to ReceivingData if address is invalid
    hw/sd/sdcard: Update coding style to make checkpatch.pl happy
    hw/sd/sdcard: Do not allow invalid SD card sizes
    hw/sd/sdcard: Simplify realize() a bit
    hw/sd/sdcard: Restrict Class 6 commands to SCSD cards
    tests/acceptance/boot_linux: Expand SD card image to power of 2
    tests/acceptance/boot_linux: Tag tests using a SD card with 'device:sd'
    docs/orangepi: Add instructions for resizing SD image to power of two
    MAINTAINERS: Cc qemu-block mailing list

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  3a9163af4e3dd61795a35d47b702e302f98f81d6:Merge remote-tracking branch 'remotes/philmd-gitlab/tags/sdcard-CVE-2020-13253-pull-request' into staging

  Fix CVE-2020-13253

  By using invalidated address, guest can do out-of-bounds accesses.
  These patches fix the issue by only allowing SD card image sizes
  power of 2, and not switching to SEND_DATA state when the address
  is invalid (out of range).

  This issue was found using QEMU fuzzing mode (using --enable-fuzzing,
  see docs/devel/fuzzing.txt) and reported by Alexander Bulekov.

  Reproducer:
    https://bugs.launchpad.net/qemu/+bug/1880822/comments/1

  CI jobs results:
  . https://cirrus-ci.com/build/5157142548185088
  . https://gitlab.com/philmd/qemu/-/pipelines/166381731
  . https://travis-ci.org/github/philmd/qemu/builds/707956535

  # gpg: Signature made Tue 14 Jul 2020 14:54:44 BST
  # gpg:                using RSA key FAABE75E12917221DCFD6BB2E3E32C2CDEADC0DE
  # gpg: Good signature from "Philippe Mathieu-Daudé (F4BUG) <f4bug@amsat.org>" [full]
  # Primary key fingerprint: FAAB E75E 1291 7221 DCFD  6BB2 E3E3 2C2C DEAD C0DE

  * remotes/philmd-gitlab/tags/sdcard-CVE-2020-13253-pull-request:
    hw/sd/sdcard: Do not switch to ReceivingData if address is invalid
    hw/sd/sdcard: Update coding style to make checkpatch.pl happy
    hw/sd/sdcard: Do not allow invalid SD card sizes
    hw/sd/sdcard: Simplify realize() a bit
    hw/sd/sdcard: Restrict Class 6 commands to SCSD cards
    tests/acceptance/boot_linux: Expand SD card image to power of 2
    tests/acceptance/boot_linux: Tag tests using a SD card with 'device:sd'
    docs/orangepi: Add instructions for resizing SD image to power of two
    MAINTAINERS: Cc qemu-block mailing list

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  790762e5487114341cccc5bffcec4cb3c022c3cd:hw/sd/sdcard: Do not switch to ReceivingData if address is invalid

  Only move the state machine to ReceivingData if there is no
  pending error. This avoids later OOB access while processing
  commands queued.

    "SD Specifications Part 1 Physical Layer Simplified Spec. v3.01"

    4.3.3 Data Read

    Read command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
    occurred and no data transfer is performed.

    4.3.4 Data Write

    Write command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
    occurred and no data transfer is performed.

  WP_VIOLATION errors are not modified: the error bit is set, we
  stay in receive-data state, wait for a stop command. All further
  data transfer is ignored. See the check on sd->card_status at the
  beginning of sd_read_data() and sd_write_data().

  Fixes: CVE-2020-13253
  Cc: qemu-stable@nongnu.org
  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Buglink: https://bugs.launchpad.net/qemu/+bug/1880822
  Reviewed-by: Peter Maydell <peter.maydell@linaro.org>
  Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
  Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
  Message-Id: <20200630133912.9428-6-f4bug@amsat.org>
  a9bcedd15a5834ca9ae6c3a97933e85ac7edbd36:hw/sd/sdcard: Do not allow invalid SD card sizes

  QEMU allows to create SD card with unrealistic sizes. This could
  work, but some guests (at least Linux) consider sizes that are not
  a power of 2 as a firmware bug and fix the card size to the next
  power of 2.

  While the possibility to use small SD card images has been seen as
  a feature, it became a bug with CVE-2020-13253, where the guest is
  able to do OOB read/write accesses past the image size end.

  In a pair of commits we will fix CVE-2020-13253 as:

      Read command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      Write command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      WP_VIOLATION errors are not modified: the error bit is set, we
      stay in receive-data state, wait for a stop command. All further
      data transfer is ignored. See the check on sd->card_status at the
      beginning of sd_read_data() and sd_write_data().

  While this is the correct behavior, in case QEMU create smaller SD
  cards, guests still try to access past the image size end, and QEMU
  considers this is an invalid address, thus "all further data transfer
  is ignored". This is wrong and make the guest looping until
  eventually timeouts.

  Fix by not allowing invalid SD card sizes (suggesting the expected
  size as a hint):

    $ qemu-system-arm -M orangepi-pc -drive file=rootfs.ext2,if=sd,format=raw
    qemu-system-arm: Invalid SD card size: 60 MiB
    SD card size has to be a power of 2, e.g. 64 MiB.
    You can resize disk images with 'qemu-img resize <imagefile> <new-size>'
    (note that this will lose data if you make the image smaller than it currently is).

  Cc: qemu-stable@nongnu.org
  Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
  Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
  Reviewed-by: Peter Maydell <peter.maydell@linaro.org>
  Message-Id: <20200713183209.26308-8-f4bug@amsat.org>
  a9bcedd15a5834ca9ae6c3a97933e85ac7edbd36:hw/sd/sdcard: Do not allow invalid SD card sizes

  QEMU allows to create SD card with unrealistic sizes. This could
  work, but some guests (at least Linux) consider sizes that are not
  a power of 2 as a firmware bug and fix the card size to the next
  power of 2.

  While the possibility to use small SD card images has been seen as
  a feature, it became a bug with CVE-2020-13253, where the guest is
  able to do OOB read/write accesses past the image size end.

  In a pair of commits we will fix CVE-2020-13253 as:

      Read command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      Write command is rejected if BLOCK_LEN_ERROR or ADDRESS_ERROR
      occurred and no data transfer is performed.

      WP_VIOLATION errors are not modified: the error bit is set, we
      stay in receive-data state, wait for a stop command. All further
      data transfer is ignored. See the check on sd->card_status at the
      beginning of sd_read_data() and sd_write_data().

  While this is the correct behavior, in case QEMU create smaller SD
  cards, guests still try to access past the image size end, and QEMU
  considers this is an invalid address, thus "all further data transfer
  is ignored". This is wrong and make the guest looping until
  eventually timeouts.

  Fix by not allowing invalid SD card sizes (suggesting the expected
  size as a hint):

    $ qemu-system-arm -M orangepi-pc -drive file=rootfs.ext2,if=sd,format=raw
    qemu-system-arm: Invalid SD card size: 60 MiB
    SD card size has to be a power of 2, e.g. 64 MiB.
    You can resize disk images with 'qemu-img resize <imagefile> <new-size>'
    (note that this will lose data if you make the image smaller than it currently is).

  Cc: qemu-stable@nongnu.org
  Signed-off-by: Philippe Mathieu-Daudé <f4bug@amsat.org>
  Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
  Reviewed-by: Peter Maydell <peter.maydell@linaro.org>
  Message-Id: <20200713183209.26308-8-f4bug@amsat.org>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 790762e5487114341cccc5bffcec4cb3c022c3cd
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 3a9163af4e3dd61795a35d47b702e302f98f81d6
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: a9bcedd15a5834ca9ae6c3a97933e85ac7edbd36
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d7fab184e98bc0d482b0203fd3333da972b7ca5f
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e569ca39faf9dcd34fb7f0911ab1a3f7c3ffc0df
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
