advisory_id: CVE-2015-5165
datasource_id: collect_qemu_fix_commits/CVE-2015-5165
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  35c30d3efdfb7d06f978cdb711cb27bc280dcbe8:rtl8139: check TCP Data Offset field (CVE-2015-5165)

  The TCP Data Offset field contains the length of the header.  Make sure
  it is valid and does not exceed the IP data length.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 8357946b15f0a31f73dd691b7da95f29318ed310)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  f4c861fd68838649e81e0f9a6d75b154fda76440:rtl8139: skip offload on short TCP header (CVE-2015-5165)

  TCP Large Segment Offload accesses the TCP header in the packet.  If the
  packet is too short we must not attempt to access header fields:

    tcp_header *p_tcp_hdr = (tcp_header*)(eth_payload_data + hlen);
    int tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 4240be45632db7831129f124bcf53c1223825b0f)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  b7a197c39e4b2099f25d2137e8d73c53c37b92c6:rtl8139: check IP Total Length field (CVE-2015-5165)

  The IP Total Length field includes the IP header and data.  Make sure it
  is valid and does not exceed the Ethernet payload size.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit c6296ea88df040054ccd781f3945fe103f8c7c17)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  85611098ff39ffaa8d78c02bb16eb2c5355d9899:rtl8139: check IP Header Length field (CVE-2015-5165)

  The IP Header Length field was only checked in the IP checksum case, but
  is used in other cases too.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 03247d43c577dfea8181cd40177ad5ba77c8db76)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  ce4f451bbba8edcd2418cfce434b096602248ab3:rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)

  Transmit offload features access Ethernet and IP headers the packet.  If
  the packet is too short we must not attempt to access header fields:

    int proto = be16_to_cpu(*(uint16_t *)(saved_buffer + 12));
    ...
    eth_payload_data = saved_buffer + ETH_HLEN;
    ...
    ip = (ip_header*)eth_payload_data;
    if (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) {

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit e1c120a9c54872f8a538ff9129d928de4e865cbd)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  6722c126f385397a0d010e391fea26eaeea14586:rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)

  The previous patch stopped using the ip pointer as an indicator that the
  IP header is present.  When we reach the if (ip) {...} statement we know
  ip is always non-NULL.

  Remove the if statement to reduce nesting.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit d6812d60e7932de3cd0f602c0ee63dd3d09f1847)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  8dd45dcd83bd819e3fe9927e819ba9441b4f0ccc:rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Transmit offload needs to parse packet headers.  If header fields have
  unexpected values the offload processing is skipped.

  The code currently uses nested ifs because there is relatively little
  input validation.  The next patches will add missing input validation
  and a goto label is more appropriate to avoid deep if statement nesting.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 39b8e7dcaf04cbdb926b478f825b160d852752b5)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef:Merge remote-tracking branch 'remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request' into staging

  Pull request

  # gpg: Signature made Mon Aug  3 13:08:25 2015 BST using RSA key ID 81AB73C8
  # gpg: Good signature from "Stefan Hajnoczi <stefanha@redhat.com>"
  # gpg:                 aka "Stefan Hajnoczi <stefanha@gmail.com>"

  * remotes/stefanha/tags/rtl8139-cplus-tx-input-validation-pull-request:
    rtl8139: check TCP Data Offset field (CVE-2015-5165)
    rtl8139: skip offload on short TCP header (CVE-2015-5165)
    rtl8139: check IP Total Length field (CVE-2015-5165)
    rtl8139: check IP Header Length field (CVE-2015-5165)
    rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)
    rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)
    rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  8357946b15f0a31f73dd691b7da95f29318ed310:rtl8139: check TCP Data Offset field (CVE-2015-5165)

  The TCP Data Offset field contains the length of the header.  Make sure
  it is valid and does not exceed the IP data length.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  4240be45632db7831129f124bcf53c1223825b0f:rtl8139: skip offload on short TCP header (CVE-2015-5165)

  TCP Large Segment Offload accesses the TCP header in the packet.  If the
  packet is too short we must not attempt to access header fields:

    tcp_header *p_tcp_hdr = (tcp_header*)(eth_payload_data + hlen);
    int tcp_hlen = TCP_HEADER_DATA_OFFSET(p_tcp_hdr);

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  c6296ea88df040054ccd781f3945fe103f8c7c17:rtl8139: check IP Total Length field (CVE-2015-5165)

  The IP Total Length field includes the IP header and data.  Make sure it
  is valid and does not exceed the Ethernet payload size.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  03247d43c577dfea8181cd40177ad5ba77c8db76:rtl8139: check IP Header Length field (CVE-2015-5165)

  The IP Header Length field was only checked in the IP checksum case, but
  is used in other cases too.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  e1c120a9c54872f8a538ff9129d928de4e865cbd:rtl8139: skip offload on short Ethernet/IP header (CVE-2015-5165)

  Transmit offload features access Ethernet and IP headers the packet.  If
  the packet is too short we must not attempt to access header fields:

    int proto = be16_to_cpu(*(uint16_t *)(saved_buffer + 12));
    ...
    eth_payload_data = saved_buffer + ETH_HLEN;
    ...
    ip = (ip_header*)eth_payload_data;
    if (IP_HEADER_VERSION(ip) != IP_HEADER_VERSION_4) {

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  d6812d60e7932de3cd0f602c0ee63dd3d09f1847:rtl8139: drop tautologous if (ip) {...} statement (CVE-2015-5165)

  The previous patch stopped using the ip pointer as an indicator that the
  IP header is present.  When we reach the if (ip) {...} statement we know
  ip is always non-NULL.

  Remove the if statement to reduce nesting.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  39b8e7dcaf04cbdb926b478f825b160d852752b5:rtl8139: avoid nested ifs in IP header parsing (CVE-2015-5165)

  Transmit offload needs to parse packet headers.  If header fields have
  unexpected values the offload processing is skipped.

  The code currently uses nested ifs because there is relatively little
  input validation.  The next patches will add missing input validation
  and a goto label is more appropriate to avoid deep if statement nesting.

  Reported-by: 朱东海(启路) <donghai.zdh@alibaba-inc.com>
  Reviewed-by: Jason Wang <jasowang@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b7a197c39e4b2099f25d2137e8d73c53c37b92c6
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 03247d43c577dfea8181cd40177ad5ba77c8db76
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 8357946b15f0a31f73dd691b7da95f29318ed310
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 35c30d3efdfb7d06f978cdb711cb27bc280dcbe8
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f4c861fd68838649e81e0f9a6d75b154fda76440
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 2a3612ccc1fa9cea77bd193afbfe21c77e7e91ef
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: d6812d60e7932de3cd0f602c0ee63dd3d09f1847
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 8dd45dcd83bd819e3fe9927e819ba9441b4f0ccc
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 6722c126f385397a0d010e391fea26eaeea14586
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 4240be45632db7831129f124bcf53c1223825b0f
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: ce4f451bbba8edcd2418cfce434b096602248ab3
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 39b8e7dcaf04cbdb926b478f825b160d852752b5
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 85611098ff39ffaa8d78c02bb16eb2c5355d9899
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e1c120a9c54872f8a538ff9129d928de4e865cbd
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: c6296ea88df040054ccd781f3945fe103f8c7c17
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
