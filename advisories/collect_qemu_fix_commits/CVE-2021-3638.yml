advisory_id: CVE-2021-3638
datasource_id: collect_qemu_fix_commits/CVE-2021-3638
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  c48c9c6b33d7bb2b4ffa14cd33934a37db0cd342:Merge tag 'kraxel-20220927-pull-request' of https://gitlab.com/kraxel/qemu into staging

  usb: make usbnet work with xhci.
  audio: add sndio backend.
  misc bugfixes for console, xhci, audio, ati-vga and virtio-gpu.

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQIzBAABCgAdFiEEoDKM/7k6F6eZAf59TLbY7tPocTgFAmMyse8ACgkQTLbY7tPo
  # cTiLrRAAltoyd++jsmhg2wXuJsfekfec3kOro7T+eSznDWfBRvm7VxJ+gswYBYga
  # HbEkHjII0yPbOP9WDMhhHx33g2nYdbhDLPKXHdK8MjHTTPxtYP7XmsWkEVpuuzTx
  # WqeYvGSmUri6QOUz7fd07IhiBT1aQvUQ/vWQ6OhyRVPy41bR8kIbGx3iV0JDxWvz
  # n3xUZALGLz3QAM0lXRzXPYT9JB/RqdbpMM35HNTpN9/xaZmgFWsyuQXSSm61pTtb
  # PS+lILDPjgZeYsfsZRyhZaSZrp2f6WOGm1ZdtSM0rvmRKezOzYnG8fm4fqZQLYSj
  # nrAqUs38sKaM71a3QbpXhDjbv4cpj0K3iSNLmlUq4pgvPiMgwPlgSwwCGlkNDaRo
  # IA1KON1pMH2A5vvtXEUt5RTkbXxHAAKPdpl5sS6kgbs7dgoKDqzaIPFQELam259Z
  # 9nbMBqz/d6gm2CFT5ogrY0q511IC5hWtsmbQZkOZeBd5SvhvyJ59DIabFDcw05fG
  # ixZVapewXYtzFUde2lb8X5qyneUVeGY5D2OJ2uUykHgR2Qz4d3CjXlhnRkLIkMcd
  # Uu6N1LTkjyuuB86BoTSZxk0iz94OvmyDiXpqwmRaCGcdnTOTj0dKrbRrtHdC2vCo
  # cBpUAIdyJvDJSm0X8ZWvvv1sMJCAJ7lofFf/P/jUKlacC2ipgXQ=
  # =QBLK
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Tue 27 Sep 2022 04:18:55 EDT
  # gpg:                using RSA key A0328CFFB93A17A79901FE7D4CB6D8EED3E87138
  # gpg: Good signature from "Gerd Hoffmann (work) <kraxel@redhat.com>" [full]
  # gpg:                 aka "Gerd Hoffmann <gerd@kraxel.org>" [full]
  # gpg:                 aka "Gerd Hoffmann (private) <kraxel@gmail.com>" [full]
  # Primary key fingerprint: A032 8CFF B93A 17A7 9901  FE7D 4CB6 D8EE D3E8 7138

  * tag 'kraxel-20220927-pull-request' of https://gitlab.com/kraxel/qemu: (24 commits)
    virtio-gpu: update scanout if there is any area covered by the rect
    hw/display/ati_2d: Fix buffer overflow in ati_2d_blt (CVE-2021-3638)
    audio: remove abort() in audio_bug()
    Revert "audio: Log context for audio bug"
    audio: Add sndio backend
    usbnet: Report link-up via interrupt endpoint in CDC-ECM mode
    usbnet: Detect short packets as sent by the xHCI controller
    usbnet: Accept mandatory USB_CDC_SET_ETHERNET_PACKET_FILTER request
    usbnet: Add missing usb_wakeup() call in usbnet_receive()
    hcd-xhci: drop operation with secondary stream arrays enabled
    usb/msd: add usb_msd_fatal_error() and fix guest-triggerable assert
    usb/msd: move usb_msd_packet_complete()
    hcd-ohci: Drop ohci_service_iso_td() if ed->head & OHCI_DPTR_MASK is zero
    hw/usb/hcd-xhci: Check whether DMA accesses fail
    ui/console: fix three double frees in png_save()
    ui/vdagent: fix serial reset of guest agent
    ui/clipboard: reset the serial state on reset
    ui/vdagent: always reset the clipboard serial on caps
    ui/clipboard: fix serial priority
    ui: add some vdagent related traces
    ...

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  205ccfd7a5ec86bd9a5678b8bd157562fc9a1643:hw/display/ati_2d: Fix buffer overflow in ati_2d_blt (CVE-2021-3638)

  When building QEMU with DEBUG_ATI defined then running with
  '-device ati-vga,romfile="" -d unimp,guest_errors -trace ati\*'
  we get:

    ati_mm_write 4 0x16c0 DP_CNTL <- 0x1
    ati_mm_write 4 0x146c DP_GUI_MASTER_CNTL <- 0x2
    ati_mm_write 4 0x16c8 DP_MIX <- 0xff0000
    ati_mm_write 4 0x16c4 DP_DATATYPE <- 0x2
    ati_mm_write 4 0x224 CRTC_OFFSET <- 0x0
    ati_mm_write 4 0x142c DST_PITCH_OFFSET <- 0xfe00000
    ati_mm_write 4 0x1420 DST_Y <- 0x3fff
    ati_mm_write 4 0x1410 DST_HEIGHT <- 0x3fff
    ati_mm_write 4 0x1588 DST_WIDTH_X <- 0x3fff3fff
    ati_2d_blt: vram:0x7fff5fa00000 addr:0 ds:0x7fff61273800 stride:2560 bpp:32 rop:0xff
    ati_2d_blt: 0 0 0, 0 127 0, (0,0) -> (16383,16383) 16383x16383 > ^
    ati_2d_blt: pixman_fill(dst:0x7fff5fa00000, stride:254, bpp:8, x:16383, y:16383, w:16383, h:16383, xor:0xff000000)
    Thread 3 "qemu-system-i38" received signal SIGSEGV, Segmentation fault.
    (gdb) bt
    #0  0x00007ffff7f62ce0 in sse2_fill.lto_priv () at /lib64/libpixman-1.so.0
    #1  0x00007ffff7f09278 in pixman_fill () at /lib64/libpixman-1.so.0
    #2  0x0000555557b5a9af in ati_2d_blt (s=0x631000028800) at hw/display/ati_2d.c:196
    #3  0x0000555557b4b5a2 in ati_mm_write (opaque=0x631000028800, addr=5512, data=1073692671, size=4) at hw/display/ati.c:843
    #4  0x0000555558b90ec4 in memory_region_write_accessor (mr=0x631000039cc0, addr=5512, ..., size=4, ...) at softmmu/memory.c:492

  Commit 584acf34cb0 ("ati-vga: Fix reverse bit blts") introduced
  the local dst_x and dst_y which adjust the (x, y) coordinates
  depending on the direction in the SRCCOPY ROP3 operation, but
  forgot to address the same issue for the PATCOPY, BLACKNESS and
  WHITENESS operations, which also call pixman_fill().

  Fix that now by using the adjusted coordinates in the pixman_fill
  call, and update the related debug printf().

  Reported-by: Qiang Liu <qiangliu@zju.edu.cn>
  Fixes: 584acf34cb0 ("ati-vga: Fix reverse bit blts")
  Signed-off-by: Philippe Mathieu-Daud√© <philmd@redhat.com>
  Tested-by: Mauro Matteo Cascella <mcascell@redhat.com>
  Message-Id: <20210906153103.1661195-1-philmd@redhat.com>
  Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 205ccfd7a5ec86bd9a5678b8bd157562fc9a1643
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: c48c9c6b33d7bb2b4ffa14cd33934a37db0cd342
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
