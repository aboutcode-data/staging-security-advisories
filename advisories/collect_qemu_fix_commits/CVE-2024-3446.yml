advisory_id: CVE-2024-3446
datasource_id: collect_qemu_fix_commits/CVE-2024-3446
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  4f01537ced3e787bd985b8f8de5869b92657160a:hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed.

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Suggested-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-5-philmd@linaro.org>
  (cherry picked from commit f4729ec39ad97a42ceaa7b5697f84f440ea6e5dc)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  fbeb0a160cbcc067c0e1f0d380cea4a31de213e3:hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed.

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Suggested-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-4-philmd@linaro.org>
  (cherry picked from commit b4295bff25f7b50de1d9cc94a9c6effd40056bca)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  1b2a52712b249e14d246cd9c7db126088e6e64db:hw/display/virtio-gpu: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed:

    $ cat << EOF | qemu-system-i386 -display none -nodefaults \
                                    -machine q35,accel=qtest \
                                    -m 512M \
                                    -device virtio-gpu \
                                    -qtest stdio
    outl 0xcf8 0x80000820
    outl 0xcfc 0xe0004000
    outl 0xcf8 0x80000804
    outw 0xcfc 0x06
    write 0xe0004030 0x4 0x024000e0
    write 0xe0004028 0x1 0xff
    write 0xe0004020 0x4 0x00009300
    write 0xe000401c 0x1 0x01
    write 0x101 0x1 0x04
    write 0x103 0x1 0x1c
    write 0x9301c8 0x1 0x18
    write 0x105 0x1 0x1c
    write 0x107 0x1 0x1c
    write 0x109 0x1 0x1c
    write 0x10b 0x1 0x00
    write 0x10d 0x1 0x00
    write 0x10f 0x1 0x00
    write 0x111 0x1 0x00
    write 0x113 0x1 0x00
    write 0x115 0x1 0x00
    write 0x117 0x1 0x00
    write 0x119 0x1 0x00
    write 0x11b 0x1 0x00
    write 0x11d 0x1 0x00
    write 0x11f 0x1 0x00
    write 0x121 0x1 0x00
    write 0x123 0x1 0x00
    write 0x125 0x1 0x00
    write 0x127 0x1 0x00
    write 0x129 0x1 0x00
    write 0x12b 0x1 0x00
    write 0x12d 0x1 0x00
    write 0x12f 0x1 0x00
    write 0x131 0x1 0x00
    write 0x133 0x1 0x00
    write 0x135 0x1 0x00
    write 0x137 0x1 0x00
    write 0x139 0x1 0x00
    write 0xe0007003 0x1 0x00
    EOF
    ...
    =================================================================
    ==276099==ERROR: AddressSanitizer: heap-use-after-free on address 0x60d000011178
    at pc 0x562cc3b736c7 bp 0x7ffed49dee60 sp 0x7ffed49dee58
    READ of size 8 at 0x60d000011178 thread T0
        #0 0x562cc3b736c6 in virtio_gpu_ctrl_response hw/display/virtio-gpu.c:180:42
        #1 0x562cc3b7c40b in virtio_gpu_ctrl_response_nodata hw/display/virtio-gpu.c:192:5
        #2 0x562cc3b7c40b in virtio_gpu_simple_process_cmd hw/display/virtio-gpu.c:1015:13
        #3 0x562cc3b82873 in virtio_gpu_process_cmdq hw/display/virtio-gpu.c:1050:9
        #4 0x562cc4a85514 in aio_bh_call util/async.c:169:5
        #5 0x562cc4a85c52 in aio_bh_poll util/async.c:216:13
        #6 0x562cc4a1a79b in aio_dispatch util/aio-posix.c:423:5
        #7 0x562cc4a8a2da in aio_ctx_dispatch util/async.c:358:5
        #8 0x7f36840547a8 in g_main_context_dispatch (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x547a8)
        #9 0x562cc4a8b753 in glib_pollfds_poll util/main-loop.c:290:9
        #10 0x562cc4a8b753 in os_host_main_loop_wait util/main-loop.c:313:5
        #11 0x562cc4a8b753 in main_loop_wait util/main-loop.c:592:11
        #12 0x562cc3938186 in qemu_main_loop system/runstate.c:782:9
        #13 0x562cc43b7af5 in qemu_default_main system/main.c:37:14
        #14 0x7f3683a6c189 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
        #15 0x7f3683a6c244 in __libc_start_main csu/../csu/libc-start.c:381:3
        #16 0x562cc2a58ac0 in _start (qemu-system-i386+0x231bac0)

    0x60d000011178 is located 56 bytes inside of 136-byte region [0x60d000011140,0x60d0000111c8)
    freed by thread T0 here:
        #0 0x562cc2adb662 in __interceptor_free (qemu-system-i386+0x239e662)
        #1 0x562cc3b86b21 in virtio_gpu_reset hw/display/virtio-gpu.c:1524:9
        #2 0x562cc416e20e in virtio_reset hw/virtio/virtio.c:2145:9
        #3 0x562cc37c5644 in virtio_pci_reset hw/virtio/virtio-pci.c:2249:5
        #4 0x562cc4233758 in memory_region_write_accessor system/memory.c:497:5
        #5 0x562cc4232eea in access_with_adjusted_size system/memory.c:573:18

    previously allocated by thread T0 here:
        #0 0x562cc2adb90e in malloc (qemu-system-i386+0x239e90e)
        #1 0x7f368405a678 in g_malloc (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x5a678)
        #2 0x562cc4163ffc in virtqueue_split_pop hw/virtio/virtio.c:1612:12
        #3 0x562cc4163ffc in virtqueue_pop hw/virtio/virtio.c:1783:16
        #4 0x562cc3b91a95 in virtio_gpu_handle_ctrl hw/display/virtio-gpu.c:1112:15
        #5 0x562cc4a85514 in aio_bh_call util/async.c:169:5
        #6 0x562cc4a85c52 in aio_bh_poll util/async.c:216:13
        #7 0x562cc4a1a79b in aio_dispatch util/aio-posix.c:423:5

    SUMMARY: AddressSanitizer: heap-use-after-free hw/display/virtio-gpu.c:180:42 in virtio_gpu_ctrl_response

  With this change, the same reproducer triggers:

    qemu-system-i386: warning: Blocked re-entrant IO on MemoryRegion: virtio-pci-common-virtio-gpu at addr: 0x6

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Reported-by: Yongkang Jia <kangel@zju.edu.cn>
  Reported-by: Xiao Lei <nop.leixiao@gmail.com>
  Reported-by: Yiming Tao <taoym@zju.edu.cn>
  Buglink: https://bugs.launchpad.net/qemu/+bug/1888606
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-3-philmd@linaro.org>
  (cherry picked from commit ba28e0ff4d95b56dc334aac2730ab3651ffc3132)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  7aaf5f7778de4d75a169ab193f08857eb28db3a4:hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed.

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Suggested-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-5-philmd@linaro.org>
  (cherry picked from commit f4729ec39ad97a42ceaa7b5697f84f440ea6e5dc)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  e7c2df3fd748a20a8b7a316d186b3ac77551f159:hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed.

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Suggested-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-4-philmd@linaro.org>
  (cherry picked from commit b4295bff25f7b50de1d9cc94a9c6effd40056bca)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  6d37a308159766cb90ed745cfeb1880937b638ec:hw/display/virtio-gpu: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed:

    $ cat << EOF | qemu-system-i386 -display none -nodefaults \
                                    -machine q35,accel=qtest \
                                    -m 512M \
                                    -device virtio-gpu \
                                    -qtest stdio
    outl 0xcf8 0x80000820
    outl 0xcfc 0xe0004000
    outl 0xcf8 0x80000804
    outw 0xcfc 0x06
    write 0xe0004030 0x4 0x024000e0
    write 0xe0004028 0x1 0xff
    write 0xe0004020 0x4 0x00009300
    write 0xe000401c 0x1 0x01
    write 0x101 0x1 0x04
    write 0x103 0x1 0x1c
    write 0x9301c8 0x1 0x18
    write 0x105 0x1 0x1c
    write 0x107 0x1 0x1c
    write 0x109 0x1 0x1c
    write 0x10b 0x1 0x00
    write 0x10d 0x1 0x00
    write 0x10f 0x1 0x00
    write 0x111 0x1 0x00
    write 0x113 0x1 0x00
    write 0x115 0x1 0x00
    write 0x117 0x1 0x00
    write 0x119 0x1 0x00
    write 0x11b 0x1 0x00
    write 0x11d 0x1 0x00
    write 0x11f 0x1 0x00
    write 0x121 0x1 0x00
    write 0x123 0x1 0x00
    write 0x125 0x1 0x00
    write 0x127 0x1 0x00
    write 0x129 0x1 0x00
    write 0x12b 0x1 0x00
    write 0x12d 0x1 0x00
    write 0x12f 0x1 0x00
    write 0x131 0x1 0x00
    write 0x133 0x1 0x00
    write 0x135 0x1 0x00
    write 0x137 0x1 0x00
    write 0x139 0x1 0x00
    write 0xe0007003 0x1 0x00
    EOF
    ...
    =================================================================
    ==276099==ERROR: AddressSanitizer: heap-use-after-free on address 0x60d000011178
    at pc 0x562cc3b736c7 bp 0x7ffed49dee60 sp 0x7ffed49dee58
    READ of size 8 at 0x60d000011178 thread T0
        #0 0x562cc3b736c6 in virtio_gpu_ctrl_response hw/display/virtio-gpu.c:180:42
        #1 0x562cc3b7c40b in virtio_gpu_ctrl_response_nodata hw/display/virtio-gpu.c:192:5
        #2 0x562cc3b7c40b in virtio_gpu_simple_process_cmd hw/display/virtio-gpu.c:1015:13
        #3 0x562cc3b82873 in virtio_gpu_process_cmdq hw/display/virtio-gpu.c:1050:9
        #4 0x562cc4a85514 in aio_bh_call util/async.c:169:5
        #5 0x562cc4a85c52 in aio_bh_poll util/async.c:216:13
        #6 0x562cc4a1a79b in aio_dispatch util/aio-posix.c:423:5
        #7 0x562cc4a8a2da in aio_ctx_dispatch util/async.c:358:5
        #8 0x7f36840547a8 in g_main_context_dispatch (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x547a8)
        #9 0x562cc4a8b753 in glib_pollfds_poll util/main-loop.c:290:9
        #10 0x562cc4a8b753 in os_host_main_loop_wait util/main-loop.c:313:5
        #11 0x562cc4a8b753 in main_loop_wait util/main-loop.c:592:11
        #12 0x562cc3938186 in qemu_main_loop system/runstate.c:782:9
        #13 0x562cc43b7af5 in qemu_default_main system/main.c:37:14
        #14 0x7f3683a6c189 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
        #15 0x7f3683a6c244 in __libc_start_main csu/../csu/libc-start.c:381:3
        #16 0x562cc2a58ac0 in _start (qemu-system-i386+0x231bac0)

    0x60d000011178 is located 56 bytes inside of 136-byte region [0x60d000011140,0x60d0000111c8)
    freed by thread T0 here:
        #0 0x562cc2adb662 in __interceptor_free (qemu-system-i386+0x239e662)
        #1 0x562cc3b86b21 in virtio_gpu_reset hw/display/virtio-gpu.c:1524:9
        #2 0x562cc416e20e in virtio_reset hw/virtio/virtio.c:2145:9
        #3 0x562cc37c5644 in virtio_pci_reset hw/virtio/virtio-pci.c:2249:5
        #4 0x562cc4233758 in memory_region_write_accessor system/memory.c:497:5
        #5 0x562cc4232eea in access_with_adjusted_size system/memory.c:573:18

    previously allocated by thread T0 here:
        #0 0x562cc2adb90e in malloc (qemu-system-i386+0x239e90e)
        #1 0x7f368405a678 in g_malloc (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x5a678)
        #2 0x562cc4163ffc in virtqueue_split_pop hw/virtio/virtio.c:1612:12
        #3 0x562cc4163ffc in virtqueue_pop hw/virtio/virtio.c:1783:16
        #4 0x562cc3b91a95 in virtio_gpu_handle_ctrl hw/display/virtio-gpu.c:1112:15
        #5 0x562cc4a85514 in aio_bh_call util/async.c:169:5
        #6 0x562cc4a85c52 in aio_bh_poll util/async.c:216:13
        #7 0x562cc4a1a79b in aio_dispatch util/aio-posix.c:423:5

    SUMMARY: AddressSanitizer: heap-use-after-free hw/display/virtio-gpu.c:180:42 in virtio_gpu_ctrl_response

  With this change, the same reproducer triggers:

    qemu-system-i386: warning: Blocked re-entrant IO on MemoryRegion: virtio-pci-common-virtio-gpu at addr: 0x6

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Reported-by: Yongkang Jia <kangel@zju.edu.cn>
  Reported-by: Xiao Lei <nop.leixiao@gmail.com>
  Reported-by: Yiming Tao <taoym@zju.edu.cn>
  Buglink: https://bugs.launchpad.net/qemu/+bug/1888606
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-3-philmd@linaro.org>
  (cherry picked from commit ba28e0ff4d95b56dc334aac2730ab3651ffc3132)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  (Mjt: context fixup in hw/display/virtio-gpu.c:virtio_gpu_device_realize()
   due to missing v8.1.0-rc2-69-ga41e2d97f92b
   "virtio-gpu: reset gfx resources in main thread".
   Maybe it's worth to pick this too)
  f243175727903a0d2b52422e7baef86c1838a895:Merge tag 'hw-misc-20240410' of https://github.com/philmd/qemu into staging

  Misc HW patch queue

  - Fix CXL Fixed Memory Window interleave-granularity typo
  - Fix for DMA re-entrancy abuse with VirtIO devices (CVE-2024-3446)
  - Fix out-of-bound access in NAND block buffer
  - Fix memory leak in AppleSMC reset() handler
  - Avoid VirtIO crypto backends abort o invalid session ID
  - Fix overflow in LAN9118 MIL TX FIFO
  - Fix overflow when abusing SDHCI TRNMOD register (CVE-2024-3447)
  - Fix overrun in short fragmented packet SCTP checksum (CVE-2024-3567)
  - Remove unused assignment in virtio-snd model (Coverity 1542933 & 1542934)

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQIzBAABCAAdFiEE+qvnXhKRciHc/Wuy4+MsLN6twN4FAmYWV94ACgkQ4+MsLN6t
  # wN4+ew/+PqDmL4S8xXGQPi6Q8fxAogbwo1mPptDO2y8ChEjtc9LI5HOLu90EYz7A
  # s62SPDsh3gx8vOthrJVEk0LqCbw4N3s5dFdmHNrnjXCsKQFifgucQ+yZy8ipy34N
  # wWHSJ9nipBQLvkK23iCxkbl3cTyr44Rlweae/TZR4/FjFCEe3N555LQU0fruEqRo
  # AHW1RjYhGvOfL9knLWzIQqW2QjcCnKky3bJhwHh3crfWE69nvVJTkbSF6oUxWSG0
  # RzSToK3nN5tmvUlyvbTBE9u0K9JkOcbtMQiAgj39nR9xpsaUZZa0zSWOmliYIuBC
  # kWuUY0/nAQk6gxHBKyu8q09ACBbzeCp+lVPOYXdxax8QMeURSa9fB1qY7JmI5QAZ
  # bg0ypD2pvbxhidU5TWpw7araAYyBOJrEYjnOkhXB4oa01ZWu2d0uNhGWo83h3Wjy
  # ahKrNDoVIQIdh8QkYy/ZqDwhCMoNM+pQcfUzsYxkqZC/JiiM/qxm87pTHQ/x2yQA
  # l0MLzljGv90/dklokrqeg4REwMqfwzc74PUbKdCk43saemmatslK3ktu3xAzUlQW
  # 2xmZQTnKwXDf+U3YnYryDddow2LsU7qlu8dlDGNd0WIrE5LRCCXzhv8la66O0jVE
  # qMOHpBPkwMlACBwiXuxV6ucelk4vy+XvabeQUsizm0m+PR7TwJY=
  # =9phd
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Wed 10 Apr 2024 10:11:58 BST
  # gpg:                using RSA key FAABE75E12917221DCFD6BB2E3E32C2CDEADC0DE
  # gpg: Good signature from "Philippe Mathieu-Daudé (F4BUG) <f4bug@amsat.org>" [full]
  # Primary key fingerprint: FAAB E75E 1291 7221 DCFD  6BB2 E3E3 2C2C DEAD C0DE

  * tag 'hw-misc-20240410' of https://github.com/philmd/qemu:
    hw/audio/virtio-snd: Remove unused assignment
    hw/net/net_tx_pkt: Fix overrun in update_sctp_checksum()
    hw/sd/sdhci: Do not update TRNMOD when Command Inhibit (DAT) is set
    hw/net/lan9118: Fix overflow in MIL TX FIFO
    hw/net/lan9118: Replace magic '2048' value by MIL_TXFIFO_SIZE definition
    backends/cryptodev: Do not abort for invalid session ID
    hw/misc/applesmc: Fix memory leak in reset() handler
    hw/misc/applesmc: Do not call DeviceReset from DeviceRealize
    hw/block/nand: Fix out-of-bound access in NAND block buffer
    hw/block/nand: Have blk_load() take unsigned offset and return boolean
    hw/block/nand: Factor nand_load_iolen() method out
    qemu-options: Fix CXL Fixed Memory Window interleave-granularity typo
    hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs
    hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs
    hw/display/virtio-gpu: Protect from DMA re-entrancy bugs
    hw/virtio: Introduce virtio_bh_new_guarded() helper

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  f4729ec39ad97a42ceaa7b5697f84f440ea6e5dc:hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed.

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Suggested-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-5-philmd@linaro.org>
  b4295bff25f7b50de1d9cc94a9c6effd40056bca:hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed.

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Suggested-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-4-philmd@linaro.org>
  ba28e0ff4d95b56dc334aac2730ab3651ffc3132:hw/display/virtio-gpu: Protect from DMA re-entrancy bugs

  Replace qemu_bh_new_guarded() by virtio_bh_new_guarded()
  so the bus and device use the same guard. Otherwise the
  DMA-reentrancy protection can be bypassed:

    $ cat << EOF | qemu-system-i386 -display none -nodefaults \
                                    -machine q35,accel=qtest \
                                    -m 512M \
                                    -device virtio-gpu \
                                    -qtest stdio
    outl 0xcf8 0x80000820
    outl 0xcfc 0xe0004000
    outl 0xcf8 0x80000804
    outw 0xcfc 0x06
    write 0xe0004030 0x4 0x024000e0
    write 0xe0004028 0x1 0xff
    write 0xe0004020 0x4 0x00009300
    write 0xe000401c 0x1 0x01
    write 0x101 0x1 0x04
    write 0x103 0x1 0x1c
    write 0x9301c8 0x1 0x18
    write 0x105 0x1 0x1c
    write 0x107 0x1 0x1c
    write 0x109 0x1 0x1c
    write 0x10b 0x1 0x00
    write 0x10d 0x1 0x00
    write 0x10f 0x1 0x00
    write 0x111 0x1 0x00
    write 0x113 0x1 0x00
    write 0x115 0x1 0x00
    write 0x117 0x1 0x00
    write 0x119 0x1 0x00
    write 0x11b 0x1 0x00
    write 0x11d 0x1 0x00
    write 0x11f 0x1 0x00
    write 0x121 0x1 0x00
    write 0x123 0x1 0x00
    write 0x125 0x1 0x00
    write 0x127 0x1 0x00
    write 0x129 0x1 0x00
    write 0x12b 0x1 0x00
    write 0x12d 0x1 0x00
    write 0x12f 0x1 0x00
    write 0x131 0x1 0x00
    write 0x133 0x1 0x00
    write 0x135 0x1 0x00
    write 0x137 0x1 0x00
    write 0x139 0x1 0x00
    write 0xe0007003 0x1 0x00
    EOF
    ...
    =================================================================
    ==276099==ERROR: AddressSanitizer: heap-use-after-free on address 0x60d000011178
    at pc 0x562cc3b736c7 bp 0x7ffed49dee60 sp 0x7ffed49dee58
    READ of size 8 at 0x60d000011178 thread T0
        #0 0x562cc3b736c6 in virtio_gpu_ctrl_response hw/display/virtio-gpu.c:180:42
        #1 0x562cc3b7c40b in virtio_gpu_ctrl_response_nodata hw/display/virtio-gpu.c:192:5
        #2 0x562cc3b7c40b in virtio_gpu_simple_process_cmd hw/display/virtio-gpu.c:1015:13
        #3 0x562cc3b82873 in virtio_gpu_process_cmdq hw/display/virtio-gpu.c:1050:9
        #4 0x562cc4a85514 in aio_bh_call util/async.c:169:5
        #5 0x562cc4a85c52 in aio_bh_poll util/async.c:216:13
        #6 0x562cc4a1a79b in aio_dispatch util/aio-posix.c:423:5
        #7 0x562cc4a8a2da in aio_ctx_dispatch util/async.c:358:5
        #8 0x7f36840547a8 in g_main_context_dispatch (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x547a8)
        #9 0x562cc4a8b753 in glib_pollfds_poll util/main-loop.c:290:9
        #10 0x562cc4a8b753 in os_host_main_loop_wait util/main-loop.c:313:5
        #11 0x562cc4a8b753 in main_loop_wait util/main-loop.c:592:11
        #12 0x562cc3938186 in qemu_main_loop system/runstate.c:782:9
        #13 0x562cc43b7af5 in qemu_default_main system/main.c:37:14
        #14 0x7f3683a6c189 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16
        #15 0x7f3683a6c244 in __libc_start_main csu/../csu/libc-start.c:381:3
        #16 0x562cc2a58ac0 in _start (qemu-system-i386+0x231bac0)

    0x60d000011178 is located 56 bytes inside of 136-byte region [0x60d000011140,0x60d0000111c8)
    freed by thread T0 here:
        #0 0x562cc2adb662 in __interceptor_free (qemu-system-i386+0x239e662)
        #1 0x562cc3b86b21 in virtio_gpu_reset hw/display/virtio-gpu.c:1524:9
        #2 0x562cc416e20e in virtio_reset hw/virtio/virtio.c:2145:9
        #3 0x562cc37c5644 in virtio_pci_reset hw/virtio/virtio-pci.c:2249:5
        #4 0x562cc4233758 in memory_region_write_accessor system/memory.c:497:5
        #5 0x562cc4232eea in access_with_adjusted_size system/memory.c:573:18

    previously allocated by thread T0 here:
        #0 0x562cc2adb90e in malloc (qemu-system-i386+0x239e90e)
        #1 0x7f368405a678 in g_malloc (/lib/x86_64-linux-gnu/libglib-2.0.so.0+0x5a678)
        #2 0x562cc4163ffc in virtqueue_split_pop hw/virtio/virtio.c:1612:12
        #3 0x562cc4163ffc in virtqueue_pop hw/virtio/virtio.c:1783:16
        #4 0x562cc3b91a95 in virtio_gpu_handle_ctrl hw/display/virtio-gpu.c:1112:15
        #5 0x562cc4a85514 in aio_bh_call util/async.c:169:5
        #6 0x562cc4a85c52 in aio_bh_poll util/async.c:216:13
        #7 0x562cc4a1a79b in aio_dispatch util/aio-posix.c:423:5

    SUMMARY: AddressSanitizer: heap-use-after-free hw/display/virtio-gpu.c:180:42 in virtio_gpu_ctrl_response

  With this change, the same reproducer triggers:

    qemu-system-i386: warning: Blocked re-entrant IO on MemoryRegion: virtio-pci-common-virtio-gpu at addr: 0x6

  Fixes: CVE-2024-3446
  Cc: qemu-stable@nongnu.org
  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Reported-by: Yongkang Jia <kangel@zju.edu.cn>
  Reported-by: Xiao Lei <nop.leixiao@gmail.com>
  Reported-by: Yiming Tao <taoym@zju.edu.cn>
  Buglink: https://bugs.launchpad.net/qemu/+bug/1888606
  Reviewed-by: Gerd Hoffmann <kraxel@redhat.com>
  Acked-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@linaro.org>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Message-Id: <20240409105537.18308-3-philmd@linaro.org>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 4f01537ced3e787bd985b8f8de5869b92657160a
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 6d37a308159766cb90ed745cfeb1880937b638ec
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f243175727903a0d2b52422e7baef86c1838a895
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 7aaf5f7778de4d75a169ab193f08857eb28db3a4
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 1b2a52712b249e14d246cd9c7db126088e6e64db
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b4295bff25f7b50de1d9cc94a9c6effd40056bca
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e7c2df3fd748a20a8b7a316d186b3ac77551f159
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: fbeb0a160cbcc067c0e1f0d380cea4a31de213e3
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: ba28e0ff4d95b56dc334aac2730ab3651ffc3132
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f4729ec39ad97a42ceaa7b5697f84f440ea6e5dc
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
