advisory_id: CVE-2021-3748
datasource_id: collect_qemu_fix_commits/CVE-2021-3748
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  9e41f16fca436a666ee79f5219797a2c58b6cf19:virtio-net: fix use after unmap/free for sg

  When mergeable buffer is enabled, we try to set the num_buffers after
  the virtqueue elem has been unmapped. This will lead several issues,
  E.g a use after free when the descriptor has an address which belongs
  to the non direct access region. In this case we use bounce buffer
  that is allocated during address_space_map() and freed during
  address_space_unmap().

  Fixing this by storing the elems temporarily in an array and delay the
  unmap after we set the the num_buffers.

  This addresses CVE-2021-3748.

  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Fixes: fbe78f4f55c6 ("virtio-net support")
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Jason Wang <jasowang@redhat.com>
  (cherry picked from commit bedd7e93d01961fcb16a97ae45d93acf357e11f6)
  Signed-off-by: Michael Roth <michael.roth@amd.com>
  5881d76ff41ab898751babdf26ea668cb8fb7a0e:virtio-net: fix use after unmap/free for sg

  When mergeable buffer is enabled, we try to set the num_buffers after
  the virtqueue elem has been unmapped. This will lead several issues,
  E.g a use after free when the descriptor has an address which belongs
  to the non direct access region. In this case we use bounce buffer
  that is allocated during address_space_map() and freed during
  address_space_unmap().

  Fixing this by storing the elems temporarily in an array and delay the
  unmap after we set the the num_buffers.

  This addresses CVE-2021-3748.

  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Fixes: fbe78f4f55c6 ("virtio-net support")
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Jason Wang <jasowang@redhat.com>
  (cherry picked from commit bedd7e93d01961fcb16a97ae45d93acf357e11f6)
  Signed-off-by: Michael Roth <michael.roth@amd.com>
  bedd7e93d01961fcb16a97ae45d93acf357e11f6:virtio-net: fix use after unmap/free for sg

  When mergeable buffer is enabled, we try to set the num_buffers after
  the virtqueue elem has been unmapped. This will lead several issues,
  E.g a use after free when the descriptor has an address which belongs
  to the non direct access region. In this case we use bounce buffer
  that is allocated during address_space_map() and freed during
  address_space_unmap().

  Fixing this by storing the elems temporarily in an array and delay the
  unmap after we set the the num_buffers.

  This addresses CVE-2021-3748.

  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Fixes: fbe78f4f55c6 ("virtio-net support")
  Cc: qemu-stable@nongnu.org
  Signed-off-by: Jason Wang <jasowang@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: bedd7e93d01961fcb16a97ae45d93acf357e11f6
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 5881d76ff41ab898751babdf26ea668cb8fb7a0e
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9e41f16fca436a666ee79f5219797a2c58b6cf19
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
