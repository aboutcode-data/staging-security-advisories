advisory_id: CVE-2015-3456
datasource_id: collect_qemu_fix_commits/CVE-2015-3456
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  959fad0ff11837d299e22b0f148c608b50eec457:fdc: force the fifo access to be in bounds of the allocated buffer

  During processing of certain commands such as FD_CMD_READ_ID and
  FD_CMD_DRIVE_SPECIFICATION_COMMAND the fifo memory access could
  get out of bounds leading to memory corruption with values coming
  from the guest.

  Fix this by making sure that the index is always bounded by the
  allocated memory.

  This is CVE-2015-3456.

  Signed-off-by: Petr Matousek <pmatouse@redhat.com>
  Reviewed-by: John Snow <jsnow@redhat.com>
  Signed-off-by: John Snow <jsnow@redhat.com>
  (cherry picked from commit e907746266721f305d67bc0718795fedee2e824c)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  6cc8a11c84ddc18c64fc88d54c8e9dca24ada489:fdc: Fix MSR.RQM flag

  The RQM bit in MSR should be set whenever the guest is supposed to
  access the FIFO, and it should be cleared in all other cases. This is
  important so the guest can't continue writing/reading the FIFO beyond
  the length that it's suppossed to access (see CVE-2015-3456).

  Commit e9077462 fixed the CVE by adding code that avoids the buffer
  overflow; however it doesn't correct the wrong behaviour of the floppy
  controller which should already have cleared RQM.

  Currently, RQM stays set all the time and during all phases while a
  command is being processed. This is error-prone because the command has
  to explicitly clear the flag if it doesn't need data (and indeed, the
  two buggy commands that are the culprits for the CVE just forgot to do
  that).

  This patch clears RQM immediately as soon as all bytes that are expected
  have been received. If the the FIFO is used in the next phase, the flag
  has to be set explicitly there.

  It also clear RQM after receiving all bytes even if the phase transition
  immediately sets it again. While it's technically not necessary at the
  moment because the state between clearing and setting RQM is not
  observable by the guest, this is more explicit and matches how real
  hardware works. It will actually become necessary in qemu once
  asynchronous code paths are introduced.

  This alone should have been enough to fix the CVE, but now we have two
  lines of defense - even better.

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: John Snow <jsnow@redhat.com>
  Message-id: 1432214378-31891-8-git-send-email-kwolf@redhat.com
  Signed-off-by: John Snow <jsnow@redhat.com>
  e907746266721f305d67bc0718795fedee2e824c:fdc: force the fifo access to be in bounds of the allocated buffer

  During processing of certain commands such as FD_CMD_READ_ID and
  FD_CMD_DRIVE_SPECIFICATION_COMMAND the fifo memory access could
  get out of bounds leading to memory corruption with values coming
  from the guest.

  Fix this by making sure that the index is always bounded by the
  allocated memory.

  This is CVE-2015-3456.

  Signed-off-by: Petr Matousek <pmatouse@redhat.com>
  Reviewed-by: John Snow <jsnow@redhat.com>
  Signed-off-by: John Snow <jsnow@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 6cc8a11c84ddc18c64fc88d54c8e9dca24ada489
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 959fad0ff11837d299e22b0f148c608b50eec457
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e907746266721f305d67bc0718795fedee2e824c
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
