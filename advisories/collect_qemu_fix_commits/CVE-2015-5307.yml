advisory_id: CVE-2015-5307
datasource_id: collect_qemu_fix_commits/CVE-2015-5307
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  e2e69f6bb907a70ac518230c54e98e7abcb0c911:i386: add notify VM exit support

  There are cases that malicious virtual machine can cause CPU stuck (due
  to event windows don't open up), e.g., infinite loop in microcode when
  nested #AC (CVE-2015-5307). No event window means no event (NMI, SMI and
  IRQ) can be delivered. It leads the CPU to be unavailable to host or
  other VMs. Notify VM exit is introduced to mitigate such kind of
  attacks, which will generate a VM exit if no event window occurs in VM
  non-root mode for a specified amount of time (notify window).

  A new KVM capability KVM_CAP_X86_NOTIFY_VMEXIT is exposed to user space
  so that the user can query the capability and set the expected notify
  window when creating VMs. The format of the argument when enabling this
  capability is as follows:
    Bit 63:32 - notify window specified in qemu command
    Bit 31:0  - some flags (e.g. KVM_X86_NOTIFY_VMEXIT_ENABLED is set to
                enable the feature.)

  Users can configure the feature by a new (x86 only) accel property:
      qemu -accel kvm,notify-vmexit=run|internal-error|disable,notify-window=n

  The default option of notify-vmexit is run, which will enable the
  capability and do nothing if the exit happens. The internal-error option
  raises a KVM internal error if it happens. The disable option does not
  enable the capability. The default value of notify-window is 0. It is valid
  only when notify-vmexit is not disabled. The valid range of notify-window
  is non-negative. It is even safe to set it to zero since there's an
  internal hardware threshold to be added to ensure no false positive.

  Because a notify VM exit may happen with VM_CONTEXT_INVALID set in exit
  qualification (no cases are anticipated that would set this bit), which
  means VM context is corrupted. It would be reflected in the flags of
  KVM_EXIT_NOTIFY exit. If KVM_NOTIFY_CONTEXT_INVALID bit is set, raise a KVM
  internal error unconditionally.

  Acked-by: Peter Xu <peterx@redhat.com>
  Signed-off-by: Chenyi Qiang <chenyi.qiang@intel.com>
  Message-Id: <20220929072014.20705-5-chenyi.qiang@intel.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e2e69f6bb907a70ac518230c54e98e7abcb0c911
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
