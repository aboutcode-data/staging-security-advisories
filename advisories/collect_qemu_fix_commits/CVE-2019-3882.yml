advisory_id: CVE-2019-3882
datasource_id: collect_qemu_fix_commits/CVE-2019-3882
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  072a8d3693b40f46efcc7b05f6f4136760e57612:block/nvme: Fix VFIO_MAP_DMA failed: No space left on device

  When the NVMe block driver was introduced (see commit bdd6a90a9e5,
  January 2018), Linux VFIO_IOMMU_MAP_DMA ioctl was only returning
  -ENOMEM in case of error. The driver was correctly handling the
  error path to recycle its volatile IOVA mappings.

  To fix CVE-2019-3882, Linux commit 492855939bdb ("vfio/type1: Limit
  DMA mappings per container", April 2019) added the -ENOSPC error to
  signal the user exhausted the DMA mappings available for a container.

  The block driver started to mis-behave:

    qemu-system-x86_64: VFIO_MAP_DMA failed: No space left on device
    (qemu)
    (qemu) info status
    VM status: paused (io-error)
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device

  (The VM is not resumable from here, hence stuck.)

  Fix by handling the new -ENOSPC error (when DMA mappings are
  exhausted) without any distinction to the current -ENOMEM error,
  so we don't change the behavior on old kernels where the CVE-2019-3882
  fix is not present.

  An easy way to reproduce this bug is to restrict the DMA mapping
  limit (65535 by default) when loading the VFIO IOMMU module:

    # modprobe vfio_iommu_type1 dma_entry_limit=666

  Cc: qemu-stable@nongnu.org
  Cc: Fam Zheng <fam@euphon.net>
  Cc: Maxim Levitsky <mlevitsk@redhat.com>
  Cc: Alex Williamson <alex.williamson@redhat.com>
  Reported-by: Michal Prívozník <mprivozn@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Message-id: 20210723195843.1032825-1-philmd@redhat.com
  Fixes: bdd6a90a9e5 ("block: Add VFIO based NVMe driver")
  Buglink: https://bugs.launchpad.net/qemu/+bug/1863333
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/65
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 15a730e7a3aaac180df72cd5730e0617bcf44a5a)
  Signed-off-by: Michael Roth <michael.roth@amd.com>
  072a8d3693b40f46efcc7b05f6f4136760e57612:block/nvme: Fix VFIO_MAP_DMA failed: No space left on device

  When the NVMe block driver was introduced (see commit bdd6a90a9e5,
  January 2018), Linux VFIO_IOMMU_MAP_DMA ioctl was only returning
  -ENOMEM in case of error. The driver was correctly handling the
  error path to recycle its volatile IOVA mappings.

  To fix CVE-2019-3882, Linux commit 492855939bdb ("vfio/type1: Limit
  DMA mappings per container", April 2019) added the -ENOSPC error to
  signal the user exhausted the DMA mappings available for a container.

  The block driver started to mis-behave:

    qemu-system-x86_64: VFIO_MAP_DMA failed: No space left on device
    (qemu)
    (qemu) info status
    VM status: paused (io-error)
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device

  (The VM is not resumable from here, hence stuck.)

  Fix by handling the new -ENOSPC error (when DMA mappings are
  exhausted) without any distinction to the current -ENOMEM error,
  so we don't change the behavior on old kernels where the CVE-2019-3882
  fix is not present.

  An easy way to reproduce this bug is to restrict the DMA mapping
  limit (65535 by default) when loading the VFIO IOMMU module:

    # modprobe vfio_iommu_type1 dma_entry_limit=666

  Cc: qemu-stable@nongnu.org
  Cc: Fam Zheng <fam@euphon.net>
  Cc: Maxim Levitsky <mlevitsk@redhat.com>
  Cc: Alex Williamson <alex.williamson@redhat.com>
  Reported-by: Michal Prívozník <mprivozn@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Message-id: 20210723195843.1032825-1-philmd@redhat.com
  Fixes: bdd6a90a9e5 ("block: Add VFIO based NVMe driver")
  Buglink: https://bugs.launchpad.net/qemu/+bug/1863333
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/65
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 15a730e7a3aaac180df72cd5730e0617bcf44a5a)
  Signed-off-by: Michael Roth <michael.roth@amd.com>
  15a730e7a3aaac180df72cd5730e0617bcf44a5a:block/nvme: Fix VFIO_MAP_DMA failed: No space left on device

  When the NVMe block driver was introduced (see commit bdd6a90a9e5,
  January 2018), Linux VFIO_IOMMU_MAP_DMA ioctl was only returning
  -ENOMEM in case of error. The driver was correctly handling the
  error path to recycle its volatile IOVA mappings.

  To fix CVE-2019-3882, Linux commit 492855939bdb ("vfio/type1: Limit
  DMA mappings per container", April 2019) added the -ENOSPC error to
  signal the user exhausted the DMA mappings available for a container.

  The block driver started to mis-behave:

    qemu-system-x86_64: VFIO_MAP_DMA failed: No space left on device
    (qemu)
    (qemu) info status
    VM status: paused (io-error)
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device

  (The VM is not resumable from here, hence stuck.)

  Fix by handling the new -ENOSPC error (when DMA mappings are
  exhausted) without any distinction to the current -ENOMEM error,
  so we don't change the behavior on old kernels where the CVE-2019-3882
  fix is not present.

  An easy way to reproduce this bug is to restrict the DMA mapping
  limit (65535 by default) when loading the VFIO IOMMU module:

    # modprobe vfio_iommu_type1 dma_entry_limit=666

  Cc: qemu-stable@nongnu.org
  Cc: Fam Zheng <fam@euphon.net>
  Cc: Maxim Levitsky <mlevitsk@redhat.com>
  Cc: Alex Williamson <alex.williamson@redhat.com>
  Reported-by: Michal Prívozník <mprivozn@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Message-id: 20210723195843.1032825-1-philmd@redhat.com
  Fixes: bdd6a90a9e5 ("block: Add VFIO based NVMe driver")
  Buglink: https://bugs.launchpad.net/qemu/+bug/1863333
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/65
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  15a730e7a3aaac180df72cd5730e0617bcf44a5a:block/nvme: Fix VFIO_MAP_DMA failed: No space left on device

  When the NVMe block driver was introduced (see commit bdd6a90a9e5,
  January 2018), Linux VFIO_IOMMU_MAP_DMA ioctl was only returning
  -ENOMEM in case of error. The driver was correctly handling the
  error path to recycle its volatile IOVA mappings.

  To fix CVE-2019-3882, Linux commit 492855939bdb ("vfio/type1: Limit
  DMA mappings per container", April 2019) added the -ENOSPC error to
  signal the user exhausted the DMA mappings available for a container.

  The block driver started to mis-behave:

    qemu-system-x86_64: VFIO_MAP_DMA failed: No space left on device
    (qemu)
    (qemu) info status
    VM status: paused (io-error)
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device
    (qemu) c
    VFIO_MAP_DMA failed: No space left on device

  (The VM is not resumable from here, hence stuck.)

  Fix by handling the new -ENOSPC error (when DMA mappings are
  exhausted) without any distinction to the current -ENOMEM error,
  so we don't change the behavior on old kernels where the CVE-2019-3882
  fix is not present.

  An easy way to reproduce this bug is to restrict the DMA mapping
  limit (65535 by default) when loading the VFIO IOMMU module:

    # modprobe vfio_iommu_type1 dma_entry_limit=666

  Cc: qemu-stable@nongnu.org
  Cc: Fam Zheng <fam@euphon.net>
  Cc: Maxim Levitsky <mlevitsk@redhat.com>
  Cc: Alex Williamson <alex.williamson@redhat.com>
  Reported-by: Michal Prívozník <mprivozn@redhat.com>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Message-id: 20210723195843.1032825-1-philmd@redhat.com
  Fixes: bdd6a90a9e5 ("block: Add VFIO based NVMe driver")
  Buglink: https://bugs.launchpad.net/qemu/+bug/1863333
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/65
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 072a8d3693b40f46efcc7b05f6f4136760e57612
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 15a730e7a3aaac180df72cd5730e0617bcf44a5a
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
