advisory_id: CVE-2017-7493
datasource_id: collect_qemu_fix_commits/CVE-2017-7493
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  7442018a001c8e626a46d19488f470c1fdb162cf:9pfs: local: forbid client access to metadata (CVE-2017-7493)

  When using the mapped-file security mode, we shouldn't let the client mess
  with the metadata. The current code already tries to hide the metadata dir
  from the client by skipping it in local_readdir(). But the client can still
  access or modify it through several other operations. This can be used to
  escalate privileges in the guest.

  Affected backend operations are:
  - local_mknod()
  - local_mkdir()
  - local_open2()
  - local_symlink()
  - local_link()
  - local_unlinkat()
  - local_renameat()
  - local_rename()
  - local_name_to_path()

  Other operations are safe because they are only passed a fid path, which
  is computed internally in local_name_to_path().

  This patch converts all the functions listed above to fail and return
  EINVAL when being passed the name of the metadata dir. This may look
  like a poor choice for errno, but there's no such thing as an illegal
  path name on Linux and I could not think of anything better.

  This fixes CVE-2017-7493.

  Reported-by: Leo Gaspard <leo@gaspard.io>
  Signed-off-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  (cherry picked from commit 7a95434e0ca8a037fd8aa1a2e2461f92585eb77b)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  7442018a001c8e626a46d19488f470c1fdb162cf:9pfs: local: forbid client access to metadata (CVE-2017-7493)

  When using the mapped-file security mode, we shouldn't let the client mess
  with the metadata. The current code already tries to hide the metadata dir
  from the client by skipping it in local_readdir(). But the client can still
  access or modify it through several other operations. This can be used to
  escalate privileges in the guest.

  Affected backend operations are:
  - local_mknod()
  - local_mkdir()
  - local_open2()
  - local_symlink()
  - local_link()
  - local_unlinkat()
  - local_renameat()
  - local_rename()
  - local_name_to_path()

  Other operations are safe because they are only passed a fid path, which
  is computed internally in local_name_to_path().

  This patch converts all the functions listed above to fail and return
  EINVAL when being passed the name of the metadata dir. This may look
  like a poor choice for errno, but there's no such thing as an illegal
  path name on Linux and I could not think of anything better.

  This fixes CVE-2017-7493.

  Reported-by: Leo Gaspard <leo@gaspard.io>
  Signed-off-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  (cherry picked from commit 7a95434e0ca8a037fd8aa1a2e2461f92585eb77b)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  96cd59981805b2d0addb86967d35f60d660ec9dc:Merge remote-tracking branch 'gkurz/tags/security-fix-for-2.10' into staging

  Fix for CVE-2017-7493.

  # gpg: Signature made Mon 15 May 2017 07:48:20 PM BST
  # gpg:                using DSA key 0x02FC3AEB0101DBC2
  # gpg: Good signature from "Greg Kurz <groug@kaod.org>"
  # gpg:                 aka "Greg Kurz <groug@free.fr>"
  # gpg:                 aka "Greg Kurz <gkurz@fr.ibm.com>"
  # gpg:                 aka "Greg Kurz <gkurz@linux.vnet.ibm.com>"
  # gpg:                 aka "Gregory Kurz (Groug) <groug@free.fr>"
  # gpg:                 aka "Gregory Kurz (Cimai Technology) <gkurz@cimai.com>"
  # gpg:                 aka "Gregory Kurz (Meiosys Technology) <gkurz@meiosys.com>"
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: 2BD4 3B44 535E C0A7 9894  DBA2 02FC 3AEB 0101 DBC2

  * gkurz/tags/security-fix-for-2.10:
    9pfs: local: forbid client access to metadata (CVE-2017-7493)

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  96cd59981805b2d0addb86967d35f60d660ec9dc:Merge remote-tracking branch 'gkurz/tags/security-fix-for-2.10' into staging

  Fix for CVE-2017-7493.

  # gpg: Signature made Mon 15 May 2017 07:48:20 PM BST
  # gpg:                using DSA key 0x02FC3AEB0101DBC2
  # gpg: Good signature from "Greg Kurz <groug@kaod.org>"
  # gpg:                 aka "Greg Kurz <groug@free.fr>"
  # gpg:                 aka "Greg Kurz <gkurz@fr.ibm.com>"
  # gpg:                 aka "Greg Kurz <gkurz@linux.vnet.ibm.com>"
  # gpg:                 aka "Gregory Kurz (Groug) <groug@free.fr>"
  # gpg:                 aka "Gregory Kurz (Cimai Technology) <gkurz@cimai.com>"
  # gpg:                 aka "Gregory Kurz (Meiosys Technology) <gkurz@meiosys.com>"
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: 2BD4 3B44 535E C0A7 9894  DBA2 02FC 3AEB 0101 DBC2

  * gkurz/tags/security-fix-for-2.10:
    9pfs: local: forbid client access to metadata (CVE-2017-7493)

  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  7a95434e0ca8a037fd8aa1a2e2461f92585eb77b:9pfs: local: forbid client access to metadata (CVE-2017-7493)

  When using the mapped-file security mode, we shouldn't let the client mess
  with the metadata. The current code already tries to hide the metadata dir
  from the client by skipping it in local_readdir(). But the client can still
  access or modify it through several other operations. This can be used to
  escalate privileges in the guest.

  Affected backend operations are:
  - local_mknod()
  - local_mkdir()
  - local_open2()
  - local_symlink()
  - local_link()
  - local_unlinkat()
  - local_renameat()
  - local_rename()
  - local_name_to_path()

  Other operations are safe because they are only passed a fid path, which
  is computed internally in local_name_to_path().

  This patch converts all the functions listed above to fail and return
  EINVAL when being passed the name of the metadata dir. This may look
  like a poor choice for errno, but there's no such thing as an illegal
  path name on Linux and I could not think of anything better.

  This fixes CVE-2017-7493.

  Reported-by: Leo Gaspard <leo@gaspard.io>
  Signed-off-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Eric Blake <eblake@redhat.com>
  7a95434e0ca8a037fd8aa1a2e2461f92585eb77b:9pfs: local: forbid client access to metadata (CVE-2017-7493)

  When using the mapped-file security mode, we shouldn't let the client mess
  with the metadata. The current code already tries to hide the metadata dir
  from the client by skipping it in local_readdir(). But the client can still
  access or modify it through several other operations. This can be used to
  escalate privileges in the guest.

  Affected backend operations are:
  - local_mknod()
  - local_mkdir()
  - local_open2()
  - local_symlink()
  - local_link()
  - local_unlinkat()
  - local_renameat()
  - local_rename()
  - local_name_to_path()

  Other operations are safe because they are only passed a fid path, which
  is computed internally in local_name_to_path().

  This patch converts all the functions listed above to fail and return
  EINVAL when being passed the name of the metadata dir. This may look
  like a poor choice for errno, but there's no such thing as an illegal
  path name on Linux and I could not think of anything better.

  This fixes CVE-2017-7493.

  Reported-by: Leo Gaspard <leo@gaspard.io>
  Signed-off-by: Greg Kurz <groug@kaod.org>
  Reviewed-by: Eric Blake <eblake@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 7442018a001c8e626a46d19488f470c1fdb162cf
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 96cd59981805b2d0addb86967d35f60d660ec9dc
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 7a95434e0ca8a037fd8aa1a2e2461f92585eb77b
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
