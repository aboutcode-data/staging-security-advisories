advisory_id: CVE-2018-16847
datasource_id: collect_qemu_fix_commits/CVE-2018-16847
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  e49f868dc0d6e7b56fe50bc592ace1c222dd647b:nvme: fix out-of-bounds access to the CMB

  Because the CMB BAR has a min_access_size of 2, if you read the last
  byte it will try to memcpy *2* bytes from n->cmbuf, causing an off-by-one
  error.  This is CVE-2018-16847.

  Another way to fix this might be to register the CMB as a RAM memory
  region, which would also be more efficient.  However, that might be a
  change for big-endian machines; I didn't think this through and I don't
  know how real hardware works.  Add a basic testcase for the CMB in case
  somebody does this change later on.

  Cc: Keith Busch <keith.busch@intel.com>
  Cc: qemu-block@nongnu.org
  Reported-by: Li Qiang <liq3ea@gmail.com>
  Reviewed-by: Li Qiang <liq3ea@gmail.com>
  Tested-by: Li Qiang <liq3ea@gmail.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  (cherry picked from commit 87ad860c622cc8f8916b5232bd8728c08f938fce)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  5298f4d67a911dd9cefa4c4185eed242074d64c2:Merge remote-tracking branch 'remotes/kevin/tags/for-upstream' into staging

  Block layer patches:

  - block: Fix update of BDRV_O_AUTO_RDONLY in update_flags_from_options()
  - block: Fix option inheritance after stream/commit job graph changes
  - qemu-img: Fix memory leak and typo in error message
  - nvme: Fixes for lockups and crashes
  - scsi-disk: Fix crash if underlying host file or disk returns error
  - Several qemu-iotests fixes and improvements

  # gpg: Signature made Thu 22 Nov 2018 18:38:30 GMT
  # gpg:                using RSA key 7F09B272C88F2FD6
  # gpg: Good signature from "Kevin Wolf <kwolf@redhat.com>"
  # Primary key fingerprint: DC3D EB15 9A9A F95D 3D74  56FE 7F09 B272 C88F 2FD6

  * remotes/kevin/tags/for-upstream:
    block: Update BlockDriverState.inherits_from on bdrv_drop_intermediate()
    block: Update BlockDriverState.inherits_from on bdrv_set_backing_hd()
    iotests: Enhance 223 to cover multiple bitmap granularities
    nvme: fix bug with PCI IRQ pins on teardown
    nvme: fix CMB endianness confusion
    Revert "nvme: fix oob access issue(CVE-2018-16847)"
    nvme: fix out-of-bounds access to the CMB
    nvme: call blk_drain in NVMe reset code to avoid lockups
    iotests: fix nbd test 233 to work correctly with raw images
    block: Fix update of BDRV_O_AUTO_RDONLY in update_flags_from_options()
    scsi-disk: Fix crash if underlying host file or disk returns error
    qemu-img: Fix leak
    qemu-img: Fix typo
    iotests: Skip 233 if certtool not installed
    iotests: Replace assertEquals() with assertEqual()
    iotests: Replace time.clock() with Timeout

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  2067d39e5e53b053bece6fa15711640123c119ed:Revert "nvme: fix oob access issue(CVE-2018-16847)"

  This reverts commit 5e3c0220d7e4f0361c4d36c697a8842f2b583402.
  We have a better fix commited for this now.

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  87ad860c622cc8f8916b5232bd8728c08f938fce:nvme: fix out-of-bounds access to the CMB

  Because the CMB BAR has a min_access_size of 2, if you read the last
  byte it will try to memcpy *2* bytes from n->cmbuf, causing an off-by-one
  error.  This is CVE-2018-16847.

  Another way to fix this might be to register the CMB as a RAM memory
  region, which would also be more efficient.  However, that might be a
  change for big-endian machines; I didn't think this through and I don't
  know how real hardware works.  Add a basic testcase for the CMB in case
  somebody does this change later on.

  Cc: Keith Busch <keith.busch@intel.com>
  Cc: qemu-block@nongnu.org
  Reported-by: Li Qiang <liq3ea@gmail.com>
  Reviewed-by: Li Qiang <liq3ea@gmail.com>
  Tested-by: Li Qiang <liq3ea@gmail.com>
  Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
  Reviewed-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Tested-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  e6ebbd46b6e539f3613136111977721d212c2812:Merge remote-tracking branch 'remotes/kevin/tags/for-upstream' into staging

  Block layer patches:

  - file-posix: Fix shared permission locks after reopen
  - block: Fix error path for failed .bdrv_reopen_prepare
  - qcow2: Catch invalid allocations when the image becomes too large
  - vvfat/fdc/nvme: Fix segfaults and leaks

  # gpg: Signature made Mon 19 Nov 2018 14:28:18 GMT
  # gpg:                using RSA key 7F09B272C88F2FD6
  # gpg: Good signature from "Kevin Wolf <kwolf@redhat.com>"
  # Primary key fingerprint: DC3D EB15 9A9A F95D 3D74  56FE 7F09 B272 C88F 2FD6

  * remotes/kevin/tags/for-upstream:
    iotests: Test file-posix locking and reopen
    file-posix: Fix shared locks on reopen commit
    block: Always abort reopen after prepare succeeded
    iotests: Add new test 220 for max compressed cluster offset
    qcow2: Don't allow overflow during cluster allocation
    qcow2: Document some maximum size constraints
    vvfat: Fix memory leak
    fdc: fix segfault in fdctrl_stop_transfer() when DMA is disabled
    nvme: fix oob access issue(CVE-2018-16847)

  Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
  5e3c0220d7e4f0361c4d36c697a8842f2b583402:nvme: fix oob access issue(CVE-2018-16847)

  Currently, the nvme_cmb_ops mr doesn't check the addr and size.
  This can lead an oob access issue. This is triggerable in the guest.
  Add check to avoid this issue.

  Fixes CVE-2018-16847.

  Reported-by: Li Qiang <liq3ea@gmail.com>
  Reviewed-by: Paolo Bonzini <pbonzini@redhat.com>
  Signed-off-by: Li Qiang <liq3ea@gmail.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  5e3c0220d7e4f0361c4d36c697a8842f2b583402:nvme: fix oob access issue(CVE-2018-16847)

  Currently, the nvme_cmb_ops mr doesn't check the addr and size.
  This can lead an oob access issue. This is triggerable in the guest.
  Add check to avoid this issue.

  Fixes CVE-2018-16847.

  Reported-by: Li Qiang <liq3ea@gmail.com>
  Reviewed-by: Paolo Bonzini <pbonzini@redhat.com>
  Signed-off-by: Li Qiang <liq3ea@gmail.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e49f868dc0d6e7b56fe50bc592ace1c222dd647b
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 87ad860c622cc8f8916b5232bd8728c08f938fce
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 5e3c0220d7e4f0361c4d36c697a8842f2b583402
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e6ebbd46b6e539f3613136111977721d212c2812
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 5298f4d67a911dd9cefa4c4185eed242074d64c2
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 2067d39e5e53b053bece6fa15711640123c119ed
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
