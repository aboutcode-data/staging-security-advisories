advisory_id: CVE-2018-15746
datasource_id: collect_qemu_fix_commits/CVE-2018-15746
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: "f43a6b314aa506afd70b56767ba704ddd5cbde2e:seccomp: set the seccomp filter to all threads\n\
  \nWhen using \"-seccomp on\", the seccomp policy is only applied to the\nmain thread, the\
  \ vcpu worker thread and other worker threads created\nafter seccomp policy is applied; the\
  \ seccomp policy is not applied to\ne.g. the RCU thread because it is created before the seccomp\
  \ policy is\napplied and SECCOMP_FILTER_FLAG_TSYNC isn't used.\n\nThis can be verified with\n\
  for task in /proc/`pidof qemu`/task/*; do cat $task/status | grep Secc ; done\nSeccomp:\t\
  2\nSeccomp:\t0\nSeccomp:\t0\nSeccomp:\t2\nSeccomp:\t2\nSeccomp:\t2\n\nStarting with libseccomp\
  \ 2.2.0 and kernel >= 3.17, we can use\nseccomp_attr_set(ctx, > SCMP_FLTATR_CTL_TSYNC, 1)\
  \ to update the policy\non all threads.\n\nlibseccomp requirement was bumped to 2.2.0 in previous\
  \ patch.\nlibseccomp should fail to set the filter if it can't honour\nSCMP_FLTATR_CTL_TSYNC\
  \ (untested), and thus -sandbox will now fail on\nkernel < 3.17.\n\nSigned-off-by: Marc-André\
  \ Lureau <marcandre.lureau@redhat.com>\nAcked-by: Eduardo Otubo <otubo@redhat.com>\n(cherry\
  \ picked from commit 70dfabeaa79ba4d7a3b699abe1a047c8012db114)\n*CVE-2018-15746\nSigned-off-by:\
  \ Michael Roth <mdroth@linux.vnet.ibm.com>\n9d01327689a786beba7aabab76816f689aa2565f:configure:\
  \ require libseccomp 2.2.0\n\nThe following patch is going to require TSYNC, which is only\
  \ available\nsince libseccomp 2.2.0.\n\nlibseccomp 2.2.0 was released February 12, 2015.\n\
  \nAccording to repology, libseccomp version in different distros:\n\n  RHEL-7: 2.3.1\n  Debian\
  \ (Stretch): 2.3.1\n  OpenSUSE Leap 15: 2.3.2\n  Ubuntu (Xenial):  2.3.1\n\nThis will drop\
  \ support for -sandbox on:\n\n  Debian (Jessie): 2.1.1 (but 2.2.3 in backports)\n\nSigned-off-by:\
  \ Marc-André Lureau <marcandre.lureau@redhat.com>\nAcked-by: Eduardo Otubo <otubo@redhat.com>\n\
  (cherry picked from commit d0699bd37c48067cffbd80383172efc29da6d2f9)\n*CVE-2018-15746\nSigned-off-by:\
  \ Michael Roth <mdroth@linux.vnet.ibm.com>\n9ad3314fa32a555c880344b960702af85ad6a231:seccomp:\
  \ prefer SCMP_ACT_KILL_PROCESS if available\n\nThe upcoming libseccomp release should have\
  \ SCMP_ACT_KILL_PROCESS\naction (https://github.com/seccomp/libseccomp/issues/96).\n\nSCMP_ACT_KILL_PROCESS\
  \ is preferable to immediately terminate the\noffending process, rather than having the SIGSYS\
  \ handler running.\n\nUse SECCOMP_GET_ACTION_AVAIL to check availability of kernel support,\n\
  as libseccomp will fallback on SCMP_ACT_KILL otherwise, and we still\nprefer SCMP_ACT_TRAP.\n\
  \nSigned-off-by: Marc-André Lureau <marcandre.lureau@redhat.com>\nReviewed-by: Daniel P. Berrangé\
  \ <berrange@redhat.com>\nAcked-by: Eduardo Otubo <otubo@redhat.com>\n(cherry picked from commit\
  \ bda08a5764d470f101fa38635d30b41179a313e1)\n*CVE-2018-15746\nSigned-off-by: Michael Roth\
  \ <mdroth@linux.vnet.ibm.com>\n8eba63e1d246b2a40a96519951d4079a806e1b27:seccomp: use SIGSYS\
  \ signal instead of killing the thread\n\nThe seccomp action SCMP_ACT_KILL results in immediate\
  \ termination of\nthe thread that made the bad system call. However, qemu being\nmulti-threaded,\
  \ it keeps running. There is no easy way for parent\nprocess / management layer (libvirt)\
  \ to know about that situation.\n\nInstead, the default SIGSYS handler when invoked with SCMP_ACT_TRAP\n\
  will terminate the program and core dump.\n\nThis may not be the most secure solution, but\
  \ probably better than\njust killing the offending thread. SCMP_ACT_KILL_PROCESS has been\n\
  added in Linux 4.14 to improve the situation, which I propose to use\nby default if available\
  \ in the next patch.\n\nRelated to:\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1594456\n\
  \nSigned-off-by: Marc-André Lureau <marcandre.lureau@redhat.com>\nReviewed-by: Daniel P. Berrangé\
  \ <berrange@redhat.com>\nAcked-by: Eduardo Otubo <otubo@redhat.com>\n(cherry picked from commit\
  \ 6f2231e9b0931e1998d9ed0c509adf7aedc02db2)\n*CVE-2018-15746\nSigned-off-by: Michael Roth\
  \ <mdroth@linux.vnet.ibm.com>"
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9d01327689a786beba7aabab76816f689aa2565f
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: f43a6b314aa506afd70b56767ba704ddd5cbde2e
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 8eba63e1d246b2a40a96519951d4079a806e1b27
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9ad3314fa32a555c880344b960702af85ad6a231
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
