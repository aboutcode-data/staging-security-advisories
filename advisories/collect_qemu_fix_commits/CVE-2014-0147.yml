advisory_id: CVE-2014-0147
datasource_id: collect_qemu_fix_commits/CVE-2014-0147
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  ffa3ab02174f7cb474366bc325bd35264364c9fd:qcow2: Don't rely on free_cluster_index in alloc_refcount_block() (CVE-2014-0147)

  free_cluster_index is only correct if update_refcount() was called from
  an allocation function, and even there it's brittle because it's used to
  protect unfinished allocations which still have a refcount of 0 - if it
  moves in the wrong place, the unfinished allocation can be corrupted.

  So not using it any more seems to be a good idea. Instead, use the
  first requested cluster to do the calculations. Return -EAGAIN if
  unfinished allocations could become invalid and let the caller restart
  its search for some free clusters.

  The context of creating a snapsnot is one situation where
  update_refcount() is called outside of a cluster allocation. For this
  case, the change fixes a buffer overflow if a cluster is referenced in
  an L2 table that cannot be represented by an existing refcount block.
  (new_table[refcount_table_index] was out of bounds)

  [Bump the qemu-iotests 026 refblock_alloc.write leak count from 10 to
  11.
  --Stefan]

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit b106ad9185f35fc4ad669555ad0e79e276083bd7)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  0e748624bd2261e7589b40b31413d62dc841957a:bochs: Use unsigned variables for offsets and sizes (CVE-2014-0147)

  Gets us rid of integer overflows resulting in negative sizes which
  aren't correctly checked.

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  (cherry picked from commit 246f65838d19db6db55bfb41117c35645a2c4789)
  Signed-off-by: Michael Roth <mdroth@linux.vnet.ibm.com>
  b106ad9185f35fc4ad669555ad0e79e276083bd7:qcow2: Don't rely on free_cluster_index in alloc_refcount_block() (CVE-2014-0147)

  free_cluster_index is only correct if update_refcount() was called from
  an allocation function, and even there it's brittle because it's used to
  protect unfinished allocations which still have a refcount of 0 - if it
  moves in the wrong place, the unfinished allocation can be corrupted.

  So not using it any more seems to be a good idea. Instead, use the
  first requested cluster to do the calculations. Return -EAGAIN if
  unfinished allocations could become invalid and let the caller restart
  its search for some free clusters.

  The context of creating a snapsnot is one situation where
  update_refcount() is called outside of a cluster allocation. For this
  case, the change fixes a buffer overflow if a cluster is referenced in
  an L2 table that cannot be represented by an existing refcount block.
  (new_table[refcount_table_index] was out of bounds)

  [Bump the qemu-iotests 026 refblock_alloc.write leak count from 10 to
  11.
  --Stefan]

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
  246f65838d19db6db55bfb41117c35645a2c4789:bochs: Use unsigned variables for offsets and sizes (CVE-2014-0147)

  Gets us rid of integer overflows resulting in negative sizes which
  aren't correctly checked.

  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Max Reitz <mreitz@redhat.com>
  Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b106ad9185f35fc4ad669555ad0e79e276083bd7
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 0e748624bd2261e7589b40b31413d62dc841957a
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: ffa3ab02174f7cb474366bc325bd35264364c9fd
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 246f65838d19db6db55bfb41117c35645a2c4789
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
