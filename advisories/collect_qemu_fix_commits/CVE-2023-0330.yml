advisory_id: CVE-2023-0330
datasource_id: collect_qemu_fix_commits/CVE-2023-0330
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  275436de62f0a8a346989926ed719a1600d37f4a:hw/scsi/lsi53c895a: add missing decrement of reentrancy counter

  When the maximum count of SCRIPTS instructions is reached, the code
  stops execution and returns, but fails to decrement the reentrancy
  counter. This effectively renders the SCSI controller unusable
  because on next entry the reentrancy counter is still above the limit.

  This bug was seen on HP-UX 10.20 which seems to trigger SCRIPTS
  loops.

  Fixes: b987718bbb ("hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)")
  Signed-off-by: Sven Schnelle <svens@stackframe.org>
  Message-ID: <20240128202214.2644768-1-svens@stackframe.org>
  Reviewed-by: Thomas Huth <thuth@redhat.com>
  Tested-by: Helge Deller <deller@gmx.de>
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  (cherry picked from commit 8b09b7fe47082c69295a0fc0cc01b041b6385025)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  bbfcb0f7bcc1f905eee3997e56d42bb1e97de51d:hw/scsi/lsi53c895a: add missing decrement of reentrancy counter

  When the maximum count of SCRIPTS instructions is reached, the code
  stops execution and returns, but fails to decrement the reentrancy
  counter. This effectively renders the SCSI controller unusable
  because on next entry the reentrancy counter is still above the limit.

  This bug was seen on HP-UX 10.20 which seems to trigger SCRIPTS
  loops.

  Fixes: b987718bbb ("hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)")
  Signed-off-by: Sven Schnelle <svens@stackframe.org>
  Message-ID: <20240128202214.2644768-1-svens@stackframe.org>
  Reviewed-by: Thomas Huth <thuth@redhat.com>
  Tested-by: Helge Deller <deller@gmx.de>
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  (cherry picked from commit 8b09b7fe47082c69295a0fc0cc01b041b6385025)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  8b09b7fe47082c69295a0fc0cc01b041b6385025:hw/scsi/lsi53c895a: add missing decrement of reentrancy counter

  When the maximum count of SCRIPTS instructions is reached, the code
  stops execution and returns, but fails to decrement the reentrancy
  counter. This effectively renders the SCSI controller unusable
  because on next entry the reentrancy counter is still above the limit.

  This bug was seen on HP-UX 10.20 which seems to trigger SCRIPTS
  loops.

  Fixes: b987718bbb ("hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)")
  Signed-off-by: Sven Schnelle <svens@stackframe.org>
  Message-ID: <20240128202214.2644768-1-svens@stackframe.org>
  Reviewed-by: Thomas Huth <thuth@redhat.com>
  Tested-by: Helge Deller <deller@gmx.de>
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  c40ca2301c7603524eaddb5308a3f524c6f89d24:memory: prevent dma-reentracy issues

  Add a flag to the DeviceState, when a device is engaged in PIO/MMIO/DMA.
  This flag is set/checked prior to calling a device's MemoryRegion
  handlers, and set when device code initiates DMA.  The purpose of this
  flag is to prevent two types of DMA-based reentrancy issues:

  1.) mmio -> dma -> mmio case
  2.) bh -> dma write -> mmio case

  These issues have led to problems such as stack-exhaustion and
  use-after-frees.

  Summary of the problem from Peter Maydell:
  https://lore.kernel.org/qemu-devel/CAFEAcA_23vc7hE3iaM-JVA6W38LK4hJoWae5KcknhPRD5fPBZA@mail.gmail.com

  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/62
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/540
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/541
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/556
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/557
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/827
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/1282
  Resolves: CVE-2023-0330

  Signed-off-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Thomas Huth <thuth@redhat.com>
  Message-Id: <20230427211013.2994127-2-alxndr@bu.edu>
  [thuth: Replace warn_report() with warn_report_once()]
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  (cherry picked from commit a2e1753b8054344f32cf94f31c6399a58794a380)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  a08c78dda7e018fbbe33bc7979f7a53f89a488b5:memory: prevent dma-reentracy issues

  Add a flag to the DeviceState, when a device is engaged in PIO/MMIO/DMA.
  This flag is set/checked prior to calling a device's MemoryRegion
  handlers, and set when device code initiates DMA.  The purpose of this
  flag is to prevent two types of DMA-based reentrancy issues:

  1.) mmio -> dma -> mmio case
  2.) bh -> dma write -> mmio case

  These issues have led to problems such as stack-exhaustion and
  use-after-frees.

  Summary of the problem from Peter Maydell:
  https://lore.kernel.org/qemu-devel/CAFEAcA_23vc7hE3iaM-JVA6W38LK4hJoWae5KcknhPRD5fPBZA@mail.gmail.com

  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/62
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/540
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/541
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/556
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/557
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/827
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/1282
  Resolves: CVE-2023-0330

  Signed-off-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Thomas Huth <thuth@redhat.com>
  Message-Id: <20230427211013.2994127-2-alxndr@bu.edu>
  [thuth: Replace warn_report() with warn_report_once()]
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  (cherry picked from commit a2e1753b8054344f32cf94f31c6399a58794a380)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  9fe6e8139dc268f9916b8b7ce3ed9586c5354d11:hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)

  We cannot use the generic reentrancy guard in the LSI code, so
  we have to manually prevent endless reentrancy here. The problematic
  lsi_execute_script() function has already a way to detect whether
  too many instructions have been executed - we just have to slightly
  change the logic here that it also takes into account if the function
  has been called too often in a reentrant way.

  The code in fuzz-lsi53c895a-test.c has been taken from an earlier
  patch by Mauro Matteo Cascella.

  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/1563
  Message-Id: <20230522091011.1082574-1-thuth@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Alexander Bulekov <alxndr@bu.edu>
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  (cherry picked from commit b987718bbb1d0eabf95499b976212dd5f0120d75)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  e49884a90987744ddb54b2fadc770633eb6a4d62:hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)

  We cannot use the generic reentrancy guard in the LSI code, so
  we have to manually prevent endless reentrancy here. The problematic
  lsi_execute_script() function has already a way to detect whether
  too many instructions have been executed - we just have to slightly
  change the logic here that it also takes into account if the function
  has been called too often in a reentrant way.

  The code in fuzz-lsi53c895a-test.c has been taken from an earlier
  patch by Mauro Matteo Cascella.

  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/1563
  Message-Id: <20230522091011.1082574-1-thuth@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Alexander Bulekov <alxndr@bu.edu>
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  (cherry picked from commit b987718bbb1d0eabf95499b976212dd5f0120d75)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  9cb47a10564e35df421f9639b0d2cf9e7449544d:Merge tag 'pull-request-2023-05-26' of https://gitlab.com/thuth/qemu into staging

  * Use MachineClass->default_nic in more machines to allow running them
    without "--nodefaults" in builds that used "--without-default-devices"
  * Improve qtests for such builds
  * Add up-/downsampling qtest
  * Avoid crash if default RAM backend name has been stolen
  * Fix reentrant DMA problem in the lsi53c895a device (CVE-2023-0330)

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJFBAABCAAvFiEEJ7iIR+7gJQEY8+q5LtnXdP5wLbUFAmRwdqsRHHRodXRoQHJl
  # ZGhhdC5jb20ACgkQLtnXdP5wLbXk6g//eQzVGv1Ep4ZusQXPDpFJLgBNq7JMOF6a
  # bWa6fTluzCn2ivnbgPEf0lV1TsCrUuQwqWlEozylltE6l4zbmIWBMO8F/6Wy0JZH
  # DuBrO9fio+nKhcEqeFLE+wTWUCiBqM66n8LL+rznO3RjXv2QU8zhk9owmsEKZUV0
  # vXrMO5XdUO/dTrxyBdVjbok9L1UpkF+Sp9LEHNxIJZnAqhVmx13jnKq6WTrDR/fX
  # ZwGbwWxsnTZl5PuPsHePdTWhXigzZJYcI5TSfcdTVHbzIxVKzFIvTX7stKxySL3b
  # 3rXqmkmdozi28UPq7kXvLRoN8VscORgC3J+0izVxd1P0q+sh6p+hF/8T1r0UCqWa
  # cgPoqGP5fcqfQiQxdaPbm3Ar9qscZPqzpZWxzjFQsptxf69RIEg+8XZq/EP+6g+c
  # GxCh1cqugLdWvZPpBjoGIDlftxJZ99rMKnOZJEudaAIDzRWbNBuqzVo5osj8n5ht
  # m68Nanlil451+ySuTS7iiWyyKXF6hIfe5I6A72QdxMPeHsavcCk5D5AN76dFSTmN
  # XWWqlk9CNYbvaYSIqyxJpANiwA5Y0j7r6GVXdWFZ9YRt//+z2rMwOrZIqYyvoscE
  # 5p+ul/qgUq10XkNwI9t1pd9DX8g+5yuIY0chfC9G1B0AuiPHzvmszORBYY+8+7GT
  # 2Rwq/HqraC4=
  # =eab7
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Fri 26 May 2023 02:06:51 AM PDT
  # gpg:                using RSA key 27B88847EEE0250118F3EAB92ED9D774FE702DB5
  # gpg:                issuer "thuth@redhat.com"
  # gpg: Good signature from "Thomas Huth <th.huth@gmx.de>" [undefined]
  # gpg:                 aka "Thomas Huth <thuth@redhat.com>" [undefined]
  # gpg:                 aka "Thomas Huth <th.huth@posteo.de>" [unknown]
  # gpg:                 aka "Thomas Huth <huth@tuxfamily.org>" [undefined]
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: 27B8 8847 EEE0 2501 18F3  EAB9 2ED9 D774 FE70 2DB5

  * tag 'pull-request-2023-05-26' of https://gitlab.com/thuth/qemu:
    hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)
    lsi53c895a: disable reentrancy detection for MMIO region, too
    machine: do not crash if default RAM backend name has been stolen
    tests/qtest/ac97-test: add up-/downsampling tests
    tests/qtest/usb-hcd-ehci-test: Check for EHCI and UHCI HCDs before using them
    tests/qtest/rtl8139-test: Check whether the rtl8139 device is available
    tests/qtest: Check for virtio-blk before using -cdrom with the arm virt machine
    tests/qtest/usb-hcd-uhci-test: Check whether "usb-storage" is available
    hw/mips: Use MachineClass->default_nic in the virt machine
    hw/arm: Use MachineClass->default_nic in the sbsa-ref machine
    hw/xtensa: Use MachineClass->default_nic in the virt machine
    hw/loongarch64: Use MachineClass->default_nic in the virt machine
    hw/arm: Use MachineClass->default_nic in the virt machine
    hw/alpha: Use MachineClass->default_nic in the alpha machine
    hw/hppa: Use MachineClass->default_nic in the hppa machine

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  9cb47a10564e35df421f9639b0d2cf9e7449544d:Merge tag 'pull-request-2023-05-26' of https://gitlab.com/thuth/qemu into staging

  * Use MachineClass->default_nic in more machines to allow running them
    without "--nodefaults" in builds that used "--without-default-devices"
  * Improve qtests for such builds
  * Add up-/downsampling qtest
  * Avoid crash if default RAM backend name has been stolen
  * Fix reentrant DMA problem in the lsi53c895a device (CVE-2023-0330)

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJFBAABCAAvFiEEJ7iIR+7gJQEY8+q5LtnXdP5wLbUFAmRwdqsRHHRodXRoQHJl
  # ZGhhdC5jb20ACgkQLtnXdP5wLbXk6g//eQzVGv1Ep4ZusQXPDpFJLgBNq7JMOF6a
  # bWa6fTluzCn2ivnbgPEf0lV1TsCrUuQwqWlEozylltE6l4zbmIWBMO8F/6Wy0JZH
  # DuBrO9fio+nKhcEqeFLE+wTWUCiBqM66n8LL+rznO3RjXv2QU8zhk9owmsEKZUV0
  # vXrMO5XdUO/dTrxyBdVjbok9L1UpkF+Sp9LEHNxIJZnAqhVmx13jnKq6WTrDR/fX
  # ZwGbwWxsnTZl5PuPsHePdTWhXigzZJYcI5TSfcdTVHbzIxVKzFIvTX7stKxySL3b
  # 3rXqmkmdozi28UPq7kXvLRoN8VscORgC3J+0izVxd1P0q+sh6p+hF/8T1r0UCqWa
  # cgPoqGP5fcqfQiQxdaPbm3Ar9qscZPqzpZWxzjFQsptxf69RIEg+8XZq/EP+6g+c
  # GxCh1cqugLdWvZPpBjoGIDlftxJZ99rMKnOZJEudaAIDzRWbNBuqzVo5osj8n5ht
  # m68Nanlil451+ySuTS7iiWyyKXF6hIfe5I6A72QdxMPeHsavcCk5D5AN76dFSTmN
  # XWWqlk9CNYbvaYSIqyxJpANiwA5Y0j7r6GVXdWFZ9YRt//+z2rMwOrZIqYyvoscE
  # 5p+ul/qgUq10XkNwI9t1pd9DX8g+5yuIY0chfC9G1B0AuiPHzvmszORBYY+8+7GT
  # 2Rwq/HqraC4=
  # =eab7
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Fri 26 May 2023 02:06:51 AM PDT
  # gpg:                using RSA key 27B88847EEE0250118F3EAB92ED9D774FE702DB5
  # gpg:                issuer "thuth@redhat.com"
  # gpg: Good signature from "Thomas Huth <th.huth@gmx.de>" [undefined]
  # gpg:                 aka "Thomas Huth <thuth@redhat.com>" [undefined]
  # gpg:                 aka "Thomas Huth <th.huth@posteo.de>" [unknown]
  # gpg:                 aka "Thomas Huth <huth@tuxfamily.org>" [undefined]
  # gpg: WARNING: This key is not certified with a trusted signature!
  # gpg:          There is no indication that the signature belongs to the owner.
  # Primary key fingerprint: 27B8 8847 EEE0 2501 18F3  EAB9 2ED9 D774 FE70 2DB5

  * tag 'pull-request-2023-05-26' of https://gitlab.com/thuth/qemu:
    hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)
    lsi53c895a: disable reentrancy detection for MMIO region, too
    machine: do not crash if default RAM backend name has been stolen
    tests/qtest/ac97-test: add up-/downsampling tests
    tests/qtest/usb-hcd-ehci-test: Check for EHCI and UHCI HCDs before using them
    tests/qtest/rtl8139-test: Check whether the rtl8139 device is available
    tests/qtest: Check for virtio-blk before using -cdrom with the arm virt machine
    tests/qtest/usb-hcd-uhci-test: Check whether "usb-storage" is available
    hw/mips: Use MachineClass->default_nic in the virt machine
    hw/arm: Use MachineClass->default_nic in the sbsa-ref machine
    hw/xtensa: Use MachineClass->default_nic in the virt machine
    hw/loongarch64: Use MachineClass->default_nic in the virt machine
    hw/arm: Use MachineClass->default_nic in the virt machine
    hw/alpha: Use MachineClass->default_nic in the alpha machine
    hw/hppa: Use MachineClass->default_nic in the hppa machine

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  b987718bbb1d0eabf95499b976212dd5f0120d75:hw/scsi/lsi53c895a: Fix reentrancy issues in the LSI controller (CVE-2023-0330)

  We cannot use the generic reentrancy guard in the LSI code, so
  we have to manually prevent endless reentrancy here. The problematic
  lsi_execute_script() function has already a way to detect whether
  too many instructions have been executed - we just have to slightly
  change the logic here that it also takes into account if the function
  has been called too often in a reentrant way.

  The code in fuzz-lsi53c895a-test.c has been taken from an earlier
  patch by Mauro Matteo Cascella.

  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/1563
  Message-Id: <20230522091011.1082574-1-thuth@redhat.com>
  Reviewed-by: Stefan Hajnoczi <stefanha@redhat.com>
  Reviewed-by: Alexander Bulekov <alxndr@bu.edu>
  Signed-off-by: Thomas Huth <thuth@redhat.com>
  a2e1753b8054344f32cf94f31c6399a58794a380:memory: prevent dma-reentracy issues

  Add a flag to the DeviceState, when a device is engaged in PIO/MMIO/DMA.
  This flag is set/checked prior to calling a device's MemoryRegion
  handlers, and set when device code initiates DMA.  The purpose of this
  flag is to prevent two types of DMA-based reentrancy issues:

  1.) mmio -> dma -> mmio case
  2.) bh -> dma write -> mmio case

  These issues have led to problems such as stack-exhaustion and
  use-after-frees.

  Summary of the problem from Peter Maydell:
  https://lore.kernel.org/qemu-devel/CAFEAcA_23vc7hE3iaM-JVA6W38LK4hJoWae5KcknhPRD5fPBZA@mail.gmail.com

  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/62
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/540
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/541
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/556
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/557
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/827
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/1282
  Resolves: CVE-2023-0330

  Signed-off-by: Alexander Bulekov <alxndr@bu.edu>
  Reviewed-by: Thomas Huth <thuth@redhat.com>
  Message-Id: <20230427211013.2994127-2-alxndr@bu.edu>
  [thuth: Replace warn_report() with warn_report_once()]
  Signed-off-by: Thomas Huth <thuth@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b987718bbb1d0eabf95499b976212dd5f0120d75
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 275436de62f0a8a346989926ed719a1600d37f4a
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 8b09b7fe47082c69295a0fc0cc01b041b6385025
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: c40ca2301c7603524eaddb5308a3f524c6f89d24
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: bbfcb0f7bcc1f905eee3997e56d42bb1e97de51d
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9fe6e8139dc268f9916b8b7ce3ed9586c5354d11
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 9cb47a10564e35df421f9639b0d2cf9e7449544d
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: a08c78dda7e018fbbe33bc7979f7a53f89a488b5
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: a2e1753b8054344f32cf94f31c6399a58794a380
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e49884a90987744ddb54b2fadc770633eb6a4d62
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
