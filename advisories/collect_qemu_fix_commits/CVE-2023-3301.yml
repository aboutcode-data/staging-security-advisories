advisory_id: CVE-2023-3301
datasource_id: collect_qemu_fix_commits/CVE-2023-3301
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  aab37b2002811f112d5c26337473486d7d585881:vhost-vdpa: do not cleanup the vdpa/vhost-net structures if peer nic is present

  When a peer nic is still attached to the vdpa backend, it is too early to free
  up the vhost-net and vdpa structures. If these structures are freed here, then
  QEMU crashes when the guest is being shut down. The following call chain
  would result in an assertion failure since the pointer returned from
  vhost_vdpa_get_vhost_net() would be NULL:

  do_vm_stop() -> vm_state_notify() -> virtio_set_status() ->
  virtio_net_vhost_status() -> get_vhost_net().

  Therefore, we defer freeing up the structures until at guest shutdown
  time when qemu_cleanup() calls net_cleanup() which then calls
  qemu_del_net_client() which would eventually call vhost_vdpa_cleanup()
  again to free up the structures. This time, the loop in net_cleanup()
  ensures that vhost_vdpa_cleanup() will be called one last time when
  all the peer nics are detached and freed.

  All unit tests pass with this change.

  CC: imammedo@redhat.com
  CC: jusual@redhat.com
  CC: mst@redhat.com
  Fixes: CVE-2023-3301
  Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=2128929
  Signed-off-by: Ani Sinha <anisinha@redhat.com>
  Message-Id: <20230619065209.442185-1-anisinha@redhat.com>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  (cherry picked from commit a0d7215e339b61c7d7a7b3fcf754954d80d93eb8)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  (Mjt: context change for stable-8.0)
  3d12598b74ed4bcc6db8b50818a95c4b770d4487:vhost-vdpa: do not cleanup the vdpa/vhost-net structures if peer nic is present

  When a peer nic is still attached to the vdpa backend, it is too early to free
  up the vhost-net and vdpa structures. If these structures are freed here, then
  QEMU crashes when the guest is being shut down. The following call chain
  would result in an assertion failure since the pointer returned from
  vhost_vdpa_get_vhost_net() would be NULL:

  do_vm_stop() -> vm_state_notify() -> virtio_set_status() ->
  virtio_net_vhost_status() -> get_vhost_net().

  Therefore, we defer freeing up the structures until at guest shutdown
  time when qemu_cleanup() calls net_cleanup() which then calls
  qemu_del_net_client() which would eventually call vhost_vdpa_cleanup()
  again to free up the structures. This time, the loop in net_cleanup()
  ensures that vhost_vdpa_cleanup() will be called one last time when
  all the peer nics are detached and freed.

  All unit tests pass with this change.

  CC: imammedo@redhat.com
  CC: jusual@redhat.com
  CC: mst@redhat.com
  Fixes: CVE-2023-3301
  Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=2128929
  Signed-off-by: Ani Sinha <anisinha@redhat.com>
  Message-Id: <20230619065209.442185-1-anisinha@redhat.com>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  (cherry picked from commit a0d7215e339b61c7d7a7b3fcf754954d80d93eb8)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  (Mjt: context change for stable-7.2)
  a0d7215e339b61c7d7a7b3fcf754954d80d93eb8:vhost-vdpa: do not cleanup the vdpa/vhost-net structures if peer nic is present

  When a peer nic is still attached to the vdpa backend, it is too early to free
  up the vhost-net and vdpa structures. If these structures are freed here, then
  QEMU crashes when the guest is being shut down. The following call chain
  would result in an assertion failure since the pointer returned from
  vhost_vdpa_get_vhost_net() would be NULL:

  do_vm_stop() -> vm_state_notify() -> virtio_set_status() ->
  virtio_net_vhost_status() -> get_vhost_net().

  Therefore, we defer freeing up the structures until at guest shutdown
  time when qemu_cleanup() calls net_cleanup() which then calls
  qemu_del_net_client() which would eventually call vhost_vdpa_cleanup()
  again to free up the structures. This time, the loop in net_cleanup()
  ensures that vhost_vdpa_cleanup() will be called one last time when
  all the peer nics are detached and freed.

  All unit tests pass with this change.

  CC: imammedo@redhat.com
  CC: jusual@redhat.com
  CC: mst@redhat.com
  Fixes: CVE-2023-3301
  Resolves: https://bugzilla.redhat.com/show_bug.cgi?id=2128929
  Signed-off-by: Ani Sinha <anisinha@redhat.com>
  Message-Id: <20230619065209.442185-1-anisinha@redhat.com>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: a0d7215e339b61c7d7a7b3fcf754954d80d93eb8
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: aab37b2002811f112d5c26337473486d7d585881
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 3d12598b74ed4bcc6db8b50818a95c4b770d4487
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
