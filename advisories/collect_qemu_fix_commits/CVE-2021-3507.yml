advisory_id: CVE-2021-3507
datasource_id: collect_qemu_fix_commits/CVE-2021-3507
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  b32b3897f8b8f2f17425c22ea229ea6ebcb7d552:Merge tag 'for-upstream' of git://repo.or.cz/qemu/kevin into staging

  Block layer patches

  - coroutine: Fix crashes due to too large pool batch size
  - fdc: Prevent end-of-track overrun
  - nbd: MULTI_CONN for shared writable exports
  - iotests test runner improvements

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJFBAABCAAvFiEE3D3rFZqa+V09dFb+fwmycsiPL9YFAmJ9KCkRHGt3b2xmQHJl
  # ZGhhdC5jb20ACgkQfwmycsiPL9ZtSRAAmYDFBPqxfutpFXM7kIKwL6COXJC12MOx
  # Tmu8cDiGB/jNChdi3kl6I5h5njzo3U0ZlL/Ign6EzHoeoXLAPSeUWmuRsARwsZ+A
  # rL61gf6yrMjAo45FZuIS0GlMDk8BauRwPl9qPWeqQcrtOMYpxwZfyFGmcMpQgAOI
  # MSC1I8p3FA7oJhGpKIHDPOjaZA97Lm2rLnDIwZ4f0YgssbybFBcFCXOQbhpsVhLy
  # Tjp/L+qRUtna9xBsPHQvHZW0kITQbCQPdX+oVqqUmwzSvuHqfXKe1YppyPjBt/S0
  # H7nxtx4HOgP0lP5Kea+wbIRAk9Da5uaOW8hlMWRLShEKv1iTUenQSKteBB6CD03t
  # GD9ze1kGoR9b6szw795BXxZxcWii0cn359lIVHeKR/U8zDuz5w3zhyl0klK8xeJy
  # nj+JErLwQ7BD8kNR+7WAfXTF3tk2dQao1AvsBjn087KjMiJ/Mg8HY4K2zrjBUrHL
  # DLTyAIjzct3BWJDZ02fb5jb8pHmIP3JO6m9Zvjm7ibP65BqJOwIXUTFpbgnrOg45
  # oFLDV4JgC4Hh4GEtdm+UhQE51A0VVW5pDaqWTdWkCcuk3QgxUdM3Wm3SW6pw1Gvb
  # T0X0j5RgF/k3YrW576R/VIy6z4YPbzAtiG4O/zSlsujHoDcVNWnxApgSB/unaDh8
  # LNkFPGEMeSs=
  # =JmTm
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Thu 12 May 2022 08:30:49 AM PDT
  # gpg:                using RSA key DC3DEB159A9AF95D3D7456FE7F09B272C88F2FD6
  # gpg:                issuer "kwolf@redhat.com"
  # gpg: Good signature from "Kevin Wolf <kwolf@redhat.com>" [full]

  * tag 'for-upstream' of git://repo.or.cz/qemu/kevin:
    qemu-iotests: inline common.config into common.rc
    nbd/server: Allow MULTI_CONN for shared writable exports
    qemu-nbd: Pass max connections to blockdev layer
    tests/qtest/fdc-test: Add a regression test for CVE-2021-3507
    hw/block/fdc: Prevent end-of-track overrun (CVE-2021-3507)
    .gitlab-ci.d: export meson testlog.txt as an artifact
    tests/qemu-iotests: print intent to run a test in TAP mode
    iotests/testrunner: Flush after run_test()
    coroutine: Revert to constant batch size
    coroutine: Rename qemu_coroutine_inc/dec_pool_size()

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  b32b3897f8b8f2f17425c22ea229ea6ebcb7d552:Merge tag 'for-upstream' of git://repo.or.cz/qemu/kevin into staging

  Block layer patches

  - coroutine: Fix crashes due to too large pool batch size
  - fdc: Prevent end-of-track overrun
  - nbd: MULTI_CONN for shared writable exports
  - iotests test runner improvements

  # -----BEGIN PGP SIGNATURE-----
  #
  # iQJFBAABCAAvFiEE3D3rFZqa+V09dFb+fwmycsiPL9YFAmJ9KCkRHGt3b2xmQHJl
  # ZGhhdC5jb20ACgkQfwmycsiPL9ZtSRAAmYDFBPqxfutpFXM7kIKwL6COXJC12MOx
  # Tmu8cDiGB/jNChdi3kl6I5h5njzo3U0ZlL/Ign6EzHoeoXLAPSeUWmuRsARwsZ+A
  # rL61gf6yrMjAo45FZuIS0GlMDk8BauRwPl9qPWeqQcrtOMYpxwZfyFGmcMpQgAOI
  # MSC1I8p3FA7oJhGpKIHDPOjaZA97Lm2rLnDIwZ4f0YgssbybFBcFCXOQbhpsVhLy
  # Tjp/L+qRUtna9xBsPHQvHZW0kITQbCQPdX+oVqqUmwzSvuHqfXKe1YppyPjBt/S0
  # H7nxtx4HOgP0lP5Kea+wbIRAk9Da5uaOW8hlMWRLShEKv1iTUenQSKteBB6CD03t
  # GD9ze1kGoR9b6szw795BXxZxcWii0cn359lIVHeKR/U8zDuz5w3zhyl0klK8xeJy
  # nj+JErLwQ7BD8kNR+7WAfXTF3tk2dQao1AvsBjn087KjMiJ/Mg8HY4K2zrjBUrHL
  # DLTyAIjzct3BWJDZ02fb5jb8pHmIP3JO6m9Zvjm7ibP65BqJOwIXUTFpbgnrOg45
  # oFLDV4JgC4Hh4GEtdm+UhQE51A0VVW5pDaqWTdWkCcuk3QgxUdM3Wm3SW6pw1Gvb
  # T0X0j5RgF/k3YrW576R/VIy6z4YPbzAtiG4O/zSlsujHoDcVNWnxApgSB/unaDh8
  # LNkFPGEMeSs=
  # =JmTm
  # -----END PGP SIGNATURE-----
  # gpg: Signature made Thu 12 May 2022 08:30:49 AM PDT
  # gpg:                using RSA key DC3DEB159A9AF95D3D7456FE7F09B272C88F2FD6
  # gpg:                issuer "kwolf@redhat.com"
  # gpg: Good signature from "Kevin Wolf <kwolf@redhat.com>" [full]

  * tag 'for-upstream' of git://repo.or.cz/qemu/kevin:
    qemu-iotests: inline common.config into common.rc
    nbd/server: Allow MULTI_CONN for shared writable exports
    qemu-nbd: Pass max connections to blockdev layer
    tests/qtest/fdc-test: Add a regression test for CVE-2021-3507
    hw/block/fdc: Prevent end-of-track overrun (CVE-2021-3507)
    .gitlab-ci.d: export meson testlog.txt as an artifact
    tests/qemu-iotests: print intent to run a test in TAP mode
    iotests/testrunner: Flush after run_test()
    coroutine: Revert to constant batch size
    coroutine: Rename qemu_coroutine_inc/dec_pool_size()

  Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
  46609b90d9e3a6304def11038a76b58ff43f77bc:tests/qtest/fdc-test: Add a regression test for CVE-2021-3507

  Add the reproducer from https://gitlab.com/qemu-project/qemu/-/issues/339

  Without the previous commit, when running 'make check-qtest-i386'
  with QEMU configured with '--enable-sanitizers' we get:

    ==4028352==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x619000062a00 at pc 0x5626d03c491a bp 0x7ffdb4199410 sp 0x7ffdb4198bc0
    READ of size 786432 at 0x619000062a00 thread T0
        #0 0x5626d03c4919 in __asan_memcpy (qemu-system-i386+0x1e65919)
        #1 0x5626d1c023cc in flatview_write_continue softmmu/physmem.c:2787:13
        #2 0x5626d1bf0c0f in flatview_write softmmu/physmem.c:2822:14
        #3 0x5626d1bf0798 in address_space_write softmmu/physmem.c:2914:18
        #4 0x5626d1bf0f37 in address_space_rw softmmu/physmem.c:2924:16
        #5 0x5626d1bf14c8 in cpu_physical_memory_rw softmmu/physmem.c:2933:5
        #6 0x5626d0bd5649 in cpu_physical_memory_write include/exec/cpu-common.h:82:5
        #7 0x5626d0bd0a07 in i8257_dma_write_memory hw/dma/i8257.c:452:9
        #8 0x5626d09f825d in fdctrl_transfer_handler hw/block/fdc.c:1616:13
        #9 0x5626d0a048b4 in fdctrl_start_transfer hw/block/fdc.c:1539:13
        #10 0x5626d09f4c3e in fdctrl_write_data hw/block/fdc.c:2266:13
        #11 0x5626d09f22f7 in fdctrl_write hw/block/fdc.c:829:9
        #12 0x5626d1c20bc5 in portio_write softmmu/ioport.c:207:17

    0x619000062a00 is located 0 bytes to the right of 512-byte region [0x619000062800,0x619000062a00)
    allocated by thread T0 here:
        #0 0x5626d03c66ec in posix_memalign (qemu-system-i386+0x1e676ec)
        #1 0x5626d2b988d4 in qemu_try_memalign util/oslib-posix.c:210:11
        #2 0x5626d2b98b0c in qemu_memalign util/oslib-posix.c:226:27
        #3 0x5626d09fbaf0 in fdctrl_realize_common hw/block/fdc.c:2341:20
        #4 0x5626d0a150ed in isabus_fdc_realize hw/block/fdc-isa.c:113:5
        #5 0x5626d2367935 in device_set_realized hw/core/qdev.c:531:13

    SUMMARY: AddressSanitizer: heap-buffer-overflow (qemu-system-i386+0x1e65919) in __asan_memcpy
    Shadow bytes around the buggy address:
      0x0c32800044f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
      0x0c3280004500: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
      0x0c3280004510: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
      0x0c3280004520: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
      0x0c3280004530: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
    =>0x0c3280004540:[fa]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
      0x0c3280004550: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
      0x0c3280004560: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
      0x0c3280004570: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
      0x0c3280004580: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
      0x0c3280004590: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
    Shadow byte legend (one shadow byte represents 8 application bytes):
      Addressable:           00
      Heap left redzone:       fa
      Freed heap region:       fd
    ==4028352==ABORTING

  [ kwolf: Added snapshot=on to prevent write file lock failure ]

  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Reviewed-by: Alexander Bulekov <alxndr@bu.edu>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
  defac5e2fbddf8423a354ff0454283a2115e1367:hw/block/fdc: Prevent end-of-track overrun (CVE-2021-3507)

  Per the 82078 datasheet, if the end-of-track (EOT byte in
  the FIFO) is more than the number of sectors per side, the
  command is terminated unsuccessfully:

  * 5.2.5 DATA TRANSFER TERMINATION

    The 82078 supports terminal count explicitly through
    the TC pin and implicitly through the underrun/over-
    run and end-of-track (EOT) functions. For full sector
    transfers, the EOT parameter can define the last
    sector to be transferred in a single or multisector
    transfer. If the last sector to be transferred is a par-
    tial sector, the host can stop transferring the data in
    mid-sector, and the 82078 will continue to complete
    the sector as if a hardware TC was received. The
    only difference between these implicit functions and
    TC is that they return "abnormal termination" result
    status. Such status indications can be ignored if they
    were expected.

  * 6.1.3 READ TRACK

    This command terminates when the EOT specified
    number of sectors have been read. If the 82078
    does not find an I D Address Mark on the diskette
    after the second· occurrence of a pulse on the
    INDX# pin, then it sets the IC code in Status Regis-
    ter 0 to "01" (Abnormal termination), sets the MA bit
    in Status Register 1 to "1", and terminates the com-
    mand.

  * 6.1.6 VERIFY

    Refer to Table 6-6 and Table 6-7 for information
    concerning the values of MT and EC versus SC and
    EOT value.

  * Table 6·6. Result Phase Table

  * Table 6-7. Verify Command Result Phase Table

  Fix by aborting the transfer when EOT > # Sectors Per Side.

  Cc: qemu-stable@nongnu.org
  Cc: Hervé Poussineau <hpoussin@reactos.org>
  Fixes: baca51faff0 ("floppy driver: disk geometry auto detect")
  Reported-by: Alexander Bulekov <alxndr@bu.edu>
  Resolves: https://gitlab.com/qemu-project/qemu/-/issues/339
  Signed-off-by: Philippe Mathieu-Daudé <philmd@redhat.com>
  Message-Id: <20211118115733.4038610-2-philmd@redhat.com>
  Reviewed-by: Hanna Reitz <hreitz@redhat.com>
  Signed-off-by: Kevin Wolf <kwolf@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 46609b90d9e3a6304def11038a76b58ff43f77bc
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: b32b3897f8b8f2f17425c22ea229ea6ebcb7d552
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: defac5e2fbddf8423a354ff0454283a2115e1367
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
