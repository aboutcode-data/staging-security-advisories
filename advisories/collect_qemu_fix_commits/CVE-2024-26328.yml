advisory_id: CVE-2024-26328
datasource_id: collect_qemu_fix_commits/CVE-2024-26328
datasource_url: https://gitlab.com/qemu-project/qemu
aliases: []
summary: |
  3f7892be2404335b1ff94902727612e4df47ae58:hw/nvme: Use pcie_sriov_num_vfs()

  nvme_sriov_pre_write_ctrl() used to directly inspect SR-IOV
  configurations to know the number of VFs being disabled due to SR-IOV
  configuration writes, but the logic was flawed and resulted in
  out-of-bound memory access.

  It assumed PCI_SRIOV_NUM_VF always has the number of currently enabled
  VFs, but it actually doesn't in the following cases:
  - PCI_SRIOV_NUM_VF has been set but PCI_SRIOV_CTRL_VFE has never been.
  - PCI_SRIOV_NUM_VF was written after PCI_SRIOV_CTRL_VFE was set.
  - VFs were only partially enabled because of realization failure.

  It is a responsibility of pcie_sriov to interpret SR-IOV configurations
  and pcie_sriov does it correctly, so use pcie_sriov_num_vfs(), which it
  provides, to get the number of enabled VFs before and after SR-IOV
  configuration writes.

  Cc: qemu-stable@nongnu.org
  Fixes: CVE-2024-26328
  Fixes: 11871f53ef8e ("hw/nvme: Add support for the Virtualization Management command")
  Suggested-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Akihiko Odaki <akihiko.odaki@daynix.com>
  Message-Id: <20240228-reuse-v8-1-282660281e60@daynix.com>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  (cherry picked from commit 91bb64a8d2014fda33a81fcf0fce37340f0d3b0c)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  e00b062da7bbf642378e3379387801effe17349f:pcie: Introduce pcie_sriov_num_vfs

  igb can use this function to change its behavior depending on the
  number of virtual functions currently enabled.

  Signed-off-by: Gal Hammer <gal.hammer@sap.com>
  Signed-off-by: Marcel Apfelbaum <marcel.apfelbaum@gmail.com>
  Signed-off-by: Akihiko Odaki <akihiko.odaki@daynix.com>
  Reviewed-by: Philippe Mathieu-Daud√© <philmd@linaro.org>
  Signed-off-by: Jason Wang <jasowang@redhat.com>
  (cherry picked from commit 31180dbdca2859ae9841939f85158908453ea01d)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  (Mjt: needed for v8.2.0-2290-g91bb64a8d2
   "hw/nvme: Use pcie_sriov_num_vfs()" (CVE-2024-26328))
  98f3488c1b6090024299f8d6362aa6aac03fe26d:hw/nvme: Use pcie_sriov_num_vfs()

  nvme_sriov_pre_write_ctrl() used to directly inspect SR-IOV
  configurations to know the number of VFs being disabled due to SR-IOV
  configuration writes, but the logic was flawed and resulted in
  out-of-bound memory access.

  It assumed PCI_SRIOV_NUM_VF always has the number of currently enabled
  VFs, but it actually doesn't in the following cases:
  - PCI_SRIOV_NUM_VF has been set but PCI_SRIOV_CTRL_VFE has never been.
  - PCI_SRIOV_NUM_VF was written after PCI_SRIOV_CTRL_VFE was set.
  - VFs were only partially enabled because of realization failure.

  It is a responsibility of pcie_sriov to interpret SR-IOV configurations
  and pcie_sriov does it correctly, so use pcie_sriov_num_vfs(), which it
  provides, to get the number of enabled VFs before and after SR-IOV
  configuration writes.

  Cc: qemu-stable@nongnu.org
  Fixes: CVE-2024-26328
  Fixes: 11871f53ef8e ("hw/nvme: Add support for the Virtualization Management command")
  Suggested-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Akihiko Odaki <akihiko.odaki@daynix.com>
  Message-Id: <20240228-reuse-v8-1-282660281e60@daynix.com>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
  (cherry picked from commit 91bb64a8d2014fda33a81fcf0fce37340f0d3b0c)
  Signed-off-by: Michael Tokarev <mjt@tls.msk.ru>
  91bb64a8d2014fda33a81fcf0fce37340f0d3b0c:hw/nvme: Use pcie_sriov_num_vfs()

  nvme_sriov_pre_write_ctrl() used to directly inspect SR-IOV
  configurations to know the number of VFs being disabled due to SR-IOV
  configuration writes, but the logic was flawed and resulted in
  out-of-bound memory access.

  It assumed PCI_SRIOV_NUM_VF always has the number of currently enabled
  VFs, but it actually doesn't in the following cases:
  - PCI_SRIOV_NUM_VF has been set but PCI_SRIOV_CTRL_VFE has never been.
  - PCI_SRIOV_NUM_VF was written after PCI_SRIOV_CTRL_VFE was set.
  - VFs were only partially enabled because of realization failure.

  It is a responsibility of pcie_sriov to interpret SR-IOV configurations
  and pcie_sriov does it correctly, so use pcie_sriov_num_vfs(), which it
  provides, to get the number of enabled VFs before and after SR-IOV
  configuration writes.

  Cc: qemu-stable@nongnu.org
  Fixes: CVE-2024-26328
  Fixes: 11871f53ef8e ("hw/nvme: Add support for the Virtualization Management command")
  Suggested-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Akihiko Odaki <akihiko.odaki@daynix.com>
  Message-Id: <20240228-reuse-v8-1-282660281e60@daynix.com>
  Reviewed-by: Michael S. Tsirkin <mst@redhat.com>
  Signed-off-by: Michael S. Tsirkin <mst@redhat.com>
impacted_packages:
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: e00b062da7bbf642378e3379387801effe17349f
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 3f7892be2404335b1ff94902727612e4df47ae58
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 98f3488c1b6090024299f8d6362aa6aac03fe26d
    introduced_in_commits: []
  - purl: pkg:gitlab/qemu-project/qemu
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://gitlab.com/qemu-project/qemu
        commit: 91bb64a8d2014fda33a81fcf0fce37340f0d3b0c
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://gitlab.com/qemu-project/qemu
    reference_type: commit
    reference_id: 91c6438caffc880e999a7312825479685d659b44
