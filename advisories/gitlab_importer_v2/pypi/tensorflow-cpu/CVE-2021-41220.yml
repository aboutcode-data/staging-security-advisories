advisory_id: pypi/tensorflow-cpu/CVE-2021-41220
datasource_id: gitlab_importer_v2/pypi/tensorflow-cpu/CVE-2021-41220
datasource_url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/pypi/tensorflow-cpu/CVE-2021-41220.yml
aliases:
  - CVE-2021-41220
  - GHSA-gpfh-jvf9-7wg5
summary: |
  Use after free / memory leak in `CollectiveReduceV2`
  The [async implementation](https://github.com/tensorflow/tensorflow/blob/8d72537c6abf5a44103b57b9c2e22c14f5f49698/tensorflow/core/kernels/collective_ops.cc#L604-L615) of `CollectiveReduceV2` suffers from a memory leak and a use after free:

  ```python
  import tensorflow as tf

  tf.raw_ops.CollectiveReduceV2(
  input=[],
  group_size=[-10, -10, -10],
  group_key=[-10, -10],
  instance_key=[-10],
  ordering_token=[],
  merge_op='Mul',
  final_op='Div')
  ```

  This occurs due to the asynchronous computation and the fact that objects that have been `std::move()`d from are still accessed:

  ```cc
  auto done_with_cleanup = [col_params, done = std::move(done)]() {
  done();
  col_params->Unref();
  };
  OP_REQUIRES_OK_ASYNC(c,
  FillCollectiveParams(col_params, REDUCTION_COLLECTIVE,
  /*group_size*/ c->input(1),
  /*group_key*/ c->input(2),
  /*instance_key*/ c->input(3)),
  done);
  ```

  Here, `done` is already moved from by the time `OP_REQUIRES_OK_ASYNC` macro needs to invoke it in case of errors. In this case, we get an undefined behavior, which can manifest via crashes, `std::bad_alloc` throws or just memory leaks.
impacted_packages:
  - purl: pkg:pypi/tensorflow-cpu
    affected_versions: vers:pypi/2.6.0|>=2.6.0|<2.6.1
    fixed_versions: vers:pypi/2.6.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score:
    scoring_system: cvssv2
    scoring_elements: AV:L/AC:L/Au:N/C:P/I:P/A:P
    published_at: None
    url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/pypi/tensorflow-cpu/CVE-2021-41220.yml
  - score:
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    published_at: None
    url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/pypi/tensorflow-cpu/CVE-2021-41220.yml
weaknesses:
  - CWE-416
  - CWE-1035
  - CWE-937
references:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow-cpu/PYSEC-2021-629.yaml
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow-gpu/PYSEC-2021-827.yaml
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow/PYSEC-2021-412.yaml
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/commit/ca38dab9d3ee66c5de06f11af9a4b1200da5ef75
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/security/advisories/GHSA-gpfh-jvf9-7wg5
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2021-41220
    reference_type:
    reference_id: CVE-2021-41220
  - url: https://github.com/advisories/GHSA-gpfh-jvf9-7wg5
    reference_type:
    reference_id: GHSA-gpfh-jvf9-7wg5
