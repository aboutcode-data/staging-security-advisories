advisory_id: pypi/tensorflow/CVE-2022-21731
datasource_id: gitlab_importer_v2/pypi/tensorflow/CVE-2022-21731
datasource_url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/pypi/tensorflow/CVE-2022-21731.yml
aliases:
  - CVE-2022-21731
  - GHSA-m4hf-j54p-p353
summary: |
  Type confusion leading to segfault in Tensorflow
  The [implementation of shape inference for `ConcatV2`](https://github.com/tensorflow/tensorflow/blob/5100e359aef5c8021f2e71c7b986420b85ce7b3d/tensorflow/core/framework/common_shape_fns.cc#L1961-L2059) can be used to trigger a denial of service attack via a segfault caused by a type confusion:

  ```python
  import tensorflow as tf

  @tf.function
  def test():
  y = tf.raw_ops.ConcatV2(
  values=[[1,2,3],[4,5,6]],
  axis = 0xb500005b)
  return y

  test()
  ```

  The `axis` argument is translated into `concat_dim` in the `ConcatShapeHelper` helper function. Then, a value for `min_rank` is computed based on `concat_dim`. This is then used to validate that the `values` tensor has at least the required rank:

  ```cc
  int64_t concat_dim;
  if (concat_dim_t->dtype() == DT_INT32) {
  concat_dim = static_cast<int64_t>(concat_dim_t->flat<int32>()(0));
  } else {
  concat_dim = concat_dim_t->flat<int64_t>()(0);
  }

  // Minimum required number of dimensions.
  const int min_rank = concat_dim < 0 ? -concat_dim : concat_dim + 1;

  // ...
  ShapeHandle input = c->input(end_value_index - 1);
  TF_RETURN_IF_ERROR(c->WithRankAtLeast(input, min_rank, &input));
  ```

  However, [`WithRankAtLeast`](https://github.com/tensorflow/tensorflow/blob/5100e359aef5c8021f2e71c7b986420b85ce7b3d/tensorflow/core/framework/shape_inference.cc#L345-L358) receives the lower bound as a 64-bits value and then compares it against the maximum 32-bits integer value that could be represented:

  ```cc
  Status InferenceContext::WithRankAtLeast(ShapeHandle shape, int64_t rank,
  ShapeHandle* out) {
  if (rank > kint32max) {
  return errors::InvalidArgument("Rank cannot exceed kint32max");
  }
  // ...
  }
  ```

  Due to the fact that `min_rank` is a 32-bits value and the value of `axis`, the `rank` argument is a [negative value](https://godbolt.org/z/Gcr5haMob), so the error check is bypassed.
impacted_packages:
  - purl: pkg:pypi/tensorflow
    affected_versions: vers:pypi/<2.5.3|>=2.6.0|<2.6.3|2.7.0|>=2.7.0|<2.7.1
    fixed_versions: vers:pypi/2.5.3|2.6.3|2.7.1
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score:
    scoring_system: cvssv2
    scoring_elements: AV:N/AC:L/Au:S/C:N/I:N/A:P
    published_at: None
    url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/pypi/tensorflow/CVE-2022-21731.yml
  - score:
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/pypi/tensorflow/CVE-2022-21731.yml
weaknesses:
  - CWE-937
  - CWE-1035
  - CWE-843
  - CWE-754
references:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow-cpu/PYSEC-2022-55.yaml
    reference_type:
    reference_id:
  - url: https://github.com/pypa/advisory-database/tree/main/vulns/tensorflow-gpu/PYSEC-2022-110.yaml
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/blob/5100e359aef5c8021f2e71c7b986420b85ce7b3d/tensorflow/core/framework/common_shape_fns.cc#L1961-L2059
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/blob/5100e359aef5c8021f2e71c7b986420b85ce7b3d/tensorflow/core/framework/shape_inference.cc#L345-L358
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/commit/08d7b00c0a5a20926363849f611729f53f3ec022
    reference_type:
    reference_id:
  - url: https://github.com/tensorflow/tensorflow/security/advisories/GHSA-m4hf-j54p-p353
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2022-21731
    reference_type:
    reference_id: CVE-2022-21731
  - url: https://github.com/advisories/GHSA-m4hf-j54p-p353
    reference_type:
    reference_id: GHSA-m4hf-j54p-p353
