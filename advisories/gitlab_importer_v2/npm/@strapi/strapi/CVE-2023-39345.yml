advisory_id: npm/@strapi/strapi/CVE-2023-39345
datasource_id: gitlab_importer_v2/npm/@strapi/strapi/CVE-2023-39345
datasource_url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/npm/@strapi/strapi/CVE-2023-39345.yml
aliases:
  - CVE-2023-39345
  - GHSA-gc7p-j5xm-xxh2
summary: |
  Unauthorized Access to Private Fields in User Registration API
  ### System Details
  | Name   | Value         |
  |----------|------------------------|
  | OS    | Windows 11       |
  | Version | 4.11.1 (node v16.14.2) |
  | Database | mysql         |


  ### Description
  I marked some fields as private fields in user content-type, and tried to register as a new user via api, at the same time I added content to fill the private fields and sent a post request, and as you can see from the images below, I can write to the private fields. To prevent this, I went to the extension area and tried to extend the register method, for this I wanted to do it using the sanitizeInput function that I know in the source codes of the strap. But the sanitizeInput function does not filter out private fields.

  ```js
   const { auth } = ctx.state;
   const data = ctx.request.body;
   const userSchema = strapi.getModel("plugin::users-permissions.user");

   sanitize.contentAPI.input(data, userSchema, { auth });
  ```

  here's the solution I've temporarily kept to myself, code snippet

  ```js
   const body = ctx.request.body;

   const { attributes } = strapi.getModel("plugin::users-permissions.user");

   const sanitizedData = _.omitBy(body, (data, key) => {
    const attribute = attributes[key];

    if (_.isNil(attribute)) {
     return false;
    }

    //? If you want, you can throw an error for fields that we does not expect.

    // if (_.isNil(attribute))
    //  throw new ApplicationError(`Unexpected value ${key}`);

    // if private value is true, we do not want to send it to the database.
    return attribute.private;
   });

   return sanitizedData;
  ```
impacted_packages:
  - purl: pkg:npm/%40strapi/strapi
    affected_versions: vers:npm/>=4.0.0|<4.13.1
    fixed_versions: vers:npm/4.13.1
    fixed_in_commits: []
    introduced_in_commits: []
severities: []
weaknesses:
  - CWE-1035
  - CWE-937
references:
  - url: https://github.com/strapi/strapi/security/advisories/GHSA-gc7p-j5xm-xxh2
    reference_type:
    reference_id:
  - url: https://strapi.io/blog/security-disclosure-of-vulnerabilities-sept-2023
    reference_type:
    reference_id:
  - url: https://github.com/advisories/GHSA-gc7p-j5xm-xxh2
    reference_type:
    reference_id: GHSA-gc7p-j5xm-xxh2
