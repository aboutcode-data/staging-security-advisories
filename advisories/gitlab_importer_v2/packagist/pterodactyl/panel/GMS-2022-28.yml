advisory_id: packagist/pterodactyl/panel/GMS-2022-28
datasource_id: gitlab_importer_v2/packagist/pterodactyl/panel/GMS-2022-28
datasource_url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/packagist/pterodactyl/panel/GMS-2022-28.yml
aliases:
  - GHSA-7v3x-h7r2-34jv
  - GMS-2022-28
summary: |
  Insufficient Session Expiration in Pterodactyl API
  ### Impact
  A vulnerability exists in Pterodactyl Panel `<= 1.6.6` that could allow a malicious attacker that compromises an API key to generate an authenticated user session that is not revoked when the API key is deleted, thus allowing the malicious user to remain logged in as the user the key belonged to.

  It is important to note that **a malicious user must first compromise an existing API key for a user to exploit this issue**. It cannot be exploited by chance, and requires a coordinated attack against an individual account using a known API key.

  ### Patches
  This issue has been addressed in the `v1.7.0` release of Pterodactyl Panel.

  ### Workarounds
  Those not wishing to upgrade may apply the change below:

  ```diff
  diff --git a/app/Http/Middleware/Api/AuthenticateKey.php b/app/Http/Middleware/Api/AuthenticateKey.php
  index eb25dac6..857bfab2 100644
  --- a/app/Http/Middleware/Api/AuthenticateKey.php
  +++ b/app/Http/Middleware/Api/AuthenticateKey.php
  @@ -70,7 +70,7 @@ class AuthenticateKey
           } else {
               $model = $this->authenticateApiKey($request->bearerToken(), $keyType);

  -            $this->auth->guard()->loginUsingId($model->user_id);
  +            $this->auth->guard()->onceUsingId($model->user_id);
           }
  ```

  ### For more information
  If you have any questions or comments about this advisory please reach out to `Tactical Fish#8008` on [Discord](https://discord.gg/pterodactyl) or email `dane@pterodactyl.io`.
impacted_packages:
  - purl: pkg:composer/pterodactyl/panel
    affected_versions: vers:composer/<1.7.0
    fixed_versions: vers:composer/1.7.0
    fixed_in_commits: []
    introduced_in_commits: []
severities: []
weaknesses:
  - CWE-1035
  - CWE-937
references:
  - url: https://github.com/pterodactyl/panel/commit/dfa329ddf242908b60e22e3340ea36359eab1ef4
    reference_type:
    reference_id:
  - url: https://github.com/pterodactyl/panel/releases/tag/v1.7.0
    reference_type:
    reference_id:
  - url: https://github.com/pterodactyl/panel/security/advisories/GHSA-7v3x-h7r2-34jv
    reference_type:
    reference_id:
  - url: https://github.com/advisories/GHSA-7v3x-h7r2-34jv
    reference_type:
    reference_id: GHSA-7v3x-h7r2-34jv
