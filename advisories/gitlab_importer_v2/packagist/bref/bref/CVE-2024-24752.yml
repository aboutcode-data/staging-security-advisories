advisory_id: packagist/bref/bref/CVE-2024-24752
datasource_id: gitlab_importer_v2/packagist/bref/bref/CVE-2024-24752
datasource_url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/packagist/bref/bref/CVE-2024-24752.yml
aliases:
  - CVE-2024-24752
  - GHSA-x4hh-frx8-98r5
summary: |
  Bref's Uploaded Files Not Deleted in Event-Driven Functions
  When Bref is used with the Event-Driven Function runtime and the handler is a `RequestHandlerInterface`, then the Lambda event is converted to a PSR7 object.
  During the conversion process, if the request is a MultiPart, each part is parsed and for each which contains a file, it is extracted and saved in `/tmp` with a random filename starting with `bref_upload_`.

  The function implementing the logic follows:

  ```php
  private static function parseBodyAndUploadedFiles(HttpRequestEvent $event): array
  {
  $bodyString = $event->getBody();
  $files = [];
  $parsedBody = null;
  $contentType = $event->getContentType();
  if ($contentType !== null && $event->getMethod() === 'POST') {
  if (str_starts_with($contentType, 'application/x-www-form-urlencoded')) {
  parse_str($bodyString, $parsedBody);
  } else {
  $document = new Part("Content-type: $contentType\r\n\r\n" . $bodyString);
  if ($document->isMultiPart()) {
  $parsedBody = [];
  foreach ($document->getParts() as $part) {
  if ($part->isFile()) {
  $tmpPath = tempnam(sys_get_temp_dir(), 'bref_upload_');
  if ($tmpPath === false) {
  throw new RuntimeException('Unable to create a temporary directory');
  }
  file_put_contents($tmpPath, $part->getBody());
  $file = new UploadedFile($tmpPath, filesize($tmpPath), UPLOAD_ERR_OK, $part->getFileName(), $part->getMimeType());

  self::parseKeyAndInsertValueInArray($files, $part->getName(), $file);
  } else {
  self::parseKeyAndInsertValueInArray($parsedBody, $part->getName(), $part->getBody());
  }
  }
  }
  }
  }
  return [$files, $parsedBody];
  }
  ```

  The flow mimics what plain PHP does but it does not delete the temporary files when the request has been processed.
impacted_packages:
  - purl: pkg:composer/bref/bref
    affected_versions: vers:composer/<2.1.13
    fixed_versions: vers:composer/2.1.13
    fixed_in_commits: []
    introduced_in_commits: []
severities:
  - score:
    scoring_system: cvssv3.1
    scoring_elements: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H
    published_at: None
    url: https://gitlab.com/gitlab-org/advisories-community/-/blob/main/packagist/bref/bref/CVE-2024-24752.yml
weaknesses:
  - CWE-770
  - CWE-1035
  - CWE-937
  - CWE-400
references:
  - url: https://github.com/brefphp/bref
    reference_type:
    reference_id:
  - url: https://github.com/brefphp/bref/blob/2.1.12/src/Event/Http/Psr7Bridge.php#L94-L125
    reference_type:
    reference_id:
  - url: https://github.com/brefphp/bref/commit/350788de12880b6fd64c4c318ba995388bec840e
    reference_type:
    reference_id:
  - url: https://github.com/brefphp/bref/security/advisories/GHSA-x4hh-frx8-98r5
    reference_type:
    reference_id:
  - url: https://nvd.nist.gov/vuln/detail/CVE-2024-24752
    reference_type:
    reference_id: CVE-2024-24752
  - url: https://github.com/advisories/GHSA-x4hh-frx8-98r5
    reference_type:
    reference_id: GHSA-x4hh-frx8-98r5
