advisory_id: CVE-2019-14271
datasource_id: collect_docker_moby_fix_commits/CVE-2019-14271
datasource_url: https://github.com/moby/moby
aliases: []
summary: |
  2a9eb66ddcf7c47ffbf22f52ce888dc3da9e5fac:vendor: github.com/moby/go-archive v0.2.0

  - remove aliases for deprecated types and functions
  - chrootarchive: remove redundant "init" mitigation for CVE-2019-14271
  - xattr: Fix OS matching

  full diff: https://github.com/moby/go-archive/compare/v0.1.0...v0.2.0

  Signed-off-by: Sebastiaan van Stijn <github@gone.nl>
  2b4db9383c5136bbfb2d695a90b169a27a738730:pkg/archive: nosysFileInfo: implement tar.FileInfoNames to prevent lookups

  commit e9bbc41dd146d692e28660a392b068c9c112f2ad removed our fork of
  pkg/archive that was in place to mitigate CVE-2019-14271. As part of that
  change, a nosysFileInfo type was added to prevent tar.FileInfoHeader from
  looking up user- and group-names.

  A proposal was pending in go https://go.dev/issue/50102 to define an
  interface for implementing custom lookup functions to be implemented,
  and disable go's builtin lookup. That proposal was accepted, and is now
  implemented in go1.23.

  Thia patch makes the nosysFileInfo implement the tar.FileInfoNames interface
  to prevent tar.FileInfoHeader from performing its own lookups. While the
  mitigation implemented in e9bbc41dd146d692e28660a392b068c9c112f2ad should
  already prevent this from happening, implementing the interface does not
  cost us much and is complementary to the existing mitigation.

  This patch keeps the mitigation added in a316b10dab79d9298b02c7930958ed52e0ccf4e4
  in place for any unforeseen other code.

  Signed-off-by: Sebastiaan van Stijn <github@gone.nl>
  8e4485536ba493508afd894beb9f7c2bdbf4df99:Remove local fork of archive/tar package

  A copy of Go's archive/tar packge was vendored with a patch applied to
  mitigate CVE-2019-14271. Vendoring standard library packages is not
  supported by Go in module-aware mode, which is getting in the way of
  maintenance. A different approach to mitigate the vulnerability is
  needed which does not involve vendoring parts of the standard library.

  glibc implements name service lookups such as users, groups and DNS
  using a scheme known as Name Service Switch. The services are
  implemented as modules, shared libraries which glibc dynamically links
  into the process the first time a function requiring the module is
  called. This is the crux of the vulnerability: if a process linked
  against glibc chroots, then calls one of the functions implemented with
  NSS for the first time, glibc may load NSS modules out of the chrooted
  filesystem.

  The API underlying the `docker cp` command is implemented by forking a
  new process which chroots into the container's rootfs and writes a tar
  stream of files from the container over standard output. It utilizes the
  Go standard library's archive/tar package to write the tar stream. It
  makes use of the tar.FileInfoHeader function to construct a tar.Header
  value from an fs.FileInfo value. In modern versions of Go on *nix
  platforms, FileInfoHeader will attempt to resolve the file's UID and GID
  to their respective user and group names by calling the os/user
  functions LookupId and LookupGroupId. The cgo implementation of os/user
  on *nix performs lookups by calling the corresponding libc functions. So
  when linked against glibc, calls to tar.FileInfoHeader after the
  process has chrooted into the container's rootfs can have the side
  effect of loading NSS modules from the container! Without any
  mitigations, a malicious container image author can trivially get
  arbitrary code execution by leveraging this vulnerability and escape the
  chroot (which is not a sandbox) into the host.

  Mitigate the vulnerability without patching or forking archive/tar by
  hiding the OS-dependent file info from tar.FileInfoHeader which it needs
  to perform the lookups. Without that information available it falls back
  to populating the tar.Header with only the information obtainable
  directly from the FileInfo value without making any calls into os/user.

  Fixes #42402

  Signed-off-by: Cory Snider <csnider@mirantis.com>
  (cherry picked from commit e9bbc41dd146d692e28660a392b068c9c112f2ad)
  Signed-off-by: Cory Snider <csnider@mirantis.com>
  e9bbc41dd146d692e28660a392b068c9c112f2ad:Remove local fork of archive/tar package

  A copy of Go's archive/tar packge was vendored with a patch applied to
  mitigate CVE-2019-14271. Vendoring standard library packages is not
  supported by Go in module-aware mode, which is getting in the way of
  maintenance. A different approach to mitigate the vulnerability is
  needed which does not involve vendoring parts of the standard library.

  glibc implements name service lookups such as users, groups and DNS
  using a scheme known as Name Service Switch. The services are
  implemented as modules, shared libraries which glibc dynamically links
  into the process the first time a function requiring the module is
  called. This is the crux of the vulnerability: if a process linked
  against glibc chroots, then calls one of the functions implemented with
  NSS for the first time, glibc may load NSS modules out of the chrooted
  filesystem.

  The API underlying the `docker cp` command is implemented by forking a
  new process which chroots into the container's rootfs and writes a tar
  stream of files from the container over standard output. It utilizes the
  Go standard library's archive/tar package to write the tar stream. It
  makes use of the tar.FileInfoHeader function to construct a tar.Header
  value from an fs.FileInfo value. In modern versions of Go on *nix
  platforms, FileInfoHeader will attempt to resolve the file's UID and GID
  to their respective user and group names by calling the os/user
  functions LookupId and LookupGroupId. The cgo implementation of os/user
  on *nix performs lookups by calling the corresponding libc functions. So
  when linked against glibc, calls to tar.FileInfoHeader after the
  process has chrooted into the container's rootfs can have the side
  effect of loading NSS modules from the container! Without any
  mitigations, a malicious container image author can trivially get
  arbitrary code execution by leveraging this vulnerability and escape the
  chroot (which is not a sandbox) into the host.

  Mitigate the vulnerability without patching or forking archive/tar by
  hiding the OS-dependent file info from tar.FileInfoHeader which it needs
  to perform the lookups. Without that information available it falls back
  to populating the tar.Header with only the information obtainable
  directly from the FileInfo value without making any calls into os/user.

  Fixes #42402

  Signed-off-by: Cory Snider <csnider@mirantis.com>
  11e48badcb67554b3d795241855028f28d244545:Merge pull request #39612 from tiborvass/cve-2019-14271

  Fix CVE-2019-14271 loading of nsswitch based config inside chroot under Glibc
impacted_packages:
  - purl: pkg:github/moby/moby
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/moby/moby
        commit: 11e48badcb67554b3d795241855028f28d244545
    introduced_in_commits: []
  - purl: pkg:github/moby/moby
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/moby/moby
        commit: 2b4db9383c5136bbfb2d695a90b169a27a738730
    introduced_in_commits: []
  - purl: pkg:github/moby/moby
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/moby/moby
        commit: e9bbc41dd146d692e28660a392b068c9c112f2ad
    introduced_in_commits: []
  - purl: pkg:github/moby/moby
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/moby/moby
        commit: 8e4485536ba493508afd894beb9f7c2bdbf4df99
    introduced_in_commits: []
  - purl: pkg:github/moby/moby
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/moby/moby
        commit: 2a9eb66ddcf7c47ffbf22f52ce888dc3da9e5fac
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/moby/moby/tree/11e48badcb67554b3d795241855028f28d244545
    reference_type: commit
    reference_id: 11e48badcb67554b3d795241855028f28d244545
  - url: https://github.com/moby/moby/tree/2a9eb66ddcf7c47ffbf22f52ce888dc3da9e5fac
    reference_type: commit
    reference_id: 2a9eb66ddcf7c47ffbf22f52ce888dc3da9e5fac
  - url: https://github.com/moby/moby/tree/2b4db9383c5136bbfb2d695a90b169a27a738730
    reference_type: commit
    reference_id: 2b4db9383c5136bbfb2d695a90b169a27a738730
  - url: https://github.com/moby/moby/tree/8e4485536ba493508afd894beb9f7c2bdbf4df99
    reference_type: commit
    reference_id: 8e4485536ba493508afd894beb9f7c2bdbf4df99
  - url: https://github.com/moby/moby/tree/e9bbc41dd146d692e28660a392b068c9c112f2ad
    reference_type: commit
    reference_id: e9bbc41dd146d692e28660a392b068c9c112f2ad
