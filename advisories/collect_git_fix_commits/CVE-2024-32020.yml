advisory_id: CVE-2024-32020
datasource_id: collect_git_fix_commits/CVE-2024-32020
datasource_url: https://github.com/git/git
aliases: []
summary: |
  9e65df5eab274bf74c7b570107aacd1303a1e703:Merge branch 'ownership-checks-in-local-clones'

  This topic addresses two CVEs:

  - CVE-2024-32020:

    Local clones may end up hardlinking files into the target repository's
    object database when source and target repository reside on the same
    disk. If the source repository is owned by a different user, then
    those hardlinked files may be rewritten at any point in time by the
    untrusted user.

  - CVE-2024-32021:

    When cloning a local source repository that contains symlinks via the
    filesystem, Git may create hardlinks to arbitrary user-readable files
    on the same filesystem as the target repository in the objects/
    directory.

  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
  1204e1a824c34071019fe106348eaa6d88f9528d:builtin/clone: refuse local clones of unsafe repositories

  When performing a local clone of a repository we end up either copying
  or hardlinking the source repository into the target repository. This is
  significantly more performant than if we were to use git-upload-pack(1)
  and git-fetch-pack(1) to create the new repository and preserves both
  disk space and compute time.

  Unfortunately though, performing such a local clone of a repository that
  is not owned by the current user is inherently unsafe:

    - It is possible that source files get swapped out underneath us while
      we are copying or hardlinking them. While we do perform some checks
      here to assert that we hardlinked the expected file, they cannot
      reliably thwart time-of-check-time-of-use (TOCTOU) style races. It
      is thus possible for an adversary to make us copy or hardlink
      unexpected files into the target directory.

      Ideally, we would address this by starting to use openat(3P),
      fstatat(3P) and friends. Due to platform compatibility with Windows
      we cannot easily do that though. Furthermore, the scope of these
      fixes would likely be quite broad and thus not fit for an embargoed
      security release.

    - Even if we handled TOCTOU-style races perfectly, hardlinking files
      owned by a different user into the target repository is not a good
      idea in general. It is possible for an adversary to rewrite those
      files to contain whatever data they want even after the clone has
      completed.

  Address these issues by completely refusing local clones of a repository
  that is not owned by the current user. This reuses our existing infra we
  have in place via `ensure_valid_ownership()` and thus allows a user to
  override the safety guard by adding the source repository path to the
  "safe.directory" configuration.

  This addresses CVE-2024-32020.

  Signed-off-by: Patrick Steinhardt <ps@pks.im>
  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
impacted_packages:
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 1204e1a824c34071019fe106348eaa6d88f9528d
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 9e65df5eab274bf74c7b570107aacd1303a1e703
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/git/git/tree/1204e1a824c34071019fe106348eaa6d88f9528d
    reference_type: commit
    reference_id: 1204e1a824c34071019fe106348eaa6d88f9528d
  - url: https://github.com/git/git/tree/9e65df5eab274bf74c7b570107aacd1303a1e703
    reference_type: commit
    reference_id: 9e65df5eab274bf74c7b570107aacd1303a1e703
