advisory_id: CVE-2022-24765
datasource_id: collect_git_fix_commits/CVE-2022-24765
datasource_url: https://github.com/git/git
aliases: []
summary: "d51e1dff980b9fc87002436b6ab36120a39816b1:setup: fix some formatting\n\nIn preparation\
  \ for touching code that was introduced in 3b0bf2704980\n(setup: tighten ownership checks\
  \ post CVE-2022-24765, 2022-05-10) and\nthat was formatted differently than preferred in the\
  \ Git project, fix\nthe indentation before actually modifying the code.\n\nSigned-off-by:\
  \ Johannes Schindelin <johannes.schindelin@gmx.de>\nSigned-off-by: Junio C Hamano <gitster@pobox.com>\n\
  8f8eea8c3aba154ce1f9eaab4fa06c73b60550dc:Sync with 2.35.4\n\n* maint-2.35:\n  Git 2.35.4\n\
  \  Git 2.34.4\n  Git 2.33.4\n  Git 2.32.3\n  Git 2.31.4\n  Git 2.30.5\n  setup: tighten ownership\
  \ checks post CVE-2022-24765\n  git-compat-util: allow root to access both SUDO_UID and root\
  \ owned\n  t0034: add negative tests and allow git init to mostly work under sudo\n  git-compat-util:\
  \ avoid failing dir ownership checks if running privileged\n  t: regression git needs safe.directory\
  \ when using sudo\naef3d5948c5b00a0409e117da7e720f574040505:Sync with 2.34.4\n\n* maint-2.34:\n\
  \  Git 2.34.4\n  Git 2.33.4\n  Git 2.32.3\n  Git 2.31.4\n  Git 2.30.5\n  setup: tighten ownership\
  \ checks post CVE-2022-24765\n  git-compat-util: allow root to access both SUDO_UID and root\
  \ owned\n  t0034: add negative tests and allow git init to mostly work under sudo\n  git-compat-util:\
  \ avoid failing dir ownership checks if running privileged\n  t: regression git needs safe.directory\
  \ when using sudo\n378eaded1aec073a815b8687e67a2e2eadd3228c:Sync with 2.33.4\n\n* maint-2.33:\n\
  \  Git 2.33.4\n  Git 2.32.3\n  Git 2.31.4\n  Git 2.30.5\n  setup: tighten ownership checks\
  \ post CVE-2022-24765\n  git-compat-util: allow root to access both SUDO_UID and root owned\n\
  \  t0034: add negative tests and allow git init to mostly work under sudo\n  git-compat-util:\
  \ avoid failing dir ownership checks if running privileged\n  t: regression git needs safe.directory\
  \ when using sudo\neebfde3f213e2990727a64da0d7d04ad961a28b0:Sync with 2.32.3\n\n* maint-2.32:\n\
  \  Git 2.32.3\n  Git 2.31.4\n  Git 2.30.5\n  setup: tighten ownership checks post CVE-2022-24765\n\
  \  git-compat-util: allow root to access both SUDO_UID and root owned\n  t0034: add negative\
  \ tests and allow git init to mostly work under sudo\n  git-compat-util: avoid failing dir\
  \ ownership checks if running privileged\n  t: regression git needs safe.directory when using\
  \ sudo\nfc0c773028685cdbae35c6c71f3fd3b87ab70985:Sync with 2.31.4\n\n* maint-2.31:\n  Git\
  \ 2.31.4\n  Git 2.30.5\n  setup: tighten ownership checks post CVE-2022-24765\n  git-compat-util:\
  \ allow root to access both SUDO_UID and root owned\n  t0034: add negative tests and allow\
  \ git init to mostly work under sudo\n  git-compat-util: avoid failing dir ownership checks\
  \ if running privileged\n  t: regression git needs safe.directory when using sudo\n2f8809f9a1838eb607f14097dcd63071f2eb00fe:Sync\
  \ with 2.30.5\n\n* maint-2.30:\n  Git 2.30.5\n  setup: tighten ownership checks post CVE-2022-24765\n\
  \  git-compat-util: allow root to access both SUDO_UID and root owned\n  t0034: add negative\
  \ tests and allow git init to mostly work under sudo\n  git-compat-util: avoid failing dir\
  \ ownership checks if running privileged\n  t: regression git needs safe.directory when using\
  \ sudo\n3b0bf2704980b1ed6018622bdf5377ec22289688:setup: tighten ownership checks post CVE-2022-24765\n\
  \n8959555cee7 (setup_git_directory(): add an owner check for the top-level\ndirectory, 2022-03-02),\
  \ adds a function to check for ownership of\nrepositories using a directory that is representative\
  \ of it, and ways to\nadd exempt a specific repository from said check if needed, but that\n\
  check didn't account for owership of the gitdir, or (when used) the\ngitfile that points to\
  \ that gitdir.\n\nAn attacker could create a git repository in a directory that they can\n\
  write into but that is owned by the victim to work around the fix that\nwas introduced with\
  \ CVE-2022-24765 to potentially run code as the\nvictim.\n\nAn example that could result in\
  \ privilege escalation to root in *NIX would\nbe to set a repository in a shared tmp directory\
  \ by doing (for example):\n\n  $ git -C /tmp init\n\nTo avoid that, extend the ensure_valid_ownership\
  \ function to be able to\ncheck for all three paths.\n\nThis will have the side effect of\
  \ tripling the number of stat() calls\nwhen a repository is detected, but the effect is expected\
  \ to be likely\nminimal, as it is done only once during the directory walk in which Git\n\
  looks for a repository.\n\nAdditionally make sure to resolve the gitfile (if one was used)\
  \ to find\nthe relevant gitdir for checking.\n\nWhile at it change the message printed on\
  \ failure so it is clear we are\nreferring to the repository by its worktree (or gitdir if\
  \ it is bare) and\nnot to a specific directory.\n\nHelped-by: Junio C Hamano <junio@pobox.com>\n\
  Helped-by: Johannes Schindelin <Johannes.Schindelin@gmx.de>\nSigned-off-by: Carlo Marcelo\
  \ Arenas Bel칩n <carenas@gmail.com>\n3b0bf2704980b1ed6018622bdf5377ec22289688:setup: tighten\
  \ ownership checks post CVE-2022-24765\n\n8959555cee7 (setup_git_directory(): add an owner\
  \ check for the top-level\ndirectory, 2022-03-02), adds a function to check for ownership\
  \ of\nrepositories using a directory that is representative of it, and ways to\nadd exempt\
  \ a specific repository from said check if needed, but that\ncheck didn't account for owership\
  \ of the gitdir, or (when used) the\ngitfile that points to that gitdir.\n\nAn attacker could\
  \ create a git repository in a directory that they can\nwrite into but that is owned by the\
  \ victim to work around the fix that\nwas introduced with CVE-2022-24765 to potentially run\
  \ code as the\nvictim.\n\nAn example that could result in privilege escalation to root in\
  \ *NIX would\nbe to set a repository in a shared tmp directory by doing (for example):\n\n\
  \  $ git -C /tmp init\n\nTo avoid that, extend the ensure_valid_ownership function to be able\
  \ to\ncheck for all three paths.\n\nThis will have the side effect of tripling the number\
  \ of stat() calls\nwhen a repository is detected, but the effect is expected to be likely\n\
  minimal, as it is done only once during the directory walk in which Git\nlooks for a repository.\n\
  \nAdditionally make sure to resolve the gitfile (if one was used) to find\nthe relevant gitdir\
  \ for checking.\n\nWhile at it change the message printed on failure so it is clear we are\n\
  referring to the repository by its worktree (or gitdir if it is bare) and\nnot to a specific\
  \ directory.\n\nHelped-by: Junio C Hamano <junio@pobox.com>\nHelped-by: Johannes Schindelin\
  \ <Johannes.Schindelin@gmx.de>\nSigned-off-by: Carlo Marcelo Arenas Bel칩n <carenas@gmail.com>\n\
  5f1a3fec8c304decaa9af2bf503712050a4a84e0:t: regression git needs safe.directory when using\
  \ sudo\n\nOriginally reported after release of v2.35.2 (and other maint branches)\nfor CVE-2022-24765\
  \ and blocking otherwise harmless commands that were\ndone using sudo in a repository that\
  \ was owned by the user.\n\nAdd a new test script with very basic support to allow running\
  \ git\ncommands through sudo, so a reproduction could be implemented and that\nuses only `git\
  \ status` as a proxy of the issue reported.\n\nNote that because of the way sudo interacts\
  \ with the system, a much\nmore complete integration with the test framework will require\
  \ a lot\nmore work and that was therefore intentionally punted for now.\n\nThe current implementation\
  \ requires the execution of a special cleanup\nfunction which should always be kept as the\
  \ last \"test\" or otherwise\nthe standard cleanup functions will fail because they can't\
  \ remove\nthe root owned directories that are used.  This also means that if\nfailures are\
  \ found while running, the specifics of the failure might\nnot be kept for further debugging\
  \ and if the test was interrupted, it\nwill be necessary to clean the working directory manually\
  \ before\nrestarting by running:\n\n  $ sudo rm -rf trash\\ directory.t0034-root-safe-directory/\n\
  \nThe test file also uses at least one initial \"setup\" test that creates\na parallel execution\
  \ directory under the \"root\" sub directory, which\nshould be used as top level directory\
  \ for all repositories that are\nused in this test file.  Unlike all other tests the repository\
  \ provided\nby the test framework should go unused.\n\nSpecial care should be taken when invoking\
  \ commands through sudo, since\nthe environment is otherwise independent from what the test\
  \ framework\nsetup and might have changed the values for HOME, SHELL and dropped\nseveral\
  \ relevant environment variables for your test.  Indeed `git status`\nwas used as a proxy\
  \ because it doesn't even require commits in the\nrepository to work and usually doesn't require\
  \ much from the environment\nto run, but a future patch will add calls to `git init` and that\
  \ will\nfail to honor the default branch name, unless that setting is NOT\nprovided through\
  \ an environment variable (which means even a CI run\ncould fail that test if enabled incorrectly).\n\
  \nA new SUDO prerequisite is provided that does some sanity checking\nto make sure the sudo\
  \ command that will be used allows for passwordless\nexecution as root without restrictions\
  \ and doesn't mess with git's\nexecution path.  This matches what is provided by the macOS\
  \ agents that\nare used as part of GitHub actions and probably nowhere else.\n\nMost of those\
  \ characteristics make this test mostly only suitable for\nCI, but it might be executed locally\
  \ if special care is taken to provide\nfor all of them in the local configuration and maybe\
  \ making use of the\nsudo credential cache by first invoking sudo, entering your password\
  \ if\nneeded, and then invoking the test with:\n\n  $ GIT_TEST_ALLOW_SUDO=YES ./t0034-root-safe-directory.sh\n\
  \nIf it fails to run, then it means your local setup wouldn't work for the\ntest because of\
  \ the configuration sudo has or other system settings, and\nthings that might help are to\
  \ comment out sudo's secure_path config, and\nmake sure that the account you are using has\
  \ no restrictions on the\ncommands it can run through sudo, just like is provided for the\
  \ user in\nthe CI.\n\nFor example (assuming a username of marta for you) something probably\n\
  similar to the following entry in your /etc/sudoers (or equivalent) file:\n\n  marta\tALL=(ALL:ALL)\
  \ NOPASSWD: ALL\n\nReported-by: SZEDER G치bor <szeder.dev@gmail.com>\nHelped-by: Phillip Wood\
  \ <phillip.wood123@gmail.com>\nSigned-off-by: Carlo Marcelo Arenas Bel칩n <carenas@gmail.com>\n\
  Signed-off-by: Junio C Hamano <gitster@pobox.com>"
impacted_packages:
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 378eaded1aec073a815b8687e67a2e2eadd3228c
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 3b0bf2704980b1ed6018622bdf5377ec22289688
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: fc0c773028685cdbae35c6c71f3fd3b87ab70985
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: aef3d5948c5b00a0409e117da7e720f574040505
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 2f8809f9a1838eb607f14097dcd63071f2eb00fe
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: d51e1dff980b9fc87002436b6ab36120a39816b1
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 8f8eea8c3aba154ce1f9eaab4fa06c73b60550dc
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 5f1a3fec8c304decaa9af2bf503712050a4a84e0
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: eebfde3f213e2990727a64da0d7d04ad961a28b0
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/git/git/tree/2f8809f9a1838eb607f14097dcd63071f2eb00fe
    reference_type: commit
    reference_id: 2f8809f9a1838eb607f14097dcd63071f2eb00fe
  - url: https://github.com/git/git/tree/378eaded1aec073a815b8687e67a2e2eadd3228c
    reference_type: commit
    reference_id: 378eaded1aec073a815b8687e67a2e2eadd3228c
  - url: https://github.com/git/git/tree/3b0bf2704980b1ed6018622bdf5377ec22289688
    reference_type: commit
    reference_id: 3b0bf2704980b1ed6018622bdf5377ec22289688
  - url: https://github.com/git/git/tree/5f1a3fec8c304decaa9af2bf503712050a4a84e0
    reference_type: commit
    reference_id: 5f1a3fec8c304decaa9af2bf503712050a4a84e0
  - url: https://github.com/git/git/tree/8f8eea8c3aba154ce1f9eaab4fa06c73b60550dc
    reference_type: commit
    reference_id: 8f8eea8c3aba154ce1f9eaab4fa06c73b60550dc
  - url: https://github.com/git/git/tree/aef3d5948c5b00a0409e117da7e720f574040505
    reference_type: commit
    reference_id: aef3d5948c5b00a0409e117da7e720f574040505
  - url: https://github.com/git/git/tree/d51e1dff980b9fc87002436b6ab36120a39816b1
    reference_type: commit
    reference_id: d51e1dff980b9fc87002436b6ab36120a39816b1
  - url: https://github.com/git/git/tree/eebfde3f213e2990727a64da0d7d04ad961a28b0
    reference_type: commit
    reference_id: eebfde3f213e2990727a64da0d7d04ad961a28b0
  - url: https://github.com/git/git/tree/fc0c773028685cdbae35c6c71f3fd3b87ab70985
    reference_type: commit
    reference_id: fc0c773028685cdbae35c6c71f3fd3b87ab70985
