advisory_id: CVE-2019-1348
datasource_id: collect_git_fix_commits/CVE-2019-1348
datasource_url: https://github.com/git/git
aliases: []
summary: |
  a7b1ad3b05fd1dc03c3de12ea4f2d8118ad24e2c:Merge branch 'jk/fast-import-unsafe'

  The `--export-marks` option of `git fast-import` is exposed also via the
  in-stream command `feature export-marks=...` and it allows overwriting
  arbitrary paths.

  This topic branch prevents the in-stream version, to prevent arbitrary
  file accesses by `git fast-import` streams coming from untrusted sources
  (e.g. in remote helpers that are based on `git fast-import`).

  This fixes CVE-2019-1348.

  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
  68061e3470210703cb15594194718d35094afdc0:fast-import: disallow "feature export-marks" by default

  The fast-import stream command "feature export-marks=<path>" lets the
  stream write marks to an arbitrary path. This may be surprising if you
  are running fast-import against an untrusted input (which otherwise
  cannot do anything except update Git objects and refs).

  Let's disallow the use of this feature by default, and provide a
  command-line option to re-enable it (you can always just use the
  command-line --export-marks as well, but the in-stream version provides
  an easy way for exporters to control the process).

  This is a backwards-incompatible change, since the default is flipping
  to the new, safer behavior. However, since the main users of the
  in-stream versions would be import/export-based remote helpers, and
  since we trust remote helpers already (which are already running
  arbitrary code), we'll pass the new option by default when reading a
  remote helper's stream. This should minimize the impact.

  Note that the implementation isn't totally simple, as we have to work
  around the fact that fast-import doesn't parse its command-line options
  until after it has read any "feature" lines from the stream. This is how
  it lets command-line options override in-stream. But in our case, it's
  important to parse the new --allow-unsafe-features first.

  There are three options for resolving this:

    1. Do a separate "early" pass over the options. This is easy for us to
       do because there are no command-line options that allow the
       "unstuck" form (so there's no chance of us mistaking an argument
       for an option), though it does introduce a risk of incorrect
       parsing later (e.g,. if we convert to parse-options).

    2. Move the option parsing phase back to the start of the program, but
       teach the stream-reading code never to override an existing value.
       This is tricky, because stream "feature" lines override each other
       (meaning we'd have to start tracking the source for every option).

    3. Accept that we might parse a "feature export-marks" line that is
       forbidden, as long we don't _act_ on it until after we've parsed
       the command line options.

       This would, in fact, work with the current code, but only because
       the previous patch fixed the export-marks parser to avoid touching
       the filesystem.

       So while it works, it does carry risk of somebody getting it wrong
       in the future in a rather subtle and unsafe way.

  I've gone with option (1) here as simple, safe, and unlikely to cause
  regressions.

  This fixes CVE-2019-1348.

  Signed-off-by: Jeff King <peff@peff.net>
impacted_packages:
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 68061e3470210703cb15594194718d35094afdc0
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: a7b1ad3b05fd1dc03c3de12ea4f2d8118ad24e2c
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/git/git/tree/68061e3470210703cb15594194718d35094afdc0
    reference_type: commit
    reference_id: 68061e3470210703cb15594194718d35094afdc0
  - url: https://github.com/git/git/tree/a7b1ad3b05fd1dc03c3de12ea4f2d8118ad24e2c
    reference_type: commit
    reference_id: a7b1ad3b05fd1dc03c3de12ea4f2d8118ad24e2c
