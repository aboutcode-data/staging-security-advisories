advisory_id: CVE-2022-39253
datasource_id: collect_git_fix_commits/CVE-2022-39253
datasource_url: https://github.com/git/git
aliases: []
summary: |
  d1bb66a546b4bb46005d17ba711caaad26f26c1e:builtin/clone: abort when hardlinked source and target file differ

  When performing local clones with hardlinks we refuse to copy source
  files which are symlinks as a mitigation for CVE-2022-39253. This check
  can be raced by an adversary though by changing the file to a symlink
  after we have checked it.

  Fix the issue by checking whether the hardlinked destination file
  matches the source file and abort in case it doesn't.

  This addresses CVE-2024-32021.

  Reported-by: Apple Product Security <product-security@apple.com>
  Suggested-by: Linus Torvalds <torvalds@linuxfoundation.org>
  Signed-off-by: Patrick Steinhardt <ps@pks.im>
  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
  150e6b0aedf57d224c3c49038c306477fa159886:builtin/clone: stop resolving symlinks when copying files

  When a user performs a local clone without `--no-local`, then we end up
  copying the source repository into the target repository directly. To
  optimize this even further, we try to hardlink files into place instead
  of copying data over, which helps both disk usage and speed.

  There is an important edge case in this context though, namely when we
  try to hardlink symlinks from the source repository into the target
  repository. Depending on both platform and filesystem the resulting
  behaviour here can be different:

    - On macOS and NetBSD, calling link(3P) with a symlink target creates
      a hardlink to the file pointed to by the symlink.

    - On Linux, calling link(3P) instead creates a hardlink to the symlink
      itself.

  To unify this behaviour, 36596fd2df (clone: better handle symlinked
  files at .git/objects/, 2019-07-10) introduced logic to resolve symlinks
  before we try to link(3P) files. Consequently, the new behaviour was to
  always create a hard link to the target of the symlink on all platforms.

  Eventually though, we figured out that following symlinks like this can
  cause havoc when performing a local clone of a malicious repository,
  which resulted in CVE-2022-39253. This issue was fixed via 6f054f9fb3
  (builtin/clone.c: disallow `--local` clones with symlinks, 2022-07-28),
  by refusing symlinks in the source repository.

  But even though we now shouldn't ever link symlinks anymore, the code
  that resolves symlinks still exists. In the best case the code does not
  end up doing anything because there are no symlinks anymore. In the
  worst case though this can be abused by an adversary that rewrites the
  source file after it has been checked not to be a symlink such that it
  actually is a symlink when we call link(3P). Thus, it is still possible
  to recreate CVE-2022-39253 due to this time-of-check-time-of-use bug.

  Remove the call to `realpath()`. This doesn't yet address the actual
  vulnerability, which will be handled in a subsequent commit.

  Reported-by: Apple Product Security <product-security@apple.com>
  Signed-off-by: Patrick Steinhardt <ps@pks.im>
  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
  150e6b0aedf57d224c3c49038c306477fa159886:builtin/clone: stop resolving symlinks when copying files

  When a user performs a local clone without `--no-local`, then we end up
  copying the source repository into the target repository directly. To
  optimize this even further, we try to hardlink files into place instead
  of copying data over, which helps both disk usage and speed.

  There is an important edge case in this context though, namely when we
  try to hardlink symlinks from the source repository into the target
  repository. Depending on both platform and filesystem the resulting
  behaviour here can be different:

    - On macOS and NetBSD, calling link(3P) with a symlink target creates
      a hardlink to the file pointed to by the symlink.

    - On Linux, calling link(3P) instead creates a hardlink to the symlink
      itself.

  To unify this behaviour, 36596fd2df (clone: better handle symlinked
  files at .git/objects/, 2019-07-10) introduced logic to resolve symlinks
  before we try to link(3P) files. Consequently, the new behaviour was to
  always create a hard link to the target of the symlink on all platforms.

  Eventually though, we figured out that following symlinks like this can
  cause havoc when performing a local clone of a malicious repository,
  which resulted in CVE-2022-39253. This issue was fixed via 6f054f9fb3
  (builtin/clone.c: disallow `--local` clones with symlinks, 2022-07-28),
  by refusing symlinks in the source repository.

  But even though we now shouldn't ever link symlinks anymore, the code
  that resolves symlinks still exists. In the best case the code does not
  end up doing anything because there are no symlinks anymore. In the
  worst case though this can be abused by an adversary that rewrites the
  source file after it has been checked not to be a symlink such that it
  actually is a symlink when we call link(3P). Thus, it is still possible
  to recreate CVE-2022-39253 due to this time-of-check-time-of-use bug.

  Remove the call to `realpath()`. This doesn't yet address the actual
  vulnerability, which will be handled in a subsequent commit.

  Reported-by: Apple Product Security <product-security@apple.com>
  Signed-off-by: Patrick Steinhardt <ps@pks.im>
  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
impacted_packages:
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 150e6b0aedf57d224c3c49038c306477fa159886
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: d1bb66a546b4bb46005d17ba711caaad26f26c1e
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/git/git/tree/150e6b0aedf57d224c3c49038c306477fa159886
    reference_type: commit
    reference_id: 150e6b0aedf57d224c3c49038c306477fa159886
  - url: https://github.com/git/git/tree/d1bb66a546b4bb46005d17ba711caaad26f26c1e
    reference_type: commit
    reference_id: d1bb66a546b4bb46005d17ba711caaad26f26c1e
