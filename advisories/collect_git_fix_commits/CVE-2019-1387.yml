advisory_id: CVE-2019-1387
datasource_id: collect_git_fix_commits/CVE-2019-1387
datasource_url: https://github.com/git/git
aliases: []
summary: |
  9cf85473209ea8ae2b56c13145c4704d12ee1374:clone: prevent clashing git dirs when cloning submodule in parallel

  While it is expected to have several git dirs within the `.git/modules/`
  tree, it is important that they do not interfere with each other. For
  example, if one submodule was called "captain" and another submodule
  "captain/hooks", their respective git dirs would clash, as they would be
  located in `.git/modules/captain/` and `.git/modules/captain/hooks/`,
  respectively, i.e. the latter's files could clash with the actual Git
  hooks of the former.

  To prevent these clashes, and in particular to prevent hooks from being
  written and then executed as part of a recursive clone, we introduced
  checks as part of the fix for CVE-2019-1387 in a8dee3ca61 (Disallow
  dubiously-nested submodule git directories, 2019-10-01).

  It is currently possible to bypass the check for clashing submodule
  git dirs in two ways:

  1. parallel cloning
  2. checkout --recurse-submodules

  Let's check not only before, but also after parallel cloning (and before
  checking out the submodule), that the git dir is not clashing with
  another one, otherwise fail. This addresses the parallel cloning issue.

  As to the parallel checkout issue: It requires quite a few manual steps
  to create clashing git dirs because Git itself would refuse to
  initialize the inner one, as demonstrated by the test case.

  Nevertheless, let's teach the recursive checkout (namely, the
  `submodule_move_head()` function that is used by the recursive checkout)
  to be careful to verify that it does not use a clashing git dir, and if
  it does, disable it (by deleting the `HEAD` file so that subsequent Git
  calls won't recognize it as a git dir anymore).

  Note: The parallel cloning test case contains a `cat err` that proved to
  be highly useful when analyzing the racy nature of the operation (the
  operation can fail with three different error messages, depending on
  timing), and was left on purpose to ease future debugging should the
  need arise.

  Signed-off-by: Filip Hejsek <filip.hejsek@gmail.com>
  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
  a8dee3ca610f5a1d403634492136c887f83b59d2:Disallow dubiously-nested submodule git directories

  Currently it is technically possible to let a submodule's git
  directory point right into the git dir of a sibling submodule.

  Example: the git directories of two submodules with the names `hippo`
  and `hippo/hooks` would be `.git/modules/hippo/` and
  `.git/modules/hippo/hooks/`, respectively, but the latter is already
  intended to house the former's hooks.

  In most cases, this is just confusing, but there is also a (quite
  contrived) attack vector where Git can be fooled into mistaking remote
  content for file contents it wrote itself during a recursive clone.

  Let's plug this bug.

  To do so, we introduce the new function `validate_submodule_git_dir()`
  which simply verifies that no git dir exists for any leading directories
  of the submodule name (if there are any).

  Note: this patch specifically continues to allow sibling modules names
  of the form `core/lib`, `core/doc`, etc, as long as `core` is not a
  submodule name.

  This fixes CVE-2019-1387.

  Reported-by: Nicolas Joly <Nicolas.Joly@microsoft.com>
  Signed-off-by: Johannes Schindelin <johannes.schindelin@gmx.de>
impacted_packages:
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: 9cf85473209ea8ae2b56c13145c4704d12ee1374
    introduced_in_commits: []
  - purl: pkg:github/git/git
    affected_versions:
    fixed_versions:
    fixed_in_commits:
      - vcs_url: https://github.com/git/git
        commit: a8dee3ca610f5a1d403634492136c887f83b59d2
    introduced_in_commits: []
severities: []
weaknesses: []
references:
  - url: https://github.com/git/git/tree/9cf85473209ea8ae2b56c13145c4704d12ee1374
    reference_type: commit
    reference_id: 9cf85473209ea8ae2b56c13145c4704d12ee1374
  - url: https://github.com/git/git/tree/a8dee3ca610f5a1d403634492136c887f83b59d2
    reference_type: commit
    reference_id: a8dee3ca610f5a1d403634492136c887f83b59d2
