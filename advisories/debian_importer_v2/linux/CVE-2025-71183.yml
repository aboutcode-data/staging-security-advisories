advisory_id: linux/CVE-2025-71183
datasource_id: debian_importer_v2/linux/CVE-2025-71183
datasource_url: https://security-tracker.debian.org/tracker/CVE-2025-71183
aliases:
  - CVE-2025-71183
summary: 'In the Linux kernel, the following vulnerability has been resolved:  btrfs: always
  detect conflicting inodes when logging inode refs  After rename exchanging (either with the
  rename exchange operation or regular renames in multiple non-atomic steps) two inodes and
  at least one of them is a directory, we can end up with a log tree that contains only of the
  inodes and after a power failure that can result in an attempt to delete the other inode when
  it should not because it was not deleted before the power failure. In some case that delete
  attempt fails when the target inode is a directory that contains a subvolume inside it, since
  the log replay code is not prepared to deal with directory entries that point to root items
  (only inode items).  1) We have directories "dir1" (inode A) and "dir2" (inode B) under the    same
  parent directory;  2) We have a file (inode C) under directory "dir1" (inode A);  3) We have
  a subvolume inside directory "dir2" (inode B);  4) All these inodes were persisted in a past
  transaction and we are    currently at transaction N;  5) We rename the file (inode C), so
  at btrfs_log_new_name() we update    inode C''s last_unlink_trans to N;  6) We get a rename
  exchange for "dir1" (inode A) and "dir2" (inode B),    so after the exchange "dir1" is inode
  B and "dir2" is inode A.    During the rename exchange we call btrfs_log_new_name() for inodes    A
  and B, but because they are directories, we don''t update their    last_unlink_trans to N;  7)
  An fsync against the file (inode C) is done, and because its inode    has a last_unlink_trans
  with a value of N we log its parent directory    (inode A) (through btrfs_log_all_parents(),
  called from    btrfs_log_inode_parent()).  8) So we end up with inode B not logged, which
  now has the old name    of inode A. At copy_inode_items_to_log(), when logging inode A, we    did
  not check if we had any conflicting inode to log because inode    A has a generation lower
  than the current transaction (created in    a past transaction);  9) After a power failure,
  when replaying the log tree, since we find that    inode A has a new name that conflicts with
  the name of inode B in the    fs tree, we attempt to delete inode B... this is wrong since
  that    directory was never deleted before the power failure, and because there    is a subvolume
  inside that directory, attempting to delete it will fail    since replay_dir_deletes() and
  btrfs_unlink_inode() are not prepared    to deal with dir items that point to roots instead
  of inodes.     When that happens the mount fails and we get a stack trace like the    following:     [87.2314]
  BTRFS info (device dm-0): start tree-log replay    [87.2318] BTRFS critical (device dm-0):
  failed to delete reference to subvol, root 5 inode 256 parent 259    [87.2332] ------------[
  cut here ]------------    [87.2338] BTRFS: Transaction aborted (error -2)    [87.2346] WARNING:
  CPU: 1 PID: 638968 at fs/btrfs/inode.c:4345 __btrfs_unlink_inode+0x416/0x440 [btrfs]    [87.2368]
  Modules linked in: btrfs loop dm_thin_pool (...)    [87.2470] CPU: 1 UID: 0 PID: 638968 Comm:
  mount Tainted: G        W           6.18.0-rc7-btrfs-next-218+ #2 PREEMPT(full)    [87.2489]
  Tainted: [W]=WARN    [87.2494] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
  rel-1.16.2-0-gea1b7a073390-prebuilt.qemu.org 04/01/2014    [87.2514] RIP: 0010:__btrfs_unlink_inode+0x416/0x440
  [btrfs]    [87.2538] Code: c0 89 04 24 (...)    [87.2568] RSP: 0018:ffffc0e741f4b9b8 EFLAGS:
  00010286    [87.2574] RAX: 0000000000000000 RBX: ffff9d3ec8a6cf60 RCX: 0000000000000000    [87.2582]
  RDX: 0000000000000002 RSI: ffffffff84ab45a1 RDI: 00000000ffffffff    [87.2591] RBP: ffff9d3ec8a6ef20
  R08: 0000000000000000 R09: ffffc0e741f4b840    [87.2599] R10: ffff9d45dc1fffa8 R11: 0000000000000003
  R12: ffff9d3ee26d77e0    [87.2608] R13: ffffc0e741f4ba98 R14: ffff9d4458040800 R15: ffff9d44b6b7ca10    [87.2618]
  FS:  00007f7b9603a840(0000) GS:ffff9d4658982000(0000) knlGS:0000000000000000    [87. ---truncated---'
impacted_packages:
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.1.159-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.1.162-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.18.12-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.18.8-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.12.63-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.12.69-1
    fixed_in_commits: []
    introduced_in_commits: []
severities: []
weaknesses: []
references: []
