advisory_id: linux/CVE-2025-39797
datasource_id: debian_importer_v2/linux/CVE-2025-39797
datasource_url: https://security-tracker.debian.org/tracker/CVE-2025-39797
aliases:
  - CVE-2025-39797
summary: 'In the Linux kernel, the following vulnerability has been resolved:  xfrm: Duplicate
  SPI Handling  The issue originates when Strongswan initiates an XFRM_MSG_ALLOCSPI Netlink
  message, which triggers the kernel function xfrm_alloc_spi(). This function is expected to
  ensure uniqueness of the Security Parameter Index (SPI) for inbound Security Associations
  (SAs). However, it can return success even when the requested SPI is already in use, leading
  to duplicate SPIs assigned to multiple inbound SAs, differentiated only by their destination
  addresses.  This behavior causes inconsistencies during SPI lookups for inbound packets. Since
  the lookup may return an arbitrary SA among those with the same SPI, packet processing can
  fail, resulting in packet drops.  According to RFC 4301 section 4.4.2 , for inbound processing
  a unicast SA is uniquely identified by the SPI and optionally protocol.  Reproducing the Issue
  Reliably: To consistently reproduce the problem, restrict the available SPI range in charon.conf
  : spi_min = 0x10000000 spi_max = 0x10000002 This limits the system to only 2 usable SPI values.
  Next, create more than 2 Child SA. each using unique pair of src/dst address. As soon as the
  3rd Child SA is initiated, it will be assigned a duplicate SPI, since the SPI pool is already
  exhausted. With a narrow SPI range, the issue is consistently reproducible. With a broader/default
  range, it becomes rare and unpredictable.  Current implementation: xfrm_spi_hash() lookup
  function computes hash using daddr, proto, and family. So if two SAs have the same SPI but
  different destination addresses, then they will: a. Hash into different buckets b. Be stored
  in different linked lists (byspi + h) c. Not be seen in the same hlist_for_each_entry_rcu()
  iteration. As a result, the lookup will result in NULL and kernel allows that Duplicate SPI  Proposed
  Change: xfrm_state_lookup_spi_proto() does a truly global search - across all states, regardless
  of hash bucket and matches SPI and proto.'
impacted_packages:
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1|6.1.159-1
    fixed_versions: vers:deb/6.18.12-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1|6.1.159-1
    fixed_versions: vers:deb/6.16.3-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1|6.1.159-1
    fixed_versions: vers:deb/6.18.13-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1|6.1.159-1
    fixed_versions: vers:deb/6.12.63-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1|6.1.159-1
    fixed_versions: vers:deb/6.12.43-1
    fixed_in_commits: []
    introduced_in_commits: []
severities: []
weaknesses: []
references: []
