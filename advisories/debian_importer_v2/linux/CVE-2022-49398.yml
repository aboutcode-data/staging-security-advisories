advisory_id: linux/CVE-2022-49398
datasource_id: debian_importer_v2/linux/CVE-2022-49398
datasource_url: https://security-tracker.debian.org/tracker/CVE-2022-49398
aliases:
  - CVE-2022-49398
summary: 'In the Linux kernel, the following vulnerability has been resolved:  usb: dwc3: gadget:
  Replace list_for_each_entry_safe() if using giveback  The list_for_each_entry_safe() macro
  saves the current item (n) and the item after (n+1), so that n can be safely removed without
  corrupting the list.  However, when traversing the list and removing items using gadget giveback,
  the DWC3 lock is briefly released, allowing other routines to execute.  There is a situation
  where, while items are being removed from the cancelled_list using dwc3_gadget_ep_cleanup_cancelled_requests(),
  the pullup disable routine is running in parallel (due to UDC unbind).  As the cleanup routine
  removes n, and the pullup disable removes n+1, once the cleanup retakes the DWC3 lock, it
  references a request who was already removed/handled.  With list debug enabled, this leads
  to a panic. Ensure all instances of the macro are replaced where gadget giveback is used.  Example
  call stack:  Thread#1: __dwc3_gadget_ep_set_halt() - CLEAR HALT   -> dwc3_gadget_ep_cleanup_cancelled_requests()     ->list_for_each_entry_safe()     ->dwc3_gadget_giveback(n)       ->dwc3_gadget_del_and_unmap_request()-
  n deleted[cancelled_list]       ->spin_unlock       ->Thread#2 executes       ...     ->dwc3_gadget_giveback(n+1)       ->Already
  removed!  Thread#2: dwc3_gadget_pullup()   ->waiting for dwc3 spin_lock   ...   ->Thread#1
  released lock   ->dwc3_stop_active_transfers()     ->dwc3_remove_requests()       ->fetches
  n+1 item from cancelled_list (n removed by Thread#1)       ->dwc3_gadget_giveback()         ->dwc3_gadget_del_and_unmap_request()-
  n+1 deleted[cancelled_list]         ->spin_unlock'
impacted_packages:
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.1.159-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/5.18.5-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.18.12-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.12.63-1
    fixed_in_commits: []
    introduced_in_commits: []
severities: []
weaknesses: []
references: []
