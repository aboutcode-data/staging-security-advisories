advisory_id: linux/CVE-2023-54121
datasource_id: debian_importer_v2/linux/CVE-2023-54121
datasource_url: https://security-tracker.debian.org/tracker/CVE-2023-54121
aliases:
  - CVE-2023-54121
summary: "In the Linux kernel, the following vulnerability has been resolved:  btrfs: fix incorrect\
  \ splitting in btrfs_drop_extent_map_range  In production we were seeing a variety of WARN_ON()'s\
  \ in the extent_map code, specifically in btrfs_drop_extent_map_range() when we have to call\
  \ add_extent_mapping() for our second split.  Consider the following extent map layout  \t\
  PINNED \t[0 16K)  [32K, 48K)  and then we call btrfs_drop_extent_map_range for [0, 36K), with\
  \ skip_pinned == true.  The initial loop will have  \tstart = 0 \tend = 36K \tlen = 36K  we\
  \ will find the [0, 16k) extent, but since we are pinned we will skip it, which has this code\
  \  \tstart = em_end; \tif (end != (u64)-1) \t\tlen = start + len - em_end;  em_end here is\
  \ 16K, so now the values are  \tstart = 16K \tlen = 16K + 36K - 16K = 36K  len should instead\
  \ be 20K.  This is a problem when we find the next extent at [32K, 48K), we need to split\
  \ this extent to leave [36K, 48k), however the code for the split looks like this  \tsplit->start\
  \ = start + len; \tsplit->len = em_end - (start + len);  In this case we have  \tem_end =\
  \ 48K \tsplit->start = 16K + 36K       // this should be 16K + 20K \tsplit->len = 48K - (16K\
  \ + 36K) // this overflows as 16K + 36K is 52K  and now we have an invalid extent_map in the\
  \ tree that potentially overlaps other entries in the extent map.  Even in the non-overlapping\
  \ case we will have split->start set improperly, which will cause problems with any block\
  \ related calculations.  We don't actually need len in this loop, we can simply use end as\
  \ our end point, and only adjust start up when we find a pinned extent we need to skip.  Adjust\
  \ the logic to do this, which keeps us from inserting an invalid extent map.  We only skip_pinned\
  \ in the relocation case, so this is relatively rare, except in the case where you are running\
  \ relocation a lot, which can happen with auto relocation on."
impacted_packages:
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.1.159-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.1.52-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.18.12-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.4.13-1
    fixed_in_commits: []
    introduced_in_commits: []
  - purl: pkg:deb/debian/linux?distro=trixie
    affected_versions: vers:deb/5.10.223-1
    fixed_versions: vers:deb/6.12.63-1
    fixed_in_commits: []
    introduced_in_commits: []
severities: []
weaknesses: []
references: []
